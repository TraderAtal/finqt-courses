<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Forex &amp; Futures â€” FinQT</title>
    <style>
/* === Reset & Base === */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --bg: #0a0a0a;
    --bg-secondary: #111111;
    --bg-sidebar: #0d0d0d;
    --text: #e0e0e0;
    --text-dim: #888888;
    --green: #00c853;
    --green-dim: #1b5e20;
    --green-glow: rgba(0, 200, 83, 0.15);
    --code-bg: #141420;
    --border: #1e1e1e;
    --header-height: 52px;
}

html {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.65;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
}

/* === Header === */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    z-index: 1000;
    gap: 12px;
}

.hamburger {
    background: none;
    border: none;
    color: var(--text);
    font-size: 22px;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    line-height: 1;
    flex-shrink: 0;
}
.hamburger:hover {
    background: rgba(255,255,255,0.08);
}

.header-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--green);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.header-module {
    font-size: 13px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-left: auto;
}

/* === Sidebar === */
.sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1001;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}
.sidebar-overlay.open {
    opacity: 1;
    pointer-events: auto;
}

.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 280px;
    max-width: 85vw;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    z-index: 1002;
    transform: translateX(-100%);
    transition: transform 0.25s ease;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 12px;
    padding-bottom: 24px;
}
.sidebar.open {
    transform: translateX(0);
}

.sidebar-header {
    padding: 12px 16px 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
}
.sidebar-header h2 {
    font-size: 15px;
    color: var(--green);
    font-weight: 600;
}

.sidebar-part {
    padding: 10px 16px 4px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.6px;
}

.sidebar-item {
    display: block;
    padding: 8px 16px 8px 24px;
    font-size: 13px;
    color: var(--text);
    text-decoration: none;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.15s;
}
.sidebar-item:hover {
    background: rgba(255,255,255,0.04);
}
.sidebar-item.active {
    color: var(--green);
    border-left-color: var(--green);
    background: var(--green-glow);
    font-weight: 600;
}

/* === Main Content === */
.main {
    margin-top: var(--header-height);
    padding: 20px 16px 80px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.module-section {
    display: none;
}
.module-section.active {
    display: block;
}

/* === Typography === */
.md-cell h1 {
    font-size: 1.7rem;
    font-weight: 700;
    color: var(--green);
    margin: 1.5em 0 0.5em;
    line-height: 1.25;
}
.md-cell h2 {
    font-size: 1.35rem;
    font-weight: 600;
    color: var(--green);
    margin: 1.4em 0 0.4em;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
}
.md-cell h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #cccccc;
    margin: 1.2em 0 0.3em;
}
.md-cell h4, .md-cell h5, .md-cell h6 {
    font-size: 1rem;
    font-weight: 600;
    color: #bbbbbb;
    margin: 1em 0 0.3em;
}

.md-cell p {
    margin: 0.6em 0;
}

.md-cell a {
    color: var(--green);
    text-decoration: none;
}
.md-cell a:hover {
    text-decoration: underline;
}

.md-cell strong {
    color: #f0f0f0;
}

.md-cell ul, .md-cell ol {
    margin: 0.5em 0;
    padding-left: 1.5em;
}
.md-cell li {
    margin: 0.25em 0;
}

.md-cell hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.5em 0;
}

.md-cell blockquote {
    border-left: 3px solid var(--green-dim);
    padding: 0.5em 1em;
    margin: 0.8em 0;
    color: var(--text-dim);
    background: rgba(255,255,255,0.02);
    border-radius: 0 6px 6px 0;
}

/* Inline code (not inside pre blocks) */
.md-cell code {
    background: rgba(255,255,255,0.08);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.88em;
    color: #e8e8e8;
}
.md-cell pre code {
    background: transparent !important;
    padding: 0;
    border-radius: 0;
    color: inherit;
}

/* Fenced code blocks inside markdown */
.md-cell pre {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    overflow-x: auto;
    margin: 0.8em 0;
    -webkit-overflow-scrolling: touch;
}
.md-cell pre code {
    background: none;
    padding: 0;
    border-radius: 0;
    font-size: 0.85rem;
    line-height: 1.5;
    color: #e8e8e8;
}

/* === Module Header (first cell) === */
.module-header {
    padding-bottom: 0.5em;
    margin-bottom: 0.5em;
}
.module-header h1 {
    font-size: 1.8rem;
    margin-top: 0;
}

/* === Tables === */
.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0.8em 0;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.md-cell table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
}
.md-cell th {
    background: var(--bg-secondary);
    color: var(--green);
    font-weight: 600;
    text-align: left;
    padding: 10px 12px;
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
}
.md-cell td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
}
.md-cell tr:last-child td {
    border-bottom: none;
}

/* === Code Cells === */
.code-cell {
    position: relative;
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin: 0.6em 0;
    overflow: hidden;
}
.code-cell pre {
    margin: 0;
    padding: 14px 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.code-cell pre code {
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.82rem;
    line-height: 1.55;
    background: transparent !important;
    padding: 0;
    border-radius: 0;
}

.copy-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(255,255,255,0.08);
    border: none;
    border-radius: 4px;
    padding: 4px 7px;
    font-size: 13px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 5;
}
.code-cell:hover .copy-btn {
    opacity: 1;
}
.copy-btn:hover {
    background: rgba(255,255,255,0.15);
}
.copy-btn.copied {
    opacity: 1;
}

/* === Exercise Styling === */
.exercise-header {
    background: rgba(0, 200, 83, 0.04);
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 12px 16px;
    margin: 1em 0 0.3em;
}
.exercise-header h3 {
    color: var(--green);
    margin-top: 0;
}

.exercise-code {
    border-color: var(--green-dim);
}

/* === Solution (details) blocks === */
.solution-block details {
    border-left: 3px solid var(--green);
    border-radius: 0 8px 8px 0;
    margin: 0.5em 0 1em;
    background: rgba(0, 200, 83, 0.03);
}
.solution-block summary {
    padding: 10px 14px;
    cursor: pointer;
    color: var(--green);
    font-weight: 600;
    font-size: 0.9rem;
    user-select: none;
    -webkit-user-select: none;
}
.solution-block summary:hover {
    background: rgba(0, 200, 83, 0.06);
}
.solution-block details[open] summary {
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
}
.solution-block details > :not(summary) {
    padding: 0 14px;
}
.solution-block details pre {
    margin: 10px 0;
}

/* === Module Project === */
.module-project {
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
    background: rgba(0, 200, 83, 0.03);
}
.module-project h1 {
    font-size: 1.4rem;
}

/* === Key Takeaways === */
.key-takeaways {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
}
.key-takeaways h1 {
    font-size: 1.3rem;
    margin-top: 0;
}

/* === Prev/Next Navigation === */
.nav-buttons {
    display: flex;
    gap: 12px;
    margin-top: 2em;
    padding-top: 1.5em;
    border-top: 1px solid var(--border);
}
.nav-btn {
    flex: 1;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: inherit;
    font-size: 0.9rem;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
    text-decoration: none;
    -webkit-appearance: none;
    -webkit-tap-highlight-color: rgba(0, 200, 83, 0.2);
}
.nav-btn:hover {
    border-color: var(--green);
    color: var(--green);
}
.nav-btn.disabled {
    opacity: 0.3;
    pointer-events: none;
}
.nav-btn-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-bottom: 2px;
}

/* === Syntax Highlighting (Pygments Monokai) === */
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.code-cell pre code .hll { background-color: #49483e }
.code-cell pre code { background: #272822; color: #f8f8f2 }
.code-cell pre code .c { color: #75715e } /* Comment */
.code-cell pre code .err { color: #960050; background-color: #1e0010 } /* Error */
.code-cell pre code .esc { color: #f8f8f2 } /* Escape */
.code-cell pre code .g { color: #f8f8f2 } /* Generic */
.code-cell pre code .k { color: #66d9ef } /* Keyword */
.code-cell pre code .l { color: #ae81ff } /* Literal */
.code-cell pre code .n { color: #f8f8f2 } /* Name */
.code-cell pre code .o { color: #f92672 } /* Operator */
.code-cell pre code .x { color: #f8f8f2 } /* Other */
.code-cell pre code .p { color: #f8f8f2 } /* Punctuation */
.code-cell pre code .ch { color: #75715e } /* Comment.Hashbang */
.code-cell pre code .cm { color: #75715e } /* Comment.Multiline */
.code-cell pre code .cp { color: #75715e } /* Comment.Preproc */
.code-cell pre code .cpf { color: #75715e } /* Comment.PreprocFile */
.code-cell pre code .c1 { color: #75715e } /* Comment.Single */
.code-cell pre code .cs { color: #75715e } /* Comment.Special */
.code-cell pre code .gd { color: #f92672 } /* Generic.Deleted */
.code-cell pre code .ge { color: #f8f8f2; font-style: italic } /* Generic.Emph */
.code-cell pre code .gr { color: #f8f8f2 } /* Generic.Error */
.code-cell pre code .gh { color: #f8f8f2 } /* Generic.Heading */
.code-cell pre code .gi { color: #a6e22e } /* Generic.Inserted */
.code-cell pre code .go { color: #66d9ef } /* Generic.Output */
.code-cell pre code .gp { color: #f92672; font-weight: bold } /* Generic.Prompt */
.code-cell pre code .gs { color: #f8f8f2; font-weight: bold } /* Generic.Strong */
.code-cell pre code .gu { color: #75715e } /* Generic.Subheading */
.code-cell pre code .gt { color: #f8f8f2 } /* Generic.Traceback */
.code-cell pre code .kc { color: #66d9ef } /* Keyword.Constant */
.code-cell pre code .kd { color: #66d9ef } /* Keyword.Declaration */
.code-cell pre code .kn { color: #f92672 } /* Keyword.Namespace */
.code-cell pre code .kp { color: #66d9ef } /* Keyword.Pseudo */
.code-cell pre code .kr { color: #66d9ef } /* Keyword.Reserved */
.code-cell pre code .kt { color: #66d9ef } /* Keyword.Type */
.code-cell pre code .ld { color: #e6db74 } /* Literal.Date */
.code-cell pre code .m { color: #ae81ff } /* Literal.Number */
.code-cell pre code .s { color: #e6db74 } /* Literal.String */
.code-cell pre code .na { color: #a6e22e } /* Name.Attribute */
.code-cell pre code .nb { color: #f8f8f2 } /* Name.Builtin */
.code-cell pre code .nc { color: #a6e22e } /* Name.Class */
.code-cell pre code .no { color: #66d9ef } /* Name.Constant */
.code-cell pre code .nd { color: #a6e22e } /* Name.Decorator */
.code-cell pre code .ni { color: #f8f8f2 } /* Name.Entity */
.code-cell pre code .ne { color: #a6e22e } /* Name.Exception */
.code-cell pre code .nf { color: #a6e22e } /* Name.Function */
.code-cell pre code .nl { color: #f8f8f2 } /* Name.Label */
.code-cell pre code .nn { color: #f8f8f2 } /* Name.Namespace */
.code-cell pre code .nx { color: #a6e22e } /* Name.Other */
.code-cell pre code .py { color: #f8f8f2 } /* Name.Property */
.code-cell pre code .nt { color: #f92672 } /* Name.Tag */
.code-cell pre code .nv { color: #f8f8f2 } /* Name.Variable */
.code-cell pre code .ow { color: #f92672 } /* Operator.Word */
.code-cell pre code .w { color: #f8f8f2 } /* Text.Whitespace */
.code-cell pre code .mb { color: #ae81ff } /* Literal.Number.Bin */
.code-cell pre code .mf { color: #ae81ff } /* Literal.Number.Float */
.code-cell pre code .mh { color: #ae81ff } /* Literal.Number.Hex */
.code-cell pre code .mi { color: #ae81ff } /* Literal.Number.Integer */
.code-cell pre code .mo { color: #ae81ff } /* Literal.Number.Oct */
.code-cell pre code .sa { color: #e6db74 } /* Literal.String.Affix */
.code-cell pre code .sb { color: #e6db74 } /* Literal.String.Backtick */
.code-cell pre code .sc { color: #e6db74 } /* Literal.String.Char */
.code-cell pre code .dl { color: #e6db74 } /* Literal.String.Delimiter */
.code-cell pre code .sd { color: #e6db74 } /* Literal.String.Doc */
.code-cell pre code .s2 { color: #e6db74 } /* Literal.String.Double */
.code-cell pre code .se { color: #ae81ff } /* Literal.String.Escape */
.code-cell pre code .sh { color: #e6db74 } /* Literal.String.Heredoc */
.code-cell pre code .si { color: #e6db74 } /* Literal.String.Interpol */
.code-cell pre code .sx { color: #e6db74 } /* Literal.String.Other */
.code-cell pre code .sr { color: #e6db74 } /* Literal.String.Regex */
.code-cell pre code .s1 { color: #e6db74 } /* Literal.String.Single */
.code-cell pre code .ss { color: #e6db74 } /* Literal.String.Symbol */
.code-cell pre code .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
.code-cell pre code .fm { color: #a6e22e } /* Name.Function.Magic */
.code-cell pre code .vc { color: #f8f8f2 } /* Name.Variable.Class */
.code-cell pre code .vg { color: #f8f8f2 } /* Name.Variable.Global */
.code-cell pre code .vi { color: #f8f8f2 } /* Name.Variable.Instance */
.code-cell pre code .vm { color: #f8f8f2 } /* Name.Variable.Magic */
.code-cell pre code .il { color: #ae81ff } /* Literal.Number.Integer.Long */

/* === Responsive === */
@media (min-width: 1024px) {
    .sidebar {
        transform: translateX(0);
        top: var(--header-height);
        padding-top: 8px;
        border-top: none;
    }
    .sidebar-overlay {
        display: none;
    }
    .main {
        margin-left: 296px;
    }
    .hamburger {
        display: none;
    }
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}
::-webkit-scrollbar-track {
    background: transparent;
}
::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.15);
    border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.25);
}
</style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">â˜°</button>
        <span class="header-title">Forex &amp; Futures</span>
        <span class="header-module"></span>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>Forex &amp; Futures</h2>
        </div>
        <div class="sidebar-part">Overview</div>
<div class="sidebar-item">Course Overview</div>
<div class="sidebar-part">Part 1: Market Fundamentals</div>
<div class="sidebar-item">Module 1: Forex Market Basics</div>
<div class="sidebar-item">Module 2: Futures Market Basics</div>
<div class="sidebar-item">Module 3: Leverage &amp; Margin</div>
<div class="sidebar-item">Module 4: Data &amp; Tools</div>
<div class="sidebar-part">Part 2: Analysis &amp; Strategies</div>
<div class="sidebar-item">Module 5: Technical Analysis for Forex &amp; Futures</div>
<div class="sidebar-item">Module 6: Fundamental Analysis for Forex &amp; Futures</div>
<div class="sidebar-item">Module 7: Commodity Trading</div>
<div class="sidebar-item">Module 8: Trading Strategies</div>
<div class="sidebar-part">Part 3: Risk &amp; Execution</div>
<div class="sidebar-item">Module 9: Risk Management</div>
<div class="sidebar-item">Module 10: Backtesting</div>
<div class="sidebar-item">Module 11: Live Trading</div>
<div class="sidebar-part">Part 4: Advanced Topics</div>
<div class="sidebar-item">Module 12: Advanced Strategies</div>
<div class="sidebar-item">Module 13: Automation &amp; Monitoring</div>
<div class="sidebar-item">Module 14: Trading Psychology &amp; Journaling</div>
<div class="sidebar-part">Capstone</div>
<div class="sidebar-item">Capstone Project</div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="module-section active" data-idx="0"><div class="md-cell module-header"><h1>Course 5: Forex &amp; Futures Algorithmic Trading</h1>
<h2>Course Overview</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Modules</th>
<th>Exercises</th>
<th>Level</th>
</tr>
</thead>
<tbody>
<tr>
<td>~40 hours</td>
<td>14 + Capstone</td>
<td>~90</td>
<td>Intermediate</td>
</tr>
</tbody>
</table></div>
<h3>Course Description</h3>
<p>Trade the world's largest markets. Master forex and futures, understand leverage, implement global macro strategies, and build systems for 24-hour operation.</p>
<h3>Prerequisites</h3>
<ul>
<li><strong>Course 0: Python for Finance</strong> - Python programming, pandas, data analysis</li>
</ul>
<h3>What You'll Learn</h3>
<ul>
<li>Navigate the forex market (currency pairs, pips, lots, trading sessions)</li>
<li>Understand futures contracts (expiration, rollover, basis, contango/backwardation)</li>
<li>Master leverage and margin management</li>
<li>Connect to OANDA API for data and trading</li>
<li>Implement forex-specific strategies (trend following, carry trade, news trading)</li>
<li>Build commodity trading systems (gold, oil, agricultural)</li>
<li>Manage risk with proper position sizing and gap risk handling</li>
<li>Deploy 24-hour automated trading systems</li>
</ul></div>
<div class="md-cell"><hr />
<h2>Course Structure</h2>
<h3>Part 1: Market Fundamentals</h3>
<p><em>Understand the unique characteristics of forex and futures markets</em></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Topics</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Forex Market Basics</td>
<td>Currency pairs, market structure, sessions, pips &amp; lots</td>
</tr>
<tr>
<td>2</td>
<td>Futures Market Basics</td>
<td>Contract specs, expiration, basis, rollover</td>
</tr>
<tr>
<td>3</td>
<td>Leverage &amp; Margin</td>
<td>Leverage mechanics, margin requirements, risk management</td>
</tr>
<tr>
<td>4</td>
<td>Data &amp; Tools</td>
<td>OANDA API, data sources, real-time feeds</td>
</tr>
</tbody>
</table></div>
<h3>Part 2: Analysis &amp; Strategies</h3>
<p><em>Learn analysis techniques and trading strategies specific to forex/futures</em></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Topics</th>
</tr>
</thead>
<tbody>
<tr>
<td>5</td>
<td>Technical Analysis</td>
<td>Chart patterns, forex indicators, multi-timeframe</td>
</tr>
<tr>
<td>6</td>
<td>Fundamental Analysis</td>
<td>Economic indicators, central banks, calendar</td>
</tr>
<tr>
<td>7</td>
<td>Commodity Trading</td>
<td>Gold, oil, agricultural, commodity currencies</td>
</tr>
<tr>
<td>8</td>
<td>Trading Strategies</td>
<td>Trend following, range, carry trade, news trading</td>
</tr>
</tbody>
</table></div>
<h3>Part 3: Risk &amp; Execution</h3>
<p><em>Manage risk and execute trades in leveraged markets</em></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Topics</th>
</tr>
</thead>
<tbody>
<tr>
<td>9</td>
<td>Risk Management</td>
<td>Forex/futures risk, portfolio risk, gap risk</td>
</tr>
<tr>
<td>10</td>
<td>Backtesting</td>
<td>Spread costs, leveraged backtesting, tick data</td>
</tr>
<tr>
<td>11</td>
<td>Live Trading</td>
<td>Brokers, OANDA execution, MetaTrader, 24h operation</td>
</tr>
</tbody>
</table></div>
<h3>Part 4: Advanced Topics</h3>
<p><em>Master advanced strategies and build production systems</em></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Topics</th>
</tr>
</thead>
<tbody>
<tr>
<td>12</td>
<td>Advanced Strategies</td>
<td>Currency indices, spreads, options, seasonality</td>
</tr>
<tr>
<td>13</td>
<td>Automation &amp; Monitoring</td>
<td>24/7 scheduling, alerts, performance tracking</td>
</tr>
<tr>
<td>14</td>
<td>Trading Psychology &amp; Journaling</td>
<td>Psychology, journals, performance review</td>
</tr>
</tbody>
</table></div>
<h3>Capstone Project</h3>
<p><strong>Build a 24-Hour Forex/Futures Trading System</strong> with multi-currency monitoring, economic calendar integration, leveraged risk management, and automated journaling.</p></div>
<div class="md-cell"><hr />
<h2>Why Forex &amp; Futures?</h2>
<h3>The World's Largest Markets</h3>
<ul>
<li><strong>Forex</strong>: $7.5 trillion daily volume (largest financial market)</li>
<li><strong>Futures</strong>: Standardized contracts for commodities, indices, currencies</li>
<li><strong>24-hour trading</strong>: Opportunities around the clock</li>
<li><strong>High liquidity</strong>: Tight spreads on major pairs</li>
</ul>
<h3>Unique Characteristics</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Feature</th>
<th>Forex</th>
<th>Futures</th>
<th>Stocks</th>
</tr>
</thead>
<tbody>
<tr>
<td>Trading Hours</td>
<td>24/5</td>
<td>Near 24/5</td>
<td>Market hours only</td>
</tr>
<tr>
<td>Leverage</td>
<td>50:1 to 500:1</td>
<td>10:1 to 20:1</td>
<td>2:1 to 4:1</td>
</tr>
<tr>
<td>Minimum Capital</td>
<td>Very low</td>
<td>Moderate</td>
<td>Moderate</td>
</tr>
<tr>
<td>Settlement</td>
<td>T+2 or rolling</td>
<td>Physical/Cash</td>
<td>T+2</td>
</tr>
<tr>
<td>Short Selling</td>
<td>Native (sell currency)</td>
<td>Easy</td>
<td>Requires borrowing</td>
</tr>
</tbody>
</table></div>
<h3>Key Concepts to Master</h3>
<ol>
<li><strong>Leverage</strong> - Amplifies both gains and losses</li>
<li><strong>Pips &amp; Lots</strong> - Forex-specific terminology</li>
<li><strong>Rollover/Swap</strong> - Interest on held positions</li>
<li><strong>Basis &amp; Contango</strong> - Futures pricing dynamics</li>
<li><strong>Economic Calendar</strong> - News drives forex markets</li>
</ol></div>
<div class="md-cell"><hr />
<h2>Environment Setup</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Install required packages (uncomment to run)</span>
<span class="c1"># !pip install oandapyV20 MetaTrader5 ta yfinance pandas numpy matplotlib</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Core imports for the course</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="c1"># Set display options</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Environment ready!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pandas version: </span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;numpy version: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Forex Market Preview</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Major currency pairs</span>
<span class="n">major_pairs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;EUR/USD&#39;</span><span class="p">:</span> <span class="s1">&#39;Euro vs US Dollar&#39;</span><span class="p">,</span>
    <span class="s1">&#39;GBP/USD&#39;</span><span class="p">:</span> <span class="s1">&#39;British Pound vs US Dollar&#39;</span><span class="p">,</span>
    <span class="s1">&#39;USD/JPY&#39;</span><span class="p">:</span> <span class="s1">&#39;US Dollar vs Japanese Yen&#39;</span><span class="p">,</span>
    <span class="s1">&#39;USD/CHF&#39;</span><span class="p">:</span> <span class="s1">&#39;US Dollar vs Swiss Franc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AUD/USD&#39;</span><span class="p">:</span> <span class="s1">&#39;Australian Dollar vs US Dollar&#39;</span><span class="p">,</span>
    <span class="s1">&#39;USD/CAD&#39;</span><span class="p">:</span> <span class="s1">&#39;US Dollar vs Canadian Dollar&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NZD/USD&#39;</span><span class="p">:</span> <span class="s1">&#39;New Zealand Dollar vs US Dollar&#39;</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Major Currency Pairs&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">major_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pair</span><span class="si">:</span><span class="s2">12</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Trading sessions (UTC times)</span>
<span class="n">sessions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Sydney&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;21:00&#39;</span><span class="p">,</span> <span class="s1">&#39;06:00&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD, NZD&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Tokyo&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;09:00&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY pairs&#39;</span><span class="p">),</span>
    <span class="s1">&#39;London&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;08:00&#39;</span><span class="p">,</span> <span class="s1">&#39;17:00&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR, GBP&#39;</span><span class="p">),</span>
    <span class="s1">&#39;New York&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;13:00&#39;</span><span class="p">,</span> <span class="s1">&#39;22:00&#39;</span><span class="p">,</span> <span class="s1">&#39;USD pairs&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Forex Trading Sessions (UTC)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Session&#39;</span><span class="si">:</span><span class="s2">12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Open&#39;</span><span class="si">:</span><span class="s2">8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Close&#39;</span><span class="si">:</span><span class="s2">8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Active Pairs&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">session</span><span class="p">,</span> <span class="p">(</span><span class="n">open_time</span><span class="p">,</span> <span class="n">close_time</span><span class="p">,</span> <span class="n">pairs</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sessions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session</span><span class="si">:</span><span class="s2">12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">open_time</span><span class="si">:</span><span class="s2">8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">close_time</span><span class="si">:</span><span class="s2">8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pairs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Pip value calculation example</span>
<span class="k">def</span> <span class="nf">calculate_pip_value</span><span class="p">(</span><span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lot_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">account_currency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate pip value for a forex pair.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pair: Currency pair (e.g., &#39;EUR/USD&#39;)</span>
<span class="sd">        lot_size: Position size in lots (1 lot = 100,000 units)</span>
<span class="sd">        account_currency: Account denomination</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Pip value in account currency</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Standard lot = 100,000 units</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">lot_size</span> <span class="o">*</span> <span class="mi">100_000</span>
    
    <span class="c1"># For pairs ending in USD, 1 pip = $10 per standard lot</span>
    <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/USD&#39;</span><span class="p">):</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="n">units</span> <span class="o">*</span> <span class="mf">0.0001</span>
    <span class="c1"># For JPY pairs, pip is 0.01</span>
    <span class="k">elif</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">:</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="n">units</span> <span class="o">*</span> <span class="mf">0.01</span> <span class="o">/</span> <span class="mi">150</span>  <span class="c1"># Approximate USD/JPY rate</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="n">units</span> <span class="o">*</span> <span class="mf">0.0001</span>
    
    <span class="k">return</span> <span class="n">pip_value</span>

<span class="c1"># Example calculations</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pip Values (1 Standard Lot = 100,000 units)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/JPY&#39;</span><span class="p">]:</span>
    <span class="n">pip_val</span> <span class="o">=</span> <span class="n">calculate_pip_value</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">lot_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">pip_val</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> per pip&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Futures Market Preview</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Popular futures contracts</span>
<span class="n">futures_contracts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ES&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;E-mini S&amp;P 500&#39;</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="s1">&#39;CME&#39;</span><span class="p">,</span> <span class="s1">&#39;tick_size&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;tick_value&#39;</span><span class="p">:</span> <span class="mf">12.50</span><span class="p">},</span>
    <span class="s1">&#39;NQ&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;E-mini Nasdaq 100&#39;</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="s1">&#39;CME&#39;</span><span class="p">,</span> <span class="s1">&#39;tick_size&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;tick_value&#39;</span><span class="p">:</span> <span class="mf">5.00</span><span class="p">},</span>
    <span class="s1">&#39;CL&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Crude Oil&#39;</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="s1">&#39;NYMEX&#39;</span><span class="p">,</span> <span class="s1">&#39;tick_size&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s1">&#39;tick_value&#39;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">},</span>
    <span class="s1">&#39;GC&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Gold&#39;</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="s1">&#39;COMEX&#39;</span><span class="p">,</span> <span class="s1">&#39;tick_size&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;tick_value&#39;</span><span class="p">:</span> <span class="mf">10.00</span><span class="p">},</span>
    <span class="s1">&#39;6E&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Euro FX&#39;</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="s1">&#39;CME&#39;</span><span class="p">,</span> <span class="s1">&#39;tick_size&#39;</span><span class="p">:</span> <span class="mf">0.00005</span><span class="p">,</span> <span class="s1">&#39;tick_value&#39;</span><span class="p">:</span> <span class="mf">6.25</span><span class="p">},</span>
    <span class="s1">&#39;ZB&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;30-Year Treasury Bond&#39;</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="s1">&#39;CBOT&#39;</span><span class="p">,</span> <span class="s1">&#39;tick_size&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;tick_value&#39;</span><span class="p">:</span> <span class="mf">31.25</span><span class="p">}</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Popular Futures Contracts&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Symbol&#39;</span><span class="si">:</span><span class="s2">8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Name&#39;</span><span class="si">:</span><span class="s2">25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Exchange&#39;</span><span class="si">:</span><span class="s2">10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Tick Size&#39;</span><span class="si">:</span><span class="s2">12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Tick Value&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">futures_contracts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">tick_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;tick_size&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">:</span><span class="s2">8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tick_str</span><span class="si">:</span><span class="s2">12</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;tick_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Contract month codes</span>
<span class="n">month_codes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="s1">&#39;January&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="s1">&#39;February&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="s1">&#39;March&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">:</span> <span class="s1">&#39;April&#39;</span><span class="p">,</span>
    <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;June&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="s1">&#39;July&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="s1">&#39;August&#39;</span><span class="p">,</span>
    <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="s1">&#39;September&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="s1">&#39;October&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;November&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="s1">&#39;December&#39;</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Futures Contract Month Codes&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">month_codes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Basis calculation example</span>
<span class="k">def</span> <span class="nf">calculate_basis</span><span class="p">(</span><span class="n">spot_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">futures_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate futures basis and market condition.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        spot_price: Current spot price</span>
<span class="sd">        futures_price: Futures contract price</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with basis and market condition</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">futures_price</span> <span class="o">-</span> <span class="n">spot_price</span>
    <span class="n">basis_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">basis</span> <span class="o">/</span> <span class="n">spot_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">if</span> <span class="n">basis</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;Contango&#39;</span>
    <span class="k">elif</span> <span class="n">basis</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;Backwardation&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;Flat&#39;</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;basis&#39;</span><span class="p">:</span> <span class="n">basis</span><span class="p">,</span>
        <span class="s1">&#39;basis_pct&#39;</span><span class="p">:</span> <span class="n">basis_pct</span><span class="p">,</span>
        <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="n">condition</span>
    <span class="p">}</span>

<span class="c1"># Example: Gold futures</span>
<span class="n">spot_gold</span> <span class="o">=</span> <span class="mf">2050.00</span>
<span class="n">futures_gold</span> <span class="o">=</span> <span class="mf">2065.50</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_basis</span><span class="p">(</span><span class="n">spot_gold</span><span class="p">,</span> <span class="n">futures_gold</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Gold Futures Basis Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spot Price:    $</span><span class="si">{</span><span class="n">spot_gold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Futures Price: $</span><span class="si">{</span><span class="n">futures_gold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Basis:         $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;basis_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Market:        </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Leverage Preview</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Leverage impact visualization</span>
<span class="k">def</span> <span class="nf">simulate_leveraged_returns</span><span class="p">(</span>
    <span class="n">price_change_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">leverage_levels</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate returns at different leverage levels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">leverage</span> <span class="ow">in</span> <span class="n">leverage_levels</span><span class="p">:</span>
        <span class="n">leveraged_return</span> <span class="o">=</span> <span class="n">price_change_pct</span> <span class="o">*</span> <span class="n">leverage</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Leverage&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">leverage</span><span class="si">}</span><span class="s1">:1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Price Change&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">price_change_pct</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Account Return&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">leveraged_return</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Show impact of 1% price move</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Impact of 1% Price Move at Different Leverage Levels&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">simulate_leveraged_returns</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Impact of -2% Price Move at Different Leverage Levels&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">simulate_leveraged_returns</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Visualize leverage impact</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Price changes from -5% to +5%</span>
<span class="n">price_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">leverage_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>

<span class="c1"># Plot returns</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">leverage</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">leverage_levels</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">price_changes</span> <span class="o">*</span> <span class="n">leverage</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">price_changes</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">leverage</span><span class="si">}</span><span class="s1">:1&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Price Change (%)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Account Return (%)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Leverage Impact on Returns&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Plot margin call threshold</span>
<span class="n">leverage_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">margin_call_threshold</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">leverage_range</span>  <span class="c1"># % move to wipe out account</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">leverage_range</span><span class="p">,</span> <span class="n">margin_call_threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">leverage_range</span><span class="p">,</span> <span class="n">margin_call_threshold</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Leverage Ratio&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Adverse Move to Wipe Out Account (%)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Margin Call Threshold by Leverage&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Add annotations</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;50:1 = 2% move&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                 <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">),</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>OANDA API Preview</h2>
<p>Throughout this course, we'll use the OANDA API for forex data and trading. Here's a preview of how it works.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Mock OANDA-style data for demonstration</span>
<span class="c1"># In real use, you&#39;ll connect to OANDA&#39;s API</span>

<span class="k">def</span> <span class="nf">generate_forex_data</span><span class="p">(</span>
    <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span>
    <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">start_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0850</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate mock forex OHLC data.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pair: Currency pair</span>
<span class="sd">        days: Number of days</span>
<span class="sd">        start_price: Starting price</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with OHLC data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span> <span class="n">periods</span><span class="o">=</span><span class="n">days</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    
    <span class="c1"># Generate price path</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
    <span class="n">close_prices</span> <span class="o">=</span> <span class="n">start_price</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span>
    
    <span class="c1"># Generate OHLC from close</span>
    <span class="n">daily_volatility</span> <span class="o">=</span> <span class="mf">0.003</span>
    <span class="n">high_prices</span> <span class="o">=</span> <span class="n">close_prices</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">daily_volatility</span><span class="p">,</span> <span class="n">days</span><span class="p">)))</span>
    <span class="n">low_prices</span> <span class="o">=</span> <span class="n">close_prices</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">daily_volatility</span><span class="p">,</span> <span class="n">days</span><span class="p">)))</span>
    <span class="n">open_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">close_prices</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">open_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_price</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">open_prices</span><span class="p">,</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">high_prices</span><span class="p">,</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">low_prices</span><span class="p">,</span>
        <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">close_prices</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># Generate sample data</span>
<span class="n">eur_usd</span> <span class="o">=</span> <span class="n">generate_forex_data</span><span class="p">(</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EUR/USD Sample Data&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">eur_usd</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Visualize forex data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># Candlestick-style visualization using bars</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> 
          <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">eur_usd</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>

<span class="c1"># Plot high-low lines</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eur_usd</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EUR/USD Price Chart&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Set x-axis labels</span>
<span class="n">tick_positions</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eur_usd</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">eur_usd</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tick_positions</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">tick_positions</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">)</span>

<span class="c1"># Volume</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eur_usd</span><span class="p">)),</span> <span class="n">eur_usd</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Volume&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">tick_positions</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Course Projects Overview</h2>
<p>Each module ends with a hands-on project:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Project</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Forex Market Analyzer</td>
</tr>
<tr>
<td>2</td>
<td>Futures Data Handler</td>
</tr>
<tr>
<td>3</td>
<td>Leverage Risk Calculator</td>
</tr>
<tr>
<td>4</td>
<td>Forex Data System</td>
</tr>
<tr>
<td>5</td>
<td>Technical Analysis Suite</td>
</tr>
<tr>
<td>6</td>
<td>Fundamental Dashboard</td>
</tr>
<tr>
<td>7</td>
<td>Commodity Trading System</td>
</tr>
<tr>
<td>8</td>
<td>Multi-Strategy Forex System</td>
</tr>
<tr>
<td>9</td>
<td>Risk Management System</td>
</tr>
<tr>
<td>10</td>
<td>Forex/Futures Backtester</td>
</tr>
<tr>
<td>11</td>
<td>Live Trading System</td>
</tr>
<tr>
<td>12</td>
<td>Advanced Strategy Toolkit</td>
</tr>
<tr>
<td>13</td>
<td>Production Monitoring System</td>
</tr>
<tr>
<td>14</td>
<td>Automated Trading Journal</td>
</tr>
<tr>
<td><strong>Capstone</strong></td>
<td><strong>24-Hour Forex/Futures Trading System</strong></td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><hr />
<h2>Getting Started</h2>
<h3>Recommended Setup</h3>
<ol>
<li><strong>OANDA Demo Account</strong></li>
<li>Sign up at <a href="https://www.oanda.com">OANDA</a></li>
<li>Create practice account for API access</li>
<li>
<p>No deposit required for demo trading</p>
</li>
<li>
<p><strong>Install Required Packages</strong>
   <code>bash
   pip install oandapyV20 MetaTrader5 ta yfinance pandas numpy matplotlib</code></p>
</li>
<li>
<p><strong>Start Learning</strong></p>
</li>
<li>Begin with Module 1: Forex Market Basics</li>
<li>Complete all exercises (3 guided + 3 open-ended per module)</li>
<li>Build each module project</li>
</ol>
<h3>Tips for Success</h3>
<ul>
<li><strong>Start with demo accounts</strong> - Never trade real money while learning</li>
<li><strong>Respect leverage</strong> - It's a double-edged sword</li>
<li><strong>Understand costs</strong> - Spreads, swaps, and commissions add up</li>
<li><strong>Master risk management</strong> - Position sizing is critical in leveraged markets</li>
<li><strong>Practice 24h thinking</strong> - These markets never sleep</li>
</ul></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ul>
<li><strong>Forex</strong> is the largest financial market with $7.5 trillion daily volume</li>
<li><strong>Futures</strong> provide standardized contracts for commodities, indices, and currencies</li>
<li><strong>Leverage</strong> amplifies both gains and losses - handle with care</li>
<li><strong>24-hour markets</strong> require different operational approaches</li>
<li><strong>Economic events</strong> drive forex markets more than other asset classes</li>
</ul>
<hr />
<p><strong>Next: Module 1 - Forex Market Basics</strong></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="1"><div class="md-cell module-header"><h1>Module 1: Forex Market Basics</h1>
<h2>Part 1: Market Fundamentals</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:</p>
<ul>
<li>Understand how currency pairs work (base vs quote currency)</li>
<li>Identify major, minor, and exotic currency pairs</li>
<li>Navigate the decentralized forex market structure</li>
<li>Understand trading sessions and their characteristics</li>
<li>Calculate pip values for different currency pairs</li>
<li>Work with lot sizes and position sizing</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Standard imports for this module</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Display settings</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>1.1 What is Forex?</h2>
<p>The <strong>foreign exchange market (Forex or FX)</strong> is the global marketplace for trading currencies. It's the largest and most liquid financial market in the world, with a daily trading volume exceeding $7.5 trillion.</p>
<h3>Currency Pairs Explained</h3>
<p>In forex, currencies are always traded in pairs. When you trade EUR/USD, you're simultaneously:
- <strong>Buying</strong> one currency (base currency)
- <strong>Selling</strong> another currency (quote currency)</p>
<div class="highlight"><pre><span></span><code>EUR/USD = 1.0850
 â”‚   â”‚      â”‚
 â”‚   â”‚      â””â”€â”€ Price: 1 EUR = 1.0850 USD
 â”‚   â””â”€â”€ Quote Currency (what you pay)
 â””â”€â”€ Base Currency (what you buy)
</code></pre></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Understanding currency pairs</span>
<span class="k">class</span> <span class="nc">CurrencyPair</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a forex currency pair.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        base: Base currency code</span>
<span class="sd">        quote: Quote currency code</span>
<span class="sd">        price: Current exchange rate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quote</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="o">=</span> <span class="n">quote</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the pair symbol.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;base_to_quote&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert an amount between currencies.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            amount: Amount to convert</span>
<span class="sd">            direction: &#39;base_to_quote&#39; or &#39;quote_to_base&#39;</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Converted amount</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;base_to_quote&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">amount</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">amount</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;CurrencyPair(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="si">}</span><span class="s2">)&quot;</span>


<span class="c1"># Example usage</span>
<span class="n">eur_usd</span> <span class="o">=</span> <span class="n">CurrencyPair</span><span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pair: </span><span class="si">{</span><span class="n">eur_usd</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate: </span><span class="si">{</span><span class="n">eur_usd</span><span class="o">.</span><span class="n">price</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">10,000 EUR = </span><span class="si">{</span><span class="n">eur_usd</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> USD&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;10,000 USD = </span><span class="si">{</span><span class="n">eur_usd</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="s1">&#39;quote_to_base&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> EUR&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Major, Minor, and Exotic Pairs</h3>
<p>Currency pairs are categorized based on trading volume and liquidity:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Category</th>
<th>Description</th>
<th>Examples</th>
<th>Spread</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Major</strong></td>
<td>USD paired with major economies</td>
<td>EUR/USD, GBP/USD, USD/JPY</td>
<td>Tightest (0.5-2 pips)</td>
</tr>
<tr>
<td><strong>Minor</strong></td>
<td>Major currencies without USD</td>
<td>EUR/GBP, EUR/JPY, GBP/JPY</td>
<td>Moderate (2-5 pips)</td>
</tr>
<tr>
<td><strong>Exotic</strong></td>
<td>Major + emerging market currency</td>
<td>USD/TRY, EUR/ZAR, USD/MXN</td>
<td>Widest (5-50+ pips)</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Currency pair classifications</span>
<span class="n">MAJOR_PAIRS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;EUR/USD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Euro&#39;</span><span class="p">,</span> <span class="s1">&#39;nickname&#39;</span><span class="p">:</span> <span class="s1">&#39;Fiber&#39;</span><span class="p">},</span>
    <span class="s1">&#39;GBP/USD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;British Pound&#39;</span><span class="p">,</span> <span class="s1">&#39;nickname&#39;</span><span class="p">:</span> <span class="s1">&#39;Cable&#39;</span><span class="p">},</span>
    <span class="s1">&#39;USD/JPY&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Japanese Yen&#39;</span><span class="p">,</span> <span class="s1">&#39;nickname&#39;</span><span class="p">:</span> <span class="s1">&#39;Gopher&#39;</span><span class="p">},</span>
    <span class="s1">&#39;USD/CHF&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Swiss Franc&#39;</span><span class="p">,</span> <span class="s1">&#39;nickname&#39;</span><span class="p">:</span> <span class="s1">&#39;Swissie&#39;</span><span class="p">},</span>
    <span class="s1">&#39;AUD/USD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Australian Dollar&#39;</span><span class="p">,</span> <span class="s1">&#39;nickname&#39;</span><span class="p">:</span> <span class="s1">&#39;Aussie&#39;</span><span class="p">},</span>
    <span class="s1">&#39;USD/CAD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Canadian Dollar&#39;</span><span class="p">,</span> <span class="s1">&#39;nickname&#39;</span><span class="p">:</span> <span class="s1">&#39;Loonie&#39;</span><span class="p">},</span>
    <span class="s1">&#39;NZD/USD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;New Zealand Dollar&#39;</span><span class="p">,</span> <span class="s1">&#39;nickname&#39;</span><span class="p">:</span> <span class="s1">&#39;Kiwi&#39;</span><span class="p">}</span>
<span class="p">}</span>

<span class="n">MINOR_PAIRS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;EUR/GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR/JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR/CHF&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR/AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR/CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR/NZD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;GBP/JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP/CHF&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP/AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP/CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP/NZD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AUD/JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD/CHF&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD/CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD/NZD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CAD/JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD/CHF&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF/JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD/JPY&#39;</span>
<span class="p">]</span>

<span class="n">EXOTIC_PAIRS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;USD/TRY&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/ZAR&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/MXN&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/SGD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/HKD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;USD/SEK&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/NOK&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/DKK&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/PLN&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/HUF&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EUR/TRY&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR/ZAR&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR/NOK&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR/SEK&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR/PLN&#39;</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Major Pairs (USD-based, highest liquidity)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">MAJOR_PAIRS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pair</span><span class="si">:</span><span class="s2">10</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">25</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;nickname&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Minor Pairs (Cross pairs without USD): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">MINOR_PAIRS</span><span class="p">)</span><span class="si">}</span><span class="s2"> pairs&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exotic Pairs (Emerging market currencies): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">EXOTIC_PAIRS</span><span class="p">)</span><span class="si">}</span><span class="s2"> pairs&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">classify_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classify a currency pair as major, minor, or exotic.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pair: Currency pair symbol (e.g., &#39;EUR/USD&#39;)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Classification string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">MAJOR_PAIRS</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Major&#39;</span>
    <span class="k">elif</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">MINOR_PAIRS</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Minor&#39;</span>
    <span class="k">elif</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">EXOTIC_PAIRS</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Exotic&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check if it could be exotic based on currency codes</span>
        <span class="n">exotic_currencies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TRY&#39;</span><span class="p">,</span> <span class="s1">&#39;ZAR&#39;</span><span class="p">,</span> <span class="s1">&#39;MXN&#39;</span><span class="p">,</span> <span class="s1">&#39;SGD&#39;</span><span class="p">,</span> <span class="s1">&#39;HKD&#39;</span><span class="p">,</span> <span class="s1">&#39;SEK&#39;</span><span class="p">,</span> <span class="s1">&#39;NOK&#39;</span><span class="p">,</span> 
                           <span class="s1">&#39;DKK&#39;</span><span class="p">,</span> <span class="s1">&#39;PLN&#39;</span><span class="p">,</span> <span class="s1">&#39;HUF&#39;</span><span class="p">,</span> <span class="s1">&#39;CZK&#39;</span><span class="p">,</span> <span class="s1">&#39;RUB&#39;</span><span class="p">,</span> <span class="s1">&#39;BRL&#39;</span><span class="p">,</span> <span class="s1">&#39;INR&#39;</span><span class="p">]</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">exotic_currencies</span> <span class="ow">or</span> <span class="n">quote</span> <span class="ow">in</span> <span class="n">exotic_currencies</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Exotic&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span>

<span class="c1"># Test classification</span>
<span class="n">test_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP/JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/TRY&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD/NZD&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR/ZAR&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pair Classification&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">test_pairs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pair</span><span class="si">:</span><span class="s2">12</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">classify_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>1.2 Market Structure</h2>
<h3>Decentralized Market</h3>
<p>Unlike stock exchanges, forex has no central exchange. It operates as an <strong>Over-The-Counter (OTC)</strong> market where trading happens electronically between participants worldwide.</p>
<h3>Market Hierarchy</h3>
<div class="highlight"><pre><span></span><code>                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Interbank Market  â”‚ â† Largest banks trade directly
                    â”‚  (Tier 1 Liquidity) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                â”‚                â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Prime Brokers   â”‚ â”‚  ECNs   â”‚ â”‚ Market Makers   â”‚
     â”‚ (Hedge Funds)   â”‚ â”‚         â”‚ â”‚ (Retail Flow)   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Retail Brokers   â”‚
                    â”‚  (Your Broker)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Retail Traders  â”‚ â† You
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Market participants and their characteristics</span>
<span class="n">MARKET_PARTICIPANTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Central Banks&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;Monetary policy, currency intervention&#39;</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="s1">&#39;Massive but infrequent&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Federal Reserve&#39;</span><span class="p">,</span> <span class="s1">&#39;ECB&#39;</span><span class="p">,</span> <span class="s1">&#39;BOJ&#39;</span><span class="p">,</span> <span class="s1">&#39;BOE&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Commercial Banks&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;Interbank trading, customer orders&#39;</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="s1">&#39;Very high (Tier 1 liquidity)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;JP Morgan&#39;</span><span class="p">,</span> <span class="s1">&#39;Citi&#39;</span><span class="p">,</span> <span class="s1">&#39;Deutsche Bank&#39;</span><span class="p">,</span> <span class="s1">&#39;UBS&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Investment Banks&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;Proprietary trading, market making&#39;</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Goldman Sachs&#39;</span><span class="p">,</span> <span class="s1">&#39;Morgan Stanley&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Hedge Funds&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;Speculative trading, arbitrage&#39;</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Bridgewater&#39;</span><span class="p">,</span> <span class="s1">&#39;Citadel&#39;</span><span class="p">,</span> <span class="s1">&#39;Renaissance&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Corporations&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;Hedging currency exposure&#39;</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="s1">&#39;Moderate&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Apple&#39;</span><span class="p">,</span> <span class="s1">&#39;Toyota&#39;</span><span class="p">,</span> <span class="s1">&#39;NestlÃ©&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Retail Traders&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;Speculation&#39;</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="s1">&#39;Low (5-10</span><span class="si">% o</span><span class="s1">f market)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Individual traders via brokers&#39;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forex Market Participants&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="k">for</span> <span class="n">participant</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">MARKET_PARTICIPANTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">participant</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Role: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volume: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Examples: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;examples&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Market share by participant type (approximate)</span>
<span class="n">participant_shares</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Commercial Banks&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
    <span class="s1">&#39;Investment Banks&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
    <span class="s1">&#39;Hedge Funds&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s1">&#39;Central Banks&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">&#39;Corporations&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">&#39;Retail Traders&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s1">&#39;Other&#39;</span><span class="p">:</span> <span class="mi">5</span>
<span class="p">}</span>

<span class="c1"># Visualize market share</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set3</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">participant_shares</span><span class="p">)))</span>
<span class="n">wedges</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">autotexts</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
    <span class="n">participant_shares</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">participant_shares</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
    <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.0f%%</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
    <span class="n">explode</span><span class="o">=</span><span class="p">[</span><span class="mf">0.02</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">participant_shares</span><span class="p">),</span>
    <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Forex Market Share by Participant Type&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 1.1: Identify Currency Pair Types (Guided)</h2>
<p>Complete the function to identify whether a currency pair is major, minor, or exotic.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 1.1: Identify Currency Pair Types (Guided)</span>
<span class="k">def</span> <span class="nf">identify_pair_type</span><span class="p">(</span><span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify the type and characteristics of a currency pair.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pair: Currency pair symbol (e.g., &#39;EUR/USD&#39;)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with pair type and characteristics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize the pair format</span>
    <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">______</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># Convert to uppercase</span>
    
    <span class="c1"># Split into base and quote currencies</span>
    <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># Split by delimiter</span>
    
    <span class="c1"># Define major currencies</span>
    <span class="n">major_currencies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]</span>
    
    <span class="c1"># Determine pair type</span>
    <span class="n">has_usd</span> <span class="o">=</span> <span class="n">______</span> <span class="ow">in</span> <span class="n">pair</span>  <span class="c1"># Check if USD is in the pair</span>
    <span class="n">both_major</span> <span class="o">=</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">major_currencies</span> <span class="ow">and</span> <span class="n">quote</span> <span class="ow">in</span> <span class="n">major_currencies</span>
    
    <span class="k">if</span> <span class="n">has_usd</span> <span class="ow">and</span> <span class="n">both_major</span><span class="p">:</span>
        <span class="n">pair_type</span> <span class="o">=</span> <span class="s1">&#39;Major&#39;</span>
        <span class="n">typical_spread</span> <span class="o">=</span> <span class="s1">&#39;0.5-2 pips&#39;</span>
    <span class="k">elif</span> <span class="n">both_major</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_usd</span><span class="p">:</span>
        <span class="n">pair_type</span> <span class="o">=</span> <span class="s1">&#39;Minor&#39;</span>
        <span class="n">typical_spread</span> <span class="o">=</span> <span class="s1">&#39;2-5 pips&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pair_type</span> <span class="o">=</span> <span class="s1">&#39;Exotic&#39;</span>
        <span class="n">typical_spread</span> <span class="o">=</span> <span class="s1">&#39;5-50+ pips&#39;</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
        <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="n">base</span><span class="p">,</span>
        <span class="s1">&#39;quote&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">pair_type</span><span class="p">,</span>
        <span class="s1">&#39;typical_spread&#39;</span><span class="p">:</span> <span class="n">typical_spread</span>
    <span class="p">}</span>

<span class="c1"># Test the function</span>
<span class="n">test_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP/JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/TRY&#39;</span><span class="p">,</span> <span class="s1">&#39;eur_gbp&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">test_pairs</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">identify_pair_type</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">10</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">7</span><span class="si">}</span><span class="s2"> (Spread: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;typical_spread&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">identify_pair_type</span><span class="p">(</span><span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify the type and characteristics of a currency pair.</span>

<span class="sd">    Args:</span>
<span class="sd">        pair: Currency pair symbol (e.g., &#39;EUR/USD&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with pair type and characteristics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize the pair format</span>
    <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># Convert to uppercase</span>

    <span class="c1"># Split into base and quote currencies</span>
    <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># Split by delimiter</span>

    <span class="c1"># Define major currencies</span>
    <span class="n">major_currencies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]</span>

    <span class="c1"># Determine pair type</span>
    <span class="n">has_usd</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span> <span class="ow">in</span> <span class="n">pair</span>  <span class="c1"># Check if USD is in the pair</span>
    <span class="n">both_major</span> <span class="o">=</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">major_currencies</span> <span class="ow">and</span> <span class="n">quote</span> <span class="ow">in</span> <span class="n">major_currencies</span>

    <span class="k">if</span> <span class="n">has_usd</span> <span class="ow">and</span> <span class="n">both_major</span><span class="p">:</span>
        <span class="n">pair_type</span> <span class="o">=</span> <span class="s1">&#39;Major&#39;</span>
        <span class="n">typical_spread</span> <span class="o">=</span> <span class="s1">&#39;0.5-2 pips&#39;</span>
    <span class="k">elif</span> <span class="n">both_major</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_usd</span><span class="p">:</span>
        <span class="n">pair_type</span> <span class="o">=</span> <span class="s1">&#39;Minor&#39;</span>
        <span class="n">typical_spread</span> <span class="o">=</span> <span class="s1">&#39;2-5 pips&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pair_type</span> <span class="o">=</span> <span class="s1">&#39;Exotic&#39;</span>
        <span class="n">typical_spread</span> <span class="o">=</span> <span class="s1">&#39;5-50+ pips&#39;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
        <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="n">base</span><span class="p">,</span>
        <span class="s1">&#39;quote&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">pair_type</span><span class="p">,</span>
        <span class="s1">&#39;typical_spread&#39;</span><span class="p">:</span> <span class="n">typical_spread</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>1.3 Trading Sessions</h2>
<p>The forex market operates 24 hours a day, 5 days a week. Trading activity rotates through four major sessions as the sun moves around the globe.</p>
<h3>Session Times (UTC)</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Session</th>
<th>Open (UTC)</th>
<th>Close (UTC)</th>
<th>Key Pairs</th>
<th>Characteristics</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Sydney</strong></td>
<td>21:00</td>
<td>06:00</td>
<td>AUD, NZD</td>
<td>Low volatility start</td>
</tr>
<tr>
<td><strong>Tokyo</strong></td>
<td>00:00</td>
<td>09:00</td>
<td>JPY pairs</td>
<td>Moderate activity</td>
</tr>
<tr>
<td><strong>London</strong></td>
<td>08:00</td>
<td>17:00</td>
<td>EUR, GBP</td>
<td>Highest volume</td>
</tr>
<tr>
<td><strong>New York</strong></td>
<td>13:00</td>
<td>22:00</td>
<td>USD pairs</td>
<td>High volatility</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ForexSession</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a forex trading session.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        name: Session name</span>
<span class="sd">        open_hour: Opening hour in UTC</span>
<span class="sd">        close_hour: Closing hour in UTC</span>
<span class="sd">        key_currencies: Most active currencies during session</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">open_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">close_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                 <span class="n">key_currencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_hour</span> <span class="o">=</span> <span class="n">open_hour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_hour</span> <span class="o">=</span> <span class="n">close_hour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_currencies</span> <span class="o">=</span> <span class="n">key_currencies</span>
    
    <span class="k">def</span> <span class="nf">is_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the session is open at a given UTC hour.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hour</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hour</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hour</span> <span class="o">&lt;=</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hour</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Crosses midnight</span>
            <span class="k">return</span> <span class="n">utc_hour</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hour</span> <span class="ow">or</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_hour</span>
    
    <span class="k">def</span> <span class="nf">hours_until_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate hours until session opens.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span><span class="p">(</span><span class="n">utc_hour</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_hour</span> <span class="o">-</span> <span class="n">utc_hour</span><span class="p">)</span> <span class="o">%</span> <span class="mi">24</span>
        <span class="k">return</span> <span class="n">hours</span>


<span class="c1"># Define the four major sessions</span>
<span class="n">SESSIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Sydney&#39;</span><span class="p">:</span> <span class="n">ForexSession</span><span class="p">(</span><span class="s1">&#39;Sydney&#39;</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;Tokyo&#39;</span><span class="p">:</span> <span class="n">ForexSession</span><span class="p">(</span><span class="s1">&#39;Tokyo&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;London&#39;</span><span class="p">:</span> <span class="n">ForexSession</span><span class="p">(</span><span class="s1">&#39;London&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;New York&#39;</span><span class="p">:</span> <span class="n">ForexSession</span><span class="p">(</span><span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">])</span>
<span class="p">}</span>

<span class="c1"># Check current session status</span>
<span class="n">current_utc_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">hour</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current UTC Hour: </span><span class="si">{</span><span class="n">current_utc_hour</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Session Status&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;OPEN&quot;</span> <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">is_open</span><span class="p">(</span><span class="n">current_utc_hour</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;CLOSED&quot;</span>
    <span class="n">hours_until</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">hours_until_open</span><span class="p">(</span><span class="n">current_utc_hour</span><span class="p">)</span>
    <span class="n">hours_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">hours_until</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot; (opens in </span><span class="si">{</span><span class="n">hours_until</span><span class="si">}</span><span class="s2">h)&quot;</span>
    <span class="n">currencies</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">key_currencies</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">status</span><span class="si">:</span><span class="s2">6</span><span class="si">}{</span><span class="n">hours_info</span><span class="si">:</span><span class="s2">15</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">currencies</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Visualize session overlaps</span>
<span class="k">def</span> <span class="nf">plot_forex_sessions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create a visual representation of forex trading sessions.&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="n">sessions_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;Sydney&#39;</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;#2ecc71&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Tokyo&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;#e74c3c&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;London&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;#3498db&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="s1">&#39;#9b59b6&#39;</span><span class="p">)</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sessions_data</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.8</span>
        
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>  <span class="c1"># Crosses midnight</span>
            <span class="c1"># Draw first part (start to midnight)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">24</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="c1"># Draw second part (midnight to end)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    
    <span class="c1"># Highlight overlaps</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Tokyo-London Overlap&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;London-NY Overlap&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;UTC Hour&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">h</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">:00&#39;</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Forex Trading Sessions (UTC)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plot_forex_sessions</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Session volatility analysis</span>
<span class="k">def</span> <span class="nf">estimate_session_volatility</span><span class="p">(</span><span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate typical volatility for a pair during a session.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pair: Currency pair</span>
<span class="sd">        session: Trading session name</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with volatility estimates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Volatility multipliers (base = London session)</span>
    <span class="n">session_multipliers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Sydney&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;Tokyo&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
        <span class="s1">&#39;London&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s1">&#39;New York&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
        <span class="s1">&#39;London-NY Overlap&#39;</span><span class="p">:</span> <span class="mf">1.2</span>
    <span class="p">}</span>
    
    <span class="c1"># Base pip ranges per pair (approximate daily range in London)</span>
    <span class="n">base_ranges</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;EUR/USD&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s1">&#39;GBP/USD&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
        <span class="s1">&#39;USD/JPY&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s1">&#39;AUD/USD&#39;</span><span class="p">:</span> <span class="mi">65</span><span class="p">,</span>
        <span class="s1">&#39;USD/CAD&#39;</span><span class="p">:</span> <span class="mi">70</span>
    <span class="p">}</span>
    
    <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">base_range</span> <span class="o">=</span> <span class="n">base_ranges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="n">session_multipliers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    
    <span class="n">session_range</span> <span class="o">=</span> <span class="n">base_range</span> <span class="o">*</span> <span class="n">multiplier</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
        <span class="s1">&#39;session&#39;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span>
        <span class="s1">&#39;expected_range_pips&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">session_range</span><span class="p">),</span>
        <span class="s1">&#39;volatility_level&#39;</span><span class="p">:</span> <span class="s1">&#39;High&#39;</span> <span class="k">if</span> <span class="n">multiplier</span> <span class="o">&gt;=</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="s1">&#39;Medium&#39;</span> <span class="k">if</span> <span class="n">multiplier</span> <span class="o">&gt;=</span> <span class="mf">0.7</span> <span class="k">else</span> <span class="s1">&#39;Low&#39;</span>
    <span class="p">}</span>

<span class="c1"># Compare volatility across sessions</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EUR/USD Volatility by Session&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Sydney&#39;</span><span class="p">,</span> <span class="s1">&#39;Tokyo&#39;</span><span class="p">,</span> <span class="s1">&#39;London&#39;</span><span class="p">,</span> <span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="s1">&#39;London-NY Overlap&#39;</span><span class="p">]:</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">estimate_session_volatility</span><span class="p">(</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session</span><span class="si">:</span><span class="s2">20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">vol</span><span class="p">[</span><span class="s1">&#39;expected_range_pips&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">3</span><span class="si">}</span><span class="s2"> pips (</span><span class="si">{</span><span class="n">vol</span><span class="p">[</span><span class="s1">&#39;volatility_level&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 1.2: Session Analysis (Guided)</h2>
<p>Complete the function to determine active sessions for a given UTC time.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 1.2: Session Analysis (Guided)</span>
<span class="k">def</span> <span class="nf">get_active_sessions</span><span class="p">(</span><span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine which forex sessions are active at a given UTC hour.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        utc_hour: Hour in UTC (0-23)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with active sessions and trading conditions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sessions_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Sydney&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>    <span class="c1"># 21:00 - 06:00</span>
        <span class="s1">&#39;Tokyo&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>      <span class="c1"># 00:00 - 09:00</span>
        <span class="s1">&#39;London&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span>    <span class="c1"># 08:00 - 17:00</span>
        <span class="s1">&#39;New York&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>  <span class="c1"># 13:00 - 22:00</span>
    <span class="p">}</span>
    
    <span class="n">active</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">session</span><span class="p">,</span> <span class="p">(</span><span class="n">open_h</span><span class="p">,</span> <span class="n">close_h</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sessions_info</span><span class="o">.</span><span class="n">______</span><span class="p">():</span>  <span class="c1"># Iterate over items</span>
        <span class="k">if</span> <span class="n">open_h</span> <span class="o">&gt;</span> <span class="n">close_h</span><span class="p">:</span>  <span class="c1"># Session crosses midnight</span>
            <span class="n">is_open</span> <span class="o">=</span> <span class="n">utc_hour</span> <span class="o">&gt;=</span> <span class="n">open_h</span> <span class="n">______</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">close_h</span>  <span class="c1"># Logical OR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_open</span> <span class="o">=</span> <span class="n">open_h</span> <span class="o">&lt;=</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">close_h</span>
        
        <span class="k">if</span> <span class="n">is_open</span><span class="p">:</span>
            <span class="n">active</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>  <span class="c1"># Add to list</span>
    
    <span class="c1"># Determine trading conditions</span>
    <span class="n">num_active</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">active</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_active</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;High Volatility (Session Overlap)&#39;</span>
    <span class="k">elif</span> <span class="n">num_active</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;Normal Volatility&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;Low Volatility (Weekend)&#39;</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;utc_hour&#39;</span><span class="p">:</span> <span class="n">utc_hour</span><span class="p">,</span>
        <span class="s1">&#39;active_sessions&#39;</span><span class="p">:</span> <span class="n">active</span><span class="p">,</span>
        <span class="s1">&#39;num_sessions&#39;</span><span class="p">:</span> <span class="n">num_active</span><span class="p">,</span>
        <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="n">condition</span>
    <span class="p">}</span>

<span class="c1"># Test for different hours</span>
<span class="n">test_hours</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">23</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session Analysis by UTC Hour&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">test_hours</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">get_active_sessions</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;active_sessions&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;active_sessions&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;None&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hour</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00 UTC -&gt; </span><span class="si">{</span><span class="n">sessions</span><span class="si">:</span><span class="s2">25</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_active_sessions</span><span class="p">(</span><span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine which forex sessions are active at a given UTC hour.</span>

<span class="sd">    Args:</span>
<span class="sd">        utc_hour: Hour in UTC (0-23)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with active sessions and trading conditions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sessions_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Sydney&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>    <span class="c1"># 21:00 - 06:00</span>
        <span class="s1">&#39;Tokyo&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>      <span class="c1"># 00:00 - 09:00</span>
        <span class="s1">&#39;London&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span>    <span class="c1"># 08:00 - 17:00</span>
        <span class="s1">&#39;New York&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>  <span class="c1"># 13:00 - 22:00</span>
    <span class="p">}</span>

    <span class="n">active</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">session</span><span class="p">,</span> <span class="p">(</span><span class="n">open_h</span><span class="p">,</span> <span class="n">close_h</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sessions_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># Iterate over items</span>
        <span class="k">if</span> <span class="n">open_h</span> <span class="o">&gt;</span> <span class="n">close_h</span><span class="p">:</span>  <span class="c1"># Session crosses midnight</span>
            <span class="n">is_open</span> <span class="o">=</span> <span class="n">utc_hour</span> <span class="o">&gt;=</span> <span class="n">open_h</span> <span class="ow">or</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">close_h</span>  <span class="c1"># Logical OR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_open</span> <span class="o">=</span> <span class="n">open_h</span> <span class="o">&lt;=</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">close_h</span>

        <span class="k">if</span> <span class="n">is_open</span><span class="p">:</span>
            <span class="n">active</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>  <span class="c1"># Add to list</span>

    <span class="c1"># Determine trading conditions</span>
    <span class="n">num_active</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">active</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_active</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;High Volatility (Session Overlap)&#39;</span>
    <span class="k">elif</span> <span class="n">num_active</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;Normal Volatility&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;Low Volatility (Weekend)&#39;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;utc_hour&#39;</span><span class="p">:</span> <span class="n">utc_hour</span><span class="p">,</span>
        <span class="s1">&#39;active_sessions&#39;</span><span class="p">:</span> <span class="n">active</span><span class="p">,</span>
        <span class="s1">&#39;num_sessions&#39;</span><span class="p">:</span> <span class="n">num_active</span><span class="p">,</span>
        <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="n">condition</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>1.4 Pips &amp; Lots</h2>
<h3>What is a Pip?</h3>
<p>A <strong>pip</strong> (Percentage in Point) is the smallest price movement in forex:</p>
<ul>
<li>For most pairs: <strong>0.0001</strong> (fourth decimal place)</li>
<li>For JPY pairs: <strong>0.01</strong> (second decimal place)</li>
</ul>
<div class="highlight"><pre><span></span><code>EUR/USD: 1.0850 â†’ 1.0851 = +1 pip
USD/JPY: 150.00 â†’ 150.01 = +1 pip
</code></pre></div>

<h3>Lot Sizes</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Lot Type</th>
<th>Units</th>
<th>EUR/USD Pip Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Standard</td>
<td>100,000</td>
<td>$10 per pip</td>
</tr>
<tr>
<td>Mini</td>
<td>10,000</td>
<td>$1 per pip</td>
</tr>
<tr>
<td>Micro</td>
<td>1,000</td>
<td>$0.10 per pip</td>
</tr>
<tr>
<td>Nano</td>
<td>100</td>
<td>$0.01 per pip</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">PipCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculator for pip values and position sizing.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        pair: Currency pair</span>
<span class="sd">        account_currency: Account denomination currency</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Pip sizes for different pair types</span>
    <span class="n">STANDARD_PIP</span> <span class="o">=</span> <span class="mf">0.0001</span>
    <span class="n">JPY_PIP</span> <span class="o">=</span> <span class="mf">0.01</span>
    
    <span class="c1"># Lot sizes</span>
    <span class="n">LOT_SIZES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;standard&#39;</span><span class="p">:</span> <span class="mi">100_000</span><span class="p">,</span>
        <span class="s1">&#39;mini&#39;</span><span class="p">:</span> <span class="mi">10_000</span><span class="p">,</span>
        <span class="s1">&#39;micro&#39;</span><span class="p">:</span> <span class="mi">1_000</span><span class="p">,</span>
        <span class="s1">&#39;nano&#39;</span><span class="p">:</span> <span class="mi">100</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">account_currency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span> <span class="o">=</span> <span class="n">account_currency</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pip_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the pip size for this pair.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">JPY_PIP</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_PIP</span>
    
    <span class="k">def</span> <span class="nf">pip_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lot_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">exchange_rate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate pip value in account currency.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            lot_size: Position size in lots</span>
<span class="sd">            exchange_rate: Current exchange rate (for conversion if needed)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Pip value in account currency</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">lot_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOT_SIZES</span><span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">]</span>
        <span class="n">pip_value_in_quote</span> <span class="o">=</span> <span class="n">units</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pip_size</span>
        
        <span class="c1"># If quote currency matches account currency, we&#39;re done</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pip_value_in_quote</span>
        
        <span class="c1"># Otherwise, need to convert (simplified - assumes USD account)</span>
        <span class="k">if</span> <span class="n">exchange_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span> <span class="o">==</span> <span class="s1">&#39;USD&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">==</span> <span class="s1">&#39;USD&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pip_value_in_quote</span> <span class="o">/</span> <span class="n">exchange_rate</span>
        
        <span class="k">return</span> <span class="n">pip_value_in_quote</span>
    
    <span class="k">def</span> <span class="nf">pips_to_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pips</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert pips to price movement.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pips</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pip_size</span>
    
    <span class="k">def</span> <span class="nf">price_to_pips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_change</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert price movement to pips.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">price_change</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pip_size</span>


<span class="c1"># Example calculations</span>
<span class="n">calc</span> <span class="o">=</span> <span class="n">PipCalculator</span><span class="p">(</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EUR/USD Pip Calculations&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pip size: </span><span class="si">{</span><span class="n">calc</span><span class="o">.</span><span class="n">pip_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1 standard lot pip value: $</span><span class="si">{</span><span class="n">calc</span><span class="o">.</span><span class="n">pip_value</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1 mini lot pip value: $</span><span class="si">{</span><span class="n">calc</span><span class="o">.</span><span class="n">pip_value</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1 micro lot pip value: $</span><span class="si">{</span><span class="n">calc</span><span class="o">.</span><span class="n">pip_value</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">50 pips = </span><span class="si">{</span><span class="n">calc</span><span class="o">.</span><span class="n">pips_to_price</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> price movement&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">calc_jpy</span> <span class="o">=</span> <span class="n">PipCalculator</span><span class="p">(</span><span class="s1">&#39;USD/JPY&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USD/JPY pip size: </span><span class="si">{</span><span class="n">calc_jpy</span><span class="o">.</span><span class="n">pip_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;50 pips = </span><span class="si">{</span><span class="n">calc_jpy</span><span class="o">.</span><span class="n">pips_to_price</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> price movement&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Pip value comparison across pairs</span>
<span class="k">def</span> <span class="nf">compare_pip_values</span><span class="p">(</span><span class="n">pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">lot_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare pip values across different currency pairs.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pairs: List of currency pairs</span>
<span class="sd">        lot_size: Position size in lots</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with pip value comparison</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">PipCalculator</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="n">pip_val</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">pip_value</span><span class="p">(</span><span class="n">lot_size</span><span class="p">)</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;Pip Size&#39;</span><span class="p">:</span> <span class="n">calc</span><span class="o">.</span><span class="n">pip_size</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Pip Value (</span><span class="si">{</span><span class="n">lot_size</span><span class="si">}</span><span class="s1"> lot)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">pip_val</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;10 Pip Move&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">pip_val</span> <span class="o">*</span> <span class="mi">10</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;50 Pip Move&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">pip_val</span> <span class="o">*</span> <span class="mi">50</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Compare major pairs</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/CAD&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pip Value Comparison (1 Standard Lot)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">compare_pip_values</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 1.3: Calculate Pip Values (Guided)</h2>
<p>Complete the function to calculate profit/loss in pips and monetary value.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 1.3: Calculate Pip Values (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_trade_pnl</span><span class="p">(</span>
    <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lot_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;long&#39; or &#39;short&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate profit/loss for a forex trade.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pair: Currency pair</span>
<span class="sd">        entry_price: Entry price</span>
<span class="sd">        exit_price: Exit price</span>
<span class="sd">        lot_size: Position size in lots</span>
<span class="sd">        direction: Trade direction (&#39;long&#39; or &#39;short&#39;)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with P&amp;L details</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">PipCalculator</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
    
    <span class="c1"># Calculate price change</span>
    <span class="n">price_change</span> <span class="o">=</span> <span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry_price</span>
    
    <span class="c1"># Adjust for direction</span>
    <span class="k">if</span> <span class="n">direction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">______</span><span class="p">:</span>  <span class="c1"># Short position</span>
        <span class="n">price_change</span> <span class="o">=</span> <span class="o">-</span><span class="n">price_change</span>
    
    <span class="c1"># Convert to pips</span>
    <span class="n">pips_gained</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">price_change</span><span class="p">)</span>  <span class="c1"># Convert price to pips</span>
    
    <span class="c1"># Calculate monetary P&amp;L</span>
    <span class="n">pip_value</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">pip_value</span><span class="p">(</span><span class="n">lot_size</span><span class="p">)</span>
    <span class="n">monetary_pnl</span> <span class="o">=</span> <span class="n">pips_gained</span> <span class="o">*</span> <span class="n">______</span>  <span class="c1"># Multiply pips by pip value</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
        <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
        <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
        <span class="s1">&#39;exit&#39;</span><span class="p">:</span> <span class="n">exit_price</span><span class="p">,</span>
        <span class="s1">&#39;lots&#39;</span><span class="p">:</span> <span class="n">lot_size</span><span class="p">,</span>
        <span class="s1">&#39;pips&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pips_gained</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">monetary_pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test with example trades</span>
<span class="n">trades</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">,</span> <span class="mf">1.0900</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="mf">1.0900</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;USD/JPY&#39;</span><span class="p">,</span> <span class="mf">150.00</span><span class="p">,</span> <span class="mf">149.50</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trade P&amp;L Calculations&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">exit_p</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_trade_pnl</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">exit_p</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">:</span><span class="s2">5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;lots&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> lot: &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> â†’ </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">sign</span><span class="si">}{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;pips&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> pips ($</span><span class="si">{</span><span class="n">sign</span><span class="si">}{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_trade_pnl</span><span class="p">(</span>
    <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lot_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;long&#39; or &#39;short&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate profit/loss for a forex trade.</span>

<span class="sd">    Args:</span>
<span class="sd">        pair: Currency pair</span>
<span class="sd">        entry_price: Entry price</span>
<span class="sd">        exit_price: Exit price</span>
<span class="sd">        lot_size: Position size in lots</span>
<span class="sd">        direction: Trade direction (&#39;long&#39; or &#39;short&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with P&amp;L details</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">PipCalculator</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>

    <span class="c1"># Calculate price change</span>
    <span class="n">price_change</span> <span class="o">=</span> <span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry_price</span>

    <span class="c1"># Adjust for direction</span>
    <span class="k">if</span> <span class="n">direction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span>  <span class="c1"># Short position</span>
        <span class="n">price_change</span> <span class="o">=</span> <span class="o">-</span><span class="n">price_change</span>

    <span class="c1"># Convert to pips</span>
    <span class="n">pips_gained</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">price_to_pips</span><span class="p">(</span><span class="n">price_change</span><span class="p">)</span>  <span class="c1"># Convert price to pips</span>

    <span class="c1"># Calculate monetary P&amp;L</span>
    <span class="n">pip_value</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">pip_value</span><span class="p">(</span><span class="n">lot_size</span><span class="p">)</span>
    <span class="n">monetary_pnl</span> <span class="o">=</span> <span class="n">pips_gained</span> <span class="o">*</span> <span class="n">pip_value</span>  <span class="c1"># Multiply pips by pip value</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
        <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
        <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
        <span class="s1">&#39;exit&#39;</span><span class="p">:</span> <span class="n">exit_price</span><span class="p">,</span>
        <span class="s1">&#39;lots&#39;</span><span class="p">:</span> <span class="n">lot_size</span><span class="p">,</span>
        <span class="s1">&#39;pips&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pips_gained</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">monetary_pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 1.4: Build Currency Pair Analyzer (Open-ended)</h2>
<p>Build a comprehensive currency pair analyzer class that includes:
- Pair classification (major/minor/exotic)
- Pip calculations
- Spread cost analysis
- Position sizing based on risk</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 1.4: Build Currency Pair Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a CurrencyPairAnalyzer class that:</span>
<span class="c1"># - Takes a currency pair as input</span>
<span class="c1"># - Classifies the pair type (major/minor/exotic)</span>
<span class="c1"># - Calculates pip values for different lot sizes</span>
<span class="c1"># - Estimates spread costs based on pair type</span>
<span class="c1"># - Calculates position size based on account risk percentage</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - classify() -&gt; str: Returns pair classification</span>
<span class="c1"># - pip_value(lots: float) -&gt; float: Calculate pip value</span>
<span class="c1"># - spread_cost(lots: float, spread_pips: float) -&gt; float: Calculate spread cost</span>
<span class="c1"># - position_size(account_balance: float, risk_pct: float, stop_loss_pips: int) -&gt; float</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CurrencyPairAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive analyzer for forex currency pairs.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        pair: Currency pair symbol</span>
<span class="sd">        base: Base currency</span>
<span class="sd">        quote: Quote currency</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MAJOR_CURRENCIES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]</span>
    <span class="n">EXOTIC_CURRENCIES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TRY&#39;</span><span class="p">,</span> <span class="s1">&#39;ZAR&#39;</span><span class="p">,</span> <span class="s1">&#39;MXN&#39;</span><span class="p">,</span> <span class="s1">&#39;SGD&#39;</span><span class="p">,</span> <span class="s1">&#39;HKD&#39;</span><span class="p">,</span> <span class="s1">&#39;SEK&#39;</span><span class="p">,</span> <span class="s1">&#39;NOK&#39;</span><span class="p">,</span> <span class="s1">&#39;PLN&#39;</span><span class="p">]</span>

    <span class="n">TYPICAL_SPREADS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Major&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s1">&#39;Minor&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="s1">&#39;Exotic&#39;</span><span class="p">:</span> <span class="mf">15.0</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pip_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair</span> <span class="k">else</span> <span class="mf">0.0001</span>

    <span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Classify the pair as major, minor, or exotic.&quot;&quot;&quot;</span>
        <span class="n">has_usd</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair</span>
        <span class="n">base_major</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAJOR_CURRENCIES</span>
        <span class="n">quote_major</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAJOR_CURRENCIES</span>

        <span class="k">if</span> <span class="n">has_usd</span> <span class="ow">and</span> <span class="n">base_major</span> <span class="ow">and</span> <span class="n">quote_major</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Major&#39;</span>
        <span class="k">elif</span> <span class="n">base_major</span> <span class="ow">and</span> <span class="n">quote_major</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Minor&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Exotic&#39;</span>

    <span class="k">def</span> <span class="nf">pip_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate pip value in USD.&quot;&quot;&quot;</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">lots</span> <span class="o">*</span> <span class="mi">100_000</span>
        <span class="k">return</span> <span class="n">units</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pip_size</span>

    <span class="k">def</span> <span class="nf">spread_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">spread_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate spread cost for a position.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spread_pips</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spread_pips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TYPICAL_SPREADS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="p">()]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pip_value</span><span class="p">(</span><span class="n">lots</span><span class="p">)</span> <span class="o">*</span> <span class="n">spread_pips</span>

    <span class="k">def</span> <span class="nf">position_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">stop_loss_pips</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate position size based on risk parameters.&quot;&quot;&quot;</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">pip_value_per_lot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pip_value</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">risk_per_lot</span> <span class="o">=</span> <span class="n">pip_value_per_lot</span> <span class="o">*</span> <span class="n">stop_loss_pips</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">risk_amount</span> <span class="o">/</span> <span class="n">risk_per_lot</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a comprehensive summary of the pair.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
            <span class="s1">&#39;quote&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">,</span>
            <span class="s1">&#39;classification&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="p">(),</span>
            <span class="s1">&#39;pip_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pip_size</span><span class="p">,</span>
            <span class="s1">&#39;pip_value_std_lot&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pip_value</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;typical_spread&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">TYPICAL_SPREADS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="p">()]</span><span class="si">}</span><span class="s1"> pips&#39;</span><span class="p">,</span>
            <span class="s1">&#39;spread_cost_std_lot&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spread_cost</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">}</span>


<span class="c1"># Test the analyzer</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP/JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/TRY&#39;</span><span class="p">]:</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">CurrencyPairAnalyzer</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> Analysis:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Position sizing example</span>
    <span class="n">lots</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">position_size</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Position size ($10k, 2% risk, 50 pip SL): </span><span class="si">{</span><span class="n">lots</span><span class="si">}</span><span class="s2"> lots&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 1.5: Session-Based Trading Filter (Open-ended)</h2>
<p>Build a session-based trading filter that determines optimal trading times for different currency pairs based on active sessions.</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 1.5: Session-Based Trading Filter (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a SessionTradingFilter class that:</span>
<span class="c1"># - Tracks forex trading sessions with their active hours</span>
<span class="c1"># - Maps currency pairs to their most active sessions</span>
<span class="c1"># - Determines if it&#39;s a good time to trade a specific pair</span>
<span class="c1"># - Returns optimal trading windows for a pair</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - is_session_open(session_name: str, utc_hour: int) -&gt; bool</span>
<span class="c1"># - get_active_sessions(utc_hour: int) -&gt; List[str]</span>
<span class="c1"># - is_good_time_to_trade(pair: str, utc_hour: int) -&gt; dict</span>
<span class="c1"># - get_optimal_hours(pair: str) -&gt; List[int]</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SessionTradingFilter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter trading times based on forex sessions.</span>

<span class="sd">    Helps identify optimal trading windows for different pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SESSIONS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Sydney&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;currencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]},</span>
        <span class="s1">&#39;Tokyo&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;currencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD&#39;</span><span class="p">]},</span>
        <span class="s1">&#39;London&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;currencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">]},</span>
        <span class="s1">&#39;New York&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="s1">&#39;currencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">]}</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">is_session_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if a session is open at a given UTC hour.&quot;&quot;&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SESSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">open_h</span><span class="p">,</span> <span class="n">close_h</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">open_h</span> <span class="o">&gt;</span> <span class="n">close_h</span><span class="p">:</span>  <span class="c1"># Crosses midnight</span>
            <span class="k">return</span> <span class="n">utc_hour</span> <span class="o">&gt;=</span> <span class="n">open_h</span> <span class="ow">or</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">close_h</span>
        <span class="k">return</span> <span class="n">open_h</span> <span class="o">&lt;=</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">close_h</span>

    <span class="k">def</span> <span class="nf">get_active_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all active sessions at a given UTC hour.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SESSIONS</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_session_open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_pair_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get relevant sessions for a currency pair.&quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="n">relevant</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">session_name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SESSIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;currencies&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">quote</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;currencies&#39;</span><span class="p">]:</span>
                <span class="n">relevant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">relevant</span>

    <span class="k">def</span> <span class="nf">is_good_time_to_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine if it&#39;s a good time to trade a pair.&quot;&quot;&quot;</span>
        <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_sessions</span><span class="p">(</span><span class="n">utc_hour</span><span class="p">)</span>
        <span class="n">relevant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pair_sessions</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>

        <span class="c1"># Check if relevant sessions are active</span>
        <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">relevant</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">active</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;Excellent&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Multiple relevant sessions overlap&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;Good&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">matching</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> session active&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;Fair&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Active sessions but not optimal for this pair&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;Poor&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;No major sessions active&#39;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;utc_hour&#39;</span><span class="p">:</span> <span class="n">utc_hour</span><span class="p">,</span>
            <span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="n">rating</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
            <span class="s1">&#39;active_sessions&#39;</span><span class="p">:</span> <span class="n">active</span><span class="p">,</span>
            <span class="s1">&#39;relevant_sessions&#39;</span><span class="p">:</span> <span class="n">relevant</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_optimal_hours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get optimal trading hours for a pair.&quot;&quot;&quot;</span>
        <span class="n">optimal</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_good_time_to_trade</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">hour</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Excellent&#39;</span><span class="p">,</span> <span class="s1">&#39;Good&#39;</span><span class="p">]:</span>
                <span class="n">optimal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optimal</span>


<span class="c1"># Test the filter</span>
<span class="nb">filter</span> <span class="o">=</span> <span class="n">SessionTradingFilter</span><span class="p">()</span>

<span class="c1"># Check current conditions</span>
<span class="n">current_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">hour</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD/JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP/USD&#39;</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">filter</span><span class="o">.</span><span class="n">is_good_time_to_trade</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">current_hour</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">current_hour</span><span class="si">}</span><span class="s2">:00 UTC:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Rating: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Reason: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Optimal hours: </span><span class="si">{</span><span class="nb">filter</span><span class="o">.</span><span class="n">get_optimal_hours</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 1.6: Multi-Pair Market Scanner (Open-ended)</h2>
<p>Build a market scanner that analyzes multiple currency pairs and ranks them by trading opportunity.</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 1.6: Multi-Pair Market Scanner (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a ForexMarketScanner class that:</span>
<span class="c1"># - Analyzes multiple currency pairs simultaneously</span>
<span class="c1"># - Ranks pairs by volatility and trading conditions</span>
<span class="c1"># - Considers current session activity</span>
<span class="c1"># - Provides trading recommendations</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - add_pair(pair: str, current_price: float, daily_range: float)</span>
<span class="c1"># - analyze_pair(pair: str, utc_hour: int) -&gt; dict</span>
<span class="c1"># - scan_all(utc_hour: int) -&gt; pd.DataFrame</span>
<span class="c1"># - get_top_opportunities(utc_hour: int, n: int) -&gt; List[str]</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ForexMarketScanner</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scanner for analyzing multiple forex pairs.</span>

<span class="sd">    Ranks pairs by opportunity based on volatility and session.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_filter</span> <span class="o">=</span> <span class="n">SessionTradingFilter</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">daily_range</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a pair with its current market data.&quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">current_price</span><span class="p">,</span>
            <span class="s1">&#39;daily_range&#39;</span><span class="p">:</span> <span class="n">daily_range</span><span class="p">,</span>
            <span class="s1">&#39;analyzer&#39;</span><span class="p">:</span> <span class="n">CurrencyPairAnalyzer</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">analyze_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze a single pair for trading opportunity.&quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Pair not found&#39;</span><span class="p">}</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;analyzer&#39;</span><span class="p">]</span>

        <span class="c1"># Get session rating</span>
        <span class="n">session_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_filter</span><span class="o">.</span><span class="n">is_good_time_to_trade</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">)</span>

        <span class="c1"># Calculate volatility score (daily range in pips)</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="mf">0.0001</span>
        <span class="n">range_pips</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;daily_range&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pip_size</span>

        <span class="c1"># Score calculation</span>
        <span class="n">session_scores</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Excellent&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Good&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Fair&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Poor&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">session_score</span> <span class="o">=</span> <span class="n">session_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session_info</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Normalize volatility (assume 100 pips is high)</span>
        <span class="n">volatility_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">range_pips</span> <span class="o">/</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># Max 4 points</span>

        <span class="c1"># Classification bonus</span>
        <span class="n">class_bonus</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Major&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;Minor&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s1">&#39;Exotic&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">}</span>

        <span class="n">total_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">session_score</span> <span class="o">+</span> <span class="n">volatility_score</span><span class="p">)</span> <span class="o">*</span> <span class="n">class_bonus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">analyzer</span><span class="o">.</span><span class="n">classify</span><span class="p">(),</span> <span class="mf">1.0</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;classification&#39;</span><span class="p">:</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">classify</span><span class="p">(),</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
            <span class="s1">&#39;daily_range_pips&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">range_pips</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;session_rating&#39;</span><span class="p">:</span> <span class="n">session_info</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">],</span>
            <span class="s1">&#39;opportunity_score&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_score</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;spread_cost&#39;</span><span class="p">:</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">spread_cost</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">scan_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scan all pairs and return ranked results.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">:</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;opportunity_score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">get_top_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get top N pairs by opportunity.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_all</span><span class="p">(</span><span class="n">utc_hour</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>


<span class="c1"># Test the scanner</span>
<span class="n">scanner</span> <span class="o">=</span> <span class="n">ForexMarketScanner</span><span class="p">()</span>

<span class="c1"># Add sample pairs with mock data</span>
<span class="n">pairs_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">,</span> <span class="mf">0.0065</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;GBP/USD&#39;</span><span class="p">,</span> <span class="mf">1.2650</span><span class="p">,</span> <span class="mf">0.0095</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;USD/JPY&#39;</span><span class="p">,</span> <span class="mf">150.50</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;AUD/USD&#39;</span><span class="p">,</span> <span class="mf">0.6550</span><span class="p">,</span> <span class="mf">0.0055</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;EUR/GBP&#39;</span><span class="p">,</span> <span class="mf">0.8580</span><span class="p">,</span> <span class="mf">0.0045</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;USD/CAD&#39;</span><span class="p">,</span> <span class="mf">1.3650</span><span class="p">,</span> <span class="mf">0.0070</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;USD/TRY&#39;</span><span class="p">,</span> <span class="mf">32.50</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">range_val</span> <span class="ow">in</span> <span class="n">pairs_data</span><span class="p">:</span>
    <span class="n">scanner</span><span class="o">.</span><span class="n">add_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">range_val</span><span class="p">)</span>

<span class="c1"># Scan at current time</span>
<span class="n">current_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">hour</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Market Scan at </span><span class="si">{</span><span class="n">current_hour</span><span class="si">}</span><span class="s2">:00 UTC&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">scan_all</span><span class="p">(</span><span class="n">current_hour</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top Opportunities: </span><span class="si">{</span><span class="n">scanner</span><span class="o">.</span><span class="n">get_top_opportunities</span><span class="p">(</span><span class="n">current_hour</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Forex Market Analyzer</h2>
<p>Build a comprehensive forex market analyzer that combines all concepts from this module.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ForexMarketAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive forex market analyzer.</span>
<span class="sd">    </span>
<span class="sd">    Combines pair analysis, session tracking, and pip calculations</span>
<span class="sd">    into a unified interface for forex market analysis.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        account_currency: Base currency for calculations</span>
<span class="sd">        account_balance: Trading account balance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">MAJOR_CURRENCIES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]</span>
    
    <span class="n">SESSIONS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Sydney&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;currencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]},</span>
        <span class="s1">&#39;Tokyo&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;currencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]},</span>
        <span class="s1">&#39;London&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span> <span class="s1">&#39;currencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">]},</span>
        <span class="s1">&#39;New York&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="s1">&#39;currencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">]}</span>
    <span class="p">}</span>
    
    <span class="n">TYPICAL_SPREADS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Major&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;Minor&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;Exotic&#39;</span><span class="p">:</span> <span class="mf">15.0</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_currency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span> <span class="o">=</span> <span class="n">account_currency</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">=</span> <span class="n">account_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">watched_pairs</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># ==================== Pair Analysis ====================</span>
    
    <span class="k">def</span> <span class="nf">add_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bid</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ask</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a currency pair to the watchlist.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pair: Currency pair symbol</span>
<span class="sd">            bid: Current bid price</span>
<span class="sd">            ask: Current ask price</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">watched_pairs</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="n">base</span><span class="p">,</span>
            <span class="s1">&#39;quote&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="p">,</span>
            <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">bid</span><span class="p">,</span>
            <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ask</span><span class="p">,</span>
            <span class="s1">&#39;classification&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_normalize_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Normalize pair format to BASE/QUOTE.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_classify_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Classify pair as Major, Minor, or Exotic.&quot;&quot;&quot;</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">has_usd</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span> <span class="ow">in</span> <span class="n">pair</span>
        <span class="n">both_major</span> <span class="o">=</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAJOR_CURRENCIES</span> <span class="ow">and</span> <span class="n">quote</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAJOR_CURRENCIES</span>
        
        <span class="k">if</span> <span class="n">has_usd</span> <span class="ow">and</span> <span class="n">both_major</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Major&#39;</span>
        <span class="k">elif</span> <span class="n">both_major</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Minor&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;Exotic&#39;</span>
    
    <span class="k">def</span> <span class="nf">get_pair_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get comprehensive information about a pair.&quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">watched_pairs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">watched_pairs</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;pip_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pip_size</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;pip_value_std_lot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_pip_value</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;typical_spread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TYPICAL_SPREADS</span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">]]</span>
        
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]:</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;current_spread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;pip_size&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">info</span>
    
    <span class="c1"># ==================== Pip Calculations ====================</span>
    
    <span class="k">def</span> <span class="nf">_get_pip_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get pip size for a pair.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="mf">0.0001</span>
    
    <span class="k">def</span> <span class="nf">_calculate_pip_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate pip value in account currency.&quot;&quot;&quot;</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pip_size</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">lots</span> <span class="o">*</span> <span class="mi">100_000</span>
        <span class="k">return</span> <span class="n">units</span> <span class="o">*</span> <span class="n">pip_size</span>
    
    <span class="k">def</span> <span class="nf">calculate_pips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">exit</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate pip difference between two prices.&quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pip_size</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">exit</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_size</span>
    
    <span class="k">def</span> <span class="nf">calculate_pnl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">entry</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">exit</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">lots</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;long&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate P&amp;L for a trade.&quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        
        <span class="c1"># Calculate pip change</span>
        <span class="n">pips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_pips</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">exit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">direction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span>
            <span class="n">pips</span> <span class="o">=</span> <span class="o">-</span><span class="n">pips</span>
        
        <span class="c1"># Calculate monetary P&amp;L</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_pip_value</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">lots</span><span class="p">)</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="n">pips</span> <span class="o">*</span> <span class="n">pip_value</span> <span class="o">/</span> <span class="mi">100_000</span> <span class="o">*</span> <span class="n">lots</span> <span class="o">*</span> <span class="mi">100_000</span>
        
        <span class="c1"># Simplified: pip_value for 1 lot * pips</span>
        <span class="n">pip_value_per_lot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_pip_value</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="n">pips</span> <span class="o">*</span> <span class="p">(</span><span class="n">pip_value_per_lot</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pip_size</span><span class="p">(</span><span class="n">pair</span><span class="p">)))</span> <span class="o">*</span> <span class="n">lots</span>
        
        <span class="c1"># Correct calculation</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="n">pips</span> <span class="o">*</span> <span class="n">lots</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># $10 per pip per lot for most pairs</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry</span><span class="p">,</span>
            <span class="s1">&#39;exit&#39;</span><span class="p">:</span> <span class="n">exit</span><span class="p">,</span>
            <span class="s1">&#39;lots&#39;</span><span class="p">:</span> <span class="n">lots</span><span class="p">,</span>
            <span class="s1">&#39;pips&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pips</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="c1"># ==================== Position Sizing ====================</span>
    
    <span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">stop_loss_pips</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">risk_percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate position size based on risk parameters.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pair: Currency pair</span>
<span class="sd">            stop_loss_pips: Stop loss distance in pips</span>
<span class="sd">            risk_percent: Percentage of account to risk</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Position sizing details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        
        <span class="c1"># Calculate risk amount</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># Pip value per standard lot (approximately $10 for most pairs)</span>
        <span class="n">pip_value_per_lot</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Simplified</span>
        
        <span class="c1"># Risk per lot = pip_value * stop_loss_pips</span>
        <span class="n">risk_per_lot</span> <span class="o">=</span> <span class="n">pip_value_per_lot</span> <span class="o">*</span> <span class="n">stop_loss_pips</span>
        
        <span class="c1"># Position size</span>
        <span class="n">lots</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">risk_per_lot</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;account_balance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">,</span>
            <span class="s1">&#39;risk_percent&#39;</span><span class="p">:</span> <span class="n">risk_percent</span><span class="p">,</span>
            <span class="s1">&#39;risk_amount&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">risk_amount</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;stop_loss_pips&#39;</span><span class="p">:</span> <span class="n">stop_loss_pips</span><span class="p">,</span>
            <span class="s1">&#39;position_lots&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">lots</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;position_units&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">lots</span> <span class="o">*</span> <span class="mi">100_000</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="c1"># ==================== Session Analysis ====================</span>
    
    <span class="k">def</span> <span class="nf">_is_session_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if a session is open.&quot;&quot;&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SESSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="n">open_h</span><span class="p">,</span> <span class="n">close_h</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">open_h</span> <span class="o">&gt;</span> <span class="n">close_h</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">utc_hour</span> <span class="o">&gt;=</span> <span class="n">open_h</span> <span class="ow">or</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">close_h</span>
        <span class="k">return</span> <span class="n">open_h</span> <span class="o">&lt;=</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">close_h</span>
    
    <span class="k">def</span> <span class="nf">get_active_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get currently active sessions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">utc_hour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utc_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">hour</span>
        
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SESSIONS</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_session_open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">)</span>
        <span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">analyze_trading_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze current trading conditions for a pair.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pair: Currency pair</span>
<span class="sd">            utc_hour: Hour in UTC (default: current)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Trading condition analysis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">utc_hour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utc_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">hour</span>
        
        <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get active sessions</span>
        <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_sessions</span><span class="p">(</span><span class="n">utc_hour</span><span class="p">)</span>
        
        <span class="c1"># Find relevant sessions for this pair</span>
        <span class="n">relevant</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">session_name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SESSIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;currencies&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">quote</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;currencies&#39;</span><span class="p">]:</span>
                <span class="n">relevant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_name</span><span class="p">)</span>
        
        <span class="c1"># Determine trading condition</span>
        <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">relevant</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">active</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;Excellent&#39;</span>
            <span class="n">expected_volatility</span> <span class="o">=</span> <span class="s1">&#39;High&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;Good&#39;</span>
            <span class="n">expected_volatility</span> <span class="o">=</span> <span class="s1">&#39;Medium-High&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;Fair&#39;</span>
            <span class="n">expected_volatility</span> <span class="o">=</span> <span class="s1">&#39;Medium&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;Poor&#39;</span>
            <span class="n">expected_volatility</span> <span class="o">=</span> <span class="s1">&#39;Low&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;utc_hour&#39;</span><span class="p">:</span> <span class="n">utc_hour</span><span class="p">,</span>
            <span class="s1">&#39;active_sessions&#39;</span><span class="p">:</span> <span class="n">active</span><span class="p">,</span>
            <span class="s1">&#39;relevant_sessions&#39;</span><span class="p">:</span> <span class="n">relevant</span><span class="p">,</span>
            <span class="s1">&#39;matching_sessions&#39;</span><span class="p">:</span> <span class="n">matching</span><span class="p">,</span>
            <span class="s1">&#39;trading_rating&#39;</span><span class="p">:</span> <span class="n">rating</span><span class="p">,</span>
            <span class="s1">&#39;expected_volatility&#39;</span><span class="p">:</span> <span class="n">expected_volatility</span>
        <span class="p">}</span>
    
    <span class="c1"># ==================== Market Overview ====================</span>
    
    <span class="k">def</span> <span class="nf">get_market_overview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get overview of all watched pairs.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">utc_hour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utc_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">hour</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">watched_pairs</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pair_info</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trading_conditions</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">)</span>
            
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Pip Value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pip_value_std_lot&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Typ. Spread&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;typical_spread&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> pips&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Rating&#39;</span><span class="p">:</span> <span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;trading_rating&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Volatility&#39;</span><span class="p">:</span> <span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;expected_volatility&#39;</span><span class="p">]</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print a comprehensive market summary.&quot;&quot;&quot;</span>
        <span class="n">utc_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">hour</span>
        <span class="n">active_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_sessions</span><span class="p">(</span><span class="n">utc_hour</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FOREX MARKET ANALYZER SUMMARY&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Account Balance: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current UTC Time: </span><span class="si">{</span><span class="n">utc_hour</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active Sessions: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">active_sessions</span><span class="p">)</span> <span class="k">if</span> <span class="n">active_sessions</span> <span class="k">else</span> <span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">watched_pairs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WATCHED PAIRS&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
            <span class="n">overview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_market_overview</span><span class="p">(</span><span class="n">utc_hour</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">overview</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate the Forex Market Analyzer</span>

<span class="c1"># Create analyzer with $25,000 account</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">ForexMarketAnalyzer</span><span class="p">(</span><span class="n">account_balance</span><span class="o">=</span><span class="mi">25000</span><span class="p">)</span>

<span class="c1"># Add pairs to watchlist</span>
<span class="n">pairs_to_watch</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="mf">1.0848</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;GBP/USD&#39;</span><span class="p">,</span> <span class="mf">1.2648</span><span class="p">,</span> <span class="mf">1.2652</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;USD/JPY&#39;</span><span class="p">,</span> <span class="mf">150.48</span><span class="p">,</span> <span class="mf">150.51</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;AUD/USD&#39;</span><span class="p">,</span> <span class="mf">0.6548</span><span class="p">,</span> <span class="mf">0.6551</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;EUR/GBP&#39;</span><span class="p">,</span> <span class="mf">0.8578</span><span class="p">,</span> <span class="mf">0.8582</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;USD/CAD&#39;</span><span class="p">,</span> <span class="mf">1.3648</span><span class="p">,</span> <span class="mf">1.3652</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span> <span class="ow">in</span> <span class="n">pairs_to_watch</span><span class="p">:</span>
    <span class="n">analyzer</span><span class="o">.</span><span class="n">add_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span><span class="p">)</span>

<span class="c1"># Print summary</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Example: Position sizing calculation</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Position Sizing Examples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="c1"># Calculate position size for 1% risk with 50 pip stop</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD/JPY&#39;</span><span class="p">]:</span>
    <span class="n">sizing</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">stop_loss_pips</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">risk_percent</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Risk: $</span><span class="si">{</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;risk_amount&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (1% of $</span><span class="si">{</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;account_balance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Stop Loss: </span><span class="si">{</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;stop_loss_pips&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> pips&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Position: </span><span class="si">{</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;position_lots&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> lots (</span><span class="si">{</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;position_units&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> units)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Example: Trade P&amp;L calculation</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trade P&amp;L Examples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># Simulate some trades</span>
<span class="n">trades</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">,</span> <span class="mf">1.0900</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">),</span>   <span class="c1"># 50 pip win</span>
    <span class="p">(</span><span class="s1">&#39;GBP/USD&#39;</span><span class="p">,</span> <span class="mf">1.2700</span><span class="p">,</span> <span class="mf">1.2650</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">),</span>  <span class="c1"># 50 pip win short</span>
    <span class="p">(</span><span class="s1">&#39;USD/JPY&#39;</span><span class="p">,</span> <span class="mf">150.00</span><span class="p">,</span> <span class="mf">149.60</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">),</span>  <span class="c1"># 40 pip win</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">exit_price</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">calculate_pnl</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">exit_price</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">:</span><span class="s2">5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;lots&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> lots: &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> â†’ </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">sign</span><span class="si">}{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;pips&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> pips ($</span><span class="si">{</span><span class="n">sign</span><span class="si">}{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Example: Session analysis</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Session Analysis for Different Hours&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="n">test_hours</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">pair</span> <span class="o">=</span> <span class="s1">&#39;EUR/USD&#39;</span>

<span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">test_hours</span><span class="p">:</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_trading_conditions</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">hour</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">hour</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00 UTC:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Active Sessions: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;active_sessions&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;active_sessions&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Relevant Sessions: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;relevant_sessions&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Trading Rating: </span><span class="si">{</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;trading_rating&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expected Volatility: </span><span class="si">{</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;expected_volatility&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ul>
<li><strong>Currency pairs</strong> consist of a base currency and quote currency - buying EUR/USD means buying euros and selling dollars</li>
<li><strong>Major pairs</strong> include USD and offer the tightest spreads; <strong>minor pairs</strong> are crosses between major currencies; <strong>exotic pairs</strong> include emerging market currencies</li>
<li><strong>The forex market is decentralized</strong> (OTC) with trading flowing through a hierarchy from interbank to retail</li>
<li><strong>Four major trading sessions</strong> (Sydney, Tokyo, London, New York) provide 24/5 market access with session overlaps offering the highest volatility</li>
<li><strong>Pips</strong> are the standard price movement unit (0.0001 for most pairs, 0.01 for JPY pairs)</li>
<li><strong>Lot sizes</strong> standardize position sizes: standard (100k), mini (10k), micro (1k)</li>
<li><strong>Position sizing</strong> based on risk percentage and stop loss is critical for account management</li>
</ul>
<hr />
<p><strong>Next: Module 2 - Futures Market Basics</strong></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="2"><div class="md-cell module-header"><h1>Module 2: Futures Market Basics</h1>
<h2>Part 1: Market Fundamentals</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:</p>
<ul>
<li>Understand futures contract specifications and mechanics</li>
<li>Navigate popular futures markets (indices, commodities, currencies)</li>
<li>Explain the relationship between spot and futures prices</li>
<li>Understand contango, backwardation, and basis</li>
<li>Handle contract expiration and rollover</li>
<li>Build continuous futures price series</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Standard imports for this module</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="c1"># Display settings</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>2.1 What are Futures?</h2>
<p>A <strong>futures contract</strong> is a standardized agreement to buy or sell an underlying asset at a predetermined price on a specific future date.</p>
<h3>Key Characteristics</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Standardized</strong></td>
<td>Exchange-defined contract size, quality, delivery</td>
</tr>
<tr>
<td><strong>Leverage</strong></td>
<td>Only margin required, not full contract value</td>
</tr>
<tr>
<td><strong>Expiration</strong></td>
<td>Contracts expire on specific dates</td>
</tr>
<tr>
<td><strong>Settlement</strong></td>
<td>Physical delivery or cash settlement</td>
</tr>
<tr>
<td><strong>Mark-to-Market</strong></td>
<td>Daily profit/loss settlement</td>
</tr>
</tbody>
</table></div>
<h3>Contract Specifications</h3>
<p>Every futures contract has specific details defined by the exchange:</p>
<div class="highlight"><pre><span></span><code>E-mini S&amp;P 500 (ES) Contract Specifications:
â”œâ”€â”€ Exchange: CME
â”œâ”€â”€ Contract Size: $50 Ã— S&amp;P 500 Index
â”œâ”€â”€ Tick Size: 0.25 index points
â”œâ”€â”€ Tick Value: $12.50
â”œâ”€â”€ Trading Hours: Nearly 24 hours (Sunday-Friday)
â”œâ”€â”€ Expiration: March, June, September, December
â””â”€â”€ Settlement: Cash settled
</code></pre></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SettlementType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Types of futures settlement.&quot;&quot;&quot;</span>
    <span class="n">CASH</span> <span class="o">=</span> <span class="s2">&quot;cash&quot;</span>
    <span class="n">PHYSICAL</span> <span class="o">=</span> <span class="s2">&quot;physical&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FuturesContract</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a futures contract specification.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        symbol: Contract symbol (e.g., &#39;ES&#39;)</span>
<span class="sd">        name: Full contract name</span>
<span class="sd">        exchange: Trading exchange</span>
<span class="sd">        contract_size: Size multiplier</span>
<span class="sd">        tick_size: Minimum price movement</span>
<span class="sd">        tick_value: Dollar value per tick</span>
<span class="sd">        settlement: Settlement type</span>
<span class="sd">        months: Trading months (letter codes)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">contract_size</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">tick_size</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">tick_value</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">settlement</span><span class="p">:</span> <span class="n">SettlementType</span>
    <span class="n">months</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">point_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate the dollar value of one full point move.&quot;&quot;&quot;</span>
        <span class="n">ticks_per_point</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span>
        <span class="k">return</span> <span class="n">ticks_per_point</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_value</span>
    
    <span class="k">def</span> <span class="nf">calculate_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">exit</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">contracts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate P&amp;L for a trade.&quot;&quot;&quot;</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">entry</span>
        <span class="k">return</span> <span class="n">points</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_value</span> <span class="o">*</span> <span class="n">contracts</span>
    
    <span class="k">def</span> <span class="nf">ticks_to_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticks</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert ticks to points.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ticks</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span>
    
    <span class="k">def</span> <span class="nf">points_to_ticks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert points to ticks.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">points</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span><span class="p">)</span>


<span class="c1"># Define popular futures contracts</span>
<span class="n">FUTURES_CONTRACTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ES&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span>
        <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;E-mini S&amp;P 500&#39;</span><span class="p">,</span>
        <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;CME&#39;</span><span class="p">,</span>
        <span class="n">contract_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">tick_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
        <span class="n">tick_value</span><span class="o">=</span><span class="mf">12.50</span><span class="p">,</span>
        <span class="n">settlement</span><span class="o">=</span><span class="n">SettlementType</span><span class="o">.</span><span class="n">CASH</span><span class="p">,</span>
        <span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]</span>  <span class="c1"># Mar, Jun, Sep, Dec</span>
    <span class="p">),</span>
    <span class="s1">&#39;NQ&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span>
        <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;NQ&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;E-mini Nasdaq 100&#39;</span><span class="p">,</span>
        <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;CME&#39;</span><span class="p">,</span>
        <span class="n">contract_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">tick_size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
        <span class="n">tick_value</span><span class="o">=</span><span class="mf">5.00</span><span class="p">,</span>
        <span class="n">settlement</span><span class="o">=</span><span class="n">SettlementType</span><span class="o">.</span><span class="n">CASH</span><span class="p">,</span>
        <span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="s1">&#39;CL&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span>
        <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;CL&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Crude Oil&#39;</span><span class="p">,</span>
        <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;NYMEX&#39;</span><span class="p">,</span>
        <span class="n">contract_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>  <span class="c1"># barrels</span>
        <span class="n">tick_size</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">tick_value</span><span class="o">=</span><span class="mf">10.00</span><span class="p">,</span>
        <span class="n">settlement</span><span class="o">=</span><span class="n">SettlementType</span><span class="o">.</span><span class="n">PHYSICAL</span><span class="p">,</span>
        <span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="s1">&#39;GC&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span>
        <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;GC&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Gold&#39;</span><span class="p">,</span>
        <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;COMEX&#39;</span><span class="p">,</span>
        <span class="n">contract_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># troy ounces</span>
        <span class="n">tick_size</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span>
        <span class="n">tick_value</span><span class="o">=</span><span class="mf">10.00</span><span class="p">,</span>
        <span class="n">settlement</span><span class="o">=</span><span class="n">SettlementType</span><span class="o">.</span><span class="n">PHYSICAL</span><span class="p">,</span>
        <span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="s1">&#39;6E&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span>
        <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;6E&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Euro FX&#39;</span><span class="p">,</span>
        <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;CME&#39;</span><span class="p">,</span>
        <span class="n">contract_size</span><span class="o">=</span><span class="mi">125000</span><span class="p">,</span>  <span class="c1"># euros</span>
        <span class="n">tick_size</span><span class="o">=</span><span class="mf">0.00005</span><span class="p">,</span>
        <span class="n">tick_value</span><span class="o">=</span><span class="mf">6.25</span><span class="p">,</span>
        <span class="n">settlement</span><span class="o">=</span><span class="n">SettlementType</span><span class="o">.</span><span class="n">CASH</span><span class="p">,</span>
        <span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="s1">&#39;ZB&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span>
        <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;ZB&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;30-Year Treasury Bond&#39;</span><span class="p">,</span>
        <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;CBOT&#39;</span><span class="p">,</span>
        <span class="n">contract_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
        <span class="n">tick_size</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">tick_value</span><span class="o">=</span><span class="mf">31.25</span><span class="p">,</span>
        <span class="n">settlement</span><span class="o">=</span><span class="n">SettlementType</span><span class="o">.</span><span class="n">PHYSICAL</span><span class="p">,</span>
        <span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Display contract specifications</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Popular Futures Contract Specifications&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">contract</span> <span class="ow">in</span> <span class="n">FUTURES_CONTRACTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">contract</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Exchange: </span><span class="si">{</span><span class="n">contract</span><span class="o">.</span><span class="n">exchange</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Contract Size: </span><span class="si">{</span><span class="n">contract</span><span class="o">.</span><span class="n">contract_size</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Tick Size: </span><span class="si">{</span><span class="n">contract</span><span class="o">.</span><span class="n">tick_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Tick Value: $</span><span class="si">{</span><span class="n">contract</span><span class="o">.</span><span class="n">tick_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Point Value: $</span><span class="si">{</span><span class="n">contract</span><span class="o">.</span><span class="n">point_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Settlement: </span><span class="si">{</span><span class="n">contract</span><span class="o">.</span><span class="n">settlement</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate P&amp;L calculations</span>
<span class="n">es</span> <span class="o">=</span> <span class="n">FUTURES_CONTRACTS</span><span class="p">[</span><span class="s1">&#39;ES&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;E-mini S&amp;P 500 (ES) P&amp;L Examples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="c1"># Example trades</span>
<span class="n">trades</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mf">5000.00</span><span class="p">,</span> <span class="mf">5010.00</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Long&#39;</span><span class="p">),</span>   <span class="c1"># 10 point gain</span>
    <span class="p">(</span><span class="mf">5000.00</span><span class="p">,</span> <span class="mf">4990.00</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Long&#39;</span><span class="p">),</span>   <span class="c1"># 10 point loss x2</span>
    <span class="p">(</span><span class="mf">5000.00</span><span class="p">,</span> <span class="mf">4980.00</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Short&#39;</span><span class="p">),</span>  <span class="c1"># 20 point gain (short)</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">entry</span><span class="p">,</span> <span class="n">exit_price</span><span class="p">,</span> <span class="n">contracts</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;Short&#39;</span><span class="p">:</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">calculate_pnl</span><span class="p">(</span><span class="n">exit_price</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">contracts</span><span class="p">)</span>  <span class="c1"># Reversed for short</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">calculate_pnl</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">exit_price</span><span class="p">,</span> <span class="n">contracts</span><span class="p">)</span>
    
    <span class="n">points</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">points_to_ticks</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span> <span class="k">if</span> <span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">direction</span><span class="si">:</span><span class="s2">5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">contracts</span><span class="si">}</span><span class="s2"> contract(s): </span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2"> â†’ </span><span class="si">{</span><span class="n">exit_price</span><span class="si">}</span><span class="s2"> = &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">points</span><span class="si">}</span><span class="s2"> pts (</span><span class="si">{</span><span class="n">ticks</span><span class="si">}</span><span class="s2"> ticks) = </span><span class="si">{</span><span class="n">sign</span><span class="si">}</span><span class="s2">$</span><span class="si">{</span><span class="n">pnl</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>2.2 Popular Futures Markets</h2>
<p>Futures are traded on various underlying assets:</p>
<h3>Market Categories</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Category</th>
<th>Examples</th>
<th>Key Contracts</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Equity Indices</strong></td>
<td>S&amp;P 500, Nasdaq, Dow</td>
<td>ES, NQ, YM</td>
</tr>
<tr>
<td><strong>Energy</strong></td>
<td>Crude Oil, Natural Gas</td>
<td>CL, NG</td>
</tr>
<tr>
<td><strong>Metals</strong></td>
<td>Gold, Silver, Copper</td>
<td>GC, SI, HG</td>
</tr>
<tr>
<td><strong>Currencies</strong></td>
<td>Euro, Yen, Pound</td>
<td>6E, 6J, 6B</td>
</tr>
<tr>
<td><strong>Interest Rates</strong></td>
<td>Treasury Bonds, Eurodollar</td>
<td>ZB, ZN, GE</td>
</tr>
<tr>
<td><strong>Agriculture</strong></td>
<td>Corn, Wheat, Soybeans</td>
<td>ZC, ZW, ZS</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Futures market categories</span>
<span class="n">FUTURES_CATEGORIES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Equity Indices&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Stock market index futures&#39;</span><span class="p">,</span>
        <span class="s1">&#39;contracts&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;ES&#39;</span><span class="p">:</span> <span class="s1">&#39;E-mini S&amp;P 500&#39;</span><span class="p">,</span>
            <span class="s1">&#39;NQ&#39;</span><span class="p">:</span> <span class="s1">&#39;E-mini Nasdaq 100&#39;</span><span class="p">,</span>
            <span class="s1">&#39;YM&#39;</span><span class="p">:</span> <span class="s1">&#39;E-mini Dow Jones&#39;</span><span class="p">,</span>
            <span class="s1">&#39;RTY&#39;</span><span class="p">:</span> <span class="s1">&#39;E-mini Russell 2000&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MES&#39;</span><span class="p">:</span> <span class="s1">&#39;Micro E-mini S&amp;P 500&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;key_drivers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Economic data&#39;</span><span class="p">,</span> <span class="s1">&#39;Earnings&#39;</span><span class="p">,</span> <span class="s1">&#39;Fed policy&#39;</span><span class="p">,</span> <span class="s1">&#39;Geopolitics&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Energy&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Oil, gas, and energy products&#39;</span><span class="p">,</span>
        <span class="s1">&#39;contracts&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;CL&#39;</span><span class="p">:</span> <span class="s1">&#39;Crude Oil (WTI)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;BZ&#39;</span><span class="p">:</span> <span class="s1">&#39;Brent Crude Oil&#39;</span><span class="p">,</span>
            <span class="s1">&#39;NG&#39;</span><span class="p">:</span> <span class="s1">&#39;Natural Gas&#39;</span><span class="p">,</span>
            <span class="s1">&#39;RB&#39;</span><span class="p">:</span> <span class="s1">&#39;RBOB Gasoline&#39;</span><span class="p">,</span>
            <span class="s1">&#39;HO&#39;</span><span class="p">:</span> <span class="s1">&#39;Heating Oil&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;key_drivers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;OPEC decisions&#39;</span><span class="p">,</span> <span class="s1">&#39;Inventory data&#39;</span><span class="p">,</span> <span class="s1">&#39;Weather&#39;</span><span class="p">,</span> <span class="s1">&#39;Geopolitics&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Metals&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Precious and industrial metals&#39;</span><span class="p">,</span>
        <span class="s1">&#39;contracts&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;GC&#39;</span><span class="p">:</span> <span class="s1">&#39;Gold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SI&#39;</span><span class="p">:</span> <span class="s1">&#39;Silver&#39;</span><span class="p">,</span>
            <span class="s1">&#39;HG&#39;</span><span class="p">:</span> <span class="s1">&#39;Copper&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PL&#39;</span><span class="p">:</span> <span class="s1">&#39;Platinum&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PA&#39;</span><span class="p">:</span> <span class="s1">&#39;Palladium&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;key_drivers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;USD strength&#39;</span><span class="p">,</span> <span class="s1">&#39;Inflation&#39;</span><span class="p">,</span> <span class="s1">&#39;Safe haven flows&#39;</span><span class="p">,</span> <span class="s1">&#39;Industrial demand&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Currencies&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Currency futures (CME)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;contracts&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;6E&#39;</span><span class="p">:</span> <span class="s1">&#39;Euro FX&#39;</span><span class="p">,</span>
            <span class="s1">&#39;6J&#39;</span><span class="p">:</span> <span class="s1">&#39;Japanese Yen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;6B&#39;</span><span class="p">:</span> <span class="s1">&#39;British Pound&#39;</span><span class="p">,</span>
            <span class="s1">&#39;6A&#39;</span><span class="p">:</span> <span class="s1">&#39;Australian Dollar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;6C&#39;</span><span class="p">:</span> <span class="s1">&#39;Canadian Dollar&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;key_drivers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Interest rates&#39;</span><span class="p">,</span> <span class="s1">&#39;Central bank policy&#39;</span><span class="p">,</span> <span class="s1">&#39;Economic data&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Interest Rates&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Treasury and interest rate futures&#39;</span><span class="p">,</span>
        <span class="s1">&#39;contracts&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;ZB&#39;</span><span class="p">:</span> <span class="s1">&#39;30-Year Treasury Bond&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ZN&#39;</span><span class="p">:</span> <span class="s1">&#39;10-Year Treasury Note&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ZF&#39;</span><span class="p">:</span> <span class="s1">&#39;5-Year Treasury Note&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ZT&#39;</span><span class="p">:</span> <span class="s1">&#39;2-Year Treasury Note&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SR3&#39;</span><span class="p">:</span> <span class="s1">&#39;3-Month SOFR&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;key_drivers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Fed policy&#39;</span><span class="p">,</span> <span class="s1">&#39;Inflation expectations&#39;</span><span class="p">,</span> <span class="s1">&#39;Economic growth&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;Agriculture&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Grains, softs, and livestock&#39;</span><span class="p">,</span>
        <span class="s1">&#39;contracts&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;ZC&#39;</span><span class="p">:</span> <span class="s1">&#39;Corn&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ZW&#39;</span><span class="p">:</span> <span class="s1">&#39;Wheat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ZS&#39;</span><span class="p">:</span> <span class="s1">&#39;Soybeans&#39;</span><span class="p">,</span>
            <span class="s1">&#39;KC&#39;</span><span class="p">:</span> <span class="s1">&#39;Coffee&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LE&#39;</span><span class="p">:</span> <span class="s1">&#39;Live Cattle&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;key_drivers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Weather&#39;</span><span class="p">,</span> <span class="s1">&#39;USDA reports&#39;</span><span class="p">,</span> <span class="s1">&#39;Global demand&#39;</span><span class="p">,</span> <span class="s1">&#39;Planting/harvest&#39;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Display market categories</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Futures Market Categories&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">FUTURES_CATEGORIES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Contracts: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;contracts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Key Drivers: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;key_drivers&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Compare contract sizes and margins</span>
<span class="k">def</span> <span class="nf">get_notional_value</span><span class="p">(</span><span class="n">contract</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate the notional value of a futures contract.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">contract</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="s1">&#39;NQ&#39;</span><span class="p">,</span> <span class="s1">&#39;YM&#39;</span><span class="p">]:</span>  <span class="c1"># Index futures</span>
        <span class="k">return</span> <span class="n">contract</span><span class="o">.</span><span class="n">contract_size</span> <span class="o">*</span> <span class="n">price</span>
    <span class="k">elif</span> <span class="n">contract</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;CL&#39;</span><span class="p">:</span>  <span class="c1"># Crude oil</span>
        <span class="k">return</span> <span class="n">contract</span><span class="o">.</span><span class="n">contract_size</span> <span class="o">*</span> <span class="n">price</span>  <span class="c1"># 1000 barrels * price</span>
    <span class="k">elif</span> <span class="n">contract</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;GC&#39;</span><span class="p">:</span>  <span class="c1"># Gold</span>
        <span class="k">return</span> <span class="n">contract</span><span class="o">.</span><span class="n">contract_size</span> <span class="o">*</span> <span class="n">price</span>  <span class="c1"># 100 oz * price</span>
    <span class="k">elif</span> <span class="n">contract</span><span class="o">.</span><span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;6E&#39;</span><span class="p">:</span>  <span class="c1"># Euro FX</span>
        <span class="k">return</span> <span class="n">contract</span><span class="o">.</span><span class="n">contract_size</span> <span class="o">*</span> <span class="n">price</span>  <span class="c1"># 125000 euros * rate</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">contract</span><span class="o">.</span><span class="n">contract_size</span> <span class="o">*</span> <span class="n">price</span>


<span class="c1"># Sample prices for calculations</span>
<span class="n">sample_prices</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ES&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
    <span class="s1">&#39;NQ&#39;</span><span class="p">:</span> <span class="mi">17500</span><span class="p">,</span>
    <span class="s1">&#39;CL&#39;</span><span class="p">:</span> <span class="mf">75.00</span><span class="p">,</span>
    <span class="s1">&#39;GC&#39;</span><span class="p">:</span> <span class="mi">2050</span><span class="p">,</span>
    <span class="s1">&#39;6E&#39;</span><span class="p">:</span> <span class="mf">1.0850</span>
<span class="p">}</span>

<span class="c1"># Approximate initial margins (varies by broker)</span>
<span class="n">initial_margins</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ES&#39;</span><span class="p">:</span> <span class="mi">12000</span><span class="p">,</span>
    <span class="s1">&#39;NQ&#39;</span><span class="p">:</span> <span class="mi">16000</span><span class="p">,</span>
    <span class="s1">&#39;CL&#39;</span><span class="p">:</span> <span class="mi">6000</span><span class="p">,</span>
    <span class="s1">&#39;GC&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span>
    <span class="s1">&#39;6E&#39;</span><span class="p">:</span> <span class="mi">2500</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Futures Contract Size Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Contract&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Price&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Notional&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Margin&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Leverage&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="s1">&#39;NQ&#39;</span><span class="p">,</span> <span class="s1">&#39;CL&#39;</span><span class="p">,</span> <span class="s1">&#39;GC&#39;</span><span class="p">,</span> <span class="s1">&#39;6E&#39;</span><span class="p">]:</span>
    <span class="n">contract</span> <span class="o">=</span> <span class="n">FUTURES_CONTRACTS</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">sample_prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
    <span class="n">notional</span> <span class="o">=</span> <span class="n">get_notional_value</span><span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="n">initial_margins</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
    <span class="n">leverage</span> <span class="o">=</span> <span class="n">notional</span> <span class="o">/</span> <span class="n">margin</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">&lt;11,.2f</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">notional</span><span class="si">:</span><span class="s2">&lt;14,.0f</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">margin</span><span class="si">:</span><span class="s2">&lt;11,</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">leverage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">:1&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 2.1: Read Contract Specifications (Guided)</h2>
<p>Complete the function to parse and analyze futures contract specifications.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 2.1: Read Contract Specifications (Guided)</span>
<span class="k">def</span> <span class="nf">analyze_contract</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze a futures contract&#39;s specifications and calculate key metrics.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        symbol: Contract symbol (e.g., &#39;ES&#39;)</span>
<span class="sd">        current_price: Current contract price</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with contract analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get contract from our definitions</span>
    <span class="n">contract</span> <span class="o">=</span> <span class="n">FUTURES_CONTRACTS</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>  <span class="c1"># Get contract by key</span>
    
    <span class="k">if</span> <span class="n">contract</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Contract </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">}</span>
    
    <span class="c1"># Calculate notional value</span>
    <span class="n">notional</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">contract_size</span> <span class="o">*</span> <span class="n">______</span>  <span class="c1"># Multiply by price</span>
    
    <span class="c1"># Calculate value of 1% move</span>
    <span class="n">one_percent_move</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">*</span> <span class="n">______</span>  <span class="c1"># 1% = 0.01</span>
    <span class="n">one_percent_pnl</span> <span class="o">=</span> <span class="n">one_percent_move</span> <span class="o">*</span> <span class="n">contract</span><span class="o">.</span><span class="n">point_value</span>
    
    <span class="c1"># Calculate ticks in a 1% move</span>
    <span class="n">ticks_in_one_percent</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">points_to_ticks</span><span class="p">(</span><span class="n">one_percent_move</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span>
        <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">current_price</span><span class="p">,</span>
        <span class="s1">&#39;notional_value&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">notional</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;point_value&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">point_value</span><span class="p">,</span>
        <span class="s1">&#39;tick_size&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">tick_size</span><span class="p">,</span>
        <span class="s1">&#39;tick_value&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">tick_value</span><span class="p">,</span>
        <span class="s1">&#39;one_percent_move_points&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">one_percent_move</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;one_percent_move_ticks&#39;</span><span class="p">:</span> <span class="n">ticks_in_one_percent</span><span class="p">,</span>
        <span class="s1">&#39;one_percent_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">one_percent_pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test the function</span>
<span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;CL&#39;</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;GC&#39;</span><span class="p">,</span> <span class="mi">2050</span><span class="p">)]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">analyze_contract</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) Analysis:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Notional Value: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;notional_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Point Value: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;point_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  1% Move: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;one_percent_move_points&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> points = $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;one_percent_pnl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_contract</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze a futures contract&#39;s specifications and calculate key metrics.</span>

<span class="sd">    Args:</span>
<span class="sd">        symbol: Contract symbol (e.g., &#39;ES&#39;)</span>
<span class="sd">        current_price: Current contract price</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with contract analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get contract from our definitions</span>
    <span class="n">contract</span> <span class="o">=</span> <span class="n">FUTURES_CONTRACTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>  <span class="c1"># Get contract by key</span>

    <span class="k">if</span> <span class="n">contract</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Contract </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">}</span>

    <span class="c1"># Calculate notional value</span>
    <span class="n">notional</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">contract_size</span> <span class="o">*</span> <span class="n">current_price</span>  <span class="c1"># Multiply by price</span>

    <span class="c1"># Calculate value of 1% move</span>
    <span class="n">one_percent_move</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">*</span> <span class="mf">0.01</span>  <span class="c1"># 1% = 0.01</span>
    <span class="n">one_percent_pnl</span> <span class="o">=</span> <span class="n">one_percent_move</span> <span class="o">*</span> <span class="n">contract</span><span class="o">.</span><span class="n">point_value</span>

    <span class="c1"># Calculate ticks in a 1% move</span>
    <span class="n">ticks_in_one_percent</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">points_to_ticks</span><span class="p">(</span><span class="n">one_percent_move</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;exchange&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span>
        <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">current_price</span><span class="p">,</span>
        <span class="s1">&#39;notional_value&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">notional</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;point_value&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">point_value</span><span class="p">,</span>
        <span class="s1">&#39;tick_size&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">tick_size</span><span class="p">,</span>
        <span class="s1">&#39;tick_value&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">tick_value</span><span class="p">,</span>
        <span class="s1">&#39;one_percent_move_points&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">one_percent_move</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;one_percent_move_ticks&#39;</span><span class="p">:</span> <span class="n">ticks_in_one_percent</span><span class="p">,</span>
        <span class="s1">&#39;one_percent_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">one_percent_pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>2.3 Futures vs Spot</h2>
<h3>Understanding Basis</h3>
<p>The <strong>basis</strong> is the difference between the futures price and the spot price:</p>
<div class="highlight"><pre><span></span><code>Basis = Futures Price - Spot Price
</code></pre></div>

<h3>Contango vs Backwardation</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Condition</th>
<th>Basis</th>
<th>Futures vs Spot</th>
<th>Common In</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Contango</strong></td>
<td>Positive</td>
<td>Futures &gt; Spot</td>
<td>Normal markets, storage costs</td>
</tr>
<tr>
<td><strong>Backwardation</strong></td>
<td>Negative</td>
<td>Futures &lt; Spot</td>
<td>Supply shortages, high demand</td>
</tr>
</tbody>
</table></div>
<h3>Cost of Carry Model</h3>
<p>In theory, the futures price should reflect:</p>
<div class="highlight"><pre><span></span><code>Futures Price = Spot Price Ã— (1 + r - y)^t

Where:
- r = risk-free interest rate
- y = convenience yield (benefit of holding physical)
- t = time to expiration
</code></pre></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BasisAnalysis</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analysis of futures basis.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        spot_price: Current spot price</span>
<span class="sd">        futures_price: Futures contract price</span>
<span class="sd">        days_to_expiry: Days until contract expiration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spot_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">futures_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">days_to_expiry</span><span class="p">:</span> <span class="nb">int</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">basis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate absolute basis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_price</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">basis_percent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate basis as percentage of spot.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">annualized_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Annualize the basis percentage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_to_expiry</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_percent</span> <span class="o">*</span> <span class="p">(</span><span class="mi">365</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_to_expiry</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">market_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine market condition.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Contango&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Backwardation&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Flat&#39;</span>
    
    <span class="k">def</span> <span class="nf">implied_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate implied yield/cost of carry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_to_expiry</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annualized_basis</span>


<span class="c1"># Example basis analysis</span>
<span class="n">examples</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;Gold&#39;</span><span class="p">,</span> <span class="mi">2050</span><span class="p">,</span> <span class="mi">2065</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span>      <span class="c1"># Contango</span>
    <span class="p">(</span><span class="s1">&#39;Crude Oil&#39;</span><span class="p">,</span> <span class="mf">75.00</span><span class="p">,</span> <span class="mf">73.50</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>  <span class="c1"># Backwardation</span>
    <span class="p">(</span><span class="s1">&#39;S&amp;P 500&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5012</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>   <span class="c1"># Slight contango</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basis Analysis Examples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">spot</span><span class="p">,</span> <span class="n">futures</span><span class="p">,</span> <span class="n">days</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
    <span class="n">analysis</span> <span class="o">=</span> <span class="n">BasisAnalysis</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">futures</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Spot: $</span><span class="si">{</span><span class="n">spot</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2"> | Futures: $</span><span class="si">{</span><span class="n">futures</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2"> | Days: </span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Basis: $</span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">basis</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">basis_percent</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annualized: </span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">annualized_basis</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Market: </span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">market_condition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Visualize contango and backwardation</span>
<span class="k">def</span> <span class="nf">plot_term_structure</span><span class="p">(</span><span class="n">contracts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot futures term structure.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        contracts: List of (name, price, days_to_expiry) tuples</span>
<span class="sd">        title: Chart title</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="c1"># Sort by expiry</span>
    <span class="n">contracts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">contracts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contracts</span><span class="p">]</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contracts</span><span class="p">]</span>
    <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contracts</span><span class="p">]</span>
    
    <span class="c1"># Plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="s1">&#39;bo-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    
    <span class="c1"># Add labels</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contracts</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s1">$</span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">price</span><span class="p">),</span>
                   <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                   <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    
    <span class="c1"># Determine structure</span>
    <span class="k">if</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="s1">&#39;CONTANGO&#39;</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="s1">&#39;BACKWARDATION&#39;</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
           <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
           <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days to Expiration&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Example: Gold in contango</span>
<span class="n">gold_contracts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;Spot&#39;</span><span class="p">,</span> <span class="mi">2050</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="mi">2055</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="mi">2062</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="mi">2070</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="mi">2078</span><span class="p">,</span> <span class="mi">210</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">plot_term_structure</span><span class="p">(</span><span class="n">gold_contracts</span><span class="p">,</span> <span class="s1">&#39;Gold Futures Term Structure&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Example: Oil in backwardation</span>
<span class="n">oil_contracts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;Spot&#39;</span><span class="p">,</span> <span class="mf">78.00</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="mf">76.50</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="mf">75.20</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="mf">74.10</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="mf">73.20</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">plot_term_structure</span><span class="p">(</span><span class="n">oil_contracts</span><span class="p">,</span> <span class="s1">&#39;Crude Oil Futures Term Structure&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 2.2: Analyze Basis (Guided)</h2>
<p>Complete the function to calculate roll yield and analyze term structure.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 2.2: Analyze Basis (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_roll_yield</span><span class="p">(</span>
    <span class="n">front_month_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">back_month_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">days_between</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the roll yield when rolling from front to back month.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        front_month_price: Price of expiring contract</span>
<span class="sd">        back_month_price: Price of next contract</span>
<span class="sd">        days_between: Days between contract expirations</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with roll yield analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate raw roll</span>
    <span class="n">roll_difference</span> <span class="o">=</span> <span class="n">back_month_price</span> <span class="o">-</span> <span class="n">front_month_price</span>
    
    <span class="c1"># Calculate roll yield percentage</span>
    <span class="n">roll_yield_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">roll_difference</span> <span class="o">/</span> <span class="n">front_month_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">______</span>  <span class="c1"># Convert to percentage</span>
    
    <span class="c1"># Annualize the roll yield</span>
    <span class="n">annualized_yield</span> <span class="o">=</span> <span class="n">roll_yield_pct</span> <span class="o">*</span> <span class="p">(</span><span class="n">______</span> <span class="o">/</span> <span class="n">days_between</span><span class="p">)</span>  <span class="c1"># Days in year</span>
    
    <span class="c1"># Determine if positive or negative roll</span>
    <span class="k">if</span> <span class="n">roll_difference</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">roll_type</span> <span class="o">=</span> <span class="s1">&#39;Negative Roll Yield&#39;</span>  <span class="c1"># Contango hurts long holders</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">______</span>  <span class="c1"># Market structure name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">roll_type</span> <span class="o">=</span> <span class="s1">&#39;Positive Roll Yield&#39;</span>  <span class="c1"># Backwardation helps long holders</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="s1">&#39;Backwardation&#39;</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;front_price&#39;</span><span class="p">:</span> <span class="n">front_month_price</span><span class="p">,</span>
        <span class="s1">&#39;back_price&#39;</span><span class="p">:</span> <span class="n">back_month_price</span><span class="p">,</span>
        <span class="s1">&#39;roll_difference&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">roll_difference</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s1">&#39;roll_yield_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">roll_yield_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;annualized_yield&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">annualized_yield</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;roll_type&#39;</span><span class="p">:</span> <span class="n">roll_type</span><span class="p">,</span>
        <span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="n">structure</span>
    <span class="p">}</span>

<span class="c1"># Test with examples</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Roll Yield Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="n">examples</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;Gold&#39;</span><span class="p">,</span> <span class="mi">2055</span><span class="p">,</span> <span class="mi">2070</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span>      <span class="c1"># Contango</span>
    <span class="p">(</span><span class="s1">&#39;Crude Oil&#39;</span><span class="p">,</span> <span class="mf">76.50</span><span class="p">,</span> <span class="mf">74.10</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span>  <span class="c1"># Backwardation</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">front</span><span class="p">,</span> <span class="n">back</span><span class="p">,</span> <span class="n">days</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_roll_yield</span><span class="p">(</span><span class="n">front</span><span class="p">,</span> <span class="n">back</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Front: $</span><span class="si">{</span><span class="n">front</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> â†’ Back: $</span><span class="si">{</span><span class="n">back</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Roll Difference: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;roll_difference&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Roll Yield: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;roll_yield_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% (</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;annualized_yield&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% annualized)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Structure: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;roll_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_roll_yield</span><span class="p">(</span>
    <span class="n">front_month_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">back_month_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">days_between</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the roll yield when rolling from front to back month.</span>

<span class="sd">    Args:</span>
<span class="sd">        front_month_price: Price of expiring contract</span>
<span class="sd">        back_month_price: Price of next contract</span>
<span class="sd">        days_between: Days between contract expirations</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with roll yield analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate raw roll</span>
    <span class="n">roll_difference</span> <span class="o">=</span> <span class="n">back_month_price</span> <span class="o">-</span> <span class="n">front_month_price</span>

    <span class="c1"># Calculate roll yield percentage</span>
    <span class="n">roll_yield_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">roll_difference</span> <span class="o">/</span> <span class="n">front_month_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Convert to percentage</span>

    <span class="c1"># Annualize the roll yield</span>
    <span class="n">annualized_yield</span> <span class="o">=</span> <span class="n">roll_yield_pct</span> <span class="o">*</span> <span class="p">(</span><span class="mi">365</span> <span class="o">/</span> <span class="n">days_between</span><span class="p">)</span>  <span class="c1"># Days in year</span>

    <span class="c1"># Determine if positive or negative roll</span>
    <span class="k">if</span> <span class="n">roll_difference</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">roll_type</span> <span class="o">=</span> <span class="s1">&#39;Negative Roll Yield&#39;</span>  <span class="c1"># Contango hurts long holders</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="s1">&#39;Contango&#39;</span>  <span class="c1"># Market structure name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">roll_type</span> <span class="o">=</span> <span class="s1">&#39;Positive Roll Yield&#39;</span>  <span class="c1"># Backwardation helps long holders</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="s1">&#39;Backwardation&#39;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;front_price&#39;</span><span class="p">:</span> <span class="n">front_month_price</span><span class="p">,</span>
        <span class="s1">&#39;back_price&#39;</span><span class="p">:</span> <span class="n">back_month_price</span><span class="p">,</span>
        <span class="s1">&#39;roll_difference&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">roll_difference</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s1">&#39;roll_yield_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">roll_yield_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;annualized_yield&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">annualized_yield</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;roll_type&#39;</span><span class="p">:</span> <span class="n">roll_type</span><span class="p">,</span>
        <span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="n">structure</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>2.4 Contract Months &amp; Rollover</h2>
<h3>Contract Month Codes</h3>
<p>Futures contracts use single-letter codes for expiration months:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Code</th>
<th>Month</th>
<th>Code</th>
<th>Month</th>
</tr>
</thead>
<tbody>
<tr>
<td>F</td>
<td>January</td>
<td>N</td>
<td>July</td>
</tr>
<tr>
<td>G</td>
<td>February</td>
<td>Q</td>
<td>August</td>
</tr>
<tr>
<td>H</td>
<td>March</td>
<td>U</td>
<td>September</td>
</tr>
<tr>
<td>J</td>
<td>April</td>
<td>V</td>
<td>October</td>
</tr>
<tr>
<td>K</td>
<td>May</td>
<td>X</td>
<td>November</td>
</tr>
<tr>
<td>M</td>
<td>June</td>
<td>Z</td>
<td>December</td>
</tr>
</tbody>
</table></div>
<h3>Contract Symbol Format</h3>
<div class="highlight"><pre><span></span><code>ESH24 = E-mini S&amp;P 500, March 2024
  â”‚â””â”´â”€â”€ Year (24 = 2024)
  â””â”€â”€â”€â”€ Month (H = March)
</code></pre></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Contract month codes</span>
<span class="n">MONTH_CODES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;January&#39;</span><span class="p">),</span>
    <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;February&#39;</span><span class="p">),</span>
    <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;March&#39;</span><span class="p">),</span>
    <span class="s1">&#39;J&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;April&#39;</span><span class="p">),</span>
    <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">),</span>
    <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;June&#39;</span><span class="p">),</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;July&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;August&#39;</span><span class="p">),</span>
    <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;September&#39;</span><span class="p">),</span>
    <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;October&#39;</span><span class="p">),</span>
    <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;November&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;December&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Reverse lookup</span>
<span class="n">MONTH_TO_CODE</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">MONTH_CODES</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="k">class</span> <span class="nc">FuturesSymbolParser</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parser for futures contract symbols.</span>
<span class="sd">    </span>
<span class="sd">    Handles symbols like ESH24, CLZ25, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the symbol into components.&quot;&quot;&quot;</span>
        <span class="c1"># Assume format: ROOT + MONTH_CODE + YEAR (2 digits)</span>
        <span class="c1"># e.g., ESH24, CLZ25, GCM24</span>
        
        <span class="c1"># Find the month code (second to last character before year)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_symbol</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">year_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_symbol</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">month_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_symbol</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_symbol</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid symbol format: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">year</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get full year.&quot;&quot;&quot;</span>
        <span class="n">year_2digit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">2000</span> <span class="o">+</span> <span class="n">year_2digit</span> <span class="k">if</span> <span class="n">year_2digit</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="mi">1900</span> <span class="o">+</span> <span class="n">year_2digit</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">month</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get month number.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MONTH_CODES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">month_code</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">month_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get month name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MONTH_CODES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">month_code</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expiration_date</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Estimate expiration date (third Friday of month).&quot;&quot;&quot;</span>
        <span class="c1"># Find third Friday</span>
        <span class="n">first_day</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Days until Friday (4 = Friday)</span>
        <span class="n">days_until_friday</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">first_day</span><span class="o">.</span><span class="n">weekday</span><span class="p">())</span> <span class="o">%</span> <span class="mi">7</span>
        <span class="n">first_friday</span> <span class="o">=</span> <span class="n">first_day</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_until_friday</span><span class="p">)</span>
        <span class="n">third_friday</span> <span class="o">=</span> <span class="n">first_friday</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">third_friday</span>
    
    <span class="k">def</span> <span class="nf">days_to_expiry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate days until expiration.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">as_of</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">as_of</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiration_date</span> <span class="o">-</span> <span class="n">as_of</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">month_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="c1"># Test the parser</span>
<span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ESH25&#39;</span><span class="p">,</span> <span class="s1">&#39;CLZ25&#39;</span><span class="p">,</span> <span class="s1">&#39;GCM25&#39;</span><span class="p">,</span> <span class="s1">&#39;NQU25&#39;</span><span class="p">,</span> <span class="s1">&#39;6EH25&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Futures Symbol Parsing&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">FuturesSymbolParser</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym</span><span class="si">:</span><span class="s2">8</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">parser</span><span class="si">!r:</span><span class="s2">25</span><span class="si">}</span><span class="s2"> (Expires: </span><span class="si">{</span><span class="n">parser</span><span class="o">.</span><span class="n">expiration_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ContractRollover</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles futures contract rollover logic.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        root_symbol: Base contract symbol (e.g., &#39;ES&#39;)</span>
<span class="sd">        contract_months: List of valid contract month codes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">contract_months</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_symbol</span> <span class="o">=</span> <span class="n">root_symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_months</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">contract_months</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_contract_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">month_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate full contract symbol.&quot;&quot;&quot;</span>
        <span class="n">year_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_symbol</span><span class="si">}{</span><span class="n">month_code</span><span class="si">}{</span><span class="n">year_str</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">def</span> <span class="nf">get_active_contract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the currently active (front month) contract.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            as_of: Reference date (default: today)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Active contract symbol</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">as_of</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">as_of</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="n">current_month</span> <span class="o">=</span> <span class="n">as_of</span><span class="o">.</span><span class="n">month</span>
        <span class="n">current_year</span> <span class="o">=</span> <span class="n">as_of</span><span class="o">.</span><span class="n">year</span>
        
        <span class="c1"># Find the next valid contract month</span>
        <span class="k">for</span> <span class="n">month_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract_months</span><span class="p">:</span>
            <span class="n">month_num</span> <span class="o">=</span> <span class="n">MONTH_CODES</span><span class="p">[</span><span class="n">month_code</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">month_num</span> <span class="o">&gt;</span> <span class="n">current_month</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_contract_symbol</span><span class="p">(</span><span class="n">month_code</span><span class="p">,</span> <span class="n">current_year</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">month_num</span> <span class="o">==</span> <span class="n">current_month</span><span class="p">:</span>
                <span class="c1"># Check if we&#39;re past typical roll date (e.g., 2nd Thursday)</span>
                <span class="k">if</span> <span class="n">as_of</span><span class="o">.</span><span class="n">day</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>  <span class="c1"># Simplified: roll after 15th</span>
                    <span class="k">continue</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_contract_symbol</span><span class="p">(</span><span class="n">month_code</span><span class="p">,</span> <span class="n">current_year</span><span class="p">)</span>
        
        <span class="c1"># Roll to next year&#39;s first contract</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_contract_symbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contract_months</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_contract_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_contracts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a chain of upcoming contracts.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            num_contracts: Number of contracts to return</span>
<span class="sd">            as_of: Reference date</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of contract symbols</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">as_of</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">as_of</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="n">contracts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_month</span> <span class="o">=</span> <span class="n">as_of</span><span class="o">.</span><span class="n">month</span>
        <span class="n">current_year</span> <span class="o">=</span> <span class="n">as_of</span><span class="o">.</span><span class="n">year</span>
        
        <span class="c1"># Build list of all possible contracts for next 2 years</span>
        <span class="n">all_contracts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="p">[</span><span class="n">current_year</span><span class="p">,</span> <span class="n">current_year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">month_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract_months</span><span class="p">:</span>
                <span class="n">month_num</span> <span class="o">=</span> <span class="n">MONTH_CODES</span><span class="p">[</span><span class="n">month_code</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="n">current_year</span> <span class="ow">and</span> <span class="n">month_num</span> <span class="o">&lt;</span> <span class="n">current_month</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">all_contracts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_contract_symbol</span><span class="p">(</span><span class="n">month_code</span><span class="p">,</span> <span class="n">year</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">all_contracts</span><span class="p">[:</span><span class="n">num_contracts</span><span class="p">]</span>


<span class="c1"># Test rollover logic</span>
<span class="n">es_rollover</span> <span class="o">=</span> <span class="n">ContractRollover</span><span class="p">(</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;E-mini S&amp;P 500 Contract Chain&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active Contract: </span><span class="si">{</span><span class="n">es_rollover</span><span class="o">.</span><span class="n">get_active_contract</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Upcoming Contracts:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">contract</span> <span class="ow">in</span> <span class="n">es_rollover</span><span class="o">.</span><span class="n">get_contract_chain</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">FuturesSymbolParser</span><span class="p">(</span><span class="n">contract</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">contract</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">parser</span><span class="o">.</span><span class="n">month_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">parser</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 2.3: Handle Rollover (Guided)</h2>
<p>Complete the function to build a continuous futures price series by handling rollovers.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 2.3: Handle Rollover (Guided)</span>
<span class="k">def</span> <span class="nf">build_continuous_series</span><span class="p">(</span>
    <span class="n">contract_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
    <span class="n">roll_dates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="p">],</span>
    <span class="n">adjustment_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ratio&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a continuous futures price series from individual contracts.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        contract_data: Dict of contract symbol -&gt; price DataFrame</span>
<span class="sd">        roll_dates: Dict of contract symbol -&gt; roll date</span>
<span class="sd">        adjustment_method: &#39;ratio&#39; or &#39;difference&#39;</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Continuous price series</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sort contracts by roll date</span>
    <span class="n">sorted_contracts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">roll_dates</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">continuous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">adjustment_factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">adjustment_method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">roll_date</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_contracts</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">contract</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contract_data</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="n">df</span> <span class="o">=</span> <span class="n">contract_data</span><span class="p">[</span><span class="n">contract</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Get data up to roll date</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_contracts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">next_contract</span> <span class="o">=</span> <span class="n">sorted_contracts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">next_roll</span> <span class="o">=</span> <span class="n">sorted_contracts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">______</span> <span class="o">&lt;</span> <span class="n">roll_date</span>  <span class="c1"># Filter by index (date)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            
            <span class="c1"># Calculate adjustment at roll point</span>
            <span class="k">if</span> <span class="n">next_contract</span> <span class="ow">in</span> <span class="n">contract_data</span><span class="p">:</span>
                <span class="n">next_df</span> <span class="o">=</span> <span class="n">contract_data</span><span class="p">[</span><span class="n">next_contract</span><span class="p">]</span>
                
                <span class="c1"># Find prices at roll date</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">old_price</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># Get first price from next contract after roll</span>
                    <span class="n">next_prices</span> <span class="o">=</span> <span class="n">next_df</span><span class="p">[</span><span class="n">next_df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">roll_date</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_prices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">new_price</span> <span class="o">=</span> <span class="n">next_prices</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        
                        <span class="k">if</span> <span class="n">adjustment_method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
                            <span class="n">adjustment_factor</span> <span class="o">*=</span> <span class="n">new_price</span> <span class="o">/</span> <span class="n">______</span>  <span class="c1"># Divide by old price</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">adjustment_factor</span> <span class="o">+=</span> <span class="n">new_price</span> <span class="o">-</span> <span class="n">old_price</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
        
        <span class="c1"># Apply adjustment</span>
        <span class="k">if</span> <span class="n">adjustment_method</span> <span class="o">==</span> <span class="n">______</span><span class="p">:</span>  <span class="c1"># Check method type</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;adjusted_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">adjustment_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;adjusted_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">adjustment_factor</span>
        
        <span class="n">continuous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">continuous</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;adjusted_close&#39;</span><span class="p">]]])</span>
    
    <span class="k">return</span> <span class="n">continuous</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="c1"># Create sample data for testing</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Mock data for two contracts</span>
<span class="n">dates1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-03-15&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">dates2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-03-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-06-15&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="n">contract1_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="mi">5000</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dates1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">dates1</span><span class="p">)</span>

<span class="n">contract2_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="mi">5020</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dates2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># Starts higher (contango)</span>
<span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">dates2</span><span class="p">)</span>

<span class="n">contract_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ESH24&#39;</span><span class="p">:</span> <span class="n">contract1_data</span><span class="p">,</span>
    <span class="s1">&#39;ESM24&#39;</span><span class="p">:</span> <span class="n">contract2_data</span>
<span class="p">}</span>

<span class="n">roll_dates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ESH24&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
    <span class="s1">&#39;ESM24&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Build continuous series</span>
<span class="n">continuous</span> <span class="o">=</span> <span class="n">build_continuous_series</span><span class="p">(</span><span class="n">contract_data</span><span class="p">,</span> <span class="n">roll_dates</span><span class="p">,</span> <span class="s1">&#39;ratio&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Continuous Series (around roll date):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">continuous</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2024-03-10&#39;</span><span class="p">:</span><span class="s1">&#39;2024-03-20&#39;</span><span class="p">])</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_continuous_series</span><span class="p">(</span>
    <span class="n">contract_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
    <span class="n">roll_dates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="p">],</span>
    <span class="n">adjustment_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ratio&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a continuous futures price series from individual contracts.</span>

<span class="sd">    Args:</span>
<span class="sd">        contract_data: Dict of contract symbol -&gt; price DataFrame</span>
<span class="sd">        roll_dates: Dict of contract symbol -&gt; roll date</span>
<span class="sd">        adjustment_method: &#39;ratio&#39; or &#39;difference&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Continuous price series</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sort contracts by roll date</span>
    <span class="n">sorted_contracts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">roll_dates</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">continuous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">adjustment_factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">adjustment_method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">contract</span><span class="p">,</span> <span class="n">roll_date</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_contracts</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">contract</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contract_data</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">contract_data</span><span class="p">[</span><span class="n">contract</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Get data up to roll date</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_contracts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">next_contract</span> <span class="o">=</span> <span class="n">sorted_contracts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">next_roll</span> <span class="o">=</span> <span class="n">sorted_contracts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">roll_date</span>  <span class="c1"># Filter by index (date)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="c1"># Calculate adjustment at roll point</span>
            <span class="k">if</span> <span class="n">next_contract</span> <span class="ow">in</span> <span class="n">contract_data</span><span class="p">:</span>
                <span class="n">next_df</span> <span class="o">=</span> <span class="n">contract_data</span><span class="p">[</span><span class="n">next_contract</span><span class="p">]</span>

                <span class="c1"># Find prices at roll date</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">old_price</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># Get first price from next contract after roll</span>
                    <span class="n">next_prices</span> <span class="o">=</span> <span class="n">next_df</span><span class="p">[</span><span class="n">next_df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">roll_date</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_prices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">new_price</span> <span class="o">=</span> <span class="n">next_prices</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">adjustment_method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
                            <span class="n">adjustment_factor</span> <span class="o">*=</span> <span class="n">new_price</span> <span class="o">/</span> <span class="n">old_price</span>  <span class="c1"># Divide by old price</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">adjustment_factor</span> <span class="o">+=</span> <span class="n">new_price</span> <span class="o">-</span> <span class="n">old_price</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="c1"># Apply adjustment</span>
        <span class="k">if</span> <span class="n">adjustment_method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>  <span class="c1"># Check method type</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;adjusted_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">adjustment_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;adjusted_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">adjustment_factor</span>

        <span class="n">continuous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">continuous</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;adjusted_close&#39;</span><span class="p">]]])</span>

    <span class="k">return</span> <span class="n">continuous</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 2.4: Futures Contract Analyzer (Open-ended)</h2>
<p>Build a comprehensive futures contract analyzer that calculates margin requirements, leverage, and risk metrics.</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 2.4: Futures Contract Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a FuturesAnalyzer class that:</span>
<span class="c1"># - Takes a contract symbol and current price</span>
<span class="c1"># - Calculates notional value and leverage based on margin</span>
<span class="c1"># - Determines position size based on risk parameters</span>
<span class="c1"># - Calculates potential P&amp;L for different price scenarios</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - get_notional_value() -&gt; float</span>
<span class="c1"># - get_leverage(margin: float) -&gt; float</span>
<span class="c1"># - position_size_by_risk(account: float, risk_pct: float, stop_ticks: int) -&gt; int</span>
<span class="c1"># - scenario_analysis(price_changes: List[float]) -&gt; pd.DataFrame</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FuturesAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive analyzer for futures contracts.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        contract: FuturesContract specification</span>
<span class="sd">        current_price: Current contract price</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract</span> <span class="o">=</span> <span class="n">FUTURES_CONTRACTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown contract: </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_price</span> <span class="o">=</span> <span class="n">current_price</span>

    <span class="k">def</span> <span class="nf">get_notional_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate the notional value of one contract.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">contract_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_price</span>

    <span class="k">def</span> <span class="nf">get_leverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">margin</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate leverage based on margin requirement.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_notional_value</span><span class="p">()</span> <span class="o">/</span> <span class="n">margin</span>

    <span class="k">def</span> <span class="nf">position_size_by_risk</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">account</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">stop_ticks</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate position size based on risk parameters.&quot;&quot;&quot;</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">account</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">risk_per_contract</span> <span class="o">=</span> <span class="n">stop_ticks</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">tick_value</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">risk_amount</span> <span class="o">/</span> <span class="n">risk_per_contract</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">scenario_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_changes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze P&amp;L under different price scenarios.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">change_pct</span> <span class="ow">in</span> <span class="n">price_changes</span><span class="p">:</span>
            <span class="n">new_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">change_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">points_change</span> <span class="o">=</span> <span class="n">new_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_price</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="n">points_change</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">point_value</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Price Change (%)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">change_pct</span><span class="si">:</span><span class="s2">+.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="s1">&#39;New Price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">new_price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;Points&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">points_change</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;P&amp;L (1 contract)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">pnl</span><span class="si">:</span><span class="s2">+,.2f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get comprehensive contract summary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_price</span><span class="p">,</span>
            <span class="s1">&#39;notional_value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_notional_value</span><span class="p">()</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;point_value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">point_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;tick_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">tick_size</span><span class="p">,</span>
            <span class="s1">&#39;tick_value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">contract</span><span class="o">.</span><span class="n">tick_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">}</span>


<span class="c1"># Test the analyzer</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">FuturesAnalyzer</span><span class="p">(</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;E-mini S&amp;P 500 Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Leverage at $12,000 margin: </span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">get_leverage</span><span class="p">(</span><span class="mi">12000</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">:1&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position size ($50k account, 2% risk, 20 tick stop): &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">position_size_by_risk</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span><span class="si">}</span><span class="s2"> contracts&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scenario Analysis:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">scenario_analysis</span><span class="p">([</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 2.5: Term Structure Analyzer (Open-ended)</h2>
<p>Build a term structure analyzer that tracks the futures curve and identifies trading opportunities.</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 2.5: Term Structure Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a TermStructureAnalyzer class that:</span>
<span class="c1"># - Takes a list of contract prices and expirations</span>
<span class="c1"># - Calculates the term structure slope</span>
<span class="c1"># - Identifies contango/backwardation</span>
<span class="c1"># - Calculates calendar spread opportunities</span>
<span class="c1"># - Estimates roll cost/yield</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - add_contract(symbol: str, price: float, expiry: datetime)</span>
<span class="c1"># - get_structure() -&gt; str  # &#39;Contango&#39;, &#39;Backwardation&#39;, &#39;Mixed&#39;</span>
<span class="c1"># - calculate_slope() -&gt; float  # Annualized basis change</span>
<span class="c1"># - find_spread_opportunities() -&gt; List[dict]</span>
<span class="c1"># - plot_term_structure()</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TermStructureAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyzes futures term structure for trading opportunities.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        underlying: Name of the underlying asset</span>
<span class="sd">        contracts: List of contract data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">underlying</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">underlying</span> <span class="o">=</span> <span class="n">underlying</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_contract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">expiry</span><span class="p">:</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a contract to the term structure.&quot;&quot;&quot;</span>
        <span class="n">days_to_expiry</span> <span class="o">=</span> <span class="p">(</span><span class="n">expiry</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="n">expiry</span><span class="p">,</span>
            <span class="s1">&#39;days_to_expiry&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">days_to_expiry</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="c1"># Sort by expiry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine overall term structure.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span>

        <span class="n">slopes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
            <span class="n">slopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>

        <span class="n">positive</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slopes</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">negative</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slopes</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">positive</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">slopes</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;Contango&#39;</span>
        <span class="k">elif</span> <span class="n">negative</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">slopes</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;Backwardation&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Mixed&#39;</span>

    <span class="k">def</span> <span class="nf">calculate_slope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate annualized term structure slope.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">front</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">back</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">price_diff</span> <span class="o">=</span> <span class="n">back</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">front</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        <span class="n">days_diff</span> <span class="o">=</span> <span class="n">back</span><span class="p">[</span><span class="s1">&#39;days_to_expiry&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">front</span><span class="p">[</span><span class="s1">&#39;days_to_expiry&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">days_diff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Annualized percentage</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">price_diff</span> <span class="o">/</span> <span class="n">front</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">365</span> <span class="o">/</span> <span class="n">days_diff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">find_spread_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find calendar spread opportunities.&quot;&quot;&quot;</span>
        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">front</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">back</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">spread</span> <span class="o">=</span> <span class="n">back</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">front</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
            <span class="n">days_diff</span> <span class="o">=</span> <span class="n">back</span><span class="p">[</span><span class="s1">&#39;days_to_expiry&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">front</span><span class="p">[</span><span class="s1">&#39;days_to_expiry&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">days_diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">annualized</span> <span class="o">=</span> <span class="p">(</span><span class="n">spread</span> <span class="o">/</span> <span class="n">front</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">365</span> <span class="o">/</span> <span class="n">days_diff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">annualized</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;front&#39;</span><span class="p">:</span> <span class="n">front</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
                <span class="s1">&#39;back&#39;</span><span class="p">:</span> <span class="n">back</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
                <span class="s1">&#39;spread&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">spread</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">spread</span> <span class="o">/</span> <span class="n">front</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;annualized_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">annualized</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;days_between&#39;</span><span class="p">:</span> <span class="n">days_diff</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">opportunities</span>

    <span class="k">def</span> <span class="nf">plot_term_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize the term structure.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No contracts to plot&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;days_to_expiry&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">]</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">]</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="s1">&#39;bo-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">symbols</span><span class="p">)):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="se">\n</span><span class="s1">$</span><span class="si">{</span><span class="n">p</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span>
                       <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
                       <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_structure</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">structure</span> <span class="o">==</span> <span class="s1">&#39;Contango&#39;</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">if</span> <span class="n">structure</span> <span class="o">==</span> <span class="s1">&#39;Backwardation&#39;</span> <span class="k">else</span> <span class="s1">&#39;orange&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
               <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
               <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days to Expiration&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">underlying</span><span class="si">}</span><span class="s1"> Futures Term Structure&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Test the analyzer</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">TermStructureAnalyzer</span><span class="p">(</span><span class="s1">&#39;Crude Oil&#39;</span><span class="p">)</span>

<span class="c1"># Add contracts (backwardation example)</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">add_contract</span><span class="p">(</span><span class="s1">&#39;CLG25&#39;</span><span class="p">,</span> <span class="mf">78.50</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">add_contract</span><span class="p">(</span><span class="s1">&#39;CLH25&#39;</span><span class="p">,</span> <span class="mf">77.20</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">add_contract</span><span class="p">(</span><span class="s1">&#39;CLJ25&#39;</span><span class="p">,</span> <span class="mf">76.10</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">add_contract</span><span class="p">(</span><span class="s1">&#39;CLK25&#39;</span><span class="p">,</span> <span class="mf">75.20</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Structure: </span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">get_structure</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Annualized Slope: </span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">calculate_slope</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Spread Opportunities:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">opp</span> <span class="ow">in</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">find_spread_opportunities</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;front&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;back&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;spread&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;annualized_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% ann.)&quot;</span><span class="p">)</span>

<span class="n">analyzer</span><span class="o">.</span><span class="n">plot_term_structure</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 2.6: Futures Data Handler (Open-ended)</h2>
<p>Build a comprehensive data handler that manages multiple futures contracts and their data.</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 2.6: Futures Data Handler (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a FuturesDataHandler class that:</span>
<span class="c1"># - Manages price data for multiple contracts</span>
<span class="c1"># - Tracks contract specifications</span>
<span class="c1"># - Handles rollover and continuous contract generation</span>
<span class="c1"># - Provides analysis methods for the data</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - add_contract_data(symbol: str, data: pd.DataFrame)</span>
<span class="c1"># - get_front_month(as_of: datetime) -&gt; str</span>
<span class="c1"># - build_continuous(method: str) -&gt; pd.DataFrame</span>
<span class="c1"># - get_term_structure(as_of: datetime) -&gt; pd.DataFrame</span>
<span class="c1"># - calculate_historical_basis(spot_data: pd.Series) -&gt; pd.DataFrame</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FuturesDataHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive handler for futures contract data.</span>

<span class="sd">    Manages multiple contracts, handles rollovers, and provides</span>
<span class="sd">    analysis capabilities for futures data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">contract_months</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_symbol</span> <span class="o">=</span> <span class="n">root_symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_months</span> <span class="o">=</span> <span class="n">contract_months</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roll_dates</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_contract_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add price data for a contract.&quot;&quot;&quot;</span>
        <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Parse expiration and set roll date</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">FuturesSymbolParser</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="c1"># Roll 5 days before expiration</span>
        <span class="n">roll_date</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">expiration_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roll_dates</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">roll_date</span>

    <span class="k">def</span> <span class="nf">get_front_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the front month contract symbol.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">as_of</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">as_of</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="c1"># Find contracts that haven&#39;t expired yet</span>
        <span class="n">active</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">roll_date</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll_dates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">roll_date</span> <span class="o">&gt;</span> <span class="n">as_of</span><span class="p">:</span>
                <span class="n">parser</span> <span class="o">=</span> <span class="n">FuturesSymbolParser</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">active</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">symbol</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">expiration_date</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Return the nearest expiration</span>
        <span class="n">active</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">active</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">build_continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ratio&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build continuous price series.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">build_continuous_series</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contract_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roll_dates</span><span class="p">,</span>
            <span class="n">method</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_term_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get term structure as of a date.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">as_of</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">as_of</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">FuturesSymbolParser</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

            <span class="c1"># Get price as of date</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">as_of</span>
                <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">price</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">price</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">days_to_expiry</span> <span class="o">=</span> <span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">expiration_date</span> <span class="o">-</span> <span class="n">as_of</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">parser</span><span class="o">.</span><span class="n">month_name</span><span class="p">,</span>
                <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">parser</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s1">&#39;days_to_expiry&#39;</span><span class="p">:</span> <span class="n">days_to_expiry</span>
            <span class="p">})</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;days_to_expiry&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_historical_basis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">spot_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate historical basis vs spot.&quot;&quot;&quot;</span>
        <span class="n">continuous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_continuous</span><span class="p">(</span><span class="s1">&#39;ratio&#39;</span><span class="p">)</span>

        <span class="c1"># Align dates</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;futures&#39;</span><span class="p">:</span> <span class="n">continuous</span><span class="p">[</span><span class="s1">&#39;adjusted_close&#39;</span><span class="p">],</span>
            <span class="s1">&#39;spot&#39;</span><span class="p">:</span> <span class="n">spot_data</span>
        <span class="p">})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">combined</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="s1">&#39;futures&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">combined</span><span class="p">[</span><span class="s1">&#39;spot&#39;</span><span class="p">]</span>
        <span class="n">combined</span><span class="p">[</span><span class="s1">&#39;basis_pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">combined</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">combined</span><span class="p">[</span><span class="s1">&#39;spot&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">return</span> <span class="n">combined</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get handler summary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;root_symbol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_symbol</span><span class="p">,</span>
            <span class="s1">&#39;contracts_loaded&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contract_data</span><span class="p">),</span>
            <span class="s1">&#39;contract_symbols&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contract_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="s1">&#39;front_month&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_front_month</span><span class="p">()</span>
        <span class="p">}</span>


<span class="c1"># Test the handler</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">FuturesDataHandler</span><span class="p">(</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">])</span>

<span class="c1"># Add mock data</span>
<span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">contract_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">add_contract_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Futures Data Handler Summary&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Term Structure:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">get_term_structure</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Futures Data Handler</h2>
<p>Build a comprehensive futures data handler that combines all concepts from this module.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ComprehensiveFuturesHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete futures data and analysis system.</span>
<span class="sd">    </span>
<span class="sd">    Combines contract specifications, price data management,</span>
<span class="sd">    rollover handling, and term structure analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the handler.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            root_symbol: Base symbol (e.g., &#39;ES&#39;, &#39;CL&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_symbol</span> <span class="o">=</span> <span class="n">root_symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_spec</span> <span class="o">=</span> <span class="n">FUTURES_CONTRACTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_symbol</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># symbol -&gt; {&#39;data&#39;: df, &#39;expiry&#39;: datetime}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spot_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># ==================== Contract Management ====================</span>
    
    <span class="k">def</span> <span class="nf">add_contract</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">expiry</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a contract with its price data.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            symbol: Full contract symbol (e.g., &#39;ESH25&#39;)</span>
<span class="sd">            data: OHLCV DataFrame</span>
<span class="sd">            expiry: Expiration date (auto-calculated if None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">expiry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">FuturesSymbolParser</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">expiry</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">expiration_date</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="n">expiry</span><span class="p">,</span>
            <span class="s1">&#39;roll_date&#39;</span><span class="p">:</span> <span class="n">expiry</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">set_spot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set spot price data for basis calculations.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spot_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_active_contracts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get list of active (non-expired) contracts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">as_of</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">as_of</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="n">active</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">symbol</span> <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">as_of</span>
        <span class="p">]</span>
        
        <span class="c1"># Sort by expiry</span>
        <span class="n">active</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;expiry&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">active</span>
    
    <span class="k">def</span> <span class="nf">get_front_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the front month contract.&quot;&quot;&quot;</span>
        <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_contracts</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">active</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">active</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="c1"># ==================== Continuous Contract ====================</span>
    
    <span class="k">def</span> <span class="nf">build_continuous</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ratio&#39;</span><span class="p">,</span>
        <span class="n">roll_days_before</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build continuous price series.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            method: Adjustment method (&#39;ratio&#39; or &#39;difference&#39;)</span>
<span class="sd">            roll_days_before: Days before expiry to roll</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Continuous price DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># Sort contracts by expiry</span>
        <span class="n">sorted_contracts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="n">continuous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">adjustment</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span> <span class="k">else</span> <span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_contracts</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">roll_date</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;roll_date&#39;</span><span class="p">]</span>
            
            <span class="c1"># Filter data up to roll date</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_contracts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">roll_date</span><span class="p">]</span>
                
                <span class="c1"># Calculate adjustment</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">next_symbol</span> <span class="o">=</span> <span class="n">sorted_contracts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">next_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="n">next_symbol</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
                    
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">old_price</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">new_data</span> <span class="o">=</span> <span class="n">next_data</span><span class="p">[</span><span class="n">next_data</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">roll_date</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">new_price</span> <span class="o">=</span> <span class="n">new_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            
                            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
                                <span class="n">adjustment</span> <span class="o">*=</span> <span class="n">new_price</span> <span class="o">/</span> <span class="n">old_price</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">adjustment</span> <span class="o">+=</span> <span class="n">new_price</span> <span class="o">-</span> <span class="n">old_price</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
            
            <span class="c1"># Apply adjustment</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;contract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ratio&#39;</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;adjusted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">adjustment</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;adjusted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">adjustment</span>
            
            <span class="n">continuous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">continuous</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span> <span class="o">=</span> <span class="n">continuous</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span>
    
    <span class="c1"># ==================== Term Structure ====================</span>
    
    <span class="k">def</span> <span class="nf">get_term_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get term structure snapshot.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            as_of: Reference date</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with term structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">as_of</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">as_of</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">expiry</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span>
            
            <span class="c1"># Get price as of date</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">as_of</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">continue</span>
            
            <span class="n">price</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">days_to_expiry</span> <span class="o">=</span> <span class="p">(</span><span class="n">expiry</span> <span class="o">-</span> <span class="n">as_of</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
            
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s1">&#39;expiry&#39;</span><span class="p">:</span> <span class="n">expiry</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="s1">&#39;days_to_expiry&#39;</span><span class="p">:</span> <span class="n">days_to_expiry</span>
            <span class="p">})</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;days_to_expiry&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">analyze_term_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze current term structure.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Analysis dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_term_structure</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data&#39;</span><span class="p">}</span>
        
        <span class="c1"># Calculate price changes</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        
        <span class="c1"># Determine structure</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">):</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="s1">&#39;Contango&#39;</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">):</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="s1">&#39;Backwardation&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="s1">&#39;Mixed&#39;</span>
        
        <span class="c1"># Calculate front-to-back spread</span>
        <span class="n">front_price</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        <span class="n">back_price</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        <span class="n">total_spread</span> <span class="o">=</span> <span class="n">back_price</span> <span class="o">-</span> <span class="n">front_price</span>
        <span class="n">spread_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_spread</span> <span class="o">/</span> <span class="n">front_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Annualize</span>
        <span class="n">days_span</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;days_to_expiry&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;days_to_expiry&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">days_span</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">annualized</span> <span class="o">=</span> <span class="n">spread_pct</span> <span class="o">*</span> <span class="p">(</span><span class="mi">365</span> <span class="o">/</span> <span class="n">days_span</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">annualized</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="n">structure</span><span class="p">,</span>
            <span class="s1">&#39;front_month&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
            <span class="s1">&#39;back_month&#39;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
            <span class="s1">&#39;total_spread&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_spread</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">spread_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;annualized_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">annualized</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;num_contracts&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="c1"># ==================== Basis Analysis ====================</span>
    
    <span class="k">def</span> <span class="nf">calculate_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate current basis vs spot.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Basis analysis dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">as_of</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">as_of</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="c1"># Get spot price</span>
        <span class="n">spot_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">as_of</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spot_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">spot_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_data</span><span class="p">[</span><span class="n">spot_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Get front month futures price</span>
        <span class="n">front</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_front_month</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">front</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">futures_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="n">front</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">futures_mask</span> <span class="o">=</span> <span class="n">futures_data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">as_of</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">futures_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">futures_price</span> <span class="o">=</span> <span class="n">futures_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">futures_mask</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Calculate basis</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">futures_price</span> <span class="o">-</span> <span class="n">spot_price</span>
        <span class="n">basis_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">basis</span> <span class="o">/</span> <span class="n">spot_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Days to expiry</span>
        <span class="n">days_to_expiry</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">[</span><span class="n">front</span><span class="p">][</span><span class="s1">&#39;expiry&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">as_of</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        
        <span class="c1"># Annualize</span>
        <span class="k">if</span> <span class="n">days_to_expiry</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">annualized</span> <span class="o">=</span> <span class="n">basis_pct</span> <span class="o">*</span> <span class="p">(</span><span class="mi">365</span> <span class="o">/</span> <span class="n">days_to_expiry</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">annualized</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;spot_price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">spot_price</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="s1">&#39;futures_price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">futures_price</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="s1">&#39;front_month&#39;</span><span class="p">:</span> <span class="n">front</span><span class="p">,</span>
            <span class="s1">&#39;basis&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="s1">&#39;basis_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">basis_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;annualized_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">annualized</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;days_to_expiry&#39;</span><span class="p">:</span> <span class="n">days_to_expiry</span><span class="p">,</span>
            <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="s1">&#39;Contango&#39;</span> <span class="k">if</span> <span class="n">basis</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Backwardation&#39;</span> <span class="k">if</span> <span class="n">basis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Flat&#39;</span>
        <span class="p">}</span>
    
    <span class="c1"># ==================== Visualization ====================</span>
    
    <span class="k">def</span> <span class="nf">plot_term_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot the current term structure.&quot;&quot;&quot;</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_term_structure</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No data to plot&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_term_structure</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="s1">&#39;days_to_expiry&#39;</span><span class="p">],</span> <span class="n">ts</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="s1">&#39;bo-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">$</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;days_to_expiry&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]),</span>
                <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span>
            <span class="p">)</span>
        
        <span class="c1"># Add structure label</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Contango&#39;</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;annualized_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% ann.&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span>
        <span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days to Expiration&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_symbol</span><span class="si">}</span><span class="s1"> Futures Term Structure&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">plot_continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot continuous price series.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_continuous</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No continuous data available&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Price chart</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span><span class="p">[</span><span class="s1">&#39;adjusted&#39;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Adjusted&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Unadjusted&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="c1"># Mark roll dates</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">roll_date</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;roll_date&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">roll_date</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span><span class="o">.</span><span class="n">index</span> <span class="ow">or</span> \
               <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">roll_date</span><span class="p">):</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">roll_date</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_symbol</span><span class="si">}</span><span class="s1"> Continuous Futures&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Contract chart</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">contracts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span><span class="p">[</span><span class="s1">&#39;contract&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set1</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">contracts</span><span class="p">)))</span>
        
        <span class="k">for</span> <span class="n">contract</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">contracts</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span><span class="p">[</span><span class="s1">&#39;contract&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">contract</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">contract</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Contract&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">contracts</span><span class="p">))</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># ==================== Summary ====================</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get comprehensive handler summary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;root_symbol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_symbol</span><span class="p">,</span>
            <span class="s1">&#39;contract_spec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract_spec</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contract_spec</span> <span class="k">else</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
            <span class="s1">&#39;contracts_loaded&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">),</span>
            <span class="s1">&#39;contract_symbols&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="s1">&#39;front_month&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_front_month</span><span class="p">(),</span>
            <span class="s1">&#39;has_spot_data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;has_continuous&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print detailed summary.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FUTURES DATA HANDLER: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root_symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Contract: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;contract_spec&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Contracts Loaded: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;contracts_loaded&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Front Month: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;front_month&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contracts</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TERM STRUCTURE&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_term_structure</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            
            <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_term_structure</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Structure: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spread: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;spread_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% (</span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;annualized_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% ann.)&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate the Comprehensive Futures Handler</span>

<span class="c1"># Create handler for E-mini S&amp;P 500</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">ComprehensiveFuturesHandler</span><span class="p">(</span><span class="s1">&#39;ES&#39;</span><span class="p">)</span>

<span class="c1"># Generate mock data for multiple contracts</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">base_price</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="n">contracts_to_add</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;ESH25&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ESM25&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="mi">5</span><span class="p">),</span>   <span class="c1"># Slight contango</span>
    <span class="p">(</span><span class="s1">&#39;ESU25&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ESZ25&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span> <span class="mi">15</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">expiry</span><span class="p">,</span> <span class="n">premium</span> <span class="ow">in</span> <span class="n">contracts_to_add</span><span class="p">:</span>
    <span class="c1"># Generate 90 days of data</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">periods</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">base_price</span> <span class="o">+</span> <span class="n">premium</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">prices</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">prices</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">prices</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
        <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="p">,</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">500000</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
    
    <span class="n">handler</span><span class="o">.</span><span class="n">add_contract</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">expiry</span><span class="p">)</span>

<span class="c1"># Print summary</span>
<span class="n">handler</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Visualize term structure</span>
<span class="n">handler</span><span class="o">.</span><span class="n">plot_term_structure</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Build and visualize continuous contract</span>
<span class="n">continuous</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">build_continuous</span><span class="p">(</span><span class="s1">&#39;ratio&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Continuous Series Sample:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">continuous</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)[[</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;adjusted&#39;</span><span class="p">,</span> <span class="s1">&#39;contract&#39;</span><span class="p">]])</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ul>
<li><strong>Futures contracts</strong> are standardized agreements with specific tick sizes, values, and expiration dates</li>
<li><strong>Contract specifications</strong> define the multiplier, tick value, and point value that determine P&amp;L</li>
<li><strong>Popular markets</strong> include equity indices (ES, NQ), energy (CL, NG), metals (GC, SI), and currencies (6E, 6J)</li>
<li><strong>Basis</strong> is the difference between futures and spot prices; positive = contango, negative = backwardation</li>
<li><strong>Term structure</strong> shows how prices vary across expiration dates and impacts roll yield</li>
<li><strong>Contract months</strong> use letter codes (H=March, M=June, U=September, Z=December for quarterlies)</li>
<li><strong>Rollover</strong> requires adjusting for price gaps when switching contracts (ratio or difference method)</li>
<li><strong>Continuous contracts</strong> enable backtesting but require careful handling of roll adjustments</li>
</ul>
<hr />
<p><strong>Next: Module 3 - Leverage &amp; Margin</strong></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="3"><div class="md-cell module-header"><h1>Module 3: Leverage &amp; Margin</h1>
<h2>Part 1: Market Fundamentals</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:</p>
<ul>
<li>Understand how leverage works in forex and futures markets</li>
<li>Calculate margin requirements and leverage ratios</li>
<li>Implement proper position sizing with leverage</li>
<li>Manage margin calls and liquidation risk</li>
<li>Build risk management systems for leveraged trading</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Standard imports for this module</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="c1"># Display settings</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>3.1 Understanding Leverage</h2>
<p><strong>Leverage</strong> allows you to control a large position with a small amount of capital. It's a double-edged sword that amplifies both gains and losses.</p>
<h3>Leverage Formula</h3>
<div class="highlight"><pre><span></span><code>Leverage Ratio = Position Value / Margin Required

Example: 50:1 leverage
- Position Value: $100,000
- Margin Required: $2,000 (2%)
- Leverage: 100,000 / 2,000 = 50:1
</code></pre></div>

<h3>Leverage by Market</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Market</th>
<th>Typical Leverage</th>
<th>Margin %</th>
</tr>
</thead>
<tbody>
<tr>
<td>Forex (Retail)</td>
<td>50:1 to 500:1</td>
<td>0.2% - 2%</td>
</tr>
<tr>
<td>Forex (US Regulated)</td>
<td>50:1 max</td>
<td>2%</td>
</tr>
<tr>
<td>Futures</td>
<td>10:1 to 20:1</td>
<td>5% - 10%</td>
</tr>
<tr>
<td>Stocks (US)</td>
<td>2:1 to 4:1</td>
<td>25% - 50%</td>
</tr>
<tr>
<td>Crypto</td>
<td>2:1 to 125:1</td>
<td>0.8% - 50%</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">LeverageCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculator for leverage and margin.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        leverage_ratio: The leverage ratio (e.g., 50 for 50:1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">leverage_ratio</span><span class="p">:</span> <span class="nb">float</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">margin_percent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate margin percentage.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage_ratio</span>
    
    <span class="k">def</span> <span class="nf">margin_required</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate required margin for a position.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">position_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage_ratio</span>
    
    <span class="k">def</span> <span class="nf">max_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">available_margin</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate maximum position size given margin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">available_margin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage_ratio</span>
    
    <span class="k">def</span> <span class="nf">leveraged_return</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">price_change_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">account_pct_at_risk</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate leveraged return on account.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            price_change_pct: Underlying price change percentage</span>
<span class="sd">            account_pct_at_risk: Percentage of account used as margin</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Account return percentage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">position_return</span> <span class="o">=</span> <span class="n">price_change_pct</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage_ratio</span>
        <span class="k">return</span> <span class="n">position_return</span> <span class="o">*</span> <span class="p">(</span><span class="n">account_pct_at_risk</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">price_move_to_wipeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate adverse price move needed to lose all margin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage_ratio</span>


<span class="c1"># Compare leverage levels</span>
<span class="n">leverage_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Leverage Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Leverage&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Margin %&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;$100k Position&#39;</span><span class="si">:</span><span class="s2">&lt;18</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Wipeout Move&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="k">for</span> <span class="n">lev</span> <span class="ow">in</span> <span class="n">leverage_levels</span><span class="p">:</span>
    <span class="n">calc</span> <span class="o">=</span> <span class="n">LeverageCalculator</span><span class="p">(</span><span class="n">lev</span><span class="p">)</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">margin_required</span><span class="p">(</span><span class="mi">100_000</span><span class="p">)</span>
    <span class="n">wipeout</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">price_move_to_wipeout</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lev</span><span class="si">}</span><span class="s2">:1</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">calc</span><span class="o">.</span><span class="n">margin_percent</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">margin</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}{</span><span class="s1">&#39;&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">wipeout</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Visualize leverage impact</span>
<span class="k">def</span> <span class="nf">plot_leverage_impact</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Visualize how leverage amplifies returns.&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="c1"># Price changes from -5% to +5%</span>
    <span class="n">price_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">leverage_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
    
    <span class="c1"># Left plot: Returns at different leverage</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">lev</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">leverage_levels</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="n">LeverageCalculator</span><span class="p">(</span><span class="n">lev</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc</span><span class="o">.</span><span class="n">leveraged_return</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span> <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">price_changes</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">price_changes</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lev</span><span class="si">}</span><span class="s1">:1&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Margin Call&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Price Change (%)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Account Return (%)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Leverage Impact on Returns&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Right plot: Margin call threshold</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">leverage_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">201</span><span class="p">)</span>
    <span class="n">wipeout_moves</span> <span class="o">=</span> <span class="p">[</span><span class="n">LeverageCalculator</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">price_move_to_wipeout</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">leverage_range</span><span class="p">]</span>
    
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">leverage_range</span><span class="p">,</span> <span class="n">wipeout_moves</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">leverage_range</span><span class="p">,</span> <span class="n">wipeout_moves</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    
    <span class="c1"># Add annotations for common leverage levels</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">lev</span><span class="p">,</span> <span class="n">move</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lev</span><span class="si">}</span><span class="s1">:1 = </span><span class="si">{</span><span class="n">move</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">lev</span><span class="p">,</span> <span class="n">move</span><span class="p">),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">lev</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">move</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">),</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
    
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Leverage Ratio&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Adverse Move to Lose All Margin (%)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Margin Call Threshold by Leverage&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plot_leverage_impact</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>3.2 Margin Requirements</h2>
<h3>Types of Margin</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Margin Type</th>
<th>Description</th>
<th>Typical Level</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Initial Margin</strong></td>
<td>Required to open a position</td>
<td>2% - 10%</td>
</tr>
<tr>
<td><strong>Maintenance Margin</strong></td>
<td>Required to keep position open</td>
<td>50% - 75% of initial</td>
</tr>
<tr>
<td><strong>Variation Margin</strong></td>
<td>Daily P&amp;L settlement (futures)</td>
<td>Based on price move</td>
</tr>
</tbody>
</table></div>
<h3>Margin Call Process</h3>
<div class="highlight"><pre><span></span><code>1. Account equity falls below maintenance margin
2. Broker issues margin call
3. Trader must:
   - Deposit additional funds, OR
   - Close positions to reduce exposure
4. If no action: Broker liquidates positions
</code></pre></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MarginAccount</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulates a margin trading account.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        balance: Initial cash balance</span>
<span class="sd">        initial_margin_pct: Initial margin requirement</span>
<span class="sd">        maintenance_margin_pct: Maintenance margin requirement</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">initial_margin_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">maintenance_margin_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_balance</span> <span class="o">=</span> <span class="n">balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="n">balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_margin_pct</span> <span class="o">=</span> <span class="n">initial_margin_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintenance_margin_pct</span> <span class="o">=</span> <span class="n">maintenance_margin_pct</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of open positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">leverage_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate effective leverage ratio.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_margin_pct</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_position_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total value of all positions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;current_value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unrealized_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate unrealized P&amp;L.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">equity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate account equity.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">unrealized_pnl</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">used_margin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate margin used by positions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;margin_used&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">free_margin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate available margin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_margin</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">margin_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate margin level percentage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_margin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_margin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">open_position</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a new position.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            symbol: Trading symbol</span>
<span class="sd">            direction: &#39;long&#39; or &#39;short&#39;</span>
<span class="sd">            size: Position size (units or lots)</span>
<span class="sd">            entry_price: Entry price</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Position details or error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">position_value</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">entry_price</span>
        <span class="n">margin_required</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_margin_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># Check if enough margin</span>
        <span class="k">if</span> <span class="n">margin_required</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_margin</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient margin&#39;</span><span class="p">}</span>
        
        <span class="n">position</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">position_value</span><span class="p">,</span>
            <span class="s1">&#39;margin_used&#39;</span><span class="p">:</span> <span class="n">margin_required</span><span class="p">,</span>
            <span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">position</span>
    
    <span class="k">def</span> <span class="nf">update_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update positions with new prices.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            prices: Dict of symbol -&gt; current price</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
                <span class="n">new_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]]</span>
                <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;current_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_price</span>
                <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;current_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">new_price</span>
                
                <span class="c1"># Calculate P&amp;L</span>
                <span class="n">price_change</span> <span class="o">=</span> <span class="n">new_price</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span>
                    <span class="n">price_change</span> <span class="o">=</span> <span class="o">-</span><span class="n">price_change</span>
                <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_change</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">check_margin_call</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if account is in margin call.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Margin call status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maintenance_required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_margin</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maintenance_margin_pct</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_margin_pct</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;LIQUIDATION&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Account equity depleted&#39;</span><span class="p">,</span>
                <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">&lt;</span> <span class="n">maintenance_required</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;MARGIN_CALL&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Below maintenance margin&#39;</span><span class="p">,</span>
                <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">,</span>
                <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="n">maintenance_required</span><span class="p">,</span>
                <span class="s1">&#39;shortfall&#39;</span><span class="p">:</span> <span class="n">maintenance_required</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span>
                <span class="s1">&#39;margin_level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_level</span>
            <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get account summary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;initial_balance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_balance</span><span class="p">,</span>
            <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unrealized_pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;used_margin&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_margin</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;free_margin&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">free_margin</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;margin_level&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margin_level</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_level</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
            <span class="s1">&#39;leverage&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">leverage_ratio</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">:1&quot;</span><span class="p">,</span>
            <span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
        <span class="p">}</span>


<span class="c1"># Demonstrate margin account</span>
<span class="n">account</span> <span class="o">=</span> <span class="n">MarginAccount</span><span class="p">(</span><span class="n">balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">initial_margin_pct</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">maintenance_margin_pct</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial Account State&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">account</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Open a position and track margin</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">open_position</span><span class="p">(</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">After Opening Position&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position: 100,000 EUR/USD at 1.0850&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position Value: $</span><span class="si">{</span><span class="mi">100000</span> <span class="o">*</span> <span class="mf">1.0850</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Margin Used: $</span><span class="si">{</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;margin_used&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Account:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">account</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Simulate price movement and margin call</span>
<span class="n">price_scenarios</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0850</span><span class="p">,</span> <span class="mf">1.0800</span><span class="p">,</span> <span class="mf">1.0750</span><span class="p">,</span> <span class="mf">1.0700</span><span class="p">,</span> <span class="mf">1.0650</span><span class="p">,</span> <span class="mf">1.0600</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Price Movement Scenarios&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Price&#39;</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;P&amp;L&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Equity&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Margin Level&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Status&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">price_scenarios</span><span class="p">:</span>
    <span class="n">account</span><span class="o">.</span><span class="n">update_prices</span><span class="p">({</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">})</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">check_margin_call</span><span class="p">()</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    
    <span class="n">pnl</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">]</span>
    <span class="n">equity</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span>
    <span class="n">margin_lvl</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;margin_level&#39;</span><span class="p">]</span>
    
    <span class="n">pnl_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">pnl</span><span class="si">:</span><span class="s2">+,.0f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">equity_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">equity</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">margin_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">margin_lvl</span><span class="si">}</span><span class="s2">%&quot;</span> <span class="k">if</span> <span class="n">margin_lvl</span> <span class="o">!=</span> <span class="s1">&#39;N/A&#39;</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pnl_str</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">equity_str</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">margin_str</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 3.1: Margin Calculator (Guided)</h2>
<p>Complete the function to calculate margin requirements for different instruments.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 3.1: Margin Calculator (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_margin_requirements</span><span class="p">(</span>
    <span class="n">instrument_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">position_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate margin requirements for different instruments.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        instrument_type: &#39;forex&#39;, &#39;futures&#39;, &#39;stocks&#39;</span>
<span class="sd">        position_value: Total position value</span>
<span class="sd">        leverage: Override default leverage</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Margin calculation details</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Default leverage by instrument type</span>
    <span class="n">default_leverage</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;forex&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="s1">&#39;futures&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s1">&#39;stocks&#39;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">}</span>
    
    <span class="c1"># Get leverage (use default if not specified)</span>
    <span class="k">if</span> <span class="n">leverage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">leverage</span> <span class="o">=</span> <span class="n">default_leverage</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">instrument_type</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Get with default</span>
    
    <span class="c1"># Calculate margin percentage</span>
    <span class="n">margin_pct</span> <span class="o">=</span> <span class="n">______</span> <span class="o">/</span> <span class="n">leverage</span>  <span class="c1"># 100 divided by leverage</span>
    
    <span class="c1"># Calculate initial margin</span>
    <span class="n">initial_margin</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">margin_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    
    <span class="c1"># Maintenance margin (typically 50% of initial for forex)</span>
    <span class="n">maintenance_margin</span> <span class="o">=</span> <span class="n">initial_margin</span> <span class="o">*</span> <span class="n">______</span>  <span class="c1"># 50% = 0.5</span>
    
    <span class="c1"># Calculate max position from margin</span>
    <span class="n">max_position_from_margin</span> <span class="o">=</span> <span class="n">initial_margin</span> <span class="o">*</span> <span class="n">leverage</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="n">instrument_type</span><span class="p">,</span>
        <span class="s1">&#39;position_value&#39;</span><span class="p">:</span> <span class="n">position_value</span><span class="p">,</span>
        <span class="s1">&#39;leverage&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leverage</span><span class="si">}</span><span class="s2">:1&quot;</span><span class="p">,</span>
        <span class="s1">&#39;margin_pct&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">margin_pct</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
        <span class="s1">&#39;initial_margin&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">initial_margin</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;maintenance_margin&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">maintenance_margin</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;max_adverse_move&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">100</span><span class="o">/</span><span class="n">leverage</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="p">}</span>

<span class="c1"># Test with different instruments</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Margin Requirements for $100,000 Position&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;forex&#39;</span><span class="p">,</span> <span class="s1">&#39;futures&#39;</span><span class="p">,</span> <span class="s1">&#39;stocks&#39;</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_margin_requirements</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">inst</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;instrument&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_margin_requirements</span><span class="p">(</span>
    <span class="n">instrument_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">position_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate margin requirements for different instruments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Default leverage by instrument type</span>
    <span class="n">default_leverage</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;forex&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="s1">&#39;futures&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s1">&#39;stocks&#39;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">}</span>

    <span class="c1"># Get leverage (use default if not specified)</span>
    <span class="k">if</span> <span class="n">leverage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">leverage</span> <span class="o">=</span> <span class="n">default_leverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instrument_type</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Get with default</span>

    <span class="c1"># Calculate margin percentage</span>
    <span class="n">margin_pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">leverage</span>  <span class="c1"># 100 divided by leverage</span>

    <span class="c1"># Calculate initial margin</span>
    <span class="n">initial_margin</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">margin_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Maintenance margin (typically 50% of initial for forex)</span>
    <span class="n">maintenance_margin</span> <span class="o">=</span> <span class="n">initial_margin</span> <span class="o">*</span> <span class="mf">0.5</span>  <span class="c1"># 50% = 0.5</span>

    <span class="c1"># Calculate max position from margin</span>
    <span class="n">max_position_from_margin</span> <span class="o">=</span> <span class="n">initial_margin</span> <span class="o">*</span> <span class="n">leverage</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="n">instrument_type</span><span class="p">,</span>
        <span class="s1">&#39;position_value&#39;</span><span class="p">:</span> <span class="n">position_value</span><span class="p">,</span>
        <span class="s1">&#39;leverage&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leverage</span><span class="si">}</span><span class="s2">:1&quot;</span><span class="p">,</span>
        <span class="s1">&#39;margin_pct&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">margin_pct</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
        <span class="s1">&#39;initial_margin&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">initial_margin</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;maintenance_margin&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">maintenance_margin</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;max_adverse_move&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">100</span><span class="o">/</span><span class="n">leverage</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>3.3 Position Sizing with Leverage</h2>
<h3>The Risk Equation</h3>
<div class="highlight"><pre><span></span><code>Risk Amount = Account Balance Ã— Risk Percentage
Position Size = Risk Amount / (Stop Loss in Pips Ã— Pip Value)
</code></pre></div>

<h3>Professional Position Sizing Rules</h3>
<ol>
<li><strong>Risk per trade</strong>: 1-2% of account</li>
<li><strong>Never risk more than you can afford to lose</strong></li>
<li><strong>Account for correlation</strong> when holding multiple positions</li>
<li><strong>Leave margin buffer</strong> for adverse moves</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">LeveragedPositionSizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate position sizes accounting for leverage.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        account_balance: Trading account balance</span>
<span class="sd">        leverage: Available leverage ratio</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">=</span> <span class="n">account_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">leverage</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_position_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Maximum position value based on leverage.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
    
    <span class="k">def</span> <span class="nf">size_by_risk</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">stop_loss_pips</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">pip_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate position size based on risk.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            risk_pct: Percentage of account to risk</span>
<span class="sd">            stop_loss_pips: Stop loss distance in pips</span>
<span class="sd">            pip_value: Dollar value per pip per lot</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Position sizing details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate risk amount in dollars</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># Calculate position size in lots</span>
        <span class="c1"># Risk per lot = stop_loss_pips * pip_value</span>
        <span class="n">risk_per_lot</span> <span class="o">=</span> <span class="n">stop_loss_pips</span> <span class="o">*</span> <span class="n">pip_value</span>
        <span class="n">lots</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">risk_per_lot</span>
        
        <span class="c1"># Calculate position value</span>
        <span class="n">position_value</span> <span class="o">=</span> <span class="n">lots</span> <span class="o">*</span> <span class="mi">100_000</span>  <span class="c1"># Standard lot = 100,000 units</span>
        
        <span class="c1"># Check if within leverage limits</span>
        <span class="n">margin_required</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
        <span class="n">within_limits</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_position_value</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="n">risk_pct</span><span class="p">,</span>
            <span class="s1">&#39;risk_amount&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">risk_amount</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;stop_loss_pips&#39;</span><span class="p">:</span> <span class="n">stop_loss_pips</span><span class="p">,</span>
            <span class="s1">&#39;lots&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">lots</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">lots</span> <span class="o">*</span> <span class="mi">100_000</span><span class="p">),</span>
            <span class="s1">&#39;position_value&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">position_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;margin_required&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">margin_required</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;margin_pct_of_account&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">margin_required</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;within_limits&#39;</span><span class="p">:</span> <span class="n">within_limits</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">size_by_margin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">margin_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate position size based on margin usage.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            margin_pct: Percentage of account to use as margin</span>
<span class="sd">            current_price: Current price for the instrument</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Position sizing details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">margin_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">margin_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">position_value</span> <span class="o">=</span> <span class="n">margin_used</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="n">current_price</span>
        <span class="n">lots</span> <span class="o">=</span> <span class="n">units</span> <span class="o">/</span> <span class="mi">100_000</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;margin_pct&#39;</span><span class="p">:</span> <span class="n">margin_pct</span><span class="p">,</span>
            <span class="s1">&#39;margin_used&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">margin_used</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;position_value&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">position_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">units</span><span class="p">),</span>
            <span class="s1">&#39;lots&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">lots</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;remaining_margin&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">-</span> <span class="n">margin_used</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>


<span class="c1"># Example position sizing</span>
<span class="n">sizer</span> <span class="o">=</span> <span class="n">LeveragedPositionSizer</span><span class="p">(</span><span class="n">account_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Position Sizing Examples&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Account: $</span><span class="si">{</span><span class="n">sizer</span><span class="o">.</span><span class="n">account_balance</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> | Leverage: </span><span class="si">{</span><span class="n">sizer</span><span class="o">.</span><span class="n">leverage</span><span class="si">}</span><span class="s2">:1&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Position Value: $</span><span class="si">{</span><span class="n">sizer</span><span class="o">.</span><span class="n">max_position_value</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Size by risk</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Size by Risk ---&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">risk</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sizer</span><span class="o">.</span><span class="n">size_by_risk</span><span class="p">(</span><span class="n">risk_pct</span><span class="o">=</span><span class="n">risk</span><span class="p">,</span> <span class="n">stop_loss_pips</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">risk</span><span class="si">}</span><span class="s2">% Risk, 50 pip stop:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Risk Amount: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;risk_amount&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Position: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;lots&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> lots (</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> units)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Margin Required: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;margin_required&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;margin_pct_of_account&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">% of account)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 3.2: Leveraged Position Sizing (Guided)</h2>
<p>Complete the function to calculate optimal position size considering both risk and margin.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 3.2: Leveraged Position Sizing (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_safe_position</span><span class="p">(</span>
    <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">stop_loss_pips</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">max_margin_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
    <span class="n">pip_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate safe position size considering both risk and margin limits.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        account_balance: Account balance</span>
<span class="sd">        leverage: Available leverage</span>
<span class="sd">        risk_pct: Risk percentage per trade</span>
<span class="sd">        stop_loss_pips: Stop loss in pips</span>
<span class="sd">        max_margin_pct: Maximum margin to use</span>
<span class="sd">        pip_value: Value per pip per lot</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Safe position sizing details</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate position by risk</span>
    <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">risk_per_lot</span> <span class="o">=</span> <span class="n">stop_loss_pips</span> <span class="o">*</span> <span class="n">pip_value</span>
    <span class="n">lots_by_risk</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">______</span>  <span class="c1"># Divide by risk per lot</span>
    
    <span class="c1"># Calculate position by margin limit</span>
    <span class="n">max_margin</span> <span class="o">=</span> <span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_margin_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">max_position_value</span> <span class="o">=</span> <span class="n">max_margin</span> <span class="o">*</span> <span class="n">______</span>  <span class="c1"># Multiply by leverage</span>
    <span class="n">lots_by_margin</span> <span class="o">=</span> <span class="n">max_position_value</span> <span class="o">/</span> <span class="mi">100_000</span>  <span class="c1"># Convert to lots</span>
    
    <span class="c1"># Use the smaller of the two</span>
    <span class="n">final_lots</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">lots_by_risk</span><span class="p">,</span> <span class="n">lots_by_margin</span><span class="p">)</span>  <span class="c1"># Take minimum</span>
    <span class="n">limiting_factor</span> <span class="o">=</span> <span class="s1">&#39;risk&#39;</span> <span class="k">if</span> <span class="n">lots_by_risk</span> <span class="o">&lt;</span> <span class="n">lots_by_margin</span> <span class="k">else</span> <span class="s1">&#39;margin&#39;</span>
    
    <span class="c1"># Calculate final metrics</span>
    <span class="n">position_value</span> <span class="o">=</span> <span class="n">final_lots</span> <span class="o">*</span> <span class="mi">100_000</span>
    <span class="n">actual_margin</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="n">leverage</span>
    <span class="n">actual_risk</span> <span class="o">=</span> <span class="n">final_lots</span> <span class="o">*</span> <span class="n">risk_per_lot</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;lots_by_risk&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">lots_by_risk</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;lots_by_margin&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">lots_by_margin</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;final_lots&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">final_lots</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;limiting_factor&#39;</span><span class="p">:</span> <span class="n">limiting_factor</span><span class="p">,</span>
        <span class="s1">&#39;position_value&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">position_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;margin_used&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">actual_margin</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;margin_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">actual_margin</span> <span class="o">/</span> <span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;actual_risk&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">actual_risk</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;actual_risk_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">actual_risk</span> <span class="o">/</span> <span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test the function</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_safe_position</span><span class="p">(</span>
    <span class="n">account_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">risk_pct</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">stop_loss_pips</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">max_margin_pct</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Safe Position Calculation&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_safe_position</span><span class="p">(</span>
    <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">stop_loss_pips</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">max_margin_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
    <span class="n">pip_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate safe position size considering both risk and margin limits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate position by risk</span>
    <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">risk_per_lot</span> <span class="o">=</span> <span class="n">stop_loss_pips</span> <span class="o">*</span> <span class="n">pip_value</span>
    <span class="n">lots_by_risk</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">risk_per_lot</span>  <span class="c1"># Divide by risk per lot</span>

    <span class="c1"># Calculate position by margin limit</span>
    <span class="n">max_margin</span> <span class="o">=</span> <span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_margin_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">max_position_value</span> <span class="o">=</span> <span class="n">max_margin</span> <span class="o">*</span> <span class="n">leverage</span>  <span class="c1"># Multiply by leverage</span>
    <span class="n">lots_by_margin</span> <span class="o">=</span> <span class="n">max_position_value</span> <span class="o">/</span> <span class="mi">100_000</span>  <span class="c1"># Convert to lots</span>

    <span class="c1"># Use the smaller of the two</span>
    <span class="n">final_lots</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lots_by_risk</span><span class="p">,</span> <span class="n">lots_by_margin</span><span class="p">)</span>  <span class="c1"># Take minimum</span>
    <span class="n">limiting_factor</span> <span class="o">=</span> <span class="s1">&#39;risk&#39;</span> <span class="k">if</span> <span class="n">lots_by_risk</span> <span class="o">&lt;</span> <span class="n">lots_by_margin</span> <span class="k">else</span> <span class="s1">&#39;margin&#39;</span>

    <span class="c1"># Calculate final metrics</span>
    <span class="n">position_value</span> <span class="o">=</span> <span class="n">final_lots</span> <span class="o">*</span> <span class="mi">100_000</span>
    <span class="n">actual_margin</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="n">leverage</span>
    <span class="n">actual_risk</span> <span class="o">=</span> <span class="n">final_lots</span> <span class="o">*</span> <span class="n">risk_per_lot</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;lots_by_risk&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">lots_by_risk</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;lots_by_margin&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">lots_by_margin</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;final_lots&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">final_lots</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;limiting_factor&#39;</span><span class="p">:</span> <span class="n">limiting_factor</span><span class="p">,</span>
        <span class="s1">&#39;position_value&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">position_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;margin_used&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">actual_margin</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;margin_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">actual_margin</span> <span class="o">/</span> <span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="s1">&#39;actual_risk&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">actual_risk</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;actual_risk_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">actual_risk</span> <span class="o">/</span> <span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>3.4 Leverage Risk Management</h2>
<h3>Why Most Traders Lose with Leverage</h3>
<ol>
<li><strong>Over-leveraging</strong>: Using too much of available leverage</li>
<li><strong>No stop losses</strong>: Letting losses run</li>
<li><strong>Ignoring volatility</strong>: Same leverage in all market conditions</li>
<li><strong>Correlation blindness</strong>: Multiple correlated positions multiply risk</li>
</ol>
<h3>Professional Approaches</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Approach</th>
<th>Description</th>
<th>Typical Leverage Used</th>
</tr>
</thead>
<tbody>
<tr>
<td>Conservative</td>
<td>Long-term, low stress</td>
<td>2:1 - 5:1</td>
</tr>
<tr>
<td>Moderate</td>
<td>Balanced risk/reward</td>
<td>5:1 - 15:1</td>
</tr>
<tr>
<td>Aggressive</td>
<td>Active trading</td>
<td>15:1 - 30:1</td>
</tr>
<tr>
<td>Extreme (Not Recommended)</td>
<td>Day trading</td>
<td>30:1+</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">RiskScenarioAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze risk scenarios for leveraged positions.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        account_balance: Starting balance</span>
<span class="sd">        leverage: Leverage ratio</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">=</span> <span class="n">account_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">leverage</span>
    
    <span class="k">def</span> <span class="nf">simulate_price_path</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">position_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">daily_volatility</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate equity paths with leverage.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            position_pct: Percentage of max leverage used</span>
<span class="sd">            daily_volatility: Daily price volatility (e.g., 0.01 = 1%)</span>
<span class="sd">            days: Number of days to simulate</span>
<span class="sd">            simulations: Number of simulation paths</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with simulation results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate effective leverage used</span>
        <span class="n">effective_leverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">*</span> <span class="p">(</span><span class="n">position_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># Generate random returns</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">daily_volatility</span><span class="p">,</span> <span class="p">(</span><span class="n">simulations</span><span class="p">,</span> <span class="n">days</span><span class="p">))</span>
        
        <span class="c1"># Apply leverage to returns</span>
        <span class="n">leveraged_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">*</span> <span class="n">effective_leverage</span>
        
        <span class="c1"># Calculate equity paths</span>
        <span class="n">equity_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">leveraged_returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Identify blown accounts (equity &lt;= 0)</span>
        <span class="n">blown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">equity_paths</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;final_equities&#39;</span><span class="p">:</span> <span class="n">equity_paths</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;max_drawdowns&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_drawdowns</span><span class="p">(</span><span class="n">equity_paths</span><span class="p">),</span>
            <span class="s1">&#39;blown_accounts&#39;</span><span class="p">:</span> <span class="n">blown</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="s1">&#39;blow_up_rate&#39;</span><span class="p">:</span> <span class="n">blown</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;mean_final&#39;</span><span class="p">:</span> <span class="n">equity_paths</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;median_final&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">equity_paths</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s1">&#39;percentile_5&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">equity_paths</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s1">&#39;percentile_95&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">equity_paths</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">95</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_calculate_drawdowns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equity_paths</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate maximum drawdown for each path.&quot;&quot;&quot;</span>
        <span class="n">running_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">equity_paths</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">drawdowns</span> <span class="o">=</span> <span class="p">(</span><span class="n">running_max</span> <span class="o">-</span> <span class="n">equity_paths</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">drawdowns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">compare_leverage_levels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">position_pcts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">daily_volatility</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare outcomes at different leverage levels.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            position_pcts: List of position percentages to test</span>
<span class="sd">            daily_volatility: Daily volatility</span>
<span class="sd">            days: Simulation period</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Comparison DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pct</span> <span class="ow">in</span> <span class="n">position_pcts</span><span class="p">:</span>
            <span class="n">sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_price_path</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span> <span class="n">daily_volatility</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
            <span class="n">effective_lev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">*</span> <span class="p">(</span><span class="n">pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Position %&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pct</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Effective Leverage&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">effective_lev</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">:1&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Blow-up Rate&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;blow_up_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Mean Final&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;mean_final&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Median Final&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;median_final&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;5th Percentile&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;percentile_5&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Max DD (avg)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;max_drawdowns&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>


<span class="c1"># Analyze different leverage scenarios</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">RiskScenarioAnalyzer</span><span class="p">(</span><span class="n">account_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Leverage Risk Comparison (1 Year, 1% Daily Volatility)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">90</span><span class="p">)</span>
<span class="n">comparison</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">compare_leverage_levels</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Visualize risk scenarios</span>
<span class="k">def</span> <span class="nf">plot_leverage_risk</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Visualize the relationship between leverage and risk.&quot;&quot;&quot;</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">RiskScenarioAnalyzer</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
    
    <span class="n">position_pcts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="n">blow_up_rates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">median_returns</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">pct</span> <span class="ow">in</span> <span class="n">position_pcts</span><span class="p">:</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">simulate_price_path</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
        <span class="n">blow_up_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;blow_up_rate&#39;</span><span class="p">])</span>
        <span class="n">median_returns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;median_final&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="c1"># Blow-up rate vs leverage</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">effective_leverage</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span> <span class="o">*</span> <span class="n">p</span> <span class="o">/</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">position_pcts</span><span class="p">]</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">position_pcts</span><span class="p">)),</span> <span class="n">blow_up_rates</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">position_pcts</span><span class="p">)))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">:1&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">effective_leverage</span><span class="p">])</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Effective Leverage&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Account Blow-up Rate (%)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Probability of Losing Everything (1 Year)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Add danger zone annotation</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;10% threshold&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="c1"># Risk-return tradeoff</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">median_returns</span><span class="p">]</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">position_pcts</span><span class="p">)),</span> <span class="n">median_returns</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">position_pcts</span><span class="p">)))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">:1&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">effective_leverage</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Effective Leverage&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Median Annual Return (%)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Median Return vs Leverage&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plot_leverage_risk</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 3.3: Risk Scenarios (Guided)</h2>
<p>Complete the function to analyze drawdown scenarios with leverage.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 3.3: Risk Scenarios (Guided)</span>
<span class="k">def</span> <span class="nf">analyze_drawdown_recovery</span><span class="p">(</span>
    <span class="n">initial_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">drawdown_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">daily_return</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze drawdown impact and recovery time with leverage.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        initial_balance: Starting account balance</span>
<span class="sd">        leverage: Leverage being used</span>
<span class="sd">        drawdown_pct: Percentage drawdown (e.g., 20 for 20%)</span>
<span class="sd">        daily_return: Expected daily return for recovery</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Drawdown analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate balance after drawdown</span>
    <span class="n">balance_after</span> <span class="o">=</span> <span class="n">initial_balance</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">drawdown_pct</span> <span class="o">/</span> <span class="n">______</span><span class="p">)</span>  <span class="c1"># Convert pct to decimal</span>
    
    <span class="c1"># Calculate loss amount</span>
    <span class="n">loss_amount</span> <span class="o">=</span> <span class="n">initial_balance</span> <span class="o">-</span> <span class="n">balance_after</span>
    
    <span class="c1"># Calculate required return to recover</span>
    <span class="c1"># If you lose X%, you need to gain X/(100-X) * 100% to recover</span>
    <span class="n">required_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_balance</span> <span class="o">/</span> <span class="n">balance_after</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">______</span>  <span class="c1"># Convert to percentage</span>
    
    <span class="c1"># Calculate price move that caused this (accounting for leverage)</span>
    <span class="n">price_move</span> <span class="o">=</span> <span class="n">drawdown_pct</span> <span class="o">/</span> <span class="n">______</span>  <span class="c1"># Divide by leverage</span>
    
    <span class="c1"># Estimate recovery days (simplified)</span>
    <span class="n">leveraged_daily_return</span> <span class="o">=</span> <span class="n">daily_return</span> <span class="o">*</span> <span class="n">leverage</span>
    <span class="k">if</span> <span class="n">leveraged_daily_return</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Days = ln(target/current) / ln(1 + daily_return)</span>
        <span class="n">recovery_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">initial_balance</span> <span class="o">/</span> <span class="n">balance_after</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">leveraged_daily_return</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">recovery_days</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;initial_balance&#39;</span><span class="p">:</span> <span class="n">initial_balance</span><span class="p">,</span>
        <span class="s1">&#39;drawdown_pct&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">drawdown_pct</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
        <span class="s1">&#39;balance_after&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">balance_after</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;loss_amount&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">loss_amount</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;price_move_caused&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">price_move</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
        <span class="s1">&#39;required_return_to_recover&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">required_return</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
        <span class="s1">&#39;estimated_recovery_days&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">recovery_days</span><span class="p">)</span> <span class="k">if</span> <span class="n">recovery_days</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
    <span class="p">}</span>

<span class="c1"># Test with different scenarios</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Drawdown Recovery Analysis (50:1 Leverage)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">analyze_drawdown_recovery</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">dd</span><span class="si">}</span><span class="s2">% Drawdown:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Balance After: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;balance_after&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Price Move: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;price_move_caused&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Required Return: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;required_return_to_recover&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Recovery Days: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;estimated_recovery_days&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_drawdown_recovery</span><span class="p">(</span>
    <span class="n">initial_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">drawdown_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">daily_return</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze drawdown impact and recovery time with leverage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate balance after drawdown</span>
    <span class="n">balance_after</span> <span class="o">=</span> <span class="n">initial_balance</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">drawdown_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Convert pct to decimal</span>

    <span class="c1"># Calculate loss amount</span>
    <span class="n">loss_amount</span> <span class="o">=</span> <span class="n">initial_balance</span> <span class="o">-</span> <span class="n">balance_after</span>

    <span class="c1"># Calculate required return to recover</span>
    <span class="n">required_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_balance</span> <span class="o">/</span> <span class="n">balance_after</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Convert to percentage</span>

    <span class="c1"># Calculate price move that caused this (accounting for leverage)</span>
    <span class="n">price_move</span> <span class="o">=</span> <span class="n">drawdown_pct</span> <span class="o">/</span> <span class="n">leverage</span>  <span class="c1"># Divide by leverage</span>

    <span class="c1"># Estimate recovery days (simplified)</span>
    <span class="n">leveraged_daily_return</span> <span class="o">=</span> <span class="n">daily_return</span> <span class="o">*</span> <span class="n">leverage</span>
    <span class="k">if</span> <span class="n">leveraged_daily_return</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">recovery_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">initial_balance</span> <span class="o">/</span> <span class="n">balance_after</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">leveraged_daily_return</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">recovery_days</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;initial_balance&#39;</span><span class="p">:</span> <span class="n">initial_balance</span><span class="p">,</span>
        <span class="s1">&#39;drawdown_pct&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">drawdown_pct</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
        <span class="s1">&#39;balance_after&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">balance_after</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;loss_amount&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">loss_amount</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;price_move_caused&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">price_move</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
        <span class="s1">&#39;required_return_to_recover&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">required_return</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
        <span class="s1">&#39;estimated_recovery_days&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">recovery_days</span><span class="p">)</span> <span class="k">if</span> <span class="n">recovery_days</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 3.4: Margin Account Simulator (Open-ended)</h2>
<p>Build a margin account simulator that tracks positions, margin, and handles margin calls.</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 3.4: Margin Account Simulator (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a MarginAccountSimulator class that:</span>
<span class="c1"># - Tracks multiple positions with their margin requirements</span>
<span class="c1"># - Updates equity based on price changes</span>
<span class="c1"># - Monitors margin levels and triggers margin calls</span>
<span class="c1"># - Handles position liquidation when necessary</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - open_position(symbol: str, direction: str, size: float, price: float) -&gt; dict</span>
<span class="c1"># - close_position(position_id: int, price: float) -&gt; dict</span>
<span class="c1"># - update_prices(prices: Dict[str, float])</span>
<span class="c1"># - check_margin_status() -&gt; dict</span>
<span class="c1"># - liquidate_if_needed() -&gt; List[dict]</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MarginAccountSimulator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Full margin account simulator with liquidation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">maintenance_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_balance</span> <span class="o">=</span> <span class="n">balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="n">balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_margin_pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintenance_pct</span> <span class="o">=</span> <span class="n">maintenance_pct</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unrealized_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">equity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">unrealized_pnl</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">used_margin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;margin&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">margin_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_margin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_margin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">def</span> <span class="nf">open_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">position_value</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">price</span>
        <span class="n">margin_required</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_margin_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">margin_required</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_margin</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient margin&#39;</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">position_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_counter</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;margin&#39;</span><span class="p">:</span> <span class="n">margin_required</span><span class="p">,</span>
            <span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">position_counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">position</span>
        <span class="k">return</span> <span class="n">position</span>

    <span class="k">def</span> <span class="nf">close_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">position_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Position not found&#39;</span><span class="p">}</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">position_id</span><span class="p">]</span>
        <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;current_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>

        <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="o">-</span><span class="n">pnl</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+=</span> <span class="n">pnl</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">position_id</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;position_id&#39;</span><span class="p">:</span> <span class="n">position_id</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
            <span class="s1">&#39;realized_pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;realized_pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">update_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
                <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;current_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]]</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;current_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span>
                    <span class="n">pnl</span> <span class="o">=</span> <span class="o">-</span><span class="n">pnl</span>
                <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnl</span>

    <span class="k">def</span> <span class="nf">check_margin_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">margin_call_level</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># 100% margin level = margin call</span>
        <span class="n">liquidation_level</span> <span class="o">=</span> <span class="mi">50</span>   <span class="c1"># 50% margin level = liquidation</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_level</span> <span class="o">&lt;=</span> <span class="n">liquidation_level</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;LIQUIDATION&#39;</span><span class="p">,</span> <span class="s1">&#39;margin_level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_level</span><span class="p">}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_level</span> <span class="o">&lt;=</span> <span class="n">margin_call_level</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;MARGIN_CALL&#39;</span><span class="p">,</span> <span class="s1">&#39;margin_level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_level</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="s1">&#39;margin_level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_level</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">liquidate_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_margin_status</span><span class="p">()</span>
        <span class="n">liquidated</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LIQUIDATION&#39;</span><span class="p">:</span>
            <span class="c1"># Close all positions</span>
            <span class="k">for</span> <span class="n">pos_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">pos_id</span><span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_position</span><span class="p">(</span><span class="n">pos_id</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;current_price&#39;</span><span class="p">])</span>
                <span class="n">liquidated</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;position_id&#39;</span><span class="p">:</span> <span class="n">pos_id</span><span class="p">,</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;realized_pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">liquidated</span>


<span class="c1"># Test the simulator</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">MarginAccountSimulator</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">sim</span><span class="o">.</span><span class="n">open_position</span><span class="p">(</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">)</span>

<span class="c1"># Simulate price drop</span>
<span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1.0850</span><span class="p">,</span> <span class="mf">1.0800</span><span class="p">,</span> <span class="mf">1.0750</span><span class="p">,</span> <span class="mf">1.0700</span><span class="p">]:</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">update_prices</span><span class="p">({</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">})</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">check_margin_status</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Price: </span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2"> | Equity: $</span><span class="si">{</span><span class="n">sim</span><span class="o">.</span><span class="n">equity</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2"> | &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Margin Level: </span><span class="si">{</span><span class="n">sim</span><span class="o">.</span><span class="n">margin_level</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% | Status: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">liq</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">liquidate_if_needed</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">liq</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  LIQUIDATED: </span><span class="si">{</span><span class="n">liq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">break</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 3.5: Portfolio Leverage Manager (Open-ended)</h2>
<p>Build a portfolio leverage manager that tracks total exposure across multiple positions.</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 3.5: Portfolio Leverage Manager (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a PortfolioLeverageManager class that:</span>
<span class="c1"># - Tracks leverage across multiple positions</span>
<span class="c1"># - Considers correlation between positions</span>
<span class="c1"># - Calculates portfolio-level margin requirements</span>
<span class="c1"># - Provides recommendations on position sizing</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - add_position(symbol: str, value: float, correlation_group: str)</span>
<span class="c1"># - get_total_leverage() -&gt; float</span>
<span class="c1"># - get_correlated_exposure(group: str) -&gt; float</span>
<span class="c1"># - recommend_new_position(symbol: str, desired_value: float) -&gt; dict</span>
<span class="c1"># - risk_report() -&gt; pd.DataFrame</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PortfolioLeverageManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manage leverage across a portfolio of positions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">max_total_leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">max_correlated_leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">=</span> <span class="n">account_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_total_leverage</span> <span class="o">=</span> <span class="n">max_total_leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_correlated_leverage</span> <span class="o">=</span> <span class="n">max_correlated_leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">correlation_group</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;correlation_group&#39;</span><span class="p">:</span> <span class="n">correlation_group</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">get_total_leverage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">total_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span>

    <span class="k">def</span> <span class="nf">get_correlated_exposure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">group_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;correlation_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">group_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span>

    <span class="k">def</span> <span class="nf">recommend_new_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">desired_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">current_leverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_leverage</span><span class="p">()</span>
        <span class="n">new_leverage</span> <span class="o">=</span> <span class="n">current_leverage</span> <span class="o">+</span> <span class="p">(</span><span class="n">desired_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span>

        <span class="n">current_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_correlated_exposure</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">new_group</span> <span class="o">=</span> <span class="n">current_group</span> <span class="o">+</span> <span class="p">(</span><span class="n">desired_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span>

        <span class="c1"># Check limits</span>
        <span class="n">total_ok</span> <span class="o">=</span> <span class="n">new_leverage</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_total_leverage</span>
        <span class="n">group_ok</span> <span class="o">=</span> <span class="n">new_group</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_correlated_leverage</span>

        <span class="k">if</span> <span class="n">total_ok</span> <span class="ow">and</span> <span class="n">group_ok</span><span class="p">:</span>
            <span class="n">recommendation</span> <span class="o">=</span> <span class="s1">&#39;APPROVED&#39;</span>
            <span class="n">suggested_value</span> <span class="o">=</span> <span class="n">desired_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recommendation</span> <span class="o">=</span> <span class="s1">&#39;REDUCE&#39;</span>
            <span class="c1"># Calculate max allowed</span>
            <span class="n">max_by_total</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_total_leverage</span> <span class="o">-</span> <span class="n">current_leverage</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span>
            <span class="n">max_by_group</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_correlated_leverage</span> <span class="o">-</span> <span class="n">current_group</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span>
            <span class="n">suggested_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_by_total</span><span class="p">,</span> <span class="n">max_by_group</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;requested&#39;</span><span class="p">:</span> <span class="n">desired_value</span><span class="p">,</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="n">recommendation</span><span class="p">,</span>
            <span class="s1">&#39;suggested_value&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">suggested_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;new_total_leverage&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">new_leverage</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;new_group_leverage&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">new_group</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">risk_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;correlation_group&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;correlation_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
            <span class="n">group_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">group_positions</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span>
                <span class="s1">&#39;Positions&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_positions</span><span class="p">),</span>
                <span class="s1">&#39;Total Value&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">group_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Leverage&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_value</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Status&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span> <span class="k">if</span> <span class="n">group_value</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_correlated_leverage</span> <span class="k">else</span> <span class="s1">&#39;WARNING&#39;</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>


<span class="c1"># Test</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">PortfolioLeverageManager</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">max_total_leverage</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_correlated_leverage</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">manager</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;EUR/USD&#39;</span><span class="p">,</span> <span class="mi">30000</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;GBP/USD&#39;</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;USD/JPY&#39;</span><span class="p">,</span> <span class="mi">15000</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portfolio Risk Report&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">risk_report</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total Leverage: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">get_total_leverage</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>

<span class="c1"># Check new position</span>
<span class="n">rec</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">recommend_new_position</span><span class="p">(</span><span class="s1">&#39;AUD/USD&#39;</span><span class="p">,</span> <span class="mi">30000</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">New Position Recommendation: </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 3.6: Leverage Risk Calculator (Open-ended)</h2>
<p>Build a comprehensive leverage risk calculator for pre-trade analysis.</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 3.6: Leverage Risk Calculator (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a LeverageRiskCalculator class that:</span>
<span class="c1"># - Calculates maximum loss under different scenarios</span>
<span class="c1"># - Determines safe leverage based on volatility</span>
<span class="c1"># - Provides margin call price levels</span>
<span class="c1"># - Creates risk visualization</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - set_parameters(account: float, leverage: float, volatility: float)</span>
<span class="c1"># - calculate_max_position() -&gt; dict</span>
<span class="c1"># - margin_call_price(entry_price: float, direction: str) -&gt; float</span>
<span class="c1"># - scenario_analysis(position_value: float, scenarios: List[float]) -&gt; pd.DataFrame</span>
<span class="c1"># - plot_risk_profile()</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LeverageRiskCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pre-trade leverage risk analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">set_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">account</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span> <span class="o">=</span> <span class="n">volatility</span>

    <span class="k">def</span> <span class="nf">calculate_max_position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">max_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
        <span class="n">margin_required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span>  <span class="c1"># Using 100% of account as margin</span>
        <span class="n">wipeout_move</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>

        <span class="c1"># Safe position (account for 3-sigma move)</span>
        <span class="n">three_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="n">safe_leverage</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leverage</span><span class="p">,</span> <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="n">three_sigma</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">safe_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">*</span> <span class="n">safe_leverage</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;max_position&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">max_position</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;margin_required&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">margin_required</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;wipeout_move_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">wipeout_move</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;recommended_leverage&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">safe_leverage</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;safe_position&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">safe_position</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;daily_var_95&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volatility</span> <span class="o">*</span> <span class="mf">1.65</span> <span class="o">*</span> <span class="n">safe_leverage</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">margin_call_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">margin_pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
        <span class="n">maintenance_pct</span> <span class="o">=</span> <span class="n">margin_pct</span> <span class="o">*</span> <span class="mf">0.5</span>  <span class="c1"># 50% maintenance</span>

        <span class="c1"># Price move to hit maintenance</span>
        <span class="n">move_to_maintenance</span> <span class="o">=</span> <span class="p">(</span><span class="n">margin_pct</span> <span class="o">-</span> <span class="n">maintenance_pct</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">move_to_maintenance</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">move_to_maintenance</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scenario_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">scenarios</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">margin</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>

        <span class="k">for</span> <span class="n">change_pct</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">change_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">new_equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">+</span> <span class="n">pnl</span>
            <span class="n">margin_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_equity</span> <span class="o">/</span> <span class="n">margin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">margin</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Price Change&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">change_pct</span><span class="si">:</span><span class="s2">+.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="s1">&#39;P&amp;L&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">pnl</span><span class="si">:</span><span class="s2">+,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Equity&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">new_equity</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Margin Level&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">margin_level</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Status&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span> <span class="k">if</span> <span class="n">margin_level</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="s1">&#39;MARGIN CALL&#39;</span> <span class="k">if</span> <span class="n">margin_level</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="s1">&#39;LIQUIDATION&#39;</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_risk_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Set parameters first&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="c1"># Left: Equity vs price change</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">price_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lev</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">*</span> <span class="n">lev</span>
            <span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">+</span> <span class="n">position</span> <span class="o">*</span> <span class="p">(</span><span class="n">price_changes</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">price_changes</span><span class="p">,</span> <span class="n">equity</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lev</span><span class="si">}</span><span class="s1">:1&#39;</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Price Change (%)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Equity ($1000s)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Equity vs Price Change at Different Leverage&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Right: VaR by leverage</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">leverage_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
        <span class="n">var_95</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">volatility</span> <span class="o">*</span> <span class="mf">1.65</span> <span class="o">*</span> <span class="n">l</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">leverage_range</span><span class="p">]</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">leverage_range</span><span class="p">,</span> <span class="n">var_95</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">leverage_range</span><span class="p">,</span> <span class="n">var_95</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Account Balance&#39;</span><span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Leverage&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Daily VaR (95%)&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Value at Risk vs Leverage&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Test</span>
<span class="n">calc</span> <span class="o">=</span> <span class="n">LeverageRiskCalculator</span><span class="p">()</span>
<span class="n">calc</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">account</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">volatility</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max Position Analysis&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">calc</span><span class="o">.</span><span class="n">calculate_max_position</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Margin Call Price (Long from 1.0850): </span><span class="si">{</span><span class="n">calc</span><span class="o">.</span><span class="n">margin_call_price</span><span class="p">(</span><span class="mf">1.0850</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scenario Analysis (Position: $200,000)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">scenario_analysis</span><span class="p">(</span><span class="mi">200000</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="n">calc</span><span class="o">.</span><span class="n">plot_risk_profile</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Leverage Risk Calculator</h2>
<p>Build a comprehensive leverage risk management system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">LeverageRiskManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive leverage and risk management system.</span>
<span class="sd">    </span>
<span class="sd">    Combines margin calculation, position sizing, scenario analysis,</span>
<span class="sd">    and risk visualization for leveraged trading.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">max_leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">risk_per_trade</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">max_portfolio_risk</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">=</span> <span class="n">account_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span> <span class="o">=</span> <span class="n">max_leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_per_trade</span> <span class="o">=</span> <span class="n">risk_per_trade</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_portfolio_risk</span> <span class="o">=</span> <span class="n">max_portfolio_risk</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># ==================== Position Sizing ====================</span>
    
    <span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stop_loss_pips</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">pip_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">custom_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate optimal position size.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            stop_loss_pips: Stop loss distance in pips</span>
<span class="sd">            pip_value: Value per pip per lot</span>
<span class="sd">            custom_risk_pct: Override default risk percentage</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Position sizing details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">risk_pct</span> <span class="o">=</span> <span class="n">custom_risk_pct</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_per_trade</span>
        
        <span class="c1"># Calculate by risk</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">risk_per_lot</span> <span class="o">=</span> <span class="n">stop_loss_pips</span> <span class="o">*</span> <span class="n">pip_value</span>
        <span class="n">lots_by_risk</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="n">risk_per_lot</span>
        
        <span class="c1"># Calculate by leverage limit</span>
        <span class="n">max_position_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span>
        <span class="n">lots_by_leverage</span> <span class="o">=</span> <span class="n">max_position_value</span> <span class="o">/</span> <span class="mi">100_000</span>
        
        <span class="c1"># Use conservative sizing</span>
        <span class="n">recommended_lots</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lots_by_risk</span><span class="p">,</span> <span class="n">lots_by_leverage</span><span class="p">)</span>
        <span class="n">position_value</span> <span class="o">=</span> <span class="n">recommended_lots</span> <span class="o">*</span> <span class="mi">100_000</span>
        <span class="n">margin_required</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span>
        <span class="n">effective_leverage</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="n">risk_pct</span><span class="p">,</span>
            <span class="s1">&#39;risk_amount&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">risk_amount</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;stop_loss_pips&#39;</span><span class="p">:</span> <span class="n">stop_loss_pips</span><span class="p">,</span>
            <span class="s1">&#39;lots&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">recommended_lots</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">recommended_lots</span> <span class="o">*</span> <span class="mi">100_000</span><span class="p">),</span>
            <span class="s1">&#39;position_value&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">position_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;margin_required&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">margin_required</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;effective_leverage&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">effective_leverage</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;margin_pct_of_account&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">margin_required</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="c1"># ==================== Margin Analysis ====================</span>
    
    <span class="k">def</span> <span class="nf">calculate_margin_call_level</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">position_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span>
        <span class="n">maintenance_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate margin call price level.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            entry_price: Position entry price</span>
<span class="sd">            position_value: Total position value</span>
<span class="sd">            direction: &#39;long&#39; or &#39;short&#39;</span>
<span class="sd">            maintenance_pct: Maintenance margin percentage</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Margin call analysis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">margin_used</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span>
        <span class="n">maintenance_margin</span> <span class="o">=</span> <span class="n">margin_used</span> <span class="o">*</span> <span class="p">(</span><span class="n">maintenance_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># Calculate price move to margin call</span>
        <span class="n">equity_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">-</span> <span class="n">maintenance_margin</span>
        <span class="n">price_move_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity_buffer</span> <span class="o">/</span> <span class="n">position_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">margin_call_price</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">price_move_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">margin_call_price</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">price_move_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># Calculate liquidation price (assume 20% maintenance)</span>
        <span class="n">liquidation_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">-</span> <span class="n">margin_used</span> <span class="o">*</span> <span class="mf">0.2</span>
        <span class="n">liq_move_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">liquidation_buffer</span> <span class="o">/</span> <span class="n">position_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">liquidation_price</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">liq_move_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">liquidation_price</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">liq_move_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;position_value&#39;</span><span class="p">:</span> <span class="n">position_value</span><span class="p">,</span>
            <span class="s1">&#39;margin_used&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">margin_used</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;margin_call_price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">margin_call_price</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s1">&#39;margin_call_pips&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">entry_price</span> <span class="o">-</span> <span class="n">margin_call_price</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.0001</span><span class="p">)),</span>
            <span class="s1">&#39;liquidation_price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">liquidation_price</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s1">&#39;buffer_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">price_move_pct</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="c1"># ==================== Scenario Analysis ====================</span>
    
    <span class="k">def</span> <span class="nf">scenario_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">position_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">price_scenarios</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze P&amp;L under different price scenarios.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            position_value: Total position value</span>
<span class="sd">            price_scenarios: List of price change percentages</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Scenario analysis DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">price_scenarios</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">price_scenarios</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        
        <span class="n">margin_used</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">change_pct</span> <span class="ow">in</span> <span class="n">price_scenarios</span><span class="p">:</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">change_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">new_equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">+</span> <span class="n">pnl</span>
            <span class="n">margin_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_equity</span> <span class="o">/</span> <span class="n">margin_used</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">margin_used</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="n">account_change</span> <span class="o">=</span> <span class="p">(</span><span class="n">pnl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            
            <span class="k">if</span> <span class="n">margin_level</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;LIQUIDATION&#39;</span>
            <span class="k">elif</span> <span class="n">margin_level</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;MARGIN CALL&#39;</span>
            <span class="k">elif</span> <span class="n">margin_level</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;WARNING&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;OK&#39;</span>
            
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Price Change&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">change_pct</span><span class="si">:</span><span class="s2">+.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="s1">&#39;P&amp;L&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">pnl</span><span class="si">:</span><span class="s2">+,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Account Change&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">account_change</span><span class="si">:</span><span class="s2">+.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Equity&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">new_equity</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Margin Level&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">margin_level</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Status&#39;</span><span class="p">:</span> <span class="n">status</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    
    <span class="c1"># ==================== Risk Metrics ====================</span>
    
    <span class="k">def</span> <span class="nf">calculate_risk_metrics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">position_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">daily_volatility</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate risk metrics for a position.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            position_value: Total position value</span>
<span class="sd">            daily_volatility: Expected daily volatility</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Risk metrics dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">effective_leverage</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span>
        
        <span class="c1"># Daily VaR (95%)</span>
        <span class="n">var_95</span> <span class="o">=</span> <span class="n">daily_volatility</span> <span class="o">*</span> <span class="mf">1.65</span> <span class="o">*</span> <span class="n">position_value</span>
        
        <span class="c1"># Daily VaR (99%)</span>
        <span class="n">var_99</span> <span class="o">=</span> <span class="n">daily_volatility</span> <span class="o">*</span> <span class="mf">2.33</span> <span class="o">*</span> <span class="n">position_value</span>
        
        <span class="c1"># Expected daily P&amp;L range</span>
        <span class="n">daily_range</span> <span class="o">=</span> <span class="n">daily_volatility</span> <span class="o">*</span> <span class="n">position_value</span>
        
        <span class="c1"># Days to potential wipeout (99% VaR)</span>
        <span class="k">if</span> <span class="n">var_99</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">days_to_wipeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">/</span> <span class="n">var_99</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">days_to_wipeout</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        
        <span class="c1"># Price move to lose entire account</span>
        <span class="n">wipeout_move</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">/</span> <span class="n">position_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;position_value&#39;</span><span class="p">:</span> <span class="n">position_value</span><span class="p">,</span>
            <span class="s1">&#39;effective_leverage&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">effective_leverage</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;daily_volatility&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">daily_volatility</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="s1">&#39;daily_var_95&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">var_95</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;daily_var_95_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">var_95</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;daily_var_99&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">var_99</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;expected_daily_range&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">daily_range</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;wipeout_price_move&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">wipeout_move</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;theoretical_days_to_wipeout&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">days_to_wipeout</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="c1"># ==================== Visualization ====================</span>
    
    <span class="k">def</span> <span class="nf">plot_risk_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visualize risk profile.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">position_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">position_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># Default 10:1</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        
        <span class="c1"># 1. Equity curve by price change</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">price_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">+</span> <span class="n">position_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">price_changes</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">price_changes</span><span class="p">,</span> <span class="n">equity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">,</span> 
                        <span class="n">where</span><span class="o">=</span><span class="n">equity</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">price_changes</span><span class="p">,</span> <span class="n">equity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">,</span>
                        <span class="n">where</span><span class="o">=</span><span class="n">equity</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">price_changes</span><span class="p">,</span> <span class="n">equity</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Wipeout&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Price Change (%)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Account Equity ($)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Equity vs Price Change (Position: $</span><span class="si">{</span><span class="n">position_value</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># 2. Leverage comparison</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">leverage_levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">lev</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">leverage_levels</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
            <span class="n">pos_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="n">lev</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">+</span> <span class="n">pos_val</span> <span class="o">*</span> <span class="p">(</span><span class="n">price_changes</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">price_changes</span><span class="p">,</span> <span class="n">eq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lev</span><span class="si">}</span><span class="s1">:1&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Price Change (%)&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Equity ($1000s)&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Equity by Leverage Level&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># 3. VaR by leverage</span>
        <span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">leverage_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
        <span class="n">daily_vol</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="n">var_95</span> <span class="o">=</span> <span class="p">[</span><span class="n">daily_vol</span> <span class="o">*</span> <span class="mf">1.65</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">leverage_range</span><span class="p">]</span>
        <span class="n">var_99</span> <span class="o">=</span> <span class="p">[</span><span class="n">daily_vol</span> <span class="o">*</span> <span class="mf">2.33</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">leverage_range</span><span class="p">]</span>
        
        <span class="n">ax3</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">leverage_range</span><span class="p">,</span> <span class="n">var_99</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;99% VaR&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">leverage_range</span><span class="p">,</span> <span class="n">var_95</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% VaR&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
                   <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Account Balance&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Leverage&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Daily VaR ($)&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Value at Risk vs Leverage (1</span><span class="si">% d</span><span class="s1">aily vol)&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># 4. Margin level by price change</span>
        <span class="n">ax4</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">margin_used</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span>
        <span class="n">margin_levels</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">+</span> <span class="n">position_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">price_changes</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span> 
                        <span class="o">/</span> <span class="n">margin_used</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">price_changes</span><span class="p">,</span> <span class="n">margin_levels</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Margin Call (100%)&#39;</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Stop Out (50%)&#39;</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">price_changes</span><span class="p">,</span> <span class="n">margin_levels</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
                        <span class="n">where</span><span class="o">=</span><span class="n">margin_levels</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">price_changes</span><span class="p">,</span> <span class="n">margin_levels</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">margin_levels</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">margin_levels</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">),</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Price Change (%)&#39;</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Margin Level (%)&#39;</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Margin Level vs Price Change&#39;</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># ==================== Summary ====================</span>
    
    <span class="k">def</span> <span class="nf">print_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stop_loss_pips</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0850</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print comprehensive analysis.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LEVERAGE RISK ANALYSIS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Account Balance: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Leverage: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span><span class="si">}</span><span class="s2">:1&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Risk Per Trade: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_per_trade</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="c1"># Position sizing</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POSITION SIZING&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">sizing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span><span class="n">stop_loss_pips</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sizing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Margin call levels</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MARGIN CALL ANALYSIS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">margin_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_margin_call_level</span><span class="p">(</span>
            <span class="n">entry_price</span><span class="p">,</span> <span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;position_value&#39;</span><span class="p">],</span> <span class="s1">&#39;long&#39;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">margin_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Risk metrics</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RISK METRICS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_risk_metrics</span><span class="p">(</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;position_value&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Scenario analysis</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SCENARIO ANALYSIS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">scenarios</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_analysis</span><span class="p">(</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;position_value&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">scenarios</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate the Leverage Risk Manager</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">LeverageRiskManager</span><span class="p">(</span>
    <span class="n">account_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">max_leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">risk_per_trade</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">max_portfolio_risk</span><span class="o">=</span><span class="mf">10.0</span>
<span class="p">)</span>

<span class="c1"># Print comprehensive analysis</span>
<span class="n">manager</span><span class="o">.</span><span class="n">print_analysis</span><span class="p">(</span><span class="n">stop_loss_pips</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">entry_price</span><span class="o">=</span><span class="mf">1.0850</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Visualize risk profile</span>
<span class="n">manager</span><span class="o">.</span><span class="n">plot_risk_profile</span><span class="p">(</span><span class="n">position_value</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ul>
<li><strong>Leverage</strong> amplifies both gains and losses - a 1% price move with 50:1 leverage is a 50% account change</li>
<li><strong>Margin</strong> is the collateral required to open and maintain positions</li>
<li><strong>Initial margin</strong> opens positions; <strong>maintenance margin</strong> keeps them open</li>
<li><strong>Margin calls</strong> occur when equity falls below maintenance level - action required or positions get liquidated</li>
<li><strong>Position sizing</strong> should be based on risk (% of account), not margin available</li>
<li><strong>Professional traders</strong> typically use 5:1 to 15:1 effective leverage, not the maximum available</li>
<li><strong>Higher leverage = smaller adverse move to wipeout</strong> (50:1 = 2% move, 100:1 = 1% move)</li>
<li><strong>Recovery math is brutal</strong> - a 50% loss requires a 100% gain to recover</li>
</ul>
<hr />
<p><strong>Next: Module 4 - Data &amp; Tools</strong></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="4"><div class="md-cell module-header"><h1>Module 4: Data &amp; Tools</h1>
<h2>Part 1: Market Fundamentals</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:</p>
<ul>
<li>Access forex data from multiple sources</li>
<li>Set up and use the OANDA API for forex data</li>
<li>Download and store historical price data</li>
<li>Work with real-time streaming data</li>
<li>Build robust data pipelines for forex trading</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Standard imports for this module</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Generator</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Display settings</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>4.1 Forex Data Sources</h2>
<h3>Available Data Sources</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Source</th>
<th>Type</th>
<th>Cost</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>OANDA</strong></td>
<td>Broker API</td>
<td>Free (demo)</td>
<td>Live trading, historical</td>
</tr>
<tr>
<td><strong>FXCM</strong></td>
<td>Broker API</td>
<td>Free (demo)</td>
<td>Historical tick data</td>
</tr>
<tr>
<td><strong>Alpha Vantage</strong></td>
<td>Data API</td>
<td>Free tier</td>
<td>Basic forex data</td>
</tr>
<tr>
<td><strong>Yahoo Finance</strong></td>
<td>Data API</td>
<td>Free</td>
<td>Currency pair proxies</td>
</tr>
<tr>
<td><strong>Dukascopy</strong></td>
<td>Data Download</td>
<td>Free</td>
<td>Tick data backtesting</td>
</tr>
<tr>
<td><strong>TradingView</strong></td>
<td>Charts</td>
<td>Free/Paid</td>
<td>Charting, basic data</td>
</tr>
</tbody>
</table></div>
<h3>Data Types</h3>
<ul>
<li><strong>Tick Data</strong>: Every price change (bid/ask)</li>
<li><strong>OHLC Bars</strong>: Open, High, Low, Close aggregated by time</li>
<li><strong>Order Book</strong>: Depth of market (advanced)</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ForexDataSource</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a forex data source.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        name: Source name</span>
<span class="sd">        api_type: Type of API/access</span>
<span class="sd">        data_types: Available data types</span>
<span class="sd">        free_tier: Whether free access is available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">data_types</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">free_tier</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># Define available data sources</span>
<span class="n">DATA_SOURCES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;oanda&#39;</span><span class="p">:</span> <span class="n">ForexDataSource</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;OANDA&#39;</span><span class="p">,</span>
        <span class="n">api_type</span><span class="o">=</span><span class="s1">&#39;REST/Streaming&#39;</span><span class="p">,</span>
        <span class="n">data_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;OHLC&#39;</span><span class="p">,</span> <span class="s1">&#39;Tick&#39;</span><span class="p">,</span> <span class="s1">&#39;Order Book&#39;</span><span class="p">],</span>
        <span class="n">free_tier</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://developer.oanda.com&#39;</span>
    <span class="p">),</span>
    <span class="s1">&#39;fxcm&#39;</span><span class="p">:</span> <span class="n">ForexDataSource</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;FXCM&#39;</span><span class="p">,</span>
        <span class="n">api_type</span><span class="o">=</span><span class="s1">&#39;REST/Socket&#39;</span><span class="p">,</span>
        <span class="n">data_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;OHLC&#39;</span><span class="p">,</span> <span class="s1">&#39;Tick&#39;</span><span class="p">],</span>
        <span class="n">free_tier</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://fxcm.github.io/rest-api-docs/&#39;</span>
    <span class="p">),</span>
    <span class="s1">&#39;alpha_vantage&#39;</span><span class="p">:</span> <span class="n">ForexDataSource</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Alpha Vantage&#39;</span><span class="p">,</span>
        <span class="n">api_type</span><span class="o">=</span><span class="s1">&#39;REST&#39;</span><span class="p">,</span>
        <span class="n">data_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;OHLC&#39;</span><span class="p">],</span>
        <span class="n">free_tier</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://www.alphavantage.co&#39;</span>
    <span class="p">),</span>
    <span class="s1">&#39;yahoo&#39;</span><span class="p">:</span> <span class="n">ForexDataSource</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Yahoo Finance&#39;</span><span class="p">,</span>
        <span class="n">api_type</span><span class="o">=</span><span class="s1">&#39;REST (yfinance)&#39;</span><span class="p">,</span>
        <span class="n">data_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;OHLC&#39;</span><span class="p">],</span>
        <span class="n">free_tier</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://finance.yahoo.com&#39;</span>
    <span class="p">),</span>
    <span class="s1">&#39;dukascopy&#39;</span><span class="p">:</span> <span class="n">ForexDataSource</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dukascopy&#39;</span><span class="p">,</span>
        <span class="n">api_type</span><span class="o">=</span><span class="s1">&#39;Download&#39;</span><span class="p">,</span>
        <span class="n">data_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Tick&#39;</span><span class="p">,</span> <span class="s1">&#39;OHLC&#39;</span><span class="p">],</span>
        <span class="n">free_tier</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://www.dukascopy.com/swiss/english/marketwatch/historical/&#39;</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Display sources</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Forex Data Sources&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">DATA_SOURCES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  API Type: </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">api_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Data Types: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">data_types</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Free Tier: </span><span class="si">{</span><span class="s1">&#39;Yes&#39;</span> <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">free_tier</span> <span class="k">else</span> <span class="s1">&#39;No&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  URL: </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Mock forex data generator (simulates API response)</span>
<span class="k">class</span> <span class="nc">MockForexDataProvider</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mock data provider for demonstration.</span>
<span class="sd">    </span>
<span class="sd">    In production, this would be replaced with actual API calls.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Base prices for common pairs</span>
    <span class="n">BASE_PRICES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;EUR_USD&#39;</span><span class="p">:</span> <span class="mf">1.0850</span><span class="p">,</span>
        <span class="s1">&#39;GBP_USD&#39;</span><span class="p">:</span> <span class="mf">1.2650</span><span class="p">,</span>
        <span class="s1">&#39;USD_JPY&#39;</span><span class="p">:</span> <span class="mf">150.50</span><span class="p">,</span>
        <span class="s1">&#39;AUD_USD&#39;</span><span class="p">:</span> <span class="mf">0.6550</span><span class="p">,</span>
        <span class="s1">&#39;USD_CAD&#39;</span><span class="p">:</span> <span class="mf">1.3650</span><span class="p">,</span>
        <span class="s1">&#39;EUR_GBP&#39;</span><span class="p">:</span> <span class="mf">0.8580</span><span class="p">,</span>
        <span class="s1">&#39;EUR_JPY&#39;</span><span class="p">:</span> <span class="mf">163.30</span>
    <span class="p">}</span>
    
    <span class="c1"># Typical spreads in pips</span>
    <span class="n">TYPICAL_SPREADS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;EUR_USD&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="s1">&#39;GBP_USD&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
        <span class="s1">&#39;USD_JPY&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s1">&#39;AUD_USD&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s1">&#39;USD_CAD&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;EUR_GBP&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s1">&#39;EUR_JPY&#39;</span><span class="p">:</span> <span class="mf">1.8</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_current_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get current bid/ask price for a pair.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pair: Currency pair (e.g., &#39;EUR_USD&#39;)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Price dictionary with bid, ask, spread</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">base_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_PRICES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">spread_pips</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TYPICAL_SPREADS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
        
        <span class="c1"># Add some randomness</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="mf">0.0001</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">pip_size</span>
        <span class="n">mid_price</span> <span class="o">=</span> <span class="n">base_price</span> <span class="o">+</span> <span class="n">noise</span>
        
        <span class="n">half_spread</span> <span class="o">=</span> <span class="p">(</span><span class="n">spread_pips</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">pip_size</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">mid_price</span> <span class="o">-</span> <span class="n">half_spread</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">mid_price</span> <span class="o">+</span> <span class="n">half_spread</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s1">&#39;mid&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">mid_price</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s1">&#39;spread_pips&#39;</span><span class="p">:</span> <span class="n">spread_pips</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_historical_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">granularity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get historical OHLC data.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pair: Currency pair</span>
<span class="sd">            granularity: Timeframe (M1, M5, M15, H1, H4, D)</span>
<span class="sd">            count: Number of candles</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with OHLC data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">base_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_PRICES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="mf">0.0001</span>
        
        <span class="c1"># Determine frequency</span>
        <span class="n">freq_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;M1&#39;</span><span class="p">:</span> <span class="s1">&#39;1min&#39;</span><span class="p">,</span> <span class="s1">&#39;M5&#39;</span><span class="p">:</span> <span class="s1">&#39;5min&#39;</span><span class="p">,</span> <span class="s1">&#39;M15&#39;</span><span class="p">:</span> <span class="s1">&#39;15min&#39;</span><span class="p">,</span>
            <span class="s1">&#39;H1&#39;</span><span class="p">:</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="s1">&#39;H4&#39;</span><span class="p">:</span> <span class="s1">&#39;4h&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="s1">&#39;1D&#39;</span>
        <span class="p">}</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">freq_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">granularity</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">)</span>
        
        <span class="c1"># Generate timestamps</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span>
        
        <span class="c1"># Generate price path</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.0002</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>  <span class="c1"># Small returns</span>
        <span class="n">close_prices</span> <span class="o">=</span> <span class="n">base_price</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span>
        
        <span class="c1"># Generate OHLC</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">pip_size</span>  <span class="c1"># Typical range</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">close_prices</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">close_prices</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span>
            <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">close_prices</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span>
            <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">close_prices</span><span class="p">,</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
        
        <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_price</span>  <span class="c1"># Fix first open</span>
        
        <span class="c1"># Ensure OHLC relationships</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>


<span class="c1"># Demonstrate the mock provider</span>
<span class="n">provider</span> <span class="o">=</span> <span class="n">MockForexDataProvider</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current Prices&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_JPY&#39;</span><span class="p">]:</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_current_price</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">10</span><span class="si">}</span><span class="s2"> Bid: </span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> | Ask: </span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> | &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Spread: </span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;spread_pips&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> pips&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>4.2 OANDA API Setup</h2>
<p>OANDA provides one of the most popular APIs for forex trading. Here's how to set it up:</p>
<h3>Account Setup</h3>
<ol>
<li>Create a demo account at <a href="https://www.oanda.com">OANDA</a></li>
<li>Navigate to "Manage API Access" in your account settings</li>
<li>Generate an API token</li>
<li>Note your account ID</li>
</ol>
<h3>API Endpoints</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Endpoint</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/v3/accounts</code></td>
<td>Account information</td>
</tr>
<tr>
<td><code>/v3/instruments/{pair}/candles</code></td>
<td>Historical OHLC</td>
</tr>
<tr>
<td><code>/v3/accounts/{id}/pricing/stream</code></td>
<td>Real-time prices</td>
</tr>
<tr>
<td><code>/v3/accounts/{id}/orders</code></td>
<td>Order management</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">OANDAClient</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OANDA API client for forex data and trading.</span>
<span class="sd">    </span>
<span class="sd">    This is a mock implementation for educational purposes.</span>
<span class="sd">    In production, use the oandapyV20 library.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        account_id: OANDA account ID</span>
<span class="sd">        access_token: API access token</span>
<span class="sd">        environment: &#39;practice&#39; or &#39;live&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">ENVIRONMENTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;practice&#39;</span><span class="p">:</span> <span class="s1">&#39;https://api-fxpractice.oanda.com&#39;</span><span class="p">,</span>
        <span class="s1">&#39;live&#39;</span><span class="p">:</span> <span class="s1">&#39;https://api-fxtrade.oanda.com&#39;</span>
    <span class="p">}</span>
    
    <span class="n">GRANULARITIES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;S5&#39;</span><span class="p">:</span> <span class="s1">&#39;S5&#39;</span><span class="p">,</span> <span class="s1">&#39;S10&#39;</span><span class="p">:</span> <span class="s1">&#39;S10&#39;</span><span class="p">,</span> <span class="s1">&#39;S15&#39;</span><span class="p">:</span> <span class="s1">&#39;S15&#39;</span><span class="p">,</span> <span class="s1">&#39;S30&#39;</span><span class="p">:</span> <span class="s1">&#39;S30&#39;</span><span class="p">,</span>
        <span class="s1">&#39;M1&#39;</span><span class="p">:</span> <span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;M2&#39;</span><span class="p">:</span> <span class="s1">&#39;M2&#39;</span><span class="p">,</span> <span class="s1">&#39;M4&#39;</span><span class="p">:</span> <span class="s1">&#39;M4&#39;</span><span class="p">,</span> <span class="s1">&#39;M5&#39;</span><span class="p">:</span> <span class="s1">&#39;M5&#39;</span><span class="p">,</span>
        <span class="s1">&#39;M10&#39;</span><span class="p">:</span> <span class="s1">&#39;M10&#39;</span><span class="p">,</span> <span class="s1">&#39;M15&#39;</span><span class="p">:</span> <span class="s1">&#39;M15&#39;</span><span class="p">,</span> <span class="s1">&#39;M30&#39;</span><span class="p">:</span> <span class="s1">&#39;M30&#39;</span><span class="p">,</span>
        <span class="s1">&#39;H1&#39;</span><span class="p">:</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">:</span> <span class="s1">&#39;H2&#39;</span><span class="p">,</span> <span class="s1">&#39;H3&#39;</span><span class="p">:</span> <span class="s1">&#39;H3&#39;</span><span class="p">,</span> <span class="s1">&#39;H4&#39;</span><span class="p">:</span> <span class="s1">&#39;H4&#39;</span><span class="p">,</span>
        <span class="s1">&#39;H6&#39;</span><span class="p">:</span> <span class="s1">&#39;H6&#39;</span><span class="p">,</span> <span class="s1">&#39;H8&#39;</span><span class="p">:</span> <span class="s1">&#39;H8&#39;</span><span class="p">,</span> <span class="s1">&#39;H12&#39;</span><span class="p">:</span> <span class="s1">&#39;H12&#39;</span><span class="p">,</span>
        <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;M&#39;</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">account_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">environment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;practice&#39;</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_id</span> <span class="o">=</span> <span class="n">account_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">access_token</span> <span class="o">=</span> <span class="n">access_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ENVIRONMENTS</span><span class="p">[</span><span class="n">environment</span><span class="p">]</span>
        
        <span class="c1"># Use mock provider for demonstration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mock</span> <span class="o">=</span> <span class="n">MockForexDataProvider</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make API request (mock implementation).</span>
<span class="sd">        </span>
<span class="sd">        In production, this would use requests library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Mock response based on endpoint</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_account_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get account summary.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Account details including balance, margin, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Mock account summary</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;account_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span>
            <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="mf">10000.00</span><span class="p">,</span>
            <span class="s1">&#39;unrealized_pl&#39;</span><span class="p">:</span> <span class="mf">125.50</span><span class="p">,</span>
            <span class="s1">&#39;nav&#39;</span><span class="p">:</span> <span class="mf">10125.50</span><span class="p">,</span>
            <span class="s1">&#39;margin_used&#39;</span><span class="p">:</span> <span class="mf">500.00</span><span class="p">,</span>
            <span class="s1">&#39;margin_available&#39;</span><span class="p">:</span> <span class="mf">9625.50</span><span class="p">,</span>
            <span class="s1">&#39;open_positions&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;open_trades&#39;</span><span class="p">:</span> <span class="mi">3</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_instruments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get available trading instruments.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of tradeable instruments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instruments</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;CURRENCY&#39;</span><span class="p">,</span> <span class="s1">&#39;pip&#39;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;CURRENCY&#39;</span><span class="p">,</span> <span class="s1">&#39;pip&#39;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;USD_JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;CURRENCY&#39;</span><span class="p">,</span> <span class="s1">&#39;pip&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;AUD_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;CURRENCY&#39;</span><span class="p">,</span> <span class="s1">&#39;pip&#39;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;USD_CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;CURRENCY&#39;</span><span class="p">,</span> <span class="s1">&#39;pip&#39;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;EUR_GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;CURRENCY&#39;</span><span class="p">,</span> <span class="s1">&#39;pip&#39;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;EUR_JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;CURRENCY&#39;</span><span class="p">,</span> <span class="s1">&#39;pip&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;XAU_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;METAL&#39;</span><span class="p">,</span> <span class="s1">&#39;pip&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">instruments</span>
    
    <span class="k">def</span> <span class="nf">get_pricing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get current pricing for instruments.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            instruments: List of instrument names</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of price dictionaries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">:</span>
            <span class="n">prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mock</span><span class="o">.</span><span class="n">get_current_price</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">get_candles</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">granularity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">from_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">to_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get historical candle data.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            instrument: Currency pair</span>
<span class="sd">            granularity: Timeframe</span>
<span class="sd">            count: Number of candles</span>
<span class="sd">            from_time: Start time</span>
<span class="sd">            to_time: End time</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with OHLC data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mock</span><span class="o">.</span><span class="n">get_historical_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>


<span class="c1"># Demonstrate OANDA client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">OANDAClient</span><span class="p">(</span>
    <span class="n">account_id</span><span class="o">=</span><span class="s1">&#39;101-001-12345678-001&#39;</span><span class="p">,</span>
    <span class="n">access_token</span><span class="o">=</span><span class="s1">&#39;your-api-token-here&#39;</span><span class="p">,</span>
    <span class="n">environment</span><span class="o">=</span><span class="s1">&#39;practice&#39;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OANDA Account Summary&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_account_summary</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Available Instruments&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">instruments</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_instruments</span><span class="p">()</span>
<span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inst</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">10</span><span class="si">}</span><span class="s2"> Type: </span><span class="si">{</span><span class="n">inst</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">10</span><span class="si">}</span><span class="s2"> Pip: </span><span class="si">{</span><span class="n">inst</span><span class="p">[</span><span class="s1">&#39;pip&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 4.1: Connect to OANDA (Guided)</h2>
<p>Complete the function to set up an OANDA connection and fetch basic data.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4.1: Connect to OANDA (Guided)</span>
<span class="k">def</span> <span class="nf">setup_oanda_connection</span><span class="p">(</span>
    <span class="n">account_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">environment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;practice&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up OANDA connection and verify access.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        account_id: OANDA account ID</span>
<span class="sd">        access_token: API access token</span>
<span class="sd">        environment: &#39;practice&#39; or &#39;live&#39;</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Connection status and account info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create client</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">OANDAClient</span><span class="p">(</span>
        <span class="n">account_id</span><span class="o">=</span><span class="n">account_id</span><span class="p">,</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">environment</span><span class="o">=</span><span class="n">______</span>  <span class="c1"># Pass the environment parameter</span>
    <span class="p">)</span>
    
    <span class="c1"># Get account summary</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  <span class="c1"># Call get_account_summary method</span>
    
    <span class="c1"># Get available instruments</span>
    <span class="n">instruments</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_instruments</span><span class="p">()</span>
    
    <span class="c1"># Get sample pricing</span>
    <span class="n">sample_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_JPY&#39;</span><span class="p">]</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">sample_pairs</span><span class="p">)</span>  <span class="c1"># Call get_pricing method</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;connected&#39;</span><span class="p">,</span>
        <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="n">environment</span><span class="p">,</span>
        <span class="s1">&#39;account_id&#39;</span><span class="p">:</span> <span class="n">account_id</span><span class="p">,</span>
        <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="n">account</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">],</span>
        <span class="s1">&#39;nav&#39;</span><span class="p">:</span> <span class="n">account</span><span class="p">[</span><span class="s1">&#39;nav&#39;</span><span class="p">],</span>
        <span class="s1">&#39;instruments_available&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">instruments</span><span class="p">),</span>
        <span class="s1">&#39;sample_prices&#39;</span><span class="p">:</span> <span class="n">prices</span>
    <span class="p">}</span>

<span class="c1"># Test connection</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">setup_oanda_connection</span><span class="p">(</span>
    <span class="n">account_id</span><span class="o">=</span><span class="s1">&#39;101-001-12345678-001&#39;</span><span class="p">,</span>
    <span class="n">access_token</span><span class="o">=</span><span class="s1">&#39;demo-token&#39;</span><span class="p">,</span>
    <span class="n">environment</span><span class="o">=</span><span class="s1">&#39;practice&#39;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connection Status&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;sample_prices&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.1</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setup_oanda_connection</span><span class="p">(</span>
    <span class="n">account_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">environment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;practice&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up OANDA connection and verify access.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create client</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">OANDAClient</span><span class="p">(</span>
        <span class="n">account_id</span><span class="o">=</span><span class="n">account_id</span><span class="p">,</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">environment</span><span class="o">=</span><span class="n">environment</span>  <span class="c1"># Pass the environment parameter</span>
    <span class="p">)</span>

    <span class="c1"># Get account summary</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_account_summary</span><span class="p">()</span>  <span class="c1"># Call get_account_summary method</span>

    <span class="c1"># Get available instruments</span>
    <span class="n">instruments</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_instruments</span><span class="p">()</span>

    <span class="c1"># Get sample pricing</span>
    <span class="n">sample_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_JPY&#39;</span><span class="p">]</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_pricing</span><span class="p">(</span><span class="n">sample_pairs</span><span class="p">)</span>  <span class="c1"># Call get_pricing method</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;connected&#39;</span><span class="p">,</span>
        <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="n">environment</span><span class="p">,</span>
        <span class="s1">&#39;account_id&#39;</span><span class="p">:</span> <span class="n">account_id</span><span class="p">,</span>
        <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="n">account</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">],</span>
        <span class="s1">&#39;nav&#39;</span><span class="p">:</span> <span class="n">account</span><span class="p">[</span><span class="s1">&#39;nav&#39;</span><span class="p">],</span>
        <span class="s1">&#39;instruments_available&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">instruments</span><span class="p">),</span>
        <span class="s1">&#39;sample_prices&#39;</span><span class="p">:</span> <span class="n">prices</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>4.3 Historical Data</h2>
<h3>Downloading and Storing Historical Data</h3>
<p>For backtesting and analysis, you need historical price data. Key considerations:</p>
<ul>
<li><strong>Timeframe</strong>: Choose appropriate granularity (M1 for scalping, H1 for swing)</li>
<li><strong>Date Range</strong>: Ensure sufficient history for your strategy</li>
<li><strong>Data Quality</strong>: Check for gaps, outliers, weekend data</li>
<li><strong>Storage Format</strong>: CSV, Parquet, or database</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ForexDataManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages downloading, storing, and retrieving forex data.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        data_dir: Directory for storing data</span>
<span class="sd">        client: OANDA client for fetching data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;./forex_data&#39;</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">OANDAClient</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span> <span class="ow">or</span> <span class="n">OANDAClient</span><span class="p">(</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="s1">&#39;demo&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">granularity</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate file path for storing data.&quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">granularity</span><span class="si">}</span><span class="s2">.csv&quot;</span>
    
    <span class="k">def</span> <span class="nf">download_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">granularity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download historical data from OANDA.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pair: Currency pair</span>
<span class="sd">            granularity: Timeframe</span>
<span class="sd">            count: Number of candles</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Downloaded data as DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">granularity</span><span class="si">}</span><span class="s2"> data...&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_candles</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        
        <span class="c1"># Save to file</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_file_path</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">granularity</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> candles to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">granularity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;H1&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data from local storage.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pair: Currency pair</span>
<span class="sd">            granularity: Timeframe</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            DataFrame or None if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_file_path</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">granularity</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">update_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">granularity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;H1&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update existing data with latest candles.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pair: Currency pair</span>
<span class="sd">            granularity: Timeframe</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Updated DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">granularity</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">existing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get new data from last timestamp</span>
            <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_candles</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            
            <span class="c1"># Combine and remove duplicates</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">existing</span><span class="p">,</span> <span class="n">new_data</span><span class="p">])</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="o">~</span><span class="n">combined</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)]</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            
            <span class="c1"># Save</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_file_path</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">granularity</span><span class="p">)</span>
            <span class="n">combined</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">combined</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_data</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">granularity</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_available_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List all available local data.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of available datasets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.csv&#39;</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">pair</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">granularity</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="c1"># Get file info</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">available</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                    <span class="s1">&#39;granularity&#39;</span><span class="p">:</span> <span class="n">granularity</span><span class="p">,</span>
                    <span class="s1">&#39;candles&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
                    <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="o">.</span><span class="n">name</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">available</span>
    
    <span class="k">def</span> <span class="nf">validate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate data quality.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            df: DataFrame to validate</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Validation report</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check for missing values</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">missing</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing values: </span><span class="si">{</span><span class="n">missing</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check OHLC relationships</span>
        <span class="n">invalid_hl</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_hl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid H/L: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_hl</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
        
        <span class="n">invalid_oh</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_oh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Open outside H/L: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_oh</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
        
        <span class="n">invalid_ch</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_ch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Close outside H/L: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_ch</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check for gaps (more than expected frequency)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">time_diffs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">median_diff</span> <span class="o">=</span> <span class="n">time_diffs</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
            <span class="n">large_gaps</span> <span class="o">=</span> <span class="n">time_diffs</span><span class="p">[</span><span class="n">time_diffs</span> <span class="o">&gt;</span> <span class="n">median_diff</span> <span class="o">*</span> <span class="mi">5</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">large_gaps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Large gaps: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">large_gaps</span><span class="p">)</span><span class="si">}</span><span class="s2"> (expected for weekends)&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="s1">&#39;date_range&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">issues</span> <span class="k">if</span> <span class="n">issues</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;No issues found&#39;</span><span class="p">]</span>
        <span class="p">}</span>


<span class="c1"># Demonstrate data manager</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">ForexDataManager</span><span class="p">(</span><span class="s1">&#39;./demo_data&#39;</span><span class="p">)</span>

<span class="c1"># Download sample data</span>
<span class="n">eur_usd</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">download_data</span><span class="p">(</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Downloaded data shape: </span><span class="si">{</span><span class="n">eur_usd</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">eur_usd</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Validate the downloaded data</span>
<span class="n">validation</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">validate_data</span><span class="p">(</span><span class="n">eur_usd</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data Validation Report&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">validation</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 4.2: Build Data Pipeline (Guided)</h2>
<p>Complete the function to build a data download pipeline for multiple pairs and timeframes.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4.2: Build Data Pipeline (Guided)</span>
<span class="k">def</span> <span class="nf">build_data_pipeline</span><span class="p">(</span>
    <span class="n">pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;./pipeline_data&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a data pipeline for multiple pairs and timeframes.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        pairs: List of currency pairs</span>
<span class="sd">        timeframes: List of timeframes (e.g., [&#39;H1&#39;, &#39;H4&#39;, &#39;D&#39;])</span>
<span class="sd">        data_dir: Directory for storing data</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Pipeline summary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ForexDataManager</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
    
    <span class="n">downloaded</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_candles</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Iterate through all combinations</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">______</span><span class="p">:</span>  <span class="c1"># Iterate through pairs</span>
        <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">______</span><span class="p">:</span>  <span class="c1"># Iterate through timeframes</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Download data</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>  <span class="c1"># Call download method</span>
                
                <span class="n">downloaded</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                    <span class="s1">&#39;timeframe&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="p">,</span>
                    <span class="s1">&#39;candles&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="p">})</span>
                <span class="n">total_candles</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                    <span class="s1">&#39;timeframe&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="p">,</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">})</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_downloads&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">downloaded</span><span class="p">),</span>
        <span class="s1">&#39;total_candles&#39;</span><span class="p">:</span> <span class="n">total_candles</span><span class="p">,</span>
        <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed</span><span class="p">),</span>
        <span class="s1">&#39;downloaded&#39;</span><span class="p">:</span> <span class="n">downloaded</span><span class="p">,</span>
        <span class="s1">&#39;failures&#39;</span><span class="p">:</span> <span class="n">failed</span>
    <span class="p">}</span>

<span class="c1"># Test the pipeline</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">build_data_pipeline</span><span class="p">(</span>
    <span class="n">pairs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">],</span>
    <span class="n">timeframes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;H4&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pipeline Summary&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Downloads: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_downloads&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Candles: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_candles&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failures: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.2</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_data_pipeline</span><span class="p">(</span>
    <span class="n">pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;./pipeline_data&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a data pipeline for multiple pairs and timeframes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">ForexDataManager</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>

    <span class="n">downloaded</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_candles</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Iterate through all combinations</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>  <span class="c1"># Iterate through pairs</span>
        <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">timeframes</span><span class="p">:</span>  <span class="c1"># Iterate through timeframes</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Download data</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">download_data</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>  <span class="c1"># Call download method</span>

                <span class="n">downloaded</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                    <span class="s1">&#39;timeframe&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="p">,</span>
                    <span class="s1">&#39;candles&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="p">})</span>
                <span class="n">total_candles</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">failed</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                    <span class="s1">&#39;timeframe&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="p">,</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">})</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_downloads&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">downloaded</span><span class="p">),</span>
        <span class="s1">&#39;total_candles&#39;</span><span class="p">:</span> <span class="n">total_candles</span><span class="p">,</span>
        <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed</span><span class="p">),</span>
        <span class="s1">&#39;downloaded&#39;</span><span class="p">:</span> <span class="n">downloaded</span><span class="p">,</span>
        <span class="s1">&#39;failures&#39;</span><span class="p">:</span> <span class="n">failed</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>4.4 Real-Time Data</h2>
<h3>Streaming Price Data</h3>
<p>For live trading, you need real-time streaming prices. OANDA provides a streaming endpoint that pushes price updates as they occur.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MockPriceStream</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulates a real-time price stream.</span>
<span class="sd">    </span>
<span class="sd">    In production, this would connect to OANDA&#39;s streaming API.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provider</span> <span class="o">=</span> <span class="n">MockForexDataProvider</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Current prices</span>
        
        <span class="c1"># Initialize prices</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="p">[</span><span class="n">inst</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provider</span><span class="o">.</span><span class="n">get_current_price</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_update_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate price updates.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="p">[</span><span class="n">inst</span><span class="p">]</span>
            <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">inst</span> <span class="k">else</span> <span class="mf">0.0001</span>
            
            <span class="c1"># Random walk</span>
            <span class="n">change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">pip_size</span>
            <span class="n">new_mid</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">change</span>
            <span class="n">half_spread</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="s1">&#39;spread_pips&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">pip_size</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="p">[</span><span class="n">inst</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">inst</span><span class="p">,</span>
                <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">new_mid</span> <span class="o">-</span> <span class="n">half_spread</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">new_mid</span> <span class="o">+</span> <span class="n">half_spread</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                <span class="s1">&#39;mid&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">new_mid</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                <span class="s1">&#39;spread_pips&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">[</span><span class="s1">&#39;spread_pips&#39;</span><span class="p">],</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stream price updates.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            duration_seconds: How long to stream</span>
<span class="sd">            </span>
<span class="sd">        Yields:</span>
<span class="sd">            Price update dictionaries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">duration_seconds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_prices</span><span class="p">()</span>
            
            <span class="c1"># Yield random instrument update</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="p">[</span><span class="n">inst</span><span class="p">]</span>
            
            <span class="c1"># Simulate network delay</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the stream.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">get_current_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get current prices for all instruments.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="c1"># Demonstrate streaming</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">MockPriceStream</span><span class="p">([</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_JPY&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulated Price Stream (5 updates)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">stream</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">duration_seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">12</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">10</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Bid: </span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> | Ask: </span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">break</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">RealTimeDataHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles real-time forex data processing.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        stream: Price stream source</span>
<span class="sd">        buffer_size: Number of ticks to buffer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="o">=</span> <span class="n">instruments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">buffer_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">MockPriceStream</span><span class="p">(</span><span class="n">instruments</span><span class="p">)</span>
        
        <span class="c1"># Initialize buffers for each instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tick_buffers</span> <span class="o">=</span> <span class="p">{</span><span class="n">inst</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of callback functions</span>
    
    <span class="k">def</span> <span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a callback function to be called on each tick.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_process_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a single tick.&quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span>
        
        <span class="c1"># Add to buffer</span>
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_buffers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tick_buffers</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
            
            <span class="c1"># Trim buffer if too large</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tick_buffers</span><span class="p">[</span><span class="n">pair</span><span class="p">])</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tick_buffers</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_buffers</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">:]</span>
        
        <span class="c1"># Call callbacks</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the data handler.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting data handler for </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"> seconds...&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_tick</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data handler stopped.&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_tick_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get buffered tick data as DataFrame.&quot;&quot;&quot;</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inst</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_buffers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="n">ticks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_buffers</span><span class="p">[</span><span class="n">inst</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ticks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">get_latest_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get latest price for each instrument.&quot;&quot;&quot;</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">inst</span><span class="p">,</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_buffers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">buffer</span><span class="p">:</span>
                <span class="n">latest</span><span class="p">[</span><span class="n">inst</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">latest</span>


<span class="c1"># Demonstrate real-time handler</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">RealTimeDataHandler</span><span class="p">([</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">],</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Add a simple callback</span>
<span class="n">tick_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">count_ticks</span><span class="p">(</span><span class="n">tick</span><span class="p">):</span>
    <span class="n">tick_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">handler</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">count_ticks</span><span class="p">)</span>

<span class="c1"># Run for short duration</span>
<span class="n">handler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total ticks received: </span><span class="si">{</span><span class="n">tick_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Latest Prices:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">handler</span><span class="o">.</span><span class="n">get_latest_prices</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 4.3: Real-Time Feed (Guided)</h2>
<p>Complete the function to process real-time price updates and calculate simple metrics.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4.3: Real-Time Feed (Guided)</span>
<span class="k">def</span> <span class="nf">process_price_stream</span><span class="p">(</span>
    <span class="n">instruments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">alert_threshold_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a price stream and generate statistics.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        instruments: List of currency pairs</span>
<span class="sd">        duration: Stream duration in seconds</span>
<span class="sd">        alert_threshold_pips: Pip move threshold for alerts</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Processing statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">MockPriceStream</span><span class="p">(</span><span class="n">instruments</span><span class="p">)</span>
    
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">first_prices</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">stream</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="mf">0.0001</span>
        
        <span class="c1"># Initialize stats for pair</span>
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;ticks&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;prices&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;first&#39;</span><span class="p">:</span> <span class="n">mid</span><span class="p">,</span>
                <span class="s1">&#39;last&#39;</span><span class="p">:</span> <span class="n">mid</span>
            <span class="p">}</span>
            <span class="n">first_prices</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">mid</span>
        
        <span class="c1"># Update stats</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="s1">&#39;ticks&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="s1">&#39;prices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">mid</span><span class="p">)</span>  <span class="c1"># Append price to list</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mid</span>
        
        <span class="c1"># Check for significant move</span>
        <span class="n">move_pips</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mid</span> <span class="o">-</span> <span class="n">first_prices</span><span class="p">[</span><span class="n">pair</span><span class="p">])</span> <span class="o">/</span> <span class="n">______</span>  <span class="c1"># Convert to pips</span>
        
        <span class="k">if</span> <span class="n">move_pips</span> <span class="o">&gt;=</span> <span class="n">alert_threshold_pips</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;UP&#39;</span> <span class="k">if</span> <span class="n">mid</span> <span class="o">&gt;</span> <span class="n">first_prices</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="k">else</span> <span class="n">______</span>  <span class="c1"># Determine direction</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                <span class="s1">&#39;move_pips&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">move_pips</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
            <span class="p">})</span>
    
    <span class="c1"># Calculate final statistics</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="mf">0.0001</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;prices&#39;</span><span class="p">]</span>
        
        <span class="n">summary</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tick_count&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ticks&#39;</span><span class="p">],</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="k">if</span> <span class="n">prices</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="k">if</span> <span class="n">prices</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;range_pips&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="p">))</span> <span class="o">/</span> <span class="n">pip_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">prices</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;net_change_pips&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">pip_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
        <span class="s1">&#39;instruments&#39;</span><span class="p">:</span> <span class="n">instruments</span><span class="p">,</span>
        <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span>
        <span class="s1">&#39;alerts&#39;</span><span class="p">:</span> <span class="n">alerts</span>
    <span class="p">}</span>

<span class="c1"># Test the function</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">process_price_stream</span><span class="p">([</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">],</span> <span class="n">duration</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Price Stream Processing Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;alerts&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Alerts: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;alerts&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No alerts triggered&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.3</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">process_price_stream</span><span class="p">(</span>
    <span class="n">instruments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">alert_threshold_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a price stream and generate statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">MockPriceStream</span><span class="p">(</span><span class="n">instruments</span><span class="p">)</span>

    <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">first_prices</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">stream</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="mf">0.0001</span>

        <span class="c1"># Initialize stats for pair</span>
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;ticks&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;prices&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;first&#39;</span><span class="p">:</span> <span class="n">mid</span><span class="p">,</span>
                <span class="s1">&#39;last&#39;</span><span class="p">:</span> <span class="n">mid</span>
            <span class="p">}</span>
            <span class="n">first_prices</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">mid</span>

        <span class="c1"># Update stats</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="s1">&#39;ticks&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="s1">&#39;prices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mid</span><span class="p">)</span>  <span class="c1"># Append price to list</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mid</span>

        <span class="c1"># Check for significant move</span>
        <span class="n">move_pips</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mid</span> <span class="o">-</span> <span class="n">first_prices</span><span class="p">[</span><span class="n">pair</span><span class="p">])</span> <span class="o">/</span> <span class="n">pip_size</span>  <span class="c1"># Convert to pips</span>

        <span class="k">if</span> <span class="n">move_pips</span> <span class="o">&gt;=</span> <span class="n">alert_threshold_pips</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;UP&#39;</span> <span class="k">if</span> <span class="n">mid</span> <span class="o">&gt;</span> <span class="n">first_prices</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;DOWN&#39;</span>  <span class="c1"># Determine direction</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                <span class="s1">&#39;move_pips&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">move_pips</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
            <span class="p">})</span>

    <span class="c1"># Calculate final statistics</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="mf">0.0001</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;prices&#39;</span><span class="p">]</span>

        <span class="n">summary</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;tick_count&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ticks&#39;</span><span class="p">],</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="k">if</span> <span class="n">prices</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="k">if</span> <span class="n">prices</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;range_pips&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">prices</span><span class="p">))</span> <span class="o">/</span> <span class="n">pip_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">prices</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;net_change_pips&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;last&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">pip_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
        <span class="s1">&#39;instruments&#39;</span><span class="p">:</span> <span class="n">instruments</span><span class="p">,</span>
        <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span>
        <span class="s1">&#39;alerts&#39;</span><span class="p">:</span> <span class="n">alerts</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 4.4: Data Source Manager (Open-ended)</h2>
<p>Build a multi-source data manager that can fetch data from different providers.</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4.4: Data Source Manager (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a MultiSourceDataManager class that:</span>
<span class="c1"># - Supports multiple data sources (OANDA, Yahoo, etc.)</span>
<span class="c1"># - Falls back to alternate sources if primary fails</span>
<span class="c1"># - Caches data to reduce API calls</span>
<span class="c1"># - Validates data quality from each source</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - add_source(name: str, provider: object, priority: int)</span>
<span class="c1"># - fetch_data(pair: str, timeframe: str) -&gt; pd.DataFrame</span>
<span class="c1"># - get_with_fallback(pair: str, timeframe: str) -&gt; pd.DataFrame</span>
<span class="c1"># - validate_source(name: str) -&gt; dict</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiSourceDataManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages multiple forex data sources with fallback.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;./cache&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># name -&gt; {provider, priority, status}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># (pair, timeframe) -&gt; (data, timestamp)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 1 hour cache</span>

    <span class="k">def</span> <span class="nf">add_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a data source with priority (lower = higher priority).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;provider&#39;</span><span class="p">:</span> <span class="n">provider</span><span class="p">,</span>
            <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span>
            <span class="s1">&#39;failures&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_sorted_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Get sources sorted by priority.&quot;&quot;&quot;</span>
        <span class="n">active</span> <span class="o">=</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;active&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;priority&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_check_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check if data is in cache and not expired.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestamp</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_update_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update cache with new data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[(</span><span class="n">pair</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">fetch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch data from a specific source.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sorted_sources</span><span class="p">()</span>
            <span class="n">source_name</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">sources</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">source_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source_name</span><span class="p">]</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s1">&#39;provider&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_candles</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">source</span><span class="p">[</span><span class="s1">&#39;failures&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">source</span><span class="p">[</span><span class="s1">&#39;failures&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">source</span><span class="p">[</span><span class="s1">&#39;failures&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">source</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;disabled&#39;</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">get_with_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get data with automatic fallback.&quot;&quot;&quot;</span>
        <span class="c1"># Check cache first</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_cache</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cached</span>

        <span class="c1"># Try sources in priority order</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sorted_sources</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;All sources failed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate a data source.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Source not found&#39;</span><span class="p">}</span>

        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s1">&#39;provider&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_candles</span><span class="p">(</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">source</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
                <span class="s1">&#39;sample_rows&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
                <span class="s1">&#39;failures&#39;</span><span class="p">:</span> <span class="n">source</span><span class="p">[</span><span class="s1">&#39;failures&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>


<span class="c1"># Test</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">MultiSourceDataManager</span><span class="p">()</span>

<span class="c1"># Add sources</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="s1">&#39;oanda&#39;</span><span class="p">,</span> <span class="n">OANDAClient</span><span class="p">(</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="s1">&#39;demo&#39;</span><span class="p">),</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_source</span><span class="p">(</span><span class="s1">&#39;backup&#39;</span><span class="p">,</span> <span class="n">OANDAClient</span><span class="p">(</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="s1">&#39;demo&#39;</span><span class="p">),</span> <span class="n">priority</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Fetch with fallback</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_with_fallback</span><span class="p">(</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetched </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>

<span class="c1"># Validate sources</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">manager</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_source</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 4.5: Streaming Data Aggregator (Open-ended)</h2>
<p>Build a streaming data aggregator that converts tick data to OHLC bars.</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4.5: Streaming Data Aggregator (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a StreamingAggregator class that:</span>
<span class="c1"># - Aggregates tick data into OHLC bars</span>
<span class="c1"># - Supports multiple timeframes simultaneously</span>
<span class="c1"># - Fires callbacks when bars complete</span>
<span class="c1"># - Handles partial bars correctly</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - add_timeframe(timeframe: str, callback: callable)</span>
<span class="c1"># - process_tick(tick: dict)</span>
<span class="c1"># - get_current_bar(timeframe: str) -&gt; dict</span>
<span class="c1"># - get_completed_bars(timeframe: str) -&gt; List[dict]</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StreamingAggregator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregates tick data into OHLC bars.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">TIMEFRAME_SECONDS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;M1&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">&#39;M5&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;M15&#39;</span><span class="p">:</span> <span class="mi">900</span><span class="p">,</span> <span class="s1">&#39;M30&#39;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>
        <span class="s1">&#39;H1&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span> <span class="s1">&#39;H4&#39;</span><span class="p">:</span> <span class="mi">14400</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">86400</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># timeframe -&gt; {bars, current_bar, callback}</span>

    <span class="k">def</span> <span class="nf">add_timeframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a timeframe to aggregate.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="p">[</span><span class="n">timeframe</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;seconds&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">TIMEFRAME_SECONDS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeframe</span><span class="p">,</span> <span class="mi">3600</span><span class="p">),</span>
            <span class="s1">&#39;bars&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;current_bar&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;callback&#39;</span><span class="p">:</span> <span class="n">callback</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_bar_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">seconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the bar start timestamp for a tick.&quot;&quot;&quot;</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">tick_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
        <span class="n">bar_epoch</span> <span class="o">=</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">//</span> <span class="n">seconds</span><span class="p">)</span> <span class="o">*</span> <span class="n">seconds</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">bar_epoch</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a single tick.&quot;&quot;&quot;</span>
        <span class="n">tick_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">tick</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;+00:00&#39;</span><span class="p">))</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">tf</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">bar_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bar_timestamp</span><span class="p">(</span><span class="n">tick_time</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;seconds&#39;</span><span class="p">])</span>

            <span class="c1"># Check if new bar needed</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;current_bar&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;current_bar&#39;</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">bar_time</span><span class="p">:</span>
                <span class="c1"># Complete previous bar</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;current_bar&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;current_bar&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;callback&#39;</span><span class="p">]:</span>
                        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;callback&#39;</span><span class="p">](</span><span class="n">tf</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;current_bar&#39;</span><span class="p">])</span>

                <span class="c1"># Start new bar</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;current_bar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">bar_time</span><span class="p">,</span>
                    <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">mid</span><span class="p">,</span>
                    <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">mid</span><span class="p">,</span>
                    <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">mid</span><span class="p">,</span>
                    <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">mid</span><span class="p">,</span>
                    <span class="s1">&#39;tick_count&#39;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Update current bar</span>
                <span class="n">bar</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;current_bar&#39;</span><span class="p">]</span>
                <span class="n">bar</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">mid</span><span class="p">)</span>
                <span class="n">bar</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bar</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">mid</span><span class="p">)</span>
                <span class="n">bar</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mid</span>
                <span class="n">bar</span><span class="p">[</span><span class="s1">&#39;tick_count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_current_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the current (incomplete) bar.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeframe</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="p">[</span><span class="n">timeframe</span><span class="p">][</span><span class="s1">&#39;current_bar&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_completed_bars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all completed bars.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeframe</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="p">[</span><span class="n">timeframe</span><span class="p">][</span><span class="s1">&#39;bars&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert completed bars to DataFrame.&quot;&quot;&quot;</span>
        <span class="n">bars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_completed_bars</span><span class="p">(</span><span class="n">timeframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bars</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">bars</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>


<span class="c1"># Test aggregator</span>
<span class="n">aggregator</span> <span class="o">=</span> <span class="n">StreamingAggregator</span><span class="p">()</span>

<span class="c1"># Add callback</span>
<span class="k">def</span> <span class="nf">on_bar_complete</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="n">bar</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New </span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2"> bar: O=</span><span class="si">{</span><span class="n">bar</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> H=</span><span class="si">{</span><span class="n">bar</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;L=</span><span class="si">{</span><span class="n">bar</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> C=</span><span class="si">{</span><span class="n">bar</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">aggregator</span><span class="o">.</span><span class="n">add_timeframe</span><span class="p">(</span><span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">on_bar_complete</span><span class="p">)</span>

<span class="c1"># Process some ticks</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">MockPriceStream</span><span class="p">([</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">stream</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">aggregator</span><span class="o">.</span><span class="n">process_tick</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Completed bars: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">aggregator</span><span class="o">.</span><span class="n">get_completed_bars</span><span class="p">(</span><span class="s1">&#39;M1&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current bar: </span><span class="si">{</span><span class="n">aggregator</span><span class="o">.</span><span class="n">get_current_bar</span><span class="p">(</span><span class="s1">&#39;M1&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h2>Exercise 4.6: Forex Data System (Open-ended)</h2>
<p>Build a complete forex data system that combines all the components from this module.</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4.6: Forex Data System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Create a ForexDataSystem class that:</span>
<span class="c1"># - Manages historical data downloads and storage</span>
<span class="c1"># - Provides real-time streaming with aggregation</span>
<span class="c1"># - Includes data validation and quality checks</span>
<span class="c1"># - Supports multiple instruments and timeframes</span>
<span class="c1">#</span>
<span class="c1"># Required methods:</span>
<span class="c1"># - initialize(instruments: List[str], timeframes: List[str])</span>
<span class="c1"># - download_history(start_date: datetime, end_date: datetime)</span>
<span class="c1"># - start_streaming()</span>
<span class="c1"># - stop_streaming()</span>
<span class="c1"># - get_data(instrument: str, timeframe: str) -&gt; pd.DataFrame</span>
<span class="c1"># - get_latest_price(instrument: str) -&gt; dict</span>
<span class="c1"># - health_check() -&gt; dict</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4.6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ForexDataSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete forex data management system.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;./forex_system&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">OANDAClient</span><span class="p">(</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="s1">&#39;demo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span> <span class="o">=</span> <span class="n">ForexDataManager</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span> <span class="o">=</span> <span class="n">StreamingAggregator</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_streaming</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the system.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span> <span class="o">=</span> <span class="n">timeframes</span>

        <span class="c1"># Set up aggregator</span>
        <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">timeframes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span><span class="o">.</span><span class="n">add_timeframe</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instruments</span><span class="p">)</span><span class="si">}</span><span class="s2"> instruments, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">timeframes</span><span class="p">)</span><span class="si">}</span><span class="s2"> timeframes&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">download_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download historical data.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">download_data</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start streaming prices.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_streaming</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">MockPriceStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Streaming started&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop streaming.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_streaming</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Streaming stopped&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_ticks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process streaming ticks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_streaming</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_streaming</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span><span class="o">.</span><span class="n">process_tick</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span><span class="p">[</span><span class="n">tick</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tick</span>

    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get historical data.&quot;&quot;&quot;</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_manager</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_latest_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get latest streaming price.&quot;&quot;&quot;</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check system health.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;instruments&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">),</span>
            <span class="s1">&#39;timeframes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="p">),</span>
            <span class="s1">&#39;streaming&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_streaming</span><span class="p">,</span>
            <span class="s1">&#39;latest_prices&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span><span class="p">),</span>
            <span class="s1">&#39;data_files&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.csv&#39;</span><span class="p">)))</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print system summary.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FOREX DATA SYSTEM SUMMARY&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">health</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_check</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">health</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>


<span class="c1"># Test the system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">ForexDataSystem</span><span class="p">(</span><span class="s1">&#39;./test_system&#39;</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
    <span class="n">instruments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_JPY&#39;</span><span class="p">],</span>
    <span class="n">timeframes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;M1&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Download history</span>
<span class="n">system</span><span class="o">.</span><span class="n">download_history</span><span class="p">()</span>

<span class="c1"># Process some streaming data</span>
<span class="n">system</span><span class="o">.</span><span class="n">start_streaming</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">process_ticks</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">stop_streaming</span><span class="p">()</span>

<span class="c1"># Print summary</span>
<span class="n">system</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># Get latest prices</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Latest Prices:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">]:</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_latest_price</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">price</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Forex Data System</h2>
<p>Build a production-ready forex data system combining all concepts from this module.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ProductionForexDataSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready forex data management system.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Multi-source data fetching with fallback</span>
<span class="sd">    - Historical data management with caching</span>
<span class="sd">    - Real-time streaming with tick aggregation</span>
<span class="sd">    - Data validation and quality monitoring</span>
<span class="sd">    - Health checks and status reporting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_dir&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">OANDAClient</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;account_id&#39;</span><span class="p">,</span> <span class="s1">&#39;demo&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access_token&#39;</span><span class="p">,</span> <span class="s1">&#39;demo&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="s1">&#39;practice&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">historical_data</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># (pair, tf) -&gt; DataFrame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ticks_received&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;bars_completed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;last_update&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_default_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;data_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;./forex_data_system&#39;</span><span class="p">,</span>
            <span class="s1">&#39;account_id&#39;</span><span class="p">:</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;access_token&#39;</span><span class="p">:</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="s1">&#39;practice&#39;</span><span class="p">,</span>
            <span class="s1">&#39;default_history_count&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s1">&#39;cache_ttl&#39;</span><span class="p">:</span> <span class="mi">3600</span>
        <span class="p">}</span>
    
    <span class="c1"># ==================== Initialization ====================</span>
    
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">instruments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the data system.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            instruments: List of currency pairs</span>
<span class="sd">            timeframes: List of timeframes (default: H1, H4, D)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span> <span class="o">=</span> <span class="n">timeframes</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;H4&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing Forex Data System&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Instruments: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Timeframes: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># ==================== Historical Data ====================</span>
    
    <span class="k">def</span> <span class="nf">download_historical</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">instruments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download historical data for all or specified instruments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instruments</span> <span class="o">=</span> <span class="n">instruments</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span>
        <span class="n">timeframes</span> <span class="o">=</span> <span class="n">timeframes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;default_history_count&#39;</span><span class="p">]</span>
        
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">instruments</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeframes</span><span class="p">)</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">timeframes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_candles</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">historical_data</span><span class="p">[(</span><span class="n">pair</span><span class="p">,</span> <span class="n">tf</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span>
                    
                    <span class="c1"># Save to file</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">.csv&quot;</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                    
                    <span class="n">completed</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">completed</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">] Downloaded </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> candles&quot;</span><span class="p">)</span>
                    
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Download complete: </span><span class="si">{</span><span class="n">completed</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> successful&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load_historical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load historical data (from memory or file).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check memory cache</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_data</span><span class="p">[(</span><span class="n">pair</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)]</span>
        
        <span class="c1"># Check file</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">historical_data</span><span class="p">[(</span><span class="n">pair</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">return</span> <span class="n">df</span>
        
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># ==================== Real-Time Data ====================</span>
    
    <span class="k">def</span> <span class="nf">start_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start real-time price streaming.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">MockPriceStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Streaming started for:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">stop_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop streaming.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Streaming stopped&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">process_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process streaming data for a duration.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            duration: Seconds to stream</span>
<span class="sd">            callback: Optional callback for each tick</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_streaming</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">duration</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;ticks_received&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span><span class="p">[</span><span class="n">tick</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tick</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;last_update&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_latest_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get latest price for an instrument.&quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_all_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get all latest prices as DataFrame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="c1"># ==================== Data Validation ====================</span>
    
    <span class="k">def</span> <span class="nf">validate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate data quality.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_historical</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Data not found&#39;</span><span class="p">}</span>
        
        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check for missing data</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Contains missing values&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check OHLC relationships</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;High &lt; Low in some rows&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check for large gaps</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">gaps</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">median_gap</span> <span class="o">=</span> <span class="n">gaps</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
            <span class="n">large_gaps</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaps</span> <span class="o">&gt;</span> <span class="n">median_gap</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">large_gaps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">large_gaps</span><span class="si">}</span><span class="s1"> large gaps (weekends expected)&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;timeframe&#39;</span><span class="p">:</span> <span class="n">timeframe</span><span class="p">,</span>
            <span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="s1">&#39;date_range&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">issues</span> <span class="k">if</span> <span class="n">issues</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;No issues&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="c1"># ==================== Health &amp; Status ====================</span>
    
    <span class="k">def</span> <span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform system health check.&quot;&quot;&quot;</span>
        <span class="n">data_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.csv&#39;</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="s1">&#39;degraded&#39;</span><span class="p">,</span>
            <span class="s1">&#39;streaming&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">,</span>
            <span class="s1">&#39;instruments&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">),</span>
            <span class="s1">&#39;timeframes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="p">),</span>
            <span class="s1">&#39;data_files&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_files</span><span class="p">),</span>
            <span class="s1">&#39;cached_datasets&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">historical_data</span><span class="p">),</span>
            <span class="s1">&#39;latest_prices&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span><span class="p">),</span>
            <span class="s1">&#39;ticks_received&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;ticks_received&#39;</span><span class="p">],</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">],</span>
            <span class="s1">&#39;last_update&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;last_update&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">print_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print detailed system status.&quot;&quot;&quot;</span>
        <span class="n">health</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_check</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FOREX DATA SYSTEM STATUS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System Health: </span><span class="si">{</span><span class="n">health</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Streaming: </span><span class="si">{</span><span class="s1">&#39;Active&#39;</span> <span class="k">if</span> <span class="n">health</span><span class="p">[</span><span class="s1">&#39;streaming&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Stopped&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configuration:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Instruments: </span><span class="si">{</span><span class="n">health</span><span class="p">[</span><span class="s1">&#39;instruments&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Timeframes: </span><span class="si">{</span><span class="n">health</span><span class="p">[</span><span class="s1">&#39;timeframes&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Data Files: </span><span class="si">{</span><span class="n">health</span><span class="p">[</span><span class="s1">&#39;data_files&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cached Datasets: </span><span class="si">{</span><span class="n">health</span><span class="p">[</span><span class="s1">&#39;cached_datasets&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Latest Prices: </span><span class="si">{</span><span class="n">health</span><span class="p">[</span><span class="s1">&#39;latest_prices&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Metrics:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Ticks Received: </span><span class="si">{</span><span class="n">health</span><span class="p">[</span><span class="s1">&#39;ticks_received&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Errors: </span><span class="si">{</span><span class="n">health</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Last Update: </span><span class="si">{</span><span class="n">health</span><span class="p">[</span><span class="s1">&#39;last_update&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Latest Prices:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_prices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> (spread: </span><span class="si">{</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;spread_pips&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> pips)&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate the Production Forex Data System</span>

<span class="c1"># Create and configure system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">ProductionForexDataSystem</span><span class="p">({</span>
    <span class="s1">&#39;data_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;./production_forex_data&#39;</span><span class="p">,</span>
    <span class="s1">&#39;account_id&#39;</span><span class="p">:</span> <span class="s1">&#39;demo-account&#39;</span><span class="p">,</span>
    <span class="s1">&#39;access_token&#39;</span><span class="p">:</span> <span class="s1">&#39;demo-token&#39;</span><span class="p">,</span>
    <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="s1">&#39;practice&#39;</span><span class="p">,</span>
    <span class="s1">&#39;default_history_count&#39;</span><span class="p">:</span> <span class="mi">500</span>
<span class="p">})</span>

<span class="c1"># Initialize</span>
<span class="n">system</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
    <span class="n">instruments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD_USD&#39;</span><span class="p">],</span>
    <span class="n">timeframes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="s1">&#39;H4&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Download historical data</span>
<span class="n">system</span><span class="o">.</span><span class="n">download_historical</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Validate data quality</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data Validation Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">]:</span>
    <span class="n">validation</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">validate_data</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> H1:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Valid: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Rows: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Issues: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Start streaming and process for a few seconds</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processing live stream...&quot;</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">start_streaming</span><span class="p">()</span>

<span class="c1"># Process with a simple callback</span>
<span class="k">def</span> <span class="nf">print_tick</span><span class="p">(</span><span class="n">tick</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">tick</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">12</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">tick</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">tick</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">system</span><span class="o">.</span><span class="n">process_stream</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">print_tick</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">stop_streaming</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Print final status</span>
<span class="n">system</span><span class="o">.</span><span class="n">print_status</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ul>
<li><strong>Multiple data sources</strong> are available for forex: OANDA, FXCM, Alpha Vantage, Yahoo Finance</li>
<li><strong>OANDA API</strong> provides free access to historical and real-time forex data via REST and streaming endpoints</li>
<li><strong>Historical data management</strong> requires proper storage, validation, and update mechanisms</li>
<li><strong>Real-time streaming</strong> enables live trading but requires tick aggregation for bar-based analysis</li>
<li><strong>Data validation</strong> is critical - check for gaps, invalid OHLC relationships, and missing values</li>
<li><strong>Production systems</strong> need health checks, error handling, and fallback data sources</li>
<li><strong>Caching</strong> reduces API calls and improves performance for frequently accessed data</li>
</ul>
<hr />
<p><strong>Next: Part 2 - Analysis &amp; Strategies</strong></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="5"><div class="md-cell module-header"><h1>Module 5: Technical Analysis for Forex &amp; Futures</h1>
<p><strong>Part 2: Analysis &amp; Strategies</strong></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ul>
<li>Identify and trade chart patterns in forex markets</li>
<li>Build forex-specific indicators like currency strength meters</li>
<li>Apply multi-timeframe analysis for better entries</li>
<li>Trade using pure price action without indicators</li>
</ul>
<h2>Prerequisites</h2>
<ul>
<li>Modules 1-4 (Forex/Futures fundamentals, data tools)</li>
<li>Basic understanding of candlestick charts</li>
<li>Python pandas and numpy proficiency</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>5.1 Forex Chart Patterns</h2>
<p>Chart patterns are visual formations that help identify potential price movements. In forex, these patterns are particularly reliable due to high liquidity.</p></div>
<div class="md-cell"><h3>Support and Resistance Levels</h3>
<p>Support and resistance are price levels where buying or selling pressure historically reverses price direction.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SupportResistanceFinder</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Identifies support and resistance levels from price data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">touch_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touch_threshold</span> <span class="o">=</span> <span class="n">touch_threshold</span>
    
    <span class="k">def</span> <span class="nf">find_pivot_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Find swing highs and lows as potential S/R levels.&quot;&quot;&quot;</span>
        <span class="n">highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lows</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">):</span>
            <span class="n">window_high</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">window_high</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                <span class="n">highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
            <span class="n">window_low</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">window_low</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
                <span class="n">lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;resistance&#39;</span><span class="p">:</span> <span class="n">highs</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">:</span> <span class="n">lows</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">cluster_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">levels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.002</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Cluster nearby levels into single stronger levels.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">levels</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="n">sorted_levels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[[</span><span class="n">sorted_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
        
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">sorted_levels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">-</span> <span class="n">clusters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">clusters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="n">clusters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">level</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">count_touches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Count how many times price touched a level.&quot;&quot;&quot;</span>
        <span class="n">touches</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">touch_threshold</span><span class="p">:</span>
                <span class="n">touches</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">touch_threshold</span><span class="p">:</span>
                <span class="n">touches</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">touches</span>
    
    <span class="k">def</span> <span class="nf">get_key_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">min_touches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Get key S/R levels with touch counts.&quot;&quot;&quot;</span>
        <span class="n">pivots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_pivot_points</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="n">resistance_clustered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_levels</span><span class="p">(</span><span class="n">pivots</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">])</span>
        <span class="n">support_clustered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_levels</span><span class="p">(</span><span class="n">pivots</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">])</span>
        
        <span class="n">key_levels</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resistance&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;support&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">resistance_clustered</span><span class="p">:</span>
            <span class="n">touches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_touches</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">touches</span> <span class="o">&gt;=</span> <span class="n">min_touches</span><span class="p">:</span>
                <span class="n">key_levels</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span><span class="p">,</span>
                    <span class="s1">&#39;touches&#39;</span><span class="p">:</span> <span class="n">touches</span><span class="p">,</span>
                    <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="s1">&#39;strong&#39;</span> <span class="k">if</span> <span class="n">touches</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="s1">&#39;moderate&#39;</span>
                <span class="p">})</span>
        
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">support_clustered</span><span class="p">:</span>
            <span class="n">touches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_touches</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">touches</span> <span class="o">&gt;=</span> <span class="n">min_touches</span><span class="p">:</span>
                <span class="n">key_levels</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span><span class="p">,</span>
                    <span class="s1">&#39;touches&#39;</span><span class="p">:</span> <span class="n">touches</span><span class="p">,</span>
                    <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="s1">&#39;strong&#39;</span> <span class="k">if</span> <span class="n">touches</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="s1">&#39;moderate&#39;</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">key_levels</span>


<span class="c1"># Generate demo data</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;4h&#39;</span><span class="p">)</span>
<span class="n">base_price</span> <span class="o">=</span> <span class="mf">1.0850</span>
<span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_price</span><span class="p">]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">199</span><span class="p">):</span>
    <span class="n">change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0950</span><span class="p">:</span>
        <span class="n">change</span> <span class="o">-=</span> <span class="mf">0.001</span>
    <span class="k">elif</span> <span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0750</span><span class="p">:</span>
        <span class="n">change</span> <span class="o">+=</span> <span class="mf">0.001</span>
    <span class="n">prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">change</span><span class="p">)</span>

<span class="n">demo_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
    <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="p">,</span>
    <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.003</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">],</span>
    <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.003</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">],</span>
    <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">]</span>
<span class="p">})</span>

<span class="n">sr_finder</span> <span class="o">=</span> <span class="n">SupportResistanceFinder</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">key_levels</span> <span class="o">=</span> <span class="n">sr_finder</span><span class="o">.</span><span class="n">get_key_levels</span><span class="p">(</span><span class="n">demo_df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Key Support Levels:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">key_levels</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;touches&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> touches (</span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Key Resistance Levels:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">key_levels</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;touches&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> touches (</span><span class="si">{</span><span class="n">level</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Trend Line Detection</h3>
<p>Trend lines connect swing highs (downtrend) or swing lows (uptrend) to identify trend direction and potential breakout points.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TrendLineDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Automatically detect and validate trend lines.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_touches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_touches</span> <span class="o">=</span> <span class="n">min_touches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span>
    
    <span class="k">def</span> <span class="nf">find_swing_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Identify swing highs and lows.&quot;&quot;&quot;</span>
        <span class="n">swing_highs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">swing_lows</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">lookback</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">lookback</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                <span class="n">swing_highs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]})</span>
            
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">lookback</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
                <span class="n">swing_lows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]})</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;highs&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">swing_highs</span><span class="p">),</span>
            <span class="s1">&#39;lows&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">swing_lows</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">fit_trend_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Fit a trend line through points using linear regression.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">intercept</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">intercept</span>
        <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">r_squared</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ss_res</span> <span class="o">/</span> <span class="n">ss_tot</span><span class="p">)</span> <span class="k">if</span> <span class="n">ss_tot</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;slope&#39;</span><span class="p">:</span> <span class="n">slope</span><span class="p">,</span>
            <span class="s1">&#39;intercept&#39;</span><span class="p">:</span> <span class="n">intercept</span><span class="p">,</span>
            <span class="s1">&#39;r_squared&#39;</span><span class="p">:</span> <span class="n">r_squared</span><span class="p">,</span>
            <span class="s1">&#39;points_used&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;up&#39;</span> <span class="k">if</span> <span class="n">slope</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;down&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">detect_trend_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Detect both uptrend and downtrend lines.&quot;&quot;&quot;</span>
        <span class="n">swings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_swing_points</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">trend_lines</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uptrend&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;downtrend&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">swings</span><span class="p">[</span><span class="s1">&#39;lows&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_touches</span><span class="p">:</span>
            <span class="n">recent_lows</span> <span class="o">=</span> <span class="n">swings</span><span class="p">[</span><span class="s1">&#39;lows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">trendline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_trend_line</span><span class="p">(</span><span class="n">recent_lows</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trendline</span> <span class="ow">and</span> <span class="n">trendline</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">trendline</span><span class="p">[</span><span class="s1">&#39;r_squared&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
                <span class="n">trend_lines</span><span class="p">[</span><span class="s1">&#39;uptrend&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trendline</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">swings</span><span class="p">[</span><span class="s1">&#39;highs&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_touches</span><span class="p">:</span>
            <span class="n">recent_highs</span> <span class="o">=</span> <span class="n">swings</span><span class="p">[</span><span class="s1">&#39;highs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">trendline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_trend_line</span><span class="p">(</span><span class="n">recent_highs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trendline</span> <span class="ow">and</span> <span class="n">trendline</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">trendline</span><span class="p">[</span><span class="s1">&#39;r_squared&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
                <span class="n">trend_lines</span><span class="p">[</span><span class="s1">&#39;downtrend&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trendline</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">trend_lines</span>


<span class="c1"># Demo</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">TrendLineDetector</span><span class="p">()</span>
<span class="n">trend_lines</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">detect_trend_lines</span><span class="p">(</span><span class="n">demo_df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detected Trend Lines:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">direction</span><span class="p">,</span> <span class="n">lines</span> <span class="ow">in</span> <span class="n">trend_lines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">direction</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">: slope=</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, RÂ²=</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;r_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Chart Pattern Recognition</h3>
<p>Common patterns include head &amp; shoulders, double tops/bottoms, triangles, and flags.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ChartPatternRecognizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Recognize common chart patterns in price data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="n">tolerance</span>
    
    <span class="k">def</span> <span class="nf">find_double_top</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Detect double top pattern (bearish reversal).&quot;&quot;&quot;</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">lookback</span><span class="p">)</span>
        <span class="n">highs</span> <span class="o">=</span> <span class="n">recent</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="n">peak_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">highs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">highs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">highs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]):</span>
                <span class="n">peak_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_indices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">peak1_idx</span><span class="p">,</span> <span class="n">peak2_idx</span> <span class="o">=</span> <span class="n">peak_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">peak_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">peak1</span><span class="p">,</span> <span class="n">peak2</span> <span class="o">=</span> <span class="n">highs</span><span class="p">[</span><span class="n">peak1_idx</span><span class="p">],</span> <span class="n">highs</span><span class="p">[</span><span class="n">peak2_idx</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">peak1</span> <span class="o">-</span> <span class="n">peak2</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">:</span>
                <span class="n">neckline</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">recent</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">peak1_idx</span><span class="p">:</span><span class="n">peak2_idx</span><span class="p">])</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;double_top&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;peak1&#39;</span><span class="p">:</span> <span class="n">peak1</span><span class="p">,</span>
                    <span class="s1">&#39;peak2&#39;</span><span class="p">:</span> <span class="n">peak2</span><span class="p">,</span>
                    <span class="s1">&#39;neckline&#39;</span><span class="p">:</span> <span class="n">neckline</span><span class="p">,</span>
                    <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">neckline</span> <span class="o">-</span> <span class="p">(</span><span class="n">peak1</span> <span class="o">-</span> <span class="n">neckline</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">find_double_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Detect double bottom pattern (bullish reversal).&quot;&quot;&quot;</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">lookback</span><span class="p">)</span>
        <span class="n">lows</span> <span class="o">=</span> <span class="n">recent</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="n">trough_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lows</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">lows</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]):</span>
                <span class="n">trough_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trough_indices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">trough1_idx</span><span class="p">,</span> <span class="n">trough2_idx</span> <span class="o">=</span> <span class="n">trough_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">trough_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">trough1</span><span class="p">,</span> <span class="n">trough2</span> <span class="o">=</span> <span class="n">lows</span><span class="p">[</span><span class="n">trough1_idx</span><span class="p">],</span> <span class="n">lows</span><span class="p">[</span><span class="n">trough2_idx</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">trough1</span> <span class="o">-</span> <span class="n">trough2</span><span class="p">)</span> <span class="o">/</span> <span class="n">trough1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span><span class="p">:</span>
                <span class="n">neckline</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">recent</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">trough1_idx</span><span class="p">:</span><span class="n">trough2_idx</span><span class="p">])</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;double_bottom&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;trough1&#39;</span><span class="p">:</span> <span class="n">trough1</span><span class="p">,</span>
                    <span class="s1">&#39;trough2&#39;</span><span class="p">:</span> <span class="n">trough2</span><span class="p">,</span>
                    <span class="s1">&#39;neckline&#39;</span><span class="p">:</span> <span class="n">neckline</span><span class="p">,</span>
                    <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">neckline</span> <span class="o">+</span> <span class="p">(</span><span class="n">neckline</span> <span class="o">-</span> <span class="n">trough1</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">find_triangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Detect triangle patterns.&quot;&quot;&quot;</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">lookback</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">recent</span><span class="p">))</span>
        <span class="n">high_slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">recent</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">low_slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">recent</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">high_slope</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.0001</span> <span class="ow">and</span> <span class="n">low_slope</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">pattern_type</span> <span class="o">=</span> <span class="s1">&#39;symmetrical&#39;</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high_slope</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0001</span> <span class="ow">and</span> <span class="n">low_slope</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">pattern_type</span> <span class="o">=</span> <span class="s1">&#39;ascending&#39;</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">high_slope</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.0001</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low_slope</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">pattern_type</span> <span class="o">=</span> <span class="s1">&#39;descending&#39;</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pattern_type</span><span class="si">}</span><span class="s1">_triangle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;high_slope&#39;</span><span class="p">:</span> <span class="n">high_slope</span><span class="p">,</span>
            <span class="s1">&#39;low_slope&#39;</span><span class="p">:</span> <span class="n">low_slope</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">scan_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Scan for all patterns.&quot;&quot;&quot;</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_double_top</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">db</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_double_bottom</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tri</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_triangle</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tri</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">patterns</span>


<span class="c1"># Demo</span>
<span class="n">pattern_recognizer</span> <span class="o">=</span> <span class="n">ChartPatternRecognizer</span><span class="p">()</span>
<span class="n">patterns</span> <span class="o">=</span> <span class="n">pattern_recognizer</span><span class="o">.</span><span class="n">scan_patterns</span><span class="p">(</span><span class="n">demo_df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detected Patterns:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> signal&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>5.2 Forex-Specific Indicators</h2>
<p>Forex markets have unique indicators not commonly used in equity markets.</p></div>
<div class="md-cell"><h3>Currency Strength Meter</h3>
<p>Measures the relative strength of individual currencies across multiple pairs.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CurrencyStrengthMeter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate relative strength of currencies.&quot;&quot;&quot;</span>
    
    <span class="n">MAJOR_CURRENCIES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]</span>
    
    <span class="n">PAIR_MAPPING</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">),</span>
        <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">),</span>
        <span class="s1">&#39;USDJPY&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">),</span>
        <span class="s1">&#39;AUDUSD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">),</span>
        <span class="s1">&#39;USDCAD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">),</span>
        <span class="s1">&#39;USDCHF&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">),</span>
        <span class="s1">&#39;NZDUSD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;NZD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">),</span>
        <span class="s1">&#39;EURGBP&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">),</span>
        <span class="s1">&#39;EURJPY&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">),</span>
        <span class="s1">&#39;GBPJPY&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">),</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
    
    <span class="k">def</span> <span class="nf">calculate_pair_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate percentage change over period.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">calculate_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate strength score for each currency.&quot;&quot;&quot;</span>
        <span class="n">strength</span> <span class="o">=</span> <span class="p">{</span><span class="n">currency</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAJOR_CURRENCIES</span><span class="p">}</span>
        <span class="n">count</span> <span class="o">=</span> <span class="p">{</span><span class="n">currency</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAJOR_CURRENCIES</span><span class="p">}</span>
        
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">prices</span> <span class="ow">in</span> <span class="n">pair_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAIR_MAPPING</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">base</span><span class="p">,</span> <span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAIR_MAPPING</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span>
            <span class="n">change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_pair_change</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
            
            <span class="n">strength</span><span class="p">[</span><span class="n">base</span><span class="p">]</span> <span class="o">+=</span> <span class="n">change</span>
            <span class="n">count</span><span class="p">[</span><span class="n">base</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">strength</span><span class="p">[</span><span class="n">quote</span><span class="p">]</span> <span class="o">-=</span> <span class="n">change</span>
            <span class="n">count</span><span class="p">[</span><span class="n">quote</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAJOR_CURRENCIES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">strength</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">/=</span> <span class="n">count</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">strength</span>
    
    <span class="k">def</span> <span class="nf">get_rankings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strength</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Rank currencies from strongest to weakest.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">strength</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_best_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strength</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find best pairs to trade (strong vs weak currencies).&quot;&quot;&quot;</span>
        <span class="n">rankings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rankings</span><span class="p">(</span><span class="n">strength</span><span class="p">)</span>
        <span class="n">strongest</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rankings</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]]</span>
        <span class="n">weakest</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rankings</span><span class="p">[</span><span class="o">-</span><span class="n">top_n</span><span class="p">:]]</span>
        
        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">strong</span> <span class="ow">in</span> <span class="n">strongest</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">weak</span> <span class="ow">in</span> <span class="n">weakest</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAIR_MAPPING</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="n">strong</span> <span class="ow">and</span> <span class="n">quote</span> <span class="o">==</span> <span class="n">weak</span><span class="p">:</span>
                        <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;LONG&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;strength_diff&#39;</span><span class="p">:</span> <span class="n">strength</span><span class="p">[</span><span class="n">strong</span><span class="p">]</span> <span class="o">-</span> <span class="n">strength</span><span class="p">[</span><span class="n">weak</span><span class="p">]</span>
                        <span class="p">})</span>
                    <span class="k">elif</span> <span class="n">base</span> <span class="o">==</span> <span class="n">weak</span> <span class="ow">and</span> <span class="n">quote</span> <span class="o">==</span> <span class="n">strong</span><span class="p">:</span>
                        <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;SHORT&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;strength_diff&#39;</span><span class="p">:</span> <span class="n">strength</span><span class="p">[</span><span class="n">strong</span><span class="p">]</span> <span class="o">-</span> <span class="n">strength</span><span class="p">[</span><span class="n">weak</span><span class="p">]</span>
                        <span class="p">})</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">opportunities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;strength_diff&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># Demo</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">pair_data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">CurrencyStrengthMeter</span><span class="o">.</span><span class="n">PAIR_MAPPING</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">base_price</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="mf">110.0</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_price</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
        <span class="n">prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">)))</span>
    <span class="n">pair_data</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

<span class="n">csm</span> <span class="o">=</span> <span class="n">CurrencyStrengthMeter</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">strength</span> <span class="o">=</span> <span class="n">csm</span><span class="o">.</span><span class="n">calculate_strength</span><span class="p">(</span><span class="n">pair_data</span><span class="p">)</span>
<span class="n">rankings</span> <span class="o">=</span> <span class="n">csm</span><span class="o">.</span><span class="n">get_rankings</span><span class="p">(</span><span class="n">strength</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Currency Strength Rankings:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">rankings</span><span class="p">:</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">+.3f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best Trading Opportunities:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">opp</span> <span class="ow">in</span> <span class="n">csm</span><span class="o">.</span><span class="n">get_best_pairs</span><span class="p">(</span><span class="n">strength</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: strength diff = </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;strength_diff&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Pivot Points</h3>
<p>Pivot points are significant levels calculated from prior period's high, low, and close. Very popular in forex day trading.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">PivotPointCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate various pivot point types.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">standard_pivots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate standard (floor) pivot points.&quot;&quot;&quot;</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;R3&#39;</span><span class="p">:</span> <span class="n">high</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">pp</span> <span class="o">-</span> <span class="n">low</span><span class="p">),</span>
            <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">pp</span> <span class="o">+</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">),</span>
            <span class="s1">&#39;R1&#39;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pp</span> <span class="o">-</span> <span class="n">low</span><span class="p">,</span>
            <span class="s1">&#39;PP&#39;</span><span class="p">:</span> <span class="n">pp</span><span class="p">,</span>
            <span class="s1">&#39;S1&#39;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pp</span> <span class="o">-</span> <span class="n">high</span><span class="p">,</span>
            <span class="s1">&#39;S2&#39;</span><span class="p">:</span> <span class="n">pp</span> <span class="o">-</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">),</span>
            <span class="s1">&#39;S3&#39;</span><span class="p">:</span> <span class="n">low</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">pp</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">fibonacci_pivots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Fibonacci pivot points.&quot;&quot;&quot;</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="n">range_hl</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;R3&#39;</span><span class="p">:</span> <span class="n">pp</span> <span class="o">+</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">1.000</span><span class="p">,</span>
            <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">pp</span> <span class="o">+</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">0.618</span><span class="p">,</span>
            <span class="s1">&#39;R1&#39;</span><span class="p">:</span> <span class="n">pp</span> <span class="o">+</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">0.382</span><span class="p">,</span>
            <span class="s1">&#39;PP&#39;</span><span class="p">:</span> <span class="n">pp</span><span class="p">,</span>
            <span class="s1">&#39;S1&#39;</span><span class="p">:</span> <span class="n">pp</span> <span class="o">-</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">0.382</span><span class="p">,</span>
            <span class="s1">&#39;S2&#39;</span><span class="p">:</span> <span class="n">pp</span> <span class="o">-</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">0.618</span><span class="p">,</span>
            <span class="s1">&#39;S3&#39;</span><span class="p">:</span> <span class="n">pp</span> <span class="o">-</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">1.000</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">camarilla_pivots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Camarilla pivot points.&quot;&quot;&quot;</span>
        <span class="n">range_hl</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;R4&#39;</span><span class="p">:</span> <span class="n">close</span> <span class="o">+</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;R3&#39;</span><span class="p">:</span> <span class="n">close</span> <span class="o">+</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">close</span> <span class="o">+</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;R1&#39;</span><span class="p">:</span> <span class="n">close</span> <span class="o">+</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span>
            <span class="s1">&#39;PP&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;S1&#39;</span><span class="p">:</span> <span class="n">close</span> <span class="o">-</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span>
            <span class="s1">&#39;S2&#39;</span><span class="p">:</span> <span class="n">close</span> <span class="o">-</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span>
            <span class="s1">&#39;S3&#39;</span><span class="p">:</span> <span class="n">close</span> <span class="o">-</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;S4&#39;</span><span class="p">:</span> <span class="n">close</span> <span class="o">-</span> <span class="n">range_hl</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="p">}</span>


<span class="c1"># Demo</span>
<span class="n">pivot_calc</span> <span class="o">=</span> <span class="n">PivotPointCalculator</span><span class="p">()</span>

<span class="n">yesterday_high</span> <span class="o">=</span> <span class="mf">1.0920</span>
<span class="n">yesterday_low</span> <span class="o">=</span> <span class="mf">1.0845</span>
<span class="n">yesterday_close</span> <span class="o">=</span> <span class="mf">1.0878</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Standard Pivot Points:&quot;</span><span class="p">)</span>
<span class="n">std_pivots</span> <span class="o">=</span> <span class="n">pivot_calc</span><span class="o">.</span><span class="n">standard_pivots</span><span class="p">(</span><span class="n">yesterday_high</span><span class="p">,</span> <span class="n">yesterday_low</span><span class="p">,</span> <span class="n">yesterday_close</span><span class="p">)</span>
<span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">std_pivots</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fibonacci Pivot Points:&quot;</span><span class="p">)</span>
<span class="n">fib_pivots</span> <span class="o">=</span> <span class="n">pivot_calc</span><span class="o">.</span><span class="n">fibonacci_pivots</span><span class="p">(</span><span class="n">yesterday_high</span><span class="p">,</span> <span class="n">yesterday_low</span><span class="p">,</span> <span class="n">yesterday_close</span><span class="p">)</span>
<span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">fib_pivots</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Fibonacci Retracements and Extensions</h3>
<p>Fibonacci levels are heavily used in forex for identifying potential reversal zones and profit targets.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">FibonacciAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate Fibonacci retracements and extensions.&quot;&quot;&quot;</span>
    
    <span class="n">RETRACEMENT_LEVELS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.236</span><span class="p">,</span> <span class="mf">0.382</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.618</span><span class="p">,</span> <span class="mf">0.786</span><span class="p">]</span>
    <span class="n">EXTENSION_LEVELS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.272</span><span class="p">,</span> <span class="mf">1.618</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.618</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">calculate_retracements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">swing_high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">swing_low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                               <span class="n">trend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Fibonacci retracement levels.&quot;&quot;&quot;</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">swing_high</span> <span class="o">-</span> <span class="n">swing_low</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">fib</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RETRACEMENT_LEVELS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
                <span class="n">levels</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fib</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">swing_high</span> <span class="o">-</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">fib</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">levels</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fib</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">swing_low</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">fib</span>
        
        <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;0.0%&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">swing_high</span> <span class="k">if</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span> <span class="k">else</span> <span class="n">swing_low</span>
        <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;100.0%&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">swing_low</span> <span class="k">if</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span> <span class="k">else</span> <span class="n">swing_high</span>
        
        <span class="k">return</span> <span class="n">levels</span>
    
    <span class="k">def</span> <span class="nf">calculate_extensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">swing_high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">swing_low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">retracement_point</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">trend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Fibonacci extension levels for profit targets.&quot;&quot;&quot;</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">swing_high</span> <span class="o">-</span> <span class="n">swing_low</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">fib</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXTENSION_LEVELS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
                <span class="n">levels</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fib</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retracement_point</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">fib</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">levels</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fib</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retracement_point</span> <span class="o">-</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">fib</span>
        
        <span class="k">return</span> <span class="n">levels</span>


<span class="c1"># Demo</span>
<span class="n">fib_analyzer</span> <span class="o">=</span> <span class="n">FibonacciAnalyzer</span><span class="p">()</span>

<span class="n">swing_low</span> <span class="o">=</span> <span class="mf">1.0750</span>
<span class="n">swing_high</span> <span class="o">=</span> <span class="mf">1.0950</span>

<span class="n">retracements</span> <span class="o">=</span> <span class="n">fib_analyzer</span><span class="o">.</span><span class="n">calculate_retracements</span><span class="p">(</span><span class="n">swing_high</span><span class="p">,</span> <span class="n">swing_low</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fibonacci Retracements (Uptrend):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">retracements</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">bounce_point</span> <span class="o">=</span> <span class="n">retracements</span><span class="p">[</span><span class="s1">&#39;61.8%&#39;</span><span class="p">]</span>
<span class="n">extensions</span> <span class="o">=</span> <span class="n">fib_analyzer</span><span class="o">.</span><span class="n">calculate_extensions</span><span class="p">(</span><span class="n">swing_high</span><span class="p">,</span> <span class="n">swing_low</span><span class="p">,</span> <span class="n">bounce_point</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fibonacci Extensions (from bounce at </span><span class="si">{</span><span class="n">bounce_point</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">price</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">extensions</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>5.3 Multi-Timeframe Analysis</h2>
<p>Multi-timeframe analysis (MTF) uses multiple chart timeframes to identify high-probability trades by aligning trend direction across timeframes.</p></div>
<div class="md-cell"><h3>Top-Down Approach</h3>
<p>Start with higher timeframes for trend direction, then drill down for entries.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MultiTimeframeAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze price action across multiple timeframes.&quot;&quot;&quot;</span>
    
    <span class="n">TIMEFRAME_HIERARCHY</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;4h&#39;</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="s1">&#39;15min&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">calculate_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">ma_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine trend using moving average.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ma_period</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>
        
        <span class="n">ma</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">ma_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">current_price</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_ma</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ma_slope</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">current_price</span> <span class="o">&gt;</span> <span class="n">current_ma</span> <span class="ow">and</span> <span class="n">ma_slope</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">current_price</span> <span class="o">&lt;</span> <span class="n">current_ma</span> <span class="ow">and</span> <span class="n">ma_slope</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;neutral&#39;</span>
    
    <span class="k">def</span> <span class="nf">analyze_timeframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Analyze trend across multiple timeframes.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">base_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">base_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">base_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">timeframes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;4h&#39;</span><span class="p">:</span> <span class="s1">&#39;4h&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">}</span>
        
        <span class="k">for</span> <span class="n">tf_name</span><span class="p">,</span> <span class="n">resample_rule</span> <span class="ow">in</span> <span class="n">timeframes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tf_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">resample_rule</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
                    <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="s1">&#39;last&#39;</span>
                <span class="p">})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                
                <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_trend</span><span class="p">(</span><span class="n">tf_data</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="n">tf_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">trend</span><span class="p">,</span>
                    <span class="s1">&#39;last_close&#39;</span><span class="p">:</span> <span class="n">tf_data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tf_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">tf_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;last_close&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">get_alignment_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate how aligned the timeframes are.&quot;&quot;&quot;</span>
        <span class="n">trends</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trends</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;aligned&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        
        <span class="n">bullish_count</span> <span class="o">=</span> <span class="n">trends</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;bullish&#39;</span><span class="p">)</span>
        <span class="n">bearish_count</span> <span class="o">=</span> <span class="n">trends</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;bearish&#39;</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trends</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">bullish_count</span> <span class="o">==</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;aligned&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">bearish_count</span> <span class="o">==</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;aligned&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">bullish_count</span> <span class="o">&gt;</span> <span class="n">bearish_count</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">bullish_count</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;aligned&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">bearish_count</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;aligned&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>


<span class="c1"># Demo</span>
<span class="n">mtf</span> <span class="o">=</span> <span class="n">MultiTimeframeAnalyzer</span><span class="p">()</span>
<span class="n">analysis</span> <span class="o">=</span> <span class="n">mtf</span><span class="o">.</span><span class="n">analyze_timeframes</span><span class="p">(</span><span class="n">demo_df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multi-Timeframe Analysis:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tf</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">alignment</span> <span class="o">=</span> <span class="n">mtf</span><span class="o">.</span><span class="n">get_alignment_score</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Alignment: </span><span class="si">{</span><span class="n">alignment</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">alignment</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fully Aligned: </span><span class="si">{</span><span class="n">alignment</span><span class="p">[</span><span class="s1">&#39;aligned&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>5.4 Price Action Trading</h2>
<p>Price action trading focuses on raw price movements without indicators, using candlestick patterns and key levels.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CandlestickPatterns</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Identify key candlestick patterns.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body_threshold</span> <span class="o">=</span> <span class="n">body_threshold</span>
    
    <span class="k">def</span> <span class="nf">get_candle_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Extract candle properties.&quot;&quot;&quot;</span>
        <span class="n">open_p</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        
        <span class="n">range_size</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
        <span class="n">body_size</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">close</span> <span class="o">-</span> <span class="n">open_p</span><span class="p">)</span>
        <span class="n">upper_wick</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">open_p</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
        <span class="n">lower_wick</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">open_p</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span> <span class="o">-</span> <span class="n">low</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;bullish&#39;</span><span class="p">:</span> <span class="n">close</span> <span class="o">&gt;</span> <span class="n">open_p</span><span class="p">,</span>
            <span class="s1">&#39;body_size&#39;</span><span class="p">:</span> <span class="n">body_size</span><span class="p">,</span>
            <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="n">range_size</span><span class="p">,</span>
            <span class="s1">&#39;body_pct&#39;</span><span class="p">:</span> <span class="n">body_size</span> <span class="o">/</span> <span class="n">range_size</span> <span class="k">if</span> <span class="n">range_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;upper_wick_pct&#39;</span><span class="p">:</span> <span class="n">upper_wick</span> <span class="o">/</span> <span class="n">range_size</span> <span class="k">if</span> <span class="n">range_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;lower_wick_pct&#39;</span><span class="p">:</span> <span class="n">lower_wick</span> <span class="o">/</span> <span class="n">range_size</span> <span class="k">if</span> <span class="n">range_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">is_doji</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for doji (indecision).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;body_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span>
    
    <span class="k">def</span> <span class="nf">is_hammer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for hammer/hanging man.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;lower_wick_pct&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="ow">and</span>
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;upper_wick_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="ow">and</span>
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;body_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">is_shooting_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for shooting star/inverted hammer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;upper_wick_pct&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="ow">and</span>
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;lower_wick_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="ow">and</span>
                <span class="n">props</span><span class="p">[</span><span class="s1">&#39;body_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">scan_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Scan for patterns in recent candles.&quot;&quot;&quot;</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">lookback</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_candle_properties</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_doji</span><span class="p">(</span><span class="n">props</span><span class="p">):</span>
                <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;doji&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;reversal_warning&#39;</span><span class="p">})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_hammer</span><span class="p">(</span><span class="n">props</span><span class="p">):</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">if</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;bullish&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;potential_bullish&#39;</span>
                <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;hammer&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shooting_star</span><span class="p">(</span><span class="n">props</span><span class="p">):</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;bullish&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;potential_bearish&#39;</span>
                <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;shooting_star&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">patterns</span>


<span class="c1"># Demo</span>
<span class="n">candle_patterns</span> <span class="o">=</span> <span class="n">CandlestickPatterns</span><span class="p">()</span>
<span class="n">patterns</span> <span class="o">=</span> <span class="n">candle_patterns</span><span class="o">.</span><span class="n">scan_patterns</span><span class="p">(</span><span class="n">demo_df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recent Candlestick Patterns:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bar </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2></div>
<div class="md-cell"><h3>Exercise 1: Support/Resistance Level Finder (Guided)</h3>
<p>Complete the <code>EnhancedSRFinder</code> class that identifies support and resistance levels and determines if they're currently being tested.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">EnhancedSRFinder</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Enhanced support/resistance finder with level testing detection.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">proximity_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.002</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proximity_pct</span> <span class="o">=</span> <span class="n">proximity_pct</span>
    
    <span class="k">def</span> <span class="nf">identify_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Identify key S/R levels from swing points.&quot;&quot;&quot;</span>
        <span class="n">resistance_levels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">support_levels</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">):</span>
            <span class="n">window_high</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">______</span><span class="p">():</span>
                <span class="n">resistance_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
            <span class="n">window_low</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">______</span><span class="p">():</span>
                <span class="n">support_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;resistance&#39;</span><span class="p">:</span> <span class="n">resistance_levels</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">:</span> <span class="n">support_levels</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">is_testing_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if price is testing (near) a level.&quot;&quot;&quot;</span>
        <span class="n">distance_pct</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="n">level</span>
        <span class="k">return</span> <span class="n">distance_pct</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximity_pct</span>
    
    <span class="k">def</span> <span class="nf">get_nearest_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get nearest support and resistance with testing status.&quot;&quot;&quot;</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_levels</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
        <span class="n">resistance_above</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">current_price</span><span class="p">]</span>
        <span class="n">nearest_resistance</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">resistance_above</span><span class="p">)</span> <span class="k">if</span> <span class="n">resistance_above</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="n">support_below</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">current_price</span><span class="p">]</span>
        <span class="n">nearest_support</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">support_below</span><span class="p">)</span> <span class="k">if</span> <span class="n">support_below</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">nearest_resistance</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">nearest_resistance</span><span class="p">,</span>
                <span class="s1">&#39;is_testing&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_testing_level</span><span class="p">(</span><span class="n">current_price</span><span class="p">,</span> <span class="n">nearest_resistance</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">nearest_support</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">nearest_support</span><span class="p">,</span>
                <span class="s1">&#39;is_testing&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_testing_level</span><span class="p">(</span><span class="n">current_price</span><span class="p">,</span> <span class="n">nearest_support</span><span class="p">)</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">result</span>


<span class="c1"># Test</span>
<span class="n">sr_finder</span> <span class="o">=</span> <span class="n">EnhancedSRFinder</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">current_price</span> <span class="o">=</span> <span class="n">demo_df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">nearest</span> <span class="o">=</span> <span class="n">sr_finder</span><span class="o">.</span><span class="n">get_nearest_levels</span><span class="p">(</span><span class="n">demo_df</span><span class="p">,</span> <span class="n">current_price</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Price: </span><span class="si">{</span><span class="n">current_price</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;resistance&#39;</span> <span class="ow">in</span> <span class="n">nearest</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">nearest</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nearest Resistance: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> (Testing: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;is_testing&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;support&#39;</span> <span class="ow">in</span> <span class="n">nearest</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">nearest</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nearest Support: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> (Testing: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;is_testing&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">EnhancedSRFinder</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">proximity_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.002</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proximity_pct</span> <span class="o">=</span> <span class="n">proximity_pct</span>

    <span class="k">def</span> <span class="nf">identify_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
        <span class="n">resistance_levels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">support_levels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">):</span>
            <span class="n">window_high</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">window_high</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                <span class="n">resistance_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">window_low</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">window_low</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
                <span class="n">support_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;resistance&#39;</span><span class="p">:</span> <span class="n">resistance_levels</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">:</span> <span class="n">support_levels</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">is_testing_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">distance_pct</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="n">level</span>
        <span class="k">return</span> <span class="n">distance_pct</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proximity_pct</span>

    <span class="k">def</span> <span class="nf">get_nearest_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_levels</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">resistance_above</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">current_price</span><span class="p">]</span>
        <span class="n">nearest_resistance</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">resistance_above</span><span class="p">)</span> <span class="k">if</span> <span class="n">resistance_above</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">support_below</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">current_price</span><span class="p">]</span>
        <span class="n">nearest_support</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">support_below</span><span class="p">)</span> <span class="k">if</span> <span class="n">support_below</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">nearest_resistance</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">nearest_resistance</span><span class="p">,</span>
                <span class="s1">&#39;is_testing&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_testing_level</span><span class="p">(</span><span class="n">current_price</span><span class="p">,</span> <span class="n">nearest_resistance</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">nearest_support</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">nearest_support</span><span class="p">,</span>
                <span class="s1">&#39;is_testing&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_testing_level</span><span class="p">(</span><span class="n">current_price</span><span class="p">,</span> <span class="n">nearest_support</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 2: Currency Strength Calculator (Guided)</h3>
<p>Complete the <code>QuickStrengthMeter</code> that calculates currency strength using a simplified method.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">QuickStrengthMeter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simplified currency strength calculator.&quot;&quot;&quot;</span>
    
    <span class="n">USD_PAIRS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="s1">&#39;quote&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="s1">&#39;quote&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USDJPY&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USDCHF&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AUDUSD&#39;</span><span class="p">:</span> <span class="s1">&#39;quote&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USDCAD&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
    
    <span class="k">def</span> <span class="nf">calculate_usd_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair_changes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate USD strength from pair percentage changes.&quot;&quot;&quot;</span>
        <span class="n">usd_strength</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pair_count</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">USD_PAIRS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pair_changes</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">change</span> <span class="o">=</span> <span class="n">pair_changes</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="s1">&#39;base&#39;</span><span class="p">:</span>
                <span class="n">usd_strength</span> <span class="n">______</span> <span class="n">change</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">usd_strength</span> <span class="n">______</span> <span class="n">change</span>
            
            <span class="n">pair_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">usd_strength</span> <span class="o">/</span> <span class="n">pair_count</span> <span class="k">if</span> <span class="n">pair_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="k">def</span> <span class="nf">get_pair_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate percentage change for each pair.&quot;&quot;&quot;</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">prices</span> <span class="ow">in</span> <span class="n">pair_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
                <span class="n">start_price</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">]</span>
                <span class="n">end_price</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">changes</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">end_price</span> <span class="o">-</span> <span class="n">start_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">start_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">______</span>
        
        <span class="k">return</span> <span class="n">changes</span>
    
    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Full analysis of USD strength.&quot;&quot;&quot;</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pair_changes</span><span class="p">(</span><span class="n">pair_data</span><span class="p">)</span>
        <span class="n">usd_strength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_usd_strength</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;usd_strength&#39;</span><span class="p">:</span> <span class="n">usd_strength</span><span class="p">,</span>
            <span class="s1">&#39;interpretation&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">if</span> <span class="n">usd_strength</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pair_changes&#39;</span><span class="p">:</span> <span class="n">changes</span>
        <span class="p">}</span>


<span class="c1"># Test</span>
<span class="n">test_pairs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">QuickStrengthMeter</span><span class="o">.</span><span class="n">USD_PAIRS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">base</span> <span class="o">=</span> <span class="mf">1.10</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="mf">150.0</span>
    <span class="n">test_pairs</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">base</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>

<span class="n">meter</span> <span class="o">=</span> <span class="n">QuickStrengthMeter</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">meter</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">test_pairs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USD Strength: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;usd_strength&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interpretation: USD is </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;interpretation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">QuickStrengthMeter</span><span class="p">:</span>
    <span class="n">USD_PAIRS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="s1">&#39;quote&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="s1">&#39;quote&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USDJPY&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USDCHF&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AUDUSD&#39;</span><span class="p">:</span> <span class="s1">&#39;quote&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USDCAD&#39;</span><span class="p">:</span> <span class="s1">&#39;base&#39;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>

    <span class="k">def</span> <span class="nf">calculate_usd_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair_changes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">usd_strength</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pair_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">USD_PAIRS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pair_changes</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">change</span> <span class="o">=</span> <span class="n">pair_changes</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="s1">&#39;base&#39;</span><span class="p">:</span>
                <span class="n">usd_strength</span> <span class="o">+=</span> <span class="n">change</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">usd_strength</span> <span class="o">-=</span> <span class="n">change</span>

            <span class="n">pair_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">usd_strength</span> <span class="o">/</span> <span class="n">pair_count</span> <span class="k">if</span> <span class="n">pair_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">get_pair_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">prices</span> <span class="ow">in</span> <span class="n">pair_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
                <span class="n">start_price</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">]</span>
                <span class="n">end_price</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">changes</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">end_price</span> <span class="o">-</span> <span class="n">start_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">start_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">return</span> <span class="n">changes</span>

    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pair_changes</span><span class="p">(</span><span class="n">pair_data</span><span class="p">)</span>
        <span class="n">usd_strength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_usd_strength</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;usd_strength&#39;</span><span class="p">:</span> <span class="n">usd_strength</span><span class="p">,</span>
            <span class="s1">&#39;interpretation&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">if</span> <span class="n">usd_strength</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pair_changes&#39;</span><span class="p">:</span> <span class="n">changes</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 3: Pivot Point Trader (Guided)</h3>
<p>Complete the <code>PivotTrader</code> class that generates signals based on pivot point levels.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">PivotTrader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate trading signals from pivot points.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bounce_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0003</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounce_threshold</span> <span class="o">=</span> <span class="n">bounce_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pivot_calc</span> <span class="o">=</span> <span class="n">PivotPointCalculator</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_position_vs_pivot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pivots</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine price position relative to pivot.&quot;&quot;&quot;</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">pivots</span><span class="p">[</span><span class="s1">&#39;PP&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">pivots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;R2&#39;</span><span class="p">,</span> <span class="n">pp</span> <span class="o">*</span> <span class="mf">1.01</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;above_r2&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">pivots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="n">pp</span> <span class="o">*</span> <span class="mf">1.005</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;above_r1&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">pp</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;above_pp&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">pivots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;S1&#39;</span><span class="p">,</span> <span class="n">pp</span> <span class="o">*</span> <span class="mf">0.995</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;below_pp&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">pivots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;S2&#39;</span><span class="p">,</span> <span class="n">pp</span> <span class="o">*</span> <span class="mf">0.99</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;below_s1&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;below_s2&#39;</span>
    
    <span class="k">def</span> <span class="nf">check_bounce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">prev</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check if price bounced off a level.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">prev</span> <span class="o">-</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounce_threshold</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">prev</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;bullish_bounce&#39;</span>
            <span class="k">elif</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">prev</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;bearish_bounce&#39;</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">prev_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">yesterday_high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">yesterday_low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">yesterday_close</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal based on pivot levels.&quot;&quot;&quot;</span>
        <span class="n">pivots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot_calc</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">yesterday_high</span><span class="p">,</span> <span class="n">yesterday_low</span><span class="p">,</span> <span class="n">yesterday_close</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_position_vs_pivot</span><span class="p">(</span><span class="n">current_price</span><span class="p">,</span> <span class="n">pivots</span><span class="p">)</span>
        
        <span class="n">signal</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
            <span class="s1">&#39;pivots&#39;</span><span class="p">:</span> <span class="n">pivots</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">level_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PP&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">,</span> <span class="s1">&#39;S2&#39;</span><span class="p">,</span> <span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">]:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">pivots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
                <span class="n">bounce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_bounce</span><span class="p">(</span><span class="n">current_price</span><span class="p">,</span> <span class="n">prev_price</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bounce</span> <span class="o">==</span> <span class="s1">&#39;bullish_bounce&#39;</span> <span class="ow">and</span> <span class="n">level_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PP&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">,</span> <span class="s1">&#39;S2&#39;</span><span class="p">]:</span>
                    <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;______&#39;</span>
                    <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bullish bounce at </span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">bounce</span> <span class="o">==</span> <span class="s1">&#39;bearish_bounce&#39;</span> <span class="ow">and</span> <span class="n">level_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PP&#39;</span><span class="p">,</span> <span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">]:</span>
                    <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;______&#39;</span>
                    <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearish bounce at </span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">break</span>
        
        <span class="k">return</span> <span class="n">signal</span>


<span class="c1"># Test</span>
<span class="n">trader</span> <span class="o">=</span> <span class="n">PivotTrader</span><span class="p">()</span>

<span class="n">y_high</span><span class="p">,</span> <span class="n">y_low</span><span class="p">,</span> <span class="n">y_close</span> <span class="o">=</span> <span class="mf">1.0920</span><span class="p">,</span> <span class="mf">1.0845</span><span class="p">,</span> <span class="mf">1.0878</span>
<span class="n">pivots</span> <span class="o">=</span> <span class="n">PivotPointCalculator</span><span class="p">()</span><span class="o">.</span><span class="n">standard_pivots</span><span class="p">(</span><span class="n">y_high</span><span class="p">,</span> <span class="n">y_low</span><span class="p">,</span> <span class="n">y_close</span><span class="p">)</span>
<span class="n">prev_price</span> <span class="o">=</span> <span class="n">pivots</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.0001</span>
<span class="n">current_price</span> <span class="o">=</span> <span class="n">pivots</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.0010</span>

<span class="n">signal</span> <span class="o">=</span> <span class="n">trader</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">current_price</span><span class="p">,</span> <span class="n">prev_price</span><span class="p">,</span> <span class="n">y_high</span><span class="p">,</span> <span class="n">y_low</span><span class="p">,</span> <span class="n">y_close</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Price: </span><span class="si">{</span><span class="n">current_price</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Action: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reason: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PivotTrader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bounce_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0003</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounce_threshold</span> <span class="o">=</span> <span class="n">bounce_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pivot_calc</span> <span class="o">=</span> <span class="n">PivotPointCalculator</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_position_vs_pivot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pivots</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">pivots</span><span class="p">[</span><span class="s1">&#39;PP&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">pivots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;R2&#39;</span><span class="p">,</span> <span class="n">pp</span> <span class="o">*</span> <span class="mf">1.01</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;above_r2&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">pivots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="n">pp</span> <span class="o">*</span> <span class="mf">1.005</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;above_r1&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">pp</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;above_pp&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">pivots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;S1&#39;</span><span class="p">,</span> <span class="n">pp</span> <span class="o">*</span> <span class="mf">0.995</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;below_pp&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">pivots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;S2&#39;</span><span class="p">,</span> <span class="n">pp</span> <span class="o">*</span> <span class="mf">0.99</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;below_s1&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;below_s2&#39;</span>

    <span class="k">def</span> <span class="nf">check_bounce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">prev</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">prev</span> <span class="o">-</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounce_threshold</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">prev</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;bullish_bounce&#39;</span>
            <span class="k">elif</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">prev</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;bearish_bounce&#39;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">prev_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">yesterday_high</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">yesterday_low</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">yesterday_close</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">pivots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot_calc</span><span class="o">.</span><span class="n">standard_pivots</span><span class="p">(</span><span class="n">yesterday_high</span><span class="p">,</span> <span class="n">yesterday_low</span><span class="p">,</span> <span class="n">yesterday_close</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_position_vs_pivot</span><span class="p">(</span><span class="n">current_price</span><span class="p">,</span> <span class="n">pivots</span><span class="p">)</span>

        <span class="n">signal</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
            <span class="s1">&#39;pivots&#39;</span><span class="p">:</span> <span class="n">pivots</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">level_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PP&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">,</span> <span class="s1">&#39;S2&#39;</span><span class="p">,</span> <span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">]:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">pivots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
                <span class="n">bounce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_bounce</span><span class="p">(</span><span class="n">current_price</span><span class="p">,</span> <span class="n">prev_price</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bounce</span> <span class="o">==</span> <span class="s1">&#39;bullish_bounce&#39;</span> <span class="ow">and</span> <span class="n">level_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PP&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">,</span> <span class="s1">&#39;S2&#39;</span><span class="p">]:</span>
                    <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BUY&#39;</span>
                    <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bullish bounce at </span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">bounce</span> <span class="o">==</span> <span class="s1">&#39;bearish_bounce&#39;</span> <span class="ow">and</span> <span class="n">level_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PP&#39;</span><span class="p">,</span> <span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">]:</span>
                    <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SELL&#39;</span>
                    <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Bearish bounce at </span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">signal</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 4: Multi-Timeframe Trend Analyzer (Open-ended)</h3>
<p>Build a comprehensive MTF analyzer that:
- Analyzes 3+ timeframes (e.g., Daily, 4H, 1H)
- Calculates trend direction for each using your choice of method
- Returns an alignment score and trading bias
- Identifies the best timeframe for entry</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4: Multi-Timeframe Trend Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class ComprehensiveMTFAnalyzer</span>
<span class="c1"># 2. Support at least 3 timeframes</span>
<span class="c1"># 3. Calculate trend using MA crossover or ADX</span>
<span class="c1"># 4. Return alignment score (0-100)</span>
<span class="c1"># 5. Provide trading recommendation</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ComprehensiveMTFAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Multi-timeframe trend analyzer with alignment scoring.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span> <span class="o">=</span> <span class="n">timeframes</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;4h&#39;</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;4h&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;1h&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">calculate_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">fast</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">slow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">slow</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="n">ma_fast</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ma_slow</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">ma_fast</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma_slow</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">ma_slow</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mf">0.002</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.002</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="p">:</span>
            <span class="n">tf_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
                <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="s1">&#39;last&#39;</span>
            <span class="p">})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">results</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_trend</span><span class="p">(</span><span class="n">tf_data</span><span class="p">)</span>

        <span class="n">bullish_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tf_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tf</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="p">)</span>
        <span class="n">bearish_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tf_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tf</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="p">)</span>

        <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bullish_score</span> <span class="o">&gt;</span> <span class="n">bearish_score</span><span class="p">:</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
            <span class="n">alignment</span> <span class="o">=</span> <span class="n">bullish_score</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_weight</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">elif</span> <span class="n">bearish_score</span> <span class="o">&gt;</span> <span class="n">bullish_score</span><span class="p">:</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
            <span class="n">alignment</span> <span class="o">=</span> <span class="n">bearish_score</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_weight</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
            <span class="n">alignment</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;timeframes&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="n">bias</span><span class="p">,</span>
            <span class="s1">&#39;alignment_score&#39;</span><span class="p">:</span> <span class="n">alignment</span><span class="p">,</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;TRADE&#39;</span> <span class="k">if</span> <span class="n">alignment</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="k">else</span> <span class="s1">&#39;WAIT&#39;</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 5: Candlestick Pattern Scanner (Open-ended)</h3>
<p>Build an advanced candlestick scanner that:
- Identifies at least 5 different patterns
- Assigns probability scores to each pattern
- Considers the context (trend, key levels)
- Returns actionable trading signals</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 5: Candlestick Pattern Scanner (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class AdvancedCandleScanner</span>
<span class="c1"># 2. Detect: doji, hammer, engulfing, morning/evening star, three soldiers/crows</span>
<span class="c1"># 3. Score pattern quality (0-100)</span>
<span class="c1"># 4. Consider if pattern is at key S/R level</span>
<span class="c1"># 5. Generate trade signal with entry/stop/target</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedCandleScanner</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Advanced candlestick pattern scanner with context awareness.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sr_finder</span> <span class="o">=</span> <span class="n">SupportResistanceFinder</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_candle_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">o</span><span class="p">)</span>
        <span class="n">range_size</span> <span class="o">=</span> <span class="n">h</span> <span class="o">-</span> <span class="n">l</span>
        <span class="n">upper_wick</span> <span class="o">=</span> <span class="n">h</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">lower_wick</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">l</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;bullish&#39;</span><span class="p">:</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">o</span><span class="p">,</span>
            <span class="s1">&#39;body_pct&#39;</span><span class="p">:</span> <span class="n">body</span> <span class="o">/</span> <span class="n">range_size</span> <span class="k">if</span> <span class="n">range_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;upper_wick_pct&#39;</span><span class="p">:</span> <span class="n">upper_wick</span> <span class="o">/</span> <span class="n">range_size</span> <span class="k">if</span> <span class="n">range_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;lower_wick_pct&#39;</span><span class="p">:</span> <span class="n">lower_wick</span> <span class="o">/</span> <span class="n">range_size</span> <span class="k">if</span> <span class="n">range_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">body</span><span class="p">,</span>
            <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="n">range_size</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">detect_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">candle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_candle_type</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">candle</span><span class="p">[</span><span class="s1">&#39;body_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;doji&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">candle</span><span class="p">[</span><span class="s1">&#39;lower_wick_pct&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="ow">and</span> <span class="n">candle</span><span class="p">[</span><span class="s1">&#39;body_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
                <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;hammer&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">candle</span><span class="p">[</span><span class="s1">&#39;upper_wick_pct&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.6</span> <span class="ow">and</span> <span class="n">candle</span><span class="p">[</span><span class="s1">&#39;body_pct&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
                <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;shooting_star&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">prev_candle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_candle_type</span><span class="p">(</span><span class="n">prev</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">],</span> <span class="n">prev</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">prev</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">prev</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">candle</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev_candle</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.3</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">candle</span><span class="p">[</span><span class="s1">&#39;bullish&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">prev_candle</span><span class="p">[</span><span class="s1">&#39;bullish&#39;</span><span class="p">]:</span>
                        <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish_engulfing&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">candle</span><span class="p">[</span><span class="s1">&#39;bullish&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">prev_candle</span><span class="p">[</span><span class="s1">&#39;bullish&#39;</span><span class="p">]:</span>
                        <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish_engulfing&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">patterns</span>

    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_patterns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">current_price</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">atr</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_finder</span><span class="o">.</span><span class="n">get_key_levels</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">at_support</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.003</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">])</span>
            <span class="n">at_resistance</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.003</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">])</span>

            <span class="n">score</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">at_support</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">20</span>
            <span class="k">elif</span> <span class="n">at_resistance</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">20</span>

            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">:</span>
                <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">else</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                    <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">current_price</span><span class="p">,</span>
                    <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">current_price</span> <span class="o">-</span> <span class="n">atr</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">else</span> <span class="n">current_price</span> <span class="o">+</span> <span class="n">atr</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span>
                    <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">current_price</span> <span class="o">+</span> <span class="n">atr</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">else</span> <span class="n">current_price</span> <span class="o">-</span> <span class="n">atr</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 6: Complete Technical Analysis Suite (Open-ended)</h3>
<p>Build a comprehensive technical analysis class that combines:
- Support/resistance levels
- Trend analysis
- Chart patterns
- Candlestick patterns
- Multi-timeframe confirmation</p>
<p>Generate a complete market analysis report.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 6: Complete Technical Analysis Suite (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class TechnicalAnalysisSuite</span>
<span class="c1"># 2. Combine S/R, trend, patterns, candles, MTF</span>
<span class="c1"># 3. Generate comprehensive analysis report</span>
<span class="c1"># 4. Provide overall bias with confidence</span>
<span class="c1"># 5. Output actionable trade setup if conditions align</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TechnicalAnalysisSuite</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive technical analysis combining multiple methods.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sr_finder</span> <span class="o">=</span> <span class="n">SupportResistanceFinder</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern_recognizer</span> <span class="o">=</span> <span class="n">ChartPatternRecognizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">candle_scanner</span> <span class="o">=</span> <span class="n">CandlestickPatterns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtf_analyzer</span> <span class="o">=</span> <span class="n">MultiTimeframeAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">analyze_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">ma20</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ma50</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ma50</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">ma20</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ma50</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">ma20</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ma50</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">full_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trend</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="s1">&#39;key_levels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_finder</span><span class="o">.</span><span class="n">get_key_levels</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="s1">&#39;chart_patterns&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern_recognizer</span><span class="o">.</span><span class="n">scan_patterns</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="s1">&#39;candle_patterns&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">candle_scanner</span><span class="o">.</span><span class="n">scan_patterns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
            <span class="s1">&#39;mtf&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtf_analyzer</span><span class="o">.</span><span class="n">analyze_timeframes</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">bullish_signals</span> <span class="o">=</span> <span class="n">bearish_signals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">:</span>
            <span class="n">bullish_signals</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span><span class="p">:</span>
            <span class="n">bearish_signals</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;chart_patterns&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">:</span> <span class="n">bullish_signals</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span><span class="p">:</span> <span class="n">bearish_signals</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;candle_patterns&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;bullish&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">bullish_signals</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="s1">&#39;bearish&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="n">bearish_signals</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">total</span> <span class="o">=</span> <span class="n">bullish_signals</span> <span class="o">+</span> <span class="n">bearish_signals</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bullish_signals</span> <span class="o">&gt;</span> <span class="n">bearish_signals</span><span class="p">:</span>
                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;overall_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bullish_signals</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;overall_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bearish_signals</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;overall_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">atr</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;current_price&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;overall_bias&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">:</span>
                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;trade_setup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry</span><span class="p">,</span>
                    <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">entry</span> <span class="o">-</span> <span class="n">atr</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">entry</span> <span class="o">+</span> <span class="n">atr</span> <span class="o">*</span> <span class="mf">2.5</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">report</span><span class="p">[</span><span class="s1">&#39;trade_setup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry</span><span class="p">,</span>
                    <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">entry</span> <span class="o">+</span> <span class="n">atr</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">entry</span> <span class="o">-</span> <span class="n">atr</span> <span class="o">*</span> <span class="mf">2.5</span>
                <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;trade_setup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">report</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Technical Analysis Suite</h2>
<p>Build a production-ready technical analysis system that combines all concepts from this module.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ForexTechnicalAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready forex technical analysis system.</span>
<span class="sd">    </span>
<span class="sd">    Combines: S/R detection, Trend analysis, Chart patterns,</span>
<span class="sd">    Candlestick patterns, MTF confirmation, Pivot points, Fibonacci.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sr_finder</span> <span class="o">=</span> <span class="n">SupportResistanceFinder</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern_detector</span> <span class="o">=</span> <span class="n">ChartPatternRecognizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">candle_scanner</span> <span class="o">=</span> <span class="n">CandlestickPatterns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtf_analyzer</span> <span class="o">=</span> <span class="n">MultiTimeframeAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pivot_calc</span> <span class="o">=</span> <span class="n">PivotPointCalculator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fib_analyzer</span> <span class="o">=</span> <span class="n">FibonacciAnalyzer</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">analyze_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze market structure.&quot;&quot;&quot;</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_finder</span><span class="o">.</span><span class="n">get_key_levels</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">resistance_above</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">current</span><span class="p">]</span>
        <span class="n">support_below</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">current</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span>
            <span class="s1">&#39;nearest_resistance&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">resistance_above</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">resistance_above</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;nearest_support&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">support_below</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">support_below</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">analyze_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Comprehensive trend analysis.&quot;&quot;&quot;</span>
        <span class="n">ma10</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ma20</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ma50</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">ma10</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ma20</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ma50</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;strong_bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">ma20</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ma50</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">75</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">ma10</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ma20</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ma50</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;strong_bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">ma20</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ma50</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">75</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;ranging&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">trend</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">pivots</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate overall trading bias.&quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="s1">&#39;bullish&#39;</span> <span class="ow">in</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">trend</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trend: </span><span class="si">{</span><span class="n">trend</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;bearish&#39;</span> <span class="ow">in</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">trend</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trend: </span><span class="si">{</span><span class="n">trend</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chart_patterns&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span>
                <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chart: </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">-=</span> <span class="mi">2</span>
                <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chart: </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">pivots</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">structure</span><span class="p">[</span><span class="s1">&#39;current_price&#39;</span><span class="p">]</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">pivots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PP&#39;</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">pp</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Above pivot&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Below pivot&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">score</span> <span class="o">*</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="mi">30</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="n">bias</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span> <span class="s1">&#39;factors&#39;</span><span class="p">:</span> <span class="n">factors</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_trade_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate specific trade setup if conditions align.&quot;&quot;&quot;</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">bias</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">current</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">][</span><span class="s1">&#39;current_price&#39;</span><span class="p">]</span>
        <span class="n">atr</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;atr&#39;</span><span class="p">,</span> <span class="n">current</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">bias</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">:</span>
            <span class="n">support</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nearest_support&#39;</span><span class="p">)</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">support</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.998</span> <span class="k">if</span> <span class="n">support</span> <span class="k">else</span> <span class="n">current</span> <span class="o">-</span> <span class="n">atr</span> <span class="o">*</span> <span class="mf">1.5</span>
            <span class="n">resistance</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nearest_resistance&#39;</span><span class="p">)</span>
            <span class="n">risk</span> <span class="o">=</span> <span class="n">current</span> <span class="o">-</span> <span class="n">stop</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">resistance</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">resistance</span> <span class="k">else</span> <span class="n">current</span> <span class="o">+</span> <span class="n">risk</span> <span class="o">*</span> <span class="mi">2</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span> <span class="s1">&#39;stop_loss&#39;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span> <span class="s1">&#39;take_profit&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
                <span class="s1">&#39;risk_pips&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">stop</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span> <span class="s1">&#39;reward_pips&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">current</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;risk_reward&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">current</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">stop</span><span class="p">)</span> <span class="k">if</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">stop</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">}</span>
        
        <span class="k">elif</span> <span class="n">bias</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span><span class="p">:</span>
            <span class="n">resistance</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nearest_resistance&#39;</span><span class="p">)</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">resistance</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.002</span> <span class="k">if</span> <span class="n">resistance</span> <span class="k">else</span> <span class="n">current</span> <span class="o">+</span> <span class="n">atr</span> <span class="o">*</span> <span class="mf">1.5</span>
            <span class="n">support</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nearest_support&#39;</span><span class="p">)</span>
            <span class="n">risk</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">current</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">support</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">support</span> <span class="k">else</span> <span class="n">current</span> <span class="o">-</span> <span class="n">risk</span> <span class="o">*</span> <span class="mi">2</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span> <span class="s1">&#39;stop_loss&#39;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span> <span class="s1">&#39;take_profit&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
                <span class="s1">&#39;risk_pips&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">current</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span> <span class="s1">&#39;reward_pips&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;risk_reward&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">current</span><span class="p">)</span> <span class="k">if</span> <span class="n">stop</span> <span class="o">!=</span> <span class="n">current</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">full_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run complete technical analysis.&quot;&quot;&quot;</span>
        <span class="n">atr</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_structure</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trend</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;chart_patterns&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern_detector</span><span class="o">.</span><span class="n">scan_patterns</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="s1">&#39;candle_patterns&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">candle_scanner</span><span class="o">.</span><span class="n">scan_patterns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_indexed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_indexed</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">daily</span> <span class="o">=</span> <span class="n">df_indexed</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
            <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="s1">&#39;last&#39;</span>
        <span class="p">})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">daily</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">yesterday</span> <span class="o">=</span> <span class="n">daily</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">pivots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivot_calc</span><span class="o">.</span><span class="n">standard_pivots</span><span class="p">(</span><span class="n">yesterday</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">yesterday</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">yesterday</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pivots</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_bias</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">trend</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">pivots</span><span class="p">)</span>
        
        <span class="n">analysis</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pair</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="n">structure</span><span class="p">,</span> <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">trend</span><span class="p">,</span> <span class="s1">&#39;patterns&#39;</span><span class="p">:</span> <span class="n">patterns</span><span class="p">,</span>
            <span class="s1">&#39;pivots&#39;</span><span class="p">:</span> <span class="n">pivots</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="n">bias</span><span class="p">,</span> <span class="s1">&#39;atr&#39;</span><span class="p">:</span> <span class="n">atr</span>
        <span class="p">}</span>
        
        <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;trade_setup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_trade_setup</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">analysis</span>
    
    <span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print formatted analysis report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  TECHNICAL ANALYSIS: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current Price: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">][</span><span class="s1">&#39;current_price&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">][</span><span class="s1">&#39;nearest_resistance&#39;</span><span class="p">]:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">][</span><span class="s1">&#39;nearest_resistance&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nearest Resistance: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">][</span><span class="s1">&#39;nearest_support&#39;</span><span class="p">]:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">][</span><span class="s1">&#39;nearest_support&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nearest Support: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trend: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">][</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pivot Points:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;R2&#39;</span><span class="p">,</span> <span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="s1">&#39;PP&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">,</span> <span class="s1">&#39;S2&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">][</span><span class="n">level</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OVERALL BIAS: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">][</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">][</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Factors: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">][</span><span class="s1">&#39;factors&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;trade_setup&#39;</span><span class="p">]:</span>
            <span class="n">setup</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;trade_setup&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRADE SETUP: </span><span class="si">{</span><span class="n">setup</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entry:  </span><span class="si">{</span><span class="n">setup</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stop:   </span><span class="si">{</span><span class="n">setup</span><span class="p">[</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">setup</span><span class="p">[</span><span class="s1">&#39;risk_pips&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pips)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target: </span><span class="si">{</span><span class="n">setup</span><span class="p">[</span><span class="s1">&#39;take_profit&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">setup</span><span class="p">[</span><span class="s1">&#39;reward_pips&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pips)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Risk/Reward: </span><span class="si">{</span><span class="n">setup</span><span class="p">[</span><span class="s1">&#39;risk_reward&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No trade setup - conditions not aligned&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>


<span class="c1"># Run the complete analysis</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">ForexTechnicalAnalyzer</span><span class="p">(</span><span class="n">pair</span><span class="o">=</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">)</span>
<span class="n">analysis</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">full_analysis</span><span class="p">(</span><span class="n">demo_df</span><span class="p">)</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">print_report</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ul>
<li><strong>Support/Resistance</strong>: Identify key levels where price historically reverses</li>
<li><strong>Trend Lines</strong>: Connect swing points to visualize trend direction and breakouts</li>
<li><strong>Chart Patterns</strong>: Double tops/bottoms, triangles signal potential reversals or continuations</li>
<li><strong>Currency Strength</strong>: Compare relative strength across pairs for high-probability trades</li>
<li><strong>Pivot Points</strong>: Daily levels that act as support/resistance for intraday trading</li>
<li><strong>Fibonacci</strong>: Identify retracement zones and extension targets</li>
<li><strong>Multi-Timeframe</strong>: Align higher timeframe trend with lower timeframe entries</li>
<li><strong>Price Action</strong>: Trade candlestick patterns at key levels without indicators</li>
<li><strong>Confluence</strong>: Combine multiple methods for higher confidence signals</li>
</ul>
<p><strong>Next: Module 6 - Fundamental Analysis</strong> where we'll analyze economic indicators, central bank policies, and build economic calendars for forex trading.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="6"><div class="md-cell module-header"><h1>Module 6: Fundamental Analysis for Forex &amp; Futures</h1>
<p><strong>Part 2: Analysis &amp; Strategies</strong></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ul>
<li>Understand key economic indicators and their impact on currencies</li>
<li>Track central bank policies and interest rate decisions</li>
<li>Build and use economic calendars for trading</li>
<li>Analyze intermarket relationships between currencies, bonds, and commodities</li>
</ul>
<h2>Prerequisites</h2>
<ul>
<li>Modules 1-5 (Forex/Futures fundamentals, technical analysis)</li>
<li>Basic understanding of macroeconomics</li>
<li>Python pandas proficiency</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>6.1 Economic Indicators</h2>
<p>Economic indicators are statistics that provide insights into a country's economic health. They directly impact currency valuations and are essential for fundamental forex analysis.</p></div>
<div class="md-cell"><h3>Types of Economic Indicators</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
<th>Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Leading</strong></td>
<td>Predict future economic activity</td>
<td>PMI, Building Permits, Yield Curve</td>
</tr>
<tr>
<td><strong>Coincident</strong></td>
<td>Reflect current economic state</td>
<td>GDP, Employment, Retail Sales</td>
</tr>
<tr>
<td><strong>Lagging</strong></td>
<td>Confirm trends after they occur</td>
<td>Unemployment Rate, CPI, Interest Rates</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">EconomicIndicator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents an economic indicator with its properties and impact.&quot;&quot;&quot;</span>
    
    <span class="n">IMPACT_LEVELS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">impact</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;medium&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">country</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impact</span> <span class="o">=</span> <span class="n">impact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                    <span class="n">forecast</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">previous</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a new data release.&quot;&quot;&quot;</span>
        <span class="n">surprise</span> <span class="o">=</span> <span class="n">actual</span> <span class="o">-</span> <span class="n">forecast</span>
        <span class="n">surprise_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">surprise</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">forecast</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">actual</span><span class="p">,</span>
            <span class="s1">&#39;forecast&#39;</span><span class="p">:</span> <span class="n">forecast</span><span class="p">,</span>
            <span class="s1">&#39;previous&#39;</span><span class="p">:</span> <span class="n">previous</span><span class="p">,</span>
            <span class="s1">&#39;surprise&#39;</span><span class="p">:</span> <span class="n">surprise</span><span class="p">,</span>
            <span class="s1">&#39;surprise_pct&#39;</span><span class="p">:</span> <span class="n">surprise_pct</span><span class="p">,</span>
            <span class="s1">&#39;beat&#39;</span><span class="p">:</span> <span class="n">actual</span> <span class="o">&gt;</span> <span class="n">forecast</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periods</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine recent trend in indicator.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">periods</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;insufficient_data&#39;</span>
        
        <span class="n">recent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="n">periods</span><span class="p">:]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">recent</span><span class="p">]</span>
        
        <span class="n">increases</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">increases</span> <span class="o">&gt;=</span> <span class="n">periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;improving&#39;</span>
        <span class="k">elif</span> <span class="n">increases</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;deteriorating&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;mixed&#39;</span>
    
    <span class="k">def</span> <span class="nf">surprise_history</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze history of forecast surprises.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">surprises</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;surprise_pct&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">]</span>
        <span class="n">beats</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_surprise&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">surprises</span><span class="p">),</span>
            <span class="s1">&#39;beat_rate&#39;</span><span class="p">:</span> <span class="n">beats</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;largest_beat&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">surprises</span><span class="p">),</span>
            <span class="s1">&#39;largest_miss&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">surprises</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Demo: US Non-Farm Payrolls</span>
<span class="n">nfp</span> <span class="o">=</span> <span class="n">EconomicIndicator</span><span class="p">(</span><span class="s1">&#39;Non-Farm Payrolls&#39;</span><span class="p">,</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">)</span>

<span class="c1"># Add historical releases</span>
<span class="n">nfp</span><span class="o">.</span><span class="n">add_release</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">173</span><span class="p">)</span>
<span class="n">nfp</span><span class="o">.</span><span class="n">add_release</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">353</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">216</span><span class="p">)</span>
<span class="n">nfp</span><span class="o">.</span><span class="n">add_release</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">275</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">353</span><span class="p">)</span>
<span class="n">nfp</span><span class="o">.</span><span class="n">add_release</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">275</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Indicator: </span><span class="si">{</span><span class="n">nfp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">nfp</span><span class="o">.</span><span class="n">country</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Impact: </span><span class="si">{</span><span class="n">nfp</span><span class="o">.</span><span class="n">impact</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trend: </span><span class="si">{</span><span class="n">nfp</span><span class="o">.</span><span class="n">get_trend</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Surprise Analysis:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nfp</span><span class="o">.</span><span class="n">surprise_history</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Key Economic Indicators for Forex</h3>
<h4>GDP (Gross Domestic Product)</h4>
<ul>
<li>Measures total economic output</li>
<li>Released quarterly</li>
<li>Higher GDP growth = stronger currency (generally)</li>
</ul>
<h4>Inflation (CPI/PCE)</h4>
<ul>
<li>Consumer Price Index measures price changes</li>
<li>Higher inflation may lead to rate hikes = currency strength</li>
<li>Too high inflation can weaken confidence</li>
</ul>
<h4>Employment</h4>
<ul>
<li>Non-Farm Payrolls (US) - most watched indicator</li>
<li>Unemployment Rate</li>
<li>Strong employment = strong economy = strong currency</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">EconomicIndicatorTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track multiple economic indicators for a country.&quot;&quot;&quot;</span>
    
    <span class="c1"># Standard indicators by importance</span>
    <span class="n">STANDARD_INDICATORS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;US&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;Non-Farm Payrolls&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CPI YoY&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GDP QoQ&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Fed Interest Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Retail Sales MoM&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ISM Manufacturing PMI&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Unemployment Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="s1">&#39;EU&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;ECB Interest Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CPI YoY&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GDP QoQ&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;German ZEW Sentiment&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Unemployment Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="s1">&#39;UK&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;BoE Interest Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CPI YoY&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GDP QoQ&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Retail Sales&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="s1">&#39;JP&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;BoJ Interest Rate&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CPI YoY&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GDP QoQ&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Tankan Survey&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">country</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EconomicIndicator</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_indicators</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_initialize_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize standard indicators for country.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_INDICATORS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">impact</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STANDARD_INDICATORS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">EconomicIndicator</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="p">,</span> <span class="n">impact</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
                        <span class="n">actual</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">forecast</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">previous</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update an indicator with new data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add_release</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">forecast</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_economic_score</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate overall economic health score.&quot;&quot;&quot;</span>
        <span class="n">total_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">EconomicIndicator</span><span class="o">.</span><span class="n">IMPACT_LEVELS</span><span class="p">[</span><span class="n">indicator</span><span class="o">.</span><span class="n">impact</span><span class="p">]</span>
            <span class="n">max_score</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="mi">100</span>
            
            <span class="k">if</span> <span class="n">indicator</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
                <span class="n">latest</span> <span class="o">=</span> <span class="n">indicator</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># Score based on beat/miss and trend</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># neutral base</span>
                <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">]:</span>
                    <span class="n">score</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">latest</span><span class="p">[</span><span class="s1">&#39;surprise_pct&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">-=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">latest</span><span class="p">[</span><span class="s1">&#39;surprise_pct&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
                
                <span class="n">trend</span> <span class="o">=</span> <span class="n">indicator</span><span class="o">.</span><span class="n">get_trend</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;improving&#39;</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">+=</span> <span class="mi">20</span>
                <span class="k">elif</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;deteriorating&#39;</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">-=</span> <span class="mi">20</span>
                
                <span class="n">score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>
                <span class="n">total_score</span> <span class="o">+=</span> <span class="n">score</span> <span class="o">*</span> <span class="n">weight</span>
                
                <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;indicator&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
                    <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">trend</span><span class="p">,</span>
                    <span class="s1">&#39;last_beat&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">]</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="p">,</span>
            <span class="s1">&#39;overall_score&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">total_score</span> <span class="o">/</span> <span class="n">max_score</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_score</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;interpretation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpret_score</span><span class="p">(</span><span class="n">total_score</span> <span class="o">/</span> <span class="n">max_score</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">max_score</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">details</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_interpret_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Interpret the economic score.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;strong_bullish&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">55</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">45</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;neutral&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;strong_bearish&#39;</span>

<span class="c1"># Demo</span>
<span class="n">us_tracker</span> <span class="o">=</span> <span class="n">EconomicIndicatorTracker</span><span class="p">(</span><span class="s1">&#39;US&#39;</span><span class="p">)</span>

<span class="c1"># Add some data</span>
<span class="n">us_tracker</span><span class="o">.</span><span class="n">update_indicator</span><span class="p">(</span><span class="s1">&#39;Non-Farm Payrolls&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">275</span><span class="p">)</span>
<span class="n">us_tracker</span><span class="o">.</span><span class="n">update_indicator</span><span class="p">(</span><span class="s1">&#39;CPI YoY&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">)</span>
<span class="n">us_tracker</span><span class="o">.</span><span class="n">update_indicator</span><span class="p">(</span><span class="s1">&#39;GDP QoQ&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">)</span>

<span class="n">score</span> <span class="o">=</span> <span class="n">us_tracker</span><span class="o">.</span><span class="n">get_economic_score</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;US Economic Score: </span><span class="si">{</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;overall_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interpretation: </span><span class="si">{</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;interpretation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>6.2 Central Banks</h2>
<p>Central banks are the most influential institutions for currency markets. Their monetary policy decisions directly impact currency valuations.</p></div>
<div class="md-cell"><h3>Major Central Banks</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Central Bank</th>
<th>Currency</th>
<th>Key Policy Tool</th>
</tr>
</thead>
<tbody>
<tr>
<td>Federal Reserve (Fed)</td>
<td>USD</td>
<td>Federal Funds Rate</td>
</tr>
<tr>
<td>European Central Bank (ECB)</td>
<td>EUR</td>
<td>Main Refinancing Rate</td>
</tr>
<tr>
<td>Bank of England (BoE)</td>
<td>GBP</td>
<td>Bank Rate</td>
</tr>
<tr>
<td>Bank of Japan (BoJ)</td>
<td>JPY</td>
<td>Policy Rate, YCC</td>
</tr>
<tr>
<td>Swiss National Bank (SNB)</td>
<td>CHF</td>
<td>Policy Rate</td>
</tr>
<tr>
<td>Reserve Bank of Australia (RBA)</td>
<td>AUD</td>
<td>Cash Rate</td>
</tr>
<tr>
<td>Bank of Canada (BoC)</td>
<td>CAD</td>
<td>Overnight Rate</td>
</tr>
<tr>
<td>Reserve Bank of New Zealand (RBNZ)</td>
<td>NZD</td>
<td>Official Cash Rate</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CentralBank</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Model a central bank and its monetary policy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_rate</span> <span class="o">=</span> <span class="n">current_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_rate_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                         <span class="n">expected</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">statement_tone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Record a rate decision.&quot;&quot;&quot;</span>
        <span class="n">change</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_rate</span>
        <span class="n">surprise</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">-</span> <span class="n">expected</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">rate</span><span class="p">,</span>
            <span class="s1">&#39;previous&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_rate</span><span class="p">,</span>
            <span class="s1">&#39;change&#39;</span><span class="p">:</span> <span class="n">change</span><span class="p">,</span>
            <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
            <span class="s1">&#39;surprise&#39;</span><span class="p">:</span> <span class="n">surprise</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;hike&#39;</span> <span class="k">if</span> <span class="n">change</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;cut&#39;</span> <span class="k">if</span> <span class="n">change</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;hold&#39;</span><span class="p">),</span>
            <span class="s1">&#39;tone&#39;</span><span class="p">:</span> <span class="n">statement_tone</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_rate</span> <span class="o">=</span> <span class="n">rate</span>
    
    <span class="k">def</span> <span class="nf">get_policy_stance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine current policy stance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>
        
        <span class="n">recent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_history</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_history</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_history</span>
        <span class="n">hikes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">recent</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hike&#39;</span><span class="p">)</span>
        <span class="n">cuts</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">recent</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cut&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">hikes</span> <span class="o">&gt;</span> <span class="n">cuts</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;hawkish&#39;</span>
        <span class="k">elif</span> <span class="n">cuts</span> <span class="o">&gt;</span> <span class="n">hikes</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;dovish&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;neutral&#39;</span>
    
    <span class="k">def</span> <span class="nf">rate_differential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;CentralBank&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate rate differential with another central bank.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_rate</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">current_rate</span>
    
    <span class="k">def</span> <span class="nf">expected_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meetings</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Project expected rate path based on recent trend.&quot;&quot;&quot;</span>
        <span class="n">stance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_policy_stance</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_rate</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">meetings</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">stance</span> <span class="o">==</span> <span class="s1">&#39;hawkish&#39;</span><span class="p">:</span>
                <span class="n">rate</span> <span class="o">+=</span> <span class="mf">0.25</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">stance</span> <span class="o">==</span> <span class="s1">&#39;dovish&#39;</span><span class="p">:</span>
                <span class="n">rate</span> <span class="o">-=</span> <span class="mf">0.25</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;meeting&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;projected_rate&#39;</span><span class="p">:</span> <span class="n">rate</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">path</span>

<span class="c1"># Demo</span>
<span class="n">fed</span> <span class="o">=</span> <span class="n">CentralBank</span><span class="p">(</span><span class="s1">&#39;Federal Reserve&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">)</span>
<span class="n">ecb</span> <span class="o">=</span> <span class="n">CentralBank</span><span class="p">(</span><span class="s1">&#39;European Central Bank&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">)</span>

<span class="c1"># Add rate history</span>
<span class="n">fed</span><span class="o">.</span><span class="n">add_rate_decision</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="mf">5.25</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">,</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span>
<span class="n">fed</span><span class="o">.</span><span class="n">add_rate_decision</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="mf">5.25</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">,</span> <span class="s1">&#39;hawkish&#39;</span><span class="p">)</span>

<span class="n">ecb</span><span class="o">.</span><span class="n">add_rate_decision</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="mf">4.50</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">,</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span>
<span class="n">ecb</span><span class="o">.</span><span class="n">add_rate_decision</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="mf">4.50</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">,</span> <span class="s1">&#39;dovish&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fed current rate: </span><span class="si">{</span><span class="n">fed</span><span class="o">.</span><span class="n">current_rate</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fed stance: </span><span class="si">{</span><span class="n">fed</span><span class="o">.</span><span class="n">get_policy_stance</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ECB current rate: </span><span class="si">{</span><span class="n">ecb</span><span class="o">.</span><span class="n">current_rate</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ECB stance: </span><span class="si">{</span><span class="n">ecb</span><span class="o">.</span><span class="n">get_policy_stance</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">USD-EUR rate differential: </span><span class="si">{</span><span class="n">fed</span><span class="o">.</span><span class="n">rate_differential</span><span class="p">(</span><span class="n">ecb</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CentralBankMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor multiple central banks for trading signals.&quot;&quot;&quot;</span>
    
    <span class="n">CURRENCY_PAIRS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR&#39;</span><span class="p">):</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">):</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">):</span> <span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">):</span> <span class="s1">&#39;USDCHF&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD&#39;</span><span class="p">):</span> <span class="s1">&#39;AUDUSD&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">):</span> <span class="s1">&#39;USDCAD&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">):</span> <span class="s1">&#39;EURGBP&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">):</span> <span class="s1">&#39;EURJPY&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">banks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CentralBank</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_bank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bank</span><span class="p">:</span> <span class="n">CentralBank</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a central bank to monitor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">banks</span><span class="p">[</span><span class="n">bank</span><span class="o">.</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">bank</span>
    
    <span class="k">def</span> <span class="nf">get_all_differentials</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate all rate differentials.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">currencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">banks</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">curr1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currencies</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">curr2</span> <span class="ow">in</span> <span class="n">currencies</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">bank1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">banks</span><span class="p">[</span><span class="n">curr1</span><span class="p">]</span>
                <span class="n">bank2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">banks</span><span class="p">[</span><span class="n">curr2</span><span class="p">]</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">bank1</span><span class="o">.</span><span class="n">rate_differential</span><span class="p">(</span><span class="n">bank2</span><span class="p">)</span>
                
                <span class="n">pair_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr1</span><span class="p">,</span> <span class="n">curr2</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">curr1</span><span class="p">,</span> <span class="n">curr2</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CURRENCY_PAIRS</span> <span class="k">else</span> <span class="p">(</span><span class="n">curr2</span><span class="p">,</span> <span class="n">curr1</span><span class="p">)</span>
                <span class="n">pair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CURRENCY_PAIRS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair_key</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">curr1</span><span class="si">}{</span><span class="n">curr2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                    <span class="s1">&#39;currency_1&#39;</span><span class="p">:</span> <span class="n">curr1</span><span class="p">,</span>
                    <span class="s1">&#39;currency_2&#39;</span><span class="p">:</span> <span class="n">curr2</span><span class="p">,</span>
                    <span class="s1">&#39;rate_1&#39;</span><span class="p">:</span> <span class="n">bank1</span><span class="o">.</span><span class="n">current_rate</span><span class="p">,</span>
                    <span class="s1">&#39;rate_2&#39;</span><span class="p">:</span> <span class="n">bank2</span><span class="o">.</span><span class="n">current_rate</span><span class="p">,</span>
                    <span class="s1">&#39;differential&#39;</span><span class="p">:</span> <span class="n">diff</span><span class="p">,</span>
                    <span class="s1">&#39;carry_direction&#39;</span><span class="p">:</span> <span class="n">curr1</span> <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">curr2</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">policy_divergence_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find trading opportunities from policy divergence.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">currencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">banks</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">curr1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currencies</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">curr2</span> <span class="ow">in</span> <span class="n">currencies</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">bank1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">banks</span><span class="p">[</span><span class="n">curr1</span><span class="p">]</span>
                <span class="n">bank2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">banks</span><span class="p">[</span><span class="n">curr2</span><span class="p">]</span>
                
                <span class="n">stance1</span> <span class="o">=</span> <span class="n">bank1</span><span class="o">.</span><span class="n">get_policy_stance</span><span class="p">()</span>
                <span class="n">stance2</span> <span class="o">=</span> <span class="n">bank2</span><span class="o">.</span><span class="n">get_policy_stance</span><span class="p">()</span>
                
                <span class="c1"># Look for divergence</span>
                <span class="k">if</span> <span class="n">stance1</span> <span class="o">==</span> <span class="s1">&#39;hawkish&#39;</span> <span class="ow">and</span> <span class="n">stance2</span> <span class="o">==</span> <span class="s1">&#39;dovish&#39;</span><span class="p">:</span>
                    <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">curr1</span><span class="p">,</span>
                        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">curr2</span><span class="p">,</span>
                        <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bank1</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> hawkish vs </span><span class="si">{</span><span class="n">bank2</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> dovish&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="s1">&#39;strong&#39;</span>
                    <span class="p">})</span>
                <span class="k">elif</span> <span class="n">stance1</span> <span class="o">==</span> <span class="s1">&#39;dovish&#39;</span> <span class="ow">and</span> <span class="n">stance2</span> <span class="o">==</span> <span class="s1">&#39;hawkish&#39;</span><span class="p">:</span>
                    <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">curr2</span><span class="p">,</span>
                        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">curr1</span><span class="p">,</span>
                        <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">bank2</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> hawkish vs </span><span class="si">{</span><span class="n">bank1</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> dovish&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="s1">&#39;strong&#39;</span>
                    <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">signals</span>

<span class="c1"># Demo</span>
<span class="n">monitor</span> <span class="o">=</span> <span class="n">CentralBankMonitor</span><span class="p">()</span>
<span class="n">monitor</span><span class="o">.</span><span class="n">add_bank</span><span class="p">(</span><span class="n">fed</span><span class="p">)</span>
<span class="n">monitor</span><span class="o">.</span><span class="n">add_bank</span><span class="p">(</span><span class="n">ecb</span><span class="p">)</span>
<span class="n">monitor</span><span class="o">.</span><span class="n">add_bank</span><span class="p">(</span><span class="n">CentralBank</span><span class="p">(</span><span class="s1">&#39;Bank of Japan&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rate Differentials:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monitor</span><span class="o">.</span><span class="n">get_all_differentials</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Policy Divergence Signals:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">monitor</span><span class="o">.</span><span class="n">policy_divergence_signals</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Long </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Short </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Reason: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>6.3 Economic Calendar</h2>
<p>An economic calendar tracks scheduled data releases and events. It's essential for avoiding unexpected volatility and finding trading opportunities.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">EventImpact</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">LOW</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">MEDIUM</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">HIGH</span> <span class="o">=</span> <span class="mi">3</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CalendarEvent</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents an economic calendar event.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">datetime</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">impact</span><span class="p">:</span> <span class="n">EventImpact</span>
    <span class="n">forecast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">previous</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">actual</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_released</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">surprise</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">beat_forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">surprise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">surprise</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Demo</span>
<span class="n">nfp_event</span> <span class="o">=</span> <span class="n">CalendarEvent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Non-Farm Payrolls&#39;</span><span class="p">,</span>
    <span class="n">country</span><span class="o">=</span><span class="s1">&#39;US&#39;</span><span class="p">,</span>
    <span class="n">datetime</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="n">impact</span><span class="o">=</span><span class="n">EventImpact</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span>
    <span class="n">forecast</span><span class="o">=</span><span class="mf">240.0</span><span class="p">,</span>
    <span class="n">previous</span><span class="o">=</span><span class="mf">303.0</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Event: </span><span class="si">{</span><span class="n">nfp_event</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time: </span><span class="si">{</span><span class="n">nfp_event</span><span class="o">.</span><span class="n">datetime</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Impact: </span><span class="si">{</span><span class="n">nfp_event</span><span class="o">.</span><span class="n">impact</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forecast: </span><span class="si">{</span><span class="n">nfp_event</span><span class="o">.</span><span class="n">forecast</span><span class="si">}</span><span class="s2">K&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Released: </span><span class="si">{</span><span class="n">nfp_event</span><span class="o">.</span><span class="n">is_released</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">EconomicCalendar</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage economic calendar events.&quot;&quot;&quot;</span>
    
    <span class="c1"># Standard high-impact events</span>
    <span class="n">HIGH_IMPACT_EVENTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;US&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Non-Farm Payrolls&#39;</span><span class="p">,</span> <span class="s1">&#39;CPI&#39;</span><span class="p">,</span> <span class="s1">&#39;FOMC Rate Decision&#39;</span><span class="p">,</span> <span class="s1">&#39;GDP&#39;</span><span class="p">,</span> <span class="s1">&#39;Retail Sales&#39;</span><span class="p">],</span>
        <span class="s1">&#39;EU&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ECB Rate Decision&#39;</span><span class="p">,</span> <span class="s1">&#39;CPI&#39;</span><span class="p">,</span> <span class="s1">&#39;GDP&#39;</span><span class="p">,</span> <span class="s1">&#39;German ZEW&#39;</span><span class="p">],</span>
        <span class="s1">&#39;UK&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;BoE Rate Decision&#39;</span><span class="p">,</span> <span class="s1">&#39;CPI&#39;</span><span class="p">,</span> <span class="s1">&#39;GDP&#39;</span><span class="p">,</span> <span class="s1">&#39;Employment&#39;</span><span class="p">],</span>
        <span class="s1">&#39;JP&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;BoJ Rate Decision&#39;</span><span class="p">,</span> <span class="s1">&#39;CPI&#39;</span><span class="p">,</span> <span class="s1">&#39;GDP&#39;</span><span class="p">,</span> <span class="s1">&#39;Tankan&#39;</span><span class="p">],</span>
        <span class="s1">&#39;AU&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;RBA Rate Decision&#39;</span><span class="p">,</span> <span class="s1">&#39;Employment&#39;</span><span class="p">,</span> <span class="s1">&#39;CPI&#39;</span><span class="p">],</span>
        <span class="s1">&#39;CA&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;BoC Rate Decision&#39;</span><span class="p">,</span> <span class="s1">&#39;Employment&#39;</span><span class="p">,</span> <span class="s1">&#39;CPI&#39;</span><span class="p">],</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CalendarEvent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">CalendarEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add event to calendar.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_upcoming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span> 
                     <span class="n">min_impact</span><span class="p">:</span> <span class="n">EventImpact</span> <span class="o">=</span> <span class="n">EventImpact</span><span class="o">.</span><span class="n">LOW</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">CalendarEvent</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get upcoming events within time window.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">.</span><span class="n">datetime</span> <span class="o">&lt;=</span> <span class="n">cutoff</span>
            <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">impact</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">min_impact</span><span class="o">.</span><span class="n">value</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">is_released</span>
        <span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_by_country</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">CalendarEvent</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get events for specific country.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="n">country</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_high_impact_today</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">CalendarEvent</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get today&#39;s high-impact events.&quot;&quot;&quot;</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">today</span>
            <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">impact</span> <span class="o">==</span> <span class="n">EventImpact</span><span class="o">.</span><span class="n">HIGH</span>
        <span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">currency_risk_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate event risk score for a currency.&quot;&quot;&quot;</span>
        <span class="c1"># Map currencies to countries</span>
        <span class="n">currency_country</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;USD&#39;</span><span class="p">:</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR&#39;</span><span class="p">:</span> <span class="s1">&#39;EU&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">:</span> <span class="s1">&#39;UK&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">:</span> <span class="s1">&#39;JP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;AUD&#39;</span><span class="p">:</span> <span class="s1">&#39;AU&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">:</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">:</span> <span class="s1">&#39;CH&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">:</span> <span class="s1">&#39;NZ&#39;</span>
        <span class="p">}</span>
        
        <span class="n">country</span> <span class="o">=</span> <span class="n">currency_country</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
        <span class="n">upcoming</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_upcoming</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span>
        <span class="n">country_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">upcoming</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="n">country</span><span class="p">]</span>
        
        <span class="n">risk_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">impact</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">country_events</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;event_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">country_events</span><span class="p">),</span>
            <span class="s1">&#39;risk_score&#39;</span><span class="p">:</span> <span class="n">risk_score</span><span class="p">,</span>
            <span class="s1">&#39;high_impact_events&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">country_events</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">impact</span> <span class="o">==</span> <span class="n">EventImpact</span><span class="o">.</span><span class="n">HIGH</span><span class="p">],</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;avoid&#39;</span> <span class="k">if</span> <span class="n">risk_score</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;caution&#39;</span> <span class="k">if</span> <span class="n">risk_score</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert calendar to DataFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
            <span class="p">{</span>
                <span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
                <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">country</span><span class="p">,</span>
                <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">impact</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;forecast&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">forecast</span><span class="p">,</span>
                <span class="s1">&#39;previous&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">previous</span><span class="p">,</span>
                <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">actual</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span>
        <span class="p">])</span>

<span class="c1"># Demo: Create sample calendar</span>
<span class="n">calendar</span> <span class="o">=</span> <span class="n">EconomicCalendar</span><span class="p">()</span>

<span class="c1"># Add some events</span>
<span class="n">base_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">calendar</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">CalendarEvent</span><span class="p">(</span>
    <span class="s1">&#39;Non-Farm Payrolls&#39;</span><span class="p">,</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="n">base_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">EventImpact</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span> <span class="n">forecast</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span> <span class="n">previous</span><span class="o">=</span><span class="mi">303</span>
<span class="p">))</span>
<span class="n">calendar</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">CalendarEvent</span><span class="p">(</span>
    <span class="s1">&#39;ECB Rate Decision&#39;</span><span class="p">,</span> <span class="s1">&#39;EU&#39;</span><span class="p">,</span> <span class="n">base_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">EventImpact</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span> <span class="n">forecast</span><span class="o">=</span><span class="mf">4.50</span><span class="p">,</span> <span class="n">previous</span><span class="o">=</span><span class="mf">4.50</span>
<span class="p">))</span>
<span class="n">calendar</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">CalendarEvent</span><span class="p">(</span>
    <span class="s1">&#39;US Retail Sales&#39;</span><span class="p">,</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="n">base_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">EventImpact</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">,</span> <span class="n">forecast</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">previous</span><span class="o">=</span><span class="mf">0.6</span>
<span class="p">))</span>
<span class="n">calendar</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">CalendarEvent</span><span class="p">(</span>
    <span class="s1">&#39;German ZEW&#39;</span><span class="p">,</span> <span class="s1">&#39;EU&#39;</span><span class="p">,</span> <span class="n">base_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">EventImpact</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">,</span> <span class="n">forecast</span><span class="o">=</span><span class="mf">42.5</span><span class="p">,</span> <span class="n">previous</span><span class="o">=</span><span class="mf">38.4</span>
<span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Upcoming High Impact Events (24h):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">calendar</span><span class="o">.</span><span class="n">get_upcoming</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">EventImpact</span><span class="o">.</span><span class="n">HIGH</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">country</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">USD Risk Assessment:&quot;</span><span class="p">)</span>
<span class="n">risk</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">currency_risk_score</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Events: </span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;event_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Risk Score: </span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;risk_score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Recommendation: </span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;recommendation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>6.4 Intermarket Analysis</h2>
<p>Intermarket analysis examines relationships between different asset classes to gain insights into currency movements.</p></div>
<div class="md-cell"><h3>Key Intermarket Relationships</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Relationship</th>
<th>Correlation</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>USD vs Gold</td>
<td>Negative</td>
<td>Gold priced in USD; weak USD = expensive gold</td>
</tr>
<tr>
<td>AUD vs Gold</td>
<td>Positive</td>
<td>Australia major gold exporter</td>
</tr>
<tr>
<td>CAD vs Oil</td>
<td>Positive</td>
<td>Canada major oil exporter</td>
</tr>
<tr>
<td>USD vs US Yields</td>
<td>Positive</td>
<td>Higher yields attract USD investment</td>
</tr>
<tr>
<td>JPY vs Risk</td>
<td>Negative</td>
<td>JPY is safe haven; strengthens in risk-off</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">IntermarketAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze relationships between currencies and other markets.&quot;&quot;&quot;</span>
    
    <span class="c1"># Known correlations (positive = move together, negative = inverse)</span>
    <span class="n">KNOWN_CORRELATIONS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;GOLD&#39;</span><span class="p">):</span> <span class="mf">0.7</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;OIL&#39;</span><span class="p">):</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GOLD&#39;</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;US10Y&#39;</span><span class="p">):</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;VIX&#39;</span><span class="p">):</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Safe haven</span>
        <span class="p">(</span><span class="s1">&#39;CHF&#39;</span><span class="p">,</span> <span class="s1">&#39;VIX&#39;</span><span class="p">):</span> <span class="mf">0.4</span><span class="p">,</span>  <span class="c1"># Safe haven</span>
        <span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;SPX&#39;</span><span class="p">):</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Risk currency</span>
        <span class="p">(</span><span class="s1">&#39;NZD&#39;</span><span class="p">,</span> <span class="s1">&#39;SPX&#39;</span><span class="p">):</span> <span class="mf">0.4</span><span class="p">,</span>  <span class="c1"># Risk currency</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add price data for an asset.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">calculate_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate returns for an asset.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">symbol2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                             <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate rolling correlation between two assets.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span> <span class="ow">or</span> <span class="n">symbol2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="n">returns1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_returns</span><span class="p">(</span><span class="n">symbol1</span><span class="p">)</span>
        <span class="n">returns2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_returns</span><span class="p">(</span><span class="n">symbol2</span><span class="p">)</span>
        
        <span class="c1"># Align data</span>
        <span class="n">aligned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">returns1</span><span class="p">,</span> <span class="n">returns2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aligned</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="k">return</span> <span class="n">aligned</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">aligned</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">get_correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get correlation matrix for all assets.&quot;&quot;&quot;</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">returns_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="n">sym</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_returns</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">symbols</span>
        <span class="p">})</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">check_divergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">related_asset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check for divergence between currency and related asset.&quot;&quot;&quot;</span>
        <span class="n">expected_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KNOWN_CORRELATIONS</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">currency</span><span class="p">,</span> <span class="n">related_asset</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">expected_corr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">actual_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_correlation</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="n">related_asset</span><span class="p">,</span> <span class="n">lookback</span><span class="p">)</span>
        
        <span class="c1"># Check if correlation has flipped or weakened significantly</span>
        <span class="k">if</span> <span class="n">expected_corr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">actual_corr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">divergence</span> <span class="o">=</span> <span class="s1">&#39;negative_flip&#39;</span>
        <span class="k">elif</span> <span class="n">expected_corr</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">actual_corr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">divergence</span> <span class="o">=</span> <span class="s1">&#39;positive_flip&#39;</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">actual_corr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expected_corr</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">divergence</span> <span class="o">=</span> <span class="s1">&#39;weakened&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">divergence</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;related_asset&#39;</span><span class="p">:</span> <span class="n">related_asset</span><span class="p">,</span>
            <span class="s1">&#39;expected_correlation&#39;</span><span class="p">:</span> <span class="n">expected_corr</span><span class="p">,</span>
            <span class="s1">&#39;actual_correlation&#39;</span><span class="p">:</span> <span class="n">actual_corr</span><span class="p">,</span>
            <span class="s1">&#39;divergence&#39;</span><span class="p">:</span> <span class="n">divergence</span><span class="p">,</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">divergence</span> <span class="o">!=</span> <span class="s1">&#39;normal&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signals from intermarket analysis.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="n">asset</span><span class="p">),</span> <span class="n">expected_corr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">KNOWN_CORRELATIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span> <span class="ow">and</span> <span class="n">asset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">:</span>
                <span class="n">divergence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_divergence</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="n">asset</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">divergence</span> <span class="ow">and</span> <span class="n">divergence</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]:</span>
                    <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">divergence</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">signals</span>

<span class="c1"># Demo with simulated data</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="n">analyzer</span> <span class="o">=</span> <span class="n">IntermarketAnalyzer</span><span class="p">()</span>

<span class="c1"># Simulate correlated data</span>
<span class="n">gold</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">2000</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">60</span><span class="p">))[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">aud</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mf">0.65</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mi">60</span><span class="p">))[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">gold</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">oil</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">75</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">))[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">cad</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mf">1.35</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mi">60</span><span class="p">))[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">oil</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>

<span class="n">analyzer</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;GOLD&#39;</span><span class="p">,</span> <span class="n">gold</span><span class="p">)</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="n">aud</span><span class="p">)</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;OIL&#39;</span><span class="p">,</span> <span class="n">oil</span><span class="p">)</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="n">cad</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation Matrix:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">get_correlation_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">AUD-Gold Divergence Check:&quot;</span><span class="p">)</span>
<span class="n">div</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">check_divergence</span><span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;GOLD&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">div</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expected: </span><span class="si">{</span><span class="n">div</span><span class="p">[</span><span class="s1">&#39;expected_correlation&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Actual: </span><span class="si">{</span><span class="n">div</span><span class="p">[</span><span class="s1">&#39;actual_correlation&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Status: </span><span class="si">{</span><span class="n">div</span><span class="p">[</span><span class="s1">&#39;divergence&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">BondCurrencyAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze bond yields and currency relationships.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yields</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">yields</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add bond yield data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yields</span><span class="p">[</span><span class="n">country</span><span class="p">]</span> <span class="o">=</span> <span class="n">yields</span>
    
    <span class="k">def</span> <span class="nf">add_currency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add currency pair data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currencies</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">yield_spread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">country2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate yield spread between two countries.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">country1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yields</span> <span class="ow">and</span> <span class="n">country2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yields</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">yields</span><span class="p">[</span><span class="n">country1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">yields</span><span class="p">[</span><span class="n">country2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">spread_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">country2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                          <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate correlation between yield spread and currency pair.&quot;&quot;&quot;</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_spread</span><span class="p">(</span><span class="n">country1</span><span class="p">,</span> <span class="n">country2</span><span class="p">)</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">())</span>
        
        <span class="k">if</span> <span class="n">spread</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">currency</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="n">aligned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">spread</span><span class="p">,</span> <span class="n">currency</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aligned</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="k">return</span> <span class="n">aligned</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">aligned</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">analyze_carry_opportunity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high_yield</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">low_yield</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze carry trade opportunity.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">high_yield</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yields</span> <span class="ow">or</span> <span class="n">low_yield</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yields</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_spread</span><span class="p">(</span><span class="n">high_yield</span><span class="p">,</span> <span class="n">low_yield</span><span class="p">)</span>
        <span class="n">current_spread</span> <span class="o">=</span> <span class="n">spread</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spread</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">avg_spread</span> <span class="o">=</span> <span class="n">spread</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spread</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># Check if spread is widening or narrowing</span>
        <span class="n">recent_change</span> <span class="o">=</span> <span class="n">spread</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spread</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spread</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;high_yield_country&#39;</span><span class="p">:</span> <span class="n">high_yield</span><span class="p">,</span>
            <span class="s1">&#39;low_yield_country&#39;</span><span class="p">:</span> <span class="n">low_yield</span><span class="p">,</span>
            <span class="s1">&#39;current_spread&#39;</span><span class="p">:</span> <span class="n">current_spread</span><span class="p">,</span>
            <span class="s1">&#39;average_spread&#39;</span><span class="p">:</span> <span class="n">avg_spread</span><span class="p">,</span>
            <span class="s1">&#39;spread_vs_avg&#39;</span><span class="p">:</span> <span class="n">current_spread</span> <span class="o">-</span> <span class="n">avg_spread</span><span class="p">,</span>
            <span class="s1">&#39;recent_trend&#39;</span><span class="p">:</span> <span class="s1">&#39;widening&#39;</span> <span class="k">if</span> <span class="n">recent_change</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;narrowing&#39;</span><span class="p">,</span>
            <span class="s1">&#39;carry_attractive&#39;</span><span class="p">:</span> <span class="n">current_spread</span> <span class="o">&gt;</span> <span class="n">avg_spread</span> <span class="ow">and</span> <span class="n">recent_change</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">bond_analyzer</span> <span class="o">=</span> <span class="n">BondCurrencyAnalyzer</span><span class="p">()</span>

<span class="c1"># Simulate yield data</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">us_yields</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mf">4.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">jp_yields</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mf">0.1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">eu_yields</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mf">3.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>

<span class="n">bond_analyzer</span><span class="o">.</span><span class="n">add_yield</span><span class="p">(</span><span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="n">us_yields</span><span class="p">)</span>
<span class="n">bond_analyzer</span><span class="o">.</span><span class="n">add_yield</span><span class="p">(</span><span class="s1">&#39;JP&#39;</span><span class="p">,</span> <span class="n">jp_yields</span><span class="p">)</span>
<span class="n">bond_analyzer</span><span class="o">.</span><span class="n">add_yield</span><span class="p">(</span><span class="s1">&#39;EU&#39;</span><span class="p">,</span> <span class="n">eu_yields</span><span class="p">)</span>

<span class="c1"># Currency data</span>
<span class="n">usdjpy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">150</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">bond_analyzer</span><span class="o">.</span><span class="n">add_currency</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="n">usdjpy</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;US-JP Yield Spread Analysis:&quot;</span><span class="p">)</span>
<span class="n">spread</span> <span class="o">=</span> <span class="n">bond_analyzer</span><span class="o">.</span><span class="n">yield_spread</span><span class="p">(</span><span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="s1">&#39;JP&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Current Spread: </span><span class="si">{</span><span class="n">spread</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Carry Trade Analysis (Long USD/JPY):&quot;</span><span class="p">)</span>
<span class="n">carry</span> <span class="o">=</span> <span class="n">bond_analyzer</span><span class="o">.</span><span class="n">analyze_carry_opportunity</span><span class="p">(</span><span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="s1">&#39;JP&#39;</span><span class="p">,</span> <span class="s1">&#39;USDJPY&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Spread vs Average: </span><span class="si">{</span><span class="n">carry</span><span class="p">[</span><span class="s1">&#39;spread_vs_avg&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Recent Trend: </span><span class="si">{</span><span class="n">carry</span><span class="p">[</span><span class="s1">&#39;recent_trend&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Carry Attractive: </span><span class="si">{</span><span class="n">carry</span><span class="p">[</span><span class="s1">&#39;carry_attractive&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2></div>
<div class="md-cell"><h3>Exercise 1: Economic Indicator Analyzer (Guided)</h3>
<p>Complete the <code>IndicatorAnalyzer</code> class that tracks economic indicators and generates currency bias.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">IndicatorAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze economic indicators for currency bias.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">country</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_reading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                    <span class="n">forecast</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">previous</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add an indicator reading.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">indicator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">surprise</span> <span class="o">=</span> <span class="n">actual</span> <span class="o">-</span> <span class="n">forecast</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;improving&#39;</span> <span class="k">if</span> <span class="n">actual</span> <span class="o">&gt;</span> <span class="n">previous</span> <span class="k">else</span> <span class="s1">&#39;deteriorating&#39;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">actual</span><span class="p">,</span>
            <span class="s1">&#39;forecast&#39;</span><span class="p">:</span> <span class="n">forecast</span><span class="p">,</span>
            <span class="s1">&#39;previous&#39;</span><span class="p">:</span> <span class="n">previous</span><span class="p">,</span>
            <span class="s1">&#39;surprise&#39;</span><span class="p">:</span> <span class="n">surprise</span><span class="p">,</span>
            <span class="s1">&#39;beat&#39;</span><span class="p">:</span> <span class="n">actual</span> <span class="n">______</span> <span class="n">forecast</span><span class="p">,</span>
            <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">trend</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_beat_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate what percentage of releases beat forecast.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">indicator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="n">readings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span>
        <span class="n">beats</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">readings</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">beats</span> <span class="o">/</span> <span class="n">______</span><span class="p">(</span><span class="n">readings</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">readings</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="k">def</span> <span class="nf">overall_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate overall currency bias from all indicators.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="n">total_beats</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_readings</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">readings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">readings</span><span class="p">:</span>
                <span class="n">latest</span> <span class="o">=</span> <span class="n">readings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">]:</span>
                    <span class="n">total_beats</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">total_readings</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">total_readings</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="n">beat_pct</span> <span class="o">=</span> <span class="n">total_beats</span> <span class="o">/</span> <span class="n">total_readings</span>
        
        <span class="k">if</span> <span class="n">beat_pct</span> <span class="o">&gt;=</span> <span class="n">______</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">beat_pct</span> <span class="o">&lt;=</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;neutral&#39;</span>

<span class="c1"># Test</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">IndicatorAnalyzer</span><span class="p">(</span><span class="s1">&#39;US&#39;</span><span class="p">)</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">add_reading</span><span class="p">(</span><span class="s1">&#39;NFP&#39;</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">275</span><span class="p">)</span>  <span class="c1"># Beat</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">add_reading</span><span class="p">(</span><span class="s1">&#39;CPI&#39;</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">)</span>  <span class="c1"># Beat</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">add_reading</span><span class="p">(</span><span class="s1">&#39;GDP&#39;</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">)</span>  <span class="c1"># Miss</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NFP Beat Rate: </span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">get_beat_rate</span><span class="p">(</span><span class="s1">&#39;NFP&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overall Bias: </span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">overall_bias</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">IndicatorAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze economic indicators for currency bias.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">country</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_reading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                    <span class="n">forecast</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">previous</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add an indicator reading.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">indicator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">surprise</span> <span class="o">=</span> <span class="n">actual</span> <span class="o">-</span> <span class="n">forecast</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;improving&#39;</span> <span class="k">if</span> <span class="n">actual</span> <span class="o">&gt;</span> <span class="n">previous</span> <span class="k">else</span> <span class="s1">&#39;deteriorating&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">actual</span><span class="p">,</span>
            <span class="s1">&#39;forecast&#39;</span><span class="p">:</span> <span class="n">forecast</span><span class="p">,</span>
            <span class="s1">&#39;previous&#39;</span><span class="p">:</span> <span class="n">previous</span><span class="p">,</span>
            <span class="s1">&#39;surprise&#39;</span><span class="p">:</span> <span class="n">surprise</span><span class="p">,</span>
            <span class="s1">&#39;beat&#39;</span><span class="p">:</span> <span class="n">actual</span> <span class="o">&gt;</span> <span class="n">forecast</span><span class="p">,</span>
            <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">trend</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">get_beat_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate what percentage of releases beat forecast.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">indicator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">readings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">indicator</span><span class="p">]</span>
        <span class="n">beats</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">readings</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">beats</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">readings</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">readings</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">overall_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate overall currency bias from all indicators.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;neutral&#39;</span>

        <span class="n">total_beats</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_readings</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">readings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">readings</span><span class="p">:</span>
                <span class="n">latest</span> <span class="o">=</span> <span class="n">readings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">]:</span>
                    <span class="n">total_beats</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">total_readings</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">total_readings</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;neutral&#39;</span>

        <span class="n">beat_pct</span> <span class="o">=</span> <span class="n">total_beats</span> <span class="o">/</span> <span class="n">total_readings</span>

        <span class="k">if</span> <span class="n">beat_pct</span> <span class="o">&gt;=</span> <span class="mf">0.6</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">beat_pct</span> <span class="o">&lt;=</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;neutral&#39;</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 2: Central Bank Rate Tracker (Guided)</h3>
<p>Complete the <code>RateTracker</code> class that monitors central bank rates and calculates rate differentials.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">RateTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track central bank interest rates.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">set_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set current rate for a currency.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
        
        <span class="k">if</span> <span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">((</span>
            <span class="n">date</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="n">rate</span>
        <span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">get_differential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curr1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">curr2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get rate differential between two currencies.&quot;&quot;&quot;</span>
        <span class="n">rate1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rate2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rate1</span> <span class="n">______</span> <span class="n">rate2</span>
    
    <span class="k">def</span> <span class="nf">get_highest_yielding</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get currency with highest yield.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">______</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">get_carry_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get best carry trade pairs (long high yield, short low yield).&quot;&quot;&quot;</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">currencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currencies</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">currencies</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_differential</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>  <span class="c1"># Minimum 1% differential</span>
                    <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">c1</span> <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">c2</span><span class="p">,</span>
                        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">c2</span> <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">c1</span><span class="p">,</span>
                        <span class="s1">&#39;differential&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
                    <span class="p">})</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;differential&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">tracker</span> <span class="o">=</span> <span class="n">RateTracker</span><span class="p">()</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">)</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">)</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="mf">5.00</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USD-JPY Differential: </span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get_differential</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Highest Yielding: </span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get_highest_yielding</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best Carry Pairs:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get_carry_pairs</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Long </span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/Short </span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;differential&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RateTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track central bank interest rates.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">set_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set current rate for a currency.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>

        <span class="k">if</span> <span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
            <span class="n">date</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="n">rate</span>
        <span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_differential</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curr1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">curr2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get rate differential between two currencies.&quot;&quot;&quot;</span>
        <span class="n">rate1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rate2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">curr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rate1</span> <span class="o">-</span> <span class="n">rate2</span>

    <span class="k">def</span> <span class="nf">get_highest_yielding</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get currency with highest yield.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_carry_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get best carry trade pairs.&quot;&quot;&quot;</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">currencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currencies</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">currencies</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_differential</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">c1</span> <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">c2</span><span class="p">,</span>
                        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">c2</span> <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">c1</span><span class="p">,</span>
                        <span class="s1">&#39;differential&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;differential&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 3: Event Impact Scorer (Guided)</h3>
<p>Complete the <code>EventScorer</code> class that scores economic events based on their potential market impact.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">EventScorer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Score economic events for trading decisions.&quot;&quot;&quot;</span>
    
    <span class="n">BASE_SCORES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;rate_decision&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;nfp&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s1">&#39;cpi&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s1">&#39;gdp&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="s1">&#39;retail_sales&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;pmi&#39;</span><span class="p">:</span> <span class="mi">4</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">surprise_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add event with its surprise magnitude.&quot;&quot;&quot;</span>
        <span class="n">base_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_SCORES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event_type</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="c1"># Adjust score based on surprise magnitude</span>
        <span class="n">surprise_multiplier</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">______</span><span class="p">(</span><span class="n">surprise_pct</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">final_score</span> <span class="o">=</span> <span class="n">base_score</span> <span class="o">*</span> <span class="n">surprise_multiplier</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">event_type</span><span class="p">,</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;surprise_pct&#39;</span><span class="p">:</span> <span class="n">surprise_pct</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">final_score</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">if</span> <span class="n">surprise_pct</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;bearish&#39;</span> <span class="k">if</span> <span class="n">surprise_pct</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_currency_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get aggregate score for a currency.&quot;&quot;&quot;</span>
        <span class="n">currency_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">currency</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">currency_events</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">}</span>
        
        <span class="n">bullish_score</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">currency_events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">)</span>
        <span class="n">bearish_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">currency_events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span><span class="p">)</span>
        
        <span class="n">net_score</span> <span class="o">=</span> <span class="n">bullish_score</span> <span class="o">-</span> <span class="n">bearish_score</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;bullish_score&#39;</span><span class="p">:</span> <span class="n">bullish_score</span><span class="p">,</span>
            <span class="s1">&#39;bearish_score&#39;</span><span class="p">:</span> <span class="n">bearish_score</span><span class="p">,</span>
            <span class="s1">&#39;net_score&#39;</span><span class="p">:</span> <span class="n">net_score</span><span class="p">,</span>
            <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">if</span> <span class="n">net_score</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;______&#39;</span> <span class="k">if</span> <span class="n">net_score</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">scorer</span> <span class="o">=</span> <span class="n">EventScorer</span><span class="p">()</span>
<span class="n">scorer</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s1">&#39;NFP&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">15.5</span><span class="p">)</span>  <span class="c1"># Big beat</span>
<span class="n">scorer</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s1">&#39;CPI&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">2.9</span><span class="p">)</span>   <span class="c1"># Small beat</span>
<span class="n">scorer</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="s1">&#39;GDP&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">36.0</span><span class="p">)</span> <span class="c1"># Big miss</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">scorer</span><span class="o">.</span><span class="n">get_currency_score</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;USD Analysis:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bullish Score: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;bullish_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bearish Score: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;bearish_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Net Score: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;net_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bias: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">EventScorer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Score economic events for trading decisions.&quot;&quot;&quot;</span>

    <span class="n">BASE_SCORES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;rate_decision&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;nfp&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s1">&#39;cpi&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s1">&#39;gdp&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="s1">&#39;retail_sales&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;pmi&#39;</span><span class="p">:</span> <span class="mi">4</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">surprise_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add event with its surprise magnitude.&quot;&quot;&quot;</span>
        <span class="n">base_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BASE_SCORES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event_type</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">surprise_multiplier</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">surprise_pct</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">final_score</span> <span class="o">=</span> <span class="n">base_score</span> <span class="o">*</span> <span class="n">surprise_multiplier</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">event_type</span><span class="p">,</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;surprise_pct&#39;</span><span class="p">:</span> <span class="n">surprise_pct</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">final_score</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">if</span> <span class="n">surprise_pct</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;bearish&#39;</span> <span class="k">if</span> <span class="n">surprise_pct</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">get_currency_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get aggregate score for a currency.&quot;&quot;&quot;</span>
        <span class="n">currency_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">currency</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">currency_events</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">}</span>

        <span class="n">bullish_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">currency_events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">)</span>
        <span class="n">bearish_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">currency_events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span><span class="p">)</span>

        <span class="n">net_score</span> <span class="o">=</span> <span class="n">bullish_score</span> <span class="o">-</span> <span class="n">bearish_score</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;bullish_score&#39;</span><span class="p">:</span> <span class="n">bullish_score</span><span class="p">,</span>
            <span class="s1">&#39;bearish_score&#39;</span><span class="p">:</span> <span class="n">bearish_score</span><span class="p">,</span>
            <span class="s1">&#39;net_score&#39;</span><span class="p">:</span> <span class="n">net_score</span><span class="p">,</span>
            <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">if</span> <span class="n">net_score</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;bearish&#39;</span> <span class="k">if</span> <span class="n">net_score</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 4: Complete Economic Calendar (Open-ended)</h3>
<p>Build a comprehensive economic calendar system that:
- Stores events with full details
- Filters by date range, country, and impact
- Calculates risk scores for trading windows
- Generates pre-event alerts</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4: Complete Economic Calendar (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class ComprehensiveCalendar</span>
<span class="c1"># 2. Store events with: name, country, datetime, impact, forecast, previous, actual</span>
<span class="c1"># 3. Methods: add_event, get_events_in_range, filter_by_impact, filter_by_country</span>
<span class="c1"># 4. Calculate risk_score for a time window (sum of impact levels)</span>
<span class="c1"># 5. Generate alerts for high-impact events in next N hours</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ComprehensiveCalendar</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Full-featured economic calendar.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
                  <span class="n">impact</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">forecast</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">previous</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add event to calendar.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="n">country</span><span class="p">,</span>
            <span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">,</span>
            <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="n">impact</span><span class="p">,</span>  <span class="c1"># 1-3</span>
            <span class="s1">&#39;forecast&#39;</span><span class="p">:</span> <span class="n">forecast</span><span class="p">,</span>
            <span class="s1">&#39;previous&#39;</span><span class="p">:</span> <span class="n">previous</span><span class="p">,</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">actual</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_events_in_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get events within date range.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">filter_by_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_impact</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Filter events by minimum impact level.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;impact&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_impact</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">filter_by_country</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Filter events by country.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">country</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">risk_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate risk score for time window.&quot;&quot;&quot;</span>
        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_events_in_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;impact&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours_ahead</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get alerts for high-impact events.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours_ahead</span><span class="p">)</span>

        <span class="n">high_impact</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cutoff</span> <span class="ow">and</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;impact&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="p">[{</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">],</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">],</span>
            <span class="s1">&#39;hours_until&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">high_impact</span><span class="p">]</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 5: Intermarket Correlation Tracker (Open-ended)</h3>
<p>Build an intermarket analyzer that:
- Tracks correlations between currencies and related assets
- Detects correlation breakdowns
- Generates divergence signals</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 5: Intermarket Correlation Tracker (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class CorrelationTracker</span>
<span class="c1"># 2. Store price series for multiple assets</span>
<span class="c1"># 3. Calculate rolling correlations</span>
<span class="c1"># 4. Define expected correlations (e.g., AUD-Gold positive)</span>
<span class="c1"># 5. Detect when actual correlation deviates from expected</span>
<span class="c1"># 6. Generate trading signals from divergences</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CorrelationTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track and analyze intermarket correlations.&quot;&quot;&quot;</span>

    <span class="n">EXPECTED</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;GOLD&#39;</span><span class="p">):</span> <span class="mf">0.6</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;OIL&#39;</span><span class="p">):</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GOLD&#39;</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;VIX&#39;</span><span class="p">):</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add price series.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>

    <span class="k">def</span> <span class="nf">rolling_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sym1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sym2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate rolling correlation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sym1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">or</span> <span class="n">sym2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>

        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sym1</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sym2</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r1</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_divergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sym1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sym2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for correlation divergence.&quot;&quot;&quot;</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">sym1</span><span class="p">,</span> <span class="n">sym2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">sym2</span><span class="p">,</span> <span class="n">sym1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling_correlation</span><span class="p">(</span><span class="n">sym1</span><span class="p">,</span> <span class="n">sym2</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="n">actual</span> <span class="o">-</span> <span class="n">expected</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sym1</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sym2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">actual</span><span class="p">,</span>
            <span class="s1">&#39;deviation&#39;</span><span class="p">:</span> <span class="n">deviation</span><span class="p">,</span>
            <span class="s1">&#39;divergence&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">deviation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">,</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;divergence_detected&#39;</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">deviation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="s1">&#39;normal&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">scan_all_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Scan all known pairs for divergences.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">sym1</span><span class="p">,</span> <span class="n">sym2</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPECTED</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sym1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="n">sym2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_divergence</span><span class="p">(</span><span class="n">sym1</span><span class="p">,</span> <span class="n">sym2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;divergence&#39;</span><span class="p">]:</span>
                    <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">signals</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 6: Fundamental Dashboard Builder (Open-ended)</h3>
<p>Build a comprehensive fundamental analysis dashboard that combines:
- Economic indicators tracking
- Central bank monitoring
- Economic calendar
- Intermarket analysis
- Overall currency bias scoring</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 6: Fundamental Dashboard Builder (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class FundamentalDashboard</span>
<span class="c1"># 2. Integrate: indicator tracker, central bank monitor, calendar, intermarket</span>
<span class="c1"># 3. Calculate overall fundamental score per currency</span>
<span class="c1"># 4. Rank currencies from most bullish to most bearish</span>
<span class="c1"># 5. Generate pair recommendations (long strongest vs short weakest)</span>
<span class="c1"># 6. Print formatted dashboard report</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FundamentalDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive fundamental analysis dashboard.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EconomicIndicatorTracker</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CentralBank</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="n">EconomicCalendar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intermarket</span> <span class="o">=</span> <span class="n">IntermarketAnalyzer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_country</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a country to track.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">EconomicIndicatorTracker</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">CentralBank</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2"> CB&quot;</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_currency_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate overall fundamental score for currency.&quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Neutral base</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Economic indicators</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">:</span>
            <span class="n">econ_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">get_economic_score</span><span class="p">()</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="p">(</span><span class="n">econ_score</span><span class="p">[</span><span class="s1">&#39;overall_score&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span>
            <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Econ: </span><span class="si">{</span><span class="n">econ_score</span><span class="p">[</span><span class="s1">&#39;interpretation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Central bank stance</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">:</span>
            <span class="n">stance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">get_policy_stance</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stance</span> <span class="o">==</span> <span class="s1">&#39;hawkish&#39;</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">15</span>
            <span class="k">elif</span> <span class="n">stance</span> <span class="o">==</span> <span class="s1">&#39;dovish&#39;</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">-=</span> <span class="mi">15</span>
            <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CB: </span><span class="si">{</span><span class="n">stance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Event risk</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="o">.</span><span class="n">currency_risk_score</span><span class="p">(</span><span class="n">currency</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">risk</span><span class="p">[</span><span class="s1">&#39;recommendation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;avoid&#39;</span><span class="p">:</span>
            <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;High event risk&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">score</span><span class="p">)),</span>
            <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;bearish&#39;</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mi">40</span> <span class="k">else</span> <span class="s1">&#39;neutral&#39;</span><span class="p">),</span>
            <span class="s1">&#39;factors&#39;</span><span class="p">:</span> <span class="n">factors</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">rank_currencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Rank all currencies by fundamental score.&quot;&quot;&quot;</span>
        <span class="n">rankings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">rankings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_currency_score</span><span class="p">(</span><span class="n">currency</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rankings</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pair_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get pair recommendations based on rankings.&quot;&quot;&quot;</span>
        <span class="n">rankings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_currencies</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rankings</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">strongest</span> <span class="o">=</span> <span class="n">rankings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">weakest</span> <span class="o">=</span> <span class="n">rankings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">strongest</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">weakest</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">strongest</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">],</span>
                <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">weakest</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">],</span>
                <span class="s1">&#39;score_diff&#39;</span><span class="p">:</span> <span class="n">strongest</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">weakest</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span>
                <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="n">strongest</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">weakest</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">30</span> <span class="k">else</span> <span class="s1">&#39;medium&#39;</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">recommendations</span>

    <span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print formatted dashboard report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  FUNDAMENTAL ANALYSIS DASHBOARD&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Currency Rankings:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_currencies</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Factors: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;factors&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recommendations:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pair_recommendations</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Long </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/Short </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Confidence: </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Fundamental Analysis Dashboard</h2>
<p>Build a production-ready fundamental analysis system that integrates all concepts from this module.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">FundamentalAnalysisDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready fundamental analysis dashboard.</span>
<span class="sd">    </span>
<span class="sd">    Integrates: Economic indicators, Central banks, Calendar, Intermarket.</span>
<span class="sd">    Provides: Currency rankings, Pair recommendations, Risk assessment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">CURRENCIES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;CHF&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicator_trackers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EconomicIndicatorTracker</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CentralBank</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="n">EconomicCalendar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intermarket</span> <span class="o">=</span> <span class="n">IntermarketAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currency_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">initialize_country</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">country</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                          <span class="n">current_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">cb_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize tracking for a country/currency.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indicator_trackers</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">EconomicIndicatorTracker</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">CentralBank</span><span class="p">(</span><span class="n">cb_name</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">current_rate</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_indicator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">indicator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">actual</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">forecast</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">previous</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update an economic indicator.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator_trackers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indicator_trackers</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">update_indicator</span><span class="p">(</span>
                <span class="n">indicator</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">actual</span><span class="p">,</span> <span class="n">forecast</span><span class="p">,</span> <span class="n">previous</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update_rate_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">expected</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tone</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Record a rate decision.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">add_rate_decision</span><span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">new_rate</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">tone</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_fundamental_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate comprehensive fundamental score.&quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Neutral base</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># 1. Economic Indicators (40% weight)</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator_trackers</span><span class="p">:</span>
            <span class="n">econ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indicator_trackers</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">get_economic_score</span><span class="p">()</span>
            <span class="n">econ_score</span> <span class="o">=</span> <span class="n">econ</span><span class="p">[</span><span class="s1">&#39;overall_score&#39;</span><span class="p">]</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="p">(</span><span class="n">econ_score</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span>
            <span class="n">components</span><span class="p">[</span><span class="s1">&#39;economic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">econ_score</span>
        
        <span class="c1"># 2. Central Bank Stance (30% weight)</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span>
            <span class="n">stance</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">get_policy_stance</span><span class="p">()</span>
            <span class="n">stance_score</span> <span class="o">=</span> <span class="mi">70</span> <span class="k">if</span> <span class="n">stance</span> <span class="o">==</span> <span class="s1">&#39;hawkish&#39;</span> <span class="k">else</span> <span class="p">(</span><span class="mi">30</span> <span class="k">if</span> <span class="n">stance</span> <span class="o">==</span> <span class="s1">&#39;dovish&#39;</span> <span class="k">else</span> <span class="mi">50</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="p">(</span><span class="n">stance_score</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span>
            <span class="n">components</span><span class="p">[</span><span class="s1">&#39;central_bank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">cb</span><span class="o">.</span><span class="n">current_rate</span><span class="p">,</span>
                <span class="s1">&#39;stance&#39;</span><span class="p">:</span> <span class="n">stance</span><span class="p">,</span>
                <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">stance_score</span>
            <span class="p">}</span>
        
        <span class="c1"># 3. Rate Differentials (20% weight)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">avg_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">cb</span><span class="o">.</span><span class="n">current_rate</span> <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="k">if</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">current_rate</span> <span class="o">-</span> <span class="n">avg_rate</span>
                <span class="n">diff_score</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># +10 points per 1% above average</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="p">(</span><span class="n">diff_score</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
                <span class="n">components</span><span class="p">[</span><span class="s1">&#39;rate_differential&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span>
        
        <span class="c1"># 4. Event Risk (10% weight - penalty only)</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="o">.</span><span class="n">currency_risk_score</span><span class="p">(</span><span class="n">currency</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">risk</span><span class="p">[</span><span class="s1">&#39;risk_score&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">5</span>
            <span class="n">components</span><span class="p">[</span><span class="s1">&#39;event_risk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">components</span><span class="p">[</span><span class="s1">&#39;event_risk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
        
        <span class="n">final_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currency_scores</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_score</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">final_score</span><span class="p">,</span>
            <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score_to_bias</span><span class="p">(</span><span class="n">final_score</span><span class="p">),</span>
            <span class="s1">&#39;components&#39;</span><span class="p">:</span> <span class="n">components</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_score_to_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert score to bias label.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;strong_bullish&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">55</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">45</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;neutral&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">35</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;strong_bearish&#39;</span>
    
    <span class="k">def</span> <span class="nf">get_currency_rankings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Rank all currencies by fundamental score.&quot;&quot;&quot;</span>
        <span class="n">rankings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_banks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">rankings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_fundamental_score</span><span class="p">(</span><span class="n">currency</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rankings</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_trade_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate trade recommendations.&quot;&quot;&quot;</span>
        <span class="n">rankings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_currency_rankings</span><span class="p">()</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rankings</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">recommendations</span>
        
        <span class="c1"># Top recommendation: strongest vs weakest</span>
        <span class="n">strongest</span> <span class="o">=</span> <span class="n">rankings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">weakest</span> <span class="o">=</span> <span class="n">rankings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">score_diff</span> <span class="o">=</span> <span class="n">strongest</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">weakest</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">score_diff</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">:</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="n">score_diff</span> <span class="o">&gt;=</span> <span class="mi">30</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;medium&#39;</span> <span class="k">if</span> <span class="n">score_diff</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="k">else</span> <span class="s1">&#39;low&#39;</span><span class="p">)</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;divergence&#39;</span><span class="p">,</span>
                <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">strongest</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">],</span>
                <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">weakest</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">],</span>
                <span class="s1">&#39;long_score&#39;</span><span class="p">:</span> <span class="n">strongest</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span>
                <span class="s1">&#39;short_score&#39;</span><span class="p">:</span> <span class="n">weakest</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span>
                <span class="s1">&#39;score_differential&#39;</span><span class="p">:</span> <span class="n">score_diff</span><span class="p">,</span>
                <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">,</span>
                <span class="s1">&#39;rationale&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">strongest</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">strongest</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">weakest</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">weakest</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">})</span>
        
        <span class="c1"># Secondary: second strongest vs second weakest</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rankings</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">second_strong</span> <span class="o">=</span> <span class="n">rankings</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">second_weak</span> <span class="o">=</span> <span class="n">rankings</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">diff2</span> <span class="o">=</span> <span class="n">second_strong</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">second_weak</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">diff2</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">:</span>
                <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;secondary&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">second_strong</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">second_weak</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;long_score&#39;</span><span class="p">:</span> <span class="n">second_strong</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;short_score&#39;</span><span class="p">:</span> <span class="n">second_weak</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;score_differential&#39;</span><span class="p">:</span> <span class="n">diff2</span><span class="p">,</span>
                    <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span> <span class="k">if</span> <span class="n">diff2</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="k">else</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;rationale&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Secondary divergence play&quot;</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">recommendations</span>
    
    <span class="k">def</span> <span class="nf">print_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print formatted dashboard.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  FUNDAMENTAL ANALYSIS DASHBOARD&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="c1"># Currency Rankings</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CURRENCY RANKINGS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_currency_rankings</span><span class="p">(),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="s1">&#39;â–ˆ&#39;</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Bias: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;central_bank&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">]:</span>
                <span class="n">cb</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">][</span><span class="s1">&#39;central_bank&#39;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Rate: </span><span class="si">{</span><span class="n">cb</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% | Stance: </span><span class="si">{</span><span class="n">cb</span><span class="p">[</span><span class="s1">&#39;stance&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Trade Recommendations</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TRADE RECOMMENDATIONS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        
        <span class="n">recommendations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trade_recommendations</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">recommendations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recommendations</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. Long </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> / Short </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Scores: </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;long_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;short_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Differential: </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;score_differential&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> points&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Confidence: </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Rationale: </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;rationale&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No clear opportunities - markets balanced&quot;</span><span class="p">)</span>
        
        <span class="c1"># Upcoming Events</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;HIGH-IMPACT EVENTS (24H)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        
        <span class="n">high_impact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="o">.</span><span class="n">get_upcoming</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="n">EventImpact</span><span class="o">.</span><span class="n">HIGH</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">high_impact</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">high_impact</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">country</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  No high-impact events scheduled&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demo the dashboard</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">FundamentalAnalysisDashboard</span><span class="p">()</span>

<span class="c1"># Initialize major currencies</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">initialize_country</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">,</span> <span class="s1">&#39;Federal Reserve&#39;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">initialize_country</span><span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;EU&#39;</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">,</span> <span class="s1">&#39;ECB&#39;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">initialize_country</span><span class="p">(</span><span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;UK&#39;</span><span class="p">,</span> <span class="mf">5.00</span><span class="p">,</span> <span class="s1">&#39;Bank of England&#39;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">initialize_country</span><span class="p">(</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;JP&#39;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;Bank of Japan&#39;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">initialize_country</span><span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;AU&#39;</span><span class="p">,</span> <span class="mf">4.35</span><span class="p">,</span> <span class="s1">&#39;RBA&#39;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">initialize_country</span><span class="p">(</span><span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="mf">5.00</span><span class="p">,</span> <span class="s1">&#39;Bank of Canada&#39;</span><span class="p">)</span>

<span class="c1"># Add some indicator data</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">update_indicator</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;Non-Farm Payrolls&#39;</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">275</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">update_indicator</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;CPI YoY&#39;</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">update_indicator</span><span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;CPI YoY&#39;</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.6</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">update_indicator</span><span class="p">(</span><span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;CPI YoY&#39;</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">update_indicator</span><span class="p">(</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;CPI YoY&#39;</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">,</span> <span class="mf">2.6</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>

<span class="c1"># Add rate decisions</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">update_rate_decision</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">,</span> <span class="s1">&#39;hawkish&#39;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">update_rate_decision</span><span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">,</span> <span class="s1">&#39;dovish&#39;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">update_rate_decision</span><span class="p">(</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;dovish&#39;</span><span class="p">)</span>

<span class="c1"># Add calendar events</span>
<span class="n">base_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">calendar</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">CalendarEvent</span><span class="p">(</span>
    <span class="s1">&#39;FOMC Minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span> <span class="n">base_time</span><span class="p">,</span> <span class="n">EventImpact</span><span class="o">.</span><span class="n">HIGH</span>
<span class="p">))</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">calendar</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">CalendarEvent</span><span class="p">(</span>
    <span class="s1">&#39;ECB Speech&#39;</span><span class="p">,</span> <span class="s1">&#39;EU&#39;</span><span class="p">,</span> <span class="n">base_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">EventImpact</span><span class="o">.</span><span class="n">MEDIUM</span>
<span class="p">))</span>

<span class="c1"># Print the dashboard</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">print_dashboard</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ul>
<li><strong>Economic Indicators</strong>: Track GDP, inflation, employment to gauge economic health and currency direction</li>
<li><strong>Central Banks</strong>: Monitor rate decisions and policy stance (hawkish vs dovish) for major currency moves</li>
<li><strong>Rate Differentials</strong>: Higher interest rates attract capital, supporting currency strength</li>
<li><strong>Economic Calendar</strong>: Schedule trading around high-impact events; avoid unexpected volatility</li>
<li><strong>Intermarket Analysis</strong>: Currencies correlate with commodities (AUD-Gold, CAD-Oil) and bonds</li>
<li><strong>Carry Trade</strong>: Long high-yield, short low-yield currencies when conditions favor risk-on</li>
<li><strong>Divergence</strong>: Policy divergence between central banks creates trending opportunities</li>
<li><strong>Combine Analysis</strong>: Best results come from aligning fundamental bias with technical setups</li>
</ul>
<p><strong>Next: Module 7 - Commodity Trading</strong> where we'll explore gold, oil, and agricultural markets with their currency relationships.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="7"><div class="md-cell module-header"><h1>Module 7: Commodity Trading</h1>
<p><strong>Part 2: Analysis &amp; Strategies</strong></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ul>
<li>Understand gold market dynamics and safe-haven trading</li>
<li>Analyze crude oil supply/demand and inventory data</li>
<li>Trade agricultural commodities with seasonal patterns</li>
<li>Exploit commodity currency correlations (AUD, CAD, NOK)</li>
</ul>
<h2>Prerequisites</h2>
<ul>
<li>Modules 1-6 (Forex/Futures fundamentals, technical &amp; fundamental analysis)</li>
<li>Understanding of correlation analysis</li>
<li>Python pandas proficiency</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>7.1 Gold Trading</h2>
<p>Gold (XAU) is the premier safe-haven asset, with unique market dynamics driven by fear, inflation expectations, and USD strength.</p></div>
<div class="md-cell"><h3>Gold Market Fundamentals</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Factor</th>
<th>Impact on Gold</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>USD Strength</td>
<td>Negative</td>
<td>Gold priced in USD; strong USD = cheaper gold</td>
</tr>
<tr>
<td>Real Interest Rates</td>
<td>Negative</td>
<td>Higher real yields = opportunity cost of holding gold</td>
</tr>
<tr>
<td>Inflation Expectations</td>
<td>Positive</td>
<td>Gold as inflation hedge</td>
</tr>
<tr>
<td>Geopolitical Risk</td>
<td>Positive</td>
<td>Safe-haven demand</td>
</tr>
<tr>
<td>Central Bank Buying</td>
<td>Positive</td>
<td>Reserve diversification</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">GoldAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze gold market dynamics and generate trading signals.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gold_prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dxy_prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>  <span class="c1"># USD Index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_yields</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>  <span class="c1"># 10Y TIPS yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>  <span class="c1"># Fear index</span>
    
    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gold</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">dxy</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">real_yields</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set market data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gold_prices</span> <span class="o">=</span> <span class="n">gold</span>
        <span class="k">if</span> <span class="n">dxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dxy_prices</span> <span class="o">=</span> <span class="n">dxy</span>
        <span class="k">if</span> <span class="n">real_yields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">real_yields</span> <span class="o">=</span> <span class="n">real_yields</span>
        <span class="k">if</span> <span class="n">vix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vix</span> <span class="o">=</span> <span class="n">vix</span>
    
    <span class="k">def</span> <span class="nf">calculate_gold_usd_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate rolling correlation between gold and USD.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dxy_prices</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        
        <span class="n">gold_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gold_prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">dxy_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dxy_prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">gold_ret</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">dxy_ret</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">safe_haven_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vix_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate safe-haven demand signal.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vix</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>
        
        <span class="n">current_vix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vix_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">current_vix</span> <span class="o">&gt;</span> <span class="n">vix_threshold</span> <span class="ow">and</span> <span class="n">vix_change</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;strong_buy&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Fear spike - safe haven demand&#39;</span>
        <span class="k">elif</span> <span class="n">current_vix</span> <span class="o">&gt;</span> <span class="n">vix_threshold</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Elevated fear - gold supportive&#39;</span>
        <span class="k">elif</span> <span class="n">current_vix</span> <span class="o">&lt;</span> <span class="mi">15</span> <span class="ow">and</span> <span class="n">vix_change</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Risk-on environment - gold headwind&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Normal volatility&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;vix&#39;</span><span class="p">:</span> <span class="n">current_vix</span><span class="p">,</span>
            <span class="s1">&#39;vix_change&#39;</span><span class="p">:</span> <span class="n">vix_change</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">real_yield_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate signal based on real yields.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_yields</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>
        
        <span class="n">current_yield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_yields</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">yield_ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_yields</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Gold is negative correlated with real yields</span>
        <span class="k">if</span> <span class="n">current_yield</span> <span class="o">&lt;</span> <span class="n">yield_ma</span> <span class="ow">and</span> <span class="n">current_yield</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Negative real yields support gold&#39;</span>
        <span class="k">elif</span> <span class="n">current_yield</span> <span class="o">&gt;</span> <span class="n">yield_ma</span> <span class="ow">and</span> <span class="n">current_yield</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;High real yields headwind for gold&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Real yields neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;real_yield&#39;</span><span class="p">:</span> <span class="n">current_yield</span><span class="p">,</span>
            <span class="s1">&#39;yield_ma&#39;</span><span class="p">:</span> <span class="n">yield_ma</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">combined_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Combine all factors for overall gold signal.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;safe_haven&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_haven_signal</span><span class="p">(),</span>
            <span class="s1">&#39;real_yield&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_yield_signal</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="c1"># Score each signal</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">signal_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;strong_buy&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;neutral&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;strong_sell&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">}</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">signals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sig</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">signal_map</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="n">signal_map</span><span class="p">[</span><span class="n">sig</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]]</span>
        
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;strong_buy&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;strong_sell&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="n">overall</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
            <span class="s1">&#39;components&#39;</span><span class="p">:</span> <span class="n">signals</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="n">gold_analyzer</span> <span class="o">=</span> <span class="n">GoldAnalyzer</span><span class="p">()</span>
<span class="n">gold_analyzer</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
    <span class="n">gold</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">2000</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">),</span>
    <span class="n">dxy</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">104</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">),</span>
    <span class="n">vix</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">18</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">),</span>
    <span class="n">real_yields</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gold Analysis:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Safe Haven Signal: </span><span class="si">{</span><span class="n">gold_analyzer</span><span class="o">.</span><span class="n">safe_haven_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Real Yield Signal: </span><span class="si">{</span><span class="n">gold_analyzer</span><span class="o">.</span><span class="n">real_yield_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Combined Signal: </span><span class="si">{</span><span class="n">gold_analyzer</span><span class="o">.</span><span class="n">combined_signal</span><span class="p">()[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>7.2 Oil Trading</h2>
<p>Crude oil (WTI/Brent) is driven by supply/demand dynamics, OPEC decisions, and inventory data.</p></div>
<div class="md-cell"><h3>Key Oil Market Drivers</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Factor</th>
<th>Impact</th>
<th>Data Source</th>
</tr>
</thead>
<tbody>
<tr>
<td>EIA Inventory</td>
<td>Build = Bearish, Draw = Bullish</td>
<td>Weekly (Wed)</td>
</tr>
<tr>
<td>OPEC Production</td>
<td>Cuts = Bullish, Increases = Bearish</td>
<td>Monthly</td>
</tr>
<tr>
<td>Global Demand</td>
<td>GDP growth correlation</td>
<td>IMF, EIA</td>
</tr>
<tr>
<td>Geopolitical</td>
<td>Supply disruption = Bullish</td>
<td>News</td>
</tr>
<tr>
<td>USD Strength</td>
<td>Negative correlation</td>
<td>DXY</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">OilAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze crude oil market and inventory data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opec_production</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">set_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set oil price data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">add_inventory_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">forecast</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">previous</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add EIA inventory report (in millions of barrels).&quot;&quot;&quot;</span>
        <span class="n">change</span> <span class="o">=</span> <span class="n">actual</span> <span class="o">-</span> <span class="n">previous</span>
        <span class="n">surprise</span> <span class="o">=</span> <span class="n">actual</span> <span class="o">-</span> <span class="n">forecast</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">actual</span><span class="p">,</span>
            <span class="s1">&#39;forecast&#39;</span><span class="p">:</span> <span class="n">forecast</span><span class="p">,</span>
            <span class="s1">&#39;previous&#39;</span><span class="p">:</span> <span class="n">previous</span><span class="p">,</span>
            <span class="s1">&#39;change&#39;</span><span class="p">:</span> <span class="n">change</span><span class="p">,</span>
            <span class="s1">&#39;surprise&#39;</span><span class="p">:</span> <span class="n">surprise</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;build&#39;</span> <span class="k">if</span> <span class="n">change</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;draw&#39;</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">inventory_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periods</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze recent inventory trend.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">periods</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="s1">&#39;insufficient_data&#39;</span><span class="p">}</span>
        
        <span class="n">recent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_data</span><span class="p">[</span><span class="o">-</span><span class="n">periods</span><span class="p">:]</span>
        <span class="n">builds</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">recent</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;build&#39;</span><span class="p">)</span>
        <span class="n">draws</span> <span class="o">=</span> <span class="n">periods</span> <span class="o">-</span> <span class="n">builds</span>
        
        <span class="n">total_change</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">recent</span><span class="p">)</span>
        <span class="n">avg_surprise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;surprise&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">recent</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">draws</span> <span class="o">&gt;</span> <span class="n">builds</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">builds</span> <span class="o">&gt;</span> <span class="n">draws</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">trend</span><span class="p">,</span>
            <span class="s1">&#39;builds&#39;</span><span class="p">:</span> <span class="n">builds</span><span class="p">,</span>
            <span class="s1">&#39;draws&#39;</span><span class="p">:</span> <span class="n">draws</span><span class="p">,</span>
            <span class="s1">&#39;total_change_mb&#39;</span><span class="p">:</span> <span class="n">total_change</span><span class="p">,</span>
            <span class="s1">&#39;avg_surprise&#39;</span><span class="p">:</span> <span class="n">avg_surprise</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">inventory_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal from latest inventory.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>
        
        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_trend</span><span class="p">()</span>
        
        <span class="c1"># Signal based on surprise and trend</span>
        <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;surprise&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;strong_buy&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Large draw surprise + bullish trend&#39;</span>
        <span class="k">elif</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;surprise&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Draw larger than expected&#39;</span>
        <span class="k">elif</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;surprise&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;strong_sell&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Large build surprise + bearish trend&#39;</span>
        <span class="k">elif</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;surprise&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Build larger than expected&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Inventory in line with expectations&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
            <span class="s1">&#39;latest_change&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">],</span>
            <span class="s1">&#39;surprise&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;surprise&#39;</span><span class="p">],</span>
            <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_seasonality</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate typical seasonal patterns.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="c1"># Group by month and calculate average returns</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">monthly_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;monthly_avg_returns&#39;</span><span class="p">:</span> <span class="n">monthly_returns</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s1">&#39;best_month&#39;</span><span class="p">:</span> <span class="n">monthly_returns</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span>
            <span class="s1">&#39;worst_month&#39;</span><span class="p">:</span> <span class="n">monthly_returns</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">oil_analyzer</span> <span class="o">=</span> <span class="n">OilAnalyzer</span><span class="p">()</span>
<span class="n">oil_analyzer</span><span class="o">.</span><span class="n">set_prices</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">75</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>

<span class="c1"># Add inventory reports</span>
<span class="n">oil_analyzer</span><span class="o">.</span><span class="n">add_inventory_report</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">451.2</span><span class="p">,</span> <span class="mf">453.0</span><span class="p">,</span> <span class="mf">452.5</span><span class="p">)</span>  <span class="c1"># Draw</span>
<span class="n">oil_analyzer</span><span class="o">.</span><span class="n">add_inventory_report</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="mf">449.8</span><span class="p">,</span> <span class="mf">451.0</span><span class="p">,</span> <span class="mf">451.2</span><span class="p">)</span>  <span class="c1"># Draw</span>
<span class="n">oil_analyzer</span><span class="o">.</span><span class="n">add_inventory_report</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span> <span class="mf">448.5</span><span class="p">,</span> <span class="mf">450.5</span><span class="p">,</span> <span class="mf">449.8</span><span class="p">)</span>  <span class="c1"># Draw</span>
<span class="n">oil_analyzer</span><span class="o">.</span><span class="n">add_inventory_report</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="mf">446.2</span><span class="p">,</span> <span class="mf">449.0</span><span class="p">,</span> <span class="mf">448.5</span><span class="p">)</span>  <span class="c1"># Large draw</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Oil Inventory Analysis:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trend: </span><span class="si">{</span><span class="n">oil_analyzer</span><span class="o">.</span><span class="n">inventory_trend</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Signal: </span><span class="si">{</span><span class="n">oil_analyzer</span><span class="o">.</span><span class="n">inventory_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>7.3 Agricultural Commodities</h2>
<p>Agricultural commodities (grains, softs) have strong seasonal patterns driven by planting, growing, and harvest cycles.</p></div>
<div class="md-cell"><h3>Major Agricultural Markets</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Commodity</th>
<th>Symbol</th>
<th>Key Factors</th>
</tr>
</thead>
<tbody>
<tr>
<td>Corn</td>
<td>ZC</td>
<td>US planting (Apr-May), Harvest (Sep-Nov)</td>
</tr>
<tr>
<td>Wheat</td>
<td>ZW</td>
<td>Winter/Spring varieties, Global weather</td>
</tr>
<tr>
<td>Soybeans</td>
<td>ZS</td>
<td>China demand, Brazil crop</td>
</tr>
<tr>
<td>Coffee</td>
<td>KC</td>
<td>Brazil frost, Colombian production</td>
</tr>
<tr>
<td>Sugar</td>
<td>SB</td>
<td>Brazil production, Ethanol demand</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">AgriculturalAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze agricultural commodities with seasonal patterns.&quot;&quot;&quot;</span>
    
    <span class="c1"># Typical seasonal patterns (month -&gt; expected direction)</span>
    <span class="n">SEASONAL_PATTERNS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;corn&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span>  <span class="c1"># Pre-planting</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span>  <span class="c1"># Planting uncertainty</span>
            <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;volatile&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;volatile&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span>  <span class="c1"># Weather/harvest</span>
            <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span>  <span class="c1"># Harvest pressure</span>
        <span class="p">},</span>
        <span class="s1">&#39;wheat&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;volatile&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span>
            <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span>
            <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;soybeans&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;volatile&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;volatile&#39;</span><span class="p">,</span>
            <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;volatile&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span>
            <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commodity</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commodity</span> <span class="o">=</span> <span class="n">commodity</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weather_events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">set_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set price data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">add_weather_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Record weather event affecting crop.&quot;&quot;&quot;</span>
        <span class="n">impact_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="s1">&#39;drought&#39;</span><span class="p">,</span> <span class="s1">&#39;severe&#39;</span><span class="p">):</span> <span class="s1">&#39;very_bullish&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;drought&#39;</span><span class="p">,</span> <span class="s1">&#39;moderate&#39;</span><span class="p">):</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;frost&#39;</span><span class="p">,</span> <span class="s1">&#39;severe&#39;</span><span class="p">):</span> <span class="s1">&#39;very_bullish&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;frost&#39;</span><span class="p">,</span> <span class="s1">&#39;moderate&#39;</span><span class="p">):</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;flooding&#39;</span><span class="p">,</span> <span class="s1">&#39;severe&#39;</span><span class="p">):</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;ideal&#39;</span><span class="p">,</span> <span class="s1">&#39;any&#39;</span><span class="p">):</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="p">}</span>
        
        <span class="n">impact</span> <span class="o">=</span> <span class="n">impact_map</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">event_type</span><span class="p">,</span> <span class="n">severity</span><span class="p">),</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">weather_events</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event_type</span><span class="p">,</span>
            <span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="n">region</span><span class="p">,</span>
            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="n">impact</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_seasonal_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get seasonal bias for current or specified month.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">month</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">month</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">month</span>
        
        <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SEASONAL_PATTERNS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commodity</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;commodity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodity</span><span class="p">,</span>
            <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">month</span><span class="p">,</span>
            <span class="s1">&#39;seasonal_bias&#39;</span><span class="p">:</span> <span class="n">bias</span><span class="p">,</span>
            <span class="s1">&#39;explanation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_seasonal_explanation</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_get_seasonal_explanation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get explanation for seasonal pattern.&quot;&quot;&quot;</span>
        <span class="n">explanations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;corn&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="s1">&#39;Pre-planting uncertainty typically bullish&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span> <span class="s1">&#39;Weather-driven volatility during growing season&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span> <span class="s1">&#39;Harvest pressure typically bearish&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;soybeans&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="s1">&#39;South American harvest, US planting&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span> <span class="s1">&#39;Critical growing period&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span> <span class="s1">&#39;US harvest pressure&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="n">commodity_exp</span> <span class="o">=</span> <span class="n">explanations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commodity</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">commodity_exp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">month</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exp</span>
        <span class="k">return</span> <span class="s1">&#39;Standard seasonal period&#39;</span>
    
    <span class="k">def</span> <span class="nf">calculate_historical_seasonality</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate historical seasonal performance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">monthly</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">])</span>
        <span class="n">monthly</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;observations&#39;</span><span class="p">]</span>
        <span class="n">monthly</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">monthly</span>
    
    <span class="k">def</span> <span class="nf">weather_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate signal from recent weather events.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather_events</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;No weather events&#39;</span><span class="p">}</span>
        
        <span class="c1"># Look at events in last 30 days</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather_events</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recent</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;No recent weather events&#39;</span><span class="p">}</span>
        
        <span class="c1"># Score events</span>
        <span class="n">impact_scores</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;very_bullish&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;bullish&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;neutral&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;bearish&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">total_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">impact_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;impact&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">recent</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">total_score</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
        <span class="k">elif</span> <span class="n">total_score</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent</span><span class="p">),</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">total_score</span><span class="p">,</span>
            <span class="s1">&#39;recent_events&#39;</span><span class="p">:</span> <span class="n">recent</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">corn_analyzer</span> <span class="o">=</span> <span class="n">AgriculturalAnalyzer</span><span class="p">(</span><span class="s1">&#39;corn&#39;</span><span class="p">)</span>
<span class="n">corn_analyzer</span><span class="o">.</span><span class="n">set_prices</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">450</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>

<span class="c1"># Add weather events</span>
<span class="n">corn_analyzer</span><span class="o">.</span><span class="n">add_weather_event</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="s1">&#39;drought&#39;</span><span class="p">,</span> <span class="s1">&#39;US Midwest&#39;</span><span class="p">,</span> <span class="s1">&#39;moderate&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corn Seasonal Bias (April): </span><span class="si">{</span><span class="n">corn_analyzer</span><span class="o">.</span><span class="n">get_seasonal_bias</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Weather Signal: </span><span class="si">{</span><span class="n">corn_analyzer</span><span class="o">.</span><span class="n">weather_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>7.4 Commodity Currencies</h2>
<p>Commodity currencies (AUD, CAD, NOK) are strongly correlated with their primary export commodities.</p></div>
<div class="md-cell"><h3>Key Commodity Currency Relationships</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Currency</th>
<th>Primary Commodity</th>
<th>Correlation</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>AUD</td>
<td>Gold, Iron Ore</td>
<td>Positive</td>
<td>China demand key</td>
</tr>
<tr>
<td>CAD</td>
<td>Crude Oil</td>
<td>Positive</td>
<td>Oil sands production</td>
</tr>
<tr>
<td>NOK</td>
<td>Brent Crude</td>
<td>Positive</td>
<td>North Sea production</td>
</tr>
<tr>
<td>NZD</td>
<td>Dairy</td>
<td>Positive</td>
<td>Fonterra prices</td>
</tr>
<tr>
<td>ZAR</td>
<td>Gold, Platinum</td>
<td>Positive</td>
<td>Mining sector</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CommodityCurrencyAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze relationships between commodities and currencies.&quot;&quot;&quot;</span>
    
    <span class="n">RELATIONSHIPS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;AUD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;commodities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;iron_ore&#39;</span><span class="p">],</span> <span class="s1">&#39;expected_corr&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">},</span>
        <span class="s1">&#39;CAD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;commodities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;oil&#39;</span><span class="p">],</span> <span class="s1">&#39;expected_corr&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
        <span class="s1">&#39;NOK&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;commodities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;brent&#39;</span><span class="p">],</span> <span class="s1">&#39;expected_corr&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">},</span>
        <span class="s1">&#39;NZD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;commodities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dairy&#39;</span><span class="p">],</span> <span class="s1">&#39;expected_corr&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">},</span>
        <span class="s1">&#39;ZAR&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;commodities&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;platinum&#39;</span><span class="p">],</span> <span class="s1">&#39;expected_corr&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currency_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commodity_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_currency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add currency pair data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currency_data</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">add_commodity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commodity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add commodity price data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commodity_data</span><span class="p">[</span><span class="n">commodity</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">calculate_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">commodity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate rolling correlation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_data</span> <span class="ow">or</span> <span class="n">commodity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodity_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="n">curr_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_data</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">comm_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodity_data</span><span class="p">[</span><span class="n">commodity</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        
        <span class="n">aligned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">curr_ret</span><span class="p">,</span> <span class="n">comm_ret</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aligned</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="k">return</span> <span class="n">aligned</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">aligned</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">check_divergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for divergence between currency and its commodities.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RELATIONSHIPS</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span> <span class="s1">&#39;divergence&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        
        <span class="n">rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RELATIONSHIPS</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;expected_corr&#39;</span><span class="p">]</span>
        
        <span class="n">correlations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">comm</span> <span class="ow">in</span> <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;commodities&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodity_data</span><span class="p">:</span>
                <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_correlation</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="n">comm</span><span class="p">)</span>
                <span class="n">correlations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;commodity&#39;</span><span class="p">:</span> <span class="n">comm</span><span class="p">,</span> <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">corr</span><span class="p">})</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">correlations</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span> <span class="s1">&#39;divergence&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;No commodity data&#39;</span><span class="p">}</span>
        
        <span class="n">avg_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">correlations</span><span class="p">])</span>
        <span class="n">divergence</span> <span class="o">=</span> <span class="n">avg_corr</span> <span class="o">&lt;</span> <span class="n">expected</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="ow">or</span> <span class="n">avg_corr</span> <span class="o">&lt;</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;expected_correlation&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
            <span class="s1">&#39;actual_correlation&#39;</span><span class="p">:</span> <span class="n">avg_corr</span><span class="p">,</span>
            <span class="s1">&#39;divergence&#39;</span><span class="p">:</span> <span class="n">divergence</span><span class="p">,</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;divergence_trade&#39;</span> <span class="k">if</span> <span class="n">divergence</span> <span class="k">else</span> <span class="s1">&#39;follow_commodity&#39;</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">correlations</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">commodity_currency_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal based on commodity-currency relationship.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RELATIONSHIPS</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_relationship&#39;</span><span class="p">}</span>
        
        <span class="n">rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RELATIONSHIPS</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">comm</span> <span class="ow">in</span> <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;commodities&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">comm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodity_data</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">comm_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodity_data</span><span class="p">[</span><span class="n">comm</span><span class="p">]</span>
            <span class="n">comm_ret_20d</span> <span class="o">=</span> <span class="p">(</span><span class="n">comm_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">comm_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comm_prices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="k">if</span> <span class="n">comm_ret_20d</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;commodity&#39;</span><span class="p">:</span> <span class="n">comm</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">comm_ret_20d</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">comm_ret_20d</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
                <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;commodity&#39;</span><span class="p">:</span> <span class="n">comm</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">comm_ret_20d</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;commodity&#39;</span><span class="p">:</span> <span class="n">comm</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">comm_ret_20d</span><span class="p">})</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">signals</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>
        
        <span class="n">bullish</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">)</span>
        <span class="n">bearish</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">bullish</span> <span class="o">&gt;</span> <span class="n">bearish</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;buy_currency&#39;</span>
        <span class="k">elif</span> <span class="n">bearish</span> <span class="o">&gt;</span> <span class="n">bullish</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;sell_currency&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">overall</span><span class="p">,</span>
            <span class="s1">&#39;commodity_signals&#39;</span><span class="p">:</span> <span class="n">signals</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">cc_analyzer</span> <span class="o">=</span> <span class="n">CommodityCurrencyAnalyzer</span><span class="p">()</span>

<span class="c1"># Add data</span>
<span class="n">cc_analyzer</span><span class="o">.</span><span class="n">add_currency</span><span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">0.65</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>
<span class="n">cc_analyzer</span><span class="o">.</span><span class="n">add_currency</span><span class="p">(</span><span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.35</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>
<span class="n">cc_analyzer</span><span class="o">.</span><span class="n">add_commodity</span><span class="p">(</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">2000</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>
<span class="n">cc_analyzer</span><span class="o">.</span><span class="n">add_commodity</span><span class="p">(</span><span class="s1">&#39;oil&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">75</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUD-Gold Divergence Check:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cc_analyzer</span><span class="o">.</span><span class="n">check_divergence</span><span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">CAD Trading Signal:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cc_analyzer</span><span class="o">.</span><span class="n">commodity_currency_signal</span><span class="p">(</span><span class="s1">&#39;CAD&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2></div>
<div class="md-cell"><h3>Exercise 1: Gold Safe Haven Analyzer (Guided)</h3>
<p>Complete the <code>SafeHavenAnalyzer</code> class that tracks gold's safe-haven behavior.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SafeHavenAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze gold&#39;s safe-haven characteristics.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gold_prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spx_prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vix_prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gold</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">spx</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">vix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set market data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gold_prices</span> <span class="o">=</span> <span class="n">gold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spx_prices</span> <span class="o">=</span> <span class="n">spx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vix_prices</span> <span class="o">=</span> <span class="n">vix</span>
    
    <span class="k">def</span> <span class="nf">calculate_crisis_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vix_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate gold-SPX correlation during high VIX periods.&quot;&quot;&quot;</span>
        <span class="n">gold_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gold_prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">spx_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spx_prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        
        <span class="c1"># Filter for crisis periods</span>
        <span class="n">crisis_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vix_prices</span> <span class="n">______</span> <span class="n">vix_threshold</span>
        
        <span class="n">crisis_gold</span> <span class="o">=</span> <span class="n">gold_ret</span><span class="p">[</span><span class="n">crisis_mask</span><span class="p">]</span>
        <span class="n">crisis_spx</span> <span class="o">=</span> <span class="n">spx_ret</span><span class="p">[</span><span class="n">crisis_mask</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crisis_gold</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="k">return</span> <span class="n">crisis_gold</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">crisis_spx</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">safe_haven_score</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate safe-haven effectiveness score.&quot;&quot;&quot;</span>
        <span class="n">crisis_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_crisis_correlation</span><span class="p">()</span>
        
        <span class="c1"># Good safe haven has negative correlation during crisis</span>
        <span class="k">if</span> <span class="n">crisis_corr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;excellent&#39;</span>
        <span class="k">elif</span> <span class="n">crisis_corr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">70</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;good&#39;</span>
        <span class="k">elif</span> <span class="n">crisis_corr</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">______</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;moderate&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;poor&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;crisis_correlation&#39;</span><span class="p">:</span> <span class="n">crisis_corr</span><span class="p">,</span>
            <span class="s1">&#39;safe_haven_score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
            <span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="n">rating</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">sha</span> <span class="o">=</span> <span class="n">SafeHavenAnalyzer</span><span class="p">()</span>
<span class="n">sha</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
    <span class="n">gold</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">2000</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">100</span><span class="p">)),</span>
    <span class="n">spx</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">5000</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">100</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">100</span><span class="p">)),</span>
    <span class="n">vix</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">18</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Safe Haven Analysis: </span><span class="si">{</span><span class="n">sha</span><span class="o">.</span><span class="n">safe_haven_score</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SafeHavenAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gold_prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spx_prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vix_prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gold</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">spx</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">vix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gold_prices</span> <span class="o">=</span> <span class="n">gold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spx_prices</span> <span class="o">=</span> <span class="n">spx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vix_prices</span> <span class="o">=</span> <span class="n">vix</span>

    <span class="k">def</span> <span class="nf">calculate_crisis_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vix_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">gold_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gold_prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">spx_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spx_prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

        <span class="n">crisis_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vix_prices</span> <span class="o">&gt;</span> <span class="n">vix_threshold</span>

        <span class="n">crisis_gold</span> <span class="o">=</span> <span class="n">gold_ret</span><span class="p">[</span><span class="n">crisis_mask</span><span class="p">]</span>
        <span class="n">crisis_spx</span> <span class="o">=</span> <span class="n">spx_ret</span><span class="p">[</span><span class="n">crisis_mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crisis_gold</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="n">crisis_gold</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">crisis_spx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">safe_haven_score</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">crisis_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_crisis_correlation</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">crisis_corr</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;excellent&#39;</span>
        <span class="k">elif</span> <span class="n">crisis_corr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">70</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;good&#39;</span>
        <span class="k">elif</span> <span class="n">crisis_corr</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">40</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;moderate&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">rating</span> <span class="o">=</span> <span class="s1">&#39;poor&#39;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;crisis_correlation&#39;</span><span class="p">:</span> <span class="n">crisis_corr</span><span class="p">,</span>
            <span class="s1">&#39;safe_haven_score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
            <span class="s1">&#39;rating&#39;</span><span class="p">:</span> <span class="n">rating</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 2: Oil Inventory Tracker (Guided)</h3>
<p>Complete the <code>InventoryTracker</code> class that analyzes EIA oil inventory data.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">InventoryTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track and analyze oil inventory data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">crude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gasoline</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                   <span class="n">distillate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add weekly inventory report (values in millions of barrels).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;crude&#39;</span><span class="p">:</span> <span class="n">crude</span><span class="p">,</span>
            <span class="s1">&#39;gasoline&#39;</span><span class="p">:</span> <span class="n">gasoline</span><span class="p">,</span>
            <span class="s1">&#39;distillate&#39;</span><span class="p">:</span> <span class="n">distillate</span><span class="p">,</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">crude</span> <span class="o">+</span> <span class="n">gasoline</span> <span class="o">+</span> <span class="n">distillate</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_weekly_change</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate week-over-week inventory changes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">[</span><span class="n">______</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;crude_change&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;crude&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;crude&#39;</span><span class="p">],</span>
            <span class="s1">&#39;gasoline_change&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;gasoline&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;gasoline&#39;</span><span class="p">],</span>
            <span class="s1">&#39;distillate_change&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;distillate&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;distillate&#39;</span><span class="p">],</span>
            <span class="s1">&#39;total_change&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weeks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine inventory trend over N weeks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">weeks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;insufficient_data&#39;</span>
        
        <span class="n">builds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weeks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;______&#39;</span><span class="p">]:</span>
                <span class="n">builds</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">builds</span> <span class="o">&gt;=</span> <span class="n">weeks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;building&#39;</span>
        <span class="k">elif</span> <span class="n">builds</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;drawing&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;mixed&#39;</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal from inventory data.&quot;&quot;&quot;</span>
        <span class="n">change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_weekly_change</span><span class="p">()</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trend</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">change</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>
        
        <span class="n">total_change</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;total_change&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">total_change</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span> <span class="ow">and</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;drawing&#39;</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;strong_buy&#39;</span>
        <span class="k">elif</span> <span class="n">total_change</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
        <span class="k">elif</span> <span class="n">total_change</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">trend</span> <span class="o">==</span> <span class="s1">&#39;building&#39;</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;strong_sell&#39;</span>
        <span class="k">elif</span> <span class="n">total_change</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span> <span class="s1">&#39;weekly_change&#39;</span><span class="p">:</span> <span class="n">total_change</span><span class="p">,</span> <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">trend</span><span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">tracker</span> <span class="o">=</span> <span class="n">InventoryTracker</span><span class="p">()</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="mi">448</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">118</span><span class="p">)</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span> <span class="mi">445</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">117</span><span class="p">)</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="mi">442</span><span class="p">,</span> <span class="mi">223</span><span class="p">,</span> <span class="mi">115</span><span class="p">)</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">438</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">113</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weekly Change: </span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get_weekly_change</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trend: </span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get_trend</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal: </span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">InventoryTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">crude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">gasoline</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                   <span class="n">distillate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;crude&#39;</span><span class="p">:</span> <span class="n">crude</span><span class="p">,</span>
            <span class="s1">&#39;gasoline&#39;</span><span class="p">:</span> <span class="n">gasoline</span><span class="p">,</span>
            <span class="s1">&#39;distillate&#39;</span><span class="p">:</span> <span class="n">distillate</span><span class="p">,</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">crude</span> <span class="o">+</span> <span class="n">gasoline</span> <span class="o">+</span> <span class="n">distillate</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">get_weekly_change</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;crude_change&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;crude&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;crude&#39;</span><span class="p">],</span>
            <span class="s1">&#39;gasoline_change&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;gasoline&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;gasoline&#39;</span><span class="p">],</span>
            <span class="s1">&#39;distillate_change&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;distillate&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;distillate&#39;</span><span class="p">],</span>
            <span class="s1">&#39;total_change&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">previous</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weeks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">weeks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;insufficient_data&#39;</span>

        <span class="n">builds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weeks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]:</span>
                <span class="n">builds</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">builds</span> <span class="o">&gt;=</span> <span class="n">weeks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;building&#39;</span>
        <span class="k">elif</span> <span class="n">builds</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;drawing&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;mixed&#39;</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 3: Seasonal Pattern Detector (Guided)</h3>
<p>Complete the <code>SeasonalDetector</code> class that identifies seasonal trading opportunities.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SeasonalDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect and trade seasonal patterns in commodities.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set historical price data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">calculate_monthly_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate statistics for each month.&quot;&quot;&quot;</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="n">monthly</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">______</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;avg_return&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">])</span>
        
        <span class="k">return</span> <span class="n">monthly</span>
    
    <span class="k">def</span> <span class="nf">get_best_months</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get months with best historical performance.&quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_monthly_stats</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="n">top_n</span><span class="p">,</span> <span class="s1">&#39;avg_return&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_worst_months</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bottom_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get months with worst historical performance.&quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_monthly_stats</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="n">bottom_n</span><span class="p">,</span> <span class="s1">&#39;avg_return&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">current_month_outlook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get outlook for current month based on seasonality.&quot;&quot;&quot;</span>
        <span class="n">current_month</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">______</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_monthly_stats</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">current_month</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;outlook&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>
        
        <span class="n">month_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">current_month</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">outlook</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">outlook</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outlook</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">current_month</span><span class="p">,</span>
            <span class="s1">&#39;outlook&#39;</span><span class="p">:</span> <span class="n">outlook</span><span class="p">,</span>
            <span class="s1">&#39;avg_return&#39;</span><span class="p">:</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">],</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">SeasonalDetector</span><span class="p">()</span>
<span class="c1"># Create 2 years of simulated data</span>
<span class="n">dates_2y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2022-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">detector</span><span class="o">.</span><span class="n">set_prices</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">100</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">500</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates_2y</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best Months: </span><span class="si">{</span><span class="n">detector</span><span class="o">.</span><span class="n">get_best_months</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Worst Months: </span><span class="si">{</span><span class="n">detector</span><span class="o">.</span><span class="n">get_worst_months</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Outlook: </span><span class="si">{</span><span class="n">detector</span><span class="o">.</span><span class="n">current_month_outlook</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SeasonalDetector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>

    <span class="k">def</span> <span class="nf">calculate_monthly_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="n">monthly</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;avg_return&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="n">monthly</span>

    <span class="k">def</span> <span class="nf">get_best_months</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_monthly_stats</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="n">top_n</span><span class="p">,</span> <span class="s1">&#39;avg_return&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_worst_months</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bottom_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_monthly_stats</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="n">bottom_n</span><span class="p">,</span> <span class="s1">&#39;avg_return&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">current_month_outlook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">current_month</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">month</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_monthly_stats</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">current_month</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;outlook&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>

        <span class="n">month_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">current_month</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">outlook</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">outlook</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outlook</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">current_month</span><span class="p">,</span>
            <span class="s1">&#39;outlook&#39;</span><span class="p">:</span> <span class="n">outlook</span><span class="p">,</span>
            <span class="s1">&#39;avg_return&#39;</span><span class="p">:</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">],</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">month_stats</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 4: Complete Gold Trading System (Open-ended)</h3>
<p>Build a comprehensive gold trading system that:
- Tracks USD correlation
- Monitors real yields impact
- Detects safe-haven flows
- Generates actionable signals</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4: Complete Gold Trading System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class GoldTradingSystem</span>
<span class="c1"># 2. Track: gold prices, DXY, real yields, VIX, SPX</span>
<span class="c1"># 3. Calculate gold-USD correlation (should be negative)</span>
<span class="c1"># 4. Monitor real yields impact (negative correlation with gold)</span>
<span class="c1"># 5. Detect safe-haven demand (VIX spikes)</span>
<span class="c1"># 6. Combine factors into weighted signal</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">GoldTradingSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gold</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dxy</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_yields</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spx</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gold</span><span class="p">,</span> <span class="n">dxy</span><span class="p">,</span> <span class="n">real_yields</span><span class="p">,</span> <span class="n">vix</span><span class="p">,</span> <span class="n">spx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gold</span> <span class="o">=</span> <span class="n">gold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dxy</span> <span class="o">=</span> <span class="n">dxy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_yields</span> <span class="o">=</span> <span class="n">real_yields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vix</span> <span class="o">=</span> <span class="n">vix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spx</span> <span class="o">=</span> <span class="n">spx</span>

    <span class="k">def</span> <span class="nf">usd_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gold</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dxy</span><span class="o">.</span><span class="n">pct_change</span><span class="p">())</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dxy_trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dxy</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dxy</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">dxy_trend</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">:</span>  <span class="c1"># USD weakening</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;USD weakness&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">dxy_trend</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>  <span class="c1"># USD strengthening</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;USD strength&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;USD stable&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">yield_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_yields</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_yields</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Negative real yields&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">ma</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Rising real yields&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Yields stable&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">safe_haven_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">vix_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vix_change</span> <span class="o">=</span> <span class="n">vix_current</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">vix_current</span> <span class="o">&gt;</span> <span class="mi">25</span> <span class="ow">and</span> <span class="n">vix_change</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;strong_buy&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Fear spike&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">vix_current</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Elevated fear&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">vix_current</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Risk-on&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Normal vol&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">combined_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;usd&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">usd_signal</span><span class="p">(),</span> <span class="mf">0.3</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;yield&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_signal</span><span class="p">(),</span> <span class="mf">0.3</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;safe_haven&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_haven_signal</span><span class="p">(),</span> <span class="mf">0.4</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">score_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;strong_buy&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;neutral&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;strong_sell&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">}</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">score_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 5: Oil Supply/Demand Analyzer (Open-ended)</h3>
<p>Build an oil market analyzer that:
- Tracks EIA inventory data
- Monitors OPEC production changes
- Calculates supply/demand balance
- Generates trading signals</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 5: Oil Supply/Demand Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class OilSupplyDemandAnalyzer</span>
<span class="c1"># 2. Track: inventories, OPEC production, global demand estimates</span>
<span class="c1"># 3. Calculate implied supply/demand balance</span>
<span class="c1"># 4. Detect inventory trends (builds vs draws)</span>
<span class="c1"># 5. Generate trading signals from S/D balance</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">OilSupplyDemandAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opec_production</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demand_estimates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">crude</span><span class="p">,</span> <span class="n">gasoline</span><span class="p">,</span> <span class="n">distillate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventories</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;crude&#39;</span><span class="p">:</span> <span class="n">crude</span><span class="p">,</span>
            <span class="s1">&#39;gasoline&#39;</span><span class="p">:</span> <span class="n">gasoline</span><span class="p">,</span>
            <span class="s1">&#39;distillate&#39;</span><span class="p">:</span> <span class="n">distillate</span><span class="p">,</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">crude</span> <span class="o">+</span> <span class="n">gasoline</span> <span class="o">+</span> <span class="n">distillate</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">add_opec_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">production</span><span class="p">,</span> <span class="n">quota</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opec_production</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;production&#39;</span><span class="p">:</span> <span class="n">production</span><span class="p">,</span>
            <span class="s1">&#39;quota&#39;</span><span class="p">:</span> <span class="n">quota</span><span class="p">,</span>
            <span class="s1">&#39;compliance&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">quota</span> <span class="o">-</span> <span class="n">production</span><span class="p">)</span> <span class="o">/</span> <span class="n">quota</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">add_demand_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">demand</span><span class="p">,</span> <span class="n">yoy_change</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demand_estimates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;demand&#39;</span><span class="p">:</span> <span class="n">demand</span><span class="p">,</span>
            <span class="s1">&#39;yoy_change&#39;</span><span class="p">:</span> <span class="n">yoy_change</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">inventory_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weeks</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventories</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">weeks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;insufficient_data&#39;</span>

        <span class="n">changes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inventories</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventories</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> 
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weeks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">draws</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;drawing&#39;</span> <span class="k">if</span> <span class="n">draws</span> <span class="o">&gt;=</span> <span class="n">weeks</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;building&#39;</span> <span class="k">if</span> <span class="n">draws</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;mixed&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">supply_demand_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">opec_production</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">demand_estimates</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>

        <span class="n">supply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opec_production</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;production&#39;</span><span class="p">]</span>
        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demand_estimates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;demand&#39;</span><span class="p">]</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="n">supply</span> <span class="o">-</span> <span class="n">demand</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;supply&#39;</span><span class="p">:</span> <span class="n">supply</span><span class="p">,</span>
            <span class="s1">&#39;demand&#39;</span><span class="p">:</span> <span class="n">demand</span><span class="p">,</span>
            <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="n">balance</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;surplus&#39;</span> <span class="k">if</span> <span class="n">balance</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;deficit&#39;</span> <span class="k">if</span> <span class="n">balance</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;balanced&#39;</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inv_trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_trend</span><span class="p">()</span>
        <span class="n">sd_balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supply_demand_balance</span><span class="p">()</span>

        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">inv_trend</span> <span class="o">==</span> <span class="s1">&#39;drawing&#39;</span><span class="p">:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">inv_trend</span> <span class="o">==</span> <span class="s1">&#39;building&#39;</span><span class="p">:</span> <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">sd_balance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;deficit&#39;</span><span class="p">:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">sd_balance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;surplus&#39;</span><span class="p">:</span> <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;sell&#39;</span> <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s1">&#39;inventory_trend&#39;</span><span class="p">:</span> <span class="n">inv_trend</span><span class="p">,</span> <span class="s1">&#39;sd_status&#39;</span><span class="p">:</span> <span class="n">sd_balance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 6: Commodity Currency Strategy (Open-ended)</h3>
<p>Build a trading strategy that exploits commodity-currency relationships:
- Track multiple commodity-currency pairs
- Detect correlation breakdowns
- Generate pair trading signals
- Manage portfolio of commodity FX trades</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 6: Commodity Currency Strategy (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class CommodityCurrencyStrategy</span>
<span class="c1"># 2. Define relationships: AUD-Gold, CAD-Oil, NOK-Brent</span>
<span class="c1"># 3. Track correlations over rolling windows</span>
<span class="c1"># 4. Detect divergences (correlation breakdown)</span>
<span class="c1"># 5. Generate signals: follow commodity or trade divergence</span>
<span class="c1"># 6. Rank opportunities by strength</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CommodityCurrencyStrategy</span><span class="p">:</span>
    <span class="n">PAIRS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;AUDUSD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;commodity&#39;</span><span class="p">:</span> <span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_corr&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">},</span>
        <span class="s1">&#39;USDCAD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;commodity&#39;</span><span class="p">:</span> <span class="s1">&#39;oil&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_corr&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">},</span>  <span class="c1"># Inverted</span>
        <span class="s1">&#39;USDNOK&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;commodity&#39;</span><span class="p">:</span> <span class="s1">&#39;brent&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_corr&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commodities</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">is_commodity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_commodity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commodities</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currencies</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>

    <span class="k">def</span> <span class="nf">rolling_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAIRS</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">commodity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAIRS</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="s1">&#39;commodity&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">currencies</span> <span class="ow">or</span> <span class="n">commodity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodities</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">curr_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currencies</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">comm_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodities</span><span class="p">[</span><span class="n">commodity</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>

        <span class="n">aligned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">curr_ret</span><span class="p">,</span> <span class="n">comm_ret</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">aligned</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">aligned</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">window</span><span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">detect_divergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAIRS</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="s1">&#39;expected_corr&#39;</span><span class="p">]</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling_correlation</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>

        <span class="n">divergence</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">actual</span> <span class="o">-</span> <span class="n">expected</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">,</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">actual</span><span class="p">,</span>
            <span class="s1">&#39;divergence&#39;</span><span class="p">:</span> <span class="n">divergence</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAIRS</span><span class="p">:</span>
            <span class="n">div</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_divergence</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
            <span class="n">commodity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAIRS</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="s1">&#39;commodity&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">commodity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodities</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">comm_ret</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commodities</span><span class="p">[</span><span class="n">commodity</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> 
                       <span class="bp">self</span><span class="o">.</span><span class="n">commodities</span><span class="p">[</span><span class="n">commodity</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

            <span class="k">if</span> <span class="n">div</span><span class="p">[</span><span class="s1">&#39;divergence&#39;</span><span class="p">]:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;divergence_trade&#39;</span>
            <span class="k">elif</span> <span class="n">comm_ret</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAIRS</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="s1">&#39;expected_corr&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span>
            <span class="k">elif</span> <span class="n">comm_ret</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAIRS</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="s1">&#39;expected_corr&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;buy&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>

            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
                <span class="s1">&#39;commodity_return&#39;</span><span class="p">:</span> <span class="n">comm_ret</span><span class="p">,</span>
                <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">div</span><span class="p">[</span><span class="s1">&#39;actual&#39;</span><span class="p">],</span>
                <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">comm_ret</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Commodity Trading System</h2>
<p>Build a production-ready system that integrates all commodity trading concepts.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CommodityTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready commodity trading system.</span>
<span class="sd">    </span>
<span class="sd">    Integrates: Gold, Oil, Agricultural, Commodity Currencies.</span>
<span class="sd">    Provides: Market analysis, Trading signals, Risk assessment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gold_analyzer</span> <span class="o">=</span> <span class="n">GoldAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oil_analyzer</span> <span class="o">=</span> <span class="n">OilAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commodity_currencies</span> <span class="o">=</span> <span class="n">CommodityCurrencyAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">load_market_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load price data for any market.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
        
        <span class="c1"># Route to appropriate analyzer</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;GOLD&#39;</span> <span class="ow">or</span> <span class="n">symbol</span> <span class="o">==</span> <span class="s1">&#39;XAUUSD&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gold_analyzer</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">gold</span><span class="o">=</span><span class="n">prices</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;OIL&#39;</span><span class="p">,</span> <span class="s1">&#39;WTI&#39;</span><span class="p">,</span> <span class="s1">&#39;CL&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oil_analyzer</span><span class="o">.</span><span class="n">set_prices</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;NOK&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commodity_currencies</span><span class="o">.</span><span class="n">add_currency</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">symbol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;oil&#39;</span><span class="p">,</span> <span class="s1">&#39;brent&#39;</span><span class="p">,</span> <span class="s1">&#39;iron_ore&#39;</span><span class="p">,</span> <span class="s1">&#39;dairy&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commodity_currencies</span><span class="o">.</span><span class="n">add_commodity</span><span class="p">(</span><span class="n">symbol</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">prices</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_oil_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                         <span class="n">forecast</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">previous</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add oil inventory report.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oil_analyzer</span><span class="o">.</span><span class="n">add_inventory_report</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">forecast</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_gold_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get comprehensive gold analysis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;safe_haven&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gold_analyzer</span><span class="o">.</span><span class="n">safe_haven_signal</span><span class="p">(),</span>
            <span class="s1">&#39;real_yield&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gold_analyzer</span><span class="o">.</span><span class="n">real_yield_signal</span><span class="p">(),</span>
            <span class="s1">&#39;combined&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gold_analyzer</span><span class="o">.</span><span class="n">combined_signal</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_oil_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get comprehensive oil analysis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;inventory_trend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_analyzer</span><span class="o">.</span><span class="n">inventory_trend</span><span class="p">(),</span>
            <span class="s1">&#39;inventory_signal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_analyzer</span><span class="o">.</span><span class="n">inventory_signal</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_commodity_fx_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all commodity currency signals.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="s1">&#39;NOK&#39;</span><span class="p">,</span> <span class="s1">&#39;NZD&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodity_currencies</span><span class="o">.</span><span class="n">currency_data</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodity_currencies</span><span class="o">.</span><span class="n">commodity_currency_signal</span><span class="p">(</span><span class="n">currency</span><span class="p">)</span>
                <span class="n">divergence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commodity_currencies</span><span class="o">.</span><span class="n">check_divergence</span><span class="p">(</span><span class="n">currency</span><span class="p">)</span>
                <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
                    <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
                    <span class="s1">&#39;divergence&#39;</span><span class="p">:</span> <span class="n">divergence</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">get_all_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Rank all trading opportunities.&quot;&quot;&quot;</span>
        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Gold opportunity</span>
        <span class="n">gold_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gold_analyzer</span><span class="o">.</span><span class="n">combined_signal</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gold_signal</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;strong_buy&#39;</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="s1">&#39;strong_sell&#39;</span><span class="p">]:</span>
            <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;market&#39;</span><span class="p">:</span> <span class="s1">&#39;GOLD&#39;</span><span class="p">,</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span> <span class="k">if</span> <span class="s1">&#39;buy&#39;</span> <span class="ow">in</span> <span class="n">gold_signal</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span>
                <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">gold_signal</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Combined fundamental signals&#39;</span>
            <span class="p">})</span>
        
        <span class="c1"># Oil opportunity</span>
        <span class="n">oil_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_analyzer</span><span class="o">.</span><span class="n">inventory_signal</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">oil_signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;strong_buy&#39;</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="s1">&#39;strong_sell&#39;</span><span class="p">]:</span>
            <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;market&#39;</span><span class="p">:</span> <span class="s1">&#39;OIL&#39;</span><span class="p">,</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span> <span class="k">if</span> <span class="s1">&#39;buy&#39;</span> <span class="ow">in</span> <span class="n">oil_signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span>
                <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mf">0.7</span> <span class="k">if</span> <span class="s1">&#39;strong&#39;</span> <span class="ow">in</span> <span class="n">oil_signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">oil_signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reason&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">})</span>
        
        <span class="c1"># Commodity currencies</span>
        <span class="k">for</span> <span class="n">fx_signal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_commodity_fx_signals</span><span class="p">():</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">fx_signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sig</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;buy_currency&#39;</span><span class="p">,</span> <span class="s1">&#39;sell_currency&#39;</span><span class="p">]:</span>
                <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;market&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fx_signal</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">USD&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span> <span class="k">if</span> <span class="n">sig</span> <span class="o">==</span> <span class="s1">&#39;buy_currency&#39;</span> <span class="k">else</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Commodity correlation&#39;</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">opportunities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print comprehensive dashboard.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  COMMODITY TRADING DASHBOARD&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="c1"># Gold Analysis</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GOLD ANALYSIS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">gold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gold_analysis</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Safe Haven: </span><span class="si">{</span><span class="n">gold</span><span class="p">[</span><span class="s1">&#39;safe_haven&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Real Yield: </span><span class="si">{</span><span class="n">gold</span><span class="p">[</span><span class="s1">&#39;real_yield&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined: </span><span class="si">{</span><span class="n">gold</span><span class="p">[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;overall&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Oil Analysis</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OIL ANALYSIS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">oil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_oil_analysis</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inventory Trend: </span><span class="si">{</span><span class="n">oil</span><span class="p">[</span><span class="s1">&#39;inventory_trend&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal: </span><span class="si">{</span><span class="n">oil</span><span class="p">[</span><span class="s1">&#39;inventory_signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Commodity Currencies</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;COMMODITY CURRENCIES&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_commodity_fx_signals</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fx</span><span class="p">[</span><span class="s1">&#39;currency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">fx</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Top Opportunities</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TOP OPPORTUNITIES&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">opp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_all_opportunities</span><span class="p">()[:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;market&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Strength: </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demo the system</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">CommodityTradingSystem</span><span class="p">()</span>

<span class="c1"># Load market data</span>
<span class="n">system</span><span class="o">.</span><span class="n">load_market_data</span><span class="p">(</span><span class="s1">&#39;GOLD&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">2000</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>
<span class="n">system</span><span class="o">.</span><span class="n">load_market_data</span><span class="p">(</span><span class="s1">&#39;OIL&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">75</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>
<span class="n">system</span><span class="o">.</span><span class="n">load_market_data</span><span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">0.65</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0005</span><span class="p">,</span> <span class="mf">0.003</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>
<span class="n">system</span><span class="o">.</span><span class="n">load_market_data</span><span class="p">(</span><span class="s1">&#39;CAD&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.35</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0003</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>
<span class="n">system</span><span class="o">.</span><span class="n">load_market_data</span><span class="p">(</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">2000</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>
<span class="n">system</span><span class="o">.</span><span class="n">load_market_data</span><span class="p">(</span><span class="s1">&#39;oil&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">75</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">))</span>

<span class="c1"># Set additional gold data</span>
<span class="n">system</span><span class="o">.</span><span class="n">gold_analyzer</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
    <span class="n">gold</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">market_data</span><span class="p">[</span><span class="s1">&#39;GOLD&#39;</span><span class="p">],</span>
    <span class="n">dxy</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">104</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">),</span>
    <span class="n">vix</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">18</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">),</span>
    <span class="n">real_yields</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Add oil inventory data</span>
<span class="n">system</span><span class="o">.</span><span class="n">add_oil_inventory</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mf">451.2</span><span class="p">,</span> <span class="mf">453.0</span><span class="p">,</span> <span class="mf">452.5</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">add_oil_inventory</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="mf">449.8</span><span class="p">,</span> <span class="mf">451.0</span><span class="p">,</span> <span class="mf">451.2</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">add_oil_inventory</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span> <span class="mf">448.5</span><span class="p">,</span> <span class="mf">450.5</span><span class="p">,</span> <span class="mf">449.8</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">add_oil_inventory</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="mf">446.2</span><span class="p">,</span> <span class="mf">449.0</span><span class="p">,</span> <span class="mf">448.5</span><span class="p">)</span>

<span class="c1"># Print dashboard</span>
<span class="n">system</span><span class="o">.</span><span class="n">print_dashboard</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ul>
<li><strong>Gold Trading</strong>: Driven by USD, real yields, and safe-haven demand; negative correlation with risk assets</li>
<li><strong>Oil Analysis</strong>: Track EIA inventories (Wed), OPEC decisions, and supply/demand balance</li>
<li><strong>Inventory Impact</strong>: Draws = bullish, Builds = bearish; surprises move markets most</li>
<li><strong>Agricultural Seasonality</strong>: Strong patterns around planting/harvest; weather is key risk</li>
<li><strong>Commodity Currencies</strong>: AUD-Gold, CAD-Oil correlations create trading opportunities</li>
<li><strong>Divergence Trading</strong>: When correlations break down, mean reversion opportunities emerge</li>
<li><strong>Multi-Asset Integration</strong>: Combine commodity and FX analysis for better signals</li>
<li><strong>Risk Management</strong>: Commodities are volatile; size positions appropriately</li>
</ul>
<p><strong>Next: Module 8 - Trading Strategies</strong> where we'll build trend following, mean reversion, carry, and news trading systems.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="8"><div class="md-cell module-header"><h1>Module 8: Trading Strategies</h1>
<p><strong>Part 2: Analysis &amp; Strategies</strong></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ul>
<li>Build forex trend following systems with MA and breakout strategies</li>
<li>Implement range trading and mean reversion strategies</li>
<li>Understand carry trade mechanics and interest rate differentials</li>
<li>Develop news trading strategies for high-impact events</li>
</ul>
<h2>Prerequisites</h2>
<ul>
<li>Modules 1-7 (Forex/Futures fundamentals, analysis, commodities)</li>
<li>Understanding of technical and fundamental analysis</li>
<li>Python pandas and backtesting concepts</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>8.1 Forex Trend Following</h2>
<p>Trend following strategies capture extended directional moves in currency pairs using moving averages and breakout systems.</p></div>
<div class="md-cell"><h3>Trend Following Approaches</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Strategy</th>
<th>Entry Signal</th>
<th>Exit Signal</th>
<th>Best Market</th>
</tr>
</thead>
<tbody>
<tr>
<td>MA Crossover</td>
<td>Fast MA crosses slow MA</td>
<td>Opposite crossover</td>
<td>Trending</td>
</tr>
<tr>
<td>Channel Breakout</td>
<td>Price breaks N-period high/low</td>
<td>Opposite breakout</td>
<td>Volatile</td>
</tr>
<tr>
<td>ADX Filter</td>
<td>Trade with trend when ADX &gt; 25</td>
<td>ADX falls below 20</td>
<td>Strong trends</td>
</tr>
<tr>
<td>Donchian</td>
<td>Price breaks 20-day high/low</td>
<td>10-day opposite</td>
<td>Any</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MovingAverageCrossover</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Classic moving average crossover trend following strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">slow_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_period</span> <span class="o">=</span> <span class="n">fast_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_period</span> <span class="o">=</span> <span class="n">slow_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set price data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">calculate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate MA crossover signals.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">})</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fast_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slow_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Signal: 1 = long, -1 = short, 0 = no position</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">],</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">],</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="c1"># Trade signals (changes in position)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">get_current_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current trading signal.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_signals</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_period</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>
        
        <span class="n">latest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span> <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;short&#39;</span> <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;flat&#39;</span><span class="p">),</span>
            <span class="s1">&#39;fast_ma&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">],</span>
            <span class="s1">&#39;slow_ma&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">],</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
            <span class="s1">&#39;trade&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;trade&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;sell&#39;</span> <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;trade&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;hold&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simple backtest of the strategy.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_signals</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span>
        
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">buy_hold</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        
        <span class="n">trades</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trade&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy_return&#39;</span><span class="p">:</span> <span class="n">total_return</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;buy_hold_return&#39;</span><span class="p">:</span> <span class="n">buy_hold</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;outperformance&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">total_return</span> <span class="o">-</span> <span class="n">buy_hold</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;num_trades&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="c1"># Create trending data</span>
<span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.1000</span> <span class="o">+</span> <span class="n">trend</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>

<span class="n">ma_strategy</span> <span class="o">=</span> <span class="n">MovingAverageCrossover</span><span class="p">(</span><span class="n">fast_period</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">slow_period</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">ma_strategy</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MA Crossover Strategy:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Signal: </span><span class="si">{</span><span class="n">ma_strategy</span><span class="o">.</span><span class="n">get_current_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Backtest Results: </span><span class="si">{</span><span class="n">ma_strategy</span><span class="o">.</span><span class="n">backtest</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">BreakoutStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Donchian channel breakout strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">exit_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_period</span> <span class="o">=</span> <span class="n">entry_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_period</span> <span class="o">=</span> <span class="n">exit_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set OHLC data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">high</span><span class="p">,</span>
            <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span>
            <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">close</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">calculate_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Donchian channels.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Entry channels</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;entry_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entry_period</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;entry_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entry_period</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        
        <span class="c1"># Exit channels</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;exit_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_period</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;exit_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_period</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">calculate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate breakout signals.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_channels</span><span class="p">()</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_period</span><span class="p">:</span>
                <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="n">close</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">prev_entry_high</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;entry_high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">prev_entry_low</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;entry_low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">prev_exit_high</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;exit_high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">prev_exit_low</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;exit_low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># Entry signals</span>
            <span class="k">if</span> <span class="n">position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">close</span> <span class="o">&gt;</span> <span class="n">prev_entry_high</span><span class="p">:</span>
                    <span class="n">position</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">close</span> <span class="o">&lt;</span> <span class="n">prev_entry_low</span><span class="p">:</span>
                    <span class="n">position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="c1"># Exit signals</span>
            <span class="k">elif</span> <span class="n">position</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">close</span> <span class="o">&lt;</span> <span class="n">prev_exit_low</span><span class="p">:</span>
                    <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">position</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">close</span> <span class="o">&gt;</span> <span class="n">prev_exit_high</span><span class="p">:</span>
                    <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">get_current_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current signal and levels.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_signals</span><span class="p">()</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span> <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;short&#39;</span> <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;flat&#39;</span><span class="p">),</span>
            <span class="s1">&#39;entry_high&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;entry_high&#39;</span><span class="p">],</span>
            <span class="s1">&#39;entry_low&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;entry_low&#39;</span><span class="p">],</span>
            <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span>
            <span class="s1">&#39;trade&#39;</span><span class="p">:</span> <span class="s1">&#39;entry&#39;</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">latest</span><span class="p">[</span><span class="s1">&#39;trade&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;hold&#39;</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">high</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.1000</span> <span class="o">+</span> <span class="n">trend</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">low</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.1000</span> <span class="o">+</span> <span class="n">trend</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">close</span> <span class="o">=</span> <span class="n">prices</span>

<span class="n">breakout</span> <span class="o">=</span> <span class="n">BreakoutStrategy</span><span class="p">(</span><span class="n">entry_period</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">exit_period</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">breakout</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Breakout Strategy:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Signal: </span><span class="si">{</span><span class="n">breakout</span><span class="o">.</span><span class="n">get_current_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TrendFilter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;ADX-based trend filter to improve trend following signals.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adx_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">adx_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">25</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adx_period</span> <span class="o">=</span> <span class="n">adx_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adx_threshold</span> <span class="o">=</span> <span class="n">adx_threshold</span>
    
    <span class="k">def</span> <span class="nf">calculate_adx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                      <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate ADX indicator.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">high</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">close</span><span class="p">})</span>
        
        <span class="c1"># True Range</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tr1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tr2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tr3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;tr1&#39;</span><span class="p">,</span> <span class="s1">&#39;tr2&#39;</span><span class="p">,</span> <span class="s1">&#39;tr3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Directional Movement</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;up_move&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;down_move&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;+dm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;up_move&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;down_move&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;up_move&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;up_move&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;-dm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;down_move&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;up_move&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;down_move&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;down_move&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Smoothed values</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adx_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;+di&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;+dm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adx_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;-di&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;-dm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adx_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">])</span>
        
        <span class="c1"># ADX</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;+di&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;-di&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;+di&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;-di&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;adx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adx_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;adx&#39;</span><span class="p">,</span> <span class="s1">&#39;+di&#39;</span><span class="p">,</span> <span class="s1">&#39;-di&#39;</span><span class="p">]]</span>
    
    <span class="k">def</span> <span class="nf">is_trending</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if market is trending.&quot;&quot;&quot;</span>
        <span class="n">adx_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_adx</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">adx_df</span><span class="p">[</span><span class="s1">&#39;adx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;trending&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data&#39;</span><span class="p">}</span>
        
        <span class="n">current_adx</span> <span class="o">=</span> <span class="n">adx_df</span><span class="p">[</span><span class="s1">&#39;adx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plus_di</span> <span class="o">=</span> <span class="n">adx_df</span><span class="p">[</span><span class="s1">&#39;+di&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">minus_di</span> <span class="o">=</span> <span class="n">adx_df</span><span class="p">[</span><span class="s1">&#39;-di&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">trending</span> <span class="o">=</span> <span class="n">current_adx</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">adx_threshold</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span> <span class="k">if</span> <span class="n">plus_di</span> <span class="o">&gt;</span> <span class="n">minus_di</span> <span class="k">else</span> <span class="s1">&#39;down&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;trending&#39;</span><span class="p">:</span> <span class="n">trending</span><span class="p">,</span>
            <span class="s1">&#39;adx&#39;</span><span class="p">:</span> <span class="n">current_adx</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span> <span class="k">if</span> <span class="n">trending</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="s1">&#39;strong&#39;</span> <span class="k">if</span> <span class="n">current_adx</span> <span class="o">&gt;</span> <span class="mi">40</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;moderate&#39;</span> <span class="k">if</span> <span class="n">current_adx</span> <span class="o">&gt;</span> <span class="mi">25</span> <span class="k">else</span> <span class="s1">&#39;weak&#39;</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">trend_filter</span> <span class="o">=</span> <span class="n">TrendFilter</span><span class="p">(</span><span class="n">adx_period</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">adx_threshold</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">trend_filter</span><span class="o">.</span><span class="n">is_trending</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trend Filter: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>8.2 Range &amp; Mean Reversion</h2>
<p>Mean reversion strategies profit from price returning to equilibrium levels after temporary deviations.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">RangeDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect ranging vs trending markets.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
    
    <span class="k">def</span> <span class="nf">detect_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                     <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect if market is in a range.&quot;&quot;&quot;</span>
        <span class="c1"># Calculate range metrics</span>
        <span class="n">period_high</span> <span class="o">=</span> <span class="n">high</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">period_low</span> <span class="o">=</span> <span class="n">low</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">range_size</span> <span class="o">=</span> <span class="n">period_high</span> <span class="o">-</span> <span class="n">period_low</span>
        
        <span class="c1"># Calculate ATR for comparison</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">,</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">atr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Range ratio: low ratio = ranging, high ratio = trending</span>
        <span class="n">range_ratio</span> <span class="o">=</span> <span class="n">range_size</span> <span class="o">/</span> <span class="p">(</span><span class="n">atr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span>
        
        <span class="c1"># Current position within range</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">position_in_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">period_low</span><span class="p">)</span> <span class="o">/</span> <span class="n">range_size</span> <span class="k">if</span> <span class="n">range_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.5</span>
        
        <span class="n">is_ranging</span> <span class="o">=</span> <span class="n">range_ratio</span> <span class="o">&lt;</span> <span class="mf">0.5</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;is_ranging&#39;</span><span class="p">:</span> <span class="n">is_ranging</span><span class="p">,</span>
            <span class="s1">&#39;range_high&#39;</span><span class="p">:</span> <span class="n">period_high</span><span class="p">,</span>
            <span class="s1">&#39;range_low&#39;</span><span class="p">:</span> <span class="n">period_low</span><span class="p">,</span>
            <span class="s1">&#39;range_size&#39;</span><span class="p">:</span> <span class="n">range_size</span><span class="p">,</span>
            <span class="s1">&#39;range_ratio&#39;</span><span class="p">:</span> <span class="n">range_ratio</span><span class="p">,</span>
            <span class="s1">&#39;position_in_range&#39;</span><span class="p">:</span> <span class="n">position_in_range</span><span class="p">,</span>
            <span class="s1">&#39;near_resistance&#39;</span><span class="p">:</span> <span class="n">position_in_range</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="s1">&#39;near_support&#39;</span><span class="p">:</span> <span class="n">position_in_range</span> <span class="o">&lt;</span> <span class="mf">0.2</span>
        <span class="p">}</span>

<span class="c1"># Demo with ranging data</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">range_prices</span> <span class="o">=</span> <span class="mf">1.1000</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.01</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">range_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="n">range_high</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">range_prices</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">range_dates</span><span class="p">)</span>
<span class="n">range_low</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">range_prices</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">range_dates</span><span class="p">)</span>
<span class="n">range_close</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">range_prices</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">range_dates</span><span class="p">)</span>

<span class="n">detector</span> <span class="o">=</span> <span class="n">RangeDetector</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Range Detection: </span><span class="si">{</span><span class="n">detector</span><span class="o">.</span><span class="n">detect_range</span><span class="p">(</span><span class="n">range_high</span><span class="p">,</span> <span class="n">range_low</span><span class="p">,</span> <span class="n">range_close</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MeanReversionStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Mean reversion strategy using Bollinger Bands and RSI.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bb_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">bb_std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                 <span class="n">rsi_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">oversold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">overbought</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">70</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bb_period</span> <span class="o">=</span> <span class="n">bb_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bb_std</span> <span class="o">=</span> <span class="n">bb_std</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span> <span class="o">=</span> <span class="n">rsi_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oversold</span> <span class="o">=</span> <span class="n">oversold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overbought</span> <span class="o">=</span> <span class="n">overbought</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set price data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Bollinger Bands and RSI.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">})</span>
        
        <span class="c1"># Bollinger Bands</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bb_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bb_period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_middle&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bb_std</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_middle&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bb_std</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_std&#39;</span><span class="p">]</span>
        
        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
        
        <span class="c1"># %B indicator (position within bands)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;percent_b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">calculate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate mean reversion signals.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_indicators</span><span class="p">()</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Buy when oversold (price below lower band AND RSI oversold)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">oversold</span><span class="p">),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># Sell when overbought (price above upper band AND RSI overbought)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">overbought</span><span class="p">),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">get_current_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current signal.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_indicators</span><span class="p">()</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Determine condition</span>
        <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">oversold</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;oversold&#39;</span>
        <span class="k">elif</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">overbought</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;overbought&#39;</span>
        <span class="k">elif</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;percent_b&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;watch_buy&#39;</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;approaching_oversold&#39;</span>
        <span class="k">elif</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;percent_b&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;watch_sell&#39;</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;approaching_overbought&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="n">condition</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
            <span class="s1">&#39;bb_upper&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;bb_upper&#39;</span><span class="p">],</span>
            <span class="s1">&#39;bb_lower&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;bb_lower&#39;</span><span class="p">],</span>
            <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span>
            <span class="s1">&#39;percent_b&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;percent_b&#39;</span><span class="p">]</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">mr_strategy</span> <span class="o">=</span> <span class="n">MeanReversionStrategy</span><span class="p">()</span>
<span class="n">mr_strategy</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">range_close</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean Reversion Strategy:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Signal: </span><span class="si">{</span><span class="n">mr_strategy</span><span class="o">.</span><span class="n">get_current_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>8.3 Carry Trade</h2>
<p>Carry trade profits from interest rate differentials by going long high-yield currencies and short low-yield currencies.</p></div>
<div class="md-cell"><h3>Carry Trade Mechanics</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Component</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Interest Differential</td>
<td>Profit from holding high-yield vs low-yield</td>
</tr>
<tr>
<td>Swap Points</td>
<td>Daily credit/debit based on rate differential</td>
</tr>
<tr>
<td>Risk</td>
<td>Currency depreciation can wipe out carry gains</td>
</tr>
<tr>
<td>Best Conditions</td>
<td>Low volatility, risk-on environment</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CarryTradeCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate carry trade opportunities and returns.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">set_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set interest rate for currency.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
    
    <span class="k">def</span> <span class="nf">set_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set price data for currency pair.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">calculate_carry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long_currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">short_currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate annual carry for a trade.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">long_currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span> <span class="ow">or</span> <span class="n">short_currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;carry&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Missing rate data&#39;</span><span class="p">}</span>
        
        <span class="n">long_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">long_currency</span><span class="p">]</span>
        <span class="n">short_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">short_currency</span><span class="p">]</span>
        <span class="n">carry</span> <span class="o">=</span> <span class="n">long_rate</span> <span class="o">-</span> <span class="n">short_rate</span>
        <span class="n">daily_carry</span> <span class="o">=</span> <span class="n">carry</span> <span class="o">/</span> <span class="mi">365</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;long_currency&#39;</span><span class="p">:</span> <span class="n">long_currency</span><span class="p">,</span>
            <span class="s1">&#39;short_currency&#39;</span><span class="p">:</span> <span class="n">short_currency</span><span class="p">,</span>
            <span class="s1">&#39;long_rate&#39;</span><span class="p">:</span> <span class="n">long_rate</span><span class="p">,</span>
            <span class="s1">&#39;short_rate&#39;</span><span class="p">:</span> <span class="n">short_rate</span><span class="p">,</span>
            <span class="s1">&#39;annual_carry&#39;</span><span class="p">:</span> <span class="n">carry</span><span class="p">,</span>
            <span class="s1">&#39;daily_carry&#39;</span><span class="p">:</span> <span class="n">daily_carry</span><span class="p">,</span>
            <span class="s1">&#39;monthly_carry&#39;</span><span class="p">:</span> <span class="n">carry</span> <span class="o">/</span> <span class="mi">12</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_best_carry_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find best carry trade opportunities.&quot;&quot;&quot;</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">currencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currencies</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">currencies</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">c2</span><span class="p">]:</span>
                    <span class="n">carry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_carry</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">carry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_carry</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
                
                <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">carry</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;annual_carry&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_total_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">long_currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                               <span class="n">short_currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total return (carry + price change).&quot;&quot;&quot;</span>
        <span class="n">carry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_carry</span><span class="p">(</span><span class="n">long_currency</span><span class="p">,</span> <span class="n">short_currency</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="n">pair</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">days</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient price data&#39;</span><span class="p">}</span>
        
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span>
        <span class="n">price_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">days</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">carry_return</span> <span class="o">=</span> <span class="n">carry</span><span class="p">[</span><span class="s1">&#39;annual_carry&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">days</span> <span class="o">/</span> <span class="mi">365</span>
        
        <span class="c1"># Adjust direction based on pair convention</span>
        <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">long_currency</span><span class="p">):</span>
            <span class="n">total_return</span> <span class="o">=</span> <span class="n">price_return</span> <span class="o">+</span> <span class="n">carry_return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_return</span> <span class="o">=</span> <span class="o">-</span><span class="n">price_return</span> <span class="o">+</span> <span class="n">carry_return</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="n">days</span><span class="p">,</span>
            <span class="s1">&#39;price_return&#39;</span><span class="p">:</span> <span class="n">price_return</span><span class="p">,</span>
            <span class="s1">&#39;carry_return&#39;</span><span class="p">:</span> <span class="n">carry_return</span><span class="p">,</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;carry_helped&#39;</span><span class="p">:</span> <span class="n">carry_return</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">carry_calc</span> <span class="o">=</span> <span class="n">CarryTradeCalculator</span><span class="p">()</span>

<span class="c1"># Set interest rates</span>
<span class="n">carry_calc</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">)</span>
<span class="n">carry_calc</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">)</span>
<span class="n">carry_calc</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
<span class="n">carry_calc</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="mf">4.35</span><span class="p">)</span>
<span class="n">carry_calc</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;CHF&#39;</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best Carry Pairs:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">carry_calc</span><span class="o">.</span><span class="n">get_best_carry_pairs</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Long </span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;long_currency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/Short </span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;short_currency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;annual_carry&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CarryTradeStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Full carry trade strategy with risk management.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_carry</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">max_volatility</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_carry</span> <span class="o">=</span> <span class="n">min_carry</span>  <span class="c1"># Minimum carry to consider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_volatility</span> <span class="o">=</span> <span class="n">max_volatility</span>  <span class="c1"># Maximum acceptable volatility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculator</span> <span class="o">=</span> <span class="n">CarryTradeCalculator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vix</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">set_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set interest rate.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vol</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set annualized volatility for pair.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span>
    
    <span class="k">def</span> <span class="nf">set_vix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vix</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set current VIX level.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vix</span> <span class="o">=</span> <span class="n">vix</span>
    
    <span class="k">def</span> <span class="nf">risk_on_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if risk environment supports carry.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vix</span> <span class="o">&lt;</span> <span class="mi">20</span>
    
    <span class="k">def</span> <span class="nf">calculate_risk_adjusted_carry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long_curr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">short_curr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate carry adjusted for volatility risk.&quot;&quot;&quot;</span>
        <span class="n">carry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">calculate_carry</span><span class="p">(</span><span class="n">long_curr</span><span class="p">,</span> <span class="n">short_curr</span><span class="p">)</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
        
        <span class="c1"># Sharpe-like ratio: carry / volatility</span>
        <span class="n">carry_ratio</span> <span class="o">=</span> <span class="n">carry</span><span class="p">[</span><span class="s1">&#39;annual_carry&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">vol</span> <span class="k">if</span> <span class="n">vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">carry</span><span class="p">,</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">vol</span><span class="p">,</span>
            <span class="s1">&#39;carry_ratio&#39;</span><span class="p">:</span> <span class="n">carry_ratio</span><span class="p">,</span>
            <span class="s1">&#39;attractive&#39;</span><span class="p">:</span> <span class="n">carry</span><span class="p">[</span><span class="s1">&#39;annual_carry&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_carry</span> <span class="ow">and</span> <span class="n">vol</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_volatility</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate carry trade signals.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_on_environment</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;risk_off&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;VIX at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vix</span><span class="si">}</span><span class="s1">, avoid carry&#39;</span><span class="p">}]</span>
        
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">best_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">get_best_carry_pairs</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">pair_info</span> <span class="ow">in</span> <span class="n">best_pairs</span><span class="p">:</span>
            <span class="c1"># Construct pair name</span>
            <span class="n">pair</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pair_info</span><span class="p">[</span><span class="s1">&#39;long_currency&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">pair_info</span><span class="p">[</span><span class="s1">&#39;short_currency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">pair_info</span><span class="p">[</span><span class="s1">&#39;annual_carry&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_carry</span><span class="p">:</span>
                <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">vol</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_volatility</span><span class="p">:</span>
                    <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;carry_long&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                        <span class="s1">&#39;carry&#39;</span><span class="p">:</span> <span class="n">pair_info</span><span class="p">[</span><span class="s1">&#39;annual_carry&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">vol</span><span class="p">,</span>
                        <span class="s1">&#39;carry_ratio&#39;</span><span class="p">:</span> <span class="n">pair_info</span><span class="p">[</span><span class="s1">&#39;annual_carry&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">vol</span><span class="p">,</span>
                        <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="n">pair_info</span><span class="p">[</span><span class="s1">&#39;annual_carry&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">vol</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;medium&#39;</span>
                    <span class="p">})</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;carry_ratio&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Demo</span>
<span class="n">carry_strategy</span> <span class="o">=</span> <span class="n">CarryTradeStrategy</span><span class="p">(</span><span class="n">min_carry</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">max_volatility</span><span class="o">=</span><span class="mf">12.0</span><span class="p">)</span>

<span class="c1"># Set rates</span>
<span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">)</span>
<span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">)</span>
<span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
<span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="mf">4.35</span><span class="p">)</span>

<span class="c1"># Set volatilities</span>
<span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_volatility</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="mf">8.5</span><span class="p">)</span>
<span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_volatility</span><span class="p">(</span><span class="s1">&#39;AUDJPY&#39;</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">)</span>
<span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_volatility</span><span class="p">(</span><span class="s1">&#39;EURJPY&#39;</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">)</span>

<span class="c1"># Set VIX</span>
<span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_vix</span><span class="p">(</span><span class="mf">16.5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Carry Trade Signals:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">carry_strategy</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">signal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>8.4 News Trading</h2>
<p>News trading strategies capitalize on high-impact economic releases and central bank decisions.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">NewsEvent</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a high-impact news event.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">release_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
                 <span class="n">forecast</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">previous</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">impact</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release_time</span> <span class="o">=</span> <span class="n">release_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forecast</span> <span class="o">=</span> <span class="n">forecast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="n">previous</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impact</span> <span class="o">=</span> <span class="n">impact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actual</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">set_actual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set actual release value.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">actual</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">surprise</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate surprise (actual - forecast).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">surprise_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate surprise as percentage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forecast</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">NewsTrader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;News trading strategy implementation.&quot;&quot;&quot;</span>
    
    <span class="c1"># Expected impact of surprise on currency (pips per 1% surprise)</span>
    <span class="n">EVENT_SENSITIVITY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;NFP&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="s1">&#39;CPI&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="s1">&#39;GDP&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s1">&#39;Rate Decision&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="s1">&#39;Retail Sales&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s1">&#39;PMI&#39;</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">NewsEvent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">historical_reactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">NewsEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add upcoming or past event.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">record_reaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">surprise_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price_move_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Record historical price reaction to event.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">historical_reactions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event_name</span><span class="p">,</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;surprise_pct&#39;</span><span class="p">:</span> <span class="n">surprise_pct</span><span class="p">,</span>
            <span class="s1">&#39;price_move&#39;</span><span class="p">:</span> <span class="n">price_move_pips</span><span class="p">,</span>
            <span class="s1">&#39;sensitivity&#39;</span><span class="p">:</span> <span class="n">price_move_pips</span> <span class="o">/</span> <span class="n">surprise_pct</span> <span class="k">if</span> <span class="n">surprise_pct</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">estimate_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">NewsEvent</span><span class="p">,</span> <span class="n">actual</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Estimate expected price move based on surprise.&quot;&quot;&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">set_actual</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>
        <span class="n">surprise_pct</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">surprise_pct</span>
        
        <span class="k">if</span> <span class="n">surprise_pct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No surprise calculated&#39;</span><span class="p">}</span>
        
        <span class="c1"># Get sensitivity for this event type</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EVENT_SENSITIVITY</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        
        <span class="c1"># Check historical reactions for this specific event</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_reactions</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hist</span><span class="p">:</span>
            <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">hist</span><span class="p">])</span>
        
        <span class="n">expected_move</span> <span class="o">=</span> <span class="n">surprise_pct</span> <span class="o">*</span> <span class="n">sensitivity</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;actual&#39;</span><span class="p">:</span> <span class="n">actual</span><span class="p">,</span>
            <span class="s1">&#39;forecast&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">forecast</span><span class="p">,</span>
            <span class="s1">&#39;surprise_pct&#39;</span><span class="p">:</span> <span class="n">surprise_pct</span><span class="p">,</span>
            <span class="s1">&#39;expected_move_pips&#39;</span><span class="p">:</span> <span class="n">expected_move</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span> <span class="k">if</span> <span class="n">expected_move</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span>
            <span class="s1">&#39;magnitude&#39;</span><span class="p">:</span> <span class="s1">&#39;large&#39;</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expected_move</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;medium&#39;</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">expected_move</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="k">else</span> <span class="s1">&#39;small&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">straddle_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">NewsEvent</span><span class="p">,</span> <span class="n">entry_distance_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set up a straddle trade before news release.&quot;&quot;&quot;</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EVENT_SENSITIVITY</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        
        <span class="c1"># Estimate potential move based on typical surprise</span>
        <span class="n">typical_surprise</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Assume 2% typical surprise</span>
        <span class="n">expected_move</span> <span class="o">=</span> <span class="n">typical_surprise</span> <span class="o">*</span> <span class="n">sensitivity</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;straddle&#39;</span><span class="p">,</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;release_time&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">release_time</span><span class="p">,</span>
            <span class="s1">&#39;buy_stop_distance&#39;</span><span class="p">:</span> <span class="n">entry_distance_pips</span><span class="p">,</span>
            <span class="s1">&#39;sell_stop_distance&#39;</span><span class="p">:</span> <span class="n">entry_distance_pips</span><span class="p">,</span>
            <span class="s1">&#39;target_pips&#39;</span><span class="p">:</span> <span class="n">expected_move</span><span class="p">,</span>
            <span class="s1">&#39;stop_loss_pips&#39;</span><span class="p">:</span> <span class="n">entry_distance_pips</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span>
            <span class="s1">&#39;risk_reward&#39;</span><span class="p">:</span> <span class="n">expected_move</span> <span class="o">/</span> <span class="p">(</span><span class="n">entry_distance_pips</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">),</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;trade&#39;</span> <span class="k">if</span> <span class="n">expected_move</span> <span class="o">/</span> <span class="p">(</span><span class="n">entry_distance_pips</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.5</span> <span class="k">else</span> <span class="s1">&#39;skip&#39;</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">news_trader</span> <span class="o">=</span> <span class="n">NewsTrader</span><span class="p">()</span>

<span class="c1"># Create NFP event</span>
<span class="n">nfp</span> <span class="o">=</span> <span class="n">NewsEvent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;NFP&#39;</span><span class="p">,</span>
    <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span>
    <span class="n">release_time</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="n">forecast</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span>
    <span class="n">previous</span><span class="o">=</span><span class="mi">303</span>
<span class="p">)</span>
<span class="n">news_trader</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">nfp</span><span class="p">)</span>

<span class="c1"># Record some historical reactions</span>
<span class="n">news_trader</span><span class="o">.</span><span class="n">record_reaction</span><span class="p">(</span><span class="s1">&#39;NFP&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
<span class="n">news_trader</span><span class="o">.</span><span class="n">record_reaction</span><span class="p">(</span><span class="s1">&#39;NFP&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">)</span>
<span class="n">news_trader</span><span class="o">.</span><span class="n">record_reaction</span><span class="p">(</span><span class="s1">&#39;NFP&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mi">85</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Straddle Setup:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">news_trader</span><span class="o">.</span><span class="n">straddle_setup</span><span class="p">(</span><span class="n">nfp</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">After Release (Actual = 275):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">news_trader</span><span class="o">.</span><span class="n">estimate_move</span><span class="p">(</span><span class="n">nfp</span><span class="p">,</span> <span class="mi">275</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">FadeStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fade (counter-trend) strategy after news spikes.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fade_threshold_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> 
                 <span class="n">wait_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fade_threshold</span> <span class="o">=</span> <span class="n">fade_threshold_pips</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_minutes</span> <span class="o">=</span> <span class="n">wait_minutes</span>
    
    <span class="k">def</span> <span class="nf">analyze_spike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_news_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">spike_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pip_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze post-news spike for fade opportunity.&quot;&quot;&quot;</span>
        <span class="n">spike_pips</span> <span class="o">=</span> <span class="p">(</span><span class="n">spike_price</span> <span class="o">-</span> <span class="n">pre_news_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_value</span>
        <span class="n">current_pips</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">pre_news_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_value</span>
        
        <span class="c1"># Calculate retracement</span>
        <span class="k">if</span> <span class="n">spike_pips</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">retracement</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">current_pips</span> <span class="o">/</span> <span class="n">spike_pips</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retracement</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;spike_pips&#39;</span><span class="p">:</span> <span class="n">spike_pips</span><span class="p">,</span>
            <span class="s1">&#39;current_from_pre&#39;</span><span class="p">:</span> <span class="n">current_pips</span><span class="p">,</span>
            <span class="s1">&#39;retracement&#39;</span><span class="p">:</span> <span class="n">retracement</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;spike_direction&#39;</span><span class="p">:</span> <span class="s1">&#39;up&#39;</span> <span class="k">if</span> <span class="n">spike_pips</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;down&#39;</span><span class="p">,</span>
            <span class="s1">&#39;extended&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">spike_pips</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fade_threshold</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_fade_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_news</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">spike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">current</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pip_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate fade trade signal.&quot;&quot;&quot;</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_spike</span><span class="p">(</span><span class="n">pre_news</span><span class="p">,</span> <span class="n">spike</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">pip_value</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;extended&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_trade&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Spike not extended enough&#39;</span><span class="p">}</span>
        
        <span class="c1"># Fade if retracement is small (spike still extended)</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;retracement&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;spike_direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span> <span class="k">else</span> <span class="s1">&#39;buy&#39;</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">pre_news</span> <span class="o">+</span> <span class="p">(</span><span class="n">spike</span> <span class="o">-</span> <span class="n">pre_news</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>  <span class="c1"># Target 50% retracement</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">spike</span> <span class="o">+</span> <span class="p">(</span><span class="n">spike</span> <span class="o">-</span> <span class="n">pre_news</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>  <span class="c1"># Stop beyond spike</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
                <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
                <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span>
                <span class="s1">&#39;risk_pips&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">current</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_value</span><span class="p">,</span>
                <span class="s1">&#39;reward_pips&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">current</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_value</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Fade extended </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;spike_direction&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> spike&#39;</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_trade&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Already retracing&#39;</span><span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">fade</span> <span class="o">=</span> <span class="n">FadeStrategy</span><span class="p">(</span><span class="n">fade_threshold_pips</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>

<span class="c1"># Scenario: NFP spike up 60 pips, now only retraced 10 pips</span>
<span class="n">pre_news</span> <span class="o">=</span> <span class="mf">1.1000</span>
<span class="n">spike</span> <span class="o">=</span> <span class="mf">1.1060</span>  <span class="c1"># 60 pip spike up</span>
<span class="n">current</span> <span class="o">=</span> <span class="mf">1.1050</span>  <span class="c1"># Only 10 pip retracement</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fade Analysis:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fade</span><span class="o">.</span><span class="n">analyze_spike</span><span class="p">(</span><span class="n">pre_news</span><span class="p">,</span> <span class="n">spike</span><span class="p">,</span> <span class="n">current</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fade Signal:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fade</span><span class="o">.</span><span class="n">generate_fade_signal</span><span class="p">(</span><span class="n">pre_news</span><span class="p">,</span> <span class="n">spike</span><span class="p">,</span> <span class="n">current</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2></div>
<div class="md-cell"><h3>Exercise 1: Triple MA Strategy (Guided)</h3>
<p>Complete the <code>TripleMAStrategy</code> class that uses three moving averages for trend confirmation.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TripleMAStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Triple moving average trend following strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">medium</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">slow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast</span> <span class="o">=</span> <span class="n">fast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">medium</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="n">slow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set price data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">calculate_mas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate all three MAs.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">})</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">______</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">get_alignment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check MA alignment.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_mas</span><span class="p">()</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;______&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;mixed&#39;</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal.&quot;&quot;&quot;</span>
        <span class="n">alignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alignment</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_mas</span><span class="p">()</span>
        
        <span class="c1"># Check for pullback to medium MA in trending market</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">near_medium</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">latest</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.005</span>
        
        <span class="k">if</span> <span class="n">alignment</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span> <span class="ow">and</span> <span class="n">near_medium</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;______&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Bullish alignment + pullback&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">alignment</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span> <span class="ow">and</span> <span class="n">near_medium</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearish alignment + pullback&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">alignment</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;bearish&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;hold&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">alignment</span><span class="si">}</span><span class="s1"> but no pullback&#39;</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;No clear trend&#39;</span><span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">triple_ma</span> <span class="o">=</span> <span class="n">TripleMAStrategy</span><span class="p">()</span>
<span class="n">triple_ma</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alignment: </span><span class="si">{</span><span class="n">triple_ma</span><span class="o">.</span><span class="n">get_alignment</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal: </span><span class="si">{</span><span class="n">triple_ma</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TripleMAStrategy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">medium</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">slow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast</span> <span class="o">=</span> <span class="n">fast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">medium</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="n">slow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>

    <span class="k">def</span> <span class="nf">calculate_mas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">})</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">get_alignment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_mas</span><span class="p">()</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;mixed&#39;</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">alignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alignment</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_mas</span><span class="p">()</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">near_medium</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">latest</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.005</span>

        <span class="k">if</span> <span class="n">alignment</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span> <span class="ow">and</span> <span class="n">near_medium</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Bullish alignment + pullback&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">alignment</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span> <span class="ow">and</span> <span class="n">near_medium</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearish alignment + pullback&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">alignment</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;bearish&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;hold&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">alignment</span><span class="si">}</span><span class="s1"> but no pullback&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;No clear trend&#39;</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 2: RSI Divergence Detector (Guided)</h3>
<p>Complete the <code>RSIDivergence</code> class that detects bullish and bearish RSI divergences.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">RSIDivergence</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect RSI divergences for mean reversion signals.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rsi_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span> <span class="o">=</span> <span class="n">rsi_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set price data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">calculate_rsi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate RSI.&quot;&quot;&quot;</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">______</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">find_divergence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find bullish or bearish divergence.&quot;&quot;&quot;</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_rsi</span><span class="p">()</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span>
        <span class="n">rsi_recent</span> <span class="o">=</span> <span class="n">rsi</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span>
        
        <span class="c1"># Find local lows for bullish divergence</span>
        <span class="n">price_low_idx</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">______</span>
        <span class="n">rsi_at_price_low</span> <span class="o">=</span> <span class="n">rsi_recent</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">price_low_idx</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)]</span>
        
        <span class="n">current_price</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_rsi</span> <span class="o">=</span> <span class="n">rsi_recent</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Bullish divergence: price makes lower low, RSI makes higher low</span>
        <span class="k">if</span> <span class="n">current_price</span> <span class="o">&lt;</span> <span class="n">prices</span><span class="p">[</span><span class="n">price_low_idx</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current_rsi</span> <span class="o">&gt;</span> <span class="n">rsi_at_price_low</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;divergence&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;price_low&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="p">[</span><span class="n">price_low_idx</span><span class="p">],</span>
                <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">current_price</span><span class="p">,</span>
                <span class="s1">&#39;rsi_at_low&#39;</span><span class="p">:</span> <span class="n">rsi_at_price_low</span><span class="p">,</span>
                <span class="s1">&#39;current_rsi&#39;</span><span class="p">:</span> <span class="n">current_rsi</span>
            <span class="p">}</span>
        
        <span class="c1"># Check bearish (price higher high, RSI lower high)</span>
        <span class="n">price_high_idx</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
        <span class="n">rsi_at_price_high</span> <span class="o">=</span> <span class="n">rsi_recent</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">price_high_idx</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">current_price</span> <span class="o">&gt;</span> <span class="n">prices</span><span class="p">[</span><span class="n">price_high_idx</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current_rsi</span> <span class="o">&lt;</span> <span class="n">rsi_at_price_high</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;divergence&#39;</span><span class="p">:</span> <span class="s1">&#39;______&#39;</span><span class="p">,</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
                <span class="s1">&#39;price_high&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="p">[</span><span class="n">price_high_idx</span><span class="p">],</span>
                <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">current_price</span><span class="p">,</span>
                <span class="s1">&#39;rsi_at_high&#39;</span><span class="p">:</span> <span class="n">rsi_at_price_high</span><span class="p">,</span>
                <span class="s1">&#39;current_rsi&#39;</span><span class="p">:</span> <span class="n">current_rsi</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;divergence&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">div_detector</span> <span class="o">=</span> <span class="n">RSIDivergence</span><span class="p">()</span>
<span class="n">div_detector</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">range_close</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Divergence: </span><span class="si">{</span><span class="n">div_detector</span><span class="o">.</span><span class="n">find_divergence</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RSIDivergence</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rsi_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span> <span class="o">=</span> <span class="n">rsi_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>

    <span class="k">def</span> <span class="nf">calculate_rsi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">find_divergence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_rsi</span><span class="p">()</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span>
        <span class="n">rsi_recent</span> <span class="o">=</span> <span class="n">rsi</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span>

        <span class="n">price_low_idx</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
        <span class="c1"># ... rest of implementation</span>

        <span class="c1"># Bearish divergence check</span>
        <span class="k">if</span> <span class="n">current_price</span> <span class="o">&gt;</span> <span class="n">prices</span><span class="p">[</span><span class="n">price_high_idx</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current_rsi</span> <span class="o">&lt;</span> <span class="n">rsi_at_price_high</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;divergence&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
                <span class="o">...</span>
            <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 3: Carry Portfolio Builder (Guided)</h3>
<p>Complete the <code>CarryPortfolio</code> class that builds a diversified carry trade portfolio.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CarryPortfolio</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Build diversified carry trade portfolio.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_positions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">min_carry</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_positions</span> <span class="o">=</span> <span class="n">max_positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_carry</span> <span class="o">=</span> <span class="n">min_carry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">set_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set interest rate.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
    
    <span class="k">def</span> <span class="nf">get_all_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all possible carry pairs.&quot;&quot;&quot;</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">currencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currencies</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">currencies</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">carry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">carry</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_carry</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">carry</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">c2</span><span class="p">,</span> <span class="s1">&#39;carry&#39;</span><span class="p">:</span> <span class="n">carry</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">c2</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span> <span class="s1">&#39;carry&#39;</span><span class="p">:</span> <span class="n">______</span><span class="p">(</span><span class="n">carry</span><span class="p">)})</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;carry&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">build_portfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Build diversified portfolio.&quot;&quot;&quot;</span>
        <span class="n">all_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_pairs</span><span class="p">()</span>
        <span class="n">portfolio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">used_currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">all_pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">portfolio</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_positions</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="c1"># Check if currencies already used (for diversification)</span>
            <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_currencies</span> <span class="ow">or</span> <span class="n">pair</span><span class="p">[</span><span class="s1">&#39;______&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_currencies</span><span class="p">:</span>
                <span class="n">portfolio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
                <span class="n">used_currencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">])</span>
                <span class="n">used_currencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">portfolio</span>
        <span class="k">return</span> <span class="n">portfolio</span>
    
    <span class="k">def</span> <span class="nf">portfolio_carry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total portfolio carry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_portfolio</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;carry&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="k">else</span> <span class="mi">0</span>

<span class="c1"># Test</span>
<span class="n">portfolio</span> <span class="o">=</span> <span class="n">CarryPortfolio</span><span class="p">(</span><span class="n">max_positions</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_carry</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">portfolio</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">)</span>
<span class="n">portfolio</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">)</span>
<span class="n">portfolio</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
<span class="n">portfolio</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="mf">4.35</span><span class="p">)</span>
<span class="n">portfolio</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;CHF&#39;</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Carry Portfolio:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">portfolio</span><span class="o">.</span><span class="n">build_portfolio</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Long </span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/Short </span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;carry&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Average Carry: </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">portfolio_carry</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CarryPortfolio</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_positions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">min_carry</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_positions</span> <span class="o">=</span> <span class="n">max_positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_carry</span> <span class="o">=</span> <span class="n">min_carry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>

    <span class="k">def</span> <span class="nf">get_all_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">currencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">currencies</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">currencies</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">carry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">carry</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_carry</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">carry</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">c2</span><span class="p">,</span> <span class="s1">&#39;carry&#39;</span><span class="p">:</span> <span class="n">carry</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">c2</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span> <span class="s1">&#39;carry&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">carry</span><span class="p">)})</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;carry&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_portfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="n">all_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_pairs</span><span class="p">()</span>
        <span class="n">portfolio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">used_currencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">all_pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">portfolio</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_positions</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_currencies</span> <span class="ow">or</span> <span class="n">pair</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_currencies</span><span class="p">:</span>
                <span class="n">portfolio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
                <span class="n">used_currencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">])</span>
                <span class="n">used_currencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">portfolio</span>
        <span class="k">return</span> <span class="n">portfolio</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 4: Complete Trend Following System (Open-ended)</h3>
<p>Build a comprehensive trend following system that:
- Uses multiple timeframe confirmation
- Includes ADX trend filter
- Implements trailing stops
- Manages position sizing</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4: Complete Trend Following System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class TrendFollowingSystem</span>
<span class="c1"># 2. Multiple MA periods (fast, medium, slow)</span>
<span class="c1"># 3. ADX filter (only trade when ADX &gt; threshold)</span>
<span class="c1"># 4. ATR-based trailing stop</span>
<span class="c1"># 5. Position sizing based on account risk %</span>
<span class="c1"># 6. Generate signals with entry, stop, and position size</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TrendFollowingSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_ma</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">medium_ma</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">slow_ma</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">adx_threshold</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_ma</span> <span class="o">=</span> <span class="n">fast_ma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium_ma</span> <span class="o">=</span> <span class="n">medium_ma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_ma</span> <span class="o">=</span> <span class="n">slow_ma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adx_threshold</span> <span class="o">=</span> <span class="n">adx_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">high</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">close</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fast_ma</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medium_ma</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slow_ma</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># ATR</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> 
                       <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># ADX (simplified)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;adx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># Placeholder</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                               <span class="n">stop_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pip_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">account</span> <span class="o">*</span> <span class="n">risk_pct</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="p">(</span><span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">position</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_indicators</span><span class="p">()</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Check alignment and ADX</span>
        <span class="n">bullish</span> <span class="o">=</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;fast&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;slow&#39;</span><span class="p">]</span>
        <span class="n">bearish</span> <span class="o">=</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;fast&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;slow&#39;</span><span class="p">]</span>
        <span class="n">trending</span> <span class="o">=</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;adx&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">adx_threshold</span>

        <span class="k">if</span> <span class="n">bullish</span> <span class="ow">and</span> <span class="n">trending</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span>
            <span class="n">stop_pips</span> <span class="o">=</span> <span class="p">(</span><span class="n">latest</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stop</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.0001</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">,</span> <span class="n">stop_pips</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">bearish</span> <span class="ow">and</span> <span class="n">trending</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span>
            <span class="n">stop_pips</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">0.0001</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">,</span> <span class="n">stop_pips</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 5: Range Trading System (Open-ended)</h3>
<p>Build a range trading system that:
- Detects ranging markets
- Identifies support/resistance levels
- Uses oscillators for confirmation
- Sets appropriate targets and stops</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 5: Range Trading System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class RangeTradingSystem</span>
<span class="c1"># 2. Detect ranging markets (low ADX or range detection)</span>
<span class="c1"># 3. Identify support/resistance from recent highs/lows</span>
<span class="c1"># 4. Use RSI or Stochastic for entry timing</span>
<span class="c1"># 5. Target opposite boundary of range</span>
<span class="c1"># 6. Stop outside range boundary</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RangeTradingSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">rsi_period</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span> <span class="o">=</span> <span class="n">rsi_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">high</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">close</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">detect_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">resistance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">range_size</span> <span class="o">=</span> <span class="n">resistance</span> <span class="o">-</span> <span class="n">support</span>

        <span class="c1"># Check if price stayed in range</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span>
        <span class="n">in_range</span> <span class="o">=</span> <span class="nb">all</span><span class="p">((</span><span class="n">recent</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">resistance</span> <span class="o">*</span> <span class="mf">1.01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">recent</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">support</span> <span class="o">*</span> <span class="mf">0.99</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;ranging&#39;</span><span class="p">:</span> <span class="n">in_range</span><span class="p">,</span> <span class="s1">&#39;resistance&#39;</span><span class="p">:</span> <span class="n">resistance</span><span class="p">,</span> <span class="s1">&#39;support&#39;</span><span class="p">:</span> <span class="n">support</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="n">range_size</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">calculate_rsi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">gain</span><span class="o">/</span><span class="n">loss</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_range</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rng</span><span class="p">[</span><span class="s1">&#39;ranging&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_trade&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Not ranging&#39;</span><span class="p">}</span>

        <span class="n">rsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_rsi</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">near_support</span> <span class="o">=</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">rng</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">rng</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.2</span>
        <span class="n">near_resistance</span> <span class="o">=</span> <span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">price</span><span class="p">)</span> <span class="o">/</span> <span class="n">rng</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.2</span>

        <span class="k">if</span> <span class="n">near_support</span> <span class="ow">and</span> <span class="n">rsi</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">rng</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">],</span>
                <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">rng</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">rng</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">near_resistance</span> <span class="ow">and</span> <span class="n">rsi</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
                <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">rng</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">],</span>
                <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">rng</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">rng</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;wait&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Not at range extremes&#39;</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 6: Multi-Strategy Manager (Open-ended)</h3>
<p>Build a strategy manager that:
- Combines trend, range, carry, and news strategies
- Allocates capital based on market regime
- Manages overall portfolio risk
- Generates consolidated signals</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 6: Multi-Strategy Manager (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class MultiStrategyManager</span>
<span class="c1"># 2. Include: trend, range, carry, news strategies</span>
<span class="c1"># 3. Detect market regime (trending vs ranging)</span>
<span class="c1"># 4. Allocate capital based on regime</span>
<span class="c1"># 5. Set overall portfolio risk limits</span>
<span class="c1"># 6. Generate consolidated trade recommendations</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiStrategyManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">total_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk</span> <span class="o">=</span> <span class="n">max_risk_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;carry&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;news&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">add_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy</span>

    <span class="k">def</span> <span class="nf">detect_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adx</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">adx</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;trending&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;ranging&#39;</span>

    <span class="k">def</span> <span class="nf">adjust_allocations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regime</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">regime</span> <span class="o">==</span> <span class="s1">&#39;trending&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;carry&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;news&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;carry&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;news&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_strategy_capital</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">strategy_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regime</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;trending&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_allocations</span><span class="p">(</span><span class="n">regime</span><span class="p">)</span>
        <span class="n">all_signals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="s1">&#39;generate_signal&#39;</span><span class="p">):</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">()</span>
                <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;capital_allocated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_strategy_capital</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">all_signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_signals</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;no_trade&#39;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">check_risk_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="n">total_risk</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;risk_pct&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total_risk</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk</span> <span class="o">/</span> <span class="n">total_risk</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;position_scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>

        <span class="k">return</span> <span class="n">signals</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Multi-Strategy Forex System</h2>
<p>Build a production-ready system that combines all trading strategies.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ForexTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready multi-strategy forex trading system.</span>
<span class="sd">    </span>
<span class="sd">    Integrates: Trend following, Mean reversion, Carry trade, News trading.</span>
<span class="sd">    Features: Regime detection, Capital allocation, Risk management.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">max_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span> <span class="o">=</span> <span class="n">max_risk_pct</span>
        
        <span class="c1"># Initialize strategies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_strategy</span> <span class="o">=</span> <span class="n">MovingAverageCrossover</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mr_strategy</span> <span class="o">=</span> <span class="n">MeanReversionStrategy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carry_strategy</span> <span class="o">=</span> <span class="n">CarryTradeStrategy</span><span class="p">()</span>
        
        <span class="c1"># Market data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">load_price_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load price data for a currency pair.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">set_interest_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set interest rate for carry calculations.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">detect_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect market regime (trending vs ranging).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>
        
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span>
        
        <span class="c1"># Simple regime detection using MA slope and range</span>
        <span class="n">ma20</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ma_slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">ma20</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ma20</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">])</span> <span class="o">/</span> <span class="n">ma20</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="n">range_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ma_slope</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">range_pct</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;trending&#39;</span>
        <span class="k">elif</span> <span class="n">range_pct</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;ranging&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;transitioning&#39;</span>
    
    <span class="k">def</span> <span class="nf">get_trend_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get trend following signals.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ma_strategy</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="n">pair</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ma_strategy</span><span class="o">.</span><span class="n">get_current_signal</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_mr_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get mean reversion signals.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;no_data&#39;</span><span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mr_strategy</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="n">pair</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mr_strategy</span><span class="o">.</span><span class="n">get_current_signal</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_carry_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get carry trade signals.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_vix</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>  <span class="c1"># Default low vol</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">carry_strategy</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">generate_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate all trading recommendations.&quot;&quot;&quot;</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_regime</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        
        <span class="c1"># Trend following (prioritize in trending regime)</span>
        <span class="n">trend_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trend_signals</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trend_signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">]:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;trend_following&#39;</span><span class="p">,</span>
                <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">trend_signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span>
                <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="n">regime</span> <span class="o">==</span> <span class="s1">&#39;trending&#39;</span> <span class="k">else</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
                <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">trend_signal</span>
            <span class="p">})</span>
        
        <span class="c1"># Mean reversion (prioritize in ranging regime)</span>
        <span class="n">mr_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mr_signals</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mr_signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">]:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;mean_reversion&#39;</span><span class="p">,</span>
                <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span> <span class="k">if</span> <span class="n">mr_signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span> <span class="k">else</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span>
                <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="n">regime</span> <span class="o">==</span> <span class="s1">&#39;ranging&#39;</span> <span class="k">else</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
                <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">mr_signal</span>
            <span class="p">})</span>
        
        <span class="c1"># Carry trades</span>
        <span class="k">for</span> <span class="n">carry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_carry_signals</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">carry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;carry_long&#39;</span><span class="p">:</span>
                <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;carry_trade&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">carry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pair&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">carry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">carry</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">recommendations</span>
    
    <span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stop_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate position size based on risk.&quot;&quot;&quot;</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Standard lot pip value for major pairs</span>
        <span class="n">position_size</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="p">(</span><span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">position_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print trading dashboard.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  FOREX TRADING SYSTEM DASHBOARD&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="c1"># Market Regime</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_regime</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Market Regime: </span><span class="si">{</span><span class="n">regime</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Primary Pair: </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Strategy Signals</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STRATEGY SIGNALS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trend Following: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_trend_signals</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Reversion: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mr_signals</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">carry_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_carry_signals</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Carry Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">carry_signals</span><span class="p">)</span><span class="si">}</span><span class="s2"> opportunities&quot;</span><span class="p">)</span>
        
        <span class="c1"># Recommendations</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RECOMMENDATIONS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_recommendations</span><span class="p">(</span><span class="n">pair</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Pair: </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> | Direction: </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Confidence: </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demo the system</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">ForexTradingSystem</span><span class="p">(</span><span class="n">capital</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">max_risk_pct</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># Load price data</span>
<span class="n">eurusd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.0800</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0002</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mi">100</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">usdjpy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">150.00</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>

<span class="n">system</span><span class="o">.</span><span class="n">load_price_data</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="n">eurusd</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">load_price_data</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="n">usdjpy</span><span class="p">)</span>

<span class="c1"># Set interest rates</span>
<span class="n">system</span><span class="o">.</span><span class="n">set_interest_rate</span><span class="p">(</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">set_interest_rate</span><span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">set_interest_rate</span><span class="p">(</span><span class="s1">&#39;JPY&#39;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">set_interest_rate</span><span class="p">(</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="mf">4.35</span><span class="p">)</span>

<span class="c1"># Set volatilities for carry strategy</span>
<span class="n">system</span><span class="o">.</span><span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_volatility</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">carry_strategy</span><span class="o">.</span><span class="n">set_volatility</span><span class="p">(</span><span class="s1">&#39;AUDJPY&#39;</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">)</span>

<span class="c1"># Print dashboard</span>
<span class="n">system</span><span class="o">.</span><span class="n">print_dashboard</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ul>
<li><strong>Trend Following</strong>: MA crossovers and breakouts work best in trending markets; use ADX filter</li>
<li><strong>Mean Reversion</strong>: Range trading and Bollinger Band strategies work in low-volatility, ranging markets</li>
<li><strong>Carry Trade</strong>: Profit from interest rate differentials; works best in risk-on, low-volatility environments</li>
<li><strong>News Trading</strong>: Straddle for unknown direction, fade extended spikes; requires fast execution</li>
<li><strong>Regime Detection</strong>: Match strategy to market conditions; trend strategies fail in ranges and vice versa</li>
<li><strong>Position Sizing</strong>: Always size based on account risk %, not potential profit</li>
<li><strong>Multi-Strategy</strong>: Diversify across strategies that perform differently in various conditions</li>
<li><strong>Risk First</strong>: No strategy works all the time; proper risk management is essential</li>
</ul>
<p><strong>Next: Part 3 - Risk &amp; Execution</strong> where we'll build comprehensive risk management and backtesting systems.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="9"><div class="md-cell module-header"><h1>Module 9: Risk Management</h1>
<p><strong>Part 3: Risk &amp; Execution</strong></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ul>
<li>Implement pip-based and ATR-based stop losses for forex</li>
<li>Calculate tick-based risk and position sizing for futures</li>
<li>Manage portfolio-level currency exposure and hedging</li>
<li>Handle weekend gaps and overnight risk</li>
</ul>
<h2>Prerequisites</h2>
<ul>
<li>Modules 1-8 (Forex/Futures fundamentals, strategies)</li>
<li>Understanding of leverage and margin</li>
<li>Python pandas proficiency</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>9.1 Forex Risk Management</h2>
<p>Forex risk management requires understanding pip values, proper stop placement, and currency correlation risks.</p></div>
<div class="md-cell"><h3>Pip Value Calculation</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Pair Type</th>
<th>Pip Size</th>
<th>Pip Value (Standard Lot)</th>
</tr>
</thead>
<tbody>
<tr>
<td>XXX/USD</td>
<td>0.0001</td>
<td>$10</td>
</tr>
<tr>
<td>USD/XXX</td>
<td>0.0001</td>
<td>$10 / exchange rate</td>
</tr>
<tr>
<td>XXX/JPY</td>
<td>0.01</td>
<td>~$7-9 (varies)</td>
</tr>
<tr>
<td>Cross pairs</td>
<td>0.0001</td>
<td>Requires conversion</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ForexRiskCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate forex position risk and sizing.&quot;&quot;&quot;</span>
    
    <span class="c1"># Pip sizes by pair type</span>
    <span class="n">PIP_SIZES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;standard&#39;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">,</span>  <span class="c1"># Most pairs</span>
        <span class="s1">&#39;jpy&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>  <span class="c1"># JPY pairs</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_currency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span> <span class="o">=</span> <span class="n">account_currency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># For conversion</span>
    
    <span class="k">def</span> <span class="nf">set_exchange_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set exchange rate for conversion.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
    
    <span class="k">def</span> <span class="nf">get_pip_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get pip size for a currency pair.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">PIP_SIZES</span><span class="p">[</span><span class="s1">&#39;jpy&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">PIP_SIZES</span><span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">calculate_pip_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lot_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate pip value in account currency.&quot;&quot;&quot;</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pip_size</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">lot_size</span> <span class="o">*</span> <span class="mi">100000</span>  <span class="c1"># Standard lot = 100,000 units</span>
        
        <span class="c1"># Base pip value</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="n">pip_size</span> <span class="o">*</span> <span class="n">units</span>
        
        <span class="c1"># Convert to account currency</span>
        <span class="n">quote_currency</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
        
        <span class="k">if</span> <span class="n">quote_currency</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pip_value</span>
        <span class="k">elif</span> <span class="n">quote_currency</span> <span class="o">==</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span> <span class="o">==</span> <span class="s1">&#39;USD&#39;</span><span class="p">:</span>
            <span class="n">usdjpy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="mf">150.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pip_value</span> <span class="o">/</span> <span class="n">usdjpy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to find conversion rate</span>
            <span class="n">conversion_pair</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quote_currency</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">conversion_pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pip_value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">[</span><span class="n">conversion_pair</span><span class="p">]</span>
            
            <span class="n">reverse_pair</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span><span class="si">}{</span><span class="n">quote_currency</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">reverse_pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pip_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">[</span><span class="n">reverse_pair</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">pip_value</span>  <span class="c1"># Default</span>
    
    <span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">risk_percent</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                               <span class="n">stop_loss_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate position size based on risk.&quot;&quot;&quot;</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">pip_value_per_lot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_pip_value</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        
        <span class="c1"># Position size in lots</span>
        <span class="n">position_lots</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="p">(</span><span class="n">stop_loss_pips</span> <span class="o">*</span> <span class="n">pip_value_per_lot</span><span class="p">)</span>
        
        <span class="c1"># Convert to units</span>
        <span class="n">position_units</span> <span class="o">=</span> <span class="n">position_lots</span> <span class="o">*</span> <span class="mi">100000</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;account_balance&#39;</span><span class="p">:</span> <span class="n">account_balance</span><span class="p">,</span>
            <span class="s1">&#39;risk_percent&#39;</span><span class="p">:</span> <span class="n">risk_percent</span><span class="p">,</span>
            <span class="s1">&#39;risk_amount&#39;</span><span class="p">:</span> <span class="n">risk_amount</span><span class="p">,</span>
            <span class="s1">&#39;stop_loss_pips&#39;</span><span class="p">:</span> <span class="n">stop_loss_pips</span><span class="p">,</span>
            <span class="s1">&#39;pip_value_per_lot&#39;</span><span class="p">:</span> <span class="n">pip_value_per_lot</span><span class="p">,</span>
            <span class="s1">&#39;position_lots&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">position_lots</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;position_units&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">position_units</span><span class="p">),</span>
            <span class="s1">&#39;mini_lots&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">position_lots</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;micro_lots&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">position_lots</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_risk_from_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">position_lots</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                    <span class="n">stop_loss_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate risk from an existing position.&quot;&quot;&quot;</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_pip_value</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">position_lots</span><span class="p">)</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">stop_loss_pips</span> <span class="o">*</span> <span class="n">pip_value</span>
        <span class="n">risk_percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">risk_amount</span> <span class="o">/</span> <span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;position_lots&#39;</span><span class="p">:</span> <span class="n">position_lots</span><span class="p">,</span>
            <span class="s1">&#39;stop_loss_pips&#39;</span><span class="p">:</span> <span class="n">stop_loss_pips</span><span class="p">,</span>
            <span class="s1">&#39;risk_amount&#39;</span><span class="p">:</span> <span class="n">risk_amount</span><span class="p">,</span>
            <span class="s1">&#39;risk_percent&#39;</span><span class="p">:</span> <span class="n">risk_percent</span><span class="p">,</span>
            <span class="s1">&#39;acceptable&#39;</span><span class="p">:</span> <span class="n">risk_percent</span> <span class="o">&lt;=</span> <span class="mf">2.0</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">forex_risk</span> <span class="o">=</span> <span class="n">ForexRiskCalculator</span><span class="p">(</span><span class="n">account_currency</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="n">forex_risk</span><span class="o">.</span><span class="n">set_exchange_rate</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="mf">150.50</span><span class="p">)</span>
<span class="n">forex_risk</span><span class="o">.</span><span class="n">set_exchange_rate</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pip Values (per standard lot):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  EURUSD: $</span><span class="si">{</span><span class="n">forex_risk</span><span class="o">.</span><span class="n">calculate_pip_value</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  USDJPY: $</span><span class="si">{</span><span class="n">forex_risk</span><span class="o">.</span><span class="n">calculate_pip_value</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Position Sizing (1</span><span class="si">% r</span><span class="s2">isk, 30 pip stop):&quot;</span><span class="p">)</span>
<span class="n">sizing</span> <span class="o">=</span> <span class="n">forex_risk</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span>
    <span class="n">account_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">risk_percent</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">stop_loss_pips</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">pair</span><span class="o">=</span><span class="s1">&#39;EURUSD&#39;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Risk Amount: $</span><span class="si">{</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;risk_amount&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Position Size: </span><span class="si">{</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;position_lots&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> lots (</span><span class="si">{</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;position_units&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> units)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">StopLossCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate stop loss levels using various methods.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set OHLC data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">high</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">close</span><span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">fixed_pip_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                       <span class="n">stop_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pip_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate fixed pip-based stop loss.&quot;&quot;&quot;</span>
        <span class="n">stop_distance</span> <span class="o">=</span> <span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_size</span>
        
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entry</span> <span class="o">-</span> <span class="n">stop_distance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entry</span> <span class="o">+</span> <span class="n">stop_distance</span>
    
    <span class="k">def</span> <span class="nf">calculate_atr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Average True Range.&quot;&quot;&quot;</span>
        <span class="n">high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span>
        <span class="n">low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span>
        <span class="n">close</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        
        <span class="n">tr1</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
        <span class="n">tr2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">tr3</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">tr3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">atr_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">atr_multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">atr_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate ATR-based stop loss.&quot;&quot;&quot;</span>
        <span class="n">atr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_atr</span><span class="p">(</span><span class="n">atr_period</span><span class="p">)</span>
        <span class="n">current_atr</span> <span class="o">=</span> <span class="n">atr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">stop_distance</span> <span class="o">=</span> <span class="n">current_atr</span> <span class="o">*</span> <span class="n">atr_multiplier</span>
        
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">stop_price</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">-</span> <span class="n">stop_distance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop_price</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">+</span> <span class="n">stop_distance</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;stop_price&#39;</span><span class="p">:</span> <span class="n">stop_price</span><span class="p">,</span>
            <span class="s1">&#39;atr&#39;</span><span class="p">:</span> <span class="n">current_atr</span><span class="p">,</span>
            <span class="s1">&#39;stop_distance&#39;</span><span class="p">:</span> <span class="n">stop_distance</span><span class="p">,</span>
            <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="n">atr_multiplier</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">swing_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate stop based on recent swing high/low.&quot;&quot;&quot;</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">lookback</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">swing_low</span> <span class="o">=</span> <span class="n">recent</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">swing_idx</span> <span class="o">=</span> <span class="n">recent</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
            <span class="n">stop_price</span> <span class="o">=</span> <span class="n">swing_low</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">swing_high</span> <span class="o">=</span> <span class="n">recent</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">swing_idx</span> <span class="o">=</span> <span class="n">recent</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
            <span class="n">stop_price</span> <span class="o">=</span> <span class="n">swing_high</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;stop_price&#39;</span><span class="p">:</span> <span class="n">stop_price</span><span class="p">,</span>
            <span class="s1">&#39;swing_date&#39;</span><span class="p">:</span> <span class="n">swing_idx</span><span class="p">,</span>
            <span class="s1">&#39;lookback&#39;</span><span class="p">:</span> <span class="n">lookback</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">trailing_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">trail_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">current_stop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">pip_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate trailing stop level.&quot;&quot;&quot;</span>
        <span class="n">trail_distance</span> <span class="o">=</span> <span class="n">trail_pips</span> <span class="o">*</span> <span class="n">pip_size</span>
        
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">new_stop</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">-</span> <span class="n">trail_distance</span>
            <span class="k">if</span> <span class="n">current_stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_stop</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">new_stop</span><span class="p">,</span> <span class="n">current_stop</span><span class="p">)</span>
            <span class="n">triggered</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">new_stop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_stop</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">+</span> <span class="n">trail_distance</span>
            <span class="k">if</span> <span class="n">current_stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_stop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_stop</span><span class="p">,</span> <span class="n">current_stop</span><span class="p">)</span>
            <span class="n">triggered</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">&gt;=</span> <span class="n">new_stop</span>
        
        <span class="n">profit_pips</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_size</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;stop_price&#39;</span><span class="p">:</span> <span class="n">new_stop</span><span class="p">,</span>
            <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">current_price</span><span class="p">,</span>
            <span class="s1">&#39;profit_pips&#39;</span><span class="p">:</span> <span class="n">profit_pips</span><span class="p">,</span>
            <span class="s1">&#39;triggered&#39;</span><span class="p">:</span> <span class="n">triggered</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">close</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.0800</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0002</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mi">60</span><span class="p">)),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">high</span> <span class="o">=</span> <span class="n">close</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.003</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">low</span> <span class="o">=</span> <span class="n">close</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.003</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

<span class="n">stop_calc</span> <span class="o">=</span> <span class="n">StopLossCalculator</span><span class="p">()</span>
<span class="n">stop_calc</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>

<span class="n">entry</span> <span class="o">=</span> <span class="mf">1.0900</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entry Price: </span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fixed 30-pip stop (long): </span><span class="si">{</span><span class="n">stop_calc</span><span class="o">.</span><span class="n">fixed_pip_stop</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ATR Stop (2x): </span><span class="si">{</span><span class="n">stop_calc</span><span class="o">.</span><span class="n">atr_stop</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Swing Stop: </span><span class="si">{</span><span class="n">stop_calc</span><span class="o">.</span><span class="n">swing_stop</span><span class="p">(</span><span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>9.2 Futures Risk Management</h2>
<p>Futures risk is calculated based on tick values, contract specifications, and notional exposure.</p></div>
<div class="md-cell"><h3>Common Futures Contract Specifications</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Contract</th>
<th>Symbol</th>
<th>Tick Size</th>
<th>Tick Value</th>
<th>Margin</th>
</tr>
</thead>
<tbody>
<tr>
<td>E-mini S&amp;P 500</td>
<td>ES</td>
<td>0.25</td>
<td>$12.50</td>
<td>~$13,200</td>
</tr>
<tr>
<td>E-mini Nasdaq</td>
<td>NQ</td>
<td>0.25</td>
<td>$5.00</td>
<td>~$17,600</td>
</tr>
<tr>
<td>Crude Oil</td>
<td>CL</td>
<td>0.01</td>
<td>$10.00</td>
<td>~$6,500</td>
</tr>
<tr>
<td>Gold</td>
<td>GC</td>
<td>0.10</td>
<td>$10.00</td>
<td>~$9,000</td>
</tr>
<tr>
<td>Euro FX</td>
<td>6E</td>
<td>0.0001</td>
<td>$12.50</td>
<td>~$2,500</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FuturesContract</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Futures contract specifications.&quot;&quot;&quot;</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tick_size</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">tick_value</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">contract_size</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">initial_margin</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">maintenance_margin</span><span class="p">:</span> <span class="nb">float</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">point_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Value of 1 full point move.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span>


<span class="k">class</span> <span class="nc">FuturesRiskCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate futures position risk and sizing.&quot;&quot;&quot;</span>
    
    <span class="c1"># Standard contract specs</span>
    <span class="n">CONTRACTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ES&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="s1">&#39;E-mini S&amp;P 500&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">12.50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">13200</span><span class="p">,</span> <span class="mi">12000</span><span class="p">),</span>
        <span class="s1">&#39;NQ&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span><span class="s1">&#39;NQ&#39;</span><span class="p">,</span> <span class="s1">&#39;E-mini Nasdaq&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">5.00</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">17600</span><span class="p">,</span> <span class="mi">16000</span><span class="p">),</span>
        <span class="s1">&#39;CL&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span><span class="s1">&#39;CL&#39;</span><span class="p">,</span> <span class="s1">&#39;Crude Oil&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">10.00</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">6500</span><span class="p">,</span> <span class="mi">5900</span><span class="p">),</span>
        <span class="s1">&#39;GC&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span><span class="s1">&#39;GC&#39;</span><span class="p">,</span> <span class="s1">&#39;Gold&#39;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">10.00</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span> <span class="mi">8200</span><span class="p">),</span>
        <span class="s1">&#39;6E&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span><span class="s1">&#39;6E&#39;</span><span class="p">,</span> <span class="s1">&#39;Euro FX&#39;</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">12.50</span><span class="p">,</span> <span class="mi">125000</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="mi">2275</span><span class="p">),</span>
        <span class="s1">&#39;ZB&#39;</span><span class="p">:</span> <span class="n">FuturesContract</span><span class="p">(</span><span class="s1">&#39;ZB&#39;</span><span class="p">,</span> <span class="s1">&#39;T-Bond&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">32</span><span class="p">,</span> <span class="mf">31.25</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">4400</span><span class="p">,</span> <span class="mi">4000</span><span class="p">),</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">get_contract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FuturesContract</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get contract specifications.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTRACTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_tick_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stop_ticks</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                           <span class="n">num_contracts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate risk based on tick distance.&quot;&quot;&quot;</span>
        <span class="n">contract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_contract</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contract</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unknown contract: </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
        
        <span class="n">risk_per_contract</span> <span class="o">=</span> <span class="n">stop_ticks</span> <span class="o">*</span> <span class="n">contract</span><span class="o">.</span><span class="n">tick_value</span>
        <span class="n">total_risk</span> <span class="o">=</span> <span class="n">risk_per_contract</span> <span class="o">*</span> <span class="n">num_contracts</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;contracts&#39;</span><span class="p">:</span> <span class="n">num_contracts</span><span class="p">,</span>
            <span class="s1">&#39;stop_ticks&#39;</span><span class="p">:</span> <span class="n">stop_ticks</span><span class="p">,</span>
            <span class="s1">&#39;risk_per_contract&#39;</span><span class="p">:</span> <span class="n">risk_per_contract</span><span class="p">,</span>
            <span class="s1">&#39;total_risk&#39;</span><span class="p">:</span> <span class="n">total_risk</span><span class="p">,</span>
            <span class="s1">&#39;tick_value&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">tick_value</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_point_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">num_contracts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate risk based on price levels.&quot;&quot;&quot;</span>
        <span class="n">contract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_contract</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contract</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unknown contract: </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
        
        <span class="n">point_distance</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">entry</span> <span class="o">-</span> <span class="n">stop</span><span class="p">)</span>
        <span class="n">tick_distance</span> <span class="o">=</span> <span class="n">point_distance</span> <span class="o">/</span> <span class="n">contract</span><span class="o">.</span><span class="n">tick_size</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tick_risk</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">tick_distance</span><span class="p">,</span> <span class="n">num_contracts</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                               <span class="n">risk_percent</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop_ticks</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate position size based on risk.&quot;&quot;&quot;</span>
        <span class="n">contract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_contract</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contract</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Unknown contract: </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
        
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">risk_per_contract</span> <span class="o">=</span> <span class="n">stop_ticks</span> <span class="o">*</span> <span class="n">contract</span><span class="o">.</span><span class="n">tick_value</span>
        
        <span class="n">max_contracts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">risk_amount</span> <span class="o">/</span> <span class="n">risk_per_contract</span><span class="p">)</span>
        
        <span class="c1"># Check margin requirements</span>
        <span class="n">margin_required</span> <span class="o">=</span> <span class="n">max_contracts</span> <span class="o">*</span> <span class="n">contract</span><span class="o">.</span><span class="n">initial_margin</span>
        <span class="n">margin_limited</span> <span class="o">=</span> <span class="n">margin_required</span> <span class="o">&gt;</span> <span class="n">account_balance</span> <span class="o">*</span> <span class="mf">0.5</span>  <span class="c1"># Use max 50% for margin</span>
        
        <span class="k">if</span> <span class="n">margin_limited</span><span class="p">:</span>
            <span class="n">margin_contracts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">account_balance</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">contract</span><span class="o">.</span><span class="n">initial_margin</span><span class="p">)</span>
            <span class="n">max_contracts</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_contracts</span><span class="p">,</span> <span class="n">margin_contracts</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;account_balance&#39;</span><span class="p">:</span> <span class="n">account_balance</span><span class="p">,</span>
            <span class="s1">&#39;risk_percent&#39;</span><span class="p">:</span> <span class="n">risk_percent</span><span class="p">,</span>
            <span class="s1">&#39;risk_amount&#39;</span><span class="p">:</span> <span class="n">risk_amount</span><span class="p">,</span>
            <span class="s1">&#39;stop_ticks&#39;</span><span class="p">:</span> <span class="n">stop_ticks</span><span class="p">,</span>
            <span class="s1">&#39;risk_per_contract&#39;</span><span class="p">:</span> <span class="n">risk_per_contract</span><span class="p">,</span>
            <span class="s1">&#39;max_contracts&#39;</span><span class="p">:</span> <span class="n">max_contracts</span><span class="p">,</span>
            <span class="s1">&#39;margin_required&#39;</span><span class="p">:</span> <span class="n">max_contracts</span> <span class="o">*</span> <span class="n">contract</span><span class="o">.</span><span class="n">initial_margin</span><span class="p">,</span>
            <span class="s1">&#39;margin_limited&#39;</span><span class="p">:</span> <span class="n">margin_limited</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_notional_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                <span class="n">num_contracts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate notional value of position.&quot;&quot;&quot;</span>
        <span class="n">contract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_contract</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contract</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="k">return</span> <span class="n">price</span> <span class="o">*</span> <span class="n">contract</span><span class="o">.</span><span class="n">contract_size</span> <span class="o">*</span> <span class="n">num_contracts</span>
    
    <span class="k">def</span> <span class="nf">calculate_leverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                          <span class="n">num_contracts</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate effective leverage.&quot;&quot;&quot;</span>
        <span class="n">notional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_notional_value</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">num_contracts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">notional</span> <span class="o">/</span> <span class="n">account_balance</span> <span class="k">if</span> <span class="n">account_balance</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

<span class="c1"># Demo</span>
<span class="n">futures_risk</span> <span class="o">=</span> <span class="n">FuturesRiskCalculator</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Futures Risk Calculations:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ES (E-mini S&amp;P 500):&quot;</span><span class="p">)</span>
<span class="n">es_risk</span> <span class="o">=</span> <span class="n">futures_risk</span><span class="o">.</span><span class="n">calculate_tick_risk</span><span class="p">(</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="n">stop_ticks</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">num_contracts</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  40 tick stop with 2 contracts: $</span><span class="si">{</span><span class="n">es_risk</span><span class="p">[</span><span class="s1">&#39;total_risk&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> risk&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Position Sizing (1</span><span class="si">% r</span><span class="s2">isk, 20 tick stop):&quot;</span><span class="p">)</span>
<span class="n">sizing</span> <span class="o">=</span> <span class="n">futures_risk</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="n">account_balance</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> 
                                              <span class="n">risk_percent</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">stop_ticks</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Contracts: </span><span class="si">{</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;max_contracts&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Margin Required: $</span><span class="si">{</span><span class="n">sizing</span><span class="p">[</span><span class="s1">&#39;margin_required&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Notional &amp; Leverage:&quot;</span><span class="p">)</span>
<span class="n">notional</span> <span class="o">=</span> <span class="n">futures_risk</span><span class="o">.</span><span class="n">calculate_notional_value</span><span class="p">(</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">leverage</span> <span class="o">=</span> <span class="n">futures_risk</span><span class="o">.</span><span class="n">calculate_leverage</span><span class="p">(</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">50000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Notional Value (2 ES @ 5000): $</span><span class="si">{</span><span class="n">notional</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Effective Leverage: </span><span class="si">{</span><span class="n">leverage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>9.3 Portfolio Risk</h2>
<p>Managing portfolio-level risk requires understanding currency exposure, correlations, and hedging strategies.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CurrencyExposureCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate and manage currency exposure across portfolio.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_currency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_currency</span> <span class="o">=</span> <span class="n">base_currency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                    <span class="n">units</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a forex position.&quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">quote</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        
        <span class="c1"># Calculate exposure</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">base_exposure</span> <span class="o">=</span> <span class="n">units</span>
            <span class="n">quote_exposure</span> <span class="o">=</span> <span class="o">-</span><span class="n">units</span> <span class="o">*</span> <span class="n">entry_price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_exposure</span> <span class="o">=</span> <span class="o">-</span><span class="n">units</span>
            <span class="n">quote_exposure</span> <span class="o">=</span> <span class="n">units</span> <span class="o">*</span> <span class="n">entry_price</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;base_currency&#39;</span><span class="p">:</span> <span class="n">base</span><span class="p">,</span>
            <span class="s1">&#39;quote_currency&#39;</span><span class="p">:</span> <span class="n">quote</span><span class="p">,</span>
            <span class="s1">&#39;base_exposure&#39;</span><span class="p">:</span> <span class="n">base_exposure</span><span class="p">,</span>
            <span class="s1">&#39;quote_exposure&#39;</span><span class="p">:</span> <span class="n">quote_exposure</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_net_exposure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate net exposure by currency.&quot;&quot;&quot;</span>
        <span class="n">exposure</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;base_currency&#39;</span><span class="p">]</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;quote_currency&#39;</span><span class="p">]</span>
            
            <span class="n">exposure</span><span class="p">[</span><span class="n">base</span><span class="p">]</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;base_exposure&#39;</span><span class="p">]</span>
            <span class="n">exposure</span><span class="p">[</span><span class="n">quote</span><span class="p">]</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;quote_exposure&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">exposure</span>
    
    <span class="k">def</span> <span class="nf">check_concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_single_currency_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for currency concentration risk.&quot;&quot;&quot;</span>
        <span class="n">exposure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_exposure</span><span class="p">()</span>
        <span class="n">total_exposure</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">exposure</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        
        <span class="k">if</span> <span class="n">total_exposure</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;concentrated&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        
        <span class="n">concentration</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">exposure</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pct</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_exposure</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">concentration</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">pct</span>
            
            <span class="k">if</span> <span class="n">pct</span> <span class="o">&gt;</span> <span class="n">max_single_currency_pct</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% (max </span><span class="si">{</span><span class="n">max_single_currency_pct</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;concentrated&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="n">warnings</span><span class="p">,</span>
            <span class="s1">&#39;concentration&#39;</span><span class="p">:</span> <span class="n">concentration</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">suggest_hedge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hedge_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Suggest hedge for a currency exposure.&quot;&quot;&quot;</span>
        <span class="n">exposure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_net_exposure</span><span class="p">()</span>
        <span class="n">current_exposure</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">current_exposure</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;hedge_needed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        
        <span class="n">hedge_amount</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_exposure</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">hedge_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># Determine hedge direction</span>
        <span class="k">if</span> <span class="n">current_exposure</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hedge_direction</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hedge_direction</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
        
        <span class="c1"># Suggest hedge pair (vs USD)</span>
        <span class="k">if</span> <span class="n">currency</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_currency</span><span class="p">:</span>
            <span class="n">hedge_pair</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">currency</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_currency</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hedge_pair</span> <span class="o">=</span> <span class="s1">&#39;N/A (base currency)&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;hedge_needed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;current_exposure&#39;</span><span class="p">:</span> <span class="n">current_exposure</span><span class="p">,</span>
            <span class="s1">&#39;hedge_pair&#39;</span><span class="p">:</span> <span class="n">hedge_pair</span><span class="p">,</span>
            <span class="s1">&#39;hedge_direction&#39;</span><span class="p">:</span> <span class="n">hedge_direction</span><span class="p">,</span>
            <span class="s1">&#39;hedge_amount&#39;</span><span class="p">:</span> <span class="n">hedge_amount</span><span class="p">,</span>
            <span class="s1">&#39;remaining_exposure&#39;</span><span class="p">:</span> <span class="n">current_exposure</span> <span class="o">-</span> <span class="p">(</span><span class="n">hedge_amount</span> <span class="k">if</span> <span class="n">current_exposure</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">hedge_amount</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">exposure_calc</span> <span class="o">=</span> <span class="n">CurrencyExposureCalculator</span><span class="p">()</span>

<span class="c1"># Add positions</span>
<span class="n">exposure_calc</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">)</span>
<span class="n">exposure_calc</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="mf">1.2650</span><span class="p">)</span>
<span class="n">exposure_calc</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mf">150.50</span><span class="p">)</span>
<span class="n">exposure_calc</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;EURJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="mf">163.30</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Net Currency Exposure:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">curr</span><span class="p">,</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">exposure_calc</span><span class="o">.</span><span class="n">get_net_exposure</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">curr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exp</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Concentration Check:&quot;</span><span class="p">)</span>
<span class="n">conc</span> <span class="o">=</span> <span class="n">exposure_calc</span><span class="o">.</span><span class="n">check_concentration</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Concentrated: </span><span class="si">{</span><span class="n">conc</span><span class="p">[</span><span class="s1">&#39;concentrated&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">conc</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">conc</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Warning: </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Hedge Suggestion for EUR:&quot;</span><span class="p">)</span>
<span class="n">hedge</span> <span class="o">=</span> <span class="n">exposure_calc</span><span class="o">.</span><span class="n">suggest_hedge</span><span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">hedge</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CorrelationRiskManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage risk from correlated positions.&quot;&quot;&quot;</span>
    
    <span class="c1"># Known high correlations between pairs</span>
    <span class="n">KNOWN_CORRELATIONS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">):</span> <span class="mf">0.85</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;AUDUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZDUSD&#39;</span><span class="p">):</span> <span class="mf">0.90</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;USDCHF&#39;</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.90</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;EURJPY&#39;</span><span class="p">):</span> <span class="mf">0.75</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;AUDUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;USDCAD&#39;</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.70</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">risk_amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add position with its risk.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="n">risk_amount</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">add_price_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add price data for correlation calculation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">get_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pair2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get correlation between two pairs.&quot;&quot;&quot;</span>
        <span class="c1"># Check known correlations</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair1</span><span class="p">,</span> <span class="n">pair2</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">pair1</span><span class="p">,</span> <span class="n">pair2</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">KNOWN_CORRELATIONS</span> <span class="k">else</span> <span class="p">(</span><span class="n">pair2</span><span class="p">,</span> <span class="n">pair1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">KNOWN_CORRELATIONS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">KNOWN_CORRELATIONS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="c1"># Calculate from price data</span>
        <span class="k">if</span> <span class="n">pair1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span> <span class="ow">and</span> <span class="n">pair2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">:</span>
            <span class="n">ret1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="n">pair1</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
            <span class="n">ret2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_data</span><span class="p">[</span><span class="n">pair2</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ret1</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">ret2</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="mf">0.0</span>
    
    <span class="k">def</span> <span class="nf">calculate_correlated_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate portfolio risk considering correlations.&quot;&quot;&quot;</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total_risk&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;correlated_risk&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        
        <span class="c1"># Simple risk (sum of individual risks)</span>
        <span class="n">simple_risk</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;risk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        
        <span class="c1"># Correlated risk (using correlation adjustment)</span>
        <span class="c1"># For same direction positions with high correlation: risk increases</span>
        <span class="c1"># For opposite direction positions with high correlation: risk decreases (hedge)</span>
        
        <span class="n">correlated_risk_squared</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">correlation_adjustments</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pair1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
            <span class="n">pos1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">pair1</span><span class="p">]</span>
            <span class="n">risk1</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">[</span><span class="s1">&#39;risk&#39;</span><span class="p">]</span>
            <span class="n">dir1</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pos1</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            
            <span class="n">correlated_risk_squared</span> <span class="o">+=</span> <span class="n">risk1</span> <span class="o">**</span> <span class="mi">2</span>
            
            <span class="k">for</span> <span class="n">pair2</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">pos2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">pair2</span><span class="p">]</span>
                <span class="n">risk2</span> <span class="o">=</span> <span class="n">pos2</span><span class="p">[</span><span class="s1">&#39;risk&#39;</span><span class="p">]</span>
                <span class="n">dir2</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pos2</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                
                <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_correlation</span><span class="p">(</span><span class="n">pair1</span><span class="p">,</span> <span class="n">pair2</span><span class="p">)</span>
                
                <span class="c1"># Adjust for direction</span>
                <span class="n">effective_corr</span> <span class="o">=</span> <span class="n">corr</span> <span class="o">*</span> <span class="n">dir1</span> <span class="o">*</span> <span class="n">dir2</span>
                
                <span class="c1"># Add correlation contribution</span>
                <span class="n">correlated_risk_squared</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">risk1</span> <span class="o">*</span> <span class="n">risk2</span> <span class="o">*</span> <span class="n">effective_corr</span>
                
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>
                    <span class="n">correlation_adjustments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;pair1&#39;</span><span class="p">:</span> <span class="n">pair1</span><span class="p">,</span>
                        <span class="s1">&#39;pair2&#39;</span><span class="p">:</span> <span class="n">pair2</span><span class="p">,</span>
                        <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">corr</span><span class="p">,</span>
                        <span class="s1">&#39;effective_correlation&#39;</span><span class="p">:</span> <span class="n">effective_corr</span><span class="p">,</span>
                        <span class="s1">&#39;impact&#39;</span><span class="p">:</span> <span class="s1">&#39;adds_risk&#39;</span> <span class="k">if</span> <span class="n">effective_corr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;hedges&#39;</span>
                    <span class="p">})</span>
        
        <span class="n">correlated_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">correlated_risk_squared</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;simple_risk&#39;</span><span class="p">:</span> <span class="n">simple_risk</span><span class="p">,</span>
            <span class="s1">&#39;correlated_risk&#39;</span><span class="p">:</span> <span class="n">correlated_risk</span><span class="p">,</span>
            <span class="s1">&#39;diversification_benefit&#39;</span><span class="p">:</span> <span class="n">simple_risk</span> <span class="o">-</span> <span class="n">correlated_risk</span><span class="p">,</span>
            <span class="s1">&#39;correlation_adjustments&#39;</span><span class="p">:</span> <span class="n">correlation_adjustments</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">corr_manager</span> <span class="o">=</span> <span class="n">CorrelationRiskManager</span><span class="p">()</span>

<span class="c1"># Add positions (same direction on correlated pairs = more risk)</span>
<span class="n">corr_manager</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">corr_manager</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>  <span class="c1"># High correlation with EUR</span>
<span class="n">corr_manager</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;USDCHF&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>  <span class="c1"># Negative correlation (hedge)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation Risk Analysis:&quot;</span><span class="p">)</span>
<span class="n">risk</span> <span class="o">=</span> <span class="n">corr_manager</span><span class="o">.</span><span class="n">calculate_correlated_risk</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Simple Risk (sum): $</span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;simple_risk&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Correlated Risk: $</span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;correlated_risk&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Diversification Benefit: $</span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;diversification_benefit&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Correlation Impacts:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">adj</span> <span class="ow">in</span> <span class="n">risk</span><span class="p">[</span><span class="s1">&#39;correlation_adjustments&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">adj</span><span class="p">[</span><span class="s1">&#39;pair1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">adj</span><span class="p">[</span><span class="s1">&#39;pair2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">adj</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">adj</span><span class="p">[</span><span class="s1">&#39;impact&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>9.4 Weekend &amp; Gap Risk</h2>
<p>Forex markets close on weekends, creating gap risk that must be managed.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">GapRiskManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage weekend and holiday gap risk.&quot;&quot;&quot;</span>
    
    <span class="c1"># Historical average gap sizes (pips)</span>
    <span class="n">TYPICAL_GAP_SIZES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s1">&#39;USDJPY&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="s1">&#39;AUDUSD&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s1">&#39;USDCAD&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="c1"># Major events that increase gap risk</span>
    <span class="n">HIGH_RISK_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;G7_meeting&#39;</span><span class="p">,</span>
        <span class="s1">&#39;central_bank_emergency&#39;</span><span class="p">,</span>
        <span class="s1">&#39;geopolitical_crisis&#39;</span><span class="p">,</span>
        <span class="s1">&#39;election&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upcoming_events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                    <span class="n">units</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">current_pnl_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add position for gap risk analysis.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
            <span class="s1">&#39;current_pnl_pips&#39;</span><span class="p">:</span> <span class="n">current_pnl_pips</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">set_upcoming_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set upcoming high-impact events.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upcoming_events</span> <span class="o">=</span> <span class="n">events</span>
    
    <span class="k">def</span> <span class="nf">calculate_gap_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate potential gap risk for all positions.&quot;&quot;&quot;</span>
        <span class="n">total_gap_risk</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">position_risks</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Multiplier for high-risk events</span>
        <span class="n">event_multiplier</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">HIGH_RISK_EVENTS</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upcoming_events</span><span class="p">):</span>
            <span class="n">event_multiplier</span> <span class="o">=</span> <span class="mf">2.0</span>
        
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="n">typical_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TYPICAL_GAP_SIZES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">],</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">worst_case_gap</span> <span class="o">=</span> <span class="n">typical_gap</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">event_multiplier</span>
            
            <span class="c1"># Calculate potential loss from adverse gap</span>
            <span class="n">pip_value</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Assuming standard lot pip value</span>
            <span class="n">lots</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100000</span>
            <span class="n">potential_loss</span> <span class="o">=</span> <span class="n">worst_case_gap</span> <span class="o">*</span> <span class="n">pip_value</span> <span class="o">*</span> <span class="n">lots</span>
            
            <span class="n">position_risks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">],</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">],</span>
                <span class="s1">&#39;typical_gap&#39;</span><span class="p">:</span> <span class="n">typical_gap</span><span class="p">,</span>
                <span class="s1">&#39;worst_case_gap&#39;</span><span class="p">:</span> <span class="n">worst_case_gap</span><span class="p">,</span>
                <span class="s1">&#39;potential_loss&#39;</span><span class="p">:</span> <span class="n">potential_loss</span><span class="p">,</span>
                <span class="s1">&#39;current_pnl_pips&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;current_pnl_pips&#39;</span><span class="p">]</span>
            <span class="p">})</span>
            
            <span class="n">total_gap_risk</span> <span class="o">+=</span> <span class="n">potential_loss</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_gap_risk&#39;</span><span class="p">:</span> <span class="n">total_gap_risk</span><span class="p">,</span>
            <span class="s1">&#39;event_multiplier&#39;</span><span class="p">:</span> <span class="n">event_multiplier</span><span class="p">,</span>
            <span class="s1">&#39;high_risk_events&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">upcoming_events</span><span class="p">,</span>
            <span class="s1">&#39;position_risks&#39;</span><span class="p">:</span> <span class="n">position_risks</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_position_reduction_advice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                      <span class="n">max_gap_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Advise on position reduction before weekend.&quot;&quot;&quot;</span>
        <span class="n">gap_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_gap_risk</span><span class="p">()</span>
        <span class="n">current_risk_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">gap_risk</span><span class="p">[</span><span class="s1">&#39;total_gap_risk&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">if</span> <span class="n">current_risk_pct</span> <span class="o">&lt;=</span> <span class="n">max_gap_risk_pct</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;reduce_needed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;current_risk_pct&#39;</span><span class="p">:</span> <span class="n">current_risk_pct</span><span class="p">,</span>
                <span class="s1">&#39;max_allowed&#39;</span><span class="p">:</span> <span class="n">max_gap_risk_pct</span>
            <span class="p">}</span>
        
        <span class="c1"># Calculate reduction needed</span>
        <span class="n">reduction_factor</span> <span class="o">=</span> <span class="n">max_gap_risk_pct</span> <span class="o">/</span> <span class="n">current_risk_pct</span>
        
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pos_risk</span> <span class="ow">in</span> <span class="n">gap_risk</span><span class="p">[</span><span class="s1">&#39;position_risks&#39;</span><span class="p">]:</span>
            <span class="c1"># Prioritize reducing losing positions</span>
            <span class="k">if</span> <span class="n">pos_risk</span><span class="p">[</span><span class="s1">&#39;current_pnl_pips&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">priority</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span>
                <span class="n">suggested_reduction</span> <span class="o">=</span> <span class="mf">0.75</span>  <span class="c1"># Close 75%</span>
            <span class="k">elif</span> <span class="n">pos_risk</span><span class="p">[</span><span class="s1">&#39;current_pnl_pips&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">priority</span> <span class="o">=</span> <span class="s1">&#39;medium&#39;</span>
                <span class="n">suggested_reduction</span> <span class="o">=</span> <span class="mf">0.50</span>  <span class="c1"># Close 50%</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">priority</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span>
                <span class="n">suggested_reduction</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">reduction_factor</span>
            
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pos_risk</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">],</span>
                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                <span class="s1">&#39;suggested_reduction&#39;</span><span class="p">:</span> <span class="n">suggested_reduction</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;losing&#39;</span> <span class="k">if</span> <span class="n">pos_risk</span><span class="p">[</span><span class="s1">&#39;current_pnl_pips&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;gap_risk&#39;</span>
            <span class="p">})</span>
        
        <span class="c1"># Sort by priority</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">]])</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;reduce_needed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;current_risk_pct&#39;</span><span class="p">:</span> <span class="n">current_risk_pct</span><span class="p">,</span>
            <span class="s1">&#39;max_allowed&#39;</span><span class="p">:</span> <span class="n">max_gap_risk_pct</span><span class="p">,</span>
            <span class="s1">&#39;target_reduction&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">reduction_factor</span><span class="p">,</span>
            <span class="s1">&#39;recommendations&#39;</span><span class="p">:</span> <span class="n">recommendations</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">should_close_friday</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                           <span class="n">max_position_gap_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine if a position should be closed Friday.&quot;&quot;&quot;</span>
        <span class="n">typical_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TYPICAL_GAP_SIZES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">],</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">worst_case</span> <span class="o">=</span> <span class="n">typical_gap</span> <span class="o">*</span> <span class="mi">3</span>
        
        <span class="n">pip_value</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">lots</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100000</span>
        <span class="n">potential_loss</span> <span class="o">=</span> <span class="n">worst_case</span> <span class="o">*</span> <span class="n">pip_value</span> <span class="o">*</span> <span class="n">lots</span>
        
        <span class="n">risk_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">potential_loss</span> <span class="o">/</span> <span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Decision factors</span>
        <span class="n">close_reasons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">risk_pct</span> <span class="o">&gt;</span> <span class="n">max_position_gap_risk_pct</span><span class="p">:</span>
            <span class="n">close_reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;excessive_gap_risk&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_pnl_pips&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">20</span><span class="p">:</span>
            <span class="n">close_reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;losing_position&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upcoming_events</span><span class="p">:</span>
            <span class="n">close_reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;upcoming_events&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;should_close&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">close_reasons</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="n">risk_pct</span><span class="p">,</span>
            <span class="s1">&#39;reasons&#39;</span><span class="p">:</span> <span class="n">close_reasons</span><span class="p">,</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;close&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close_reasons</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;reduce&#39;</span> <span class="k">if</span> <span class="n">close_reasons</span> <span class="k">else</span> <span class="s1">&#39;hold&#39;</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">gap_manager</span> <span class="o">=</span> <span class="n">GapRiskManager</span><span class="p">()</span>

<span class="c1"># Add positions</span>
<span class="n">gap_manager</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">200000</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>  <span class="c1"># Winning</span>
<span class="n">gap_manager</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># Losing</span>
<span class="n">gap_manager</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span> <span class="mi">150000</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># Winning</span>

<span class="c1"># Set upcoming events</span>
<span class="n">gap_manager</span><span class="o">.</span><span class="n">set_upcoming_events</span><span class="p">([</span><span class="s1">&#39;G7_meeting&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gap Risk Analysis:&quot;</span><span class="p">)</span>
<span class="n">risk</span> <span class="o">=</span> <span class="n">gap_manager</span><span class="o">.</span><span class="n">calculate_gap_risk</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Gap Risk: $</span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;total_gap_risk&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Event Multiplier: </span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;event_multiplier&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Position Reduction Advice (50k account):&quot;</span><span class="p">)</span>
<span class="n">advice</span> <span class="o">=</span> <span class="n">gap_manager</span><span class="o">.</span><span class="n">get_position_reduction_advice</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="n">max_gap_risk_pct</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Reduce Needed: </span><span class="si">{</span><span class="n">advice</span><span class="p">[</span><span class="s1">&#39;reduce_needed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Current Risk: </span><span class="si">{</span><span class="n">advice</span><span class="p">[</span><span class="s1">&#39;current_risk_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">advice</span><span class="p">[</span><span class="s1">&#39;reduce_needed&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Recommendations:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">advice</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;priority&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> priority, reduce </span><span class="si">{</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;suggested_reduction&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2></div>
<div class="md-cell"><h3>Exercise 1: Forex Position Calculator (Guided)</h3>
<p>Complete the <code>ForexPositionCalculator</code> class for comprehensive position sizing.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ForexPositionCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete forex position calculator.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">account_currency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">=</span> <span class="n">account_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span> <span class="o">=</span> <span class="n">account_currency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">set_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set exchange rate.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
    
    <span class="k">def</span> <span class="nf">get_pip_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lot_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate pip value in account currency.&quot;&quot;&quot;</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="n">______</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">lot_size</span> <span class="o">*</span> <span class="mi">100000</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="n">pip_size</span> <span class="o">*</span> <span class="n">units</span>
        
        <span class="n">quote</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">quote</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pip_value</span>
        
        <span class="c1"># Convert to account currency</span>
        <span class="n">conversion_pair</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quote</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">conversion_pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pip_value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">[</span><span class="n">conversion_pair</span><span class="p">]</span>
        
        <span class="n">reverse</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span><span class="si">}{</span><span class="n">quote</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">reverse</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pip_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">[</span><span class="n">reverse</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">pip_value</span>
    
    <span class="k">def</span> <span class="nf">calculate_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                          <span class="n">stop_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate position size.&quot;&quot;&quot;</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_pct</span> <span class="o">/</span> <span class="n">______</span><span class="p">)</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pip_value</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        
        <span class="n">lots</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="p">(</span><span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;risk_amount&#39;</span><span class="p">:</span> <span class="n">risk_amount</span><span class="p">,</span>
            <span class="s1">&#39;lots&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">lots</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">lots</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">),</span>
            <span class="s1">&#39;pip_value&#39;</span><span class="p">:</span> <span class="n">pip_value</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">validate_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                         <span class="n">max_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                         <span class="n">stop_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate if position size is acceptable.&quot;&quot;&quot;</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pip_value</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">lots</span><span class="p">)</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_value</span>
        <span class="n">risk_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">risk</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="n">risk_pct</span> <span class="o">&lt;=</span> <span class="n">______</span><span class="p">,</span>
            <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="n">risk_pct</span><span class="p">,</span>
            <span class="s1">&#39;max_allowed&#39;</span><span class="p">:</span> <span class="n">max_risk_pct</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">calc</span> <span class="o">=</span> <span class="n">ForexPositionCalculator</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">)</span>
<span class="n">calc</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">)</span>
<span class="n">calc</span><span class="o">.</span><span class="n">set_rate</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="mf">150.50</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position for 1% risk, 25 pip stop: </span><span class="si">{</span><span class="n">calc</span><span class="o">.</span><span class="n">calculate_position</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation: </span><span class="si">{</span><span class="n">calc</span><span class="o">.</span><span class="n">validate_position</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ForexPositionCalculator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">account_currency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">=</span> <span class="n">account_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span> <span class="o">=</span> <span class="n">account_currency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">set_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange_rates</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>

    <span class="k">def</span> <span class="nf">get_pip_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lot_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">in</span> <span class="n">pair</span> <span class="k">else</span> <span class="mf">0.0001</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">lot_size</span> <span class="o">*</span> <span class="mi">100000</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="n">pip_size</span> <span class="o">*</span> <span class="n">units</span>
        <span class="c1"># ... conversion logic</span>
        <span class="k">return</span> <span class="n">pip_value</span>

    <span class="k">def</span> <span class="nf">calculate_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pip_value</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">lots</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="p">(</span><span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span> <span class="s1">&#39;risk_amount&#39;</span><span class="p">:</span> <span class="n">risk_amount</span><span class="p">,</span> <span class="s1">&#39;lots&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">lots</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">...</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">max_risk_pct</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">stop_pips</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="c1"># ...</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="n">risk_pct</span> <span class="o">&lt;=</span> <span class="n">max_risk_pct</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 2: Futures Margin Monitor (Guided)</h3>
<p>Complete the <code>MarginMonitor</code> class for tracking futures margin.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MarginMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor futures margin levels.&quot;&quot;&quot;</span>
    
    <span class="n">CONTRACTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ES&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;initial&#39;</span><span class="p">:</span> <span class="mi">13200</span><span class="p">,</span> <span class="s1">&#39;maintenance&#39;</span><span class="p">:</span> <span class="mi">12000</span><span class="p">},</span>
        <span class="s1">&#39;NQ&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;initial&#39;</span><span class="p">:</span> <span class="mi">17600</span><span class="p">,</span> <span class="s1">&#39;maintenance&#39;</span><span class="p">:</span> <span class="mi">16000</span><span class="p">},</span>
        <span class="s1">&#39;CL&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;initial&#39;</span><span class="p">:</span> <span class="mi">6500</span><span class="p">,</span> <span class="s1">&#39;maintenance&#39;</span><span class="p">:</span> <span class="mi">5900</span><span class="p">},</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">=</span> <span class="n">account_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># symbol -&gt; contracts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unrealized_pnl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">contracts</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add or update position.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">contracts</span>
    
    <span class="k">def</span> <span class="nf">set_unrealized_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pnl</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set current unrealized P&amp;L.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unrealized_pnl</span> <span class="o">=</span> <span class="n">pnl</span>
    
    <span class="k">def</span> <span class="nf">get_margin_required</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total margin required.&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">contracts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">______</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTRACTS</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">contracts</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTRACTS</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">total</span>
    
    <span class="k">def</span> <span class="nf">get_maintenance_margin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate maintenance margin.&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">contracts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTRACTS</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">contracts</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTRACTS</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;______&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">total</span>
    
    <span class="k">def</span> <span class="nf">get_margin_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current margin status.&quot;&quot;&quot;</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">unrealized_pnl</span>
        <span class="n">margin_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_margin_required</span><span class="p">()</span>
        <span class="n">maintenance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_maintenance_margin</span><span class="p">()</span>
        
        <span class="n">margin_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">/</span> <span class="n">margin_used</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">margin_used</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">100</span>
        
        <span class="k">if</span> <span class="n">margin_level</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;healthy&#39;</span>
        <span class="k">elif</span> <span class="n">margin_level</span> <span class="o">&gt;</span> <span class="n">______</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;warning&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;margin_call&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="n">equity</span><span class="p">,</span>
            <span class="s1">&#39;margin_used&#39;</span><span class="p">:</span> <span class="n">margin_used</span><span class="p">,</span>
            <span class="s1">&#39;margin_level&#39;</span><span class="p">:</span> <span class="n">margin_level</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s1">&#39;distance_to_call&#39;</span><span class="p">:</span> <span class="n">equity</span> <span class="o">-</span> <span class="n">maintenance</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">monitor</span> <span class="o">=</span> <span class="n">MarginMonitor</span><span class="p">(</span><span class="mi">50000</span><span class="p">)</span>
<span class="n">monitor</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">monitor</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;CL&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">monitor</span><span class="o">.</span><span class="n">set_unrealized_pnl</span><span class="p">(</span><span class="o">-</span><span class="mi">2000</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Margin Status: </span><span class="si">{</span><span class="n">monitor</span><span class="o">.</span><span class="n">get_margin_status</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MarginMonitor</span><span class="p">:</span>
    <span class="c1"># ... CONTRACTS dict ...</span>

    <span class="k">def</span> <span class="nf">get_margin_required</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">contracts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTRACTS</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">contracts</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTRACTS</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">total</span>

    <span class="k">def</span> <span class="nf">get_maintenance_margin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">contracts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTRACTS</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">contracts</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONTRACTS</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;maintenance&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">total</span>

    <span class="k">def</span> <span class="nf">get_margin_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="c1"># ...</span>
        <span class="k">if</span> <span class="n">margin_level</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;healthy&#39;</span>
        <span class="k">elif</span> <span class="n">margin_level</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;warning&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;margin_call&#39;</span>
        <span class="c1"># ...</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 3: Weekend Risk Advisor (Guided)</h3>
<p>Complete the <code>WeekendRiskAdvisor</code> class for Friday position management.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">WeekendRiskAdvisor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Advise on positions before weekend.&quot;&quot;&quot;</span>
    
    <span class="n">AVG_GAPS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;USDJPY&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_weekend_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">=</span> <span class="n">account_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk</span> <span class="o">=</span> <span class="n">max_weekend_risk_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pnl_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add position.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;lots&#39;</span><span class="p">:</span> <span class="n">lots</span><span class="p">,</span>
            <span class="s1">&#39;pnl_pips&#39;</span><span class="p">:</span> <span class="n">pnl_pips</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">calculate_weekend_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total weekend gap risk.&quot;&quot;&quot;</span>
        <span class="n">total_risk</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="n">gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVG_GAPS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">],</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>  <span class="c1"># 3x for worst case</span>
            <span class="n">risk</span> <span class="o">=</span> <span class="n">gap</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;lots&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">______</span>  <span class="c1"># pip value</span>
            <span class="n">total_risk</span> <span class="o">+=</span> <span class="n">risk</span>
        <span class="k">return</span> <span class="n">total_risk</span>
    
    <span class="k">def</span> <span class="nf">get_advice</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get weekend risk advice.&quot;&quot;&quot;</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_weekend_risk</span><span class="p">()</span>
        <span class="n">risk_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">risk</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">if</span> <span class="n">risk_pct</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;hold&#39;</span><span class="p">,</span> <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="n">risk_pct</span><span class="p">}</span>
        
        <span class="c1"># Recommend closing losing positions first</span>
        <span class="n">to_close</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;______&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;pnl_pips&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">to_close</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;reduce&#39;</span><span class="p">,</span>
            <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="n">risk_pct</span><span class="p">,</span>
            <span class="s1">&#39;close_first&#39;</span><span class="p">:</span> <span class="n">to_close</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">advisor</span> <span class="o">=</span> <span class="n">WeekendRiskAdvisor</span><span class="p">(</span><span class="mi">20000</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
<span class="n">advisor</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">advisor</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weekend Advice: </span><span class="si">{</span><span class="n">advisor</span><span class="o">.</span><span class="n">get_advice</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WeekendRiskAdvisor</span><span class="p">:</span>
    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">calculate_weekend_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">total_risk</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="n">gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVG_GAPS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">],</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="n">risk</span> <span class="o">=</span> <span class="n">gap</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;lots&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># pip value = $10/lot</span>
            <span class="n">total_risk</span> <span class="o">+=</span> <span class="n">risk</span>
        <span class="k">return</span> <span class="n">total_risk</span>

    <span class="k">def</span> <span class="nf">get_advice</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_weekend_risk</span><span class="p">()</span>
        <span class="n">risk_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">risk</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="n">risk_pct</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;hold&#39;</span><span class="p">,</span> <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="n">risk_pct</span><span class="p">}</span>

        <span class="c1"># Sort by pnl_pips to close losers first</span>
        <span class="n">to_close</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;pnl_pips&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;pnl_pips&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">to_close</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;reduce&#39;</span><span class="p">,</span> <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="n">risk_pct</span><span class="p">,</span> <span class="s1">&#39;close_first&#39;</span><span class="p">:</span> <span class="n">to_close</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 4: Complete Risk Dashboard (Open-ended)</h3>
<p>Build a comprehensive risk dashboard that:
- Tracks all positions (forex and futures)
- Calculates total account risk
- Monitors margin levels
- Provides alerts and recommendations</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4: Complete Risk Dashboard (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class RiskDashboard</span>
<span class="c1"># 2. Track forex and futures positions</span>
<span class="c1"># 3. Calculate total risk as % of account</span>
<span class="c1"># 4. Monitor margin utilization</span>
<span class="c1"># 5. Generate alerts when risk exceeds limits</span>
<span class="c1"># 6. Provide position reduction recommendations</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RiskDashboard</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">account_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forex_positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures_positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span> <span class="o">=</span> <span class="mf">5.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_margin_pct</span> <span class="o">=</span> <span class="mf">50.0</span>

    <span class="k">def</span> <span class="nf">add_forex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">stop_pips</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="n">stop_pips</span> <span class="o">*</span> <span class="n">lots</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forex_positions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span> <span class="s1">&#39;lots&#39;</span><span class="p">:</span> <span class="n">lots</span><span class="p">,</span> <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="n">risk</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">add_futures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">contracts</span><span class="p">,</span> <span class="n">stop_ticks</span><span class="p">,</span> <span class="n">tick_value</span><span class="p">,</span> <span class="n">margin</span><span class="p">):</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="n">stop_ticks</span> <span class="o">*</span> <span class="n">tick_value</span> <span class="o">*</span> <span class="n">contracts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures_positions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;contracts&#39;</span><span class="p">:</span> <span class="n">contracts</span><span class="p">,</span> <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="n">risk</span><span class="p">,</span> <span class="s1">&#39;margin&#39;</span><span class="p">:</span> <span class="n">margin</span> <span class="o">*</span> <span class="n">contracts</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">total_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fx_risk</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;risk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forex_positions</span><span class="p">)</span>
        <span class="n">fut_risk</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;risk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures_positions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fx_risk</span> <span class="o">+</span> <span class="n">fut_risk</span>

    <span class="k">def</span> <span class="nf">total_margin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;margin&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures_positions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">risk_pct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_risk</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">margin_pct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_margin</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="n">risk_pct</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span><span class="p">:</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RISK: </span><span class="si">{</span><span class="n">risk_pct</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% exceeds </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">margin_pct</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_margin_pct</span><span class="p">:</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MARGIN: </span><span class="si">{</span><span class="n">margin_pct</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% exceeds </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_margin_pct</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">alerts</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_risk&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_risk</span><span class="p">(),</span>
            <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_risk</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;margin_used&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_margin</span><span class="p">(),</span>
            <span class="s1">&#39;margin_pct&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_margin</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;alerts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alerts</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 5: Correlation-Adjusted Position Sizer (Open-ended)</h3>
<p>Build a position sizer that accounts for correlations between positions.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 5: Correlation-Adjusted Position Sizer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class CorrelationAdjustedSizer</span>
<span class="c1"># 2. Store known correlations between pairs</span>
<span class="c1"># 3. When adding new position, check correlation with existing</span>
<span class="c1"># 4. Reduce size if highly correlated (adds risk)</span>
<span class="c1"># 5. Allow larger size if negative correlation (hedges)</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CorrelationAdjustedSizer</span><span class="p">:</span>
    <span class="n">CORRELATIONS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">):</span> <span class="mf">0.85</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;USDCHF&#39;</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.90</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;AUDUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZDUSD&#39;</span><span class="p">):</span> <span class="mf">0.90</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_risk</span> <span class="o">=</span> <span class="n">base_risk_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># pair -&gt; direction</span>

    <span class="k">def</span> <span class="nf">get_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pair2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair1</span><span class="p">,</span> <span class="n">pair2</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">pair1</span><span class="p">,</span> <span class="n">pair2</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORRELATIONS</span> <span class="k">else</span> <span class="p">(</span><span class="n">pair2</span><span class="p">,</span> <span class="n">pair1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORRELATIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_adjusted_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">max_corr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">adds_risk</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_correlation</span><span class="p">(</span><span class="n">new_pair</span><span class="p">,</span> <span class="n">pair</span><span class="p">)</span>
            <span class="n">effective_corr</span> <span class="o">=</span> <span class="n">corr</span> <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="n">new_direction</span> <span class="k">else</span> <span class="o">-</span><span class="n">corr</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_corr</span><span class="p">):</span>
                <span class="n">max_corr</span> <span class="o">=</span> <span class="n">corr</span>
                <span class="n">adds_risk</span> <span class="o">=</span> <span class="n">effective_corr</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Adjust risk based on correlation</span>
        <span class="k">if</span> <span class="n">adds_risk</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_corr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_risk</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_corr</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Reduce up to 50%</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">adds_risk</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_corr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_risk</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_corr</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">)</span>  <span class="c1"># Increase up to 25%</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_risk</span>

    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">direction</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 6: Dynamic Stop Manager (Open-ended)</h3>
<p>Build a stop loss manager that dynamically adjusts stops based on market conditions.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 6: Dynamic Stop Manager (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class DynamicStopManager</span>
<span class="c1"># 2. Track positions with entry, current stop, direction</span>
<span class="c1"># 3. Calculate ATR-based trailing stop</span>
<span class="c1"># 4. Implement break-even stop after X pips profit</span>
<span class="c1"># 5. Tighten stop as profit increases</span>
<span class="c1"># 6. Never move stop against the trade</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DynamicStopManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">breakeven_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">atr_multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breakeven_pips</span> <span class="o">=</span> <span class="n">breakeven_pips</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr_mult</span> <span class="o">=</span> <span class="n">atr_multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span> <span class="s1">&#39;highest&#39;</span><span class="p">:</span> <span class="n">entry</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">update_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">atr</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pos</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Position not found&#39;</span><span class="p">}</span>

        <span class="n">pip</span> <span class="o">=</span> <span class="mf">0.0001</span>
        <span class="n">profit_pips</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">pip</span> <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip</span>

        <span class="c1"># Update highest/lowest</span>
        <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;highest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;highest&#39;</span><span class="p">],</span> <span class="n">current_price</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;highest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;highest&#39;</span><span class="p">],</span> <span class="n">current_price</span><span class="p">)</span>

        <span class="n">new_stop</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span>

        <span class="c1"># Break-even</span>
        <span class="k">if</span> <span class="n">profit_pips</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">breakeven_pips</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
                <span class="n">new_stop</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">new_stop</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">pip</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_stop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_stop</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;entry&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">pip</span><span class="p">)</span>

        <span class="c1"># ATR trailing</span>
        <span class="k">if</span> <span class="n">profit_pips</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">breakeven_pips</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">trail_stop</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;highest&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">atr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr_mult</span><span class="p">)</span> <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;highest&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">atr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr_mult</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
                <span class="n">new_stop</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">new_stop</span><span class="p">,</span> <span class="n">trail_stop</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_stop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_stop</span><span class="p">,</span> <span class="n">trail_stop</span><span class="p">)</span>

        <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_stop</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;new_stop&#39;</span><span class="p">:</span> <span class="n">new_stop</span><span class="p">,</span> <span class="s1">&#39;profit_pips&#39;</span><span class="p">:</span> <span class="n">profit_pips</span><span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Risk Management System</h2>
<p>Build a production-ready risk management system for forex and futures trading.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">RiskManagementSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready risk management system.</span>
<span class="sd">    </span>
<span class="sd">    Features: Position sizing, Margin monitoring, Correlation risk,</span>
<span class="sd">    Gap risk, Dynamic stops, Real-time alerts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">account_currency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">=</span> <span class="n">account_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span> <span class="o">=</span> <span class="n">account_currency</span>
        
        <span class="c1"># Sub-systems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forex_calc</span> <span class="o">=</span> <span class="n">ForexRiskCalculator</span><span class="p">(</span><span class="n">account_currency</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures_calc</span> <span class="o">=</span> <span class="n">FuturesRiskCalculator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_calc</span> <span class="o">=</span> <span class="n">CurrencyExposureCalculator</span><span class="p">(</span><span class="n">account_currency</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr_manager</span> <span class="o">=</span> <span class="n">CorrelationRiskManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap_manager</span> <span class="o">=</span> <span class="n">GapRiskManager</span><span class="p">()</span>
        
        <span class="c1"># Risk limits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_single_trade_risk</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># %</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_total_risk</span> <span class="o">=</span> <span class="mf">6.0</span>  <span class="c1"># %</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_correlation_risk</span> <span class="o">=</span> <span class="mf">4.0</span>  <span class="c1"># %</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_margin_usage</span> <span class="o">=</span> <span class="mf">50.0</span>  <span class="c1"># %</span>
        
        <span class="c1"># Active positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forex_positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures_positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">set_exchange_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set exchange rate for calculations.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forex_calc</span><span class="o">.</span><span class="n">set_exchange_rate</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_forex_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                <span class="n">stop_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate forex position size.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">risk_pct</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_single_trade_risk</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Risk </span><span class="si">{</span><span class="n">risk_pct</span><span class="si">}</span><span class="s1">% exceeds max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_single_trade_risk</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forex_calc</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">,</span> <span class="n">stop_pips</span><span class="p">,</span> <span class="n">pair</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_futures_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                  <span class="n">stop_ticks</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate futures position size.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">risk_pct</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_single_trade_risk</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Risk </span><span class="si">{</span><span class="n">risk_pct</span><span class="si">}</span><span class="s1">% exceeds max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_single_trade_risk</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures_calc</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span>
            <span class="n">symbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">,</span> <span class="n">stop_ticks</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_forex_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">units</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add active forex position.&quot;&quot;&quot;</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forex_calc</span><span class="o">.</span><span class="n">calculate_pip_value</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">units</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">)</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_value</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">forex_positions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;pair&#39;</span><span class="p">:</span> <span class="n">pair</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
            <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry</span><span class="p">,</span>
            <span class="s1">&#39;stop_pips&#39;</span><span class="p">:</span> <span class="n">stop_pips</span><span class="p">,</span>
            <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="n">risk</span>
        <span class="p">})</span>
        
        <span class="c1"># Update sub-systems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_calc</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr_manager</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">risk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap_manager</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_futures_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">contracts</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stop_ticks</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add active futures position.&quot;&quot;&quot;</span>
        <span class="n">risk_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures_calc</span><span class="o">.</span><span class="n">calculate_tick_risk</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">stop_ticks</span><span class="p">,</span> <span class="n">contracts</span><span class="p">)</span>
        <span class="n">contract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures_calc</span><span class="o">.</span><span class="n">get_contract</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">futures_positions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;contracts&#39;</span><span class="p">:</span> <span class="n">contracts</span><span class="p">,</span>
            <span class="s1">&#39;stop_ticks&#39;</span><span class="p">:</span> <span class="n">stop_ticks</span><span class="p">,</span>
            <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="n">risk_info</span><span class="p">[</span><span class="s1">&#39;total_risk&#39;</span><span class="p">],</span>
            <span class="s1">&#39;margin&#39;</span><span class="p">:</span> <span class="n">contract</span><span class="o">.</span><span class="n">initial_margin</span> <span class="o">*</span> <span class="n">contracts</span> <span class="k">if</span> <span class="n">contract</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">get_total_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total portfolio risk.&quot;&quot;&quot;</span>
        <span class="n">forex_risk</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;risk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forex_positions</span><span class="p">)</span>
        <span class="n">futures_risk</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;risk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures_positions</span><span class="p">)</span>
        
        <span class="c1"># Get correlated risk</span>
        <span class="n">corr_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_manager</span><span class="o">.</span><span class="n">calculate_correlated_risk</span><span class="p">()</span>
        
        <span class="n">simple_total</span> <span class="o">=</span> <span class="n">forex_risk</span> <span class="o">+</span> <span class="n">futures_risk</span>
        <span class="n">correlated_total</span> <span class="o">=</span> <span class="n">corr_risk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;correlated_risk&#39;</span><span class="p">,</span> <span class="n">simple_total</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;forex_risk&#39;</span><span class="p">:</span> <span class="n">forex_risk</span><span class="p">,</span>
            <span class="s1">&#39;futures_risk&#39;</span><span class="p">:</span> <span class="n">futures_risk</span><span class="p">,</span>
            <span class="s1">&#39;simple_total&#39;</span><span class="p">:</span> <span class="n">simple_total</span><span class="p">,</span>
            <span class="s1">&#39;correlated_total&#39;</span><span class="p">:</span> <span class="n">correlated_total</span><span class="p">,</span>
            <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">correlated_total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;diversification_benefit&#39;</span><span class="p">:</span> <span class="n">simple_total</span> <span class="o">-</span> <span class="n">correlated_total</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_margin_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get futures margin status.&quot;&quot;&quot;</span>
        <span class="n">total_margin</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;margin&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures_positions</span><span class="p">)</span>
        <span class="n">margin_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_margin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;margin_used&#39;</span><span class="p">:</span> <span class="n">total_margin</span><span class="p">,</span>
            <span class="s1">&#39;margin_pct&#39;</span><span class="p">:</span> <span class="n">margin_pct</span><span class="p">,</span>
            <span class="s1">&#39;available&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span> <span class="o">-</span> <span class="n">total_margin</span><span class="p">,</span>
            <span class="s1">&#39;within_limits&#39;</span><span class="p">:</span> <span class="n">margin_pct</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_margin_usage</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get risk alerts.&quot;&quot;&quot;</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Total risk check</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_risk</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">risk</span><span class="p">[</span><span class="s1">&#39;risk_pct&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_total_risk</span><span class="p">:</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TOTAL RISK: </span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;risk_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% exceeds </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_total_risk</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="c1"># Margin check</span>
        <span class="n">margin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_margin_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">margin</span><span class="p">[</span><span class="s1">&#39;within_limits&#39;</span><span class="p">]:</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MARGIN: </span><span class="si">{</span><span class="n">margin</span><span class="p">[</span><span class="s1">&#39;margin_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% exceeds </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_margin_usage</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="c1"># Concentration check</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_calc</span><span class="o">.</span><span class="n">check_concentration</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conc</span><span class="p">[</span><span class="s1">&#39;concentrated&#39;</span><span class="p">]:</span>
            <span class="n">alerts</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;CONCENTRATION: </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">conc</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]])</span>
        
        <span class="k">return</span> <span class="n">alerts</span>
    
    <span class="k">def</span> <span class="nf">can_add_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">risk_amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if a new trade can be added within limits.&quot;&quot;&quot;</span>
        <span class="n">current_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_risk</span><span class="p">()[</span><span class="s1">&#39;correlated_total&#39;</span><span class="p">]</span>
        <span class="n">new_total</span> <span class="o">=</span> <span class="n">current_risk</span> <span class="o">+</span> <span class="n">risk_amount</span>
        <span class="n">new_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;can_add&#39;</span><span class="p">:</span> <span class="n">new_pct</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_total_risk</span><span class="p">,</span>
            <span class="s1">&#39;current_risk_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">current_risk</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;new_risk_pct&#39;</span><span class="p">:</span> <span class="n">new_pct</span><span class="p">,</span>
            <span class="s1">&#39;max_allowed&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_total_risk</span><span class="p">,</span>
            <span class="s1">&#39;headroom&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_total_risk</span> <span class="o">-</span> <span class="n">new_pct</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">print_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print risk dashboard.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  RISK MANAGEMENT DASHBOARD&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Account: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">account_balance</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">account_currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="c1"># Positions</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POSITIONS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forex: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forex_positions</span><span class="p">)</span><span class="si">}</span><span class="s2"> positions&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forex_positions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> units, Risk: $</span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;risk&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Futures: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">futures_positions</span><span class="p">)</span><span class="si">}</span><span class="s2"> positions&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures_positions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;contracts&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> contracts, Risk: $</span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;risk&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Risk Summary</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RISK SUMMARY&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_risk</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Risk: $</span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;correlated_total&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;risk_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diversification Benefit: $</span><span class="si">{</span><span class="n">risk</span><span class="p">[</span><span class="s1">&#39;diversification_benefit&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Margin</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MARGIN STATUS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">margin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_margin_status</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Margin Used: $</span><span class="si">{</span><span class="n">margin</span><span class="p">[</span><span class="s1">&#39;margin_used&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">margin</span><span class="p">[</span><span class="s1">&#39;margin_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available: $</span><span class="si">{</span><span class="n">margin</span><span class="p">[</span><span class="s1">&#39;available&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Alerts</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alerts</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">alerts</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ALERTS&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">alerts</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ! </span><span class="si">{</span><span class="n">alert</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  All risk metrics within limits.&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demo the risk management system</span>
<span class="n">rms</span> <span class="o">=</span> <span class="n">RiskManagementSystem</span><span class="p">(</span><span class="n">account_balance</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">account_currency</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">)</span>

<span class="c1"># Set exchange rates</span>
<span class="n">rms</span><span class="o">.</span><span class="n">set_exchange_rate</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">)</span>
<span class="n">rms</span><span class="o">.</span><span class="n">set_exchange_rate</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="mf">150.50</span><span class="p">)</span>

<span class="c1"># Add forex positions</span>
<span class="n">rms</span><span class="o">.</span><span class="n">add_forex_position</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">rms</span><span class="o">.</span><span class="n">add_forex_position</span><span class="p">(</span><span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="mf">1.2650</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">rms</span><span class="o">.</span><span class="n">add_forex_position</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mf">150.50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="c1"># Add futures position</span>
<span class="n">rms</span><span class="o">.</span><span class="n">add_futures_position</span><span class="p">(</span><span class="s1">&#39;ES&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

<span class="c1"># Print dashboard</span>
<span class="n">rms</span><span class="o">.</span><span class="n">print_dashboard</span><span class="p">()</span>

<span class="c1"># Check if we can add another trade</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Can add $300 risk trade?&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rms</span><span class="o">.</span><span class="n">can_add_trade</span><span class="p">(</span><span class="mi">300</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ul>
<li><strong>Position Sizing</strong>: Always size positions based on risk %, not profit potential; typically 1-2% per trade</li>
<li><strong>Pip Value</strong>: Varies by pair and quote currency; always calculate in account currency</li>
<li><strong>Futures Risk</strong>: Based on tick values and contract specifications; watch margin requirements</li>
<li><strong>ATR Stops</strong>: Dynamic stops that adapt to market volatility; typically 1.5-3x ATR</li>
<li><strong>Correlation Risk</strong>: Same-direction correlated positions multiply risk; opposite directions hedge</li>
<li><strong>Currency Exposure</strong>: Monitor net exposure by currency to avoid concentration</li>
<li><strong>Weekend Gaps</strong>: Reduce position size before weekends; close losing trades first</li>
<li><strong>Margin Management</strong>: Keep margin usage under 50% to handle adverse moves</li>
</ul>
<p><strong>Next: Module 10 - Backtesting</strong> where we'll build robust backtesting systems for forex and futures.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="10"><div class="md-cell module-header"><h1>Module 10: Backtesting</h1>
<p><strong>Part 3: Risk &amp; Execution</strong></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>~2.5 hours</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ul>
<li>Account for realistic forex/futures costs (spreads, swaps, commissions)</li>
<li>Build a leveraged backtester with margin tracking</li>
<li>Understand tick data backtesting and variable spreads</li>
<li>Implement walk-forward optimization for robustness</li>
</ul>
<h2>Prerequisites</h2>
<ul>
<li>Modules 1-9 (Forex/Futures fundamentals, strategies, risk management)</li>
<li>Basic backtesting concepts</li>
<li>Python pandas proficiency</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>10.1 Backtesting Considerations</h2>
<p>Forex and futures backtesting requires accounting for spreads, swap/rollover costs, and leverage effects.</p></div>
<div class="md-cell"><h3>Trading Costs Overview</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Cost Type</th>
<th>Forex</th>
<th>Futures</th>
<th>Impact</th>
</tr>
</thead>
<tbody>
<tr>
<td>Spread</td>
<td>0.5-3 pips</td>
<td>0.25-1 tick</td>
<td>Per trade</td>
</tr>
<tr>
<td>Commission</td>
<td>$0-7/lot</td>
<td>$2-5/contract</td>
<td>Per trade</td>
</tr>
<tr>
<td>Swap/Rollover</td>
<td>Variable</td>
<td>N/A</td>
<td>Daily (forex)</td>
</tr>
<tr>
<td>Slippage</td>
<td>0.5-2 pips</td>
<td>1-2 ticks</td>
<td>Market orders</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TradingCosts</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trading costs configuration.&quot;&quot;&quot;</span>
    <span class="n">spread_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Forex spread</span>
    <span class="n">commission_per_lot</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Commission per lot</span>
    <span class="n">swap_long</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Daily swap for long (pips)</span>
    <span class="n">swap_short</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Daily swap for short (pips)</span>
    <span class="n">slippage_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Average slippage</span>
    
    <span class="k">def</span> <span class="nf">total_entry_cost_pips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_long</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Total cost to enter a trade in pips.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spread_pips</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage_pips</span>
    
    <span class="k">def</span> <span class="nf">total_exit_cost_pips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_long</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Total cost to exit a trade in pips.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spread_pips</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage_pips</span>
    
    <span class="k">def</span> <span class="nf">holding_cost_pips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_long</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Total swap cost for holding period.&quot;&quot;&quot;</span>
        <span class="n">daily_swap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_long</span> <span class="k">if</span> <span class="n">is_long</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_short</span>
        <span class="k">return</span> <span class="n">daily_swap</span> <span class="o">*</span> <span class="n">days</span>
    
    <span class="k">def</span> <span class="nf">commission_pips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pip_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Commission converted to pips.&quot;&quot;&quot;</span>
        <span class="n">total_commission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission_per_lot</span> <span class="o">*</span> <span class="n">lots</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># Entry + exit</span>
        <span class="k">return</span> <span class="n">total_commission</span> <span class="o">/</span> <span class="n">pip_value</span>


<span class="k">class</span> <span class="nc">CostCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate realistic trading costs.&quot;&quot;&quot;</span>
    
    <span class="c1"># Typical costs by pair</span>
    <span class="n">FOREX_COSTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="n">TradingCosts</span><span class="p">(</span><span class="n">spread_pips</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">swap_long</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">swap_short</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
        <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="n">TradingCosts</span><span class="p">(</span><span class="n">spread_pips</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">swap_long</span><span class="o">=-</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">swap_short</span><span class="o">=</span><span class="mf">0.4</span><span class="p">),</span>
        <span class="s1">&#39;USDJPY&#39;</span><span class="p">:</span> <span class="n">TradingCosts</span><span class="p">(</span><span class="n">spread_pips</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">swap_long</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">swap_short</span><span class="o">=-</span><span class="mf">1.2</span><span class="p">),</span>
        <span class="s1">&#39;AUDUSD&#39;</span><span class="p">:</span> <span class="n">TradingCosts</span><span class="p">(</span><span class="n">spread_pips</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">swap_long</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">swap_short</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">),</span>
        <span class="s1">&#39;USDCAD&#39;</span><span class="p">:</span> <span class="n">TradingCosts</span><span class="p">(</span><span class="n">spread_pips</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">swap_long</span><span class="o">=-</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">swap_short</span><span class="o">=</span><span class="mf">0.2</span><span class="p">),</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_costs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TradingCosts</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">set_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">costs</span><span class="p">:</span> <span class="n">TradingCosts</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set custom costs for a symbol.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_costs</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span>
    
    <span class="k">def</span> <span class="nf">get_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TradingCosts</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get costs for a symbol.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_costs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_costs</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FOREX_COSTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">TradingCosts</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">calculate_trade_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">is_long</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">holding_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total cost for a trade.&quot;&quot;&quot;</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_costs</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">lots</span>  <span class="c1"># Assuming standard pip value</span>
        
        <span class="n">entry_pips</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">total_entry_cost_pips</span><span class="p">(</span><span class="n">is_long</span><span class="p">)</span>
        <span class="n">exit_pips</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">total_exit_cost_pips</span><span class="p">(</span><span class="n">is_long</span><span class="p">)</span>
        <span class="n">holding_pips</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">holding_cost_pips</span><span class="p">(</span><span class="n">is_long</span><span class="p">,</span> <span class="n">holding_days</span><span class="p">)</span>
        <span class="n">commission_pips</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">commission_pips</span><span class="p">(</span><span class="n">lots</span><span class="p">)</span>
        
        <span class="n">total_pips</span> <span class="o">=</span> <span class="n">entry_pips</span> <span class="o">+</span> <span class="n">exit_pips</span> <span class="o">+</span> <span class="n">holding_pips</span> <span class="o">+</span> <span class="n">commission_pips</span>
        <span class="n">total_dollars</span> <span class="o">=</span> <span class="n">total_pips</span> <span class="o">*</span> <span class="n">pip_value</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;lots&#39;</span><span class="p">:</span> <span class="n">lots</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span> <span class="k">if</span> <span class="n">is_long</span> <span class="k">else</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span>
            <span class="s1">&#39;holding_days&#39;</span><span class="p">:</span> <span class="n">holding_days</span><span class="p">,</span>
            <span class="s1">&#39;entry_cost_pips&#39;</span><span class="p">:</span> <span class="n">entry_pips</span><span class="p">,</span>
            <span class="s1">&#39;exit_cost_pips&#39;</span><span class="p">:</span> <span class="n">exit_pips</span><span class="p">,</span>
            <span class="s1">&#39;swap_cost_pips&#39;</span><span class="p">:</span> <span class="n">holding_pips</span><span class="p">,</span>
            <span class="s1">&#39;commission_pips&#39;</span><span class="p">:</span> <span class="n">commission_pips</span><span class="p">,</span>
            <span class="s1">&#39;total_cost_pips&#39;</span><span class="p">:</span> <span class="n">total_pips</span><span class="p">,</span>
            <span class="s1">&#39;total_cost_dollars&#39;</span><span class="p">:</span> <span class="n">total_dollars</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">break_even_pips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                        <span class="n">is_long</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">holding_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate pips needed to break even.&quot;&quot;&quot;</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_trade_cost</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">is_long</span><span class="p">,</span> <span class="n">holding_days</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cost</span><span class="p">[</span><span class="s1">&#39;total_cost_pips&#39;</span><span class="p">]</span>

<span class="c1"># Demo</span>
<span class="n">cost_calc</span> <span class="o">=</span> <span class="n">CostCalculator</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trade Cost Calculation:&quot;</span><span class="p">)</span>
<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_calc</span><span class="o">.</span><span class="n">calculate_trade_cost</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">is_long</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">holding_days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cost</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Break-even pips: </span><span class="si">{</span><span class="n">cost_calc</span><span class="o">.</span><span class="n">break_even_pips</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>10.2 Building Backtester</h2>
<p>A forex-specific backtester must handle leverage, margin, and realistic execution.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Trade</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a single trade.&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;long&#39; or &#39;short&#39;</span>
    <span class="n">entry_time</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">units</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">take_profit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">exit_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">exit_reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pnl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pnl_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>


<span class="k">class</span> <span class="nc">ForexBacktester</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Forex-specific backtester with leverage and margin.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                 <span class="n">risk_per_trade</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_per_trade</span> <span class="o">=</span> <span class="n">risk_per_trade</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_calculator</span> <span class="o">=</span> <span class="n">CostCalculator</span><span class="p">()</span>
        
        <span class="c1"># State</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin_used</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_counter</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reset backtester state.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin_used</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed_trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_counter</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stop_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate position size based on risk.&quot;&quot;&quot;</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_per_trade</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">pip_value_per_unit</span> <span class="o">=</span> <span class="mf">0.0001</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">symbol</span> <span class="k">else</span> <span class="mf">0.01</span>
        
        <span class="c1"># Units = Risk Amount / (Stop Pips * Pip Value)</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="p">(</span><span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_value_per_unit</span><span class="p">)</span>
        
        <span class="c1"># Check margin constraint</span>
        <span class="n">margin_required</span> <span class="o">=</span> <span class="n">units</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
        <span class="n">available_margin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_used</span>
        
        <span class="k">if</span> <span class="n">margin_required</span> <span class="o">&gt;</span> <span class="n">available_margin</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">available_margin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
        
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">open_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                   <span class="n">entry_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                   <span class="n">stop_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tp_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Trade</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Open a new trade.&quot;&quot;&quot;</span>
        <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">stop_pips</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">units</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.0001</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">symbol</span> <span class="k">else</span> <span class="mf">0.01</span>
        
        <span class="c1"># Calculate stops</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="p">(</span><span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_size</span><span class="p">)</span>
            <span class="n">take_profit</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp_pips</span> <span class="o">*</span> <span class="n">pip_size</span><span class="p">)</span> <span class="k">if</span> <span class="n">tp_pips</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">+</span> <span class="p">(</span><span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_size</span><span class="p">)</span>
            <span class="n">take_profit</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="p">(</span><span class="n">tp_pips</span> <span class="o">*</span> <span class="n">pip_size</span><span class="p">)</span> <span class="k">if</span> <span class="n">tp_pips</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="c1"># Apply entry costs (slippage)</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_calculator</span><span class="o">.</span><span class="n">get_costs</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">slippage</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">slippage_pips</span> <span class="o">*</span> <span class="n">pip_size</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">entry_price</span> <span class="o">+=</span> <span class="n">slippage</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entry_price</span> <span class="o">-=</span> <span class="n">slippage</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_counter</span><span class="p">,</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span>
            <span class="n">entry_time</span><span class="o">=</span><span class="n">entry_time</span><span class="p">,</span>
            <span class="n">entry_price</span><span class="o">=</span><span class="n">entry_price</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
            <span class="n">stop_loss</span><span class="o">=</span><span class="n">stop_loss</span><span class="p">,</span>
            <span class="n">take_profit</span><span class="o">=</span><span class="n">take_profit</span>
        <span class="p">)</span>
        
        <span class="c1"># Update margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin_used</span> <span class="o">+=</span> <span class="n">units</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">trade</span>
    
    <span class="k">def</span> <span class="nf">close_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">Trade</span><span class="p">,</span> <span class="n">exit_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
                   <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close an open trade.&quot;&quot;&quot;</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.0001</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trade</span><span class="o">.</span><span class="n">symbol</span> <span class="k">else</span> <span class="mf">0.01</span>
        
        <span class="c1"># Apply exit costs</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_calculator</span><span class="o">.</span><span class="n">get_costs</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">slippage</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">slippage_pips</span> <span class="o">*</span> <span class="n">pip_size</span>
        <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">exit_price</span> <span class="o">-=</span> <span class="n">slippage</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_price</span> <span class="o">+=</span> <span class="n">slippage</span>
        
        <span class="c1"># Calculate P&amp;L</span>
        <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">pnl_pips</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">trade</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pnl_pips</span> <span class="o">=</span> <span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">-</span> <span class="n">exit_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">pip_size</span>
        
        <span class="c1"># Subtract spread cost</span>
        <span class="n">pnl_pips</span> <span class="o">-=</span> <span class="n">costs</span><span class="o">.</span><span class="n">spread_pips</span>
        
        <span class="c1"># Calculate holding days and swap</span>
        <span class="n">holding_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_time</span> <span class="o">-</span> <span class="n">trade</span><span class="o">.</span><span class="n">entry_time</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="n">swap_pips</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">holding_cost_pips</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="n">holding_days</span><span class="p">)</span>
        <span class="n">pnl_pips</span> <span class="o">+=</span> <span class="n">swap_pips</span>  <span class="c1"># Swap can be positive or negative</span>
        
        <span class="c1"># Convert to dollars</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="n">pnl_pips</span> <span class="o">*</span> <span class="n">pip_size</span> <span class="o">*</span> <span class="n">trade</span><span class="o">.</span><span class="n">units</span>
        
        <span class="c1"># Update trade</span>
        <span class="n">trade</span><span class="o">.</span><span class="n">exit_time</span> <span class="o">=</span> <span class="n">exit_time</span>
        <span class="n">trade</span><span class="o">.</span><span class="n">exit_price</span> <span class="o">=</span> <span class="n">exit_price</span>
        <span class="n">trade</span><span class="o">.</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">reason</span>
        <span class="n">trade</span><span class="o">.</span><span class="n">pnl</span> <span class="o">=</span> <span class="n">pnl</span>
        <span class="n">trade</span><span class="o">.</span><span class="n">pnl_pips</span> <span class="o">=</span> <span class="n">pnl_pips</span>
        
        <span class="c1"># Update account</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">pnl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin_used</span> <span class="o">-=</span> <span class="n">trade</span><span class="o">.</span><span class="n">units</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
        
        <span class="c1"># Move to closed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed_trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update open trades and check stops/targets.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span><span class="p">[:]:</span>
            <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
                <span class="c1"># Check stop loss</span>
                <span class="k">if</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">trade</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">,</span> <span class="s1">&#39;stop_loss&#39;</span><span class="p">)</span>
                <span class="c1"># Check take profit</span>
                <span class="k">elif</span> <span class="n">trade</span><span class="o">.</span><span class="n">take_profit</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&gt;=</span> <span class="n">trade</span><span class="o">.</span><span class="n">take_profit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">take_profit</span><span class="p">,</span> <span class="s1">&#39;take_profit&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Short</span>
                <span class="k">if</span> <span class="n">current_price</span> <span class="o">&gt;=</span> <span class="n">trade</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">,</span> <span class="s1">&#39;stop_loss&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">trade</span><span class="o">.</span><span class="n">take_profit</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">trade</span><span class="o">.</span><span class="n">take_profit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">take_profit</span><span class="p">,</span> <span class="s1">&#39;take_profit&#39;</span><span class="p">)</span>
        
        <span class="c1"># Update equity curve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_equity</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="n">current_price</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_update_equity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update equity with unrealized P&amp;L.&quot;&quot;&quot;</span>
        <span class="n">unrealized</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span><span class="p">:</span>
            <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.0001</span> <span class="k">if</span> <span class="s1">&#39;JPY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trade</span><span class="o">.</span><span class="n">symbol</span> <span class="k">else</span> <span class="mf">0.01</span>
            <span class="k">if</span> <span class="n">trade</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
                <span class="n">unrealized</span> <span class="o">+=</span> <span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">trade</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">trade</span><span class="o">.</span><span class="n">units</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unrealized</span> <span class="o">+=</span> <span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">-</span> <span class="n">current_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">trade</span><span class="o">.</span><span class="n">units</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">unrealized</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">,</span>
            <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">,</span>
            <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run backtest with a strategy function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">current_price</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
            
            <span class="c1"># Update existing trades</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_time</span><span class="p">,</span> <span class="n">current_price</span><span class="p">)</span>
            
            <span class="c1"># Check margin call</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_used</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="c1"># Close all trades</span>
                <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span><span class="p">[:]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">current_price</span><span class="p">,</span> <span class="s1">&#39;margin_call&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="c1"># Generate signal from strategy</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">signal</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open_trade</span><span class="p">(</span>
                    <span class="n">symbol</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">),</span>
                    <span class="n">direction</span><span class="o">=</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">],</span>
                    <span class="n">entry_time</span><span class="o">=</span><span class="n">current_time</span><span class="p">,</span>
                    <span class="n">entry_price</span><span class="o">=</span><span class="n">current_price</span><span class="p">,</span>
                    <span class="n">stop_pips</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stop_pips&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
                    <span class="n">tp_pips</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tp_pips&#39;</span><span class="p">)</span>
                <span class="p">)</span>
        
        <span class="c1"># Close any remaining trades</span>
        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span><span class="p">[:]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;end_of_test&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate backtest statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No trades&#39;</span><span class="p">}</span>
        
        <span class="n">pnls</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">]</span>
        <span class="n">pnl_pips</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">pnl_pips</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">]</span>
        
        <span class="n">wins</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="n">total_pnl</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wins</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">pnls</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="n">avg_win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wins</span><span class="p">)</span> <span class="k">if</span> <span class="n">wins</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses</span><span class="p">))</span> <span class="k">if</span> <span class="n">losses</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">profit_factor</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">wins</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">))</span> <span class="k">if</span> <span class="n">losses</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># Drawdown</span>
        <span class="n">equity_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">]</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">equity_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="n">equity_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eq</span> <span class="o">&gt;</span> <span class="n">peak</span><span class="p">:</span>
                <span class="n">peak</span> <span class="o">=</span> <span class="n">eq</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="n">eq</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">max_dd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_dd</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;initial_capital&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">,</span>
            <span class="s1">&#39;final_equity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span><span class="p">,</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="n">total_pnl</span><span class="p">,</span>
            <span class="s1">&#39;return_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">),</span>
            <span class="s1">&#39;winning_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">wins</span><span class="p">),</span>
            <span class="s1">&#39;losing_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
            <span class="s1">&#39;avg_win&#39;</span><span class="p">:</span> <span class="n">avg_win</span><span class="p">,</span>
            <span class="s1">&#39;avg_loss&#39;</span><span class="p">:</span> <span class="n">avg_loss</span><span class="p">,</span>
            <span class="s1">&#39;profit_factor&#39;</span><span class="p">:</span> <span class="n">profit_factor</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown_pct&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;avg_pips&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pnl_pips</span><span class="p">),</span>
            <span class="s1">&#39;total_pips&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pnl_pips</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="mf">1.0800</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mi">250</span><span class="p">)),</span>
    <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">prices</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
<span class="n">prices</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.003</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
<span class="n">prices</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.003</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>

<span class="c1"># Simple MA crossover strategy</span>
<span class="k">def</span> <span class="nf">ma_strategy</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">fast</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">slow</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">prev_fast</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">prev_slow</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="c1"># Crossover</span>
    <span class="k">if</span> <span class="n">prev_fast</span> <span class="o">&lt;=</span> <span class="n">prev_slow</span> <span class="ow">and</span> <span class="n">fast</span> <span class="o">&gt;</span> <span class="n">slow</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="s1">&#39;stop_pips&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;tp_pips&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">prev_fast</span> <span class="o">&gt;=</span> <span class="n">prev_slow</span> <span class="ow">and</span> <span class="n">fast</span> <span class="o">&lt;</span> <span class="n">slow</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span> <span class="s1">&#39;stop_pips&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;tp_pips&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Run backtest</span>
<span class="n">backtester</span> <span class="o">=</span> <span class="n">ForexBacktester</span><span class="p">(</span><span class="n">initial_capital</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">risk_per_trade</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">backtester</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">ma_strategy</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backtest Results:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>10.3 Tick Data Backtesting</h2>
<p>Tick data provides the most accurate simulation by capturing variable spreads and real execution conditions.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Tick</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Single tick with bid/ask.&quot;&quot;&quot;</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">bid</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">ask</span><span class="p">:</span> <span class="nb">float</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bid</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bid</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>


<span class="k">class</span> <span class="nc">TickDataBacktester</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Backtester using tick-level data with variable spreads.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reset state.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">execute_market_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">units</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute market order at current tick.&quot;&quot;&quot;</span>
        <span class="n">pip_size</span> <span class="o">=</span> <span class="mf">0.0001</span>
        
        <span class="c1"># Use appropriate price (ask for buy, bid for sell)</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">entry_price</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">ask</span>  <span class="c1"># Buy at ask</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span> <span class="o">-</span> <span class="p">(</span><span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entry_price</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span>  <span class="c1"># Sell at bid</span>
            <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">ask</span> <span class="o">+</span> <span class="p">(</span><span class="n">stop_pips</span> <span class="o">*</span> <span class="n">pip_size</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
            <span class="s1">&#39;stop_loss&#39;</span><span class="p">:</span> <span class="n">stop_loss</span><span class="p">,</span>
            <span class="s1">&#39;entry_spread&#39;</span><span class="p">:</span> <span class="n">tick</span><span class="o">.</span><span class="n">spread</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
    
    <span class="k">def</span> <span class="nf">close_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close current position.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Use appropriate price</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="n">exit_price</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span>  <span class="c1"># Sell at bid</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_price</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">ask</span>  <span class="c1"># Buy at ask</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">exit_price</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
        
        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="s1">&#39;exit_price&#39;</span><span class="p">:</span> <span class="n">exit_price</span><span class="p">,</span>
            <span class="s1">&#39;exit_time&#39;</span><span class="p">:</span> <span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="s1">&#39;exit_spread&#39;</span><span class="p">:</span> <span class="n">tick</span><span class="o">.</span><span class="n">spread</span><span class="p">,</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">+=</span> <span class="n">pnl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="n">trade</span>
    
    <span class="k">def</span> <span class="nf">check_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if stop loss is hit.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_position</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="s1">&#39;stop_loss&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tick</span><span class="o">.</span><span class="n">ask</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_position</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="s1">&#39;stop_loss&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">analyze_spread_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze impact of spreads on results.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">spreads</span> <span class="o">=</span> <span class="p">[(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;entry_spread&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;exit_spread&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">]</span>
        <span class="n">spread_costs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spreads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_spread&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spreads</span><span class="p">),</span>
            <span class="s1">&#39;max_spread&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">spreads</span><span class="p">),</span>
            <span class="s1">&#39;min_spread&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">spreads</span><span class="p">),</span>
            <span class="s1">&#39;total_spread_cost&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">spread_costs</span><span class="p">),</span>
            <span class="s1">&#39;spread_cost_per_trade&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spread_costs</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Demo with simulated tick data</span>
<span class="k">def</span> <span class="nf">generate_tick_data</span><span class="p">(</span><span class="n">n_ticks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">base_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0800</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tick</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Generate simulated tick data with variable spreads.&quot;&quot;&quot;</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">base_price</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ticks</span><span class="p">):</span>
        <span class="c1"># Random price movement</span>
        <span class="n">price</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.00005</span><span class="p">)</span>
        
        <span class="c1"># Variable spread (wider during volatile times)</span>
        <span class="n">base_spread</span> <span class="o">=</span> <span class="mf">0.00008</span>
        <span class="n">spread_variation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.00005</span><span class="p">)</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">base_spread</span> <span class="o">+</span> <span class="n">spread_variation</span>
        
        <span class="n">tick</span> <span class="o">=</span> <span class="n">Tick</span><span class="p">(</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">i</span><span class="p">),</span>
            <span class="n">bid</span><span class="o">=</span><span class="n">price</span> <span class="o">-</span> <span class="n">spread</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">ask</span><span class="o">=</span><span class="n">price</span> <span class="o">+</span> <span class="n">spread</span><span class="o">/</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ticks</span>

<span class="c1"># Generate ticks</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">generate_tick_data</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>

<span class="c1"># Run simple tick-level backtest</span>
<span class="n">tick_bt</span> <span class="o">=</span> <span class="n">TickDataBacktester</span><span class="p">(</span><span class="n">initial_capital</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ticks</span><span class="p">):</span>
    <span class="c1"># Check stops first</span>
    <span class="n">tick_bt</span><span class="o">.</span><span class="n">check_stop</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
    
    <span class="c1"># Simple strategy: trade every 1000 ticks</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tick_bt</span><span class="o">.</span><span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;long&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;short&#39;</span>
        <span class="n">tick_bt</span><span class="o">.</span><span class="n">execute_market_order</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">stop_pips</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="c1"># Close after 500 ticks in trade</span>
    <span class="k">if</span> <span class="n">tick_bt</span><span class="o">.</span><span class="n">position</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tick_bt</span><span class="o">.</span><span class="n">close_position</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="s1">&#39;time_exit&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tick-Level Backtest:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Final Equity: $</span><span class="si">{</span><span class="n">tick_bt</span><span class="o">.</span><span class="n">equity</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tick_bt</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Spread Analysis:&quot;</span><span class="p">)</span>
<span class="n">spread_analysis</span> <span class="o">=</span> <span class="n">tick_bt</span><span class="o">.</span><span class="n">analyze_spread_impact</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spread_analysis</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="s1">&#39;spread&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>10.4 Walk-Forward Optimization</h2>
<p>Walk-forward testing validates strategy robustness by optimizing on in-sample data and testing on out-of-sample data.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">WalkForwardOptimizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Walk-forward optimization for strategy validation.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backtester</span><span class="p">:</span> <span class="n">ForexBacktester</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span> <span class="o">=</span> <span class="n">backtester</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">create_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                       <span class="n">is_period</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">oos_period</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                       <span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create in-sample and out-of-sample windows.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">oos_period</span>
        
        <span class="n">windows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="n">start</span> <span class="o">+</span> <span class="n">is_period</span> <span class="o">+</span> <span class="n">oos_period</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">is_start</span> <span class="o">=</span> <span class="n">start</span>
            <span class="n">is_end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">is_period</span>
            <span class="n">oos_start</span> <span class="o">=</span> <span class="n">is_end</span>
            <span class="n">oos_end</span> <span class="o">=</span> <span class="n">oos_start</span> <span class="o">+</span> <span class="n">oos_period</span>
            
            <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;is_data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">is_start</span><span class="p">:</span><span class="n">is_end</span><span class="p">],</span>
                <span class="s1">&#39;oos_data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">oos_start</span><span class="p">:</span><span class="n">oos_end</span><span class="p">],</span>
                <span class="s1">&#39;is_dates&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">is_start</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">is_end</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s1">&#39;oos_dates&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">oos_start</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">oos_end</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">})</span>
            
            <span class="n">start</span> <span class="o">+=</span> <span class="n">step</span>
        
        <span class="k">return</span> <span class="n">windows</span>
    
    <span class="k">def</span> <span class="nf">optimize_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                           <span class="n">param_grid</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                           <span class="n">strategy_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find best parameters on in-sample data.&quot;&quot;&quot;</span>
        <span class="n">best_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_metric</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="c1"># Generate all parameter combinations</span>
        <span class="kn">import</span> <span class="nn">itertools</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">param_grid</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">param_grid</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        
        <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">combo</span><span class="p">))</span>
            
            <span class="c1"># Create strategy with these parameters</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy_factory</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            
            <span class="c1"># Run backtest</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
            
            <span class="c1"># Optimize for Sharpe-like metric (return / drawdown)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown_pct&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown_pct&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">metric</span> <span class="o">&gt;</span> <span class="n">best_metric</span><span class="p">:</span>
                <span class="n">best_metric</span> <span class="o">=</span> <span class="n">metric</span>
                <span class="n">best_params</span> <span class="o">=</span> <span class="n">params</span>
                <span class="n">best_result</span> <span class="o">=</span> <span class="n">result</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="n">best_params</span><span class="p">,</span>
            <span class="s1">&#39;best_result&#39;</span><span class="p">:</span> <span class="n">best_result</span><span class="p">,</span>
            <span class="s1">&#39;optimization_metric&#39;</span><span class="p">:</span> <span class="n">best_metric</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">run_walk_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                        <span class="n">is_period</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">oos_period</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="n">param_grid</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                        <span class="n">strategy_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run complete walk-forward analysis.&quot;&quot;&quot;</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_windows</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">is_period</span><span class="p">,</span> <span class="n">oos_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">windows</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Window </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            
            <span class="c1"># Optimize on in-sample</span>
            <span class="n">opt_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_parameters</span><span class="p">(</span>
                <span class="n">window</span><span class="p">[</span><span class="s1">&#39;is_data&#39;</span><span class="p">],</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">strategy_factory</span>
            <span class="p">)</span>
            
            <span class="c1"># Test on out-of-sample with best params</span>
            <span class="n">best_strategy</span> <span class="o">=</span> <span class="n">strategy_factory</span><span class="p">(</span><span class="n">opt_result</span><span class="p">[</span><span class="s1">&#39;best_params&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="n">oos_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">window</span><span class="p">[</span><span class="s1">&#39;oos_data&#39;</span><span class="p">],</span> <span class="n">best_strategy</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;is_dates&#39;</span><span class="p">:</span> <span class="n">window</span><span class="p">[</span><span class="s1">&#39;is_dates&#39;</span><span class="p">],</span>
                <span class="s1">&#39;oos_dates&#39;</span><span class="p">:</span> <span class="n">window</span><span class="p">[</span><span class="s1">&#39;oos_dates&#39;</span><span class="p">],</span>
                <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="n">opt_result</span><span class="p">[</span><span class="s1">&#39;best_params&#39;</span><span class="p">],</span>
                <span class="s1">&#39;is_result&#39;</span><span class="p">:</span> <span class="n">opt_result</span><span class="p">[</span><span class="s1">&#39;best_result&#39;</span><span class="p">],</span>
                <span class="s1">&#39;oos_result&#39;</span><span class="p">:</span> <span class="n">oos_result</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summary</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get walk-forward summary statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">is_returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;is_result&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
        <span class="n">oos_returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;oos_result&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
        
        <span class="c1"># Walk-forward efficiency</span>
        <span class="n">wf_efficiency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">oos_returns</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">is_returns</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">is_returns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;num_windows&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">),</span>
            <span class="s1">&#39;avg_is_return&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">is_returns</span><span class="p">),</span>
            <span class="s1">&#39;avg_oos_return&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">oos_returns</span><span class="p">),</span>
            <span class="s1">&#39;wf_efficiency&#39;</span><span class="p">:</span> <span class="n">wf_efficiency</span><span class="p">,</span>
            <span class="s1">&#39;oos_win_rate&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">oos_returns</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">oos_returns</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;total_oos_return&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">oos_returns</span><span class="p">),</span>
            <span class="s1">&#39;is_oos_correlation&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">is_returns</span><span class="p">,</span> <span class="n">oos_returns</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">is_returns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>

<span class="c1"># Demo walk-forward</span>
<span class="k">def</span> <span class="nf">create_ma_strategy</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Factory to create MA strategy with given parameters.&quot;&quot;&quot;</span>
    <span class="n">fast</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">slow</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">strategy</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">slow</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">fast_ma</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">slow_ma</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prev_fast</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">prev_slow</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">prev_fast</span> <span class="o">&lt;=</span> <span class="n">prev_slow</span> <span class="ow">and</span> <span class="n">fast_ma</span> <span class="o">&gt;</span> <span class="n">slow_ma</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="s1">&#39;stop_pips&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;tp_pips&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">prev_fast</span> <span class="o">&gt;=</span> <span class="n">prev_slow</span> <span class="ow">and</span> <span class="n">fast_ma</span> <span class="o">&lt;</span> <span class="n">slow_ma</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span> <span class="s1">&#39;stop_pips&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;tp_pips&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">return</span> <span class="n">strategy</span>

<span class="c1"># Run walk-forward (smaller dataset for demo)</span>
<span class="n">wfo</span> <span class="o">=</span> <span class="n">WalkForwardOptimizer</span><span class="p">(</span><span class="n">ForexBacktester</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;fast&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
    <span class="s1">&#39;slow&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">wf_results</span> <span class="o">=</span> <span class="n">wfo</span><span class="o">.</span><span class="n">run_walk_forward</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span>
    <span class="n">is_period</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">oos_period</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
    <span class="n">strategy_factory</span><span class="o">=</span><span class="n">create_ma_strategy</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Walk-Forward Results:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">wf_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2></div>
<div class="md-cell"><h3>Exercise 1: Cost-Adjusted Backtester (Guided)</h3>
<p>Complete the <code>CostAdjustedBacktester</code> that properly accounts for all trading costs.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CostAdjustedBacktester</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Backtester with realistic cost modeling.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">calculate_trade_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">exit</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                             <span class="n">lots</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">days_held</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                             <span class="n">spread_pips</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                             <span class="n">swap_per_day</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate all costs for a trade.&quot;&quot;&quot;</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">lots</span>
        
        <span class="c1"># Spread cost</span>
        <span class="n">spread_cost</span> <span class="o">=</span> <span class="n">spread_pips</span> <span class="o">*</span> <span class="n">______</span>
        
        <span class="c1"># Swap cost</span>
        <span class="n">swap_cost</span> <span class="o">=</span> <span class="n">swap_per_day</span> <span class="o">*</span> <span class="n">days_held</span> <span class="o">*</span> <span class="n">pip_value</span>
        
        <span class="c1"># Slippage (assume 0.5 pips each way)</span>
        <span class="n">slippage_cost</span> <span class="o">=</span> <span class="n">______</span> <span class="o">*</span> <span class="n">pip_value</span> <span class="o">*</span> <span class="mi">2</span>
        
        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">spread_cost</span> <span class="o">+</span> <span class="n">swap_cost</span> <span class="o">+</span> <span class="n">slippage_cost</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;spread_cost&#39;</span><span class="p">:</span> <span class="n">spread_cost</span><span class="p">,</span>
            <span class="s1">&#39;swap_cost&#39;</span><span class="p">:</span> <span class="n">swap_cost</span><span class="p">,</span>
            <span class="s1">&#39;slippage_cost&#39;</span><span class="p">:</span> <span class="n">slippage_cost</span><span class="p">,</span>
            <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_net_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gross_pnl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">costs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate net P&amp;L after costs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">gross_pnl</span> <span class="o">-</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;______&#39;</span><span class="p">]</span>

<span class="c1"># Test</span>
<span class="n">bt</span> <span class="o">=</span> <span class="n">CostAdjustedBacktester</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">costs</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">calculate_trade_costs</span><span class="p">(</span><span class="mf">1.0800</span><span class="p">,</span> <span class="mf">1.0830</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">days_held</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trade Costs: </span><span class="si">{</span><span class="n">costs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Net P&amp;L (from 30 pip gain): $</span><span class="si">{</span><span class="n">bt</span><span class="o">.</span><span class="n">calculate_net_pnl</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="n">costs</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 1</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CostAdjustedBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">calculate_trade_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">exit</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">days_held</span><span class="p">,</span>
                             <span class="n">spread_pips</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">swap_per_day</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">pip_value</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">lots</span>

        <span class="n">spread_cost</span> <span class="o">=</span> <span class="n">spread_pips</span> <span class="o">*</span> <span class="n">pip_value</span>
        <span class="n">swap_cost</span> <span class="o">=</span> <span class="n">swap_per_day</span> <span class="o">*</span> <span class="n">days_held</span> <span class="o">*</span> <span class="n">pip_value</span>
        <span class="n">slippage_cost</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">pip_value</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">spread_cost</span> <span class="o">+</span> <span class="n">swap_cost</span> <span class="o">+</span> <span class="n">slippage_cost</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">...</span><span class="p">,</span> <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">calculate_net_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gross_pnl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">costs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gross_pnl</span> <span class="o">-</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;total_cost&#39;</span><span class="p">]</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 2: Margin Tracker (Guided)</h3>
<p>Complete the <code>MarginTracker</code> class for tracking margin during backtests.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MarginTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track margin levels during backtest.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_equity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="n">initial_equity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># symbol -&gt; units</span>
    
    <span class="k">def</span> <span class="nf">get_margin_used</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total margin used.&quot;&quot;&quot;</span>
        <span class="n">total_units</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">______</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">total_units</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
    
    <span class="k">def</span> <span class="nf">get_free_margin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate available margin.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">______</span>
    
    <span class="k">def</span> <span class="nf">get_margin_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate margin level percentage.&quot;&quot;&quot;</span>
        <span class="n">used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_margin_used</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">used</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">100.0</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">/</span> <span class="n">used</span><span class="p">)</span> <span class="o">*</span> <span class="n">______</span>
    
    <span class="k">def</span> <span class="nf">can_open_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">min_margin_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if new position is possible.&quot;&quot;&quot;</span>
        <span class="n">new_margin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_margin_used</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">units</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span><span class="p">)</span>
        <span class="n">new_level</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">/</span> <span class="n">new_margin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">new_margin</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">new_level</span> <span class="o">&gt;=</span> <span class="n">min_margin_level</span>

<span class="c1"># Test</span>
<span class="n">tracker</span> <span class="o">=</span> <span class="n">MarginTracker</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">tracker</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Margin Used: $</span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get_margin_used</span><span class="p">()</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Free Margin: $</span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get_free_margin</span><span class="p">()</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Margin Level: </span><span class="si">{</span><span class="n">tracker</span><span class="o">.</span><span class="n">get_margin_level</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 2</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MarginTracker</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_equity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="n">initial_equity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_margin_used</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">total_units</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">total_units</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>

    <span class="k">def</span> <span class="nf">get_free_margin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_margin_used</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_margin_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_margin_used</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">used</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">100.0</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">/</span> <span class="n">used</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 3: Spread Analyzer (Guided)</h3>
<p>Complete the <code>SpreadAnalyzer</code> for analyzing spread patterns in tick data.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SpreadAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze spread patterns from tick data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">bid</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ask</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add tick data.&quot;&quot;&quot;</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">ask</span> <span class="o">-</span> <span class="n">______</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get spread statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_spread&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">),</span>
            <span class="s1">&#39;median_spread&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">),</span>
            <span class="s1">&#39;max_spread&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">),</span>
            <span class="s1">&#39;min_spread&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">),</span>
            <span class="s1">&#39;std_spread&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_spread_by_hour</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get average spread by hour.&quot;&quot;&quot;</span>
        <span class="n">hourly</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">spread</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">):</span>
            <span class="n">hour</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">______</span>
            <span class="k">if</span> <span class="n">hour</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hourly</span><span class="p">:</span>
                <span class="n">hourly</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">hourly</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spread</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="n">h</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">hourly</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># Test</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">SpreadAnalyzer</span><span class="p">()</span>
<span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]:</span>
    <span class="n">analyzer</span><span class="o">.</span><span class="n">add_tick</span><span class="p">(</span><span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">ask</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spread Statistics: </span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 3</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SpreadAnalyzer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">bid</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ask</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">ask</span> <span class="o">-</span> <span class="n">bid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_spread&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">),</span>
            <span class="o">...</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_spread_by_hour</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">hourly</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">spread</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span><span class="p">):</span>
            <span class="n">hour</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">hour</span>
            <span class="o">...</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 4: Complete Forex Backtester (Open-ended)</h3>
<p>Build a full-featured forex backtester with all realistic components.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4: Complete Forex Backtester (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class FullForexBacktester</span>
<span class="c1"># 2. Track: equity, balance, margin, open/closed trades</span>
<span class="c1"># 3. Include all costs: spread, swap, slippage, commission</span>
<span class="c1"># 4. Handle margin calls (close all if equity &lt; margin)</span>
<span class="c1"># 5. Support multiple open positions</span>
<span class="c1"># 6. Calculate comprehensive statistics</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 4</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FullForexBacktester</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">,</span> <span class="n">leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">=</span> <span class="n">capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin_used</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed_trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">costs</span> <span class="o">=</span> <span class="n">CostCalculator</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">open_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">margin</span> <span class="o">=</span> <span class="n">units</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_used</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Apply entry slippage</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">costs</span><span class="o">.</span><span class="n">get_costs</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">slip</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">slippage_pips</span> <span class="o">*</span> <span class="mf">0.0001</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">+</span> <span class="n">slip</span> <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="n">entry</span> <span class="o">-</span> <span class="n">slip</span>

        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                 <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span> <span class="s1">&#39;tp&#39;</span><span class="p">:</span> <span class="n">tp</span><span class="p">,</span> <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin_used</span> <span class="o">+=</span> <span class="n">margin</span>
        <span class="k">return</span> <span class="n">trade</span>

    <span class="k">def</span> <span class="nf">close_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">,</span> <span class="n">exit_price</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">costs</span><span class="o">.</span><span class="n">get_costs</span><span class="p">(</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">])</span>
        <span class="c1"># Apply exit costs and calculate PnL</span>
        <span class="c1"># ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">pnl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin_used</span> <span class="o">-=</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed_trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_margin_call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_used</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_trades</span><span class="p">[:]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="s1">&#39;margin_call&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Calculate win rate, profit factor, max DD, etc.</span>
        <span class="k">pass</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 5: Monte Carlo Simulator (Open-ended)</h3>
<p>Build a Monte Carlo simulator to test strategy robustness.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 5: Monte Carlo Simulator (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class MonteCarloSimulator</span>
<span class="c1"># 2. Take backtest trade results as input</span>
<span class="c1"># 3. Randomly resample trades to create N simulations</span>
<span class="c1"># 4. Calculate distribution of final equity</span>
<span class="c1"># 5. Calculate probability of ruin (equity &lt; X%)</span>
<span class="c1"># 6. Generate confidence intervals for returns</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 5</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MonteCarloSimulator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="n">trade_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">initial_capital</span>

    <span class="k">def</span> <span class="nf">run_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">final_equities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_drawdowns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
            <span class="c1"># Randomly resample trades</span>
            <span class="n">sampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Calculate equity curve</span>
            <span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">equity</span>
            <span class="n">max_dd</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">pnl</span> <span class="ow">in</span> <span class="n">sampled</span><span class="p">:</span>
                <span class="n">equity</span> <span class="o">+=</span> <span class="n">pnl</span>
                <span class="k">if</span> <span class="n">equity</span> <span class="o">&gt;</span> <span class="n">peak</span><span class="p">:</span>
                    <span class="n">peak</span> <span class="o">=</span> <span class="n">equity</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="n">equity</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
                <span class="n">max_dd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_dd</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span>

            <span class="n">final_equities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>
            <span class="n">max_drawdowns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;mean_equity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">final_equities</span><span class="p">),</span>
            <span class="s1">&#39;median_equity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">final_equities</span><span class="p">),</span>
            <span class="s1">&#39;std_equity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">final_equities</span><span class="p">),</span>
            <span class="s1">&#39;percentile_5&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">final_equities</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s1">&#39;percentile_95&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">final_equities</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
            <span class="s1">&#39;prob_profit&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">final_equities</span> <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_simulations</span><span class="p">,</span>
            <span class="s1">&#39;prob_ruin&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">final_equities</span> <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_simulations</span><span class="p">,</span>
            <span class="s1">&#39;avg_max_dd&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">max_drawdowns</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>Exercise 6: Walk-Forward Report Generator (Open-ended)</h3>
<p>Build a comprehensive walk-forward analysis report generator.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 6: Walk-Forward Report Generator (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Requirements:</span>
<span class="c1"># 1. Create class WalkForwardReporter</span>
<span class="c1"># 2. Take walk-forward results as input</span>
<span class="c1"># 3. Calculate WF efficiency (OOS return / IS return)</span>
<span class="c1"># 4. Track parameter stability across windows</span>
<span class="c1"># 5. Identify degradation trends</span>
<span class="c1"># 6. Generate pass/fail verdict on strategy robustness</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Solution 6</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WalkForwardReporter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wf_results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">wf_results</span>

    <span class="k">def</span> <span class="nf">calculate_wf_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">is_returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;is_result&#39;</span><span class="p">][</span><span class="s1">&#39;return_pct&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
        <span class="n">oos_returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;oos_result&#39;</span><span class="p">][</span><span class="s1">&#39;return_pct&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">oos_returns</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">is_returns</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">is_returns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">analyze_parameter_stability</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">params_by_window</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;best_params&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
        <span class="c1"># Check how often parameters change</span>
        <span class="n">stability</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params_by_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params_by_window</span><span class="p">]</span>
            <span class="n">stability</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;unique_values&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
                <span class="s1">&#39;most_common&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">count</span><span class="p">),</span>
                <span class="s1">&#39;stability_score&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">stability</span>

    <span class="k">def</span> <span class="nf">detect_degradation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">oos_returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;oos_result&#39;</span><span class="p">][</span><span class="s1">&#39;return_pct&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
        <span class="c1"># Check if returns are trending down</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oos_returns</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oos_returns</span><span class="p">)),</span> <span class="n">oos_returns</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">trend</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Significant negative trend</span>

    <span class="k">def</span> <span class="nf">get_verdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">wf_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_wf_efficiency</span><span class="p">()</span>
        <span class="n">degrading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_degradation</span><span class="p">()</span>
        <span class="n">oos_wins</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;oos_result&#39;</span><span class="p">][</span><span class="s1">&#39;return_pct&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">passed</span> <span class="o">=</span> <span class="n">wf_eff</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">degrading</span> <span class="ow">and</span> <span class="n">oos_wins</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;verdict&#39;</span><span class="p">:</span> <span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="n">passed</span> <span class="k">else</span> <span class="s1">&#39;FAIL&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wf_efficiency&#39;</span><span class="p">:</span> <span class="n">wf_eff</span><span class="p">,</span>
            <span class="s1">&#39;degrading&#39;</span><span class="p">:</span> <span class="n">degrading</span><span class="p">,</span>
            <span class="s1">&#39;oos_win_rate&#39;</span><span class="p">:</span> <span class="n">oos_wins</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;reasons&#39;</span><span class="p">:</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">passed</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_failure_reasons</span><span class="p">(</span><span class="n">wf_eff</span><span class="p">,</span> <span class="n">degrading</span><span class="p">,</span> <span class="n">oos_wins</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Forex/Futures Backtester</h2>
<p>Build a production-ready backtesting system with all features.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ProductionBacktester</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready forex/futures backtesting system.</span>
<span class="sd">    </span>
<span class="sd">    Features: Realistic costs, Margin tracking, Walk-forward,</span>
<span class="sd">    Monte Carlo analysis, Comprehensive reporting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
                 <span class="n">leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">risk_per_trade</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_per_trade</span> <span class="o">=</span> <span class="n">risk_per_trade</span>
        
        <span class="c1"># Core backtester</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span> <span class="o">=</span> <span class="n">ForexBacktester</span><span class="p">(</span><span class="n">initial_capital</span><span class="p">,</span> <span class="n">leverage</span><span class="p">,</span> <span class="n">risk_per_trade</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_calc</span> <span class="o">=</span> <span class="n">CostCalculator</span><span class="p">()</span>
        
        <span class="c1"># Results storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wf_results</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc_results</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">run_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
                    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run standard backtest.&quot;&quot;&quot;</span>
        <span class="c1"># Set costs for symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">cost_calculator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_calc</span>
        
        <span class="c1"># Run backtest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
        
        <span class="c1"># Add cost analysis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">:</span>
            <span class="n">total_spread_cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cost_calc</span><span class="o">.</span><span class="n">get_costs</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">spread_pips</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">units</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">closed_trades</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="p">[</span><span class="s1">&#39;total_spread_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_spread_cost</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span>
    
    <span class="k">def</span> <span class="nf">run_walk_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                        <span class="n">param_grid</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">strategy_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
                        <span class="n">is_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">oos_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run walk-forward optimization.&quot;&quot;&quot;</span>
        <span class="n">wfo</span> <span class="o">=</span> <span class="n">WalkForwardOptimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wf_results</span> <span class="o">=</span> <span class="n">wfo</span><span class="o">.</span><span class="n">run_walk_forward</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">is_period</span><span class="p">,</span> <span class="n">oos_period</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">strategy_factory</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf_results</span>
    
    <span class="k">def</span> <span class="nf">run_monte_carlo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run Monte Carlo analysis on backtest results.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No trades to analyze&#39;</span><span class="p">}</span>
        
        <span class="n">pnls</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtester</span><span class="o">.</span><span class="n">closed_trades</span><span class="p">]</span>
        
        <span class="n">final_equities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_drawdowns</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
            <span class="n">sampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">pnls</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pnls</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">equity</span>
            <span class="n">max_dd</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="k">for</span> <span class="n">pnl</span> <span class="ow">in</span> <span class="n">sampled</span><span class="p">:</span>
                <span class="n">equity</span> <span class="o">+=</span> <span class="n">pnl</span>
                <span class="k">if</span> <span class="n">equity</span> <span class="o">&gt;</span> <span class="n">peak</span><span class="p">:</span>
                    <span class="n">peak</span> <span class="o">=</span> <span class="n">equity</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="n">equity</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">max_dd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_dd</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span>
            
            <span class="n">final_equities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">equity</span><span class="p">)</span>
            <span class="n">max_drawdowns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mc_results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean_equity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">final_equities</span><span class="p">),</span>
            <span class="s1">&#39;median_equity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">final_equities</span><span class="p">),</span>
            <span class="s1">&#39;percentile_5&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">final_equities</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s1">&#39;percentile_95&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">final_equities</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
            <span class="s1">&#39;prob_profit&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">final_equities</span> <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_simulations</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;prob_ruin_50pct&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">final_equities</span> <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_simulations</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;avg_max_drawdown&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">max_drawdowns</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_results</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive backtest report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  BACKTEST REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        
        <span class="c1"># Backtest Results</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BACKTEST RESULTS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Capital: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Equity: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;final_equity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Return: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Trades: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_trades&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win Rate: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Profit Factor: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profit_factor&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">backtest_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="c1"># Walk-Forward Results</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf_results</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WALK-FORWARD ANALYSIS&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Windows Tested: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wf_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_windows&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avg IS Return: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wf_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avg_is_return&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avg OOS Return: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wf_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avg_oos_return&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WF Efficiency: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wf_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_efficiency&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OOS Win Rate: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wf_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oos_win_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="c1"># Monte Carlo Results</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc_results</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MONTE CARLO ANALYSIS&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Final Equity: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean_equity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;5th Percentile: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percentile_5&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95th Percentile: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percentile_95&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Probability of Profit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prob_profit&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Probability of 50% Ruin: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prob_ruin_50pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demo the production backtester</span>
<span class="n">prod_bt</span> <span class="o">=</span> <span class="n">ProductionBacktester</span><span class="p">(</span><span class="n">initial_capital</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">risk_per_trade</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># Run standard backtest</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running backtest...&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">prod_bt</span><span class="o">.</span><span class="n">run_backtest</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">ma_strategy</span><span class="p">,</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">)</span>

<span class="c1"># Run walk-forward</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running walk-forward analysis...&quot;</span><span class="p">)</span>
<span class="n">wf</span> <span class="o">=</span> <span class="n">prod_bt</span><span class="o">.</span><span class="n">run_walk_forward</span><span class="p">(</span>
    <span class="n">prices</span><span class="p">,</span> 
    <span class="n">param_grid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fast&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="s1">&#39;slow&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]},</span>
    <span class="n">strategy_factory</span><span class="o">=</span><span class="n">create_ma_strategy</span><span class="p">,</span>
    <span class="n">is_period</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">oos_period</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)</span>

<span class="c1"># Run Monte Carlo</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running Monte Carlo analysis...&quot;</span><span class="p">)</span>
<span class="n">mc</span> <span class="o">=</span> <span class="n">prod_bt</span><span class="o">.</span><span class="n">run_monte_carlo</span><span class="p">(</span><span class="n">n_simulations</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="c1"># Generate report</span>
<span class="n">prod_bt</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ul>
<li><strong>Realistic Costs</strong>: Include spread, swap, slippage, and commission in all backtests</li>
<li><strong>Break-Even</strong>: Calculate minimum pips needed to cover costs before expecting profit</li>
<li><strong>Margin Tracking</strong>: Monitor margin usage to avoid margin calls; keep under 50%</li>
<li><strong>Tick Data</strong>: Most accurate simulation; captures variable spreads and real execution</li>
<li><strong>Walk-Forward</strong>: Validates strategy robustness; aim for &gt;50% WF efficiency</li>
<li><strong>Parameter Stability</strong>: Stable optimal parameters across windows indicate robustness</li>
<li><strong>Monte Carlo</strong>: Test distribution of outcomes; understand probability of ruin</li>
<li><strong>Over-Optimization</strong>: Beware curve-fitting; out-of-sample results matter most</li>
</ul>
<p><strong>Next: Module 11 - Live Trading</strong> where we'll build systems for real-world execution.</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="11"><div class="md-cell module-header"><h1>Module 11: Live Trading</h1>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Skill Level</strong></td>
<td>Advanced</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Modules 9-10</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:
- Evaluate and select appropriate forex/futures brokers
- Execute trades programmatically via OANDA API
- Integrate with MetaTrader platforms
- Design systems for 24-hour continuous operation</p>
<h2>Prerequisites</h2>
<ul>
<li>Completed Modules 9 (Risk Management) and 10 (Backtesting)</li>
<li>Understanding of order types and position management</li>
<li>Familiarity with REST APIs</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 11.1: Broker Selection</h2>
<p>Choosing the right broker is critical for live trading success.</p></div>
<div class="md-cell"><h3>Forex Broker Considerations</h3>
<p><strong>Key Factors:</strong>
- <strong>Regulation</strong>: FCA (UK), NFA/CFTC (US), ASIC (Australia)
- <strong>Spreads</strong>: Variable vs fixed, typical vs minimum
- <strong>Execution</strong>: Market maker vs ECN/STP
- <strong>API Access</strong>: REST, FIX, proprietary
- <strong>Leverage</strong>: Varies by jurisdiction (50:1 US, 30:1 EU)</p>
<p><strong>Popular Forex Brokers with API:</strong>
- OANDA (REST API, well-documented)
- Interactive Brokers (comprehensive but complex)
- IG Markets (REST API)
- Saxo Bank (OpenAPI)</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BrokerProfile</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Broker evaluation profile.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">regulation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">typical_spread_eurusd</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># in pips</span>
    <span class="n">min_deposit</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">max_leverage</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">commission_per_lot</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="k">def</span> <span class="nf">total_cost_per_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lot_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total cost including spread and commission.&quot;&quot;&quot;</span>
        <span class="n">spread_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typical_spread_eurusd</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">lot_size</span>  <span class="c1"># $10 per pip per lot</span>
        <span class="n">commission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission_per_lot</span> <span class="o">*</span> <span class="n">lot_size</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># round trip</span>
        <span class="k">return</span> <span class="n">spread_cost</span> <span class="o">+</span> <span class="n">commission</span>


<span class="k">class</span> <span class="nc">BrokerComparator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compare brokers for trading suitability.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brokers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BrokerProfile</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">add_broker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">:</span> <span class="n">BrokerProfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add broker to comparison.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brokers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">broker</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">compare_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monthly_lots</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compare monthly trading costs.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">broker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">brokers</span><span class="p">:</span>
            <span class="n">cost_per_trade</span> <span class="o">=</span> <span class="n">broker</span><span class="o">.</span><span class="n">total_cost_per_trade</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">monthly_cost</span> <span class="o">=</span> <span class="n">cost_per_trade</span> <span class="o">*</span> <span class="n">monthly_lots</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Broker&#39;</span><span class="p">:</span> <span class="n">broker</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;Spread (pips)&#39;</span><span class="p">:</span> <span class="n">broker</span><span class="o">.</span><span class="n">typical_spread_eurusd</span><span class="p">,</span>
                <span class="s1">&#39;Commission/lot&#39;</span><span class="p">:</span> <span class="n">broker</span><span class="o">.</span><span class="n">commission_per_lot</span><span class="p">,</span>
                <span class="s1">&#39;Cost per lot&#39;</span><span class="p">:</span> <span class="n">cost_per_trade</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;Monthly (</span><span class="si">{</span><span class="n">monthly_lots</span><span class="si">}</span><span class="s1"> lots)&#39;</span><span class="p">:</span> <span class="n">monthly_cost</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Monthly (</span><span class="si">{</span><span class="n">monthly_lots</span><span class="si">}</span><span class="s1"> lots)&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">filter_by_regulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BrokerProfile</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Filter brokers by regulation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">brokers</span> 
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">reg</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">regulation</span> <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">required</span><span class="p">)</span>
        <span class="p">]</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Example broker comparison</span>
<span class="n">comparator</span> <span class="o">=</span> <span class="n">BrokerComparator</span><span class="p">()</span>

<span class="n">comparator</span><span class="o">.</span><span class="n">add_broker</span><span class="p">(</span><span class="n">BrokerProfile</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;OANDA&quot;</span><span class="p">,</span>
    <span class="n">regulation</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;FCA&quot;</span><span class="p">,</span> <span class="s2">&quot;NFA&quot;</span><span class="p">,</span> <span class="s2">&quot;ASIC&quot;</span><span class="p">],</span>
    <span class="n">typical_spread_eurusd</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">min_deposit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">max_leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">api_type</span><span class="o">=</span><span class="s2">&quot;REST&quot;</span>
<span class="p">))</span>

<span class="n">comparator</span><span class="o">.</span><span class="n">add_broker</span><span class="p">(</span><span class="n">BrokerProfile</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Interactive Brokers&quot;</span><span class="p">,</span>
    <span class="n">regulation</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SEC&quot;</span><span class="p">,</span> <span class="s2">&quot;FCA&quot;</span><span class="p">,</span> <span class="s2">&quot;ASIC&quot;</span><span class="p">],</span>
    <span class="n">typical_spread_eurusd</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">min_deposit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">max_leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">api_type</span><span class="o">=</span><span class="s2">&quot;TWS/REST&quot;</span><span class="p">,</span>
    <span class="n">commission_per_lot</span><span class="o">=</span><span class="mf">2.0</span>
<span class="p">))</span>

<span class="n">comparator</span><span class="o">.</span><span class="n">add_broker</span><span class="p">(</span><span class="n">BrokerProfile</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ECN Broker&quot;</span><span class="p">,</span>
    <span class="n">regulation</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;FCA&quot;</span><span class="p">],</span>
    <span class="n">typical_spread_eurusd</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">min_deposit</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">max_leverage</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">api_type</span><span class="o">=</span><span class="s2">&quot;FIX&quot;</span><span class="p">,</span>
    <span class="n">commission_per_lot</span><span class="o">=</span><span class="mf">3.5</span>
<span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Broker Cost Comparison (10 lots/month):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparator</span><span class="o">.</span><span class="n">compare_costs</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h3>Futures Broker Considerations</h3>
<p>Futures brokers have different characteristics:
- <strong>Exchange access</strong>: CME, ICE, Eurex
- <strong>Commission structure</strong>: Per-contract fees
- <strong>Margin rates</strong>: Day trading vs overnight
- <strong>Platform</strong>: CQG, Rithmic, TT</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span> 
<span class="k">class</span> <span class="nc">FuturesBrokerProfile</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Futures broker profile.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">exchanges</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">commission_per_contract</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">platform</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">day_margin_es</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># E-mini S&amp;P day margin</span>
    <span class="n">overnight_margin_es</span><span class="p">:</span> <span class="nb">float</span>
    
    <span class="k">def</span> <span class="nf">annual_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contracts_per_day</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">trading_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate annual commission costs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission_per_contract</span> <span class="o">*</span> <span class="n">contracts_per_day</span> <span class="o">*</span> <span class="n">trading_days</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># round trip</span>


<span class="c1"># Compare futures brokers</span>
<span class="n">futures_brokers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FuturesBrokerProfile</span><span class="p">(</span><span class="s2">&quot;AMP Futures&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;CME&quot;</span><span class="p">,</span> <span class="s2">&quot;ICE&quot;</span><span class="p">],</span> <span class="mf">0.59</span><span class="p">,</span> <span class="s2">&quot;Various&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">13200</span><span class="p">),</span>
    <span class="n">FuturesBrokerProfile</span><span class="p">(</span><span class="s2">&quot;NinjaTrader&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;CME&quot;</span><span class="p">,</span> <span class="s2">&quot;ICE&quot;</span><span class="p">],</span> <span class="mf">0.53</span><span class="p">,</span> <span class="s2">&quot;NinjaTrader&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">13200</span><span class="p">),</span>
    <span class="n">FuturesBrokerProfile</span><span class="p">(</span><span class="s2">&quot;Interactive Brokers&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;CME&quot;</span><span class="p">,</span> <span class="s2">&quot;ICE&quot;</span><span class="p">,</span> <span class="s2">&quot;Eurex&quot;</span><span class="p">],</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;TWS&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">13200</span><span class="p">),</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Futures Broker Annual Costs (10 contracts/day):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">broker</span> <span class="ow">in</span> <span class="n">futures_brokers</span><span class="p">:</span>
    <span class="n">annual</span> <span class="o">=</span> <span class="n">broker</span><span class="o">.</span><span class="n">annual_cost</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">broker</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">annual</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 11.2: OANDA Order Execution</h2>
<p>OANDA provides a well-documented REST API for forex trading.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">OrderType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">MARKET</span> <span class="o">=</span> <span class="s2">&quot;MARKET&quot;</span>
    <span class="n">LIMIT</span> <span class="o">=</span> <span class="s2">&quot;LIMIT&quot;</span>
    <span class="n">STOP</span> <span class="o">=</span> <span class="s2">&quot;STOP&quot;</span>
    <span class="n">MARKET_IF_TOUCHED</span> <span class="o">=</span> <span class="s2">&quot;MARKET_IF_TOUCHED&quot;</span>


<span class="k">class</span> <span class="nc">OrderSide</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">BUY</span> <span class="o">=</span> <span class="s2">&quot;BUY&quot;</span>
    <span class="n">SELL</span> <span class="o">=</span> <span class="s2">&quot;SELL&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">OrderRequest</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Order request structure.&quot;&quot;&quot;</span>
    <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">units</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># positive for buy, negative for sell</span>
    <span class="n">order_type</span><span class="p">:</span> <span class="n">OrderType</span>
    <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stop_loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">take_profit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">trailing_stop_distance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">time_in_force</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GTC&quot;</span>  <span class="c1"># Good Till Cancelled</span>
    
    <span class="k">def</span> <span class="nf">to_api_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert to OANDA API format.&quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s2">&quot;instrument&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
            <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">),</span>
            <span class="s2">&quot;timeInForce&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_in_force</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">!=</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">:</span>
            <span class="n">order</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">:</span>
            <span class="n">order</span><span class="p">[</span><span class="s2">&quot;stopLossOnFill&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">)}</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">take_profit</span><span class="p">:</span>
            <span class="n">order</span><span class="p">[</span><span class="s2">&quot;takeProfitOnFill&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">take_profit</span><span class="p">)}</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_distance</span><span class="p">:</span>
            <span class="n">order</span><span class="p">[</span><span class="s2">&quot;trailingStopLossOnFill&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;distance&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_distance</span><span class="p">)</span>
            <span class="p">}</span>
            
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Position</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trading position.&quot;&quot;&quot;</span>
    <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">units</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">average_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">unrealized_pnl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">side</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;LONG&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;SHORT&quot;</span>


<span class="k">class</span> <span class="nc">OANDAClient</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simulated OANDA API client for demonstration.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">practice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_id</span> <span class="o">=</span> <span class="n">account_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">practice</span> <span class="o">=</span> <span class="n">practice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://api-fxpractice.oanda.com&quot;</span> <span class="k">if</span> <span class="n">practice</span> <span class="k">else</span> <span class="s2">&quot;https://api-fxtrade.oanda.com&quot;</span>
        
        <span class="c1"># Simulated state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_balance</span> <span class="o">=</span> <span class="mf">100000.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Position</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_id</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;EUR_USD&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0850</span><span class="p">,</span> <span class="mf">1.0852</span><span class="p">),</span>  <span class="c1"># bid, ask</span>
            <span class="s2">&quot;GBP_USD&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.2650</span><span class="p">,</span> <span class="mf">1.2653</span><span class="p">),</span>
            <span class="s2">&quot;USD_JPY&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">149.50</span><span class="p">,</span> <span class="mf">149.53</span><span class="p">),</span>
        <span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">get_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Get current bid/ask prices.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">inst</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_account</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get account summary.&quot;&quot;&quot;</span>
        <span class="n">unrealized</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">unrealized_pnl</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;account_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span>
            <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_balance</span><span class="p">,</span>
            <span class="s2">&quot;unrealized_pnl&quot;</span><span class="p">:</span> <span class="n">unrealized</span><span class="p">,</span>
            <span class="s2">&quot;nav&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_balance</span> <span class="o">+</span> <span class="n">unrealized</span><span class="p">,</span>
            <span class="s2">&quot;margin_used&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">units</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">average_price</span> <span class="o">/</span> <span class="mi">50</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">submit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">OrderRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit an order.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_id</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Get fill price</span>
        <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">fill_price</span> <span class="o">=</span> <span class="n">ask</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">units</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">bid</span>
        
        <span class="c1"># Update position</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">instrument</span><span class="p">]</span>
            <span class="n">new_units</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">units</span> <span class="o">+</span> <span class="n">order</span><span class="o">.</span><span class="n">units</span>
            <span class="k">if</span> <span class="n">new_units</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">instrument</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">new_units</span>
                <span class="n">pos</span><span class="o">.</span><span class="n">average_price</span> <span class="o">=</span> <span class="n">fill_price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">instrument</span><span class="p">]</span> <span class="o">=</span> <span class="n">Position</span><span class="p">(</span>
                <span class="n">instrument</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
                <span class="n">average_price</span><span class="o">=</span><span class="n">fill_price</span>
            <span class="p">)</span>
            
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;order_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_id</span><span class="p">),</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;FILLED&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fill_price&quot;</span><span class="p">:</span> <span class="n">fill_price</span><span class="p">,</span>
            <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="s2">&quot;instrument&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">instrument</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Position</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all open positions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">close_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close a position.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">instrument</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No position found&quot;</span><span class="p">}</span>
            
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span>
        <span class="n">close_order</span> <span class="o">=</span> <span class="n">OrderRequest</span><span class="p">(</span>
            <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=-</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="n">order_type</span><span class="o">=</span><span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span><span class="n">close_order</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate OANDA client usage</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">OANDAClient</span><span class="p">(</span><span class="s2">&quot;101-001-12345678-001&quot;</span><span class="p">,</span> <span class="n">practice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Check account</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Account Summary:&quot;</span><span class="p">)</span>
<span class="n">account</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">account</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Get prices</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current Prices:&quot;</span><span class="p">)</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_prices</span><span class="p">([</span><span class="s2">&quot;EUR_USD&quot;</span><span class="p">,</span> <span class="s2">&quot;GBP_USD&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">inst</span><span class="p">,</span> <span class="p">(</span><span class="n">bid</span><span class="p">,</span> <span class="n">ask</span><span class="p">)</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">inst</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">bid</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ask</span><span class="si">}</span><span class="s2"> (spread: </span><span class="si">{</span><span class="p">(</span><span class="n">ask</span><span class="o">-</span><span class="n">bid</span><span class="p">)</span><span class="o">*</span><span class="mi">10000</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> pips)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Submit a market order with stop loss and take profit</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">OrderRequest</span><span class="p">(</span>
    <span class="n">instrument</span><span class="o">=</span><span class="s2">&quot;EUR_USD&quot;</span><span class="p">,</span>
    <span class="n">units</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>  <span class="c1"># 0.1 lot long</span>
    <span class="n">order_type</span><span class="o">=</span><span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">,</span>
    <span class="n">stop_loss</span><span class="o">=</span><span class="mf">1.0800</span><span class="p">,</span>
    <span class="n">take_profit</span><span class="o">=</span><span class="mf">1.0950</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Order Request (API format):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">to_api_format</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Submitting order...&quot;</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Open Positions:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">get_positions</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">pos</span><span class="o">.</span><span class="n">instrument</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">pos</span><span class="o">.</span><span class="n">average_price</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">pos</span><span class="o">.</span><span class="n">side</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 11.3: MetaTrader Integration</h2>
<p>MetaTrader 4/5 are popular retail trading platforms with Python integration options.</p></div>
<div class="md-cell"><h3>MetaTrader Overview</h3>
<p><strong>MT4 vs MT5:</strong>
- MT4: Older, forex-focused, MQL4 language
- MT5: Newer, multi-asset, MQL5, better Python support</p>
<p><strong>Python Integration Methods:</strong>
1. <strong>MetaTrader5 package</strong>: Official Python library (MT5 only)
2. <strong>ZeroMQ bridge</strong>: Connect via Expert Advisor
3. <strong>File-based</strong>: Read/write files for communication
4. <strong>REST bridge</strong>: Third-party REST API wrappers</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MT5Simulator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simulated MetaTrader 5 interface.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_account_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="mi">12345678</span><span class="p">,</span>
            <span class="s1">&#39;server&#39;</span><span class="p">:</span> <span class="s1">&#39;Demo-Server&#39;</span><span class="p">,</span>
            <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="mf">100000.0</span><span class="p">,</span>
            <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="mf">100000.0</span><span class="p">,</span>
            <span class="s1">&#39;margin&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;margin_free&#39;</span><span class="p">:</span> <span class="mf">100000.0</span><span class="p">,</span>
            <span class="s1">&#39;leverage&#39;</span><span class="p">:</span> <span class="mi">100</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ticket</span> <span class="o">=</span> <span class="mi">1000000</span>
        
        <span class="c1"># Simulated symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="mf">1.0850</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="mf">1.0852</span><span class="p">,</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
            <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="mf">1.2650</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="mf">1.2653</span><span class="p">,</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
            <span class="s1">&#39;USDJPY&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="mf">149.50</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="mf">149.53</span><span class="p">,</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s1">&#39;digits&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
        <span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize connection to MT5.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MT5 initialized (simulated)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shutdown MT5 connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">account_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get account information.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_account_info</span>
    
    <span class="k">def</span> <span class="nf">symbol_info_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current tick for symbol.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbols</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">order_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send a trading order.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;retcode&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Not initialized&#39;</span><span class="p">}</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_ticket</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">symbol</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">order_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 0=BUY, 1=SELL</span>
        
        <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol_info_tick</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tick</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;retcode&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid symbol&#39;</span><span class="p">}</span>
            
        <span class="n">price</span> <span class="o">=</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;retcode&#39;</span><span class="p">:</span> <span class="mi">10009</span><span class="p">,</span>  <span class="c1"># TRADE_RETCODE_DONE</span>
            <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ticket</span><span class="p">,</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">volume</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Order executed&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">positions_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get open positions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_positions</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MT5Trader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;High-level MT5 trading interface.&quot;&quot;&quot;</span>
    
    <span class="c1"># Order type constants</span>
    <span class="n">ORDER_TYPE_BUY</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ORDER_TYPE_SELL</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ORDER_TYPE_BUY_LIMIT</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">ORDER_TYPE_SELL_LIMIT</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ORDER_TYPE_BUY_STOP</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">ORDER_TYPE_SELL_STOP</span> <span class="o">=</span> <span class="mi">5</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mt5</span> <span class="o">=</span> <span class="n">MT5Simulator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Connect to MetaTrader 5.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt5</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt5</span><span class="o">.</span><span class="n">account_info</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connected to account </span><span class="si">{</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;login&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Balance: $</span><span class="si">{</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">, Leverage: 1:</span><span class="si">{</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;leverage&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disconnect from MT5.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mt5</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get bid/ask price.&quot;&quot;&quot;</span>
        <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt5</span><span class="o">.</span><span class="n">symbol_info_tick</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tick</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span> <span class="n">tick</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Place a buy order.&quot;&quot;&quot;</span>
        <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ask</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Could not get price&#39;</span><span class="p">}</span>
            
        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># TRADE_ACTION_DEAL</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">volume</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_TYPE_BUY</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">ask</span><span class="p">,</span>
            <span class="s1">&#39;deviation&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;magic&#39;</span><span class="p">:</span> <span class="mi">123456</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Python MT5 order&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">sl</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;sl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span>
        <span class="k">if</span> <span class="n">tp</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;tp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt5</span><span class="o">.</span><span class="n">order_send</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Place a sell order.&quot;&quot;&quot;</span>
        <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bid</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Could not get price&#39;</span><span class="p">}</span>
            
        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">volume</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ORDER_TYPE_SELL</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">bid</span><span class="p">,</span>
            <span class="s1">&#39;deviation&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;magic&#39;</span><span class="p">:</span> <span class="mi">123456</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Python MT5 order&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">sl</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;sl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sl</span>
        <span class="k">if</span> <span class="n">tp</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;tp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt5</span><span class="o">.</span><span class="n">order_send</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate MT5 trading</span>
<span class="n">trader</span> <span class="o">=</span> <span class="n">MT5Trader</span><span class="p">()</span>

<span class="k">if</span> <span class="n">trader</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
    <span class="c1"># Get price</span>
    <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;EURUSD&quot;</span>
    <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span> <span class="o">=</span> <span class="n">trader</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: Bid=</span><span class="si">{</span><span class="n">bid</span><span class="si">}</span><span class="s2">, Ask=</span><span class="si">{</span><span class="n">ask</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Place buy order</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">trader</span><span class="o">.</span><span class="n">buy</span><span class="p">(</span>
        <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
        <span class="n">volume</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">sl</span><span class="o">=</span><span class="n">bid</span> <span class="o">-</span> <span class="mf">0.0050</span><span class="p">,</span>  <span class="c1"># 50 pip stop</span>
        <span class="n">tp</span><span class="o">=</span><span class="n">bid</span> <span class="o">+</span> <span class="mf">0.0100</span>   <span class="c1"># 100 pip target</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Buy order result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">trader</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 11.4: Continuous Operation</h2>
<p>Forex markets trade 24 hours, requiring robust systems for continuous operation.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TradingSession</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Global trading sessions.&quot;&quot;&quot;</span>
    <span class="n">SYDNEY</span> <span class="o">=</span> <span class="s2">&quot;Sydney&quot;</span>
    <span class="n">TOKYO</span> <span class="o">=</span> <span class="s2">&quot;Tokyo&quot;</span>
    <span class="n">LONDON</span> <span class="o">=</span> <span class="s2">&quot;London&quot;</span>
    <span class="n">NEW_YORK</span> <span class="o">=</span> <span class="s2">&quot;New York&quot;</span>


<span class="k">class</span> <span class="nc">SessionMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor trading sessions and market hours.&quot;&quot;&quot;</span>
    
    <span class="c1"># Session times in UTC</span>
    <span class="n">SESSIONS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">TradingSession</span><span class="o">.</span><span class="n">SYDNEY</span><span class="p">:</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>    <span class="c1"># 21:00 - 06:00 UTC</span>
        <span class="n">TradingSession</span><span class="o">.</span><span class="n">TOKYO</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>      <span class="c1"># 00:00 - 09:00 UTC</span>
        <span class="n">TradingSession</span><span class="o">.</span><span class="n">LONDON</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>    <span class="c1"># 07:00 - 16:00 UTC</span>
        <span class="n">TradingSession</span><span class="o">.</span><span class="n">NEW_YORK</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span> <span class="c1"># 12:00 - 21:00 UTC</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_active_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TradingSession</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get currently active trading sessions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">utc_hour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utc_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span>
            
        <span class="n">active</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">session</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SESSIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">active</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Crosses midnight</span>
                <span class="k">if</span> <span class="n">utc_hour</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
                    <span class="n">active</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">active</span>
    
    <span class="k">def</span> <span class="nf">is_weekend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if market is closed for weekend.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        
        <span class="c1"># Forex closes Friday 21:00 UTC, opens Sunday 21:00 UTC</span>
        <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Saturday</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">:</span>  <span class="c1"># Sunday before open</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="mi">21</span><span class="p">:</span>  <span class="c1"># Friday after close</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">get_session_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Identify high-liquidity session overlaps.&quot;&quot;&quot;</span>
        <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_sessions</span><span class="p">(</span><span class="n">utc_hour</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">TradingSession</span><span class="o">.</span><span class="n">LONDON</span> <span class="ow">in</span> <span class="n">active</span> <span class="ow">and</span> <span class="n">TradingSession</span><span class="o">.</span><span class="n">NEW_YORK</span> <span class="ow">in</span> <span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;London-NY Overlap (Highest Liquidity)&quot;</span>
        <span class="k">elif</span> <span class="n">TradingSession</span><span class="o">.</span><span class="n">TOKYO</span> <span class="ow">in</span> <span class="n">active</span> <span class="ow">and</span> <span class="n">TradingSession</span><span class="o">.</span><span class="n">LONDON</span> <span class="ow">in</span> <span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Tokyo-London Overlap&quot;</span>
        <span class="k">elif</span> <span class="n">TradingSession</span><span class="o">.</span><span class="n">SYDNEY</span> <span class="ow">in</span> <span class="n">active</span> <span class="ow">and</span> <span class="n">TradingSession</span><span class="o">.</span><span class="n">TOKYO</span> <span class="ow">in</span> <span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Sydney-Tokyo Overlap&quot;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">active</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> Session Only&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Low Liquidity Period&quot;</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate session monitoring</span>
<span class="n">monitor</span> <span class="o">=</span> <span class="n">SessionMonitor</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session Activity by Hour (UTC):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">get_active_sessions</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">overlap</span> <span class="o">=</span> <span class="n">monitor</span><span class="o">.</span><span class="n">get_session_overlap</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">session_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hour</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00 - </span><span class="si">{</span><span class="n">session_names</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SystemHealth</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor trading system health.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_check</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">check_broker_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Verify broker connection is active.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">account</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="s1">&#39;broker_connection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="s1">&#39;broker_connection&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Broker connection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="s1">&#39;broker_connection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">check_data_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Verify price data is flowing.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prices</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="s1">&#39;data_feed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span>
            <span class="k">return</span> <span class="n">valid</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data feed error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="s1">&#39;data_feed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">check_margin_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">min_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">200.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check margin level is healthy.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">account</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
            <span class="n">margin_used</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;margin_used&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">margin_used</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">margin_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;nav&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">margin_used</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">margin_level</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="s1">&#39;margin_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">margin_level</span> <span class="o">&gt;=</span> <span class="n">min_level</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="s1">&#39;margin_level&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Margin check error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="s1">&#39;margin_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">run_all_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run all health checks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_broker_connection</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_data_feed</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">symbols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_margin_level</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_check</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span>
    
    <span class="k">def</span> <span class="nf">is_healthy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if all systems are healthy.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">get_status_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate status report.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;System Health Report&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">check</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span> <span class="k">if</span> <span class="n">status</span> <span class="k">else</span> <span class="s2">&quot;FAIL&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">check</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Errors:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate health monitoring</span>
<span class="n">health</span> <span class="o">=</span> <span class="n">SystemHealth</span><span class="p">()</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">OANDAClient</span><span class="p">(</span><span class="s2">&quot;101-001-12345678-001&quot;</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">health</span><span class="o">.</span><span class="n">run_all_checks</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;EUR_USD&quot;</span><span class="p">,</span> <span class="s2">&quot;GBP_USD&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">health</span><span class="o">.</span><span class="n">get_status_report</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System healthy: </span><span class="si">{</span><span class="n">health</span><span class="o">.</span><span class="n">is_healthy</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TradingBot</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;24-hour trading bot framework.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">SystemHealth</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_monitor</span> <span class="o">=</span> <span class="n">SessionMonitor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_daily_trades</span> <span class="o">=</span> <span class="mi">10</span>
        
        <span class="c1"># Configure logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;TradingBot&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">pre_trade_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run checks before each trading cycle.&quot;&quot;&quot;</span>
        <span class="c1"># Check if weekend</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_monitor</span><span class="o">.</span><span class="n">is_weekend</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Market closed for weekend&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="c1"># Check daily trade limit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_daily_trades</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Daily trade limit reached&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="c1"># Run health checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">run_all_checks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;EUR_USD&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">is_healthy</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Health check failed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run one trading cycle.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_trade_checks</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="c1"># Get market data</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_prices</span><span class="p">([</span><span class="s2">&quot;EUR_USD&quot;</span><span class="p">])</span>
        
        <span class="c1"># Get signal from strategy</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal generated: </span><span class="si">{</span><span class="n">signal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Execute signal</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;FILLED&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">result</span>
            
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">execute_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute a trading signal.&quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">OrderRequest</span><span class="p">(</span>
            <span class="n">instrument</span><span class="o">=</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">],</span>
            <span class="n">units</span><span class="o">=</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
            <span class="n">order_type</span><span class="o">=</span><span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">,</span>
            <span class="n">stop_loss</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">),</span>
            <span class="n">take_profit</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;take_profit&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">reset_daily_counters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset counters at start of new day.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Daily counters reset&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Simple strategy for demonstration</span>
<span class="k">class</span> <span class="nc">SimpleStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simple demonstration strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;EUR_USD&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_count</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal (simulated).&quot;&quot;&quot;</span>
        <span class="c1"># In real implementation, this would contain actual strategy logic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Only generate signal occasionally for demo</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_count</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s1">&#39;stop_loss&#39;</span><span class="p">:</span> <span class="n">bid</span> <span class="o">-</span> <span class="mf">0.0050</span><span class="p">,</span>
                <span class="s1">&#39;take_profit&#39;</span><span class="p">:</span> <span class="n">bid</span> <span class="o">+</span> <span class="mf">0.0100</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="c1"># Demonstrate bot framework</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">OANDAClient</span><span class="p">(</span><span class="s2">&quot;101-001-12345678-001&quot;</span><span class="p">)</span>
<span class="n">strategy</span> <span class="o">=</span> <span class="n">SimpleStrategy</span><span class="p">(</span><span class="s2">&quot;EUR_USD&quot;</span><span class="p">)</span>
<span class="n">bot</span> <span class="o">=</span> <span class="n">TradingBot</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running 3 trading cycles:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cycle </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">run_cycle</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Trade executed: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  No trade&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2></div>
<div class="md-cell"><h3>Exercise 1: Broker Comparison (Guided)</h3>
<p>Complete the broker scoring system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">BrokerScorer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Score brokers based on multiple criteria.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Weights for different criteria</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>
            <span class="s1">&#39;regulation&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
            <span class="s1">&#39;api_quality&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
            <span class="s1">&#39;leverage&#39;</span><span class="p">:</span> <span class="mf">0.20</span>
        <span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">score_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spread_pips</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Score cost (lower is better). Returns 0-100.&quot;&quot;&quot;</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">spread_pips</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">commission</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="c1"># Assume $50 is worst case, $5 is best case</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="n">total_cost</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="mi">45</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">______</span>  <span class="c1"># Return the score</span>
    
    <span class="k">def</span> <span class="nf">score_regulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regulations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Score regulation quality. Returns 0-100.&quot;&quot;&quot;</span>
        <span class="n">tier1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FCA&#39;</span><span class="p">,</span> <span class="s1">&#39;NFA&#39;</span><span class="p">,</span> <span class="s1">&#39;ASIC&#39;</span><span class="p">,</span> <span class="s1">&#39;SEC&#39;</span><span class="p">]</span>
        <span class="n">tier2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CySEC&#39;</span><span class="p">,</span> <span class="s1">&#39;FINMA&#39;</span><span class="p">,</span> <span class="s1">&#39;BaFin&#39;</span><span class="p">]</span>
        
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regulations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">tier1</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">40</span>
            <span class="k">elif</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">tier2</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">25</span>
        <span class="k">return</span> <span class="n">______</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Cap at 100</span>
    
    <span class="k">def</span> <span class="nf">score_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Score API quality. Returns 0-100.&quot;&quot;&quot;</span>
        <span class="n">api_scores</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;REST&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
            <span class="s1">&#39;FIX&#39;</span><span class="p">:</span> <span class="mi">95</span><span class="p">,</span>
            <span class="s1">&#39;TWS&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s1">&#39;Proprietary&#39;</span><span class="p">:</span> <span class="mi">50</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">api_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">______</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>  <span class="c1"># Get score or default 30</span>
    
    <span class="k">def</span> <span class="nf">calculate_total_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">:</span> <span class="n">BrokerProfile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate weighted total score.&quot;&quot;&quot;</span>
        <span class="n">cost_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_cost</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">typical_spread_eurusd</span><span class="p">,</span> <span class="n">broker</span><span class="o">.</span><span class="n">commission_per_lot</span><span class="p">)</span>
        <span class="n">reg_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_regulation</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">regulation</span><span class="p">)</span>
        <span class="n">api_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_api</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">api_type</span><span class="p">)</span>
        <span class="n">leverage_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">max_leverage</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="n">total</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">cost_score</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">reg_score</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;regulation&#39;</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">api_score</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;api_quality&#39;</span><span class="p">]</span> <span class="o">+</span>
            <span class="n">leverage_score</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;______&#39;</span><span class="p">]</span>  <span class="c1"># Fill in weight key</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


<span class="c1"># Test the scorer</span>
<span class="n">scorer</span> <span class="o">=</span> <span class="n">BrokerScorer</span><span class="p">()</span>
<span class="n">test_broker</span> <span class="o">=</span> <span class="n">BrokerProfile</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Test Broker&quot;</span><span class="p">,</span>
    <span class="n">regulation</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;FCA&quot;</span><span class="p">,</span> <span class="s2">&quot;ASIC&quot;</span><span class="p">],</span>
    <span class="n">typical_spread_eurusd</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">min_deposit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">max_leverage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">api_type</span><span class="o">=</span><span class="s2">&quot;REST&quot;</span>
<span class="p">)</span>

<span class="n">score</span> <span class="o">=</span> <span class="n">scorer</span><span class="o">.</span><span class="n">calculate_total_score</span><span class="p">(</span><span class="n">test_broker</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Broker score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">/100&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 2: Order Builder (Guided)</h3>
<p>Complete the order builder with validation.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">OrderBuilder</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Builder pattern for creating validated orders.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instrument</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">:</span> <span class="n">OrderType</span> <span class="o">=</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_loss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_take_profit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OrderBuilder&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set instrument.&quot;&quot;&quot;</span>
        <span class="n">valid_instruments</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;USD_JPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD_USD&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">instrument</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_instruments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid instrument: </span><span class="si">{</span><span class="n">instrument</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instrument</span> <span class="o">=</span> <span class="n">______</span>  <span class="c1"># Set the instrument</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OrderBuilder&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set position size (positive=buy, negative=sell).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Minimum order size is 1000 units&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000000</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Maximum order size is 10M units&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">______</span> <span class="o">=</span> <span class="n">units</span>  <span class="c1"># Set units attribute</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">limit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OrderBuilder&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set as limit order.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span> <span class="o">=</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_price</span> <span class="o">=</span> <span class="n">price</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OrderBuilder&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set stop loss.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_loss</span> <span class="o">=</span> <span class="n">______</span>  <span class="c1"># Set stop loss price</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">take_profit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OrderBuilder&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set take profit.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_take_profit</span> <span class="o">=</span> <span class="n">price</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate order configuration.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instrument</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Instrument is required&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Units is required&quot;</span><span class="p">)</span>
            
        <span class="c1"># Validate stop loss direction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_loss</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_loss</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_price</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_price</span> <span class="k">else</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Stop loss must be below entry for long positions&quot;</span><span class="p">)</span>
                
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span> <span class="o">==</span> <span class="n">______</span>  <span class="c1"># Return True if no errors</span>
    
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderRequest</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build and return the order.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid order: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">OrderRequest</span><span class="p">(</span>
            <span class="n">instrument</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_instrument</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">,</span>
            <span class="n">order_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_type</span><span class="p">,</span>
            <span class="n">price</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_price</span><span class="p">,</span>
            <span class="n">stop_loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_stop_loss</span><span class="p">,</span>
            <span class="n">take_profit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_take_profit</span>
        <span class="p">)</span>


<span class="c1"># Test the builder</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">order</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">OrderBuilder</span><span class="p">()</span>
        <span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="s2">&quot;EUR_USD&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">units</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="o">.</span><span class="n">stop_loss</span><span class="p">(</span><span class="mf">1.0800</span><span class="p">)</span>
        <span class="o">.</span><span class="n">take_profit</span><span class="p">(</span><span class="mf">1.0950</span><span class="p">)</span>
        <span class="o">.</span><span class="n">build</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order created: </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 3: Connection Manager (Guided)</h3>
<p>Complete the connection manager with reconnection logic.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ConnectionManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage broker connection with auto-reconnect.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="n">retry_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Attempt to connect with retries.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_attempts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">______</span><span class="p">:</span>  <span class="c1"># Check max retries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection attempt </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_attempts</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Simulate connection (would call real API)</span>
                <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">account</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="n">______</span>  <span class="c1"># Set connected status</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connected successfully&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_attempts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrying in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span><span class="si">}</span><span class="s2"> seconds...&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">______</span><span class="p">)</span>  <span class="c1"># Wait before retry</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">ensure_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Ensure connection is active, reconnect if needed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="c1"># Verify connection with heartbeat</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
                
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>


<span class="c1"># Test connection manager</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">OANDAClient</span><span class="p">(</span><span class="s2">&quot;test-account&quot;</span><span class="p">)</span>
<span class="n">manager</span> <span class="o">=</span> <span class="n">ConnectionManager</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">retry_delay</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">connect</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Connection established&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total attempts: </span><span class="si">{</span><span class="n">manager</span><span class="o">.</span><span class="n">connection_attempts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 4: Deployment Checklist</h3>
<p>Create a comprehensive pre-deployment checklist system for a live trading bot.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4: Build a DeploymentChecklist class that:</span>
<span class="c1"># 1. Defines critical checks (broker connection, risk params, strategy validation)</span>
<span class="c1"># 2. Defines warning checks (time until weekend, market hours)</span>
<span class="c1"># 3. Has a run_all() method that executes all checks</span>
<span class="c1"># 4. Returns a report showing pass/fail status and any warnings</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 5: Alert System</h3>
<p>Build an alert system for monitoring live trades.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 5: Build an AlertSystem class that:</span>
<span class="c1"># 1. Monitors positions for stop loss proximity (within X pips)</span>
<span class="c1"># 2. Monitors daily P&amp;L against thresholds (max loss, target profit)</span>
<span class="c1"># 3. Monitors margin level</span>
<span class="c1"># 4. Generates alerts with severity levels (INFO, WARNING, CRITICAL)</span>
<span class="c1"># 5. Has a method to get all active alerts</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 6: Error Recovery</h3>
<p>Implement error handling and recovery for common trading issues.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 6: Build an ErrorRecovery class that:</span>
<span class="c1"># 1. Handles order rejection (retry with adjusted parameters)</span>
<span class="c1"># 2. Handles connection loss (attempt reconnection)</span>
<span class="c1"># 3. Handles position reconciliation (compare local vs broker positions)</span>
<span class="c1"># 4. Logs all errors and recovery attempts</span>
<span class="c1"># 5. Implements circuit breaker pattern (disable trading after N errors)</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Live Trading System</h2>
<p>Build a complete live trading system framework.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">LiveTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete live trading system.</span>
<span class="sd">    </span>
<span class="sd">    Integrates:</span>
<span class="sd">    - Broker connection with auto-reconnect</span>
<span class="sd">    - Session monitoring</span>
<span class="sd">    - Health checks</span>
<span class="sd">    - Order management</span>
<span class="sd">    - Alerting</span>
<span class="sd">    - Logging</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize trading system.</span>
<span class="sd">        </span>
<span class="sd">        Config should include:</span>
<span class="sd">        - broker: Broker client instance</span>
<span class="sd">        - strategy: Trading strategy instance</span>
<span class="sd">        - risk_params: Risk management parameters</span>
<span class="sd">        - instruments: List of instruments to trade</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;broker&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instruments&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">])</span>
        
        <span class="c1"># Components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_monitor</span> <span class="o">=</span> <span class="n">SessionMonitor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">SystemHealth</span><span class="p">()</span>
        
        <span class="c1"># State</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Risk parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_daily_loss</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;risk_params&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_daily_loss&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_daily_trades</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;risk_params&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_daily_trades&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Setup logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_logging</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_setup_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure logging.&quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;LiveTradingSystem&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">startup_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run all startup checks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running startup checks...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check broker connection</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">check_broker_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Broker connection failed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="c1"># Check data feed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">check_data_feed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Data feed check failed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="c1"># Check margin</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">check_margin_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Margin level check failed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All startup checks passed&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">can_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check if trading is allowed.&quot;&quot;&quot;</span>
        <span class="c1"># Check if paused</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paused</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;System is paused&quot;</span>
            
        <span class="c1"># Check weekend</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_monitor</span><span class="o">.</span><span class="n">is_weekend</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Market closed for weekend&quot;</span>
            
        <span class="c1"># Check daily loss limit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_daily_loss</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Daily loss limit reached: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="si">}</span><span class="s2">&quot;</span>
            
        <span class="c1"># Check daily trade limit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_daily_trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Daily trade limit reached&quot;</span>
            
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;OK&quot;</span>
    
    <span class="k">def</span> <span class="nf">process_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Process and execute a trading signal.&quot;&quot;&quot;</span>
        <span class="n">can_trade</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_trade</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">can_trade</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot trade: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="c1"># Create order</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">OrderRequest</span><span class="p">(</span>
            <span class="n">instrument</span><span class="o">=</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">],</span>
            <span class="n">units</span><span class="o">=</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
            <span class="n">order_type</span><span class="o">=</span><span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">,</span>
            <span class="n">stop_loss</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">),</span>
            <span class="n">take_profit</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;take_profit&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Execute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing order: </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">signal</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> units&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;FILLED&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order filled: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order not filled: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run one trading cycle.&quot;&quot;&quot;</span>
        <span class="c1"># Health check</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">is_healthy</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">run_all_checks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">is_healthy</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Health check failed, skipping cycle&quot;</span><span class="p">)</span>
                <span class="k">return</span>
                
        <span class="c1"># Get prices</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_prices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instruments</span><span class="p">)</span>
        
        <span class="c1"># Generate signal</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">signal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pause trading.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trading paused&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resume trading.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trading resumed&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Graceful shutdown.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initiating shutdown...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Close all positions</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closing position: </span><span class="si">{</span><span class="n">pos</span><span class="o">.</span><span class="n">instrument</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close_position</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">instrument</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shutdown complete&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current system status.&quot;&quot;&quot;</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_monitor</span><span class="o">.</span><span class="n">get_active_sessions</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;running&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">,</span>
            <span class="s1">&#39;paused&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">paused</span><span class="p">,</span>
            <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">is_healthy</span><span class="p">(),</span>
            <span class="s1">&#39;daily_pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">,</span>
            <span class="s1">&#39;trades_today&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades_today</span><span class="p">,</span>
            <span class="s1">&#39;active_sessions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">],</span>
            <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="n">account</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;balance&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="n">account</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;positions&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate the live trading system</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;broker&#39;</span><span class="p">:</span> <span class="n">OANDAClient</span><span class="p">(</span><span class="s2">&quot;101-001-12345678-001&quot;</span><span class="p">),</span>
    <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="n">SimpleStrategy</span><span class="p">(</span><span class="s2">&quot;EUR_USD&quot;</span><span class="p">),</span>
    <span class="s1">&#39;instruments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EUR_USD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP_USD&#39;</span><span class="p">],</span>
    <span class="s1">&#39;risk_params&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;max_daily_loss&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">500</span><span class="p">,</span>
        <span class="s1">&#39;max_daily_trades&#39;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">LiveTradingSystem</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="c1"># Run startup checks</span>
<span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">startup_checks</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System Status:&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="c1"># Run a few cycles</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running trading cycles:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">system</span><span class="o">.</span><span class="n">run_cycle</span><span class="p">()</span>
        
    <span class="c1"># Check final status</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trades executed: </span><span class="si">{</span><span class="n">system</span><span class="o">.</span><span class="n">trades_today</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Broker Selection</strong>: Evaluate brokers on regulation, costs, API quality, and execution</p>
</li>
<li>
<p><strong>Order Execution</strong>: Use proper order types with stop loss and take profit for risk management</p>
</li>
<li>
<p><strong>Platform Integration</strong>: OANDA REST API and MetaTrader 5 offer different trade-offs for Python integration</p>
</li>
<li>
<p><strong>24-Hour Operation</strong>: Forex requires session awareness, health monitoring, and automatic recovery</p>
</li>
<li>
<p><strong>System Design</strong>: Production systems need connection management, health checks, alerting, and graceful shutdown</p>
</li>
<li>
<p><strong>Risk Controls</strong>: Always implement daily loss limits, trade limits, and margin monitoring</p>
</li>
</ol>
<hr />
<p><strong>Next Module</strong>: Module 12 - Advanced Strategies (Currency Indices, Spread Trading)</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="12"><div class="md-cell module-header"><h1>Module 12: Advanced Strategies</h1>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Skill Level</strong></td>
<td>Advanced</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Modules 8-11</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:
- Build and trade custom currency indices
- Implement spread and pairs trading strategies
- Understand options on forex and futures
- Identify and trade seasonal patterns</p>
<h2>Prerequisites</h2>
<ul>
<li>Completed Part 3 (Risk &amp; Execution)</li>
<li>Understanding of technical and fundamental analysis</li>
<li>Familiarity with backtesting concepts</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 12.1: Currency Indices</h2>
<p>Currency indices measure a currency's strength against a basket of currencies.</p></div>
<div class="md-cell"><h3>The US Dollar Index (DXY)</h3>
<p>The DXY measures USD against 6 major currencies:
- EUR (57.6%)
- JPY (13.6%)
- GBP (11.9%)
- CAD (9.1%)
- SEK (4.2%)
- CHF (3.6%)</p>
<p>Formula: DXY = 50.14348112 Ã— (EUR/USD)^-0.576 Ã— (USD/JPY)^0.136 Ã— ...</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">DollarIndex</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate the US Dollar Index (DXY).&quot;&quot;&quot;</span>
    
    <span class="c1"># Official DXY weights</span>
    <span class="n">WEIGHTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;EUR&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.576</span><span class="p">,</span>   <span class="c1"># Negative because EUR/USD</span>
        <span class="s1">&#39;JPY&#39;</span><span class="p">:</span> <span class="mf">0.136</span><span class="p">,</span>    <span class="c1"># Positive because USD/JPY</span>
        <span class="s1">&#39;GBP&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.119</span><span class="p">,</span>   <span class="c1"># Negative because GBP/USD</span>
        <span class="s1">&#39;CAD&#39;</span><span class="p">:</span> <span class="mf">0.091</span><span class="p">,</span>    <span class="c1"># Positive because USD/CAD</span>
        <span class="s1">&#39;SEK&#39;</span><span class="p">:</span> <span class="mf">0.042</span><span class="p">,</span>    <span class="c1"># Positive because USD/SEK</span>
        <span class="s1">&#39;CHF&#39;</span><span class="p">:</span> <span class="mf">0.036</span>     <span class="c1"># Positive because USD/CHF</span>
    <span class="p">}</span>
    
    <span class="n">CONSTANT</span> <span class="o">=</span> <span class="mf">50.14348112</span>
    
    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate DXY from exchange rates.</span>
<span class="sd">        </span>
<span class="sd">        rates should contain:</span>
<span class="sd">        - EURUSD, USDJPY, GBPUSD, USDCAD, USDSEK, USDCHF</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONSTANT</span>
        
        <span class="c1"># Convert rates to proper format</span>
        <span class="n">rate_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;EUR&#39;</span><span class="p">:</span> <span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s1">&#39;JPY&#39;</span><span class="p">:</span> <span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">),</span>
            <span class="s1">&#39;GBP&#39;</span><span class="p">:</span> <span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s1">&#39;CAD&#39;</span><span class="p">:</span> <span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USDCAD&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s1">&#39;SEK&#39;</span><span class="p">:</span> <span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USDSEK&#39;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span>
            <span class="s1">&#39;CHF&#39;</span><span class="p">:</span> <span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USDCHF&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">WEIGHTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">rate_map</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span>
            <span class="n">dxy</span> <span class="o">*=</span> <span class="n">rate</span> <span class="o">**</span> <span class="n">weight</span>
            
        <span class="k">return</span> <span class="n">dxy</span>
    
    <span class="k">def</span> <span class="nf">calculate_contribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> 
                               <span class="n">prev_rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate each currency&#39;s contribution to DXY change.&quot;&quot;&quot;</span>
        <span class="n">contributions</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">rate_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;EUR&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;JPY&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;GBP&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;CAD&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;USDCAD&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;SEK&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;USDSEK&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;CHF&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;USDCHF&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rate_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">prev_rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span> <span class="o">/</span> <span class="n">previous</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">direction</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WEIGHTS</span><span class="p">[</span><span class="n">currency</span><span class="p">])</span>
            <span class="n">contributions</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="n">change</span> <span class="o">*</span> <span class="n">weight</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># in percentage points</span>
            
        <span class="k">return</span> <span class="n">contributions</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Calculate DXY example</span>
<span class="n">dxy</span> <span class="o">=</span> <span class="n">DollarIndex</span><span class="p">()</span>

<span class="n">current_rates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="mf">1.0850</span><span class="p">,</span>
    <span class="s1">&#39;USDJPY&#39;</span><span class="p">:</span> <span class="mf">149.50</span><span class="p">,</span>
    <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="mf">1.2650</span><span class="p">,</span>
    <span class="s1">&#39;USDCAD&#39;</span><span class="p">:</span> <span class="mf">1.3500</span><span class="p">,</span>
    <span class="s1">&#39;USDSEK&#39;</span><span class="p">:</span> <span class="mf">10.50</span><span class="p">,</span>
    <span class="s1">&#39;USDCHF&#39;</span><span class="p">:</span> <span class="mf">0.8800</span>
<span class="p">}</span>

<span class="n">index_value</span> <span class="o">=</span> <span class="n">dxy</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">current_rates</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DXY Value: </span><span class="si">{</span><span class="n">index_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Calculate contribution from rate changes</span>
<span class="n">previous_rates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="mf">1.0900</span><span class="p">,</span>
    <span class="s1">&#39;USDJPY&#39;</span><span class="p">:</span> <span class="mf">148.00</span><span class="p">,</span>
    <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="mf">1.2700</span><span class="p">,</span>
    <span class="s1">&#39;USDCAD&#39;</span><span class="p">:</span> <span class="mf">1.3450</span><span class="p">,</span>
    <span class="s1">&#39;USDSEK&#39;</span><span class="p">:</span> <span class="mf">10.40</span><span class="p">,</span>
    <span class="s1">&#39;USDCHF&#39;</span><span class="p">:</span> <span class="mf">0.8750</span>
<span class="p">}</span>

<span class="n">contributions</span> <span class="o">=</span> <span class="n">dxy</span><span class="o">.</span><span class="n">calculate_contribution</span><span class="p">(</span><span class="n">current_rates</span><span class="p">,</span> <span class="n">previous_rates</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Contributions to DXY change:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">currency</span><span class="p">,</span> <span class="n">contrib</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">currency</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">contrib</span><span class="si">:</span><span class="s2">+.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CustomCurrencyIndex</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Build custom currency strength indices.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize custom index.</span>
<span class="sd">        </span>
<span class="sd">        base_currency: Currency to measure strength of (e.g., &#39;EUR&#39;)</span>
<span class="sd">        pairs: List of pairs involving this currency</span>
<span class="sd">        weights: Optional custom weights (default: equal)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_currency</span> <span class="o">=</span> <span class="n">base_currency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span>
        
        <span class="k">if</span> <span class="n">weights</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Equal weights</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">pair</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">}</span>
            
    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">base_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate index value from rates.&quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            
            <span class="c1"># Determine if base currency is first or second in pair</span>
            <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_currency</span><span class="p">):</span>
                <span class="c1"># EUR in EURUSD - higher rate = stronger EUR</span>
                <span class="n">contribution</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># EUR in GBPEUR - lower rate = stronger EUR</span>
                <span class="n">contribution</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
                
            <span class="n">index</span> <span class="o">+=</span> <span class="n">contribution</span>
            
        <span class="k">return</span> <span class="n">index</span> <span class="o">*</span> <span class="n">base_value</span>
    
    <span class="k">def</span> <span class="nf">calculate_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rates_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate index over time series.&quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rates_series</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">rates</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">rates</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">rates_series</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Create EUR strength index</span>
<span class="n">eur_index</span> <span class="o">=</span> <span class="n">CustomCurrencyIndex</span><span class="p">(</span>
    <span class="n">base_currency</span><span class="o">=</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span>
    <span class="n">pairs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;EURJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;EURGBP&#39;</span><span class="p">,</span> <span class="s1">&#39;EURCHF&#39;</span><span class="p">],</span>
    <span class="n">weights</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>  <span class="c1"># Most important</span>
        <span class="s1">&#39;EURJPY&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="s1">&#39;EURGBP&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span>
        <span class="s1">&#39;EURCHF&#39;</span><span class="p">:</span> <span class="mf">0.15</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">sample_rates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="mf">1.0850</span><span class="p">,</span>
    <span class="s1">&#39;EURJPY&#39;</span><span class="p">:</span> <span class="mf">162.20</span><span class="p">,</span>
    <span class="s1">&#39;EURGBP&#39;</span><span class="p">:</span> <span class="mf">0.8580</span><span class="p">,</span>
    <span class="s1">&#39;EURCHF&#39;</span><span class="p">:</span> <span class="mf">0.9550</span>
<span class="p">}</span>

<span class="n">eur_strength</span> <span class="o">=</span> <span class="n">eur_index</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">sample_rates</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EUR Strength Index: </span><span class="si">{</span><span class="n">eur_strength</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 12.2: Spread Trading</h2>
<p>Spread trading involves simultaneously buying and selling related instruments.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SpreadTrade</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a spread trade.&quot;&quot;&quot;</span>
    <span class="n">long_instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">short_instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">long_units</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">short_units</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">entry_spread</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">current_spread</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate P&amp;L from spread change.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_spread</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_spread</span>


<span class="k">class</span> <span class="nc">InterCommoditySpread</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trade spreads between related commodities.&quot;&quot;&quot;</span>
    
    <span class="c1"># Common commodity spreads</span>
    <span class="n">COMMON_SPREADS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;crack_spread&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;CL&#39;</span><span class="p">,</span> <span class="s1">&#39;RB&#39;</span><span class="p">),</span>     <span class="c1"># Crude oil vs Gasoline</span>
        <span class="s1">&#39;crush_spread&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;ZS&#39;</span><span class="p">,</span> <span class="s1">&#39;ZM&#39;</span><span class="p">),</span>     <span class="c1"># Soybeans vs Soybean Meal</span>
        <span class="s1">&#39;gold_silver&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;GC&#39;</span><span class="p">,</span> <span class="s1">&#39;SI&#39;</span><span class="p">),</span>       <span class="c1"># Gold vs Silver ratio</span>
        <span class="s1">&#39;brent_wti&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;BZ&#39;</span><span class="p">,</span> <span class="s1">&#39;CL&#39;</span><span class="p">),</span>         <span class="c1"># Brent vs WTI crude</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spread_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spread_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMMON_SPREADS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown spread type: </span><span class="si">{</span><span class="n">spread_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spread_type</span> <span class="o">=</span> <span class="n">spread_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_sym</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_sym</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMMON_SPREADS</span><span class="p">[</span><span class="n">spread_type</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">calculate_spread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">short_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate spread value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spread_type</span> <span class="o">==</span> <span class="s1">&#39;gold_silver&#39;</span><span class="p">:</span>
            <span class="c1"># Gold/Silver ratio</span>
            <span class="k">return</span> <span class="n">long_price</span> <span class="o">/</span> <span class="n">short_price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Price difference</span>
            <span class="k">return</span> <span class="n">long_price</span> <span class="o">-</span> <span class="n">short_price</span>
    
    <span class="k">def</span> <span class="nf">analyze_spread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spread_history</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze spread statistics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">spread_history</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">spread_history</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">spread_history</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;z_score&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">spread_history</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spread_history</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">spread_history</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;percentile&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">percentileofscore</span><span class="p">(</span><span class="n">spread_history</span><span class="p">,</span> <span class="n">spread_history</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">spread_history</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">spread_history</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Generate synthetic gold/silver ratio data</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="c1"># Gold/Silver ratio typically ranges 60-90</span>
<span class="n">ratio_mean</span> <span class="o">=</span> <span class="mi">75</span>
<span class="n">ratio_std</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ratios</span> <span class="o">=</span> <span class="n">ratio_mean</span> <span class="o">+</span> <span class="n">ratio_std</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">spread_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ratios</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>

<span class="c1"># Analyze the spread</span>
<span class="n">gs_spread</span> <span class="o">=</span> <span class="n">InterCommoditySpread</span><span class="p">(</span><span class="s1">&#39;gold_silver&#39;</span><span class="p">)</span>
<span class="n">analysis</span> <span class="o">=</span> <span class="n">gs_spread</span><span class="o">.</span><span class="n">analyze_spread</span><span class="p">(</span><span class="n">spread_series</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gold/Silver Ratio Analysis:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spread_series</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Gold/Silver Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;+2 Std&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;-2 Std&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gold/Silver Ratio with Bollinger Bands&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CalendarSpread</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trade spreads between different contract months.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">front_month</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">back_month</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">front_month</span> <span class="o">=</span> <span class="n">front_month</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">back_month</span> <span class="o">=</span> <span class="n">back_month</span>
        
    <span class="k">def</span> <span class="nf">calculate_spread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">front_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">back_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate calendar spread (back - front).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">back_price</span> <span class="o">-</span> <span class="n">front_price</span>
    
    <span class="k">def</span> <span class="nf">determine_market_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">front_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">back_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine contango or backwardation.&quot;&quot;&quot;</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_spread</span><span class="p">(</span><span class="n">front_price</span><span class="p">,</span> <span class="n">back_price</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Contango&quot;</span>  <span class="c1"># Back month more expensive</span>
        <span class="k">elif</span> <span class="n">spread</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Backwardation&quot;</span>  <span class="c1"># Front month more expensive</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Flat&quot;</span>
    
    <span class="k">def</span> <span class="nf">calculate_roll_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">front_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">back_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                             <span class="n">days_to_expiry</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate annualized roll yield.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">front_price</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">days_to_expiry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="n">spread_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">back_price</span> <span class="o">-</span> <span class="n">front_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">front_price</span>
        <span class="n">annualized</span> <span class="o">=</span> <span class="n">spread_pct</span> <span class="o">*</span> <span class="p">(</span><span class="mi">365</span> <span class="o">/</span> <span class="n">days_to_expiry</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">annualized</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># As percentage</span>


<span class="c1"># Example: Crude Oil calendar spread</span>
<span class="n">oil_spread</span> <span class="o">=</span> <span class="n">CalendarSpread</span><span class="p">(</span><span class="s1">&#39;CL&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar24&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun24&#39;</span><span class="p">)</span>

<span class="n">front_price</span> <span class="o">=</span> <span class="mf">72.50</span>
<span class="n">back_price</span> <span class="o">=</span> <span class="mf">73.80</span>

<span class="n">spread</span> <span class="o">=</span> <span class="n">oil_spread</span><span class="o">.</span><span class="n">calculate_spread</span><span class="p">(</span><span class="n">front_price</span><span class="p">,</span> <span class="n">back_price</span><span class="p">)</span>
<span class="n">structure</span> <span class="o">=</span> <span class="n">oil_spread</span><span class="o">.</span><span class="n">determine_market_structure</span><span class="p">(</span><span class="n">front_price</span><span class="p">,</span> <span class="n">back_price</span><span class="p">)</span>
<span class="n">roll_yield</span> <span class="o">=</span> <span class="n">oil_spread</span><span class="o">.</span><span class="n">calculate_roll_yield</span><span class="p">(</span><span class="n">front_price</span><span class="p">,</span> <span class="n">back_price</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crude Oil Calendar Spread:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Front (</span><span class="si">{</span><span class="n">oil_spread</span><span class="o">.</span><span class="n">front_month</span><span class="si">}</span><span class="s2">): $</span><span class="si">{</span><span class="n">front_price</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Back (</span><span class="si">{</span><span class="n">oil_spread</span><span class="o">.</span><span class="n">back_month</span><span class="si">}</span><span class="s2">): $</span><span class="si">{</span><span class="n">back_price</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Spread: $</span><span class="si">{</span><span class="n">spread</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Market Structure: </span><span class="si">{</span><span class="n">structure</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annualized Roll Yield: </span><span class="si">{</span><span class="n">roll_yield</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">CurrencyPairsTrader</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Statistical arbitrage on correlated currency pairs.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pair2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair1</span> <span class="o">=</span> <span class="n">pair1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair2</span> <span class="o">=</span> <span class="n">pair2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hedge_ratio</span> <span class="o">=</span> <span class="mf">1.0</span>
        
    <span class="k">def</span> <span class="nf">calculate_hedge_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">prices2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate optimal hedge ratio using linear regression.&quot;&quot;&quot;</span>
        <span class="c1"># Use recent prices for regression</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">prices1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">prices2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span>
        
        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hedge_ratio</span> <span class="o">=</span> <span class="n">slope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correlation</span> <span class="o">=</span> <span class="n">r_value</span>
        <span class="k">return</span> <span class="n">slope</span>
    
    <span class="k">def</span> <span class="nf">calculate_spread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price2</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate spread using hedge ratio.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">price1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">hedge_ratio</span> <span class="o">*</span> <span class="n">price2</span>
    
    <span class="k">def</span> <span class="nf">calculate_spread_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">prices2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate spread time series.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">prices1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">hedge_ratio</span> <span class="o">*</span> <span class="n">prices2</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spread</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">z_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signals based on z-score.&quot;&quot;&quot;</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">spread</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">spread</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">z_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">spread</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
        
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">spread</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="n">z_score</span> <span class="o">&gt;</span> <span class="n">z_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>   <span class="c1"># Short spread</span>
        <span class="n">signals</span><span class="p">[</span><span class="n">z_score</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">z_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># Long spread</span>
        
        <span class="k">return</span> <span class="n">signals</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Generate synthetic correlated pair data</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">252</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="c1"># EURUSD and GBPUSD are highly correlated</span>
<span class="n">common_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">)</span>
<span class="n">eurusd</span> <span class="o">=</span> <span class="mf">1.08</span> <span class="o">+</span> <span class="n">common_factor</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0005</span><span class="p">)</span>
<span class="n">gbpusd</span> <span class="o">=</span> <span class="mf">1.26</span> <span class="o">+</span> <span class="n">common_factor</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0006</span><span class="p">)</span>

<span class="n">eurusd_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">eurusd</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">gbpusd_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">gbpusd</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>

<span class="c1"># Create pairs trader</span>
<span class="n">pairs_trader</span> <span class="o">=</span> <span class="n">CurrencyPairsTrader</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">hedge_ratio</span> <span class="o">=</span> <span class="n">pairs_trader</span><span class="o">.</span><span class="n">calculate_hedge_ratio</span><span class="p">(</span><span class="n">eurusd_series</span><span class="p">,</span> <span class="n">gbpusd_series</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hedge Ratio: </span><span class="si">{</span><span class="n">hedge_ratio</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation: </span><span class="si">{</span><span class="n">pairs_trader</span><span class="o">.</span><span class="n">correlation</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Calculate spread and signals</span>
<span class="n">spread</span> <span class="o">=</span> <span class="n">pairs_trader</span><span class="o">.</span><span class="n">calculate_spread_series</span><span class="p">(</span><span class="n">eurusd_series</span><span class="p">,</span> <span class="n">gbpusd_series</span><span class="p">)</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">pairs_trader</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">(</span><span class="n">spread</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Signal distribution:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 12.3: Options on Futures</h2>
<p>Options provide additional strategic flexibility in forex and futures trading.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">OptionType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CALL</span> <span class="o">=</span> <span class="s2">&quot;call&quot;</span>
    <span class="n">PUT</span> <span class="o">=</span> <span class="s2">&quot;put&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FXOption</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;FX Option representation.&quot;&quot;&quot;</span>
    <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">option_type</span><span class="p">:</span> <span class="n">OptionType</span>
    <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">expiry_days</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">premium</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">notional</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span>  <span class="c1"># Standard lot</span>
    
    <span class="k">def</span> <span class="nf">intrinsic_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spot</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate intrinsic value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_type</span> <span class="o">==</span> <span class="n">OptionType</span><span class="o">.</span><span class="n">CALL</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">spot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">notional</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">-</span> <span class="n">spot</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">notional</span>
    
    <span class="k">def</span> <span class="nf">payoff_at_expiry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spot</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate P&amp;L at expiry.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_value</span><span class="p">(</span><span class="n">spot</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">premium</span>
    
    <span class="k">def</span> <span class="nf">breakeven</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate breakeven price.&quot;&quot;&quot;</span>
        <span class="n">premium_per_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">premium</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">notional</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_type</span> <span class="o">==</span> <span class="n">OptionType</span><span class="o">.</span><span class="n">CALL</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">+</span> <span class="n">premium_per_unit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">-</span> <span class="n">premium_per_unit</span>


<span class="k">class</span> <span class="nc">BlackScholes</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Black-Scholes option pricing for FX options.&quot;&quot;&quot;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">d1</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_d</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_f</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate d1.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S</span> <span class="o">/</span> <span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r_d</span> <span class="o">-</span> <span class="n">r_f</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">d2</span><span class="p">(</span><span class="n">d1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate d2.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">price</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_d</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_f</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
              <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="n">OptionType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate option price using Garman-Kohlhagen (FX Black-Scholes).</span>
<span class="sd">        </span>
<span class="sd">        S: Spot rate</span>
<span class="sd">        K: Strike</span>
<span class="sd">        r_d: Domestic interest rate</span>
<span class="sd">        r_f: Foreign interest rate</span>
<span class="sd">        sigma: Volatility</span>
<span class="sd">        T: Time to expiry in years</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">T</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
            
        <span class="n">d1</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">r_d</span><span class="p">,</span> <span class="n">r_f</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">d2</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="n">OptionType</span><span class="o">.</span><span class="n">CALL</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_f</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_d</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_d</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d2</span><span class="p">)</span> <span class="o">-</span> <span class="n">S</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_f</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d1</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">price</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_d</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_f</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
              <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="n">OptionType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate option delta.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">T</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
            
        <span class="n">d1</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">r_d</span><span class="p">,</span> <span class="n">r_f</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="n">OptionType</span><span class="o">.</span><span class="n">CALL</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_f</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_f</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Price an EURUSD call option</span>
<span class="n">spot</span> <span class="o">=</span> <span class="mf">1.0850</span>
<span class="n">strike</span> <span class="o">=</span> <span class="mf">1.0900</span>
<span class="n">r_usd</span> <span class="o">=</span> <span class="mf">0.05</span>    <span class="c1"># USD rate</span>
<span class="n">r_eur</span> <span class="o">=</span> <span class="mf">0.04</span>    <span class="c1"># EUR rate</span>
<span class="n">volatility</span> <span class="o">=</span> <span class="mf">0.08</span>  <span class="c1"># 8% annualized vol</span>
<span class="n">days_to_expiry</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">days_to_expiry</span> <span class="o">/</span> <span class="mi">365</span>

<span class="n">call_price</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">price</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">r_usd</span><span class="p">,</span> <span class="n">r_eur</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">OptionType</span><span class="o">.</span><span class="n">CALL</span><span class="p">)</span>
<span class="n">put_price</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">price</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">r_usd</span><span class="p">,</span> <span class="n">r_eur</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">OptionType</span><span class="o">.</span><span class="n">PUT</span><span class="p">)</span>
<span class="n">call_delta</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">delta</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">r_usd</span><span class="p">,</span> <span class="n">r_eur</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">OptionType</span><span class="o">.</span><span class="n">CALL</span><span class="p">)</span>
<span class="n">put_delta</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">delta</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">r_usd</span><span class="p">,</span> <span class="n">r_eur</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">OptionType</span><span class="o">.</span><span class="n">PUT</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EURUSD Option Pricing:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Spot: </span><span class="si">{</span><span class="n">spot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Strike: </span><span class="si">{</span><span class="n">strike</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Days to Expiry: </span><span class="si">{</span><span class="n">days_to_expiry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">volatility</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Call Option:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Price: </span><span class="si">{</span><span class="n">call_price</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">call_price</span><span class="o">*</span><span class="mi">100000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> USD per 100k lot)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Delta: </span><span class="si">{</span><span class="n">call_delta</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Put Option:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Price: </span><span class="si">{</span><span class="n">put_price</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">put_price</span><span class="o">*</span><span class="mi">100000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> USD per 100k lot)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Delta: </span><span class="si">{</span><span class="n">put_delta</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">DeltaHedger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Delta hedging for option positions.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">:</span> <span class="n">FXOption</span><span class="p">,</span> <span class="n">hedge_frequency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;daily&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">option</span> <span class="o">=</span> <span class="n">option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hedge_frequency</span> <span class="o">=</span> <span class="n">hedge_frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spot_position</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hedge_history</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">calculate_hedge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spot</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_d</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_f</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                       <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">days_remaining</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate required spot hedge.&quot;&quot;&quot;</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">days_remaining</span> <span class="o">/</span> <span class="mi">365</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">delta</span><span class="p">(</span>
            <span class="n">spot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="n">r_d</span><span class="p">,</span> <span class="n">r_f</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">option_type</span>
        <span class="p">)</span>
        
        <span class="c1"># For a long option, we need to sell delta * notional of spot</span>
        <span class="n">required_hedge</span> <span class="o">=</span> <span class="o">-</span><span class="n">delta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">notional</span>
        <span class="k">return</span> <span class="n">required_hedge</span>
    
    <span class="k">def</span> <span class="nf">rebalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spot</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_d</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_f</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">days_remaining</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rebalance the hedge.&quot;&quot;&quot;</span>
        <span class="n">required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_hedge</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">r_d</span><span class="p">,</span> <span class="n">r_f</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">days_remaining</span><span class="p">)</span>
        <span class="n">adjustment</span> <span class="o">=</span> <span class="n">required</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spot_position</span> <span class="o">=</span> <span class="n">required</span>
        
        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;spot&#39;</span><span class="p">:</span> <span class="n">spot</span><span class="p">,</span>
            <span class="s1">&#39;required_hedge&#39;</span><span class="p">:</span> <span class="n">required</span><span class="p">,</span>
            <span class="s1">&#39;adjustment&#39;</span><span class="p">:</span> <span class="n">adjustment</span><span class="p">,</span>
            <span class="s1">&#39;days_remaining&#39;</span><span class="p">:</span> <span class="n">days_remaining</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hedge_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trade</span>


<span class="c1"># Example delta hedging</span>
<span class="n">option</span> <span class="o">=</span> <span class="n">FXOption</span><span class="p">(</span>
    <span class="n">pair</span><span class="o">=</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span>
    <span class="n">option_type</span><span class="o">=</span><span class="n">OptionType</span><span class="o">.</span><span class="n">CALL</span><span class="p">,</span>
    <span class="n">strike</span><span class="o">=</span><span class="mf">1.0900</span><span class="p">,</span>
    <span class="n">expiry_days</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">premium</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">notional</span><span class="o">=</span><span class="mi">100000</span>
<span class="p">)</span>

<span class="n">hedger</span> <span class="o">=</span> <span class="n">DeltaHedger</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>

<span class="c1"># Simulate hedging over a few days</span>
<span class="n">spots</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0850</span><span class="p">,</span> <span class="mf">1.0880</span><span class="p">,</span> <span class="mf">1.0920</span><span class="p">,</span> <span class="mf">1.0900</span><span class="p">]</span>
<span class="n">days_left</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">27</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Delta Hedging Simulation:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">spot</span><span class="p">,</span> <span class="n">days</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spots</span><span class="p">,</span> <span class="n">days_left</span><span class="p">):</span>
    <span class="n">trade</span> <span class="o">=</span> <span class="n">hedger</span><span class="o">.</span><span class="n">rebalance</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Day </span><span class="si">{</span><span class="mi">30</span><span class="o">-</span><span class="n">days</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Spot=</span><span class="si">{</span><span class="n">spot</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Hedge=</span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;required_hedge&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Adjustment=</span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;adjustment&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">+.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 12.4: Seasonal Strategies</h2>
<p>Many markets exhibit predictable seasonal patterns.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SeasonalAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze seasonal patterns in price data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">monthly_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate average returns by month.&quot;&quot;&quot;</span>
        <span class="n">monthly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">])</span>
        <span class="n">monthly</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;observations&#39;</span><span class="p">]</span>
        <span class="n">monthly</span><span class="p">[</span><span class="s1">&#39;t_stat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly</span><span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">monthly</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">monthly</span><span class="p">[</span><span class="s1">&#39;observations&#39;</span><span class="p">]))</span>
        <span class="n">monthly</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">monthly</span>
    
    <span class="k">def</span> <span class="nf">day_of_week_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate average returns by day of week.&quot;&quot;&quot;</span>
        <span class="n">daily</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">])</span>
        <span class="n">daily</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;observations&#39;</span><span class="p">]</span>
        <span class="n">daily</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mon&#39;</span><span class="p">,</span> <span class="s1">&#39;Tue&#39;</span><span class="p">,</span> <span class="s1">&#39;Wed&#39;</span><span class="p">,</span> <span class="s1">&#39;Thu&#39;</span><span class="p">,</span> <span class="s1">&#39;Fri&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">daily</span>
    
    <span class="k">def</span> <span class="nf">turn_of_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze turn-of-month effect.&quot;&quot;&quot;</span>
        <span class="c1"># Last N days of month</span>
        <span class="n">month_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_month_end</span> <span class="o">|</span> 
                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">is_month_start</span><span class="p">]</span>
        
        <span class="c1"># First N days of month</span>
        <span class="n">month_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_month_start</span> <span class="o">|</span> 
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">&lt;=</span> <span class="n">window</span><span class="p">)]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;month_end_avg&#39;</span><span class="p">:</span> <span class="n">month_end</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;month_start_avg&#39;</span><span class="p">:</span> <span class="n">month_start</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;rest_avg&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">month_end</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">month_start</span><span class="o">.</span><span class="n">index</span><span class="p">))]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Generate multi-year synthetic data with seasonal patterns</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-12-31&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="c1"># Base random walk</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.01</span>

<span class="c1"># Add monthly seasonality (e.g., January effect)</span>
<span class="n">month_effects</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span>   <span class="c1"># January positive</span>
    <span class="mi">5</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">,</span>  <span class="c1"># May negative (sell in May)</span>
    <span class="mi">9</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">,</span>  <span class="c1"># September negative</span>
    <span class="mi">12</span><span class="p">:</span> <span class="mf">0.002</span>   <span class="c1"># December positive (Santa rally)</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span> <span class="ow">in</span> <span class="n">month_effects</span><span class="p">:</span>
        <span class="n">returns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">month_effects</span><span class="p">[</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">]</span>

<span class="n">prices</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">returns</span><span class="p">))</span>
<span class="n">price_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>

<span class="c1"># Analyze seasonality</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">SeasonalAnalyzer</span><span class="p">(</span><span class="n">price_series</span><span class="p">)</span>
<span class="n">monthly</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">monthly_returns</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Monthly Return Analysis:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monthly</span><span class="p">[[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">,</span> <span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;t_stat&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Plot monthly returns</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">monthly</span><span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">]]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">months</span><span class="p">,</span> <span class="n">monthly</span><span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Average Monthly Returns (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Return (%)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SeasonalStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trade based on seasonal patterns.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long_months</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">short_months</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize strategy.</span>
<span class="sd">        </span>
<span class="sd">        long_months: Months to go long (1-12)</span>
<span class="sd">        short_months: Months to go short (optional)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_months</span> <span class="o">=</span> <span class="n">long_months</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_months</span> <span class="o">=</span> <span class="n">short_months</span> <span class="ow">or</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate position signals.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_months</span><span class="p">:</span>
                <span class="n">signals</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_months</span><span class="p">:</span>
                <span class="n">signals</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Backtest the seasonal strategy.&quot;&quot;&quot;</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">*</span> <span class="n">signals</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Signal from previous day</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;returns&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="p">,</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signals</span><span class="p">,</span>
            <span class="s1">&#39;strategy_returns&#39;</span><span class="p">:</span> <span class="n">strategy_returns</span>
        <span class="p">})</span>
        
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cumulative&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;strategy_returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;buy_hold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">results</span>


<span class="c1"># Test &quot;Sell in May&quot; strategy</span>
<span class="n">sell_in_may</span> <span class="o">=</span> <span class="n">SeasonalStrategy</span><span class="p">(</span>
    <span class="n">long_months</span><span class="o">=</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>  <span class="c1"># Long Nov-Apr</span>
    <span class="n">short_months</span><span class="o">=</span><span class="p">[]</span>  <span class="c1"># Stay flat May-Oct</span>
<span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">sell_in_may</span><span class="o">.</span><span class="n">backtest</span><span class="p">(</span><span class="n">price_series</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sell in May Strategy Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Strategy Total Return: </span><span class="si">{</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;cumulative&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Buy &amp; Hold Return: </span><span class="si">{</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;buy_hold&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Time in Market: </span><span class="si">{</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2></div>
<div class="md-cell"><h3>Exercise 1: GBP Index (Guided)</h3>
<p>Create a GBP strength index.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">GBPStrengthIndex</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate GBP strength against major currencies.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Define pairs and weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPEUR&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPCHF&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPAUD&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>   <span class="c1"># USD most important</span>
            <span class="s1">&#39;GBPEUR&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>   <span class="c1"># EUR second</span>
            <span class="s1">&#39;GBPJPY&#39;</span><span class="p">:</span> <span class="n">______</span><span class="p">,</span>  <span class="c1"># Fill in weight</span>
            <span class="s1">&#39;GBPCHF&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
            <span class="s1">&#39;GBPAUD&#39;</span><span class="p">:</span> <span class="mf">0.15</span>
        <span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate GBP index value.&quot;&quot;&quot;</span>
        <span class="n">index_value</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="c1"># GBP is always first in these pairs</span>
            <span class="c1"># Higher rate = stronger GBP</span>
            <span class="n">index_value</span> <span class="o">+=</span> <span class="n">rate</span> <span class="o">*</span> <span class="n">______</span>  <span class="c1"># Apply weight</span>
            
        <span class="k">return</span> <span class="n">index_value</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Scale to 100</span>
    
    <span class="k">def</span> <span class="nf">rate_of_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> 
                       <span class="n">previous</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate index change.&quot;&quot;&quot;</span>
        <span class="n">current_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>    <span class="c1"># Call calculate method</span>
        <span class="n">previous_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">previous</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">current_idx</span> <span class="o">/</span> <span class="n">previous_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">______</span>  <span class="c1"># Return as percentage</span>


<span class="c1"># Test the index</span>
<span class="n">gbp_index</span> <span class="o">=</span> <span class="n">GBPStrengthIndex</span><span class="p">()</span>
<span class="n">rates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="mf">1.2650</span><span class="p">,</span>
    <span class="s1">&#39;GBPEUR&#39;</span><span class="p">:</span> <span class="mf">1.1650</span><span class="p">,</span>
    <span class="s1">&#39;GBPJPY&#39;</span><span class="p">:</span> <span class="mf">189.00</span><span class="p">,</span>
    <span class="s1">&#39;GBPCHF&#39;</span><span class="p">:</span> <span class="mf">1.1100</span><span class="p">,</span>
    <span class="s1">&#39;GBPAUD&#39;</span><span class="p">:</span> <span class="mf">1.9200</span>
<span class="p">}</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">gbp_index</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GBP Strength Index: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 2: Spread Mean Reversion (Guided)</h3>
<p>Build a mean reversion strategy for spreads.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SpreadMeanReversion</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Mean reversion strategy for spread trading.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">entry_z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">exit_z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_z</span> <span class="o">=</span> <span class="n">entry_z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_z</span> <span class="o">=</span> <span class="n">exit_z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># -1, 0, or 1</span>
        
    <span class="k">def</span> <span class="nf">calculate_z_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spread</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate current z-score.&quot;&quot;&quot;</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="n">spread</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">recent</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>      <span class="c1"># Calculate mean</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">recent</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">spread</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">std</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">______</span>  <span class="c1"># Calculate z-score</span>
    
    <span class="k">def</span> <span class="nf">generate_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spread</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal.&quot;&quot;&quot;</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_z_score</span><span class="p">(</span><span class="n">spread</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># No position</span>
            <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_z</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">______</span>  <span class="c1"># Short the spread</span>
            <span class="k">elif</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">entry_z</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># Long the spread</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Have position</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">______</span><span class="p">:</span>  <span class="c1"># Check exit threshold</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Exit</span>
                
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>


<span class="c1"># Test the strategy</span>
<span class="n">strategy</span> <span class="o">=</span> <span class="n">SpreadMeanReversion</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">entry_z</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">exit_z</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Use spread_series from earlier</span>
<span class="n">signals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spread_series</span><span class="p">)):</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">generate_signal</span><span class="p">(</span><span class="n">spread_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal distribution: </span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 3: Option Payoff Calculator (Guided)</h3>
<p>Create a payoff diagram generator.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">OptionPayoffCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate and visualize option payoffs.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">add_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a call option position.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span>
            <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="n">strike</span><span class="p">,</span>
            <span class="s1">&#39;premium&#39;</span><span class="p">:</span> <span class="n">premium</span><span class="p">,</span>
            <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">quantity</span>
        <span class="p">})</span>
        
    <span class="k">def</span> <span class="nf">add_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a put option position.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">______</span><span class="p">,</span>  <span class="c1"># Set type</span>
            <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="n">strike</span><span class="p">,</span>
            <span class="s1">&#39;premium&#39;</span><span class="p">:</span> <span class="n">premium</span><span class="p">,</span>
            <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">quantity</span>
        <span class="p">})</span>
        
    <span class="k">def</span> <span class="nf">calculate_payoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spot</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total payoff at given spot price.&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
                <span class="n">intrinsic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">spot</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># put</span>
                <span class="n">intrinsic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;______&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spot</span><span class="p">)</span>  <span class="c1"># Get strike</span>
                
            <span class="n">payoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">intrinsic</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;premium&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">payoff</span>
            
        <span class="k">return</span> <span class="n">total</span>
    
    <span class="k">def</span> <span class="nf">plot_payoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spot_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Option Payoff&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot payoff diagram.&quot;&quot;&quot;</span>
        <span class="n">spots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">spot_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spot_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">payoffs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_payoff</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spots</span><span class="p">]</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spots</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">spots</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">payoffs</span><span class="p">],</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Profit&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">spots</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">payoffs</span><span class="p">],</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Spot Price&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;P&amp;L&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  <span class="c1"># Display the plot</span>


<span class="c1"># Create a bull call spread</span>
<span class="n">calc</span> <span class="o">=</span> <span class="n">OptionPayoffCalculator</span><span class="p">()</span>
<span class="n">calc</span><span class="o">.</span><span class="n">add_call</span><span class="p">(</span><span class="n">strike</span><span class="o">=</span><span class="mf">1.08</span><span class="p">,</span> <span class="n">premium</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># Buy lower strike</span>
<span class="n">calc</span><span class="o">.</span><span class="n">add_call</span><span class="p">(</span><span class="n">strike</span><span class="o">=</span><span class="mf">1.10</span><span class="p">,</span> <span class="n">premium</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Sell higher strike</span>

<span class="n">calc</span><span class="o">.</span><span class="n">plot_payoff</span><span class="p">((</span><span class="mf">1.04</span><span class="p">,</span> <span class="mf">1.14</span><span class="p">),</span> <span class="s2">&quot;Bull Call Spread - EURUSD&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 4: Multi-Currency Basket</h3>
<p>Create a customizable multi-currency basket index.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4: Build a CurrencyBasket class that:</span>
<span class="c1"># 1. Allows adding multiple currency pairs with custom weights</span>
<span class="c1"># 2. Normalizes weights to sum to 1.0</span>
<span class="c1"># 3. Calculates basket value from current rates</span>
<span class="c1"># 4. Tracks basket value over time series</span>
<span class="c1"># 5. Calculates correlation between individual pairs and basket</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 5: Calendar Spread Analyzer</h3>
<p>Build a comprehensive calendar spread analysis tool.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 5: Build a CalendarSpreadAnalyzer class that:</span>
<span class="c1"># 1. Takes prices for multiple contract months</span>
<span class="c1"># 2. Calculates all pairwise spreads</span>
<span class="c1"># 3. Identifies the term structure (contango/backwardation)</span>
<span class="c1"># 4. Finds the most attractive spread based on historical z-score</span>
<span class="c1"># 5. Generates a term structure plot</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 6: Seasonal Strategy Optimizer</h3>
<p>Optimize a seasonal trading strategy.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 6: Build a SeasonalOptimizer class that:</span>
<span class="c1"># 1. Tests all combinations of months to be long/short/flat</span>
<span class="c1"># 2. Evaluates strategies using Sharpe ratio</span>
<span class="c1"># 3. Applies out-of-sample validation</span>
<span class="c1"># 4. Returns the optimal month selection</span>
<span class="c1"># 5. Reports statistical significance of patterns</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Advanced Strategy Toolkit</h2>
<p>Build a comprehensive toolkit for advanced forex/futures strategies.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">AdvancedStrategyToolkit</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive toolkit for advanced trading strategies.</span>
<span class="sd">    </span>
<span class="sd">    Integrates:</span>
<span class="sd">    - Currency indices</span>
<span class="sd">    - Spread trading</span>
<span class="sd">    - Options analysis</span>
<span class="sd">    - Seasonal patterns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dxy</span> <span class="o">=</span> <span class="n">DollarIndex</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seasonal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spreads</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">analyze_currency_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate strength for all major currencies.</span>
<span class="sd">        </span>
<span class="sd">        Returns normalized strength scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate DXY</span>
        <span class="n">dxy_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dxy</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span>
        
        <span class="c1"># Calculate other currency indices</span>
        <span class="n">eur_index</span> <span class="o">=</span> <span class="n">CustomCurrencyIndex</span><span class="p">(</span><span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;EURJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;EURGBP&#39;</span><span class="p">])</span>
        <span class="n">gbp_index</span> <span class="o">=</span> <span class="n">CustomCurrencyIndex</span><span class="p">(</span><span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPCHF&#39;</span><span class="p">])</span>
        <span class="n">jpy_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;EURJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPJPY&#39;</span><span class="p">]</span>
        
        <span class="c1"># Normalize (100 = average)</span>
        <span class="n">strengths</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;USD&#39;</span><span class="p">:</span> <span class="n">dxy_value</span><span class="p">,</span>
            <span class="s1">&#39;EUR&#39;</span><span class="p">:</span> <span class="n">eur_index</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">rates</span><span class="p">),</span>
            <span class="s1">&#39;GBP&#39;</span><span class="p">:</span> <span class="n">gbp_index</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">strengths</span>
    
    <span class="k">def</span> <span class="nf">find_spread_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span> 
                                   <span class="n">z_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan for spread trading opportunities.</span>
<span class="sd">        </span>
<span class="sd">        Returns list of opportunities sorted by z-score.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Define related pairs to check</span>
        <span class="n">related_pairs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;AUDUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZDUSD&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;EURJPY&#39;</span><span class="p">),</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">pair1</span><span class="p">,</span> <span class="n">pair2</span> <span class="ow">in</span> <span class="n">related_pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair1</span> <span class="ow">in</span> <span class="n">prices</span> <span class="ow">and</span> <span class="n">pair2</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
                <span class="n">trader</span> <span class="o">=</span> <span class="n">CurrencyPairsTrader</span><span class="p">(</span><span class="n">pair1</span><span class="p">,</span> <span class="n">pair2</span><span class="p">)</span>
                <span class="n">trader</span><span class="o">.</span><span class="n">calculate_hedge_ratio</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="n">pair1</span><span class="p">],</span> <span class="n">prices</span><span class="p">[</span><span class="n">pair2</span><span class="p">])</span>
                <span class="n">spread</span> <span class="o">=</span> <span class="n">trader</span><span class="o">.</span><span class="n">calculate_spread_series</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="n">pair1</span><span class="p">],</span> <span class="n">prices</span><span class="p">[</span><span class="n">pair2</span><span class="p">])</span>
                
                <span class="c1"># Calculate z-score</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="n">spread</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">std</span> <span class="o">=</span> <span class="n">spread</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">z_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">spread</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span> <span class="k">if</span> <span class="n">std</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z_score</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">z_threshold</span><span class="p">:</span>
                    <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;pair1&#39;</span><span class="p">:</span> <span class="n">pair1</span><span class="p">,</span>
                        <span class="s1">&#39;pair2&#39;</span><span class="p">:</span> <span class="n">pair2</span><span class="p">,</span>
                        <span class="s1">&#39;z_score&#39;</span><span class="p">:</span> <span class="n">z_score</span><span class="p">,</span>
                        <span class="s1">&#39;hedge_ratio&#39;</span><span class="p">:</span> <span class="n">trader</span><span class="o">.</span><span class="n">hedge_ratio</span><span class="p">,</span>
                        <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">trader</span><span class="o">.</span><span class="n">correlation</span><span class="p">,</span>
                        <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;SHORT_SPREAD&#39;</span> <span class="k">if</span> <span class="n">z_score</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;LONG_SPREAD&#39;</span>
                    <span class="p">})</span>
                    
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">opportunities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;z_score&#39;</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">analyze_seasonality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Comprehensive seasonal analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seasonal</span> <span class="o">=</span> <span class="n">SeasonalAnalyzer</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        
        <span class="n">monthly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasonal</span><span class="o">.</span><span class="n">monthly_returns</span><span class="p">()</span>
        <span class="n">dow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasonal</span><span class="o">.</span><span class="n">day_of_week_returns</span><span class="p">()</span>
        <span class="n">tom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasonal</span><span class="o">.</span><span class="n">turn_of_month</span><span class="p">()</span>
        
        <span class="c1"># Find significant patterns</span>
        <span class="n">significant_months</span> <span class="o">=</span> <span class="n">monthly</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">monthly</span><span class="p">[</span><span class="s1">&#39;t_stat&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1.96</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;monthly&#39;</span><span class="p">:</span> <span class="n">monthly</span><span class="p">,</span>
            <span class="s1">&#39;day_of_week&#39;</span><span class="p">:</span> <span class="n">dow</span><span class="p">,</span>
            <span class="s1">&#39;turn_of_month&#39;</span><span class="p">:</span> <span class="n">tom</span><span class="p">,</span>
            <span class="s1">&#39;significant_months&#39;</span><span class="p">:</span> <span class="n">significant_months</span><span class="p">,</span>
            <span class="s1">&#39;best_month&#39;</span><span class="p">:</span> <span class="n">monthly</span><span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span>
            <span class="s1">&#39;worst_month&#39;</span><span class="p">:</span> <span class="n">monthly</span><span class="p">[</span><span class="s1">&#39;avg_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">price_option_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spot</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">strategies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
                               <span class="n">r_d</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r_f</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Price a multi-leg option strategy.</span>
<span class="sd">        </span>
<span class="sd">        strategies: List of {&#39;type&#39;: &#39;call&#39;/&#39;put&#39;, &#39;strike&#39;: K, &#39;quantity&#39;: N}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_premium</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_delta</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">legs</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">strat</span> <span class="ow">in</span> <span class="n">strategies</span><span class="p">:</span>
            <span class="n">opt_type</span> <span class="o">=</span> <span class="n">OptionType</span><span class="o">.</span><span class="n">CALL</span> <span class="k">if</span> <span class="n">strat</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span> <span class="k">else</span> <span class="n">OptionType</span><span class="o">.</span><span class="n">PUT</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">price</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">strat</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">],</span> <span class="n">r_d</span><span class="p">,</span> <span class="n">r_f</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">opt_type</span><span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">delta</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">strat</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">],</span> <span class="n">r_d</span><span class="p">,</span> <span class="n">r_f</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">opt_type</span><span class="p">)</span>
            
            <span class="n">legs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">strat</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="n">strat</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">],</span>
                <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">strat</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">],</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">delta</span>
            <span class="p">})</span>
            
            <span class="n">total_premium</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">strat</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
            <span class="n">total_delta</span> <span class="o">+=</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">strat</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
            
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;legs&#39;</span><span class="p">:</span> <span class="n">legs</span><span class="p">,</span>
            <span class="s1">&#39;net_premium&#39;</span><span class="p">:</span> <span class="n">total_premium</span><span class="p">,</span>
            <span class="s1">&#39;net_delta&#39;</span><span class="p">:</span> <span class="n">total_delta</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rates</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive market analysis report.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ADVANCED STRATEGY TOOLKIT REPORT&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="c1"># Currency strength</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- CURRENCY STRENGTH ---&quot;</span><span class="p">)</span>
        <span class="n">strengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_currency_strength</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ccy</span><span class="p">,</span> <span class="n">strength</span> <span class="ow">in</span> <span class="n">strengths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ccy</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">strength</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="c1"># Spread opportunities</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- SPREAD OPPORTUNITIES ---&quot;</span><span class="p">)</span>
        <span class="n">opps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_spread_opportunities</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">z_threshold</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opps</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">opp</span> <span class="ow">in</span> <span class="n">opps</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;pair1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;pair2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: Z=</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;z_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No significant opportunities found&quot;</span><span class="p">)</span>
            
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate the toolkit</span>
<span class="n">toolkit</span> <span class="o">=</span> <span class="n">AdvancedStrategyToolkit</span><span class="p">()</span>

<span class="c1"># Sample rates</span>
<span class="n">rates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="mf">1.0850</span><span class="p">,</span>
    <span class="s1">&#39;USDJPY&#39;</span><span class="p">:</span> <span class="mf">149.50</span><span class="p">,</span>
    <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="mf">1.2650</span><span class="p">,</span>
    <span class="s1">&#39;USDCAD&#39;</span><span class="p">:</span> <span class="mf">1.3500</span><span class="p">,</span>
    <span class="s1">&#39;USDSEK&#39;</span><span class="p">:</span> <span class="mf">10.50</span><span class="p">,</span>
    <span class="s1">&#39;USDCHF&#39;</span><span class="p">:</span> <span class="mf">0.8800</span><span class="p">,</span>
    <span class="s1">&#39;EURJPY&#39;</span><span class="p">:</span> <span class="mf">162.20</span><span class="p">,</span>
    <span class="s1">&#39;EURGBP&#39;</span><span class="p">:</span> <span class="mf">0.8580</span><span class="p">,</span>
    <span class="s1">&#39;GBPJPY&#39;</span><span class="p">:</span> <span class="mf">189.00</span><span class="p">,</span>
    <span class="s1">&#39;GBPCHF&#39;</span><span class="p">:</span> <span class="mf">1.1100</span>
<span class="p">}</span>

<span class="c1"># Generate synthetic price series for spread analysis</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="n">prices</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.08</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.002</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">),</span>
    <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.26</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.002</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># Generate report</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">generate_report</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

<span class="c1"># Analyze seasonality</span>
<span class="n">seasonal</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">analyze_seasonality</span><span class="p">(</span><span class="n">price_series</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best Month: </span><span class="si">{</span><span class="n">seasonal</span><span class="p">[</span><span class="s1">&#39;best_month&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Worst Month: </span><span class="si">{</span><span class="n">seasonal</span><span class="p">[</span><span class="s1">&#39;worst_month&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Currency Indices</strong>: DXY and custom indices measure relative currency strength</p>
</li>
<li>
<p><strong>Spread Trading</strong>: Inter-commodity, calendar, and pairs spreads offer relative value opportunities</p>
</li>
<li>
<p><strong>Options</strong>: FX options add strategic flexibility; delta hedging manages directional risk</p>
</li>
<li>
<p><strong>Seasonality</strong>: Calendar effects exist but require statistical validation</p>
</li>
<li>
<p><strong>Integration</strong>: Combining multiple approaches improves trading decisions</p>
</li>
</ol>
<hr />
<p><strong>Next Module</strong>: Module 13 - Automation &amp; Monitoring</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="13"><div class="md-cell module-header"><h1>Module 13: Automation &amp; Monitoring</h1>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Skill Level</strong></td>
<td>Advanced</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Modules 11-12</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:
- Build 24/7 scheduling systems with timezone awareness
- Implement comprehensive alert and notification systems
- Track real-time performance metrics
- Monitor system health and implement failover logic</p>
<h2>Prerequisites</h2>
<ul>
<li>Completed Module 11 (Live Trading)</li>
<li>Understanding of trading sessions and market hours</li>
<li>Familiarity with logging and error handling</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">time_module</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 13.1: Scheduling for 24/7</h2>
<p>Forex markets trade 24 hours, requiring sophisticated scheduling with timezone awareness.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">Timezone</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Major financial timezones.&quot;&quot;&quot;</span>
    <span class="n">UTC</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">NEW_YORK</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>  <span class="c1"># EST (adjust for DST)</span>
    <span class="n">LONDON</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># GMT (adjust for DST)</span>
    <span class="n">TOKYO</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">SYDNEY</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">FRANKFURT</span> <span class="o">=</span> <span class="mi">1</span>


<span class="k">class</span> <span class="nc">TimezoneConverter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Handle timezone conversions for global markets.&quot;&quot;&quot;</span>
    
    <span class="c1"># DST transitions (simplified)</span>
    <span class="n">DST_REGIONS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;US&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)},</span>    <span class="c1"># Mar 2nd Sun, Nov 1st Sun</span>
        <span class="s1">&#39;EU&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">)},</span>    <span class="c1"># Mar last Sun, Oct last Sun</span>
        <span class="s1">&#39;AU&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)},</span>    <span class="c1"># Oct 1st Sun, Apr 1st Sun</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_tz</span><span class="p">:</span> <span class="n">Timezone</span> <span class="o">=</span> <span class="n">Timezone</span><span class="o">.</span><span class="n">UTC</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_tz</span> <span class="o">=</span> <span class="n">local_tz</span>
        
    <span class="k">def</span> <span class="nf">utc_to_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">utc_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">target_tz</span><span class="p">:</span> <span class="n">Timezone</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert UTC to target timezone.&quot;&quot;&quot;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">target_tz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">utc_time</span> <span class="o">+</span> <span class="n">offset</span>
    
    <span class="k">def</span> <span class="nf">local_to_utc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">source_tz</span><span class="p">:</span> <span class="n">Timezone</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert local time to UTC.&quot;&quot;&quot;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">source_tz</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">local_time</span> <span class="o">-</span> <span class="n">offset</span>
    
    <span class="k">def</span> <span class="nf">get_session_times_utc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get trading session times in UTC.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;Sydney&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>      <span class="c1"># 21:00 - 06:00 UTC</span>
            <span class="s1">&#39;Tokyo&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>        <span class="c1"># 00:00 - 09:00 UTC</span>
            <span class="s1">&#39;London&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>      <span class="c1"># 07:00 - 16:00 UTC</span>
            <span class="s1">&#39;New York&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>   <span class="c1"># 12:00 - 21:00 UTC</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">is_session_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">utc_hour</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if a trading session is active.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">utc_hour</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utc_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span>
            
        <span class="n">sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session_times_utc</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="n">session</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">end</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Crosses midnight</span>
            <span class="k">return</span> <span class="n">utc_hour</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="ow">or</span> <span class="n">utc_hour</span> <span class="o">&lt;</span> <span class="n">end</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TradingScheduler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Schedule trading activities across sessions.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tz_converter</span> <span class="o">=</span> <span class="n">TimezoneConverter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">add_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> 
                 <span class="n">schedule_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a scheduled task.</span>
<span class="sd">        </span>
<span class="sd">        schedule_type:</span>
<span class="sd">        - &#39;interval&#39;: Run every N seconds (kwargs: interval_seconds)</span>
<span class="sd">        - &#39;daily&#39;: Run at specific time (kwargs: hour, minute, timezone)</span>
<span class="sd">        - &#39;session_start&#39;: Run when session opens (kwargs: session)</span>
<span class="sd">        - &#39;session_end&#39;: Run when session closes (kwargs: session)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;callback&#39;</span><span class="p">:</span> <span class="n">callback</span><span class="p">,</span>
            <span class="s1">&#39;schedule_type&#39;</span><span class="p">:</span> <span class="n">schedule_type</span><span class="p">,</span>
            <span class="s1">&#39;last_run&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">should_run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">current_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if task should run now.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="n">schedule_type</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;schedule_type&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">schedule_type</span> <span class="o">==</span> <span class="s1">&#39;interval&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;interval_seconds&#39;</span><span class="p">]</span>
            
        <span class="k">elif</span> <span class="n">schedule_type</span> <span class="o">==</span> <span class="s1">&#39;daily&#39;</span><span class="p">:</span>
            <span class="n">target_hour</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span>
            <span class="n">target_minute</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">current_time</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="n">target_hour</span> <span class="ow">and</span> <span class="n">current_time</span><span class="o">.</span><span class="n">minute</span> <span class="o">==</span> <span class="n">target_minute</span><span class="p">:</span>
                <span class="c1"># Check if already run today</span>
                <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">current_time</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                
        <span class="k">elif</span> <span class="n">schedule_type</span> <span class="o">==</span> <span class="s1">&#39;session_start&#39;</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span>
            <span class="n">sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_converter</span><span class="o">.</span><span class="n">get_session_times_utc</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
                <span class="n">start_hour</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="n">session</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">current_time</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="n">start_hour</span> <span class="ow">and</span> <span class="n">current_time</span><span class="o">.</span><span class="n">minute</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">return</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">current_time</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                    
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">run_pending</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run all pending tasks.&quot;&quot;&quot;</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">executed</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_run_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">current_time</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">task</span><span class="p">[</span><span class="s1">&#39;callback&#39;</span><span class="p">]()</span>
                    <span class="n">task</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span>
                    <span class="n">executed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
        <span class="k">return</span> <span class="n">executed</span>
    
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get status of all scheduled tasks.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_tasks</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;schedule_type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Enabled&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Last Run&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">]</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate scheduler</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="n">TradingScheduler</span><span class="p">()</span>

<span class="c1"># Add various tasks</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;price_check&#39;</span><span class="p">,</span>
    <span class="n">callback</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking prices...&quot;</span><span class="p">),</span>
    <span class="n">schedule_type</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span>
    <span class="n">interval_seconds</span><span class="o">=</span><span class="mi">60</span>
<span class="p">)</span>

<span class="n">scheduler</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;daily_report&#39;</span><span class="p">,</span>
    <span class="n">callback</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating daily report...&quot;</span><span class="p">),</span>
    <span class="n">schedule_type</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
    <span class="n">hour</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span>  <span class="c1"># 5 PM UTC</span>
    <span class="n">minute</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>

<span class="n">scheduler</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;london_open&#39;</span><span class="p">,</span>
    <span class="n">callback</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;London session opening...&quot;</span><span class="p">),</span>
    <span class="n">schedule_type</span><span class="o">=</span><span class="s1">&#39;session_start&#39;</span><span class="p">,</span>
    <span class="n">session</span><span class="o">=</span><span class="s1">&#39;London&#39;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scheduled Tasks:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scheduler</span><span class="o">.</span><span class="n">get_status</span><span class="p">())</span>

<span class="c1"># Run pending tasks</span>
<span class="n">executed</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Executed: </span><span class="si">{</span><span class="n">executed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">WeekendHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Handle weekend market closures.&quot;&quot;&quot;</span>
    
    <span class="c1"># Forex closes Friday 21:00 UTC, opens Sunday 21:00 UTC</span>
    <span class="n">CLOSE_DAY</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Friday</span>
    <span class="n">CLOSE_HOUR</span> <span class="o">=</span> <span class="mi">21</span>
    <span class="n">OPEN_DAY</span> <span class="o">=</span> <span class="mi">6</span>   <span class="c1"># Sunday</span>
    <span class="n">OPEN_HOUR</span> <span class="o">=</span> <span class="mi">21</span>
    
    <span class="k">def</span> <span class="nf">is_weekend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if market is closed for weekend.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            
        <span class="n">weekday</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
        <span class="n">hour</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
        
        <span class="c1"># Saturday</span>
        <span class="k">if</span> <span class="n">weekday</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># Friday after close</span>
        <span class="k">if</span> <span class="n">weekday</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOSE_DAY</span> <span class="ow">and</span> <span class="n">hour</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOSE_HOUR</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># Sunday before open</span>
        <span class="k">if</span> <span class="n">weekday</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPEN_DAY</span> <span class="ow">and</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPEN_HOUR</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">time_to_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate time until market opens.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_weekend</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="c1"># Find next Sunday 21:00 UTC</span>
        <span class="n">days_to_sunday</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">())</span> <span class="o">%</span> <span class="mi">7</span>
        <span class="k">if</span> <span class="n">days_to_sunday</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPEN_HOUR</span><span class="p">:</span>
            <span class="n">days_to_sunday</span> <span class="o">=</span> <span class="mi">7</span>
            
        <span class="n">next_open</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">OPEN_HOUR</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">next_open</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_to_sunday</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">next_open</span> <span class="o">-</span> <span class="n">dt</span>
    
    <span class="k">def</span> <span class="nf">time_to_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate time until market closes for weekend.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_weekend</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="c1"># Find next Friday 21:00 UTC</span>
        <span class="n">days_to_friday</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">())</span> <span class="o">%</span> <span class="mi">7</span>
        <span class="k">if</span> <span class="n">days_to_friday</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLOSE_HOUR</span><span class="p">:</span>
            <span class="n">days_to_friday</span> <span class="o">=</span> <span class="mi">7</span>
            
        <span class="n">next_close</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CLOSE_HOUR</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">next_close</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_to_friday</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">next_close</span> <span class="o">-</span> <span class="n">dt</span>


<span class="c1"># Test weekend handler</span>
<span class="n">weekend</span> <span class="o">=</span> <span class="n">WeekendHandler</span><span class="p">()</span>

<span class="c1"># Test different times</span>
<span class="n">test_times</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Friday 20:00 - open</span>
    <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Friday 22:00 - closed</span>
    <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Saturday - closed</span>
    <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Sunday 20:00 - closed</span>
    <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Sunday 22:00 - open</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Weekend Status Check:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">test_times</span><span class="p">:</span>
    <span class="n">is_closed</span> <span class="o">=</span> <span class="n">weekend</span><span class="o">.</span><span class="n">is_weekend</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%A %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;CLOSED&#39;</span> <span class="k">if</span> <span class="n">is_closed</span> <span class="k">else</span> <span class="s1">&#39;OPEN&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 13.2: Alerts &amp; Notifications</h2>
<p>Comprehensive alerting for price movements, signals, and system events.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">AlertLevel</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">INFO</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span>
    <span class="n">WARNING</span> <span class="o">=</span> <span class="s2">&quot;warning&quot;</span>
    <span class="n">CRITICAL</span> <span class="o">=</span> <span class="s2">&quot;critical&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Alert</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a single alert.&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">level</span><span class="p">:</span> <span class="n">AlertLevel</span>
    <span class="n">category</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">acknowledged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">AlertManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage alerts and notifications.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_alerts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="p">:</span> <span class="n">deque</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">max_alerts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppression_rules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a notification handler (email, SMS, etc.).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">suppress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">duration_minutes</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Suppress alerts of a category for a duration.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppression_rules</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">duration_minutes</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_is_suppressed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if category is suppressed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">category</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppression_rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppression_rules</span><span class="p">[</span><span class="n">category</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppression_rules</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">create_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">AlertLevel</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Alert</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create and dispatch an alert.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_suppressed</span><span class="p">(</span><span class="n">category</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">alert</span> <span class="o">=</span> <span class="n">Alert</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ALT-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alert_count</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
        
        <span class="c1"># Dispatch to handlers</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">handler</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handler error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="k">return</span> <span class="n">alert</span>
    
    <span class="k">def</span> <span class="nf">get_active_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">AlertLevel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Alert</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get unacknowledged alerts.&quot;&quot;&quot;</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">acknowledged</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">level</span><span class="p">:</span>
            <span class="n">alerts</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alerts</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">level</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">alerts</span>
    
    <span class="k">def</span> <span class="nf">acknowledge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Acknowledge an alert.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alert</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">alert_id</span><span class="p">:</span>
                <span class="n">alert</span><span class="o">.</span><span class="n">acknowledged</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
    
    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get alert summary.&quot;&quot;&quot;</span>
        <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_alerts</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="p">),</span>
            <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">active</span><span class="p">),</span>
            <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">active</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">AlertLevel</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">]),</span>
            <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">active</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">AlertLevel</span><span class="o">.</span><span class="n">WARNING</span><span class="p">]),</span>
            <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">active</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">AlertLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">])</span>
        <span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">PriceAlertMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor prices and generate alerts.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_manager</span><span class="p">:</span> <span class="n">AlertManager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">alert_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_alerts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">add_price_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                        <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a price alert.</span>
<span class="sd">        </span>
<span class="sd">        condition: &#39;above&#39;, &#39;below&#39;, &#39;cross_above&#39;, &#39;cross_below&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">,</span>
            <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="n">condition</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instrument</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;triggered&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;last_price&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">check_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Check all price alerts against current prices.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_alerts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
                
            <span class="n">instrument</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">instrument</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_prices</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="n">current</span> <span class="o">=</span> <span class="n">current_prices</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;last_price&#39;</span><span class="p">]</span>
            
            <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;below&#39;</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
                <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;cross_above&#39;</span> <span class="ow">and</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last</span> <span class="o">&lt;=</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                    <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;cross_below&#39;</span> <span class="ow">and</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last</span> <span class="o">&gt;=</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
                    <span class="n">should_trigger</span> <span class="o">=</span> <span class="kc">True</span>
                    
            <span class="k">if</span> <span class="n">should_trigger</span><span class="p">:</span>
                <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">create_alert</span><span class="p">(</span>
                    <span class="n">level</span><span class="o">=</span><span class="n">AlertLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="n">category</span><span class="o">=</span><span class="s1">&#39;price_alert&#39;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">],</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">}</span>
                <span class="p">)</span>
                
            <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;last_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SignalAlertMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor trading signals and generate alerts.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_manager</span><span class="p">:</span> <span class="n">AlertManager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">alert_manager</span>
        
    <span class="k">def</span> <span class="nf">on_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a new trading signal.&quot;&quot;&quot;</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instrument&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        <span class="n">strength</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;strength&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Determine alert level based on signal strength</span>
        <span class="k">if</span> <span class="n">strength</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">AlertLevel</span><span class="o">.</span><span class="n">CRITICAL</span>
        <span class="k">elif</span> <span class="n">strength</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">AlertLevel</span><span class="o">.</span><span class="n">WARNING</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">AlertLevel</span><span class="o">.</span><span class="n">INFO</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">create_alert</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="s1">&#39;trading_signal&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">direction</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> signal on </span><span class="si">{</span><span class="n">instrument</span><span class="si">}</span><span class="s2"> (strength: </span><span class="si">{</span><span class="n">strength</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">signal</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">ErrorAlertMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor system errors and generate alerts.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_manager</span><span class="p">:</span> <span class="n">AlertManager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">alert_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Alert after 3 errors of same type</span>
        
    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle an error.&quot;&quot;&quot;</span>
        <span class="c1"># Track error count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span><span class="p">[</span><span class="n">error_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_counts</span><span class="p">[</span><span class="n">error_type</span><span class="p">]</span>
        
        <span class="c1"># Determine level based on frequency</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">*</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">AlertLevel</span><span class="o">.</span><span class="n">CRITICAL</span>
        <span class="k">elif</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">AlertLevel</span><span class="o">.</span><span class="n">WARNING</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">AlertLevel</span><span class="o">.</span><span class="n">INFO</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">create_alert</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="s1">&#39;system_error&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2"> (count: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;error_type&#39;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">context</span> <span class="ow">or</span> <span class="p">{}}</span>
        <span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate alert system</span>
<span class="n">alert_manager</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>

<span class="c1"># Add console handler</span>
<span class="k">def</span> <span class="nf">console_handler</span><span class="p">(</span><span class="n">alert</span><span class="p">:</span> <span class="n">Alert</span><span class="p">):</span>
    <span class="n">level_icon</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">}[</span><span class="n">alert</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">level_icon</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">alert</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">alert</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">alert_manager</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>

<span class="c1"># Setup monitors</span>
<span class="n">price_monitor</span> <span class="o">=</span> <span class="n">PriceAlertMonitor</span><span class="p">(</span><span class="n">alert_manager</span><span class="p">)</span>
<span class="n">signal_monitor</span> <span class="o">=</span> <span class="n">SignalAlertMonitor</span><span class="p">(</span><span class="n">alert_manager</span><span class="p">)</span>
<span class="n">error_monitor</span> <span class="o">=</span> <span class="n">ErrorAlertMonitor</span><span class="p">(</span><span class="n">alert_manager</span><span class="p">)</span>

<span class="c1"># Add price alerts</span>
<span class="n">price_monitor</span><span class="o">.</span><span class="n">add_price_alert</span><span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;above&#39;</span><span class="p">,</span> <span class="mf">1.0900</span><span class="p">,</span> <span class="s1">&#39;EURUSD broke above 1.0900!&#39;</span><span class="p">)</span>
<span class="n">price_monitor</span><span class="o">.</span><span class="n">add_price_alert</span><span class="p">(</span><span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;below&#39;</span><span class="p">,</span> <span class="mf">1.2600</span><span class="p">,</span> <span class="s1">&#39;GBPUSD fell below 1.2600!&#39;</span><span class="p">)</span>

<span class="c1"># Simulate price updates</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Price Updates ---&quot;</span><span class="p">)</span>
<span class="n">price_monitor</span><span class="o">.</span><span class="n">check_prices</span><span class="p">({</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="mf">1.0850</span><span class="p">,</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="mf">1.2650</span><span class="p">})</span>
<span class="n">price_monitor</span><span class="o">.</span><span class="n">check_prices</span><span class="p">({</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="mf">1.0920</span><span class="p">,</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="mf">1.2580</span><span class="p">})</span>

<span class="c1"># Simulate signal</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Trading Signal ---&quot;</span><span class="p">)</span>
<span class="n">signal_monitor</span><span class="o">.</span><span class="n">on_signal</span><span class="p">({</span>
    <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
    <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="mf">1.0920</span>
<span class="p">})</span>

<span class="c1"># Summary</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Alert Summary: </span><span class="si">{</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">get_summary</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 13.3: Performance Tracking</h2>
<p>Real-time performance monitoring and reporting.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TradeRecord</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Record of a completed trade.&quot;&quot;&quot;</span>
    <span class="n">trade_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">units</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">entry_time</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">exit_time</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">pnl</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">pnl_pips</span><span class="p">:</span> <span class="nb">float</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_time</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_winner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">PerformanceTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track and analyze trading performance.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_balance</span> <span class="o">=</span> <span class="n">initial_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_balance</span> <span class="o">=</span> <span class="n">initial_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TradeRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="n">initial_balance</span><span class="p">,</span>
            <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="n">initial_balance</span>
        <span class="p">}]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">record_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">TradeRecord</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record a completed trade.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_balance</span> <span class="o">+=</span> <span class="n">trade</span><span class="o">.</span><span class="n">pnl</span>
        
        <span class="c1"># Update equity curve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">trade</span><span class="o">.</span><span class="n">exit_time</span><span class="p">,</span>
            <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_balance</span><span class="p">,</span>
            <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_balance</span>
        <span class="p">})</span>
        
        <span class="c1"># Update daily P&amp;L</span>
        <span class="n">date_key</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">exit_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">[</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">date_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">trade</span><span class="o">.</span><span class="n">pnl</span>
        
    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate comprehensive statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;trades&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            
        <span class="n">winners</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_winner</span><span class="p">]</span>
        <span class="n">losers</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">is_winner</span><span class="p">]</span>
        
        <span class="n">total_pnl</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        
        <span class="n">avg_win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">winners</span><span class="p">])</span> <span class="k">if</span> <span class="n">winners</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">losers</span><span class="p">])</span> <span class="k">if</span> <span class="n">losers</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># Calculate max drawdown</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">equity_curve</span><span class="p">]</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">equity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">equity</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="n">peak</span><span class="p">:</span>
                <span class="n">peak</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="n">e</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
            <span class="n">max_dd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_dd</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span>
            
        <span class="c1"># Calculate profit factor</span>
        <span class="n">gross_profit</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">winners</span><span class="p">)</span>
        <span class="n">gross_loss</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">losers</span><span class="p">))</span>
        <span class="n">profit_factor</span> <span class="o">=</span> <span class="n">gross_profit</span> <span class="o">/</span> <span class="n">gross_loss</span> <span class="k">if</span> <span class="n">gross_loss</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;winners&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">),</span>
            <span class="s1">&#39;losers&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">losers</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="n">total_pnl</span><span class="p">,</span>
            <span class="s1">&#39;return_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_balance</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_balance</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;avg_win&#39;</span><span class="p">:</span> <span class="n">avg_win</span><span class="p">,</span>
            <span class="s1">&#39;avg_loss&#39;</span><span class="p">:</span> <span class="n">avg_loss</span><span class="p">,</span>
            <span class="s1">&#39;profit_factor&#39;</span><span class="p">:</span> <span class="n">profit_factor</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown_pct&#39;</span><span class="p">:</span> <span class="n">max_dd</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;avg_trade_duration&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">])</span>
        <span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">RealTimePnLTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track P&amp;L in real-time.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_manager</span><span class="p">:</span> <span class="n">AlertManager</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">realized_pnl</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">alert_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_limit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>  <span class="c1"># Max daily loss</span>
        
    <span class="k">def</span> <span class="nf">open_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">units</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                      <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pip_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record position opening.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;pip_value&#39;</span><span class="p">:</span> <span class="n">pip_value</span><span class="p">,</span>
            <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">:</span> <span class="mf">0.0</span>
        <span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">update_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update price and recalculate unrealized P&amp;L.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">instrument</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span>
        <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;current_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_price</span>
        
        <span class="c1"># Calculate unrealized P&amp;L</span>
        <span class="n">price_diff</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Short position</span>
            <span class="n">price_diff</span> <span class="o">=</span> <span class="o">-</span><span class="n">price_diff</span>
            
        <span class="n">pips</span> <span class="o">=</span> <span class="n">price_diff</span> <span class="o">*</span> <span class="mi">10000</span>  <span class="c1"># Assuming 4 decimal places</span>
        <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pips</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;pip_value&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100000</span>
        
    <span class="k">def</span> <span class="nf">close_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close position and realize P&amp;L.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">instrument</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
            
        <span class="n">pnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">instrument</span><span class="p">][</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">realized_pnl</span> <span class="o">+=</span> <span class="n">pnl</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span>
        
        <span class="c1"># Check daily limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_daily_limit</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">pnl</span>
    
    <span class="k">def</span> <span class="nf">_check_daily_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if daily loss limit is breached.&quot;&quot;&quot;</span>
        <span class="n">total_pnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_pnl</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">total_pnl</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">create_alert</span><span class="p">(</span>
                <span class="n">level</span><span class="o">=</span><span class="n">AlertLevel</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="s1">&#39;risk_limit&#39;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Daily loss limit breached: $</span><span class="si">{</span><span class="n">total_pnl</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;realized&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">realized_pnl</span><span class="p">,</span> <span class="s1">&#39;unrealized&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unrealized_pnl</span><span class="p">()}</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_unrealized_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get total unrealized P&amp;L.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">get_total_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get total P&amp;L (realized + unrealized).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">realized_pnl</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unrealized_pnl</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_position_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get summary of all positions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inst</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Instrument&#39;</span><span class="p">:</span> <span class="n">inst</span><span class="p">,</span>
                <span class="s1">&#39;Units&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Entry&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;entry_price&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Current&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;current_price&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Unrealized P&amp;L&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">]</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate performance tracking</span>
<span class="n">tracker</span> <span class="o">=</span> <span class="n">PerformanceTracker</span><span class="p">(</span><span class="n">initial_balance</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

<span class="c1"># Simulate some trades</span>
<span class="n">sample_trades</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">TradeRecord</span><span class="p">(</span><span class="s1">&#39;T001&#39;</span><span class="p">,</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mf">1.0800</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> 
                <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="n">TradeRecord</span><span class="p">(</span><span class="s1">&#39;T002&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span> <span class="mf">1.2700</span><span class="p">,</span> <span class="mf">1.2650</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
    <span class="n">TradeRecord</span><span class="p">(</span><span class="s1">&#39;T003&#39;</span><span class="p">,</span> <span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mf">148.00</span><span class="p">,</span> <span class="mf">147.50</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">33</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">),</span>
    <span class="n">TradeRecord</span><span class="p">(</span><span class="s1">&#39;T004&#39;</span><span class="p">,</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mf">1.0850</span><span class="p">,</span> <span class="mf">1.0920</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">sample_trades</span><span class="p">:</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">record_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>

<span class="c1"># Get statistics</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performance Statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">DailySummaryReport</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate daily performance summaries.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracker</span><span class="p">:</span> <span class="n">PerformanceTracker</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span> <span class="o">=</span> <span class="n">tracker</span>
        
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate daily summary report.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="c1"># Get trades for the date</span>
        <span class="n">day_trades</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">trades</span> 
                     <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">exit_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">date</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">day_trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;No trades on </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
            
        <span class="n">day_pnl</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">day_trades</span><span class="p">)</span>
        <span class="n">winners</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">day_trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_winner</span><span class="p">]</span>
        
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;DAILY PERFORMANCE SUMMARY - </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">day_trades</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Winners: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">day_trades</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Losers: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">day_trades</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Daily P&amp;L: $</span><span class="si">{</span><span class="n">day_pnl</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Account Balance: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">current_balance</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Trade Details:&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">day_trades</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;WIN&#39;</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_winner</span> <span class="k">else</span> <span class="s1">&#39;LOSS&#39;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">instrument</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">pnl_pips</span><span class="si">:</span><span class="s2">+.1f</span><span class="si">}</span><span class="s2"> pips ($</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span><span class="si">:</span><span class="s2">+.2f</span><span class="si">}</span><span class="s2">) [</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<span class="c1"># Generate daily report</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">DailySummaryReport</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 13.4: System Health</h2>
<p>Monitor system health and implement failover logic.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">HealthStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">HEALTHY</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>
    <span class="n">DEGRADED</span> <span class="o">=</span> <span class="s2">&quot;degraded&quot;</span>
    <span class="n">CRITICAL</span> <span class="o">=</span> <span class="s2">&quot;critical&quot;</span>
    <span class="n">OFFLINE</span> <span class="o">=</span> <span class="s2">&quot;offline&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">HealthCheck</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Result of a health check.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">HealthStatus</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">latency_ms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">last_check</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SystemHealthMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive system health monitoring.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_manager</span><span class="p">:</span> <span class="n">AlertManager</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">alert_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">HealthCheck</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_history</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">HealthCheck</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_history</span> <span class="o">=</span> <span class="mi">100</span>
        
    <span class="k">def</span> <span class="nf">register_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">checker</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">HealthCheck</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Register a health check function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_history</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkers</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_checkers&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">checker</span>
        
    <span class="k">def</span> <span class="nf">run_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HealthCheck</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run a specific health check.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HealthCheck</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">OFFLINE</span><span class="p">,</span> <span class="s2">&quot;Check not registered&quot;</span><span class="p">)</span>
            
        <span class="n">start</span> <span class="o">=</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkers</span><span class="p">[</span><span class="n">name</span><span class="p">]()</span>
            <span class="n">result</span><span class="o">.</span><span class="n">latency_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">HealthCheck</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">latency_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            
        <span class="c1"># Store result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_history</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_history</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_history</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_history</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="c1"># Alert on status changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_status_change</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">run_all_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">HealthCheck</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run all registered health checks.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_check</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span>
    
    <span class="k">def</span> <span class="nf">_check_status_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current</span><span class="p">:</span> <span class="n">HealthCheck</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for status changes and alert.&quot;&quot;&quot;</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_history</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="n">previous</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">previous</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">current</span><span class="o">.</span><span class="n">status</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">AlertLevel</span><span class="o">.</span><span class="n">CRITICAL</span> <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">HealthStatus</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">OFFLINE</span><span class="p">]</span> <span class="k">else</span> <span class="n">AlertLevel</span><span class="o">.</span><span class="n">WARNING</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">create_alert</span><span class="p">(</span>
                <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="s1">&#39;health_status&#39;</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> status changed: </span><span class="si">{</span><span class="n">previous</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">current</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;check&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;previous&#39;</span><span class="p">:</span> <span class="n">previous</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">current</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_overall_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HealthStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get overall system health status.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">OFFLINE</span>
            
        <span class="n">statuses</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">status</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">OFFLINE</span> <span class="ow">in</span> <span class="n">statuses</span> <span class="ow">or</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">CRITICAL</span> <span class="ow">in</span> <span class="n">statuses</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">CRITICAL</span>
        <span class="k">elif</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">DEGRADED</span> <span class="ow">in</span> <span class="n">statuses</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">DEGRADED</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span>
    
    <span class="k">def</span> <span class="nf">get_uptime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate uptime percentage for a check.&quot;&quot;&quot;</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_history</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
            
        <span class="n">healthy</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">healthy</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate health status report.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;SYSTEM HEALTH REPORT - </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Overall Status: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_overall_status</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Component Status:&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">]</span>
        
        <span class="n">status_icons</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">:</span> <span class="s1">&#39;[OK]&#39;</span><span class="p">,</span>
            <span class="n">HealthStatus</span><span class="o">.</span><span class="n">DEGRADED</span><span class="p">:</span> <span class="s1">&#39;[!!]&#39;</span><span class="p">,</span>
            <span class="n">HealthStatus</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">:</span> <span class="s1">&#39;[XX]&#39;</span><span class="p">,</span>
            <span class="n">HealthStatus</span><span class="o">.</span><span class="n">OFFLINE</span><span class="p">:</span> <span class="s1">&#39;[--]&#39;</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">check</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
                <span class="n">icon</span> <span class="o">=</span> <span class="n">status_icons</span><span class="p">[</span><span class="n">check</span><span class="o">.</span><span class="n">status</span><span class="p">]</span>
                <span class="n">uptime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uptime</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">check</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2"> (latency: </span><span class="si">{</span><span class="n">check</span><span class="o">.</span><span class="n">latency_ms</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">ms, uptime: </span><span class="si">{</span><span class="n">uptime</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [--] </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: Not checked&quot;</span><span class="p">)</span>
                
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">DataQualityChecker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check data feed quality.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap_threshold</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># 1% price gap is suspicious</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stale_threshold</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># Seconds before data is considered stale</span>
        
    <span class="k">def</span> <span class="nf">check_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check price data quality.&quot;&quot;&quot;</span>
        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_prices</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_prices</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span>
            
            <span class="c1"># Check for gaps</span>
            <span class="n">change</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">price</span> <span class="o">/</span> <span class="n">last</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">change</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap_threshold</span><span class="p">:</span>
                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Large price gap: </span><span class="si">{</span><span class="n">change</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                
            <span class="c1"># Check for stale data</span>
            <span class="n">time_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">last</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">time_diff</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stale_threshold</span><span class="p">:</span>
                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data was stale for </span><span class="si">{</span><span class="n">time_diff</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
                
        <span class="c1"># Update last price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_prices</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">issues</span><span class="p">,</span>
            <span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">FailoverManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage failover between primary and backup systems.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failover_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_failover</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cooldown_minutes</span> <span class="o">=</span> <span class="mi">5</span>
        
    <span class="k">def</span> <span class="nf">trigger_failover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Trigger failover to backup system.&quot;&quot;&quot;</span>
        <span class="c1"># Check cooldown</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_failover</span><span class="p">:</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_failover</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
            <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cooldown_minutes</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_active</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_active</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failover_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_failover</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;backup&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_active</span> <span class="k">else</span> <span class="s2">&quot;primary&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FAILOVER: Switched to </span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s2"> system. Reason: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">get_active_system</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get currently active system.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;primary&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_active</span> <span class="k">else</span> <span class="s2">&quot;backup&quot;</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate health monitoring</span>
<span class="n">health_monitor</span> <span class="o">=</span> <span class="n">SystemHealthMonitor</span><span class="p">(</span><span class="n">alert_manager</span><span class="p">)</span>

<span class="c1"># Register health checks</span>
<span class="k">def</span> <span class="nf">check_broker_connection</span><span class="p">():</span>
    <span class="c1"># Simulated check</span>
    <span class="k">return</span> <span class="n">HealthCheck</span><span class="p">(</span><span class="s2">&quot;broker_connection&quot;</span><span class="p">,</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">,</span> <span class="s2">&quot;Connected to broker&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_data_feed</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">HealthCheck</span><span class="p">(</span><span class="s2">&quot;data_feed&quot;</span><span class="p">,</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">,</span> <span class="s2">&quot;Data feed active&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_strategy_engine</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">HealthCheck</span><span class="p">(</span><span class="s2">&quot;strategy_engine&quot;</span><span class="p">,</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">,</span> <span class="s2">&quot;Strategy running&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_database</span><span class="p">():</span>
    <span class="c1"># Simulate degraded state</span>
    <span class="k">return</span> <span class="n">HealthCheck</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">DEGRADED</span><span class="p">,</span> <span class="s2">&quot;High latency detected&quot;</span><span class="p">)</span>

<span class="n">health_monitor</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="s2">&quot;broker_connection&quot;</span><span class="p">,</span> <span class="n">check_broker_connection</span><span class="p">)</span>
<span class="n">health_monitor</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="s2">&quot;data_feed&quot;</span><span class="p">,</span> <span class="n">check_data_feed</span><span class="p">)</span>
<span class="n">health_monitor</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="s2">&quot;strategy_engine&quot;</span><span class="p">,</span> <span class="n">check_strategy_engine</span><span class="p">)</span>
<span class="n">health_monitor</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="n">check_database</span><span class="p">)</span>

<span class="c1"># Run all checks</span>
<span class="n">health_monitor</span><span class="o">.</span><span class="n">run_all_checks</span><span class="p">()</span>

<span class="c1"># Generate report</span>
<span class="nb">print</span><span class="p">(</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2></div>
<div class="md-cell"><h3>Exercise 1: Session-Based Scheduler (Guided)</h3>
<p>Create a scheduler that runs different logic for different trading sessions.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SessionBasedScheduler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Run different tasks based on trading session.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_tasks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Sydney&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;Tokyo&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;London&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;New_York&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tz_converter</span> <span class="o">=</span> <span class="n">TimezoneConverter</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">add_session_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a task for a specific session.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_tasks</span><span class="p">[</span><span class="n">session</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>  <span class="c1"># Add task to list</span>
            
    <span class="k">def</span> <span class="nf">get_current_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get currently active sessions.&quot;&quot;&quot;</span>
        <span class="n">current_hour</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span>
        <span class="n">active</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Sydney&#39;</span><span class="p">,</span> <span class="s1">&#39;Tokyo&#39;</span><span class="p">,</span> <span class="s1">&#39;London&#39;</span><span class="p">,</span> <span class="s1">&#39;New_York&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz_converter</span><span class="o">.</span><span class="n">is_session_active</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">current_hour</span><span class="p">):</span>
                <span class="n">active</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">______</span><span class="p">)</span> <span class="c1"># Append session name</span>
                
        <span class="k">return</span> <span class="n">active</span>
    
    <span class="k">def</span> <span class="nf">run_session_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run all tasks for currently active sessions.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">active_sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_sessions</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">active_sessions</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_tasks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">executed</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">______</span><span class="p">:</span>  <span class="c1"># Iterate over tasks</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">task</span><span class="p">()</span>
                    <span class="n">executed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task error in </span><span class="si">{</span><span class="n">session</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
            <span class="n">results</span><span class="p">[</span><span class="n">session</span><span class="p">]</span> <span class="o">=</span> <span class="n">executed</span>
            
        <span class="k">return</span> <span class="n">results</span>


<span class="c1"># Test the scheduler</span>
<span class="n">session_scheduler</span> <span class="o">=</span> <span class="n">SessionBasedScheduler</span><span class="p">()</span>

<span class="n">session_scheduler</span><span class="o">.</span><span class="n">add_session_task</span><span class="p">(</span><span class="s1">&#39;London&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Checking EUR pairs...&quot;</span><span class="p">))</span>
<span class="n">session_scheduler</span><span class="o">.</span><span class="n">add_session_task</span><span class="p">(</span><span class="s1">&#39;New_York&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Checking USD pairs...&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active sessions: </span><span class="si">{</span><span class="n">session_scheduler</span><span class="o">.</span><span class="n">get_current_sessions</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running session tasks:&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">session_scheduler</span><span class="o">.</span><span class="n">run_session_tasks</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results: </span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 2: Multi-Channel Alert System (Guided)</h3>
<p>Create an alert system with multiple notification channels.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">NotificationChannel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for notification channels.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert</span><span class="p">:</span> <span class="n">Alert</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">class</span> <span class="nc">ConsoleChannel</span><span class="p">(</span><span class="n">NotificationChannel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print alerts to console.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert</span><span class="p">:</span> <span class="n">Alert</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">alert</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">alert</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">EmailChannel</span><span class="p">(</span><span class="n">NotificationChannel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Send alerts via email (simulated).&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recipient</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recipient</span> <span class="o">=</span> <span class="n">recipient</span>
        
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert</span><span class="p">:</span> <span class="n">Alert</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EMAIL to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recipient</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">alert</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">______</span>  <span class="c1"># Return success status</span>


<span class="k">class</span> <span class="nc">MultiChannelAlertManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Alert manager with multiple notification channels.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NotificationChannel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routing_rules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">AlertLevel</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">AlertLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">:</span> <span class="p">[],</span>
            <span class="n">AlertLevel</span><span class="o">.</span><span class="n">WARNING</span><span class="p">:</span> <span class="p">[],</span>
            <span class="n">AlertLevel</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_count</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">add_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="n">NotificationChannel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a notification channel.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">______</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>  <span class="c1"># Store channel by name</span>
        
    <span class="k">def</span> <span class="nf">set_routing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">AlertLevel</span><span class="p">,</span> <span class="n">channels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Set which channels receive which alert levels.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routing_rules</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">channels</span>
        
    <span class="k">def</span> <span class="nf">send_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">AlertLevel</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create and send alert through appropriate channels.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">alert</span> <span class="o">=</span> <span class="n">Alert</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ALT-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alert_count</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="s1">&#39;general&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="p">)</span>
        
        <span class="c1"># Get channels for this level</span>
        <span class="n">channel_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing_rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="p">[])</span>
        
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">channel_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">______</span><span class="p">:</span>  <span class="c1"># Access channels dict</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>


<span class="c1"># Test multi-channel alerts</span>
<span class="n">mcam</span> <span class="o">=</span> <span class="n">MultiChannelAlertManager</span><span class="p">()</span>

<span class="n">mcam</span><span class="o">.</span><span class="n">add_channel</span><span class="p">(</span><span class="s1">&#39;console&#39;</span><span class="p">,</span> <span class="n">ConsoleChannel</span><span class="p">())</span>
<span class="n">mcam</span><span class="o">.</span><span class="n">add_channel</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="n">EmailChannel</span><span class="p">(</span><span class="s1">&#39;trader@example.com&#39;</span><span class="p">))</span>

<span class="c1"># Route INFO to console only, WARNING and CRITICAL to both</span>
<span class="n">mcam</span><span class="o">.</span><span class="n">set_routing</span><span class="p">(</span><span class="n">AlertLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;console&#39;</span><span class="p">])</span>
<span class="n">mcam</span><span class="o">.</span><span class="n">set_routing</span><span class="p">(</span><span class="n">AlertLevel</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;console&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">])</span>
<span class="n">mcam</span><span class="o">.</span><span class="n">set_routing</span><span class="p">(</span><span class="n">AlertLevel</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;console&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sending alerts:&quot;</span><span class="p">)</span>
<span class="n">mcam</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span><span class="n">AlertLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="s2">&quot;System started&quot;</span><span class="p">)</span>
<span class="n">mcam</span><span class="o">.</span><span class="n">send_alert</span><span class="p">(</span><span class="n">AlertLevel</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span> <span class="s2">&quot;Connection lost!&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 3: Performance Dashboard (Guided)</h3>
<p>Create a real-time performance dashboard data structure.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">PerformanceDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Real-time performance dashboard.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracker</span><span class="p">:</span> <span class="n">PerformanceTracker</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span> <span class="o">=</span> <span class="n">tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_interval</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_refresh</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">get_dashboard_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get all dashboard data.&quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="n">stats</span><span class="p">),</span>
            <span class="s1">&#39;recent_trades&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_recent_trades</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
            <span class="s1">&#39;daily_pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_daily_pnl</span><span class="p">(),</span>
            <span class="s1">&#39;updated_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stats</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get summary metrics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;______&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Get win rate</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_trades&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;profit_factor&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profit_factor&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_get_recent_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get N most recent trades.&quot;&quot;&quot;</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">trades</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span>
                <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">______</span><span class="p">,</span>  <span class="c1"># Get P&amp;L</span>
                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">exit_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
        <span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_get_daily_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get daily P&amp;L for charting.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">pnl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">daily_pnl</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        <span class="p">]</span>  <span class="c1"># Iterate over items</span>


<span class="c1"># Create dashboard</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">PerformanceDashboard</span><span class="p">(</span><span class="n">tracker</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">get_dashboard_data</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Dashboard Data:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 4: 24/7 Task Runner</h3>
<p>Build a complete 24/7 task runner with weekend handling.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4: Build a TwentyFourSevenRunner class that:</span>
<span class="c1"># 1. Runs continuously with configurable sleep interval</span>
<span class="c1"># 2. Automatically pauses during weekends</span>
<span class="c1"># 3. Executes different tasks based on trading session</span>
<span class="c1"># 4. Logs all activity</span>
<span class="c1"># 5. Handles graceful shutdown</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 5: Advanced Alert Rules</h3>
<p>Create an advanced alert rule engine.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 5: Build an AlertRuleEngine class that:</span>
<span class="c1"># 1. Supports complex conditions (AND, OR, NOT)</span>
<span class="c1"># 2. Has rate limiting per rule (max N alerts per hour)</span>
<span class="c1"># 3. Supports time-based rules (only alert during certain hours)</span>
<span class="c1"># 4. Can escalate alerts if condition persists</span>
<span class="c1"># 5. Generates alert statistics</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 6: System Recovery</h3>
<p>Build an automatic system recovery manager.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 6: Build a SystemRecoveryManager class that:</span>
<span class="c1"># 1. Detects when components are unhealthy</span>
<span class="c1"># 2. Attempts automatic recovery (reconnect, restart)</span>
<span class="c1"># 3. Implements exponential backoff for retries</span>
<span class="c1"># 4. Triggers failover after N failed attempts</span>
<span class="c1"># 5. Maintains recovery audit log</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Production Monitoring System</h2>
<p>Build a comprehensive production monitoring system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ProductionMonitoringSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete production monitoring system.</span>
<span class="sd">    </span>
<span class="sd">    Integrates:</span>
<span class="sd">    - 24/7 scheduling</span>
<span class="sd">    - Multi-channel alerting</span>
<span class="sd">    - Performance tracking</span>
<span class="sd">    - Health monitoring</span>
<span class="sd">    - Failover management</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        
        <span class="c1"># Initialize components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">TradingScheduler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span> <span class="o">=</span> <span class="n">SystemHealthMonitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">performance_tracker</span> <span class="o">=</span> <span class="n">PerformanceTracker</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_balance&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pnl_tracker</span> <span class="o">=</span> <span class="n">RealTimePnLTracker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weekend_handler</span> <span class="o">=</span> <span class="n">WeekendHandler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failover</span> <span class="o">=</span> <span class="n">FailoverManager</span><span class="p">()</span>
        
        <span class="c1"># State</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_alert_handlers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_scheduled_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_health_checks</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_setup_alert_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup notification channels.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">log_handler</span><span class="p">(</span><span class="n">alert</span><span class="p">:</span> <span class="n">Alert</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">alert</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">alert</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_setup_scheduled_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup scheduled monitoring tasks.&quot;&quot;&quot;</span>
        <span class="c1"># Health check every minute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;health_check&#39;</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_health_check</span><span class="p">,</span>
            <span class="n">schedule_type</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span>
            <span class="n">interval_seconds</span><span class="o">=</span><span class="mi">60</span>
        <span class="p">)</span>
        
        <span class="c1"># Daily summary at end of NY session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;daily_summary&#39;</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_daily_summary</span><span class="p">,</span>
            <span class="n">schedule_type</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
            <span class="n">hour</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
            <span class="n">minute</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_setup_health_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register health checks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span>
            <span class="s1">&#39;system_status&#39;</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">HealthCheck</span><span class="p">(</span><span class="s1">&#39;system_status&#39;</span><span class="p">,</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">,</span> <span class="s1">&#39;System operational&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_run_health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute health check cycle.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">run_all_checks</span><span class="p">()</span>
        <span class="n">overall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">get_overall_status</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">overall</span> <span class="o">==</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failover</span><span class="o">.</span><span class="n">trigger_failover</span><span class="p">(</span><span class="s2">&quot;Critical health status&quot;</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_generate_daily_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate and send daily summary.&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">DailySummaryReport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance_tracker</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">create_alert</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">AlertLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="s1">&#39;daily_summary&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Daily Summary Generated&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="n">summary</span><span class="p">}</span>
        <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start the monitoring system.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">create_alert</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">AlertLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="s1">&#39;system&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Production monitoring system started&quot;</span>
        <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the monitoring system.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">create_alert</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="n">AlertLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="s1">&#39;system&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Production monitoring system stopped&quot;</span>
        <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run one monitoring cycle.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Check if weekend</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weekend_handler</span><span class="o">.</span><span class="n">is_weekend</span><span class="p">():</span>
            <span class="k">return</span>
            
        <span class="c1"># Run scheduled tasks</span>
        <span class="n">executed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">run_pending</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">executed</span>
    
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get comprehensive system status.&quot;&quot;&quot;</span>
        <span class="n">uptime</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;running&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">,</span>
            <span class="s1">&#39;uptime_hours&#39;</span><span class="p">:</span> <span class="n">uptime</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">,</span>
            <span class="s1">&#39;health&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">get_overall_status</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;alerts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_manager</span><span class="o">.</span><span class="n">get_summary</span><span class="p">(),</span>
            <span class="s1">&#39;performance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_tracker</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">(),</span>
            <span class="s1">&#39;active_system&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">failover</span><span class="o">.</span><span class="n">get_active_system</span><span class="p">(),</span>
            <span class="s1">&#39;is_weekend&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">weekend_handler</span><span class="o">.</span><span class="n">is_weekend</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate the production monitoring system</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;initial_balance&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="s1">&#39;alert_email&#39;</span><span class="p">:</span> <span class="s1">&#39;trader@example.com&#39;</span>
<span class="p">}</span>

<span class="n">monitoring_system</span> <span class="o">=</span> <span class="n">ProductionMonitoringSystem</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="c1"># Start the system</span>
<span class="n">monitoring_system</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="c1"># Add some sample trades to the tracker</span>
<span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">sample_trades</span><span class="p">:</span>
    <span class="n">monitoring_system</span><span class="o">.</span><span class="n">performance_tracker</span><span class="o">.</span><span class="n">record_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>

<span class="c1"># Run a few cycles</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">monitoring_system</span><span class="o">.</span><span class="n">run_cycle</span><span class="p">()</span>

<span class="c1"># Get status</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">monitoring_system</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">System Status:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>

<span class="c1"># Generate health report</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monitoring_system</span><span class="o">.</span><span class="n">health_monitor</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>24/7 Scheduling</strong>: Forex requires timezone-aware scheduling with session and weekend handling</p>
</li>
<li>
<p><strong>Alerting</strong>: Multi-channel alerts with routing, suppression, and escalation are essential</p>
</li>
<li>
<p><strong>Performance Tracking</strong>: Real-time P&amp;L and comprehensive statistics enable informed decisions</p>
</li>
<li>
<p><strong>Health Monitoring</strong>: Proactive monitoring prevents issues and enables automatic recovery</p>
</li>
<li>
<p><strong>Failover</strong>: Automatic failover between systems ensures continuous operation</p>
</li>
</ol>
<hr />
<p><strong>Next Module</strong>: Module 14 - Trading Psychology &amp; Journaling</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="14"><div class="md-cell module-header"><h1>Module 14: Trading Psychology &amp; Journaling</h1>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Skill Level</strong></td>
<td>Advanced</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Modules 11-13</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:
- Identify and mitigate common trading biases
- Build a comprehensive automated trading journal
- Implement systematic performance review processes
- Create continuous improvement frameworks</p>
<h2>Prerequisites</h2>
<ul>
<li>Completed Part 3 and Modules 12-13</li>
<li>Understanding of trading performance metrics</li>
<li>Familiarity with data analysis and visualization</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 14.1: Trading Psychology</h2>
<p>Understanding and managing psychological biases is crucial for trading success.</p></div>
<div class="md-cell"><h3>Common Trading Biases</h3>
<p><strong>Cognitive Biases:</strong>
- <strong>Confirmation Bias</strong>: Seeking information that confirms existing beliefs
- <strong>Recency Bias</strong>: Overweighting recent events
- <strong>Anchoring</strong>: Fixating on specific price levels
- <strong>Hindsight Bias</strong>: "I knew it all along"</p>
<p><strong>Emotional Biases:</strong>
- <strong>Loss Aversion</strong>: Pain of losses &gt; pleasure of gains (2x typically)
- <strong>Overconfidence</strong>: Overestimating prediction ability
- <strong>FOMO</strong>: Fear of missing out on trades
- <strong>Revenge Trading</strong>: Trading to recover losses</p>
<p><strong>Leverage Psychology:</strong>
- Higher leverage amplifies emotional responses
- Small account moves feel larger
- Can lead to premature exit or excessive risk</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TradingBias</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Common trading biases.&quot;&quot;&quot;</span>
    <span class="n">CONFIRMATION</span> <span class="o">=</span> <span class="s2">&quot;confirmation_bias&quot;</span>
    <span class="n">RECENCY</span> <span class="o">=</span> <span class="s2">&quot;recency_bias&quot;</span>
    <span class="n">ANCHORING</span> <span class="o">=</span> <span class="s2">&quot;anchoring_bias&quot;</span>
    <span class="n">LOSS_AVERSION</span> <span class="o">=</span> <span class="s2">&quot;loss_aversion&quot;</span>
    <span class="n">OVERCONFIDENCE</span> <span class="o">=</span> <span class="s2">&quot;overconfidence&quot;</span>
    <span class="n">FOMO</span> <span class="o">=</span> <span class="s2">&quot;fear_of_missing_out&quot;</span>
    <span class="n">REVENGE_TRADING</span> <span class="o">=</span> <span class="s2">&quot;revenge_trading&quot;</span>
    <span class="n">DISPOSITION_EFFECT</span> <span class="o">=</span> <span class="s2">&quot;disposition_effect&quot;</span>  <span class="c1"># Selling winners too early, holding losers</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BiasIndicator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Indicator for detecting a specific bias.&quot;&quot;&quot;</span>
    <span class="n">bias</span><span class="p">:</span> <span class="n">TradingBias</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">detection_rule</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">mitigation</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">BiasDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect potential trading biases from trade data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_indicators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_indicators</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_setup_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">TradingBias</span><span class="p">,</span> <span class="n">BiasIndicator</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Setup bias detection indicators.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">TradingBias</span><span class="o">.</span><span class="n">LOSS_AVERSION</span><span class="p">:</span> <span class="n">BiasIndicator</span><span class="p">(</span>
                <span class="n">bias</span><span class="o">=</span><span class="n">TradingBias</span><span class="o">.</span><span class="n">LOSS_AVERSION</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Holding losing trades too long while cutting winners short&quot;</span><span class="p">,</span>
                <span class="n">detection_rule</span><span class="o">=</span><span class="s2">&quot;Average losing trade duration &gt; 2x average winning trade duration&quot;</span><span class="p">,</span>
                <span class="n">mitigation</span><span class="o">=</span><span class="s2">&quot;Use strict stop losses; define exit rules before entry&quot;</span>
            <span class="p">),</span>
            <span class="n">TradingBias</span><span class="o">.</span><span class="n">OVERCONFIDENCE</span><span class="p">:</span> <span class="n">BiasIndicator</span><span class="p">(</span>
                <span class="n">bias</span><span class="o">=</span><span class="n">TradingBias</span><span class="o">.</span><span class="n">OVERCONFIDENCE</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Increasing position sizes after winning streak&quot;</span><span class="p">,</span>
                <span class="n">detection_rule</span><span class="o">=</span><span class="s2">&quot;Position size increases &gt;50</span><span class="si">% a</span><span class="s2">fter 3+ consecutive wins&quot;</span><span class="p">,</span>
                <span class="n">mitigation</span><span class="o">=</span><span class="s2">&quot;Use fixed position sizing rules; scale based on account, not recent results&quot;</span>
            <span class="p">),</span>
            <span class="n">TradingBias</span><span class="o">.</span><span class="n">REVENGE_TRADING</span><span class="p">:</span> <span class="n">BiasIndicator</span><span class="p">(</span>
                <span class="n">bias</span><span class="o">=</span><span class="n">TradingBias</span><span class="o">.</span><span class="n">REVENGE_TRADING</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Increased trading frequency after losses&quot;</span><span class="p">,</span>
                <span class="n">detection_rule</span><span class="o">=</span><span class="s2">&quot;Trade count increases &gt;100</span><span class="si">% i</span><span class="s2">n hour following losing trade&quot;</span><span class="p">,</span>
                <span class="n">mitigation</span><span class="o">=</span><span class="s2">&quot;Implement mandatory cooldown periods after losses&quot;</span>
            <span class="p">),</span>
            <span class="n">TradingBias</span><span class="o">.</span><span class="n">DISPOSITION_EFFECT</span><span class="p">:</span> <span class="n">BiasIndicator</span><span class="p">(</span>
                <span class="n">bias</span><span class="o">=</span><span class="n">TradingBias</span><span class="o">.</span><span class="n">DISPOSITION_EFFECT</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Selling winners early, holding losers&quot;</span><span class="p">,</span>
                <span class="n">detection_rule</span><span class="o">=</span><span class="s2">&quot;Average winning trade R:R &lt; 1.0 while holding losers beyond stop&quot;</span><span class="p">,</span>
                <span class="n">mitigation</span><span class="o">=</span><span class="s2">&quot;Let winners run; use trailing stops&quot;</span>
            <span class="p">),</span>
            <span class="n">TradingBias</span><span class="o">.</span><span class="n">FOMO</span><span class="p">:</span> <span class="n">BiasIndicator</span><span class="p">(</span>
                <span class="n">bias</span><span class="o">=</span><span class="n">TradingBias</span><span class="o">.</span><span class="n">FOMO</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Entering trades after missing initial move&quot;</span><span class="p">,</span>
                <span class="n">detection_rule</span><span class="o">=</span><span class="s2">&quot;Entry price &gt;80</span><span class="si">% o</span><span class="s2">f way to resistance/support after move started&quot;</span><span class="p">,</span>
                <span class="n">mitigation</span><span class="o">=</span><span class="s2">&quot;Wait for pullbacks; define entry zones before market opens&quot;</span>
            <span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">analyze_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Analyze trades for potential biases.&quot;&quot;&quot;</span>
        <span class="n">detected_biases</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">detected_biases</span>
            
        <span class="c1"># Check for loss aversion</span>
        <span class="n">winners</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">losers</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">winners</span> <span class="ow">and</span> <span class="n">losers</span><span class="p">:</span>
            <span class="n">avg_win_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duration_hours&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">winners</span><span class="p">])</span>
            <span class="n">avg_loss_duration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duration_hours&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">losers</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">avg_loss_duration</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">avg_win_duration</span><span class="p">:</span>
                <span class="n">detected_biases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="n">TradingBias</span><span class="o">.</span><span class="n">LOSS_AVERSION</span><span class="p">,</span>
                    <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="n">avg_loss_duration</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">avg_win_duration</span> <span class="k">else</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;evidence&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Avg loss duration (</span><span class="si">{</span><span class="n">avg_loss_duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">h) &gt; 2x avg win duration (</span><span class="si">{</span><span class="n">avg_win_duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">h)&quot;</span>
                <span class="p">})</span>
        
        <span class="c1"># Check for revenge trading</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">trades</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">time_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">trades</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;entry_time&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="o">-</span> 
                           <span class="n">trades</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_time&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
                <span class="k">if</span> <span class="n">time_diff</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>  <span class="c1"># Trade within 15 minutes of loss</span>
                    <span class="n">detected_biases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="n">TradingBias</span><span class="o">.</span><span class="n">REVENGE_TRADING</span><span class="p">,</span>
                        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;evidence&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;New trade within </span><span class="si">{</span><span class="n">time_diff</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> minutes of losing trade&quot;</span>
                    <span class="p">})</span>
                    
        <span class="k">return</span> <span class="n">detected_biases</span>
    
    <span class="k">def</span> <span class="nf">get_mitigation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bias</span><span class="p">:</span> <span class="n">TradingBias</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get mitigation strategy for a bias.&quot;&quot;&quot;</span>
        <span class="n">indicator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_indicators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">indicator</span><span class="o">.</span><span class="n">mitigation</span> <span class="k">if</span> <span class="n">indicator</span> <span class="k">else</span> <span class="s2">&quot;No specific mitigation available&quot;</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate bias detection</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">BiasDetector</span><span class="p">()</span>

<span class="c1"># Sample trades with potential biases</span>
<span class="n">sample_trades</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;duration_hours&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;exit_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">0</span><span class="p">)},</span>
    <span class="p">{</span><span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;duration_hours&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;exit_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">0</span><span class="p">)},</span>
    <span class="p">{</span><span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;duration_hours&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="s1">&#39;exit_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">5</span><span class="p">)},</span>  <span class="c1"># Quick trade after loss</span>
    <span class="p">{</span><span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;duration_hours&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;exit_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">0</span><span class="p">)},</span>
<span class="p">]</span>

<span class="n">biases</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">analyze_trades</span><span class="p">(</span><span class="n">sample_trades</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detected Biases:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">biases</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Bias: </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Severity: </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evidence: </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;evidence&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mitigation: </span><span class="si">{</span><span class="n">detector</span><span class="o">.</span><span class="n">get_mitigation</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">EmotionalStateTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track emotional state during trading.&quot;&quot;&quot;</span>
    
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;calm&#39;</span><span class="p">,</span> <span class="s1">&#39;focused&#39;</span><span class="p">,</span> <span class="s1">&#39;anxious&#39;</span><span class="p">,</span> <span class="s1">&#39;frustrated&#39;</span><span class="p">,</span> <span class="s1">&#39;euphoric&#39;</span><span class="p">,</span> <span class="s1">&#39;fearful&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">log_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log current emotional state.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown state. Use one of: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
            <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="n">notes</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">context</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">analyze_state_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze patterns in emotional states.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
            
        <span class="n">state_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="n">state_counts</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;distribution&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">count</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">state_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="s1">&#39;most_common&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">state_counts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">state_counts</span><span class="o">.</span><span class="n">get</span><span class="p">),</span>
            <span class="s1">&#39;total_entries&#39;</span><span class="p">:</span> <span class="n">total</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">correlate_with_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Correlate emotional states with trading performance.&quot;&quot;&quot;</span>
        <span class="c1"># Match trades with nearest emotional state entry</span>
        <span class="n">state_performance</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
            <span class="n">trade_time</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;entry_time&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            
            <span class="c1"># Find nearest emotional state entry</span>
            <span class="n">nearest_state</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">min_diff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">trade_time</span> <span class="o">-</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">min_diff</span><span class="p">:</span>
                    <span class="n">min_diff</span> <span class="o">=</span> <span class="n">diff</span>
                    <span class="n">nearest_state</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span>
                    
            <span class="k">if</span> <span class="n">nearest_state</span> <span class="ow">and</span> <span class="n">min_diff</span> <span class="o">&lt;</span> <span class="mi">3600</span><span class="p">:</span>  <span class="c1"># Within 1 hour</span>
                <span class="n">state_performance</span><span class="p">[</span><span class="n">nearest_state</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                
        <span class="c1"># Calculate average P&amp;L by state</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">state</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;avg_pnl&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pnls</span><span class="p">),</span>
                <span class="s1">&#39;trade_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnls</span><span class="p">),</span>
                <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnls</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">pnls</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">state</span><span class="p">,</span> <span class="n">pnls</span> <span class="ow">in</span> <span class="n">state_performance</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>


<span class="c1"># Example usage</span>
<span class="n">emotional_tracker</span> <span class="o">=</span> <span class="n">EmotionalStateTracker</span><span class="p">()</span>
<span class="n">emotional_tracker</span><span class="o">.</span><span class="n">log_state</span><span class="p">(</span><span class="s1">&#39;calm&#39;</span><span class="p">,</span> <span class="s1">&#39;Morning routine complete, ready to trade&#39;</span><span class="p">)</span>
<span class="n">emotional_tracker</span><span class="o">.</span><span class="n">log_state</span><span class="p">(</span><span class="s1">&#39;focused&#39;</span><span class="p">,</span> <span class="s1">&#39;Good setup developing on EURUSD&#39;</span><span class="p">)</span>
<span class="n">emotional_tracker</span><span class="o">.</span><span class="n">log_state</span><span class="p">(</span><span class="s1">&#39;anxious&#39;</span><span class="p">,</span> <span class="s1">&#39;Large position, uncertain about direction&#39;</span><span class="p">)</span>
<span class="n">emotional_tracker</span><span class="o">.</span><span class="n">log_state</span><span class="p">(</span><span class="s1">&#39;frustrated&#39;</span><span class="p">,</span> <span class="s1">&#39;Stopped out on clear manipulation&#39;</span><span class="p">)</span>

<span class="n">analysis</span> <span class="o">=</span> <span class="n">emotional_tracker</span><span class="o">.</span><span class="n">analyze_state_patterns</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Emotional State Analysis:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Most common state: </span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;most_common&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribution: </span><span class="si">{</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;distribution&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 14.2: Building a Trading Journal</h2>
<p>A comprehensive trading journal is essential for improvement.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">JournalEntry</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete journal entry for a trade.&quot;&quot;&quot;</span>
    <span class="c1"># Trade identification</span>
    <span class="n">trade_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    
    <span class="c1"># Trade details</span>
    <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">position_size</span><span class="p">:</span> <span class="nb">float</span>
    
    <span class="c1"># Risk management</span>
    <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">take_profit</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">risk_reward</span><span class="p">:</span> <span class="nb">float</span>
    
    <span class="c1"># Results</span>
    <span class="n">pnl</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">pnl_pips</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">duration_minutes</span><span class="p">:</span> <span class="nb">int</span>
    
    <span class="c1"># Analysis</span>
    <span class="n">setup_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">market_conditions</span><span class="p">:</span> <span class="nb">str</span>
    
    <span class="c1"># Psychology</span>
    <span class="n">emotional_state</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">confidence_level</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1"># 1-10</span>
    <span class="n">followed_plan</span><span class="p">:</span> <span class="nb">bool</span>
    
    <span class="c1"># Reflection</span>
    <span class="n">entry_reasoning</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">exit_reasoning</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">lessons_learned</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">what_would_do_differently</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    
    <span class="c1"># Tags for filtering</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    
    <span class="c1"># Screenshot paths</span>
    <span class="n">screenshots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;trade_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_id</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
            <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span>
            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;exit_price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_price</span><span class="p">,</span>
            <span class="s1">&#39;position_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_size</span><span class="p">,</span>
            <span class="s1">&#39;stop_loss&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">,</span>
            <span class="s1">&#39;take_profit&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">take_profit</span><span class="p">,</span>
            <span class="s1">&#39;risk_reward&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_reward</span><span class="p">,</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pnl</span><span class="p">,</span>
            <span class="s1">&#39;pnl_pips&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pnl_pips</span><span class="p">,</span>
            <span class="s1">&#39;duration_minutes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration_minutes</span><span class="p">,</span>
            <span class="s1">&#39;setup_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_type</span><span class="p">,</span>
            <span class="s1">&#39;timeframe&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeframe</span><span class="p">,</span>
            <span class="s1">&#39;market_conditions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_conditions</span><span class="p">,</span>
            <span class="s1">&#39;emotional_state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">emotional_state</span><span class="p">,</span>
            <span class="s1">&#39;confidence_level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">confidence_level</span><span class="p">,</span>
            <span class="s1">&#39;followed_plan&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">followed_plan</span><span class="p">,</span>
            <span class="s1">&#39;entry_reasoning&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_reasoning</span><span class="p">,</span>
            <span class="s1">&#39;exit_reasoning&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_reasoning</span><span class="p">,</span>
            <span class="s1">&#39;lessons_learned&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lessons_learned</span><span class="p">,</span>
            <span class="s1">&#39;what_would_do_differently&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">what_would_do_differently</span><span class="p">,</span>
            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
            <span class="s1">&#39;screenshots&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">screenshots</span>
        <span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TradingJournal</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive trading journal system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">journal_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">journal_path</span> <span class="o">=</span> <span class="n">journal_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_count</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">add_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="n">JournalEntry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a new journal entry.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
    <span class="k">def</span> <span class="nf">create_entry_from_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> 
                                 <span class="n">psychological_data</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">analysis_data</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JournalEntry</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a journal entry from trade data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">psych</span> <span class="o">=</span> <span class="n">psychological_data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="n">analysis_data</span> <span class="ow">or</span> <span class="p">{}</span>
        
        <span class="c1"># Calculate risk/reward</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;entry_price&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;take_profit&#39;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">entry</span> <span class="o">-</span> <span class="n">sl</span><span class="p">)</span> <span class="k">if</span> <span class="n">sl</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">reward</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tp</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="k">if</span> <span class="n">tp</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">reward</span> <span class="o">/</span> <span class="n">risk</span> <span class="k">if</span> <span class="n">risk</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="n">JournalEntry</span><span class="p">(</span>
            <span class="n">trade_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;J</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">entry_count</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;entry_time&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span>
            <span class="n">instrument</span><span class="o">=</span><span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instrument&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
            <span class="n">entry_price</span><span class="o">=</span><span class="n">entry</span><span class="p">,</span>
            <span class="n">exit_price</span><span class="o">=</span><span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_price&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">position_size</span><span class="o">=</span><span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">stop_loss</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span>
            <span class="n">take_profit</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span>
            <span class="n">risk_reward</span><span class="o">=</span><span class="n">rr</span><span class="p">,</span>
            <span class="n">pnl</span><span class="o">=</span><span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">pnl_pips</span><span class="o">=</span><span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl_pips&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">duration_minutes</span><span class="o">=</span><span class="n">trade</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;duration_minutes&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">setup_type</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;setup_type&#39;</span><span class="p">,</span> <span class="s1">&#39;Unclassified&#39;</span><span class="p">),</span>
            <span class="n">timeframe</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeframe&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
            <span class="n">market_conditions</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;market_conditions&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
            <span class="n">emotional_state</span><span class="o">=</span><span class="n">psych</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;emotional_state&#39;</span><span class="p">,</span> <span class="s1">&#39;Not recorded&#39;</span><span class="p">),</span>
            <span class="n">confidence_level</span><span class="o">=</span><span class="n">psych</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="n">followed_plan</span><span class="o">=</span><span class="n">psych</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;followed_plan&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">entry_reasoning</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;entry_reasoning&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="n">exit_reasoning</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exit_reasoning&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">filters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Search journal entries with filters.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span>
        
        <span class="k">if</span> <span class="s1">&#39;instrument&#39;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">instrument</span> <span class="o">==</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="s1">&#39;direction&#39;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="s1">&#39;setup_type&#39;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">setup_type</span> <span class="o">==</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;setup_type&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="s1">&#39;profitable&#39;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;profitable&#39;</span><span class="p">]:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;tag&#39;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">tags</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;date_from&#39;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;=</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;date_from&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="s1">&#39;date_to&#39;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&lt;=</span> <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;date_to&#39;</span><span class="p">]]</span>
            
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate statistics for journal entries.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">entries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
            
        <span class="n">winners</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">losers</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">),</span>
            <span class="s1">&#39;avg_win&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">winners</span><span class="p">])</span> <span class="k">if</span> <span class="n">winners</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;avg_loss&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">losers</span><span class="p">])</span> <span class="k">if</span> <span class="n">losers</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;avg_rr_planned&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">risk_reward</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]),</span>
            <span class="s1">&#39;plan_adherence&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">followed_plan</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;avg_confidence&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">confidence_level</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]),</span>
            <span class="s1">&#39;top_setup&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_top_setup</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="s1">&#39;worst_setup&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_worst_setup</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_get_top_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find best performing setup type.&quot;&quot;&quot;</span>
        <span class="n">setup_pnl</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">setup_pnl</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">setup_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">pnl</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">setup_pnl</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span>
            
        <span class="n">avg_by_setup</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">pnls</span> <span class="ow">in</span> <span class="n">setup_pnl</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">avg_by_setup</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">avg_by_setup</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_worst_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find worst performing setup type.&quot;&quot;&quot;</span>
        <span class="n">setup_pnl</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">setup_pnl</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">setup_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">pnl</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">setup_pnl</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span>
            
        <span class="n">avg_by_setup</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">pnls</span> <span class="ow">in</span> <span class="n">setup_pnl</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">avg_by_setup</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">avg_by_setup</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save journal to file.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No path specified&quot;</span><span class="p">)</span>
            
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load journal from file.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No path specified&quot;</span><span class="p">)</span>
            
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
        <span class="c1"># Convert back to JournalEntry objects</span>
        <span class="c1"># (simplified - would need proper datetime parsing)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate trading journal</span>
<span class="n">journal</span> <span class="o">=</span> <span class="n">TradingJournal</span><span class="p">()</span>

<span class="c1"># Add sample entries</span>
<span class="n">sample_trades_for_journal</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span>
        <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span>
        <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="mf">1.0850</span><span class="p">,</span>
        <span class="s1">&#39;exit_price&#39;</span><span class="p">:</span> <span class="mf">1.0920</span><span class="p">,</span>
        <span class="s1">&#39;stop_loss&#39;</span><span class="p">:</span> <span class="mf">1.0800</span><span class="p">,</span>
        <span class="s1">&#39;take_profit&#39;</span><span class="p">:</span> <span class="mf">1.0950</span><span class="p">,</span>
        <span class="s1">&#39;position_size&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s1">&#39;pnl_pips&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s1">&#39;duration_minutes&#39;</span><span class="p">:</span> <span class="mi">180</span><span class="p">,</span>
        <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span>
        <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span>
        <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="mf">1.2700</span><span class="p">,</span>
        <span class="s1">&#39;exit_price&#39;</span><span class="p">:</span> <span class="mf">1.2650</span><span class="p">,</span>
        <span class="s1">&#39;stop_loss&#39;</span><span class="p">:</span> <span class="mf">1.2750</span><span class="p">,</span>
        <span class="s1">&#39;take_profit&#39;</span><span class="p">:</span> <span class="mf">1.2600</span><span class="p">,</span>
        <span class="s1">&#39;position_size&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="s1">&#39;pnl_pips&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="s1">&#39;duration_minutes&#39;</span><span class="p">:</span> <span class="mi">240</span><span class="p">,</span>
        <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span>
        <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span>
        <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="mf">1.0880</span><span class="p">,</span>
        <span class="s1">&#39;exit_price&#39;</span><span class="p">:</span> <span class="mf">1.0850</span><span class="p">,</span>
        <span class="s1">&#39;stop_loss&#39;</span><span class="p">:</span> <span class="mf">1.0850</span><span class="p">,</span>
        <span class="s1">&#39;take_profit&#39;</span><span class="p">:</span> <span class="mf">1.0950</span><span class="p">,</span>
        <span class="s1">&#39;position_size&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span>
        <span class="s1">&#39;pnl_pips&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span>
        <span class="s1">&#39;duration_minutes&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">sample_trades_for_journal</span><span class="p">:</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="n">journal</span><span class="o">.</span><span class="n">create_entry_from_trade</span><span class="p">(</span>
        <span class="n">trade</span><span class="p">,</span>
        <span class="n">psychological_data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;emotional_state&#39;</span><span class="p">:</span> <span class="s1">&#39;focused&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;followed_plan&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="n">analysis_data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;setup_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Trend Continuation&#39;</span><span class="p">,</span> <span class="s1">&#39;timeframe&#39;</span><span class="p">:</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span> 
                      <span class="s1">&#39;market_conditions&#39;</span><span class="p">:</span> <span class="s1">&#39;Trending&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">]}</span>
    <span class="p">)</span>
    <span class="n">journal</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

<span class="c1"># Get statistics</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">journal</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Journal Statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 14.3: Performance Review</h2>
<p>Systematic review processes for continuous improvement.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">WeeklyReview</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate weekly performance review.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">journal</span><span class="p">:</span> <span class="n">TradingJournal</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">journal</span> <span class="o">=</span> <span class="n">journal</span>
        
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">week_start</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">week_end</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate weekly review report.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">week_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">week_end</span> <span class="o">=</span> <span class="n">week_start</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
            
        <span class="c1"># Get trades for the week</span>
        <span class="n">week_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">date_from</span><span class="o">=</span><span class="n">week_start</span><span class="p">,</span> <span class="n">date_to</span><span class="o">=</span><span class="n">week_end</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">week_entries</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="n">week_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="s1">&#39;trades&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">(</span><span class="n">week_entries</span><span class="p">)</span>
        
        <span class="c1"># Analyze by day</span>
        <span class="n">daily_pnl</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">week_entries</span><span class="p">:</span>
            <span class="n">day</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%A&#39;</span><span class="p">)</span>
            <span class="n">daily_pnl</span><span class="p">[</span><span class="n">day</span><span class="p">]</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">.</span><span class="n">pnl</span>
            
        <span class="c1"># Analyze by session</span>
        <span class="n">session_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_by_session</span><span class="p">(</span><span class="n">week_entries</span><span class="p">)</span>
        
        <span class="c1"># Find patterns</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identify_patterns</span><span class="p">(</span><span class="n">week_entries</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="n">week_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
            <span class="s1">&#39;statistics&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span>
            <span class="s1">&#39;daily_pnl&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">daily_pnl</span><span class="p">),</span>
            <span class="s1">&#39;session_performance&#39;</span><span class="p">:</span> <span class="n">session_performance</span><span class="p">,</span>
            <span class="s1">&#39;patterns&#39;</span><span class="p">:</span> <span class="n">patterns</span><span class="p">,</span>
            <span class="s1">&#39;improvement_areas&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identify_improvements</span><span class="p">(</span><span class="n">week_entries</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_analyze_by_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze performance by trading session.&quot;&quot;&quot;</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Asian&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;London&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;New York&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">hour</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">hour</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;Asian&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">pnl</span><span class="p">)</span>
            <span class="k">elif</span> <span class="mi">8</span> <span class="o">&lt;=</span> <span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">:</span>
                <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;London&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">pnl</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;New York&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">pnl</span><span class="p">)</span>
                
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">session</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnls</span><span class="p">),</span>
                <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pnls</span><span class="p">),</span>
                <span class="s1">&#39;avg_pnl&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pnls</span><span class="p">)</span> <span class="k">if</span> <span class="n">pnls</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">session</span><span class="p">,</span> <span class="n">pnls</span> <span class="ow">in</span> <span class="n">sessions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_identify_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Identify trading patterns.&quot;&quot;&quot;</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check win streaks</span>
        <span class="n">max_streak</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_streak</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">current_streak</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">max_streak</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_streak</span><span class="p">,</span> <span class="n">current_streak</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_streak</span> <span class="o">=</span> <span class="mi">0</span>
                
        <span class="k">if</span> <span class="n">max_streak</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Winning streak of </span><span class="si">{</span><span class="n">max_streak</span><span class="si">}</span><span class="s2"> trades&quot;</span><span class="p">)</span>
            
        <span class="c1"># Check for overtrading</span>
        <span class="n">trades_per_day</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>  <span class="c1"># Assuming 5 trading days</span>
        <span class="k">if</span> <span class="n">trades_per_day</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High trading frequency: </span><span class="si">{</span><span class="n">trades_per_day</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> trades/day&quot;</span><span class="p">)</span>
            
        <span class="c1"># Check plan adherence</span>
        <span class="n">adherence</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">followed_plan</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">adherence</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Low plan adherence: </span><span class="si">{</span><span class="n">adherence</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">patterns</span>
    
    <span class="k">def</span> <span class="nf">_identify_improvements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Identify areas for improvement.&quot;&quot;&quot;</span>
        <span class="n">improvements</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check if losing trades are too large</span>
        <span class="n">losers</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">winners</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">losers</span> <span class="ow">and</span> <span class="n">winners</span><span class="p">:</span>
            <span class="n">avg_loss</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">losers</span><span class="p">]))</span>
            <span class="n">avg_win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">winners</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">avg_loss</span> <span class="o">&gt;</span> <span class="n">avg_win</span><span class="p">:</span>
                <span class="n">improvements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Cut losers faster - avg loss &gt; avg win&quot;</span><span class="p">)</span>
                
        <span class="c1"># Check emotional trading</span>
        <span class="n">emotional_losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">emotional_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;anxious&#39;</span><span class="p">,</span> <span class="s1">&#39;frustrated&#39;</span><span class="p">,</span> <span class="s1">&#39;euphoric&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">emotional_losses</span><span class="p">:</span>
            <span class="n">improvements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">emotional_losses</span><span class="p">)</span><span class="si">}</span><span class="s2"> losing trades during emotional states&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">improvements</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MonthlyAnalysis</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive monthly performance analysis.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">journal</span><span class="p">:</span> <span class="n">TradingJournal</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">journal</span> <span class="o">=</span> <span class="n">journal</span>
        
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate monthly analysis report.&quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
        <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">date_from</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">date_to</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;trades&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="s1">&#39;by_instrument&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_by_instrument</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="s1">&#39;by_setup&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_by_setup</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="s1">&#39;equity_curve&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_equity_curve</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="s1">&#39;best_trade&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_best_trade</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="s1">&#39;worst_trade&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_worst_trade</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span>
            <span class="s1">&#39;key_insights&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_insights</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get summary statistics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_analyze_by_instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze performance by instrument.&quot;&quot;&quot;</span>
        <span class="n">by_instrument</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">by_instrument</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">instrument</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">inst</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">),</span>
                <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">),</span>
                <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">inst</span><span class="p">,</span> <span class="n">trades</span> <span class="ow">in</span> <span class="n">by_instrument</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_analyze_by_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze performance by setup type.&quot;&quot;&quot;</span>
        <span class="n">by_setup</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">by_setup</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">setup_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">setup</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">),</span>
                <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">),</span>
                <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s1">&#39;avg_rr&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">risk_reward</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">])</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">setup</span><span class="p">,</span> <span class="n">trades</span> <span class="ow">in</span> <span class="n">by_setup</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_build_equity_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Build equity curve data.&quot;&quot;&quot;</span>
        <span class="n">sorted_entries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">curve</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">sorted_entries</span><span class="p">:</span>
            <span class="n">equity</span> <span class="o">+=</span> <span class="n">e</span><span class="o">.</span><span class="n">pnl</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="n">equity</span>
            <span class="p">})</span>
            
        <span class="k">return</span> <span class="n">curve</span>
    
    <span class="k">def</span> <span class="nf">_get_best_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get best trade of the month.&quot;&quot;&quot;</span>
        <span class="n">best</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pnl</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="n">best</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">best</span><span class="o">.</span><span class="n">pnl</span><span class="p">,</span>
            <span class="s1">&#39;setup&#39;</span><span class="p">:</span> <span class="n">best</span><span class="o">.</span><span class="n">setup_type</span><span class="p">,</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">best</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_get_worst_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get worst trade of the month.&quot;&quot;&quot;</span>
        <span class="n">worst</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pnl</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="n">worst</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">worst</span><span class="o">.</span><span class="n">pnl</span><span class="p">,</span>
            <span class="s1">&#39;setup&#39;</span><span class="p">:</span> <span class="n">worst</span><span class="o">.</span><span class="n">setup_type</span><span class="p">,</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">worst</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_generate_insights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JournalEntry</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate actionable insights.&quot;&quot;&quot;</span>
        <span class="n">insights</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Find best setup</span>
        <span class="n">by_setup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_by_setup</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">by_setup</span><span class="p">:</span>
            <span class="n">best_setup</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">by_setup</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;total_pnl&#39;</span><span class="p">])</span>
            <span class="n">insights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best performing setup: </span><span class="si">{</span><span class="n">best_setup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> ($</span><span class="si">{</span><span class="n">best_setup</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;total_pnl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            
        <span class="c1"># Check confidence correlation</span>
        <span class="n">high_conf</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">confidence_level</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">low_conf</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">confidence_level</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">high_conf</span> <span class="ow">and</span> <span class="n">low_conf</span><span class="p">:</span>
            <span class="n">high_conf_wr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">high_conf</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">high_conf</span><span class="p">)</span>
            <span class="n">low_conf_wr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">low_conf</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">low_conf</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">high_conf_wr</span> <span class="o">&gt;</span> <span class="n">low_conf_wr</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">insights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High confidence trades outperform (</span><span class="si">{</span><span class="n">high_conf_wr</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% vs </span><span class="si">{</span><span class="n">low_conf_wr</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% win rate)&quot;</span><span class="p">)</span>
                
        <span class="k">return</span> <span class="n">insights</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Generate weekly review</span>
<span class="n">weekly_review</span> <span class="o">=</span> <span class="n">WeeklyReview</span><span class="p">(</span><span class="n">journal</span><span class="p">)</span>
<span class="n">review</span> <span class="o">=</span> <span class="n">weekly_review</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Weekly Review:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Week of: </span><span class="si">{</span><span class="n">review</span><span class="p">[</span><span class="s1">&#39;week&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Statistics:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">review</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;statistics&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Patterns: </span><span class="si">{</span><span class="n">review</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;patterns&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Improvements: </span><span class="si">{</span><span class="n">review</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;improvement_areas&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 14.4: Continuous Improvement</h2>
<p>Systematic frameworks for ongoing trading improvement.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ImprovementGoal</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A specific improvement goal.&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">target_value</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">current_value</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">deadline</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">progress_notes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">progress_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate progress towards goal.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_value</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_achieved</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_value</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_value</span>


<span class="k">class</span> <span class="nc">ImprovementTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track and manage improvement goals.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ImprovementGoal</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_count</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">add_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                 <span class="n">target_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">deadline</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
                 <span class="n">current_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a new improvement goal.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">goal_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;GOAL-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">goal_count</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">goals</span><span class="p">[</span><span class="n">goal_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImprovementGoal</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">goal_id</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
            <span class="n">target_value</span><span class="o">=</span><span class="n">target_value</span><span class="p">,</span>
            <span class="n">current_value</span><span class="o">=</span><span class="n">current_value</span><span class="p">,</span>
            <span class="n">deadline</span><span class="o">=</span><span class="n">deadline</span><span class="p">,</span>
            <span class="n">actions</span><span class="o">=</span><span class="n">actions</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">goal_id</span>
    
    <span class="k">def</span> <span class="nf">update_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">note</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update progress on a goal.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">goal_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">goals</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="n">goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goals</span><span class="p">[</span><span class="n">goal_id</span><span class="p">]</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">progress_notes</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">new_value</span><span class="p">,</span>
            <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="n">note</span>
        <span class="p">})</span>
        
    <span class="k">def</span> <span class="nf">get_active_goals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ImprovementGoal</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get goals that are not yet achieved.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">goals</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_achieved</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_status_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate status report for all goals.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s2">&quot;IMPROVEMENT GOALS STATUS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">goal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">goals</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ACHIEVED&quot;</span> <span class="k">if</span> <span class="n">goal</span><span class="o">.</span><span class="n">is_achieved</span> <span class="k">else</span> <span class="s2">&quot;IN PROGRESS&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Metric: </span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Progress: </span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">current_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">target_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">progress_pct</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Deadline: </span><span class="si">{</span><span class="n">goal</span><span class="o">.</span><span class="n">deadline</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">ABTestFramework</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A/B testing framework for trading strategies.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_count</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">def</span> <span class="nf">create_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">variant_a</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">variant_b</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a new A/B test.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">test_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;TEST-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">test_count</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">test_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;variant_a&#39;</span><span class="p">:</span> <span class="n">variant_a</span><span class="p">,</span>
            <span class="s1">&#39;variant_b&#39;</span><span class="p">:</span> <span class="n">variant_b</span><span class="p">,</span>
            <span class="s1">&#39;sample_size&#39;</span><span class="p">:</span> <span class="n">sample_size</span><span class="p">,</span>
            <span class="s1">&#39;results_a&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;results_b&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span>
            <span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">test_id</span>
    
    <span class="k">def</span> <span class="nf">record_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pnl</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record a result for a test variant.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">test_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">test_id</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="n">test</span><span class="p">[</span><span class="s1">&#39;results_a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pnl</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test</span><span class="p">[</span><span class="s1">&#39;results_b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pnl</span><span class="p">)</span>
            
        <span class="c1"># Check if test is complete</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;results_a&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]</span> <span class="ow">and</span> 
            <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;results_b&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;sample_size&#39;</span><span class="p">]):</span>
            <span class="n">test</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span>
            
    <span class="k">def</span> <span class="nf">analyze_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze test results.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">test_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
            
        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">test_id</span><span class="p">]</span>
        <span class="n">results_a</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;results_a&#39;</span><span class="p">]</span>
        <span class="n">results_b</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;results_b&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results_a</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">results_b</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;insufficient_data&#39;</span><span class="p">}</span>
            
        <span class="c1"># Calculate statistics</span>
        <span class="n">mean_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results_a</span><span class="p">)</span>
        <span class="n">mean_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results_b</span><span class="p">)</span>
        
        <span class="c1"># Simple t-test</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
        <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">results_a</span><span class="p">,</span> <span class="n">results_b</span><span class="p">)</span>
        
        <span class="n">winner</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span> <span class="k">if</span> <span class="n">mean_a</span> <span class="o">&gt;</span> <span class="n">mean_b</span> <span class="k">else</span> <span class="s1">&#39;B&#39;</span>
        <span class="n">significant</span> <span class="o">=</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;test_name&#39;</span><span class="p">:</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="s1">&#39;variant_a&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;variant_a&#39;</span><span class="p">],</span>
                <span class="s1">&#39;samples&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_a</span><span class="p">),</span>
                <span class="s1">&#39;mean_pnl&#39;</span><span class="p">:</span> <span class="n">mean_a</span><span class="p">,</span>
                <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results_a</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_a</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="p">},</span>
            <span class="s1">&#39;variant_b&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;variant_b&#39;</span><span class="p">],</span>
                <span class="s1">&#39;samples&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_b</span><span class="p">),</span>
                <span class="s1">&#39;mean_pnl&#39;</span><span class="p">:</span> <span class="n">mean_b</span><span class="p">,</span>
                <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results_b</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_b</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="p">},</span>
            <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s1">&#39;statistically_significant&#39;</span><span class="p">:</span> <span class="n">significant</span><span class="p">,</span>
            <span class="s1">&#39;recommended&#39;</span><span class="p">:</span> <span class="n">winner</span> <span class="k">if</span> <span class="n">significant</span> <span class="k">else</span> <span class="s1">&#39;No clear winner&#39;</span>
        <span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate improvement tracking</span>
<span class="n">improvement_tracker</span> <span class="o">=</span> <span class="n">ImprovementTracker</span><span class="p">()</span>

<span class="c1"># Add improvement goals</span>
<span class="n">improvement_tracker</span><span class="o">.</span><span class="n">add_goal</span><span class="p">(</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Improve win rate&quot;</span><span class="p">,</span>
    <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;win_rate_pct&quot;</span><span class="p">,</span>
    <span class="n">target_value</span><span class="o">=</span><span class="mi">55</span><span class="p">,</span>
    <span class="n">current_value</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span>
    <span class="n">deadline</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Only take A+ setups&quot;</span><span class="p">,</span> <span class="s2">&quot;Wait for confirmation&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">improvement_tracker</span><span class="o">.</span><span class="n">add_goal</span><span class="p">(</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Reduce average loss size&quot;</span><span class="p">,</span>
    <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;avg_loss_usd&quot;</span><span class="p">,</span>
    <span class="n">target_value</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">current_value</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>
    <span class="n">deadline</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Use tighter stops&quot;</span><span class="p">,</span> <span class="s2">&quot;Cut losers faster&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">improvement_tracker</span><span class="o">.</span><span class="n">add_goal</span><span class="p">(</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Increase plan adherence&quot;</span><span class="p">,</span>
    <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;plan_adherence_pct&quot;</span><span class="p">,</span>
    <span class="n">target_value</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="n">current_value</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span>
    <span class="n">deadline</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
    <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Pre-define entries/exits&quot;</span><span class="p">,</span> <span class="s2">&quot;Use checklist&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">improvement_tracker</span><span class="o">.</span><span class="n">get_status_report</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate A/B testing</span>
<span class="n">ab_framework</span> <span class="o">=</span> <span class="n">ABTestFramework</span><span class="p">()</span>

<span class="c1"># Create a test</span>
<span class="n">test_id</span> <span class="o">=</span> <span class="n">ab_framework</span><span class="o">.</span><span class="n">create_test</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Stop Loss Placement&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Testing ATR-based stops vs fixed pip stops&quot;</span><span class="p">,</span>
    <span class="n">variant_a</span><span class="o">=</span><span class="s2">&quot;ATR-based stop (2x ATR)&quot;</span><span class="p">,</span>
    <span class="n">variant_b</span><span class="o">=</span><span class="s2">&quot;Fixed 30 pip stop&quot;</span><span class="p">,</span>
    <span class="n">sample_size</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>

<span class="c1"># Simulate results</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Variant A results (ATR-based)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">pnl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>  <span class="c1"># Slightly positive expectancy</span>
    <span class="n">ab_framework</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">test_id</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">pnl</span><span class="p">)</span>

<span class="c1"># Variant B results (Fixed stop)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">pnl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>  <span class="c1"># Lower expectancy</span>
    <span class="n">ab_framework</span><span class="o">.</span><span class="n">record_result</span><span class="p">(</span><span class="n">test_id</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">pnl</span><span class="p">)</span>

<span class="c1"># Analyze</span>
<span class="n">analysis</span> <span class="o">=</span> <span class="n">ab_framework</span><span class="o">.</span><span class="n">analyze_test</span><span class="p">(</span><span class="n">test_id</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A/B Test Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;test_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Variant A (</span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;variant_a&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Samples: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;variant_a&#39;</span><span class="p">][</span><span class="s1">&#39;samples&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean P&amp;L: $</span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;variant_a&#39;</span><span class="p">][</span><span class="s1">&#39;mean_pnl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Win Rate: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;variant_a&#39;</span><span class="p">][</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Variant B (</span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;variant_b&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Samples: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;variant_b&#39;</span><span class="p">][</span><span class="s1">&#39;samples&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean P&amp;L: $</span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;variant_b&#39;</span><span class="p">][</span><span class="s1">&#39;mean_pnl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Win Rate: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;variant_b&#39;</span><span class="p">][</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">P-value: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Statistically Significant: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;statistically_significant&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recommendation: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;recommended&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Exercises</h2></div>
<div class="md-cell"><h3>Exercise 1: Bias Detection Enhancement (Guided)</h3>
<p>Enhance the bias detector with additional detection rules.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">EnhancedBiasDetector</span><span class="p">(</span><span class="n">BiasDetector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enhanced bias detection with more rules.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">detect_overtrading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Detect overtrading patterns.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="c1"># Group trades by date</span>
        <span class="n">trades_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;entry_time&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="n">trades_by_date</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            
        <span class="c1"># Find days with excessive trading</span>
        <span class="n">overtrading_days</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">trades_by_date</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">______</span><span class="p">]</span>  <span class="c1"># Check threshold</span>
        
        <span class="k">if</span> <span class="n">overtrading_days</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="s1">&#39;overtrading&#39;</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overtrading_days</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                <span class="s1">&#39;evidence&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">overtrading_days</span><span class="p">)</span><span class="si">}</span><span class="s2"> days with &gt;</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> trades&quot;</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">detect_anchoring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Detect anchoring to specific price levels.&quot;&quot;&quot;</span>
        <span class="c1"># Check if many stops/targets are at round numbers</span>
        <span class="n">round_number_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stop_loss&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;take_profit&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sl</span><span class="p">,</span> <span class="n">tp</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># Check if price is a round number (ends in 00)</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">round_number_count</span> <span class="o">+=</span> <span class="n">______</span>  <span class="c1"># Increment count</span>
                        
        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">round_number_count</span> <span class="o">/</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;bias&#39;</span><span class="p">:</span> <span class="n">TradingBias</span><span class="o">.</span><span class="n">ANCHORING</span><span class="p">,</span>
                <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span>
                <span class="s1">&#39;evidence&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">round_number_count</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% of stops/targets at round numbers&quot;</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">analyze_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run all bias detection methods.&quot;&quot;&quot;</span>
        <span class="n">biases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_trades</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
        
        <span class="n">overtrading</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_overtrading</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overtrading</span><span class="p">:</span>
            <span class="n">biases</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">overtrading</span><span class="p">)</span>  <span class="c1"># Add to list</span>
            
        <span class="n">anchoring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_anchoring</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">anchoring</span><span class="p">:</span>
            <span class="n">biases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anchoring</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">biases</span>


<span class="c1"># Test enhanced detector</span>
<span class="n">enhanced_detector</span> <span class="o">=</span> <span class="n">EnhancedBiasDetector</span><span class="p">()</span>
<span class="n">biases</span> <span class="o">=</span> <span class="n">enhanced_detector</span><span class="o">.</span><span class="n">analyze_all</span><span class="p">(</span><span class="n">sample_trades</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">biases</span><span class="p">)</span><span class="si">}</span><span class="s2"> potential biases&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 2: Journal Entry Template (Guided)</h3>
<p>Create a journal entry template generator.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">JournalTemplateGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate journal entry templates.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;entry_reasoning&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;What setup triggered this trade?&quot;</span><span class="p">,</span>
                <span class="s2">&quot;What was the market structure?&quot;</span><span class="p">,</span>
                <span class="s2">&quot;What was your edge in this trade?&quot;</span>
            <span class="p">],</span>
            <span class="s1">&#39;exit_reasoning&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;Why did you exit at this point?&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Was this a planned or discretionary exit?&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Did price action confirm your exit?&quot;</span>
            <span class="p">],</span>
            <span class="s1">&#39;lessons&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;What would you do differently?&quot;</span><span class="p">,</span>
                <span class="s2">&quot;What did this trade teach you?&quot;</span><span class="p">,</span>
                <span class="s2">&quot;How can you improve similar setups?&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_pre_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate pre-trade checklist.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s2">&quot;PRE-TRADE CHECKLIST&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Instrument: </span><span class="si">{</span><span class="n">trade_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instrument&#39;</span><span class="p">,</span> <span class="s1">&#39;_________&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Direction: </span><span class="si">{</span><span class="n">trade_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="s1">&#39;_________&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SETUP CONFIRMATION:&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[ ] Is this my A+ setup?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[ ] Is the trend aligned with my direction?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[ ] Is there clear support/resistance?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RISK CHECK:&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[ ] Position size within risk limits?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[ ] Stop loss clearly defined?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[ ] Risk:Reward &gt;= 1:2?&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;EMOTIONAL CHECK:&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Current emotional state: __________&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Confidence (1-10): __________&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[ ] Not revenge trading&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[ ] Not FOMO&quot;</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># Join lines with newline</span>
    
    <span class="k">def</span> <span class="nf">generate_post_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate post-trade review template.&quot;&quot;&quot;</span>
        <span class="n">outcome</span> <span class="o">=</span> <span class="s2">&quot;WIN&quot;</span> <span class="k">if</span> <span class="n">trade_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;______&quot;</span>  <span class="c1"># Set outcome</span>
        
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;POST-TRADE REVIEW - </span><span class="si">{</span><span class="n">outcome</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;P&amp;L: $</span><span class="si">{</span><span class="n">trade_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Pips: </span><span class="si">{</span><span class="n">trade_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pnl_pips&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;EXECUTION REVIEW:&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompts</span><span class="p">[</span><span class="s1">&#39;entry_reasoning&#39;</span><span class="p">]:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Q: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;A: _________________________________&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">LESSONS LEARNED:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompts</span><span class="p">[</span><span class="s1">&#39;lessons&#39;</span><span class="p">]:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Q: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;A: _________________________________&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">______</span><span class="p">)</span>


<span class="c1"># Test template generator</span>
<span class="n">template_gen</span> <span class="o">=</span> <span class="n">JournalTemplateGenerator</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">template_gen</span><span class="o">.</span><span class="n">generate_pre_trade</span><span class="p">({</span><span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span><span class="p">}))</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 3: Performance Heatmap (Guided)</h3>
<p>Create a performance heatmap generator.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">PerformanceHeatmap</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate performance heatmaps.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">journal</span><span class="p">:</span> <span class="n">TradingJournal</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">journal</span> <span class="o">=</span> <span class="n">journal</span>
        
    <span class="k">def</span> <span class="nf">by_day_hour</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create heatmap data by day of week and hour.&quot;&quot;&quot;</span>
        <span class="c1"># Initialize matrix</span>
        <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mon&#39;</span><span class="p">,</span> <span class="s1">&#39;Tue&#39;</span><span class="p">,</span> <span class="s1">&#39;Wed&#39;</span><span class="p">,</span> <span class="s1">&#39;Thu&#39;</span><span class="p">,</span> <span class="s1">&#39;Fri&#39;</span><span class="p">]</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">days</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">days</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="n">day</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%a</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">hour</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">______</span>  <span class="c1"># Get hour from timestamp</span>
            
            <span class="k">if</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">days</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">]</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">.</span><span class="n">pnl</span>
                <span class="n">counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                
        <span class="c1"># Calculate average (avoid division by zero)</span>
        <span class="n">avg_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">avg_data</span>
    
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot heatmap.&quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Avg P&amp;L&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)),</span> <span class="n">data</span><span class="o">.</span><span class="n">______</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Hour (UTC)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Day of Week&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Create heatmap</span>
<span class="n">heatmap</span> <span class="o">=</span> <span class="n">PerformanceHeatmap</span><span class="p">(</span><span class="n">journal</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">heatmap</span><span class="o">.</span><span class="n">by_day_hour</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performance by Day/Hour:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 4: Emotional Journal Integration</h3>
<p>Build a system that integrates emotional tracking with trade journaling.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 4: Build an EmotionalJournalIntegration class that:</span>
<span class="c1"># 1. Links emotional state entries to specific trades</span>
<span class="c1"># 2. Calculates performance by emotional state</span>
<span class="c1"># 3. Identifies emotional patterns that lead to losses</span>
<span class="c1"># 4. Generates recommendations based on emotional patterns</span>
<span class="c1"># 5. Creates a report showing emotional impact on trading</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 5: Strategy Evolution Tracker</h3>
<p>Track how your trading strategy evolves over time.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 5: Build a StrategyEvolutionTracker class that:</span>
<span class="c1"># 1. Records strategy changes with timestamps and reasons</span>
<span class="c1"># 2. Compares performance before/after changes</span>
<span class="c1"># 3. Identifies which changes improved performance</span>
<span class="c1"># 4. Tracks rule additions/modifications/removals</span>
<span class="c1"># 5. Generates an evolution timeline</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell"><h3>Exercise 6: Automated Review Generator</h3>
<p>Build a system that automatically generates comprehensive reviews.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Exercise 6: Build an AutomatedReviewGenerator class that:</span>
<span class="c1"># 1. Generates daily, weekly, and monthly reviews automatically</span>
<span class="c1"># 2. Compares current period to historical averages</span>
<span class="c1"># 3. Highlights anomalies and unusual patterns</span>
<span class="c1"># 4. Creates actionable recommendations</span>
<span class="c1"># 5. Exports reviews to multiple formats (text, HTML, PDF)</span>

<span class="c1"># Your code here</span>
</code></pre></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Automated Trading Journal</h2>
<p>Build a complete automated trading journal system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">AutomatedTradingJournal</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete automated trading journal system.</span>
<span class="sd">    </span>
<span class="sd">    Integrates:</span>
<span class="sd">    - Trade logging</span>
<span class="sd">    - Psychological tracking</span>
<span class="sd">    - Bias detection</span>
<span class="sd">    - Performance analysis</span>
<span class="sd">    - Improvement tracking</span>
<span class="sd">    - Automated reviews</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">journal</span> <span class="o">=</span> <span class="n">TradingJournal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emotional_tracker</span> <span class="o">=</span> <span class="n">EmotionalStateTracker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_detector</span> <span class="o">=</span> <span class="n">BiasDetector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improvement_tracker</span> <span class="o">=</span> <span class="n">ImprovementTracker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ab_framework</span> <span class="o">=</span> <span class="n">ABTestFramework</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">log_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">emotional_state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">analysis</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log a trade with full context.&quot;&quot;&quot;</span>
        <span class="c1"># Log emotional state if provided</span>
        <span class="k">if</span> <span class="n">emotional_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emotional_tracker</span><span class="o">.</span><span class="n">log_state</span><span class="p">(</span>
                <span class="n">emotional_state</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;trade_entry&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="p">)</span>
            
        <span class="c1"># Create journal entry</span>
        <span class="n">psych_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;emotional_state&#39;</span><span class="p">:</span> <span class="n">emotional_state</span> <span class="ow">or</span> <span class="s1">&#39;not_recorded&#39;</span><span class="p">,</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="k">if</span> <span class="n">analysis</span> <span class="k">else</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;followed_plan&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;followed_plan&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">analysis</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="p">}</span>
        
        <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">create_entry_from_trade</span><span class="p">(</span><span class="n">trade</span><span class="p">,</span> <span class="n">psych_data</span><span class="p">,</span> <span class="n">analysis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">entry</span>
    
    <span class="k">def</span> <span class="nf">run_bias_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run bias detection on recent trades.&quot;&quot;&quot;</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">lookback_days</span><span class="p">)</span>
        <span class="n">recent_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">date_from</span><span class="o">=</span><span class="n">cutoff</span><span class="p">)</span>
        
        <span class="n">trades</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">pnl</span><span class="p">,</span>
                <span class="s1">&#39;duration_hours&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">duration_minutes</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>
                <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                <span class="s1">&#39;exit_time&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">duration_minutes</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">recent_entries</span>
        <span class="p">]</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_detector</span><span class="o">.</span><span class="n">analyze_trades</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">generate_weekly_review</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate weekly performance review.&quot;&quot;&quot;</span>
        <span class="n">week_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">weekly_review</span> <span class="o">=</span> <span class="n">WeeklyReview</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weekly_review</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">week_start</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">generate_monthly_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate monthly analysis.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">monthly</span> <span class="o">=</span> <span class="n">MonthlyAnalysis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">monthly</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_improvement_suggestions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get personalized improvement suggestions.&quot;&quot;&quot;</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span>
        
        <span class="c1"># Check win rate</span>
        <span class="k">if</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Focus on improving trade selection - win rate below 50%&quot;</span><span class="p">)</span>
            
        <span class="c1"># Check plan adherence</span>
        <span class="k">if</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plan_adherence&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Improve discipline - plan adherence below 80%&quot;</span><span class="p">)</span>
            
        <span class="c1"># Check emotional correlation</span>
        <span class="n">emotional_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emotional_tracker</span><span class="o">.</span><span class="n">analyze_state_patterns</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">emotional_analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;most_common&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;anxious&#39;</span><span class="p">,</span> <span class="s1">&#39;frustrated&#39;</span><span class="p">]:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Address emotional management - frequently trading in negative states&quot;</span><span class="p">)</span>
            
        <span class="c1"># Add bias-specific suggestions</span>
        <span class="n">biases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_bias_check</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bias</span> <span class="ow">in</span> <span class="n">biases</span><span class="p">:</span>
            <span class="n">suggestions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Address </span><span class="si">{</span><span class="n">bias</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_detector</span><span class="o">.</span><span class="n">get_mitigation</span><span class="p">(</span><span class="n">bias</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">suggestions</span>
    
    <span class="k">def</span> <span class="nf">generate_comprehensive_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive trading report.&quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span>
        <span class="n">biases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_bias_check</span><span class="p">()</span>
        <span class="n">suggestions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_improvement_suggestions</span><span class="p">()</span>
        
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;COMPREHENSIVE TRADING REPORT&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PERFORMANCE SUMMARY&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DETECTED BIASES&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">biases</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bias</span> <span class="ow">in</span> <span class="n">biases</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">bias</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">bias</span><span class="p">[</span><span class="s1">&#39;bias&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Evidence: </span><span class="si">{</span><span class="n">bias</span><span class="p">[</span><span class="s1">&#39;evidence&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  No significant biases detected&quot;</span><span class="p">)</span>
            
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;IMPROVEMENT SUGGESTIONS&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">suggestion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">suggestions</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">suggestion</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Demonstrate the automated trading journal</span>
<span class="n">auto_journal</span> <span class="o">=</span> <span class="n">AutomatedTradingJournal</span><span class="p">()</span>

<span class="c1"># Log some trades</span>
<span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">sample_trades_for_journal</span><span class="p">:</span>
    <span class="n">auto_journal</span><span class="o">.</span><span class="n">log_trade</span><span class="p">(</span>
        <span class="n">trade</span><span class="p">,</span>
        <span class="n">emotional_state</span><span class="o">=</span><span class="s1">&#39;focused&#39;</span><span class="p">,</span>
        <span class="n">analysis</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;setup_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Trend Continuation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timeframe&#39;</span><span class="p">:</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;market_conditions&#39;</span><span class="p">:</span> <span class="s1">&#39;Trending&#39;</span><span class="p">,</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
            <span class="s1">&#39;followed_plan&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="c1"># Generate comprehensive report</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">auto_journal</span><span class="o">.</span><span class="n">generate_comprehensive_report</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<ol>
<li>
<p><strong>Trading Psychology</strong>: Understanding and mitigating biases is as important as technical skills</p>
</li>
<li>
<p><strong>Journaling</strong>: Detailed trade documentation enables systematic improvement</p>
</li>
<li>
<p><strong>Regular Reviews</strong>: Weekly and monthly reviews identify patterns and areas for improvement</p>
</li>
<li>
<p><strong>Continuous Improvement</strong>: A/B testing and goal tracking accelerate development</p>
</li>
<li>
<p><strong>Automation</strong>: Automated systems ensure consistency and reduce manual effort</p>
</li>
</ol>
<hr />
<p><strong>Next</strong>: Capstone Project - Build a complete 24-hour Forex/Futures Trading System</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="15"><div class="md-cell module-header"><h1>Capstone Project: 24-Hour Forex/Futures Trading System</h1>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~8-10 hours</td>
</tr>
<tr>
<td><strong>Skill Level</strong></td>
<td>Advanced</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>All Course 5 Modules</td>
</tr>
</tbody>
</table></div>
<h2>Project Overview</h2>
<p>Build a complete, production-ready 24-hour trading system that combines everything you've learned in this course.</p>
<h3>System Requirements</h3>
<ul>
<li>Multi-currency monitoring</li>
<li>Economic calendar integration</li>
<li>Technical + fundamental signals</li>
<li>Leveraged risk management</li>
<li>OANDA or MT5 execution (simulated)</li>
<li>24-hour scheduling</li>
<li>Performance tracking</li>
<li>Automated journaling</li>
</ul>
<h3>Learning Objectives</h3>
<p>By completing this capstone, you will demonstrate mastery of:
- Forex and futures market mechanics
- Technical and fundamental analysis integration
- Risk management for leveraged products
- Automated trading system development
- Performance monitoring and analysis
- Professional software engineering practices</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 1: Core Infrastructure</h2>
<p>Build the foundational components of the trading system.</p></div>
<div class="md-cell"><h3>1.1 Data Models</h3></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">OrderType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">MARKET</span> <span class="o">=</span> <span class="s2">&quot;market&quot;</span>
    <span class="n">LIMIT</span> <span class="o">=</span> <span class="s2">&quot;limit&quot;</span>
    <span class="n">STOP</span> <span class="o">=</span> <span class="s2">&quot;stop&quot;</span>


<span class="k">class</span> <span class="nc">OrderSide</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">BUY</span> <span class="o">=</span> <span class="s2">&quot;buy&quot;</span>
    <span class="n">SELL</span> <span class="o">=</span> <span class="s2">&quot;sell&quot;</span>


<span class="k">class</span> <span class="nc">TradingSession</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">SYDNEY</span> <span class="o">=</span> <span class="s2">&quot;Sydney&quot;</span>
    <span class="n">TOKYO</span> <span class="o">=</span> <span class="s2">&quot;Tokyo&quot;</span>
    <span class="n">LONDON</span> <span class="o">=</span> <span class="s2">&quot;London&quot;</span>
    <span class="n">NEW_YORK</span> <span class="o">=</span> <span class="s2">&quot;New_York&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Tick</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Single price tick.&quot;&quot;&quot;</span>
    <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">bid</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">ask</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bid</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spread_pips</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ask</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bid</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">OHLC</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;OHLC candle data.&quot;&quot;&quot;</span>
    <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="nb">open</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">high</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">low</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">close</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">volume</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trading order.&quot;&quot;&quot;</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">side</span><span class="p">:</span> <span class="n">OrderSide</span>
    <span class="n">order_type</span><span class="p">:</span> <span class="n">OrderType</span>
    <span class="n">units</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stop_loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">take_profit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">trailing_stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
    <span class="n">fill_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fill_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Position</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Open position.&quot;&quot;&quot;</span>
    <span class="n">position_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">units</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">entry_time</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">stop_loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">take_profit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">side</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;long&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;short&quot;</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unrealized_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_price</span><span class="p">)</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unrealized_pips</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff</span>
        <span class="k">return</span> <span class="n">diff</span> <span class="o">*</span> <span class="mi">10000</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TradeRecord</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Completed trade record.&quot;&quot;&quot;</span>
    <span class="n">trade_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">side</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">units</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">entry_time</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">exit_time</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">pnl</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">pnl_pips</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">setup_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</code></pre></div>
<div class="md-cell"><h3>1.2 Market Data Manager</h3></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">MarketDataManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage market data for multiple instruments.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tick</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">candles</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">OHLC</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tick</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">def</span> <span class="nf">update_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update with new tick.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticks</span><span class="p">[</span><span class="n">tick</span><span class="o">.</span><span class="n">instrument</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_prices</span><span class="p">[</span><span class="n">tick</span><span class="o">.</span><span class="n">instrument</span><span class="p">]</span> <span class="o">=</span> <span class="n">tick</span>
        
        <span class="c1"># Keep only last 10000 ticks per instrument</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticks</span><span class="p">[</span><span class="n">tick</span><span class="o">.</span><span class="n">instrument</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ticks</span><span class="p">[</span><span class="n">tick</span><span class="o">.</span><span class="n">instrument</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticks</span><span class="p">[</span><span class="n">tick</span><span class="o">.</span><span class="n">instrument</span><span class="p">][</span><span class="o">-</span><span class="mi">10000</span><span class="p">:]</span>
            
    <span class="k">def</span> <span class="nf">add_candle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candle</span><span class="p">:</span> <span class="n">OHLC</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add OHLC candle.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">candles</span><span class="p">[</span><span class="n">candle</span><span class="o">.</span><span class="n">instrument</span><span class="p">][</span><span class="n">candle</span><span class="o">.</span><span class="n">timeframe</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candle</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">get_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tick</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get current price for instrument.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_candles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">OHLC</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get recent candles.&quot;&quot;&quot;</span>
        <span class="n">candles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">candles</span><span class="p">[</span><span class="n">instrument</span><span class="p">][</span><span class="n">timeframe</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">candles</span><span class="p">[</span><span class="o">-</span><span class="n">count</span><span class="p">:]</span> <span class="k">if</span> <span class="n">candles</span> <span class="k">else</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">get_ohlc_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get candles as DataFrame.&quot;&quot;&quot;</span>
        <span class="n">candles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_candles</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">candles</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            
        <span class="n">data</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">open</span><span class="p">,</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
            <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">low</span><span class="p">,</span>
            <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
            <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">volume</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candles</span><span class="p">]</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
</code></pre></div>
<div class="md-cell"><h3>1.3 Simulated Broker</h3></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">SimulatedBroker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simulated broker for paper trading.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_balance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10000.0</span><span class="p">,</span> <span class="n">leverage</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">initial_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_balance</span> <span class="o">=</span> <span class="n">initial_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span> <span class="o">=</span> <span class="n">leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Position</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Order</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TradeRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_count</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Commission structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spread_markup</span> <span class="o">=</span> <span class="mf">0.0001</span>  <span class="c1"># 1 pip additional spread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission_per_lot</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># No commission (spread only)</span>
        
    <span class="k">def</span> <span class="nf">get_account_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get account summary.&quot;&quot;&quot;</span>
        <span class="n">unrealized_pnl</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">unrealized_pnl</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">equity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">unrealized_pnl</span>
        
        <span class="c1"># Calculate margin used</span>
        <span class="n">margin_used</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">notional</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">units</span><span class="p">)</span> <span class="o">*</span> <span class="n">pos</span><span class="o">.</span><span class="n">current_price</span>
            <span class="n">margin_used</span> <span class="o">+=</span> <span class="n">notional</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">leverage</span>
            
        <span class="n">margin_available</span> <span class="o">=</span> <span class="n">equity</span> <span class="o">-</span> <span class="n">margin_used</span>
        <span class="n">margin_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">/</span> <span class="n">margin_used</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">margin_used</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">,</span>
            <span class="s1">&#39;unrealized_pnl&#39;</span><span class="p">:</span> <span class="n">unrealized_pnl</span><span class="p">,</span>
            <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="n">equity</span><span class="p">,</span>
            <span class="s1">&#39;margin_used&#39;</span><span class="p">:</span> <span class="n">margin_used</span><span class="p">,</span>
            <span class="s1">&#39;margin_available&#39;</span><span class="p">:</span> <span class="n">margin_available</span><span class="p">,</span>
            <span class="s1">&#39;margin_level&#39;</span><span class="p">:</span> <span class="n">margin_level</span><span class="p">,</span>
            <span class="s1">&#39;open_positions&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">),</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">submit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="n">OrderSide</span><span class="p">,</span> <span class="n">units</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">order_type</span><span class="p">:</span> <span class="n">OrderType</span> <span class="o">=</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">,</span>
                     <span class="n">price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">take_profit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">current_tick</span><span class="p">:</span> <span class="n">Tick</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit a new order.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">order_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ORD-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">order_count</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
            <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
            <span class="n">order_type</span><span class="o">=</span><span class="n">order_type</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
            <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
            <span class="n">stop_loss</span><span class="o">=</span><span class="n">stop_loss</span><span class="p">,</span>
            <span class="n">take_profit</span><span class="o">=</span><span class="n">take_profit</span>
        <span class="p">)</span>
        
        <span class="c1"># For market orders, execute immediately</span>
        <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span> <span class="ow">and</span> <span class="n">current_tick</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_order</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">current_tick</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
            
        <span class="k">return</span> <span class="n">order</span>
    
    <span class="k">def</span> <span class="nf">_execute_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute an order at current price.&quot;&quot;&quot;</span>
        <span class="c1"># Determine fill price (include spread)</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">:</span>
            <span class="n">fill_price</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">ask</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spread_markup</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fill_price</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spread_markup</span>
            
        <span class="n">order</span><span class="o">.</span><span class="n">fill_price</span> <span class="o">=</span> <span class="n">fill_price</span>
        <span class="n">order</span><span class="o">.</span><span class="n">fill_time</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span>
        <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;filled&quot;</span>
        
        <span class="c1"># Check if this closes an existing position</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_position</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_position</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_open_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a new position.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">position_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;POS-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">position_count</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="n">units</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">units</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span> <span class="k">else</span> <span class="o">-</span><span class="n">order</span><span class="o">.</span><span class="n">units</span>
        
        <span class="n">position</span> <span class="o">=</span> <span class="n">Position</span><span class="p">(</span>
            <span class="n">position_id</span><span class="o">=</span><span class="n">position_id</span><span class="p">,</span>
            <span class="n">instrument</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
            <span class="n">entry_price</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">fill_price</span><span class="p">,</span>
            <span class="n">entry_time</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">fill_time</span><span class="p">,</span>
            <span class="n">stop_loss</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">,</span>
            <span class="n">take_profit</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">take_profit</span><span class="p">,</span>
            <span class="n">current_price</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">fill_price</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">instrument</span><span class="p">]</span> <span class="o">=</span> <span class="n">position</span>
        
    <span class="k">def</span> <span class="nf">_update_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update existing position (add to or close).&quot;&quot;&quot;</span>
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">instrument</span><span class="p">]</span>
        <span class="n">order_units</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">units</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span> <span class="k">else</span> <span class="o">-</span><span class="n">order</span><span class="o">.</span><span class="n">units</span>
        <span class="n">new_units</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">units</span> <span class="o">+</span> <span class="n">order_units</span>
        
        <span class="k">if</span> <span class="n">new_units</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Position fully closed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">fill_price</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">units</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">new_units</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">units</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">new_units</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># Position reversed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">fill_price</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
            <span class="c1"># Open new position with remaining units</span>
            <span class="n">order</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">new_units</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_position</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Position increased</span>
            <span class="n">total_cost</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">units</span><span class="p">)</span> <span class="o">+</span> <span class="n">order</span><span class="o">.</span><span class="n">fill_price</span> <span class="o">*</span> <span class="n">order</span><span class="o">.</span><span class="n">units</span>
            <span class="n">position</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">new_units</span>
            <span class="n">position</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">=</span> <span class="n">total_cost</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">new_units</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_close_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">exit_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close a position and record the trade.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">instrument</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span>
        
        <span class="c1"># Calculate P&amp;L</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">units</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">position</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">position</span><span class="o">.</span><span class="n">units</span>
            <span class="n">pnl_pips</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">position</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">-</span> <span class="n">exit_price</span><span class="p">)</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
            <span class="n">pnl_pips</span> <span class="o">=</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">-</span> <span class="n">exit_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span>
            
        <span class="c1"># Update balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">pnl</span>
        
        <span class="c1"># Record trade</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="n">TradeRecord</span><span class="p">(</span>
            <span class="n">trade_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;TRD-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_count</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="n">position</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">units</span><span class="p">),</span>
            <span class="n">entry_price</span><span class="o">=</span><span class="n">position</span><span class="o">.</span><span class="n">entry_price</span><span class="p">,</span>
            <span class="n">exit_price</span><span class="o">=</span><span class="n">exit_price</span><span class="p">,</span>
            <span class="n">entry_time</span><span class="o">=</span><span class="n">position</span><span class="o">.</span><span class="n">entry_time</span><span class="p">,</span>
            <span class="n">exit_time</span><span class="o">=</span><span class="n">exit_time</span><span class="p">,</span>
            <span class="n">pnl</span><span class="o">=</span><span class="n">pnl</span><span class="p">,</span>
            <span class="n">pnl_pips</span><span class="o">=</span><span class="n">pnl_pips</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        
        <span class="c1"># Remove position</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">update_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market_data</span><span class="p">:</span> <span class="n">MarketDataManager</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update position prices and check stops/targets.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">position</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">tick</span> <span class="o">=</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tick</span><span class="p">:</span>
                <span class="n">position</span><span class="o">.</span><span class="n">current_price</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">mid</span>
                
                <span class="c1"># Check stop loss</span>
                <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">units</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span> <span class="o">&lt;=</span> <span class="n">position</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">position</span><span class="o">.</span><span class="n">units</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tick</span><span class="o">.</span><span class="n">ask</span> <span class="o">&gt;=</span> <span class="n">position</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">ask</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
                        
                <span class="c1"># Check take profit</span>
                <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">take_profit</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">units</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span> <span class="o">&gt;=</span> <span class="n">position</span><span class="o">.</span><span class="n">take_profit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">position</span><span class="o">.</span><span class="n">units</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tick</span><span class="o">.</span><span class="n">ask</span> <span class="o">&lt;=</span> <span class="n">position</span><span class="o">.</span><span class="n">take_profit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">ask</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
                        
    <span class="k">def</span> <span class="nf">close_all_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market_data</span><span class="p">:</span> <span class="n">MarketDataManager</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close all open positions.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">tick</span> <span class="o">=</span> <span class="n">market_data</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tick</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">instrument</span><span class="p">]</span>
                <span class="n">exit_price</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span> <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">units</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">tick</span><span class="o">.</span><span class="n">ask</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_close_position</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">exit_price</span><span class="p">,</span> <span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 2: Signal Generation</h2>
<p>Build signal generation from technical and fundamental analysis.</p></div>
<div class="md-cell"><h3>2.1 Technical Indicators</h3></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TechnicalIndicators</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate technical indicators.&quot;&quot;&quot;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simple Moving Average.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ema</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Exponential Moving Average.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">prices</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rsi</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Relative Strength Index.&quot;&quot;&quot;</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="k">return</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">atr</span><span class="p">(</span><span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Average True Range.&quot;&quot;&quot;</span>
        <span class="n">tr1</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
        <span class="n">tr2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
        <span class="n">tr3</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">tr3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bollinger_bands</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">std_dev</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Bollinger Bands.&quot;&quot;&quot;</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">middle</span> <span class="o">+</span> <span class="n">std_dev</span> <span class="o">*</span> <span class="n">std</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">middle</span> <span class="o">-</span> <span class="n">std_dev</span> <span class="o">*</span> <span class="n">std</span>
        <span class="k">return</span> <span class="n">upper</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">lower</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">macd</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">fast</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">slow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;MACD indicator.&quot;&quot;&quot;</span>
        <span class="n">ema_fast</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ema_slow</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">slow</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">macd_line</span> <span class="o">=</span> <span class="n">ema_fast</span> <span class="o">-</span> <span class="n">ema_slow</span>
        <span class="n">signal_line</span> <span class="o">=</span> <span class="n">macd_line</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">histogram</span> <span class="o">=</span> <span class="n">macd_line</span> <span class="o">-</span> <span class="n">signal_line</span>
        <span class="k">return</span> <span class="n">macd_line</span><span class="p">,</span> <span class="n">signal_line</span><span class="p">,</span> <span class="n">histogram</span>
</code></pre></div>
<div class="md-cell"><h3>2.2 Signal Generator</h3></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Signal</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trading signal.&quot;&quot;&quot;</span>
    <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;long&#39; or &#39;short&#39;</span>
    <span class="n">strength</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># 0.0 to 1.0</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;technical&#39;, &#39;fundamental&#39;, &#39;combined&#39;</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">entry_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stop_loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">take_profit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SignalGenerator</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for signal generators.&quot;&quot;&quot;</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate trading signal from data.&quot;&quot;&quot;</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">TrendFollowingSignal</span><span class="p">(</span><span class="n">SignalGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trend following signal using moving averages.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">slow_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">atr_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast_period</span> <span class="o">=</span> <span class="n">fast_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_period</span> <span class="o">=</span> <span class="n">slow_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr_period</span> <span class="o">=</span> <span class="n">atr_period</span>
        
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="c1"># Calculate indicators</span>
        <span class="n">fast_ma</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">ema</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast_period</span><span class="p">)</span>
        <span class="n">slow_ma</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">ema</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_period</span><span class="p">)</span>
        <span class="n">atr</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">atr</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr_period</span><span class="p">)</span>
        
        <span class="n">current_fast</span> <span class="o">=</span> <span class="n">fast_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_slow</span> <span class="o">=</span> <span class="n">slow_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prev_fast</span> <span class="o">=</span> <span class="n">fast_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">prev_slow</span> <span class="o">=</span> <span class="n">slow_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">current_atr</span> <span class="o">=</span> <span class="n">atr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_price</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Check for crossover</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">prev_fast</span> <span class="o">&lt;=</span> <span class="n">prev_slow</span> <span class="ow">and</span> <span class="n">current_fast</span> <span class="o">&gt;</span> <span class="n">current_slow</span><span class="p">:</span>
            <span class="c1"># Bullish crossover</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;long&#39;</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="s1">&#39;technical&#39;</span><span class="p">,</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">entry_price</span><span class="o">=</span><span class="n">current_price</span><span class="p">,</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">current_price</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">current_atr</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">current_price</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">current_atr</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">:</span> <span class="n">current_fast</span><span class="p">,</span> <span class="s1">&#39;slow_ma&#39;</span><span class="p">:</span> <span class="n">current_slow</span><span class="p">,</span> <span class="s1">&#39;atr&#39;</span><span class="p">:</span> <span class="n">current_atr</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">prev_fast</span> <span class="o">&gt;=</span> <span class="n">prev_slow</span> <span class="ow">and</span> <span class="n">current_fast</span> <span class="o">&lt;</span> <span class="n">current_slow</span><span class="p">:</span>
            <span class="c1"># Bearish crossover</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;short&#39;</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="s1">&#39;technical&#39;</span><span class="p">,</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">entry_price</span><span class="o">=</span><span class="n">current_price</span><span class="p">,</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">current_price</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">current_atr</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">current_price</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">current_atr</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">:</span> <span class="n">current_fast</span><span class="p">,</span> <span class="s1">&#39;slow_ma&#39;</span><span class="p">:</span> <span class="n">current_slow</span><span class="p">,</span> <span class="s1">&#39;atr&#39;</span><span class="p">:</span> <span class="n">current_atr</span><span class="p">}</span>
            <span class="p">)</span>
            
        <span class="k">return</span> <span class="n">signal</span>


<span class="k">class</span> <span class="nc">MeanReversionSignal</span><span class="p">(</span><span class="n">SignalGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mean reversion signal using Bollinger Bands.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">std_dev</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">rsi_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std_dev</span> <span class="o">=</span> <span class="n">std_dev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span> <span class="o">=</span> <span class="n">rsi_period</span>
        
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Signal</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="c1"># Calculate indicators</span>
        <span class="n">upper</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">lower</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">bollinger_bands</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_dev</span><span class="p">)</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">rsi</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsi_period</span><span class="p">)</span>
        <span class="n">atr</span> <span class="o">=</span> <span class="n">TechnicalIndicators</span><span class="o">.</span><span class="n">atr</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">],</span> <span class="mi">14</span><span class="p">)</span>
        
        <span class="n">current_price</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_rsi</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_atr</span> <span class="o">=</span> <span class="n">atr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_upper</span> <span class="o">=</span> <span class="n">upper</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_lower</span> <span class="o">=</span> <span class="n">lower</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_middle</span> <span class="o">=</span> <span class="n">middle</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">signal</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Oversold at lower band</span>
        <span class="k">if</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">current_lower</span> <span class="ow">and</span> <span class="n">current_rsi</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;long&#39;</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="mf">0.6</span> <span class="o">+</span> <span class="p">(</span><span class="mi">30</span> <span class="o">-</span> <span class="n">current_rsi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="s1">&#39;technical&#39;</span><span class="p">,</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">entry_price</span><span class="o">=</span><span class="n">current_price</span><span class="p">,</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">current_price</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">current_atr</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">current_middle</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">current_rsi</span><span class="p">,</span> <span class="s1">&#39;bb_lower&#39;</span><span class="p">:</span> <span class="n">current_lower</span><span class="p">,</span> <span class="s1">&#39;bb_middle&#39;</span><span class="p">:</span> <span class="n">current_middle</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="c1"># Overbought at upper band</span>
        <span class="k">elif</span> <span class="n">current_price</span> <span class="o">&gt;=</span> <span class="n">current_upper</span> <span class="ow">and</span> <span class="n">current_rsi</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span>
                <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;short&#39;</span><span class="p">,</span>
                <span class="n">strength</span><span class="o">=</span><span class="mf">0.6</span> <span class="o">+</span> <span class="p">(</span><span class="n">current_rsi</span> <span class="o">-</span> <span class="mi">70</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="s1">&#39;technical&#39;</span><span class="p">,</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">entry_price</span><span class="o">=</span><span class="n">current_price</span><span class="p">,</span>
                <span class="n">stop_loss</span><span class="o">=</span><span class="n">current_price</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">current_atr</span><span class="p">,</span>
                <span class="n">take_profit</span><span class="o">=</span><span class="n">current_middle</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">current_rsi</span><span class="p">,</span> <span class="s1">&#39;bb_upper&#39;</span><span class="p">:</span> <span class="n">current_upper</span><span class="p">,</span> <span class="s1">&#39;bb_middle&#39;</span><span class="p">:</span> <span class="n">current_middle</span><span class="p">}</span>
            <span class="p">)</span>
            
        <span class="k">return</span> <span class="n">signal</span>
</code></pre></div>
<div class="md-cell"><h3>2.3 Economic Calendar Integration</h3></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">EconomicEvent</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Economic calendar event.&quot;&quot;&quot;</span>
    <span class="n">event_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">impact</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;low&#39;, &#39;medium&#39;, &#39;high&#39;</span>
    <span class="n">datetime</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">actual</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">forecast</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">previous</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">EconomicCalendar</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Economic calendar for fundamental analysis.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">EconomicEvent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">EconomicEvent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an economic event.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">get_upcoming_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours_ahead</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">EconomicEvent</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get events in the next N hours.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours_ahead</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="k">if</span> <span class="n">now</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">.</span><span class="n">datetime</span> <span class="o">&lt;=</span> <span class="n">cutoff</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_high_impact_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours_ahead</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">EconomicEvent</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get high impact events.&quot;&quot;&quot;</span>
        <span class="n">upcoming</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_upcoming_events</span><span class="p">(</span><span class="n">hours_ahead</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">upcoming</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">impact</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">should_avoid_trading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">minutes_before</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EconomicEvent</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Check if trading should be avoided due to upcoming event.&quot;&quot;&quot;</span>
        <span class="c1"># Extract currencies from instrument</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">quote</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="k">else</span> <span class="n">instrument</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">event_window</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">minutes_before</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">impact</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">currency</span> <span class="ow">in</span> <span class="p">[</span><span class="n">base</span><span class="p">,</span> <span class="n">quote</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">now</span> <span class="o">&lt;=</span> <span class="n">event</span><span class="o">.</span><span class="n">datetime</span> <span class="o">&lt;=</span> <span class="n">event_window</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">event</span>
                    
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>


<span class="c1"># Create sample economic calendar</span>
<span class="k">def</span> <span class="nf">create_sample_calendar</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">EconomicCalendar</span><span class="p">:</span>
    <span class="n">calendar</span> <span class="o">=</span> <span class="n">EconomicCalendar</span><span class="p">()</span>
    
    <span class="c1"># Add sample events</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">EconomicEvent</span><span class="p">(</span><span class="s1">&#39;EVT001&#39;</span><span class="p">,</span> <span class="s1">&#39;Non-Farm Payrolls&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span>
        <span class="n">EconomicEvent</span><span class="p">(</span><span class="s1">&#39;EVT002&#39;</span><span class="p">,</span> <span class="s1">&#39;ECB Rate Decision&#39;</span><span class="p">,</span> <span class="s1">&#39;EUR&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">5</span><span class="p">)),</span>
        <span class="n">EconomicEvent</span><span class="p">(</span><span class="s1">&#39;EVT003&#39;</span><span class="p">,</span> <span class="s1">&#39;UK CPI&#39;</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">12</span><span class="p">)),</span>
        <span class="n">EconomicEvent</span><span class="p">(</span><span class="s1">&#39;EVT004&#39;</span><span class="p">,</span> <span class="s1">&#39;US Retail Sales&#39;</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">26</span><span class="p">)),</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
        <span class="n">calendar</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">calendar</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 3: Risk Management</h2>
<p>Implement comprehensive risk management for leveraged trading.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">RiskManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive risk management for forex/futures.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_risk_per_trade</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
                 <span class="n">max_daily_loss</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                 <span class="n">max_positions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                 <span class="n">max_correlation_exposure</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_per_trade</span> <span class="o">=</span> <span class="n">max_risk_per_trade</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_daily_loss</span> <span class="o">=</span> <span class="n">max_daily_loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_positions</span> <span class="o">=</span> <span class="n">max_positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_correlation_exposure</span> <span class="o">=</span> <span class="n">max_correlation_exposure</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_start_balance</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_reset</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Currency pair correlations (simplified)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correlations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">):</span> <span class="mf">0.85</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;USDCHF&#39;</span><span class="p">):</span> <span class="o">-</span><span class="mf">0.90</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;AUDUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;NZDUSD&#39;</span><span class="p">):</span> <span class="mf">0.90</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;USDJPY&#39;</span><span class="p">,</span> <span class="s1">&#39;EURJPY&#39;</span><span class="p">):</span> <span class="mf">0.75</span><span class="p">,</span>
        <span class="p">}</span>
        
    <span class="k">def</span> <span class="nf">reset_daily</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset daily tracking.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_start_balance</span> <span class="o">=</span> <span class="n">current_balance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_balance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pip_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate position size based on risk.&quot;&quot;&quot;</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">account_balance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_per_trade</span>
        <span class="n">stop_distance_pips</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">entry_price</span> <span class="o">-</span> <span class="n">stop_loss</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span>
        
        <span class="k">if</span> <span class="n">stop_distance_pips</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
            
        <span class="c1"># Position size in lots (100,000 units)</span>
        <span class="n">position_lots</span> <span class="o">=</span> <span class="n">risk_amount</span> <span class="o">/</span> <span class="p">(</span><span class="n">stop_distance_pips</span> <span class="o">*</span> <span class="n">pip_value</span><span class="p">)</span>
        
        <span class="c1"># Round to micro lots (0.01)</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">position_lots</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">can_open_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">:</span> <span class="n">SimulatedBroker</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="n">Signal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check if a new trade can be opened.&quot;&quot;&quot;</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">broker</span><span class="o">.</span><span class="n">get_account_summary</span><span class="p">()</span>
        
        <span class="c1"># Check daily loss limit</span>
        <span class="n">daily_loss_pct</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_start_balance</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_start_balance</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">daily_loss_pct</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_daily_loss</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Daily loss limit reached: </span><span class="si">{</span><span class="n">daily_loss_pct</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span>
            
        <span class="c1"># Check max positions</span>
        <span class="k">if</span> <span class="n">account</span><span class="p">[</span><span class="s1">&#39;open_positions&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_positions</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Max positions reached: </span><span class="si">{</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;open_positions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            
        <span class="c1"># Check margin level</span>
        <span class="k">if</span> <span class="n">account</span><span class="p">[</span><span class="s1">&#39;margin_level&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Low margin level: </span><span class="si">{</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;margin_level&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span>
            
        <span class="c1"># Check correlation exposure</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_correlation</span><span class="p">(</span><span class="n">broker</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">instrument</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Correlation exposure too high&quot;</span>
            
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;OK&quot;</span>
    
    <span class="k">def</span> <span class="nf">_check_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Position</span><span class="p">],</span> <span class="n">new_instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if new position would create too much correlation exposure.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
            <span class="n">pair</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">inst</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">new_instrument</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]))</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_correlation_exposure</span><span class="p">:</span>
                <span class="c1"># Check if same direction for positive correlation</span>
                <span class="k">return</span> <span class="kc">False</span>
                
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">update_daily_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pnl</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update daily P&amp;L tracking.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">+=</span> <span class="n">pnl</span>
        
    <span class="k">def</span> <span class="nf">get_risk_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">broker</span><span class="p">:</span> <span class="n">SimulatedBroker</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current risk metrics.&quot;&quot;&quot;</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">broker</span><span class="o">.</span><span class="n">get_account_summary</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;daily_pnl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">,</span>
            <span class="s1">&#39;daily_pnl_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_start_balance</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_start_balance</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;daily_loss_limit_remaining&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_daily_loss</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_start_balance</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_pnl</span><span class="p">),</span>
            <span class="s1">&#39;margin_level&#39;</span><span class="p">:</span> <span class="n">account</span><span class="p">[</span><span class="s1">&#39;margin_level&#39;</span><span class="p">],</span>
            <span class="s1">&#39;open_positions&#39;</span><span class="p">:</span> <span class="n">account</span><span class="p">[</span><span class="s1">&#39;open_positions&#39;</span><span class="p">],</span>
            <span class="s1">&#39;max_positions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_positions</span><span class="p">,</span>
            <span class="s1">&#39;equity&#39;</span><span class="p">:</span> <span class="n">account</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 4: Trading Engine</h2>
<p>Build the core trading engine that orchestrates all components.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">TradingEngine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Core trading engine orchestrating all components.</span>
<span class="sd">    </span>
<span class="sd">    Components:</span>
<span class="sd">    - Market data management</span>
<span class="sd">    - Signal generation</span>
<span class="sd">    - Risk management</span>
<span class="sd">    - Order execution</span>
<span class="sd">    - Performance tracking</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        
        <span class="c1"># Initialize components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span> <span class="o">=</span> <span class="n">MarketDataManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broker</span> <span class="o">=</span> <span class="n">SimulatedBroker</span><span class="p">(</span>
            <span class="n">initial_balance</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_balance&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">),</span>
            <span class="n">leverage</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;leverage&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span> <span class="o">=</span> <span class="n">RiskManager</span><span class="p">(</span>
            <span class="n">max_risk_per_trade</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;risk_per_trade&#39;</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">),</span>
            <span class="n">max_daily_loss</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_daily_loss&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
            <span class="n">max_positions</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_positions&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="n">create_sample_calendar</span><span class="p">()</span>
        
        <span class="c1"># Signal generators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_generators</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SignalGenerator</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">TrendFollowingSignal</span><span class="p">(),</span>
            <span class="n">MeanReversionSignal</span><span class="p">()</span>
        <span class="p">]</span>
        
        <span class="c1"># Trading parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instruments</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instruments&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;USDJPY&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframe</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeframe&#39;</span><span class="p">,</span> <span class="s1">&#39;H1&#39;</span><span class="p">)</span>
        
        <span class="c1"># State</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals_generated</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades_executed</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Logging</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;TradingEngine&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start the trading engine.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">reset_daily</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">balance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trading engine started&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the trading engine.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">close_all_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trading engine stopped&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">pause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pause trading.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trading paused&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resume trading.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Trading resumed&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">on_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">Tick</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process new tick data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Update market data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">update_tick</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
        
        <span class="c1"># Update positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">update_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">on_candle_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candle</span><span class="p">:</span> <span class="n">OHLC</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process candle close - main signal generation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">paused</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Add candle to market data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">add_candle</span><span class="p">(</span><span class="n">candle</span><span class="p">)</span>
        
        <span class="c1"># Skip if already in position for this instrument</span>
        <span class="k">if</span> <span class="n">candle</span><span class="o">.</span><span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Check economic calendar</span>
        <span class="n">should_avoid</span><span class="p">,</span> <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="o">.</span><span class="n">should_avoid_trading</span><span class="p">(</span><span class="n">candle</span><span class="o">.</span><span class="n">instrument</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">should_avoid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avoiding </span><span class="si">{</span><span class="n">candle</span><span class="o">.</span><span class="n">instrument</span><span class="si">}</span><span class="s2"> due to </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
            
        <span class="c1"># Get price data</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">get_ohlc_dataframe</span><span class="p">(</span><span class="n">candle</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="n">candle</span><span class="o">.</span><span class="n">timeframe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Generate signals</span>
        <span class="n">best_signal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_strength</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">generator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_generators</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">candle</span><span class="o">.</span><span class="n">instrument</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signal</span> <span class="ow">and</span> <span class="n">signal</span><span class="o">.</span><span class="n">strength</span> <span class="o">&gt;</span> <span class="n">best_strength</span><span class="p">:</span>
                <span class="n">best_signal</span> <span class="o">=</span> <span class="n">signal</span>
                <span class="n">best_strength</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">strength</span>
                
        <span class="k">if</span> <span class="n">best_signal</span> <span class="ow">and</span> <span class="n">best_strength</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_signal_strength&#39;</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signals_generated</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_signal</span><span class="p">(</span><span class="n">best_signal</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_process_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="n">Signal</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process and potentially execute a signal.&quot;&quot;&quot;</span>
        <span class="c1"># Check if we can trade</span>
        <span class="n">can_trade</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">can_open_trade</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">can_trade</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal rejected: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
            
        <span class="c1"># Calculate position size</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">get_account_summary</span><span class="p">()</span>
        <span class="n">position_lots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span>
            <span class="n">account</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">],</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">entry_price</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">stop_loss</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">position_lots</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Position size too small&quot;</span><span class="p">)</span>
            <span class="k">return</span>
            
        <span class="c1"># Convert lots to units</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">position_lots</span> <span class="o">*</span> <span class="mi">100000</span>
        
        <span class="c1"># Get current tick</span>
        <span class="n">tick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_data</span><span class="o">.</span><span class="n">get_price</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">instrument</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tick</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="c1"># Submit order</span>
        <span class="n">side</span> <span class="o">=</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span> <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span>
        
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span>
            <span class="n">instrument</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
            <span class="n">order_type</span><span class="o">=</span><span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">,</span>
            <span class="n">stop_loss</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">stop_loss</span><span class="p">,</span>
            <span class="n">take_profit</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">take_profit</span><span class="p">,</span>
            <span class="n">current_tick</span><span class="o">=</span><span class="n">tick</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;filled&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trades_executed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trade executed: </span><span class="si">{</span><span class="n">signal</span><span class="o">.</span><span class="n">instrument</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">signal</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">fill_price</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current engine status.&quot;&quot;&quot;</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">get_account_summary</span><span class="p">()</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">get_risk_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;running&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">,</span>
            <span class="s1">&#39;paused&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">paused</span><span class="p">,</span>
            <span class="s1">&#39;account&#39;</span><span class="p">:</span> <span class="n">account</span><span class="p">,</span>
            <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="n">risk</span><span class="p">,</span>
            <span class="s1">&#39;signals_generated&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals_generated</span><span class="p">,</span>
            <span class="s1">&#39;trades_executed&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades_executed</span><span class="p">,</span>
            <span class="s1">&#39;open_positions&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">positions</span><span class="p">),</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">trade_history</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 5: Performance Tracking &amp; Journaling</h2>
<p>Implement automated performance tracking and trade journaling.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">class</span> <span class="nc">PerformanceTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track and analyze trading performance.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="n">TradingEngine</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_snapshots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">calculate_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate comprehensive statistics.&quot;&quot;&quot;</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">trade_history</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            
        <span class="n">winners</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">losers</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="n">total_pnl</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">)</span>
        
        <span class="c1"># Calculate metrics</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">avg_win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">winners</span><span class="p">])</span> <span class="k">if</span> <span class="n">winners</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">losers</span><span class="p">])</span> <span class="k">if</span> <span class="n">losers</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="n">gross_profit</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">winners</span><span class="p">)</span>
        <span class="n">gross_loss</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">losers</span><span class="p">))</span>
        <span class="n">profit_factor</span> <span class="o">=</span> <span class="n">gross_profit</span> <span class="o">/</span> <span class="n">gross_loss</span> <span class="k">if</span> <span class="n">gross_loss</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        
        <span class="c1"># Calculate max drawdown</span>
        <span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">initial_balance</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
            <span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">trade</span><span class="o">.</span><span class="n">pnl</span><span class="p">)</span>
            
        <span class="n">peak</span> <span class="o">=</span> <span class="n">equity_curve</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">equity</span> <span class="ow">in</span> <span class="n">equity_curve</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">equity</span> <span class="o">&gt;</span> <span class="n">peak</span><span class="p">:</span>
                <span class="n">peak</span> <span class="o">=</span> <span class="n">equity</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="n">equity</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">max_dd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_dd</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span>
            
        <span class="c1"># Calculate Sharpe ratio (simplified daily)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">returns</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">pnl</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">]</span>
            <span class="n">sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sharpe</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;winners&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">),</span>
            <span class="s1">&#39;losers&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">losers</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="n">total_pnl</span><span class="p">,</span>
            <span class="s1">&#39;avg_win&#39;</span><span class="p">:</span> <span class="n">avg_win</span><span class="p">,</span>
            <span class="s1">&#39;avg_loss&#39;</span><span class="p">:</span> <span class="n">avg_loss</span><span class="p">,</span>
            <span class="s1">&#39;profit_factor&#39;</span><span class="p">:</span> <span class="n">profit_factor</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;return_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">balance</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">initial_balance</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate performance report.&quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_statistics</span><span class="p">()</span>
        <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">get_account_summary</span><span class="p">()</span>
        
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s2">&quot;TRADING SYSTEM PERFORMANCE REPORT&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ACCOUNT SUMMARY&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Initial Balance: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">initial_balance</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Current Balance: $</span><span class="si">{</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Equity: $</span><span class="si">{</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Return: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TRADING STATISTICS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Total Trades: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_trades&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Winners: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;winners&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Losers: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;losers&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Win Rate: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Average Win: $</span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avg_win&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Average Loss: $</span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avg_loss&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Profit Factor: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profit_factor&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RISK METRICS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Max Drawdown: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Sharpe Ratio: </span><span class="si">{</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Open Positions: </span><span class="si">{</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;open_positions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Margin Level: </span><span class="si">{</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;margin_level&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="p">]</span>
        
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 6: Running the System</h2>
<p>Demonstrate the complete trading system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="k">def</span> <span class="nf">generate_sample_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">OHLC</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tick</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Generate sample market data for testing.&quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="c1"># Starting prices</span>
    <span class="n">start_prices</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;EURUSD&#39;</span><span class="p">:</span> <span class="mf">1.0850</span><span class="p">,</span>
        <span class="s1">&#39;GBPUSD&#39;</span><span class="p">:</span> <span class="mf">1.2650</span><span class="p">,</span>
        <span class="s1">&#39;USDJPY&#39;</span><span class="p">:</span> <span class="mf">149.50</span>
    <span class="p">}</span>
    
    <span class="n">price</span> <span class="o">=</span> <span class="n">start_prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    
    <span class="n">candles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
            <span class="c1"># Generate hourly candle</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">day</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">hour</span><span class="p">)</span>
            
            <span class="c1"># Random walk with slight trend</span>
            <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.001</span> <span class="o">+</span> <span class="mf">0.00002</span>  <span class="c1"># Slight upward bias</span>
            
            <span class="n">open_price</span> <span class="o">=</span> <span class="n">price</span>
            <span class="n">close_price</span> <span class="o">=</span> <span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span>
            <span class="n">high_price</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">open_price</span><span class="p">,</span> <span class="n">close_price</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.0005</span><span class="p">))</span>
            <span class="n">low_price</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">open_price</span><span class="p">,</span> <span class="n">close_price</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.0005</span><span class="p">))</span>
            
            <span class="n">candle</span> <span class="o">=</span> <span class="n">OHLC</span><span class="p">(</span>
                <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                <span class="n">timeframe</span><span class="o">=</span><span class="s1">&#39;H1&#39;</span><span class="p">,</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                <span class="nb">open</span><span class="o">=</span><span class="n">open_price</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="n">high_price</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="n">low_price</span><span class="p">,</span>
                <span class="n">close</span><span class="o">=</span><span class="n">close_price</span><span class="p">,</span>
                <span class="n">volume</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">candles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candle</span><span class="p">)</span>
            
            <span class="c1"># Generate tick at candle close</span>
            <span class="n">spread</span> <span class="o">=</span> <span class="mf">0.0002</span>
            <span class="n">tick</span> <span class="o">=</span> <span class="n">Tick</span><span class="p">(</span>
                <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                <span class="n">bid</span><span class="o">=</span><span class="n">close_price</span> <span class="o">-</span> <span class="n">spread</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">ask</span><span class="o">=</span><span class="n">close_price</span> <span class="o">+</span> <span class="n">spread</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span>
            <span class="p">)</span>
            <span class="n">ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
            
            <span class="n">price</span> <span class="o">=</span> <span class="n">close_price</span>
            
    <span class="k">return</span> <span class="n">candles</span><span class="p">,</span> <span class="n">ticks</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Configure and run the trading system</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;initial_balance&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="s1">&#39;leverage&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="s1">&#39;risk_per_trade&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>
    <span class="s1">&#39;max_daily_loss&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="s1">&#39;max_positions&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;instruments&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;EURUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;GBPUSD&#39;</span><span class="p">,</span> <span class="s1">&#39;USDJPY&#39;</span><span class="p">],</span>
    <span class="s1">&#39;timeframe&#39;</span><span class="p">:</span> <span class="s1">&#39;H1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;min_signal_strength&#39;</span><span class="p">:</span> <span class="mf">0.6</span>
<span class="p">}</span>

<span class="c1"># Create trading engine</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">TradingEngine</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">performance</span> <span class="o">=</span> <span class="n">PerformanceTracker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># Generate sample data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating sample data...&quot;</span><span class="p">)</span>
<span class="n">all_candles</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">all_ticks</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;instruments&#39;</span><span class="p">]:</span>
    <span class="n">candles</span><span class="p">,</span> <span class="n">ticks</span> <span class="o">=</span> <span class="n">generate_sample_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">all_candles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">candles</span><span class="p">)</span>
    <span class="n">all_ticks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>

<span class="c1"># Sort by timestamp</span>
<span class="n">all_candles</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
<span class="n">all_ticks</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_candles</span><span class="p">)</span><span class="si">}</span><span class="s2"> candles and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_ticks</span><span class="p">)</span><span class="si">}</span><span class="s2"> ticks&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Run backtest</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running backtest...&quot;</span><span class="p">)</span>
<span class="n">engine</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">candle</span><span class="p">,</span> <span class="n">tick</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_candles</span><span class="p">,</span> <span class="n">all_ticks</span><span class="p">)):</span>
    <span class="c1"># Process tick</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">on_tick</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
    
    <span class="c1"># Process candle close</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">on_candle_close</span><span class="p">(</span><span class="n">candle</span><span class="p">)</span>
    
    <span class="c1"># Progress update</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_candles</span><span class="p">)</span><span class="si">}</span><span class="s2"> candles, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Signals: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;signals_generated&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Trades: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;trades_executed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;Balance: $</span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;account&#39;</span><span class="p">][</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">engine</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Backtest complete!&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Generate performance report</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">performance</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">ðŸ“‹</button><pre><code><span class="c1"># Plot equity curve</span>
<span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">trade_history</span><span class="p">:</span>
    <span class="n">equity_curve</span> <span class="o">=</span> <span class="p">[</span><span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">initial_balance</span><span class="p">]</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">trade_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">entry_time</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">trade_history</span><span class="p">:</span>
        <span class="n">equity_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">equity_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">trade</span><span class="o">.</span><span class="n">pnl</span><span class="p">)</span>
        <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="o">.</span><span class="n">exit_time</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">initial_balance</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">initial_balance</span><span class="p">,</span> 
                     <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="n">e</span> <span class="o">&gt;=</span> <span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">initial_balance</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">equity_curve</span><span class="p">],</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">equity_curve</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">initial_balance</span><span class="p">,</span>
                     <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="n">e</span> <span class="o">&lt;</span> <span class="n">engine</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">initial_balance</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">equity_curve</span><span class="p">],</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Trading System Equity Curve&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Equity ($)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No trades to plot&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Capstone Completion Checklist</h2>
<p>Ensure your system includes:</p>
<h3>Core Components</h3>
<ul>
<li>[ ] Market data management (ticks and candles)</li>
<li>[ ] Simulated broker with realistic execution</li>
<li>[ ] Position and order management</li>
<li>[ ] Multiple instrument support</li>
</ul>
<h3>Signal Generation</h3>
<ul>
<li>[ ] At least 2 technical strategies</li>
<li>[ ] Economic calendar integration</li>
<li>[ ] Signal strength filtering</li>
</ul>
<h3>Risk Management</h3>
<ul>
<li>[ ] Position sizing based on risk</li>
<li>[ ] Daily loss limits</li>
<li>[ ] Maximum position limits</li>
<li>[ ] Correlation monitoring</li>
</ul>
<h3>Performance Tracking</h3>
<ul>
<li>[ ] Trade history logging</li>
<li>[ ] Performance statistics</li>
<li>[ ] Equity curve tracking</li>
<li>[ ] Automated reporting</li>
</ul>
<h3>Documentation</h3>
<ul>
<li>[ ] Code comments</li>
<li>[ ] Configuration documentation</li>
<li>[ ] Usage examples</li>
</ul>
<hr />
<h2>Congratulations!</h2>
<p>You have completed the Forex &amp; Futures Trading course capstone project. You now have a complete, production-ready trading system framework that demonstrates:</p>
<ul>
<li>Understanding of forex and futures markets</li>
<li>Technical and fundamental analysis integration</li>
<li>Professional risk management practices</li>
<li>Software engineering skills for trading systems</li>
</ul>
<p><strong>Next Steps:</strong>
1. Extend with additional strategies
2. Connect to live broker APIs (OANDA, MT5)
3. Add machine learning signal filters
4. Implement real-time alerting
5. Deploy on cloud infrastructure</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">â† Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next â†’</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
    </main>

    <script>
        window.courseId = 'course5_forex_futures';
        
// State
let currentModule = 0;
const modules = document.querySelectorAll('.module-section');
const sidebarItems = document.querySelectorAll('.sidebar-item');
const sidebar = document.querySelector('.sidebar');
const overlay = document.querySelector('.sidebar-overlay');
const headerModule = document.querySelector('.header-module');

function showModule(idx) {
    if (idx < 0 || idx >= modules.length) return;

    // Hide all, show target
    modules.forEach(m => m.classList.remove('active'));
    modules[idx].classList.add('active');

    // Update sidebar active state
    sidebarItems.forEach(s => s.classList.remove('active'));
    sidebarItems[idx].classList.add('active');

    // Update header
    const label = sidebarItems[idx].textContent.trim();
    if (headerModule) headerModule.textContent = label;

    // Update prev/next buttons
    updateNavButtons(idx);

    // Save & scroll
    currentModule = idx;
    try { localStorage.setItem(window.courseId + '_module', idx); } catch(e) {}
    window.scrollTo(0, 0);

    // Close sidebar on mobile
    closeSidebar();
}

function updateNavButtons(idx) {
    const section = modules[idx];
    const prevBtn = section.querySelector('.prev-btn');
    const nextBtn = section.querySelector('.next-btn');

    if (prevBtn) {
        // Clone to remove old listeners
        const newPrev = prevBtn.cloneNode(true);
        prevBtn.parentNode.replaceChild(newPrev, prevBtn);
        if (idx === 0) {
            newPrev.classList.add('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = '';
        } else {
            newPrev.classList.remove('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = sidebarItems[idx - 1].textContent.trim();
            newPrev.addEventListener('click', () => showModule(idx - 1));
        }
    }
    if (nextBtn) {
        const newNext = nextBtn.cloneNode(true);
        nextBtn.parentNode.replaceChild(newNext, nextBtn);
        if (idx === modules.length - 1) {
            newNext.classList.add('disabled');
            newNext.querySelector('.nav-btn-name').textContent = '';
        } else {
            newNext.classList.remove('disabled');
            newNext.querySelector('.nav-btn-name').textContent = sidebarItems[idx + 1].textContent.trim();
            newNext.addEventListener('click', () => showModule(idx + 1));
        }
    }
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('open');
}

// Copy code button
function copyCode(btn) {
    const code = btn.parentElement.querySelector('pre code');
    const text = code.textContent;
    navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'âœ“';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = 'ðŸ“‹';
            btn.classList.remove('copied');
        }, 1500);
    }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        btn.textContent = 'âœ“';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = 'ðŸ“‹';
            btn.classList.remove('copied');
        }, 1500);
    });
}

// Init: bind sidebar items
sidebarItems.forEach((item, idx) => {
    item.addEventListener('click', () => showModule(idx));
});

// Restore last viewed module
document.addEventListener('DOMContentLoaded', () => {
    let saved = 0;
    try { saved = parseInt(localStorage.getItem(window.courseId + '_module')) || 0; } catch(e) {}
    if (saved >= 0 && saved < modules.length) {
        showModule(saved);
    } else {
        showModule(0);
    }
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' && currentModule > 0) showModule(currentModule - 1);
    if (e.key === 'ArrowRight' && currentModule < modules.length - 1) showModule(currentModule + 1);
    if (e.key === 'Escape') closeSidebar();
});

    </script>
</body>
</html>