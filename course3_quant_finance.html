<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Quantitative Finance ‚Äî FinQT</title>
    <style>
/* === Reset & Base === */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --bg: #0a0a0a;
    --bg-secondary: #111111;
    --bg-sidebar: #0d0d0d;
    --text: #e0e0e0;
    --text-dim: #888888;
    --green: #00c853;
    --green-dim: #1b5e20;
    --green-glow: rgba(0, 200, 83, 0.15);
    --code-bg: #141420;
    --border: #1e1e1e;
    --header-height: 52px;
}

html {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.65;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
}

/* === Header === */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    z-index: 1000;
    gap: 12px;
}

.hamburger {
    background: none;
    border: none;
    color: var(--text);
    font-size: 22px;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    line-height: 1;
    flex-shrink: 0;
}
.hamburger:hover {
    background: rgba(255,255,255,0.08);
}

.header-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--green);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.header-module {
    font-size: 13px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-left: auto;
}

/* === Sidebar === */
.sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1001;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}
.sidebar-overlay.open {
    opacity: 1;
    pointer-events: auto;
}

.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 280px;
    max-width: 85vw;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    z-index: 1002;
    transform: translateX(-100%);
    transition: transform 0.25s ease;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 12px;
    padding-bottom: 24px;
}
.sidebar.open {
    transform: translateX(0);
}

.sidebar-header {
    padding: 12px 16px 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
}
.sidebar-header h2 {
    font-size: 15px;
    color: var(--green);
    font-weight: 600;
}

.sidebar-part {
    padding: 10px 16px 4px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.6px;
}

.sidebar-item {
    display: block;
    padding: 8px 16px 8px 24px;
    font-size: 13px;
    color: var(--text);
    text-decoration: none;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.15s;
}
.sidebar-item:hover {
    background: rgba(255,255,255,0.04);
}
.sidebar-item.active {
    color: var(--green);
    border-left-color: var(--green);
    background: var(--green-glow);
    font-weight: 600;
}

/* === Main Content === */
.main {
    margin-top: var(--header-height);
    padding: 20px 16px 80px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.module-section {
    display: none;
}
.module-section.active {
    display: block;
}

/* === Typography === */
.md-cell h1 {
    font-size: 1.7rem;
    font-weight: 700;
    color: var(--green);
    margin: 1.5em 0 0.5em;
    line-height: 1.25;
}
.md-cell h2 {
    font-size: 1.35rem;
    font-weight: 600;
    color: var(--green);
    margin: 1.4em 0 0.4em;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
}
.md-cell h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #cccccc;
    margin: 1.2em 0 0.3em;
}
.md-cell h4, .md-cell h5, .md-cell h6 {
    font-size: 1rem;
    font-weight: 600;
    color: #bbbbbb;
    margin: 1em 0 0.3em;
}

.md-cell p {
    margin: 0.6em 0;
}

.md-cell a {
    color: var(--green);
    text-decoration: none;
}
.md-cell a:hover {
    text-decoration: underline;
}

.md-cell strong {
    color: #f0f0f0;
}

.md-cell ul, .md-cell ol {
    margin: 0.5em 0;
    padding-left: 1.5em;
}
.md-cell li {
    margin: 0.25em 0;
}

.md-cell hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.5em 0;
}

.md-cell blockquote {
    border-left: 3px solid var(--green-dim);
    padding: 0.5em 1em;
    margin: 0.8em 0;
    color: var(--text-dim);
    background: rgba(255,255,255,0.02);
    border-radius: 0 6px 6px 0;
}

/* Inline code (not inside pre blocks) */
.md-cell code {
    background: rgba(255,255,255,0.08);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.88em;
    color: #e8e8e8;
}
.md-cell pre code {
    background: transparent !important;
    padding: 0;
    border-radius: 0;
    color: inherit;
}

/* Fenced code blocks inside markdown */
.md-cell pre {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    overflow-x: auto;
    margin: 0.8em 0;
    -webkit-overflow-scrolling: touch;
}
.md-cell pre code {
    background: none;
    padding: 0;
    border-radius: 0;
    font-size: 0.85rem;
    line-height: 1.5;
    color: #e8e8e8;
}

/* === Module Header (first cell) === */
.module-header {
    padding-bottom: 0.5em;
    margin-bottom: 0.5em;
}
.module-header h1 {
    font-size: 1.8rem;
    margin-top: 0;
}

/* === Tables === */
.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0.8em 0;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.md-cell table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
}
.md-cell th {
    background: var(--bg-secondary);
    color: var(--green);
    font-weight: 600;
    text-align: left;
    padding: 10px 12px;
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
}
.md-cell td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
}
.md-cell tr:last-child td {
    border-bottom: none;
}

/* === Code Cells === */
.code-cell {
    position: relative;
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin: 0.6em 0;
    overflow: hidden;
}
.code-cell pre {
    margin: 0;
    padding: 14px 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.code-cell pre code {
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.82rem;
    line-height: 1.55;
    background: transparent !important;
    padding: 0;
    border-radius: 0;
}

.copy-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(255,255,255,0.08);
    border: none;
    border-radius: 4px;
    padding: 4px 7px;
    font-size: 13px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 5;
}
.code-cell:hover .copy-btn {
    opacity: 1;
}
.copy-btn:hover {
    background: rgba(255,255,255,0.15);
}
.copy-btn.copied {
    opacity: 1;
}

/* === Exercise Styling === */
.exercise-header {
    background: rgba(0, 200, 83, 0.04);
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 12px 16px;
    margin: 1em 0 0.3em;
}
.exercise-header h3 {
    color: var(--green);
    margin-top: 0;
}

.exercise-code {
    border-color: var(--green-dim);
}

/* === Solution (details) blocks === */
.solution-block details {
    border-left: 3px solid var(--green);
    border-radius: 0 8px 8px 0;
    margin: 0.5em 0 1em;
    background: rgba(0, 200, 83, 0.03);
}
.solution-block summary {
    padding: 10px 14px;
    cursor: pointer;
    color: var(--green);
    font-weight: 600;
    font-size: 0.9rem;
    user-select: none;
    -webkit-user-select: none;
}
.solution-block summary:hover {
    background: rgba(0, 200, 83, 0.06);
}
.solution-block details[open] summary {
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
}
.solution-block details > :not(summary) {
    padding: 0 14px;
}
.solution-block details pre {
    margin: 10px 0;
}

/* === Module Project === */
.module-project {
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
    background: rgba(0, 200, 83, 0.03);
}
.module-project h1 {
    font-size: 1.4rem;
}

/* === Key Takeaways === */
.key-takeaways {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
}
.key-takeaways h1 {
    font-size: 1.3rem;
    margin-top: 0;
}

/* === Prev/Next Navigation === */
.nav-buttons {
    display: flex;
    gap: 12px;
    margin-top: 2em;
    padding-top: 1.5em;
    border-top: 1px solid var(--border);
}
.nav-btn {
    flex: 1;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: inherit;
    font-size: 0.9rem;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
    text-decoration: none;
    -webkit-appearance: none;
    -webkit-tap-highlight-color: rgba(0, 200, 83, 0.2);
}
.nav-btn:hover {
    border-color: var(--green);
    color: var(--green);
}
.nav-btn.disabled {
    opacity: 0.3;
    pointer-events: none;
}
.nav-btn-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-bottom: 2px;
}

/* === Syntax Highlighting (Pygments Monokai) === */
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.code-cell pre code .hll { background-color: #49483e }
.code-cell pre code { background: #272822; color: #f8f8f2 }
.code-cell pre code .c { color: #75715e } /* Comment */
.code-cell pre code .err { color: #960050; background-color: #1e0010 } /* Error */
.code-cell pre code .esc { color: #f8f8f2 } /* Escape */
.code-cell pre code .g { color: #f8f8f2 } /* Generic */
.code-cell pre code .k { color: #66d9ef } /* Keyword */
.code-cell pre code .l { color: #ae81ff } /* Literal */
.code-cell pre code .n { color: #f8f8f2 } /* Name */
.code-cell pre code .o { color: #f92672 } /* Operator */
.code-cell pre code .x { color: #f8f8f2 } /* Other */
.code-cell pre code .p { color: #f8f8f2 } /* Punctuation */
.code-cell pre code .ch { color: #75715e } /* Comment.Hashbang */
.code-cell pre code .cm { color: #75715e } /* Comment.Multiline */
.code-cell pre code .cp { color: #75715e } /* Comment.Preproc */
.code-cell pre code .cpf { color: #75715e } /* Comment.PreprocFile */
.code-cell pre code .c1 { color: #75715e } /* Comment.Single */
.code-cell pre code .cs { color: #75715e } /* Comment.Special */
.code-cell pre code .gd { color: #f92672 } /* Generic.Deleted */
.code-cell pre code .ge { color: #f8f8f2; font-style: italic } /* Generic.Emph */
.code-cell pre code .gr { color: #f8f8f2 } /* Generic.Error */
.code-cell pre code .gh { color: #f8f8f2 } /* Generic.Heading */
.code-cell pre code .gi { color: #a6e22e } /* Generic.Inserted */
.code-cell pre code .go { color: #66d9ef } /* Generic.Output */
.code-cell pre code .gp { color: #f92672; font-weight: bold } /* Generic.Prompt */
.code-cell pre code .gs { color: #f8f8f2; font-weight: bold } /* Generic.Strong */
.code-cell pre code .gu { color: #75715e } /* Generic.Subheading */
.code-cell pre code .gt { color: #f8f8f2 } /* Generic.Traceback */
.code-cell pre code .kc { color: #66d9ef } /* Keyword.Constant */
.code-cell pre code .kd { color: #66d9ef } /* Keyword.Declaration */
.code-cell pre code .kn { color: #f92672 } /* Keyword.Namespace */
.code-cell pre code .kp { color: #66d9ef } /* Keyword.Pseudo */
.code-cell pre code .kr { color: #66d9ef } /* Keyword.Reserved */
.code-cell pre code .kt { color: #66d9ef } /* Keyword.Type */
.code-cell pre code .ld { color: #e6db74 } /* Literal.Date */
.code-cell pre code .m { color: #ae81ff } /* Literal.Number */
.code-cell pre code .s { color: #e6db74 } /* Literal.String */
.code-cell pre code .na { color: #a6e22e } /* Name.Attribute */
.code-cell pre code .nb { color: #f8f8f2 } /* Name.Builtin */
.code-cell pre code .nc { color: #a6e22e } /* Name.Class */
.code-cell pre code .no { color: #66d9ef } /* Name.Constant */
.code-cell pre code .nd { color: #a6e22e } /* Name.Decorator */
.code-cell pre code .ni { color: #f8f8f2 } /* Name.Entity */
.code-cell pre code .ne { color: #a6e22e } /* Name.Exception */
.code-cell pre code .nf { color: #a6e22e } /* Name.Function */
.code-cell pre code .nl { color: #f8f8f2 } /* Name.Label */
.code-cell pre code .nn { color: #f8f8f2 } /* Name.Namespace */
.code-cell pre code .nx { color: #a6e22e } /* Name.Other */
.code-cell pre code .py { color: #f8f8f2 } /* Name.Property */
.code-cell pre code .nt { color: #f92672 } /* Name.Tag */
.code-cell pre code .nv { color: #f8f8f2 } /* Name.Variable */
.code-cell pre code .ow { color: #f92672 } /* Operator.Word */
.code-cell pre code .w { color: #f8f8f2 } /* Text.Whitespace */
.code-cell pre code .mb { color: #ae81ff } /* Literal.Number.Bin */
.code-cell pre code .mf { color: #ae81ff } /* Literal.Number.Float */
.code-cell pre code .mh { color: #ae81ff } /* Literal.Number.Hex */
.code-cell pre code .mi { color: #ae81ff } /* Literal.Number.Integer */
.code-cell pre code .mo { color: #ae81ff } /* Literal.Number.Oct */
.code-cell pre code .sa { color: #e6db74 } /* Literal.String.Affix */
.code-cell pre code .sb { color: #e6db74 } /* Literal.String.Backtick */
.code-cell pre code .sc { color: #e6db74 } /* Literal.String.Char */
.code-cell pre code .dl { color: #e6db74 } /* Literal.String.Delimiter */
.code-cell pre code .sd { color: #e6db74 } /* Literal.String.Doc */
.code-cell pre code .s2 { color: #e6db74 } /* Literal.String.Double */
.code-cell pre code .se { color: #ae81ff } /* Literal.String.Escape */
.code-cell pre code .sh { color: #e6db74 } /* Literal.String.Heredoc */
.code-cell pre code .si { color: #e6db74 } /* Literal.String.Interpol */
.code-cell pre code .sx { color: #e6db74 } /* Literal.String.Other */
.code-cell pre code .sr { color: #e6db74 } /* Literal.String.Regex */
.code-cell pre code .s1 { color: #e6db74 } /* Literal.String.Single */
.code-cell pre code .ss { color: #e6db74 } /* Literal.String.Symbol */
.code-cell pre code .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
.code-cell pre code .fm { color: #a6e22e } /* Name.Function.Magic */
.code-cell pre code .vc { color: #f8f8f2 } /* Name.Variable.Class */
.code-cell pre code .vg { color: #f8f8f2 } /* Name.Variable.Global */
.code-cell pre code .vi { color: #f8f8f2 } /* Name.Variable.Instance */
.code-cell pre code .vm { color: #f8f8f2 } /* Name.Variable.Magic */
.code-cell pre code .il { color: #ae81ff } /* Literal.Number.Integer.Long */

/* === Responsive === */
@media (min-width: 1024px) {
    .sidebar {
        transform: translateX(0);
        top: var(--header-height);
        padding-top: 8px;
        border-top: none;
    }
    .sidebar-overlay {
        display: none;
    }
    .main {
        margin-left: 296px;
    }
    .hamburger {
        display: none;
    }
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}
::-webkit-scrollbar-track {
    background: transparent;
}
::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.15);
    border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.25);
}
</style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">‚ò∞</button>
        <span class="header-title">Quantitative Finance</span>
        <span class="header-module"></span>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>Quantitative Finance</h2>
        </div>
        <div class="sidebar-part">Overview</div>
<div class="sidebar-item">Course Overview</div>
<div class="sidebar-part">Part 1: Statistical Foundations</div>
<div class="sidebar-item">Module 1: Statistics for Finance</div>
<div class="sidebar-item">Module 2: Return Analysis</div>
<div class="sidebar-item">Module 3: Time Series Analysis</div>
<div class="sidebar-part">Part 2: Portfolio Theory</div>
<div class="sidebar-item">Module 4: Modern Portfolio Theory</div>
<div class="sidebar-item">Module 5: Mean-Variance Optimization</div>
<div class="sidebar-item">Module 6: Advanced Portfolio Techniques</div>
<div class="sidebar-part">Part 3: Risk Modeling</div>
<div class="sidebar-item">Module 7: Value at Risk (VaR)</div>
<div class="sidebar-item">Module 8: Beyond VaR</div>
<div class="sidebar-item">Module 9: Factor Models</div>
<div class="sidebar-part">Part 4: Simulation &amp; Analytics</div>
<div class="sidebar-item">Module 10: Monte Carlo Simulation</div>
<div class="sidebar-item">Module 11: Performance Attribution</div>
<div class="sidebar-item">Module 12: Building Dashboards</div>
<div class="sidebar-part">Part 5: Production &amp; Infrastructure</div>
<div class="sidebar-item">Module 13: Professional Reporting</div>
<div class="sidebar-item">Module 14: Rebalancing &amp; Execution</div>
<div class="sidebar-item">Module 15: Market Microstructure</div>
<div class="sidebar-item">Module 16: High-Frequency Concepts</div>
<div class="sidebar-item">Module 17: Cloud Deployment</div>
<div class="sidebar-item">Module 18: 24/7 Operation</div>
<div class="sidebar-part">Capstone</div>
<div class="sidebar-item">Capstone Project</div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="module-section active" data-idx="0"><div class="md-cell module-header"><h1>Course 3: Quantitative Finance &amp; Portfolio Theory</h1>
<p><strong>Welcome to the Quantitative Finance course!</strong></p>
<p>In this course, you'll master the mathematical foundations that power institutional trading systems, from statistical analysis to portfolio optimization and risk management.</p>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Modules</strong></td>
<td>18</td>
</tr>
<tr>
<td><strong>Duration</strong></td>
<td>~45 hours</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>108</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Course 0 (Python for Finance)</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>What You'll Build</h2>
<p>By the end of this course, you'll have built:</p>
<ol>
<li><strong>Statistical Analysis Tools</strong> - Analyze financial returns and fit distributions</li>
<li><strong>Portfolio Optimizer</strong> - Construct efficient portfolios using mean-variance optimization</li>
<li><strong>Risk Management System</strong> - Calculate VaR, CVaR, and stress test portfolios</li>
<li><strong>Monte Carlo Simulator</strong> - Simulate thousands of portfolio paths</li>
<li><strong>Performance Dashboard</strong> - Interactive analytics and attribution</li>
<li><strong>Production System</strong> - Deployed, monitored quantitative infrastructure</li>
</ol>
<p>The <strong>Capstone Project</strong> integrates all these into a complete portfolio management system.</p></div>
<div class="md-cell"><h2>Course Structure</h2>
<div class="highlight"><pre><span></span><code>Part 1: Statistical Foundations (Modules 1-3)
    ‚îî‚îÄ‚îÄ Statistics, Returns, Time Series
              ‚îÇ
              ‚ñº
Part 2: Portfolio Theory (Modules 4-6)
    ‚îî‚îÄ‚îÄ Basics, Optimization, Advanced Techniques
              ‚îÇ
              ‚ñº
Part 3: Risk Modeling (Modules 7-9)
    ‚îî‚îÄ‚îÄ VaR, Beyond VaR, Factor Models
              ‚îÇ
              ‚ñº
Part 4: Simulation &amp; Analytics (Modules 10-12)
    ‚îî‚îÄ‚îÄ Monte Carlo, Attribution, Dashboards
              ‚îÇ
              ‚ñº
Part 5: Production &amp; Infrastructure (Modules 13-18)
    ‚îî‚îÄ‚îÄ Reporting, Execution, Microstructure, HFT, Cloud, Operations
              ‚îÇ
              ‚ñº
        CAPSTONE PROJECT
</code></pre></div></div>
<div class="md-cell"><h2>Module Overview</h2>
<h3>Part 1: Statistical Foundations</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Concepts</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Statistics for Finance</td>
<td>Descriptive stats, probability distributions, hypothesis testing, correlation</td>
</tr>
<tr>
<td>2</td>
<td>Return Analysis</td>
<td>Simple vs log returns, annualization, Sharpe ratio, drawdowns</td>
</tr>
<tr>
<td>3</td>
<td>Time Series Analysis</td>
<td>Stationarity, autocorrelation, ARIMA, volatility clustering</td>
</tr>
</tbody>
</table></div>
<h3>Part 2: Portfolio Theory</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Concepts</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>Portfolio Basics</td>
<td>Risk/return tradeoff, diversification, efficient frontier</td>
</tr>
<tr>
<td>5</td>
<td>Portfolio Optimization</td>
<td>Mean-variance, Maximum Sharpe, Minimum Variance, constraints</td>
</tr>
<tr>
<td>6</td>
<td>Advanced Techniques</td>
<td>Risk parity, Black-Litterman, robust optimization</td>
</tr>
</tbody>
</table></div>
<h3>Part 3: Risk Modeling</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Concepts</th>
</tr>
</thead>
<tbody>
<tr>
<td>7</td>
<td>Value at Risk</td>
<td>Historical VaR, parametric VaR, Monte Carlo VaR</td>
</tr>
<tr>
<td>8</td>
<td>Beyond VaR</td>
<td>CVaR/Expected Shortfall, drawdown analysis, stress testing</td>
</tr>
<tr>
<td>9</td>
<td>Factor Models</td>
<td>CAPM, Fama-French, PCA-based factors, factor attribution</td>
</tr>
</tbody>
</table></div>
<h3>Part 4: Simulation &amp; Analytics</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Concepts</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>Monte Carlo Simulation</td>
<td>GBM, correlated assets, option pricing, portfolio simulation</td>
</tr>
<tr>
<td>11</td>
<td>Performance Attribution</td>
<td>Brinson attribution, factor attribution, contribution analysis</td>
</tr>
<tr>
<td>12</td>
<td>Building Dashboards</td>
<td>Plotly, real-time metrics, interactive visualizations</td>
</tr>
</tbody>
</table></div>
<h3>Part 5: Production &amp; Infrastructure</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Key Concepts</th>
</tr>
</thead>
<tbody>
<tr>
<td>13</td>
<td>Professional Reporting</td>
<td>Automated reports, PDF generation, scheduling</td>
</tr>
<tr>
<td>14</td>
<td>Rebalancing &amp; Execution</td>
<td>Calendar/threshold rebalancing, transaction costs, tax-loss harvesting</td>
</tr>
<tr>
<td>15</td>
<td>Market Microstructure</td>
<td>Order books, bid-ask spread, price impact, optimal execution</td>
</tr>
<tr>
<td>16</td>
<td>High-Frequency Concepts</td>
<td>Latency, co-location, HFT strategies, regulations</td>
</tr>
<tr>
<td>17</td>
<td>Cloud Deployment</td>
<td>AWS/GCP, Docker, serverless, CI/CD</td>
</tr>
<tr>
<td>18</td>
<td>24/7 Operation</td>
<td>Monitoring, alerting, incident response, backup/recovery</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Prerequisites Check</h2>
<p>Before starting, ensure you can run the following code without errors:</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Prerequisites Check</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Python version: </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Core libraries</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Finance libraries</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span><span class="p">,</span> <span class="n">optimize</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">All prerequisites installed!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NumPy: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pandas: </span><span class="si">{</span><span class="n">pd</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Quick test: Download sample data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Testing data download...&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s1">&#39;1mo&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> days of SPY data&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You&#39;re ready to start Course 3!&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>How to Use This Course</h2>
<h3>Learning Approach</h3>
<ol>
<li><strong>Read the concepts</strong> - Understand the theory before coding</li>
<li><strong>Run the examples</strong> - Execute all code cells to see results</li>
<li><strong>Do the exercises</strong> - Practice with guided and open-ended problems</li>
<li><strong>Check solutions</strong> - Compare your approach after attempting</li>
<li><strong>Build the project</strong> - Apply everything in the module project</li>
</ol>
<h3>Exercise Format</h3>
<p>Each module has 6 exercises:
- <strong>3 Guided exercises</strong> - Fill in the blanks with hints provided
- <strong>3 Open-ended exercises</strong> - Build complete solutions from scratch</p>
<p>Solutions are provided in collapsible sections - try first before peeking!</p>
<h3>Time Commitment</h3>
<ul>
<li>Each module: ~2.5 hours</li>
<li>Recommended pace: 1-2 modules per session</li>
<li>Total course: ~45 hours</li>
</ul></div>
<div class="md-cell"><h2>Let's Begin!</h2>
<p>Start with <strong>Module 1: Statistics for Finance</strong> ‚Äî good luck on your quantitative finance journey!</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="1"><div class="md-cell module-header"><h1>Module 1: Statistics for Finance</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 1: Statistical Foundations</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Calculate and interpret descriptive statistics for financial returns</li>
<li>Apply probability distributions to model asset prices and returns</li>
<li>Conduct hypothesis tests to validate trading strategies</li>
<li>Compute and analyze correlation and covariance matrices</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Course 0 (Python for Finance)</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-1.1">Section 1.1: Descriptive Statistics</a></li>
<li><a href="#section-1.2">Section 1.2: Probability Distributions</a></li>
<li><a href="#section-1.3">Section 1.3: Hypothesis Testing</a></li>
<li><a href="#section-1.4">Section 1.4: Correlation &amp; Covariance</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Libraries loaded successfully!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Financial Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download stock data</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">]</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2019-01-01&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2024-01-01&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Downloading data for </span><span class="si">{</span><span class="n">tickers</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Handle different yfinance column structures</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data range: </span><span class="si">{</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trading days: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">prices</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-1.1'></a></p>
<h1>Section 1.1: Descriptive Statistics</h1>
<p>Before diving into complex models, we need to understand our data. Descriptive statistics give us a snapshot of what we're working with.</p>
<p><strong>In this section, you will learn:</strong>
- How to measure the "center" of returns (mean, median)
- How to measure the "spread" of returns (variance, std deviation)
- How to measure the "shape" of returns (skewness, kurtosis)</p></div>
<div class="md-cell"><h2>1.1.1 Central Tendency: Mean vs Median</h2>
<p>The <strong>mean</strong> is the average - simple to calculate but sensitive to outliers.</p>
<p>The <strong>median</strong> is the middle value - robust to outliers.</p>
<p><strong>Why does this matter in finance?</strong>
- A few extreme days (like March 2020) can significantly skew the mean
- The median tells you what a "typical" day looks like</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Let&#39;s look at SPY returns</span>
<span class="n">spy_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>

<span class="c1"># Calculate mean and median</span>
<span class="n">mean_ret</span> <span class="o">=</span> <span class="n">spy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">median_ret</span> <span class="o">=</span> <span class="n">spy_returns</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== SPY Daily Returns ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean:   </span><span class="si">{</span><span class="n">mean_ret</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> (annualized: </span><span class="si">{</span><span class="n">mean_ret</span><span class="o">*</span><span class="mi">252</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Median: </span><span class="si">{</span><span class="n">median_ret</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Difference: </span><span class="si">{</span><span class="p">(</span><span class="n">mean_ret</span> <span class="o">-</span> <span class="n">median_ret</span><span class="p">)</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.1.2 Dispersion: Variance &amp; Volatility</h2>
<p>Returns fluctuate. We measure this with:</p>
<ul>
<li><strong>Variance (œÉ¬≤):</strong> Average squared deviation from mean</li>
<li><strong>Standard Deviation (œÉ):</strong> Square root of variance</li>
<li><strong>Volatility:</strong> Annualized std = œÉ √ó ‚àö252</li>
</ul>
<p><strong>The key insight:</strong> Volatility is often used as a proxy for risk.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate volatility for all assets</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Annualized Volatility ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(Higher = more risky)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">daily_std</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">annual_vol</span> <span class="o">=</span> <span class="n">daily_std</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">annual_vol</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.1.3 Shape: Skewness &amp; Kurtosis</h2>
<p>Beyond center and spread, the <em>shape</em> of returns matters enormously.</p>
<p><strong>Skewness</strong> measures asymmetry:
- Negative skew = More extreme losses than gains (bad for investors!)
- Positive skew = More extreme gains than losses
- Zero skew = Symmetric distribution</p>
<p><strong>Kurtosis</strong> measures "tail thickness":
- High kurtosis (&gt;0) = Fat tails = More extreme events than expected
- Zero kurtosis = Normal distribution tails
- Negative kurtosis = Thin tails</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate skewness and kurtosis</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Return Distribution Shape ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Asset&quot;</span><span class="si">:</span><span class="s1">&lt;6</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Skewness&quot;</span><span class="si">:</span><span class="s1">&gt;10</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Kurtosis&quot;</span><span class="si">:</span><span class="s1">&gt;10</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">28</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">skew</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>
    <span class="n">kurt</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s1">&lt;6</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">skew</span><span class="si">:</span><span class="s1">&gt;10.2f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">kurt</span><span class="si">:</span><span class="s1">&gt;10.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>Visualizing Return Distributions</h3></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize SPY return distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Histogram with normal overlay</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> 
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual SPY&#39;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">spy_returns</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">spy_returns</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean_ret</span><span class="p">,</span> <span class="n">spy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()),</span> 
         <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Normal Distribution&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Return&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY Returns vs Normal Distribution&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># QQ-plot</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot: Are Returns Normal?&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 1.1: Calculate Descriptive Statistics (Guided)</h3>
<p><strong>Your Task:</strong> Complete the function to calculate key statistics for a return series.</p>
<p>Fill in the blanks to calculate mean, volatility, skewness, and kurtosis:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.1: Calculate Descriptive Statistics (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_return_stats</span><span class="p">(</span><span class="n">returns_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate descriptive statistics for a return series.&quot;&quot;&quot;</span>
    
    <span class="c1"># TODO: Calculate mean daily return</span>
    <span class="n">mean_daily</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># TODO: Calculate annualized volatility (daily std * sqrt(252))</span>
    <span class="n">volatility</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate skewness</span>
    <span class="n">skewness</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># TODO: Calculate kurtosis</span>
    <span class="n">kurtosis</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean_daily&#39;</span><span class="p">:</span> <span class="n">mean_daily</span><span class="p">,</span>
        <span class="s1">&#39;mean_annual&#39;</span><span class="p">:</span> <span class="n">mean_daily</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
        <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">volatility</span><span class="p">,</span>
        <span class="s1">&#39;skewness&#39;</span><span class="p">:</span> <span class="n">skewness</span><span class="p">,</span>
        <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="n">kurtosis</span>
    <span class="p">}</span>

<span class="c1"># Test your function</span>
<span class="c1"># result = calculate_return_stats(returns[&#39;SPY&#39;])</span>
<span class="c1"># print(result)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_return_stats</span><span class="p">(</span><span class="n">returns_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate descriptive statistics for a return series.&quot;&quot;&quot;</span>
    <span class="n">mean_daily</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">volatility</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">skewness</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>
    <span class="n">kurtosis</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean_daily&#39;</span><span class="p">:</span> <span class="n">mean_daily</span><span class="p">,</span>
        <span class="s1">&#39;mean_annual&#39;</span><span class="p">:</span> <span class="n">mean_daily</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
        <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">volatility</span><span class="p">,</span>
        <span class="s1">&#39;skewness&#39;</span><span class="p">:</span> <span class="n">skewness</span><span class="p">,</span>
        <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="n">kurtosis</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_return_stats</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPY Annual Return: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;mean_annual&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPY Volatility: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-1.2'></a></p>
<h1>Section 1.2: Probability Distributions</h1>
<p>Now that we understand our data's shape, let's formalize it with probability distributions.</p>
<p><strong>In this section, you will learn:</strong>
- Why the Normal distribution is useful (and where it fails)
- How the Student's t-distribution handles fat tails
- How to test if your data follows a specific distribution</p></div>
<div class="md-cell"><h2>1.2.1 The Normal Distribution</h2>
<p>Despite its limitations, the Normal distribution is foundational:</p>
<ul>
<li><strong>Parameters:</strong> mean (Œº) and standard deviation (œÉ)</li>
<li><strong>Properties:</strong> 68-95-99.7 rule</li>
<li><strong>Use cases:</strong> Central Limit Theorem, log returns over long periods</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># How often do extreme events occur under a Normal distribution?</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Probability of Extreme Events (Normal Distribution) ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">spy_std</span> <span class="o">=</span> <span class="n">spy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">spy_mean</span> <span class="o">=</span> <span class="n">spy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">for</span> <span class="n">sigma</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>  <span class="c1"># Two-tailed</span>
    <span class="n">expected_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">prob</span><span class="p">)</span> <span class="k">if</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s1">-sigma event: </span><span class="si">{</span><span class="n">prob</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> probability&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   Expected once every </span><span class="si">{</span><span class="n">expected_days</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> trading days (</span><span class="si">{</span><span class="n">expected_days</span><span class="o">/</span><span class="mi">252</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> years)&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Count actual extreme events in SPY</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Actual vs Expected Extreme Events in SPY ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="k">for</span> <span class="n">sigma</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">spy_std</span>
    <span class="n">extreme_days</span> <span class="o">=</span> <span class="n">spy_returns</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">spy_returns</span> <span class="o">-</span> <span class="n">spy_mean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extreme_days</span><span class="p">)</span>
    
    <span class="n">normal_prob</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>
    <span class="n">expected_count</span> <span class="o">=</span> <span class="n">normal_prob</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s1">-sigma events: Actual=</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">, Expected=</span><span class="si">{</span><span class="n">expected_count</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, Ratio=</span><span class="si">{</span><span class="n">count</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">expected_count</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">x&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.2.2 The Student's t-Distribution</h2>
<p>The t-distribution is like the Normal but with <strong>fatter tails</strong>.</p>
<ul>
<li><strong>Key parameter:</strong> degrees of freedom (df or ŒΩ)</li>
<li>Lower df = fatter tails</li>
<li>As df ‚Üí ‚àû, t-distribution ‚Üí Normal distribution</li>
<li>Financial returns typically fit with df = 3 to 8</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare Normal vs t-distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;t (df=3)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;t (df=5)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;t (df=10)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Standard Deviations from Mean&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Probability Density&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Normal vs Student</span><span class="se">\&#39;</span><span class="s1">s t-Distribution&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Notice: Lower degrees of freedom = fatter tails = more extreme events&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Fit t-distribution to SPY returns</span>
<span class="n">df_fit</span><span class="p">,</span> <span class="n">loc_fit</span><span class="p">,</span> <span class="n">scale_fit</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Fitted t-Distribution Parameters ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Degrees of freedom: </span><span class="si">{</span><span class="n">df_fit</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Location (mean):    </span><span class="si">{</span><span class="n">loc_fit</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Scale (std):        </span><span class="si">{</span><span class="n">scale_fit</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Interpretation: df=</span><span class="si">{</span><span class="n">df_fit</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> confirms fat tails in SPY returns&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.2.3 Testing for Normality</h2>
<p><strong>Common tests:</strong>
- <strong>Jarque-Bera test:</strong> Based on skewness and kurtosis
- <strong>Shapiro-Wilk test:</strong> Compares data to Normal quantiles</p>
<p><strong>Interpretation:</strong>
- p-value &lt; 0.05 ‚Üí Reject normality (data is NOT normal)
- p-value ‚â• 0.05 ‚Üí Cannot reject normality</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test for normality</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Normality Tests ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
    <span class="n">jb_stat</span><span class="p">,</span> <span class="n">jb_pval</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">jarque_bera</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="n">is_normal</span> <span class="o">=</span> <span class="s1">&#39;YES&#39;</span> <span class="k">if</span> <span class="n">jb_pval</span> <span class="o">&gt;</span> <span class="mf">0.05</span> <span class="k">else</span> <span class="s1">&#39;NO&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1">: Jarque-Bera p-value=</span><span class="si">{</span><span class="n">jb_pval</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">, Normal? </span><span class="si">{</span><span class="n">is_normal</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 1.2: Fit a t-Distribution (Guided)</h3>
<p><strong>Your Task:</strong> Complete the function to fit a t-distribution and compare it to the Normal.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.2: Fit a t-Distribution (Guided)</span>
<span class="k">def</span> <span class="nf">fit_and_compare_distributions</span><span class="p">(</span><span class="n">returns_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fit Normal and t-distribution, compare the fits.&quot;&quot;&quot;</span>
    
    <span class="c1"># TODO: Calculate Normal distribution parameters</span>
    <span class="n">norm_mean</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    <span class="n">norm_std</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># TODO: Fit t-distribution (returns df, loc, scale)</span>
    <span class="n">t_df</span><span class="p">,</span> <span class="n">t_loc</span><span class="p">,</span> <span class="n">t_scale</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">______</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">returns_series</span><span class="p">)</span>
    
    <span class="c1"># TODO: Run Jarque-Bera normality test</span>
    <span class="n">jb_stat</span><span class="p">,</span> <span class="n">jb_pval</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">returns_series</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;norm_mean&#39;</span><span class="p">:</span> <span class="n">norm_mean</span><span class="p">,</span>
        <span class="s1">&#39;norm_std&#39;</span><span class="p">:</span> <span class="n">norm_std</span><span class="p">,</span>
        <span class="s1">&#39;t_df&#39;</span><span class="p">:</span> <span class="n">t_df</span><span class="p">,</span>
        <span class="s1">&#39;t_loc&#39;</span><span class="p">:</span> <span class="n">t_loc</span><span class="p">,</span>
        <span class="s1">&#39;t_scale&#39;</span><span class="p">:</span> <span class="n">t_scale</span><span class="p">,</span>
        <span class="s1">&#39;is_normal&#39;</span><span class="p">:</span> <span class="n">jb_pval</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="s1">&#39;jb_pval&#39;</span><span class="p">:</span> <span class="n">jb_pval</span>
    <span class="p">}</span>

<span class="c1"># Test your function</span>
<span class="c1"># result = fit_and_compare_distributions(returns[&#39;AAPL&#39;])</span>
<span class="c1"># print(f&quot;AAPL t-distribution df: {result[&#39;t_df&#39;]:.2f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">fit_and_compare_distributions</span><span class="p">(</span><span class="n">returns_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fit Normal and t-distribution, compare the fits.&quot;&quot;&quot;</span>
    <span class="n">norm_mean</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">norm_std</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">t_df</span><span class="p">,</span> <span class="n">t_loc</span><span class="p">,</span> <span class="n">t_scale</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">returns_series</span><span class="p">)</span>
    <span class="n">jb_stat</span><span class="p">,</span> <span class="n">jb_pval</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">jarque_bera</span><span class="p">(</span><span class="n">returns_series</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;norm_mean&#39;</span><span class="p">:</span> <span class="n">norm_mean</span><span class="p">,</span>
        <span class="s1">&#39;norm_std&#39;</span><span class="p">:</span> <span class="n">norm_std</span><span class="p">,</span>
        <span class="s1">&#39;t_df&#39;</span><span class="p">:</span> <span class="n">t_df</span><span class="p">,</span>
        <span class="s1">&#39;t_loc&#39;</span><span class="p">:</span> <span class="n">t_loc</span><span class="p">,</span>
        <span class="s1">&#39;t_scale&#39;</span><span class="p">:</span> <span class="n">t_scale</span><span class="p">,</span>
        <span class="s1">&#39;is_normal&#39;</span><span class="p">:</span> <span class="n">jb_pval</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="s1">&#39;jb_pval&#39;</span><span class="p">:</span> <span class="n">jb_pval</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">fit_and_compare_distributions</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: t-dist df=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;t_df&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Normal? </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_normal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-1.3'></a></p>
<h1>Section 1.3: Hypothesis Testing</h1>
<p>How do we know if a trading strategy actually works, or if we just got lucky?</p>
<p>Hypothesis testing helps us distinguish <strong>skill from randomness</strong>.</p>
<p><strong>In this section, you will learn:</strong>
- How to formulate null and alternative hypotheses
- How to conduct t-tests on financial returns
- How to interpret p-values correctly</p></div>
<div class="md-cell"><h2>1.3.1 The Hypothesis Testing Framework</h2>
<p><strong>Null Hypothesis (H‚ÇÄ):</strong> The default assumption (usually "no effect")
- Example: "My strategy's mean return is zero"</p>
<p><strong>Alternative Hypothesis (H‚ÇÅ):</strong> What we're trying to prove
- Example: "My strategy's mean return is positive"</p>
<p><strong>The p-value:</strong> Probability of seeing our result (or more extreme) if H‚ÇÄ is true
- p &lt; 0.05 ‚Üí Reject H‚ÇÄ (result is "statistically significant")
- p ‚â• 0.05 ‚Üí Cannot reject H‚ÇÄ</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test if SPY has statistically significant positive returns</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== One-Sample t-Test: Is SPY Mean Return Zero? ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_1samp</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sample mean:     </span><span class="si">{</span><span class="n">spy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sample size:     </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t-statistic:     </span><span class="si">{</span><span class="n">t_stat</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;p-value:         </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Result: REJECT null hypothesis - SPY has significant non-zero returns&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Result: CANNOT reject null hypothesis&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.3.2 Two-Sample t-Test: Comparing Returns</h2>
<p>Often we want to compare two assets or two strategies.</p>
<p><strong>Question:</strong> Does AAPL outperform SPY?</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare AAPL vs SPY</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Two-Sample t-Test: AAPL vs SPY ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">aapl_ret</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">]</span>
<span class="n">spy_ret</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>

<span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">aapl_ret</span><span class="p">,</span> <span class="n">spy_ret</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;AAPL mean: </span><span class="si">{</span><span class="n">aapl_ret</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">252</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1"> annualized&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SPY mean:  </span><span class="si">{</span><span class="n">spy_ret</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">252</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1"> annualized&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t-statistic: </span><span class="si">{</span><span class="n">t_stat</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;p-value:     </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Result: Significant difference between AAPL and SPY&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Result: No significant difference&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 1.3: Hypothesis Test Setup (Guided)</h3>
<p><strong>Your Task:</strong> Complete the function to perform hypothesis tests on return series.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.3: Hypothesis Test Setup (Guided)</span>
<span class="k">def</span> <span class="nf">test_returns</span><span class="p">(</span><span class="n">returns1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">returns2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">test_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Perform one-sample or two-sample t-test on returns.&quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">returns2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO: One-sample t-test (test if mean equals test_value)</span>
        <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">returns1</span><span class="p">,</span> <span class="n">test_value</span><span class="p">)</span>
        <span class="n">test_type</span> <span class="o">=</span> <span class="s1">&#39;one-sample&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO: Two-sample t-test (compare two series)</span>
        <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">returns1</span><span class="p">,</span> <span class="n">returns2</span><span class="p">)</span>
        <span class="n">test_type</span> <span class="o">=</span> <span class="s1">&#39;two-sample&#39;</span>
    
    <span class="c1"># TODO: Determine if result is significant</span>
    <span class="n">is_significant</span> <span class="o">=</span> <span class="n">p_val</span> <span class="n">______</span> <span class="n">alpha</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;test_type&#39;</span><span class="p">:</span> <span class="n">test_type</span><span class="p">,</span>
        <span class="s1">&#39;t_statistic&#39;</span><span class="p">:</span> <span class="n">t_stat</span><span class="p">,</span>
        <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
        <span class="s1">&#39;is_significant&#39;</span><span class="p">:</span> <span class="n">is_significant</span><span class="p">,</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span>
    <span class="p">}</span>

<span class="c1"># Test your function</span>
<span class="c1"># result = test_returns(returns[&#39;GLD&#39;], returns[&#39;TLT&#39;])</span>
<span class="c1"># print(f&quot;GLD vs TLT: p-value = {result[&#39;p_value&#39;]:.4f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_returns</span><span class="p">(</span><span class="n">returns1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">returns2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                 <span class="n">test_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Perform one-sample or two-sample t-test on returns.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">returns2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_1samp</span><span class="p">(</span><span class="n">returns1</span><span class="p">,</span> <span class="n">test_value</span><span class="p">)</span>
        <span class="n">test_type</span> <span class="o">=</span> <span class="s1">&#39;one-sample&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">returns1</span><span class="p">,</span> <span class="n">returns2</span><span class="p">)</span>
        <span class="n">test_type</span> <span class="o">=</span> <span class="s1">&#39;two-sample&#39;</span>

    <span class="n">is_significant</span> <span class="o">=</span> <span class="n">p_val</span> <span class="o">&lt;</span> <span class="n">alpha</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;test_type&#39;</span><span class="p">:</span> <span class="n">test_type</span><span class="p">,</span>
        <span class="s1">&#39;t_statistic&#39;</span><span class="p">:</span> <span class="n">t_stat</span><span class="p">,</span>
        <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
        <span class="s1">&#39;is_significant&#39;</span><span class="p">:</span> <span class="n">is_significant</span><span class="p">,</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">test_returns</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPY vs Zero: p=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Significant? </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_significant&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">test_returns</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;GLD&#39;</span><span class="p">],</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;TLT&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GLD vs TLT:  p=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Significant? </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;is_significant&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 1.4: Complete Statistical Analysis (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that performs a complete statistical analysis of a return series:
- Calculate all descriptive statistics (mean, std, skewness, kurtosis)
- Fit a t-distribution and report degrees of freedom
- Test if mean return is significantly different from zero
- Return all results in a dictionary</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.4: Complete Statistical Analysis (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">complete_statistical_analysis</span><span class="p">(</span><span class="n">returns_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Asset&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Perform complete statistical analysis of a return series.&quot;&quot;&quot;</span>

    <span class="c1"># Descriptive statistics</span>
    <span class="n">desc_stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;mean_daily&#39;</span><span class="p">:</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;mean_annual&#39;</span><span class="p">:</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
        <span class="s1">&#39;std_daily&#39;</span><span class="p">:</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
        <span class="s1">&#39;volatility_annual&#39;</span><span class="p">:</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span>
        <span class="s1">&#39;skewness&#39;</span><span class="p">:</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">skew</span><span class="p">(),</span>
        <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1"># Distribution fit</span>
    <span class="n">t_df</span><span class="p">,</span> <span class="n">t_loc</span><span class="p">,</span> <span class="n">t_scale</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">returns_series</span><span class="p">)</span>
    <span class="n">jb_stat</span><span class="p">,</span> <span class="n">jb_pval</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">jarque_bera</span><span class="p">(</span><span class="n">returns_series</span><span class="p">)</span>

    <span class="n">dist_stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;t_degrees_freedom&#39;</span><span class="p">:</span> <span class="n">t_df</span><span class="p">,</span>
        <span class="s1">&#39;is_normal&#39;</span><span class="p">:</span> <span class="n">jb_pval</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="s1">&#39;normality_pval&#39;</span><span class="p">:</span> <span class="n">jb_pval</span>
    <span class="p">}</span>

    <span class="c1"># Hypothesis test</span>
    <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_1samp</span><span class="p">(</span><span class="n">returns_series</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">hyp_stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;t_statistic&#39;</span><span class="p">:</span> <span class="n">t_stat</span><span class="p">,</span>
        <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
        <span class="s1">&#39;significant_returns&#39;</span><span class="p">:</span> <span class="n">p_val</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;n_observations&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns_series</span><span class="p">),</span>
        <span class="s1">&#39;descriptive&#39;</span><span class="p">:</span> <span class="n">desc_stats</span><span class="p">,</span>
        <span class="s1">&#39;distribution&#39;</span><span class="p">:</span> <span class="n">dist_stats</span><span class="p">,</span>
        <span class="s1">&#39;hypothesis_test&#39;</span><span class="p">:</span> <span class="n">hyp_stats</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">analysis</span> <span class="o">=</span> <span class="n">complete_statistical_analysis</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;MSFT&#39;</span><span class="p">],</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Analysis ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Annual Return: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;descriptive&#39;</span><span class="p">][</span><span class="s1">&#39;mean_annual&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volatility: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;descriptive&#39;</span><span class="p">][</span><span class="s1">&#39;volatility_annual&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t-dist df: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">][</span><span class="s1">&#39;t_degrees_freedom&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant? </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;hypothesis_test&#39;</span><span class="p">][</span><span class="s1">&#39;significant_returns&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-1.4'></a></p>
<h1>Section 1.4: Correlation &amp; Covariance</h1>
<p>Understanding how assets move together is fundamental to portfolio construction.</p>
<p><strong>In this section, you will learn:</strong>
- The difference between covariance and correlation
- How to compute and interpret correlation matrices
- Why correlation matters for diversification</p></div>
<div class="md-cell"><h2>1.4.1 Covariance and Correlation</h2>
<p><strong>Covariance</strong> measures joint variability but is scale-dependent.</p>
<p><strong>Correlation</strong> standardizes to -1 to +1:
- œÅ = +1: Perfect positive correlation
- œÅ = 0: No linear correlation<br />
- œÅ = -1: Perfect negative correlation</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate correlation matrix</span>
<span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Correlation Matrix ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize correlations</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Asset Correlation Matrix&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Correlation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>1.4.2 Diversification Benefits</h2>
<p>When correlation &lt; 1, portfolio risk &lt; weighted average risk.</p>
<p>This is why diversification works!</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Demonstrate diversification</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Diversification Benefit ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">spy_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">tlt_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;TLT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">correlation</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;TLT&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SPY volatility: </span><span class="si">{</span><span class="n">spy_vol</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TLT volatility: </span><span class="si">{</span><span class="n">tlt_vol</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Correlation:    </span><span class="si">{</span><span class="n">correlation</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># 50/50 portfolio</span>
<span class="n">weighted_avg_vol</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">spy_vol</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">tlt_vol</span>
<span class="n">portfolio_returns</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;TLT&#39;</span><span class="p">]</span>
<span class="n">actual_portfolio_vol</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;50/50 Portfolio:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  If correlation=1: </span><span class="si">{</span><span class="n">weighted_avg_vol</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Actual:           </span><span class="si">{</span><span class="n">actual_portfolio_vol</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Benefit:          </span><span class="si">{</span><span class="n">weighted_avg_vol</span> <span class="o">-</span> <span class="n">actual_portfolio_vol</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> reduction&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.4.3 Rolling Correlations</h2>
<p><strong>Warning:</strong> Correlations change over time, especially during market stress.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Rolling correlations</span>
<span class="n">window</span> <span class="o">=</span> <span class="mi">60</span>

<span class="n">rolling_corr_spy_tlt</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;TLT&#39;</span><span class="p">])</span>
<span class="n">rolling_corr_spy_gld</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;GLD&#39;</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_corr_spy_tlt</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_corr_spy_tlt</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SPY-TLT&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_corr_spy_gld</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_corr_spy_gld</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SPY-GLD&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;60-Day Rolling Correlation&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling Correlations Over Time&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 1.5: Build a Correlation Analyzer (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a class that analyzes correlations between assets:
- Calculate the full correlation matrix
- Find the pair with minimum correlation (best for diversification)
- Find the pair with maximum correlation (highest risk concentration)
- Calculate rolling correlations for a given window</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.5: Build a Correlation Analyzer (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CorrelationAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze correlations between assets.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="o">=</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the correlation matrix.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_matrix</span>

    <span class="k">def</span> <span class="nf">find_min_correlation_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find the pair with minimum correlation.&quot;&quot;&quot;</span>
        <span class="n">corr_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">corr_values</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ignore diagonal</span>

        <span class="n">min_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">corr_values</span><span class="p">),</span> <span class="n">corr_values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">asset1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="n">min_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">asset2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="n">min_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">min_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">asset1</span><span class="p">,</span> <span class="n">asset2</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">asset1</span><span class="p">,</span> <span class="n">asset2</span><span class="p">,</span> <span class="n">min_corr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_max_correlation_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find the pair with maximum correlation (excluding self).&quot;&quot;&quot;</span>
        <span class="n">corr_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">corr_values</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ignore diagonal</span>

        <span class="n">max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">corr_values</span><span class="p">),</span> <span class="n">corr_values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">asset1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="n">max_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">asset2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">[</span><span class="n">max_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">max_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">asset1</span><span class="p">,</span> <span class="n">asset2</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">asset1</span><span class="p">,</span> <span class="n">asset2</span><span class="p">,</span> <span class="n">max_corr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rolling_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">asset2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate rolling correlation between two assets.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="n">asset1</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="n">asset2</span><span class="p">])</span>

<span class="c1"># Test</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">CorrelationAnalyzer</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
<span class="n">min_pair</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">find_min_correlation_pair</span><span class="p">()</span>
<span class="n">max_pair</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">find_max_correlation_pair</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Best diversification: </span><span class="si">{</span><span class="n">min_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">min_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> (corr=</span><span class="si">{</span><span class="n">min_pair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Highest correlation:  </span><span class="si">{</span><span class="n">max_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">max_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> (corr=</span><span class="si">{</span><span class="n">max_pair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 1.6: Diversification Calculator (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that calculates the diversification benefit of combining two assets:
- Calculate individual asset volatilities
- Calculate the 50/50 portfolio volatility
- Calculate the "weighted average" volatility (if correlation=1)
- Calculate the diversification benefit (reduction in volatility)
- Return the percentage improvement</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 1.6: Diversification Calculator (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_diversification_benefit</span><span class="p">(</span><span class="n">returns_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                                       <span class="n">asset1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                       <span class="n">asset2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                       <span class="n">weight1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate diversification benefit of combining two assets.&quot;&quot;&quot;</span>

    <span class="n">weight2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight1</span>

    <span class="c1"># Individual volatilities</span>
    <span class="n">vol1</span> <span class="o">=</span> <span class="n">returns_df</span><span class="p">[</span><span class="n">asset1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">vol2</span> <span class="o">=</span> <span class="n">returns_df</span><span class="p">[</span><span class="n">asset2</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="c1"># Correlation</span>
    <span class="n">correlation</span> <span class="o">=</span> <span class="n">returns_df</span><span class="p">[</span><span class="n">asset1</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">returns_df</span><span class="p">[</span><span class="n">asset2</span><span class="p">])</span>

    <span class="c1"># Portfolio volatility</span>
    <span class="n">port_returns</span> <span class="o">=</span> <span class="n">weight1</span> <span class="o">*</span> <span class="n">returns_df</span><span class="p">[</span><span class="n">asset1</span><span class="p">]</span> <span class="o">+</span> <span class="n">weight2</span> <span class="o">*</span> <span class="n">returns_df</span><span class="p">[</span><span class="n">asset2</span><span class="p">]</span>
    <span class="n">port_vol</span> <span class="o">=</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="c1"># Weighted average (if correlation = 1)</span>
    <span class="n">weighted_avg_vol</span> <span class="o">=</span> <span class="n">weight1</span> <span class="o">*</span> <span class="n">vol1</span> <span class="o">+</span> <span class="n">weight2</span> <span class="o">*</span> <span class="n">vol2</span>

    <span class="c1"># Diversification benefit</span>
    <span class="n">benefit</span> <span class="o">=</span> <span class="n">weighted_avg_vol</span> <span class="o">-</span> <span class="n">port_vol</span>
    <span class="n">benefit_pct</span> <span class="o">=</span> <span class="n">benefit</span> <span class="o">/</span> <span class="n">weighted_avg_vol</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;asset1&#39;</span><span class="p">:</span> <span class="n">asset1</span><span class="p">,</span>
        <span class="s1">&#39;asset2&#39;</span><span class="p">:</span> <span class="n">asset2</span><span class="p">,</span>
        <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">correlation</span><span class="p">,</span>
        <span class="s1">&#39;portfolio_vol&#39;</span><span class="p">:</span> <span class="n">port_vol</span><span class="p">,</span>
        <span class="s1">&#39;weighted_avg_vol&#39;</span><span class="p">:</span> <span class="n">weighted_avg_vol</span><span class="p">,</span>
        <span class="s1">&#39;diversification_benefit&#39;</span><span class="p">:</span> <span class="n">benefit</span><span class="p">,</span>
        <span class="s1">&#39;benefit_percentage&#39;</span><span class="p">:</span> <span class="n">benefit_pct</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_diversification_benefit</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">a1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">a2</span><span class="si">}</span><span class="s1">: corr=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;correlation&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, benefit=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;benefit_percentage&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Statistical Analysis Report</h1>
<p>Put together everything you've learned!</p>
<p><strong>Your Challenge:</strong></p>
<p>Create a comprehensive statistical analysis report for QQQ (Nasdaq 100 ETF):</p>
<ol>
<li><strong>Descriptive Statistics:</strong> Mean, std, skewness, kurtosis</li>
<li><strong>Distribution Fit:</strong> Fit a t-distribution and interpret degrees of freedom</li>
<li><strong>Hypothesis Test:</strong> Test if QQQ has significantly different returns than SPY</li>
<li><strong>Correlation Analysis:</strong> How correlated is QQQ with our other assets?</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Module Project: Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Download QQQ data</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading QQQ data...&#39;</span><span class="p">)</span>
<span class="n">qqq_data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qqq_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="n">qqq_prices</span> <span class="o">=</span> <span class="n">qqq_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">][</span><span class="s1">&#39;QQQ&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">qqq_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">qqq_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">qqq_prices</span> <span class="o">=</span> <span class="n">qqq_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">qqq_data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">qqq_data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>

<span class="n">qqq_returns</span> <span class="o">=</span> <span class="n">qqq_prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;QQQ STATISTICAL ANALYSIS REPORT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># 1. Descriptive Statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- 1. DESCRIPTIVE STATISTICS ---&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annual Return: </span><span class="si">{</span><span class="n">qqq_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">252</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Volatility:    </span><span class="si">{</span><span class="n">qqq_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skewness:      </span><span class="si">{</span><span class="n">qqq_returns</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Kurtosis:      </span><span class="si">{</span><span class="n">qqq_returns</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># 2. Distribution Fit</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- 2. DISTRIBUTION FIT ---&#39;</span><span class="p">)</span>
<span class="n">t_df</span><span class="p">,</span> <span class="n">t_loc</span><span class="p">,</span> <span class="n">t_scale</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">qqq_returns</span><span class="p">)</span>
<span class="n">jb_stat</span><span class="p">,</span> <span class="n">jb_pval</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">jarque_bera</span><span class="p">(</span><span class="n">qqq_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t-distribution df: </span><span class="si">{</span><span class="n">t_df</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Normal? </span><span class="si">{</span><span class="n">jb_pval</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># 3. Hypothesis Test vs SPY</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- 3. HYPOTHESIS TEST: QQQ vs SPY ---&#39;</span><span class="p">)</span>
<span class="n">common_idx</span> <span class="o">=</span> <span class="n">qqq_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">t_stat</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">qqq_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">],</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;p-value: </span><span class="si">{</span><span class="n">p_val</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Significant difference? </span><span class="si">{</span><span class="n">p_val</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># 4. Correlations</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- 4. CORRELATION ANALYSIS ---&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">qqq_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;QQQ vs </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">corr</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;END OF REPORT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Descriptive Statistics</h3>
<ul>
<li><strong>Mean vs Median:</strong> Mean is affected by outliers; median shows "typical" values</li>
<li><strong>Volatility:</strong> Annualized standard deviation is the standard risk measure</li>
<li><strong>Skewness:</strong> Negative skew means more extreme losses (common in stocks)</li>
<li><strong>Kurtosis:</strong> High kurtosis means fat tails and more extreme events</li>
</ul>
<h3>2. Probability Distributions</h3>
<ul>
<li><strong>Financial returns are NOT normal:</strong> They have fat tails</li>
<li><strong>t-distribution:</strong> Better fits financial data (3-8 degrees of freedom typical)</li>
<li><strong>Risk models assuming normality underestimate extreme events</strong></li>
</ul>
<h3>3. Hypothesis Testing</h3>
<ul>
<li><strong>p-value &lt; 0.05:</strong> Reject null hypothesis (result is "significant")</li>
<li><strong>Financial data is noisy:</strong> Hard to prove statistical significance</li>
<li><strong>Statistical significance ‚â† Practical significance</strong></li>
</ul>
<h3>4. Correlation &amp; Covariance</h3>
<ul>
<li><strong>Correlation ranges from -1 to +1:</strong> Easier to interpret than covariance</li>
<li><strong>Diversification works when correlation &lt; 1</strong></li>
<li><strong>Correlations change over time:</strong> Especially during crises</li>
</ul></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 2: Return Analysis</strong>, we'll dive deeper into:
- Simple vs Log returns
- Annualization of returns and risk
- Risk-adjusted performance metrics (Sharpe, Sortino)
- Benchmark comparison and Alpha/Beta</p>
<hr />
<p><em>Congratulations on completing Module 1! You now have the statistical foundation for quantitative finance.</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="2"><div class="md-cell module-header"><h1>Module 2: Return Analysis</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 1: Statistical Foundations</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Calculate and interpret simple vs logarithmic returns</li>
<li>Properly annualize returns and volatility</li>
<li>Compute risk-adjusted performance metrics (Sharpe, Sortino, Calmar)</li>
<li>Compare strategies against benchmarks using Alpha, Beta, and Information Ratio</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 1 (Statistics for Finance)</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-2.1">Section 2.1: Types of Returns</a></li>
<li><a href="#section-2.2">Section 2.2: Annualization</a></li>
<li><a href="#section-2.3">Section 2.3: Risk-Adjusted Returns</a></li>
<li><a href="#section-2.4">Section 2.4: Benchmark Comparison</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Libraries loaded successfully!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Financial Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download stock data</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">]</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2019-01-01&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2024-01-01&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Downloading data for </span><span class="si">{</span><span class="n">tickers</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Handle different yfinance column structures</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="c1"># Calculate returns</span>
<span class="n">simple_returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prices</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data range: </span><span class="si">{</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trading days: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">prices</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-2.1'></a></p>
<h1>Section 2.1: Types of Returns</h1>
<p>Not all returns are created equal! The way you calculate returns affects everything downstream.</p>
<p><strong>In this section, you will learn:</strong>
- The difference between simple and log returns
- When to use each type
- Why this choice matters for your analysis</p></div>
<div class="md-cell"><h2>2.1.1 Simple Returns (Arithmetic Returns)</h2>
<p><strong>Formula:</strong> R = (P‚ÇÅ - P‚ÇÄ) / P‚ÇÄ = P‚ÇÅ/P‚ÇÄ - 1</p>
<p><strong>Pros:</strong>
- Intuitive to understand
- Additive across assets (for portfolio returns)</p>
<p><strong>Cons:</strong>
- Not additive across time
- Can't simply sum daily returns to get total return</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate simple returns</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Simple (Arithmetic) Returns ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;First 5 days of SPY simple returns:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Sum of all simple returns: </span><span class="si">{</span><span class="n">simple_returns</span><span class="p">[</span><span class="s2">&quot;SPY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare sum of returns vs actual total return</span>
<span class="n">spy_prices</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>

<span class="c1"># Actual total return</span>
<span class="n">actual_total</span> <span class="o">=</span> <span class="p">(</span><span class="n">spy_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c1"># Sum of simple returns (WRONG approach)</span>
<span class="n">sum_of_returns</span> <span class="o">=</span> <span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># Compounded returns (CORRECT approach)</span>
<span class="n">compounded</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Total Return Calculation ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Actual total return:     </span><span class="si">{</span><span class="n">actual_total</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sum of simple returns:   </span><span class="si">{</span><span class="n">sum_of_returns</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">  ‚Üê WRONG!&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Compounded returns:      </span><span class="si">{</span><span class="n">compounded</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">  ‚Üê CORRECT!&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Lesson: Never sum simple returns to get total return!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.1.2 Log Returns (Continuously Compounded Returns)</h2>
<p><strong>Formula:</strong> r = ln(P‚ÇÅ/P‚ÇÄ) = ln(P‚ÇÅ) - ln(P‚ÇÄ)</p>
<p><strong>Pros:</strong>
- Additive across time (sum log returns = total log return)
- More symmetric (up 50% and down 50% are equal in magnitude)
- Better statistical properties (more normal)</p>
<p><strong>Cons:</strong>
- Not additive across assets
- Less intuitive</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Log returns ARE additive across time!</span>
<span class="n">actual_log_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">spy_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">spy_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sum_of_log</span> <span class="o">=</span> <span class="n">log_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Log Returns: Time Additivity ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Actual log total return: </span><span class="si">{</span><span class="n">actual_log_total</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sum of log returns:      </span><span class="si">{</span><span class="n">sum_of_log</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Difference:              </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">actual_log_total</span> <span class="o">-</span> <span class="n">sum_of_log</span><span class="p">)</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;They match! Log returns can be summed across time.&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.1.3 Converting Between Return Types</h2>
<ul>
<li><strong>Simple to Log:</strong> r = ln(1 + R)</li>
<li><strong>Log to Simple:</strong> R = e^r - 1</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Convert between return types</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Return Conversion ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Take first return as example</span>
<span class="n">simple_r</span> <span class="o">=</span> <span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">log_r</span> <span class="o">=</span> <span class="n">log_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Original simple return:  </span><span class="si">{</span><span class="n">simple_r</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Original log return:     </span><span class="si">{</span><span class="n">log_r</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Convert simple to log</span>
<span class="n">simple_to_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">simple_r</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simple ‚Üí Log: ln(1 + </span><span class="si">{</span><span class="n">simple_r</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">) = </span><span class="si">{</span><span class="n">simple_to_log</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Convert log to simple</span>
<span class="n">log_to_simple</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_r</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Log ‚Üí Simple: e^</span><span class="si">{</span><span class="n">log_r</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> - 1 = </span><span class="si">{</span><span class="n">log_to_simple</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.1.4 When to Use Each Type?</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Use Case</th>
<th>Return Type</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td>Multi-period analysis</td>
<td>Log</td>
<td>Additive across time</td>
</tr>
<tr>
<td>Portfolio returns</td>
<td>Simple</td>
<td>Additive across assets</td>
</tr>
<tr>
<td>Statistical modeling</td>
<td>Log</td>
<td>Better distributional properties</td>
</tr>
<tr>
<td>Reporting to clients</td>
<td>Simple</td>
<td>More intuitive</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visual comparison</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Distribution comparison</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Simple&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">log_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Log&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Simple vs Log Returns Distribution&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Scatter plot showing relationship</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="n">log_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">],</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;y = x&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Simple Return&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Log Return&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Simple vs Log Returns (nearly identical for small values)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For small returns, simple ‚âà log. For large returns, they diverge.&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 2.1: Calculate Total Returns (Guided)</h3>
<p><strong>Your Task:</strong> Calculate AAPL's total return using both compounded simple returns and summed log returns.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.1: Calculate Total Returns (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_total_return</span><span class="p">(</span><span class="n">simple_rets</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">log_rets</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate total return using both methods.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        simple_rets: Simple daily returns</span>
<span class="sd">        log_rets: Log daily returns</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with both calculations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Compound simple returns: (1 + r1) * (1 + r2) * ... - 1</span>
    <span class="n">compounded</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">simple_rets</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="c1"># TODO: Sum log returns and convert to simple</span>
    <span class="n">log_sum</span> <span class="o">=</span> <span class="n">log_rets</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    <span class="n">from_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">log_sum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;compounded_simple&#39;</span><span class="p">:</span> <span class="n">compounded</span><span class="p">,</span>
        <span class="s1">&#39;from_log&#39;</span><span class="p">:</span> <span class="n">from_log</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># result = calculate_total_return(simple_returns[&#39;AAPL&#39;], log_returns[&#39;AAPL&#39;])</span>
<span class="c1"># print(f&quot;Compounded: {result[&#39;compounded_simple&#39;]:.2%}&quot;)</span>
<span class="c1"># print(f&quot;From Log: {result[&#39;from_log&#39;]:.2%}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_total_return</span><span class="p">(</span><span class="n">simple_rets</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">log_rets</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate total return using both methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compound simple returns: (1 + r1) * (1 + r2) * ... - 1</span>
    <span class="n">compounded</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">simple_rets</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Sum log returns and convert to simple</span>
    <span class="n">log_sum</span> <span class="o">=</span> <span class="n">log_rets</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">from_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_sum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;compounded_simple&#39;</span><span class="p">:</span> <span class="n">compounded</span><span class="p">,</span>
        <span class="s1">&#39;from_log&#39;</span><span class="p">:</span> <span class="n">from_log</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_total_return</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">],</span> <span class="n">log_returns</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compounded: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;compounded_simple&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;From Log: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;from_log&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-2.2'></a></p>
<h1>Section 2.2: Annualization</h1>
<p>Returns and risk are typically quoted on an annual basis for easy comparison.</p>
<p><strong>In this section, you will learn:</strong>
- How to annualize returns properly
- How to annualize volatility
- Common pitfalls to avoid</p></div>
<div class="md-cell"><h2>2.2.1 Annualizing Returns</h2>
<p><strong>Key insight:</strong> Returns compound, so we should compound when annualizing.</p>
<p><strong>Formulas:</strong>
- <strong>Daily to Annual:</strong> R_annual = (1 + R_daily)^252 - 1
- <strong>Monthly to Annual:</strong> R_annual = (1 + R_monthly)^12 - 1
- <strong>Weekly to Annual:</strong> R_annual = (1 + R_weekly)^52 - 1</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare different annualization methods</span>
<span class="n">daily_mean</span> <span class="o">=</span> <span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Annualizing Daily Returns ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Daily mean return: </span><span class="si">{</span><span class="n">daily_mean</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Wrong way: simple multiplication</span>
<span class="n">wrong_annual</span> <span class="o">=</span> <span class="n">daily_mean</span> <span class="o">*</span> <span class="mi">252</span>

<span class="c1"># Right way: compounding</span>
<span class="n">right_annual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">daily_mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WRONG (multiply by 252):  </span><span class="si">{</span><span class="n">wrong_annual</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RIGHT (compound):         </span><span class="si">{</span><span class="n">right_annual</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Difference:               </span><span class="si">{</span><span class="n">right_annual</span> <span class="o">-</span> <span class="n">wrong_annual</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For small returns, the difference is small. For larger returns, it matters!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.2.2 Annualizing Volatility</h2>
<p>Volatility is annualized differently because variance (not std dev) is additive!</p>
<p><strong>Formula:</strong> œÉ_annual = œÉ_daily √ó ‚àö252</p>
<p><strong>Why square root?</strong>
- Variance = œÉ¬≤ is additive for independent returns
- œÉ¬≤_annual = œÉ¬≤_daily √ó 252
- Taking square root: œÉ_annual = œÉ_daily √ó ‚àö252</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Annualize volatility correctly</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Annualized Volatility ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">daily_vol</span> <span class="o">=</span> <span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">annual_vol</span> <span class="o">=</span> <span class="n">daily_vol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1">: Daily </span><span class="si">{</span><span class="n">daily_vol</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> ‚Üí Annual </span><span class="si">{</span><span class="n">annual_vol</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Wrong vs right volatility annualization</span>
<span class="n">daily_vol</span> <span class="o">=</span> <span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="n">wrong_vol</span> <span class="o">=</span> <span class="n">daily_vol</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">right_vol</span> <span class="o">=</span> <span class="n">daily_vol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Volatility Annualization ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Daily volatility:          </span><span class="si">{</span><span class="n">daily_vol</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WRONG (multiply by 252):   </span><span class="si">{</span><span class="n">wrong_vol</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">  ‚Üê Nonsensical!&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RIGHT (multiply by ‚àö252):  </span><span class="si">{</span><span class="n">right_vol</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">  ‚Üê Makes sense&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Remember: ‚àö252 ‚âà 15.87&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 2.2: Annualize Quarterly Data (Guided)</h3>
<p><strong>Your Task:</strong> Calculate quarterly returns for AAPL and annualize both return and volatility.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.2: Annualize Quarterly Data (Guided)</span>
<span class="k">def</span> <span class="nf">annualize_quarterly</span><span class="p">(</span><span class="n">prices_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate and annualize quarterly statistics.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        prices_series: Daily price series</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with quarterly and annualized metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Resample to quarterly prices (end of quarter)</span>
    <span class="n">quarterly_prices</span> <span class="o">=</span> <span class="n">prices_series</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">______</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
    
    <span class="c1"># TODO: Calculate quarterly returns</span>
    <span class="n">quarterly_returns</span> <span class="o">=</span> <span class="n">quarterly_prices</span><span class="o">.</span><span class="n">______</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="c1"># Calculate quarterly statistics</span>
    <span class="n">q_mean</span> <span class="o">=</span> <span class="n">quarterly_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">q_vol</span> <span class="o">=</span> <span class="n">quarterly_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    
    <span class="c1"># TODO: Annualize (4 quarters per year)</span>
    <span class="n">annual_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q_mean</span><span class="p">)</span> <span class="o">**</span> <span class="n">______</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">annual_vol</span> <span class="o">=</span> <span class="n">q_vol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">______</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;quarterly_return&#39;</span><span class="p">:</span> <span class="n">q_mean</span><span class="p">,</span>
        <span class="s1">&#39;quarterly_vol&#39;</span><span class="p">:</span> <span class="n">q_vol</span><span class="p">,</span>
        <span class="s1">&#39;annual_return&#39;</span><span class="p">:</span> <span class="n">annual_return</span><span class="p">,</span>
        <span class="s1">&#39;annual_vol&#39;</span><span class="p">:</span> <span class="n">annual_vol</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># result = annualize_quarterly(prices[&#39;AAPL&#39;])</span>
<span class="c1"># print(f&quot;Quarterly Return: {result[&#39;quarterly_return&#39;]:.2%}&quot;)</span>
<span class="c1"># print(f&quot;Annualized Return: {result[&#39;annual_return&#39;]:.2%}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">annualize_quarterly</span><span class="p">(</span><span class="n">prices_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate and annualize quarterly statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Resample to quarterly prices (end of quarter)</span>
    <span class="n">quarterly_prices</span> <span class="o">=</span> <span class="n">prices_series</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>

    <span class="c1"># Calculate quarterly returns</span>
    <span class="n">quarterly_returns</span> <span class="o">=</span> <span class="n">quarterly_prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># Calculate quarterly statistics</span>
    <span class="n">q_mean</span> <span class="o">=</span> <span class="n">quarterly_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">q_vol</span> <span class="o">=</span> <span class="n">quarterly_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="c1"># Annualize (4 quarters per year)</span>
    <span class="n">annual_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">q_mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">annual_vol</span> <span class="o">=</span> <span class="n">q_vol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;quarterly_return&#39;</span><span class="p">:</span> <span class="n">q_mean</span><span class="p">,</span>
        <span class="s1">&#39;quarterly_vol&#39;</span><span class="p">:</span> <span class="n">q_vol</span><span class="p">,</span>
        <span class="s1">&#39;annual_return&#39;</span><span class="p">:</span> <span class="n">annual_return</span><span class="p">,</span>
        <span class="s1">&#39;annual_vol&#39;</span><span class="p">:</span> <span class="n">annual_vol</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">annualize_quarterly</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quarterly Return: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;quarterly_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Annualized Return: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;annual_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quarterly Vol: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;quarterly_vol&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Annualized Vol: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;annual_vol&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-2.3'></a></p>
<h1>Section 2.3: Risk-Adjusted Returns</h1>
<p>Raw returns don't tell the whole story. A 20% return with 50% volatility isn't as good as 15% return with 10% volatility!</p>
<p><strong>In this section, you will learn:</strong>
- Sharpe Ratio: The most popular risk-adjusted metric
- Sortino Ratio: Penalizes only downside risk
- Calmar Ratio: Uses maximum drawdown as risk</p></div>
<div class="md-cell"><h2>2.3.1 The Sharpe Ratio</h2>
<p><strong>Formula:</strong> Sharpe = (R_portfolio - R_f) / œÉ_portfolio</p>
<p>Where:
- R_portfolio = Portfolio return
- R_f = Risk-free rate (e.g., T-bills)
- œÉ_portfolio = Portfolio volatility</p>
<p><strong>Interpretation:</strong>
- Sharpe &lt; 1: Subpar risk-adjusted returns
- 1 ‚â§ Sharpe &lt; 2: Good
- 2 ‚â§ Sharpe &lt; 3: Very good
- Sharpe ‚â• 3: Excellent (rare for long periods)</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate Sharpe Ratio</span>
<span class="n">risk_free_rate</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># Assume 2% annual risk-free rate</span>

<span class="k">def</span> <span class="nf">calculate_sharpe</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">risk_free_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate annualized Sharpe ratio.&quot;&quot;&quot;</span>
    <span class="n">excess_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">-</span> <span class="p">(</span><span class="n">risk_free_rate</span> <span class="o">/</span> <span class="mi">252</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">excess_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">excess_returns</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Sharpe Ratios (Risk-Free Rate = 2%) ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">sharpe_ratios</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="n">calculate_sharpe</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">])</span>
    <span class="n">sharpe_ratios</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">sharpe</span>
    <span class="n">quality</span> <span class="o">=</span> <span class="s1">&#39;Excellent&#39;</span> <span class="k">if</span> <span class="n">sharpe</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;Good&#39;</span> <span class="k">if</span> <span class="n">sharpe</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;Poor&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sharpe</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">quality</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.3.2 The Sortino Ratio</h2>
<p>The Sharpe ratio penalizes <strong>all</strong> volatility equally. But investors mainly dislike <strong>downside</strong> volatility!</p>
<p><strong>Formula:</strong> Sortino = (R_portfolio - R_f) / œÉ_downside</p>
<p>Where œÉ_downside only considers returns below a threshold (typically 0 or R_f).</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_sortino</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">risk_free_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate annualized Sortino ratio.&quot;&quot;&quot;</span>
    <span class="n">excess_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">-</span> <span class="p">(</span><span class="n">risk_free_rate</span> <span class="o">/</span> <span class="mi">252</span><span class="p">)</span>
    
    <span class="c1"># Downside deviation: only returns below target</span>
    <span class="n">downside_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">]</span>
    <span class="n">downside_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">downside_returns</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">excess_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">downside_std</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Sortino Ratios (vs Sharpe) ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Asset&quot;</span><span class="si">:</span><span class="s1">&lt;6</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Sharpe&quot;</span><span class="si">:</span><span class="s1">&gt;10</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Sortino&quot;</span><span class="si">:</span><span class="s1">&gt;10</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">28</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="n">calculate_sharpe</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">])</span>
    <span class="n">sortino</span> <span class="o">=</span> <span class="n">calculate_sortino</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s1">&lt;6</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">sharpe</span><span class="si">:</span><span class="s1">&gt;10.3f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">sortino</span><span class="si">:</span><span class="s1">&gt;10.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.3.3 The Calmar Ratio</h2>
<p>Instead of volatility, the Calmar ratio uses <strong>maximum drawdown</strong> as the risk measure.</p>
<p><strong>Formula:</strong> Calmar = Annual Return / Maximum Drawdown</p>
<p><strong>Maximum Drawdown:</strong> The largest peak-to-trough decline in portfolio value.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_max_drawdown</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate maximum drawdown from price series.&quot;&quot;&quot;</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    <span class="k">return</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">calculate_calmar</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate Calmar ratio.&quot;&quot;&quot;</span>
    <span class="n">annual_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">max_dd</span> <span class="o">=</span> <span class="n">calculate_max_drawdown</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">annual_return</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Maximum Drawdowns &amp; Calmar Ratios ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Asset&quot;</span><span class="si">:</span><span class="s1">&lt;6</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Max Drawdown&quot;</span><span class="si">:</span><span class="s1">&gt;12</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Annual Return&quot;</span><span class="si">:</span><span class="s1">&gt;14</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Calmar&quot;</span><span class="si">:</span><span class="s1">&gt;10</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">46</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">max_dd</span> <span class="o">=</span> <span class="n">calculate_max_drawdown</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="n">ticker</span><span class="p">])</span>
    <span class="n">annual_ret</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">calmar</span> <span class="o">=</span> <span class="n">calculate_calmar</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">prices</span><span class="p">[</span><span class="n">ticker</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s1">&lt;6</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">max_dd</span><span class="si">:</span><span class="s1">&gt;12.2%</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">annual_ret</span><span class="si">:</span><span class="s1">&gt;14.2%</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">calmar</span><span class="si">:</span><span class="s1">&gt;10.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize drawdowns</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Normalize prices to start at 100</span>
<span class="n">normalized</span> <span class="o">=</span> <span class="n">prices</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

<span class="c1"># Price chart</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">normalized</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized Price (100 = Start)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Asset Prices Over Time&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1"># Drawdown chart</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">drawdown</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ticker</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Underwater Chart (Drawdowns)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.0%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 2.3: Calculate Risk-Adjusted Metrics (Guided)</h3>
<p><strong>Your Task:</strong> Build a function that calculates all three risk-adjusted ratios for a given asset.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.3: Calculate Risk-Adjusted Metrics (Guided)</span>
<span class="k">def</span> <span class="nf">risk_adjusted_metrics</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                          <span class="n">risk_free</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Sharpe, Sortino, and Calmar ratios.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Daily return series</span>
<span class="sd">        prices: Daily price series</span>
<span class="sd">        risk_free: Annual risk-free rate</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with all three ratios</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate excess returns</span>
    <span class="n">daily_rf</span> <span class="o">=</span> <span class="n">risk_free</span> <span class="o">/</span> <span class="mi">252</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">-</span> <span class="n">daily_rf</span>
    
    <span class="c1"># TODO: Sharpe = annualized excess return / annualized volatility</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">excess</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">/</span> <span class="n">excess</span><span class="o">.</span><span class="n">______</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="c1"># Sortino - only downside volatility</span>
    <span class="n">downside</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">downside_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">downside</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">sortino</span> <span class="o">=</span> <span class="p">(</span><span class="n">excess</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">downside_std</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calmar = annual return / |max drawdown|</span>
    <span class="n">annual_ret</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    <span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    <span class="n">calmar</span> <span class="o">=</span> <span class="n">annual_ret</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span> <span class="s1">&#39;sortino&#39;</span><span class="p">:</span> <span class="n">sortino</span><span class="p">,</span> <span class="s1">&#39;calmar&#39;</span><span class="p">:</span> <span class="n">calmar</span><span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># metrics = risk_adjusted_metrics(simple_returns[&#39;AAPL&#39;], prices[&#39;AAPL&#39;])</span>
<span class="c1"># for name, value in metrics.items():</span>
<span class="c1">#     print(f&quot;{name.capitalize()}: {value:.3f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">risk_adjusted_metrics</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                          <span class="n">risk_free</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Sharpe, Sortino, and Calmar ratios.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate excess returns</span>
    <span class="n">daily_rf</span> <span class="o">=</span> <span class="n">risk_free</span> <span class="o">/</span> <span class="mi">252</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">-</span> <span class="n">daily_rf</span>

    <span class="c1"># Sharpe = annualized excess return / annualized volatility</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">excess</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">excess</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="c1"># Sortino - only downside volatility</span>
    <span class="n">downside</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">downside_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">downside</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">sortino</span> <span class="o">=</span> <span class="p">(</span><span class="n">excess</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">downside_std</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="c1"># Calmar = annual return / |max drawdown|</span>
    <span class="n">annual_ret</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    <span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">calmar</span> <span class="o">=</span> <span class="n">annual_ret</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span> <span class="s1">&#39;sortino&#39;</span><span class="p">:</span> <span class="n">sortino</span><span class="p">,</span> <span class="s1">&#39;calmar&#39;</span><span class="p">:</span> <span class="n">calmar</span><span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">risk_adjusted_metrics</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">],</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-2.4'></a></p>
<h1>Section 2.4: Benchmark Comparison</h1>
<p>How does your strategy compare to a simple benchmark? This section covers Alpha, Beta, and other benchmark-relative metrics.</p>
<p><strong>In this section, you will learn:</strong>
- Alpha: Excess return vs benchmark
- Beta: Sensitivity to benchmark movements
- Information Ratio: Risk-adjusted active return</p></div>
<div class="md-cell"><h2>2.4.1 Beta: Market Sensitivity</h2>
<p><strong>Beta</strong> measures how much an asset moves relative to the market.</p>
<p><strong>Formula:</strong> Œ≤ = Cov(R_asset, R_market) / Var(R_market)</p>
<p><strong>Interpretation:</strong>
- Œ≤ = 1: Moves exactly with the market
- Œ≤ &gt; 1: More volatile than market (amplifies movements)
- Œ≤ &lt; 1: Less volatile than market (dampens movements)
- Œ≤ &lt; 0: Moves opposite to market (rare)</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate Beta using SPY as the market</span>
<span class="n">market_returns</span> <span class="o">=</span> <span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">calculate_beta</span><span class="p">(</span><span class="n">asset_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">market_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate beta relative to market.&quot;&quot;&quot;</span>
    <span class="n">covariance</span> <span class="o">=</span> <span class="n">asset_returns</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">market_returns</span><span class="p">)</span>
    <span class="n">market_variance</span> <span class="o">=</span> <span class="n">market_returns</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">covariance</span> <span class="o">/</span> <span class="n">market_variance</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Beta Values (vs SPY) ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ticker</span> <span class="o">==</span> <span class="s1">&#39;SPY&#39;</span><span class="p">:</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">calculate_beta</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">market_returns</span><span class="p">)</span>
    
    <span class="n">interpretation</span> <span class="o">=</span> <span class="s1">&#39;More risky&#39;</span> <span class="k">if</span> <span class="n">beta</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;Less risky&#39;</span> <span class="k">if</span> <span class="n">beta</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;Same as market&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">beta</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">interpretation</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.4.2 Alpha: Excess Return</h2>
<p><strong>Alpha</strong> measures return above what beta predicts.</p>
<p><strong>Formula:</strong> Œ± = R_asset - [R_f + Œ≤ √ó (R_market - R_f)]</p>
<p><strong>Interpretation:</strong>
- Œ± &gt; 0: Asset outperformed risk-adjusted expectations
- Œ± &lt; 0: Asset underperformed
- Œ± = 0: Performance exactly as expected given beta</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_alpha</span><span class="p">(</span><span class="n">asset_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">market_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                    <span class="n">risk_free_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate annualized alpha using CAPM.&quot;&quot;&quot;</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">calculate_beta</span><span class="p">(</span><span class="n">asset_returns</span><span class="p">,</span> <span class="n">market_returns</span><span class="p">)</span>
    
    <span class="c1"># Annualized returns</span>
    <span class="n">asset_annual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">asset_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">market_annual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">market_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="c1"># Expected return based on CAPM</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">risk_free_rate</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">market_annual</span> <span class="o">-</span> <span class="n">risk_free_rate</span><span class="p">)</span>
    
    <span class="c1"># Alpha is the difference</span>
    <span class="k">return</span> <span class="n">asset_annual</span> <span class="o">-</span> <span class="n">expected</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Alpha Values (Annualized) ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">calculate_beta</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">market_returns</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">calculate_alpha</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">market_returns</span><span class="p">)</span>
    
    <span class="n">performance</span> <span class="o">=</span> <span class="s1">&#39;Outperformed&#39;</span> <span class="k">if</span> <span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Underperformed&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1">: Œ± = </span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s1">&gt;7.2%</span><span class="si">}</span><span class="s1">, Œ≤ = </span><span class="si">{</span><span class="n">beta</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">performance</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.4.3 Information Ratio</h2>
<p>For active managers, we care about:
- <strong>Active Return:</strong> Return difference vs benchmark
- <strong>Tracking Error:</strong> Volatility of active returns
- <strong>Information Ratio:</strong> Active return / Tracking error</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_information_ratio</span><span class="p">(</span><span class="n">asset_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                                 <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate Information Ratio.&quot;&quot;&quot;</span>
    <span class="n">active_returns</span> <span class="o">=</span> <span class="n">asset_returns</span> <span class="o">-</span> <span class="n">benchmark_returns</span>
    <span class="n">active_return_annual</span> <span class="o">=</span> <span class="n">active_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
    <span class="n">tracking_error</span> <span class="o">=</span> <span class="n">active_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">active_return_annual</span> <span class="o">/</span> <span class="n">tracking_error</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Benchmark-Relative Metrics (vs SPY) ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Asset&quot;</span><span class="si">:</span><span class="s1">&lt;6</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Active Return&quot;</span><span class="si">:</span><span class="s1">&gt;14</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Tracking Error&quot;</span><span class="si">:</span><span class="s1">&gt;14</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Info Ratio&quot;</span><span class="si">:</span><span class="s1">&gt;12</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ticker</span> <span class="o">==</span> <span class="s1">&#39;SPY&#39;</span><span class="p">:</span>
        <span class="k">continue</span>
        
    <span class="n">active_ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">market_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">*</span> <span class="mi">252</span>
    <span class="n">te</span> <span class="o">=</span> <span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">-</span> <span class="n">market_returns</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">ir</span> <span class="o">=</span> <span class="n">calculate_information_ratio</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">market_returns</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s1">&lt;6</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">active_ret</span><span class="si">:</span><span class="s1">&gt;14.2%</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">te</span><span class="si">:</span><span class="s1">&gt;14.2%</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">ir</span><span class="si">:</span><span class="s1">&gt;12.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 2.4: Build a Performance Comparison Tool (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that compares any asset against a benchmark and returns a comprehensive report including:
- Alpha and Beta
- Information Ratio
- Correlation with benchmark
- Relative Sharpe (asset Sharpe - benchmark Sharpe)</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.4: Build a Performance Comparison Tool (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compare_to_benchmark</span><span class="p">(</span><span class="n">asset_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                         <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                         <span class="n">risk_free</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive benchmark comparison.</span>

<span class="sd">    Args:</span>
<span class="sd">        asset_returns: Daily returns of asset</span>
<span class="sd">        benchmark_returns: Daily returns of benchmark</span>
<span class="sd">        risk_free: Annual risk-free rate</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with all comparison metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Beta</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">asset_returns</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">benchmark_returns</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">benchmark_returns</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="n">var</span>

    <span class="c1"># Alpha (annualized)</span>
    <span class="n">asset_annual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">asset_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">bench_annual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">benchmark_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">risk_free</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">bench_annual</span> <span class="o">-</span> <span class="n">risk_free</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">asset_annual</span> <span class="o">-</span> <span class="n">expected</span>

    <span class="c1"># Information Ratio</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">asset_returns</span> <span class="o">-</span> <span class="n">benchmark_returns</span>
    <span class="n">ir</span> <span class="o">=</span> <span class="p">(</span><span class="n">active</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">active</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>

    <span class="c1"># Correlation</span>
    <span class="n">correlation</span> <span class="o">=</span> <span class="n">asset_returns</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">benchmark_returns</span><span class="p">)</span>

    <span class="c1"># Sharpe comparison</span>
    <span class="n">excess_asset</span> <span class="o">=</span> <span class="n">asset_returns</span> <span class="o">-</span> <span class="n">risk_free</span><span class="o">/</span><span class="mi">252</span>
    <span class="n">excess_bench</span> <span class="o">=</span> <span class="n">benchmark_returns</span> <span class="o">-</span> <span class="n">risk_free</span><span class="o">/</span><span class="mi">252</span>
    <span class="n">sharpe_asset</span> <span class="o">=</span> <span class="p">(</span><span class="n">excess_asset</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">excess_asset</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">sharpe_bench</span> <span class="o">=</span> <span class="p">(</span><span class="n">excess_bench</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">excess_bench</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span>
        <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
        <span class="s1">&#39;information_ratio&#39;</span><span class="p">:</span> <span class="n">ir</span><span class="p">,</span>
        <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">correlation</span><span class="p">,</span>
        <span class="s1">&#39;asset_sharpe&#39;</span><span class="p">:</span> <span class="n">sharpe_asset</span><span class="p">,</span>
        <span class="s1">&#39;benchmark_sharpe&#39;</span><span class="p">:</span> <span class="n">sharpe_bench</span><span class="p">,</span>
        <span class="s1">&#39;relative_sharpe&#39;</span><span class="p">:</span> <span class="n">sharpe_asset</span> <span class="o">-</span> <span class="n">sharpe_bench</span>
    <span class="p">}</span>

<span class="c1"># Test with AAPL vs SPY</span>
<span class="n">comparison</span> <span class="o">=</span> <span class="n">compare_to_benchmark</span><span class="p">(</span><span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">],</span> <span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== AAPL vs SPY Comparison ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alpha: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Beta: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Information Ratio: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;information_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Asset Sharpe: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;asset_sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Benchmark Sharpe: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;benchmark_sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative Sharpe: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;relative_sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 2.5: Multi-Asset Return Analysis (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Takes a list of tickers and a date range
- Calculates simple and log returns for each
- Computes annualized return and volatility
- Returns a sorted DataFrame (by Sharpe ratio)</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.5: Multi-Asset Return Analysis (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_multiple_assets</span><span class="p">(</span><span class="n">tickers</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> 
                            <span class="n">start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                            <span class="n">end</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">risk_free</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze returns for multiple assets.</span>

<span class="sd">    Args:</span>
<span class="sd">        tickers: List of ticker symbols</span>
<span class="sd">        start: Start date string</span>
<span class="sd">        end: End date string</span>
<span class="sd">        risk_free: Annual risk-free rate</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame sorted by Sharpe ratio</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Download data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Handle column structure</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ticker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">simple_ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># Annualized metrics</span>
        <span class="n">annual_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">simple_ret</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">annual_vol</span> <span class="o">=</span> <span class="n">simple_ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

        <span class="c1"># Sharpe</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">simple_ret</span> <span class="o">-</span> <span class="n">risk_free</span><span class="o">/</span><span class="mi">252</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">excess</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">excess</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

        <span class="c1"># Total return</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Ticker&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
            <span class="s1">&#39;Total Return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;Annual Return&#39;</span><span class="p">:</span> <span class="n">annual_return</span><span class="p">,</span>
            <span class="s1">&#39;Annual Vol&#39;</span><span class="p">:</span> <span class="n">annual_vol</span><span class="p">,</span>
            <span class="s1">&#39;Sharpe&#39;</span><span class="p">:</span> <span class="n">sharpe</span>
        <span class="p">})</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Sharpe&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">analysis</span> <span class="o">=</span> <span class="n">analyze_multiple_assets</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">],</span>
    <span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-01&#39;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">formatters</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;Total Return&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.2%}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
    <span class="s1">&#39;Annual Return&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.2%}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
    <span class="s1">&#39;Annual Vol&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.2%}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
    <span class="s1">&#39;Sharpe&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="p">}))</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 2.6: Drawdown Analysis Tool (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a comprehensive drawdown analyzer that:
- Calculates maximum drawdown and its duration
- Finds the top 5 worst drawdown periods
- Calculates average time to recovery
- Plots the underwater chart</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 2.6: Drawdown Analysis Tool (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DrawdownAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive drawdown analysis tool.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_max</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_max</span>

    <span class="k">def</span> <span class="nf">max_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return maximum drawdown.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">max_drawdown_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate duration of max drawdown in days.&quot;&quot;&quot;</span>
        <span class="c1"># Find trough date</span>
        <span class="n">trough_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>

        <span class="c1"># Find peak before trough</span>
        <span class="n">peak_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[:</span><span class="n">trough_date</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>

        <span class="c1"># Find recovery date (if any)</span>
        <span class="n">post_trough</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="n">trough_date</span><span class="p">:]</span>
        <span class="n">peak_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="n">peak_date</span><span class="p">]</span>
        <span class="n">recovery</span> <span class="o">=</span> <span class="n">post_trough</span><span class="p">[</span><span class="n">post_trough</span> <span class="o">&gt;=</span> <span class="n">peak_value</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">recovery_date</span> <span class="o">=</span> <span class="n">recovery</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">recovery_date</span> <span class="o">-</span> <span class="n">peak_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

    <span class="k">def</span> <span class="nf">top_drawdowns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find top N drawdown periods.&quot;&quot;&quot;</span>
        <span class="c1"># Simple approach: find local minima</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">trough_date</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
            <span class="n">trough_value</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Trough Date&#39;</span><span class="p">:</span> <span class="n">trough_date</span><span class="p">,</span>
                <span class="s1">&#39;Drawdown&#39;</span><span class="p">:</span> <span class="n">trough_value</span>
            <span class="p">})</span>

            <span class="c1"># Zero out this drawdown period</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">trough_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span> <span class="o">&amp;</span> \
                   <span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">trough_date</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span>
            <span class="n">dd</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot underwater chart.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="p">,</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Underwater Chart (Drawdowns)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.0%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Test</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">DrawdownAnalyzer</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown: </span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">()</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max DD Duration: </span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">max_drawdown_duration</span><span class="p">()</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 5 Drawdowns:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">top_drawdowns</span><span class="p">())</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Complete Performance Report</h1>
<p>Create a professional performance report for a portfolio.</p>
<p><strong>Your Challenge:</strong></p>
<p>Create an equal-weight portfolio of SPY, AAPL, GLD, and TLT, then:
1. Calculate portfolio returns (use simple returns weighted by 25% each)
2. Compare to SPY as benchmark
3. Report: Annual return, Volatility, Sharpe, Sortino, Max Drawdown, Alpha, Beta</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Build the portfolio and create a complete report</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Complete Performance Report Solution</span>

<span class="c1"># Create equal-weight portfolio</span>
<span class="n">portfolio_tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]</span>

<span class="c1"># Calculate portfolio returns</span>
<span class="n">portfolio_returns</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">simple_returns</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">portfolio_tickers</span><span class="p">))</span>

<span class="c1"># Create portfolio price series for drawdown calculation</span>
<span class="n">portfolio_prices</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">portfolio_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PORTFOLIO PERFORMANCE REPORT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Equal-Weight: SPY (25%), AAPL (25%), GLD (25%), TLT (25%)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Calculate all metrics</span>
<span class="n">annual_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">annual_vol</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="c1"># Sharpe</span>
<span class="n">risk_free</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">excess</span> <span class="o">=</span> <span class="n">portfolio_returns</span> <span class="o">-</span> <span class="n">risk_free</span><span class="o">/</span><span class="mi">252</span>
<span class="n">sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">excess</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">excess</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="c1"># Sortino</span>
<span class="n">downside</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="p">[</span><span class="n">portfolio_returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">downside_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">downside</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">sortino</span> <span class="o">=</span> <span class="p">(</span><span class="n">excess</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">downside_std</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="c1"># Max Drawdown</span>
<span class="n">running_max</span> <span class="o">=</span> <span class="n">portfolio_prices</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
<span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">portfolio_prices</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
<span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="c1"># Calmar</span>
<span class="n">calmar</span> <span class="o">=</span> <span class="n">annual_return</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span>

<span class="c1"># Alpha and Beta (vs SPY)</span>
<span class="n">market</span> <span class="o">=</span> <span class="n">simple_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">market</span><span class="p">)</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="n">var</span>

<span class="n">market_annual</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">market</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">**</span> <span class="mi">252</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">expected</span> <span class="o">=</span> <span class="n">risk_free</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">market_annual</span> <span class="o">-</span> <span class="n">risk_free</span><span class="p">)</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="n">annual_return</span> <span class="o">-</span> <span class="n">expected</span>

<span class="c1"># Benchmark metrics</span>
<span class="n">spy_annual</span> <span class="o">=</span> <span class="n">market_annual</span>
<span class="n">spy_vol</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">spy_excess</span> <span class="o">=</span> <span class="n">market</span> <span class="o">-</span> <span class="n">risk_free</span><span class="o">/</span><span class="mi">252</span>
<span class="n">spy_sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">spy_excess</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">spy_excess</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">spy_max_dd</span> <span class="o">=</span> <span class="p">((</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cummax</span><span class="p">())</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cummax</span><span class="p">())</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="c1"># Print Report</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- Return Metrics ---&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Metric&quot;</span><span class="si">:</span><span class="s1">&lt;25</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;Portfolio&quot;</span><span class="si">:</span><span class="s1">&gt;15</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;SPY Benchmark&quot;</span><span class="si">:</span><span class="s1">&gt;15</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Annual Return&quot;</span><span class="si">:</span><span class="s1">&lt;25</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">annual_return</span><span class="si">:</span><span class="s1">&gt;15.2%</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">spy_annual</span><span class="si">:</span><span class="s1">&gt;15.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Annual Volatility&quot;</span><span class="si">:</span><span class="s1">&lt;25</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">annual_vol</span><span class="si">:</span><span class="s1">&gt;15.2%</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">spy_vol</span><span class="si">:</span><span class="s1">&gt;15.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- Risk-Adjusted Metrics ---&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Sharpe Ratio&quot;</span><span class="si">:</span><span class="s1">&lt;25</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">sharpe</span><span class="si">:</span><span class="s1">&gt;15.3f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">spy_sharpe</span><span class="si">:</span><span class="s1">&gt;15.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Sortino Ratio&quot;</span><span class="si">:</span><span class="s1">&lt;25</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">sortino</span><span class="si">:</span><span class="s1">&gt;15.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Calmar Ratio&quot;</span><span class="si">:</span><span class="s1">&lt;25</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">calmar</span><span class="si">:</span><span class="s1">&gt;15.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Maximum Drawdown&quot;</span><span class="si">:</span><span class="s1">&lt;25</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">max_dd</span><span class="si">:</span><span class="s1">&gt;15.2%</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">spy_max_dd</span><span class="si">:</span><span class="s1">&gt;15.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- Benchmark-Relative Metrics ---&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Alpha&quot;</span><span class="si">:</span><span class="s1">&lt;25</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s1">&gt;15.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Beta&quot;</span><span class="si">:</span><span class="s1">&lt;25</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">beta</span><span class="si">:</span><span class="s1">&gt;15.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SUMMARY: &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">sharpe</span> <span class="o">&gt;</span> <span class="n">spy_sharpe</span> <span class="ow">and</span> <span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Portfolio OUTPERFORMED SPY on risk-adjusted basis!&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Portfolio underperformed SPY on risk-adjusted basis.&#39;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Types of Returns</h3>
<ul>
<li><strong>Simple returns:</strong> Intuitive, additive across assets, NOT additive across time</li>
<li><strong>Log returns:</strong> Additive across time, better statistical properties</li>
<li>Use simple for portfolio weights, log for time-series analysis</li>
</ul>
<h3>2. Annualization</h3>
<ul>
<li><strong>Returns:</strong> Compound using (1 + r)^n - 1</li>
<li><strong>Volatility:</strong> Multiply by ‚àön (not n!)</li>
<li>Use 252 for daily stock data, 12 for monthly, etc.</li>
</ul>
<h3>3. Risk-Adjusted Metrics</h3>
<ul>
<li><strong>Sharpe Ratio:</strong> Return per unit of total risk (most popular)</li>
<li><strong>Sortino Ratio:</strong> Return per unit of downside risk</li>
<li><strong>Calmar Ratio:</strong> Return per unit of maximum drawdown</li>
</ul>
<h3>4. Benchmark Comparison</h3>
<ul>
<li><strong>Alpha:</strong> Return above what beta predicts (skill measure)</li>
<li><strong>Beta:</strong> Sensitivity to benchmark movements</li>
<li><strong>Information Ratio:</strong> Risk-adjusted active return vs benchmark</li>
</ul></div>
<div class="md-cell"><h2>Formula Reference</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Metric</th>
<th>Formula</th>
</tr>
</thead>
<tbody>
<tr>
<td>Simple Return</td>
<td>R = P‚ÇÅ/P‚ÇÄ - 1</td>
</tr>
<tr>
<td>Log Return</td>
<td>r = ln(P‚ÇÅ/P‚ÇÄ)</td>
</tr>
<tr>
<td>Annual Return</td>
<td>(1 + daily)^252 - 1</td>
</tr>
<tr>
<td>Annual Vol</td>
<td>daily_vol √ó ‚àö252</td>
</tr>
<tr>
<td>Sharpe</td>
<td>(R - Rf) / œÉ</td>
</tr>
<tr>
<td>Sortino</td>
<td>(R - Rf) / œÉ_downside</td>
</tr>
<tr>
<td>Calmar</td>
<td>Annual Return / Max DD</td>
</tr>
<tr>
<td>Beta</td>
<td>Cov(R, Rm) / Var(Rm)</td>
</tr>
<tr>
<td>Alpha</td>
<td>R - [Rf + Œ≤(Rm - Rf)]</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 3: Time Series Analysis</strong>, we'll explore:
- Stationarity and why it matters
- Autocorrelation in returns
- Moving statistics (rolling, expanding, EWM)
- Volatility clustering and modeling</p>
<hr />
<p><em>Congratulations on completing Module 2! You now have the tools to properly analyze and compare investment performance.</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="3"><div class="md-cell module-header"><h1>Module 3: Time Series Analysis</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 1: Statistical Foundations</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Test for stationarity and understand why it matters</li>
<li>Analyze autocorrelation in financial returns</li>
<li>Apply moving statistics (rolling, expanding, exponential)</li>
<li>Understand and model volatility clustering</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Modules 1-2 (Statistics, Return Analysis)</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-3.1">Section 3.1: Stationarity</a></li>
<li><a href="#section-3.2">Section 3.2: Autocorrelation</a></li>
<li><a href="#section-3.3">Section 3.3: Moving Statistics</a></li>
<li><a href="#section-3.4">Section 3.4: Volatility Modeling</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">adfuller</span><span class="p">,</span> <span class="n">acf</span><span class="p">,</span> <span class="n">pacf</span>
<span class="kn">from</span> <span class="nn">statsmodels.graphics.tsaplots</span> <span class="kn">import</span> <span class="n">plot_acf</span><span class="p">,</span> <span class="n">plot_pacf</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.diagnostic</span> <span class="kn">import</span> <span class="n">acorr_ljungbox</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Libraries loaded successfully!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Financial Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download stock data</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">]</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2019-01-01&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2024-01-01&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Downloading data for </span><span class="si">{</span><span class="n">tickers</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Handle different yfinance column structures</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="c1"># Calculate returns</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prices</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data range: </span><span class="si">{</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trading days: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">prices</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-3.1'></a></p>
<h1>Section 3.1: Stationarity</h1>
<p>Stationarity is a fundamental concept in time series analysis. Most statistical models assume stationarity!</p>
<p><strong>In this section, you will learn:</strong>
- What stationarity means and why it matters
- How to test for stationarity (ADF test)
- How to transform non-stationary data</p></div>
<div class="md-cell"><h2>3.1.1 What is Stationarity?</h2>
<p>A time series is <strong>stationary</strong> if its statistical properties don't change over time:</p>
<ol>
<li><strong>Constant mean:</strong> E[X_t] = Œº for all t</li>
<li><strong>Constant variance:</strong> Var(X_t) = œÉ¬≤ for all t</li>
<li><strong>Covariance depends only on lag:</strong> Cov(X_t, X_{t+k}) depends only on k, not t</li>
</ol>
<p><strong>Why does it matter?</strong>
- Non-stationary data can lead to spurious correlations
- Most forecasting models require stationarity
- Statistical inference assumes constant distributions</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare prices (non-stationary) vs returns (stationary)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">spy_prices</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>
<span class="n">spy_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>

<span class="c1"># Prices</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_prices</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY Prices (Non-Stationary)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>

<span class="c1"># Returns</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY Returns (Stationary)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>

<span class="c1"># Rolling mean of prices</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">rolling_mean_prices</span> <span class="o">=</span> <span class="n">spy_prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_prices</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prices&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_mean_prices</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;60-day Mean&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Prices: Mean Changes Over Time&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Rolling mean of returns</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">rolling_mean_returns</span> <span class="o">=</span> <span class="n">spy_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Returns&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_mean_returns</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;60-day Mean&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Returns: Mean Stays Around Zero&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Notice: Prices have a clear trend (non-stationary).&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Returns fluctuate around zero with no trend (stationary).&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.1.2 Testing for Stationarity: ADF Test</h2>
<p>The <strong>Augmented Dickey-Fuller (ADF) test</strong> is the standard test for stationarity.</p>
<p><strong>Hypotheses:</strong>
- H‚ÇÄ: Series has a unit root (non-stationary)
- H‚ÇÅ: Series is stationary</p>
<p><strong>Interpretation:</strong>
- p-value &lt; 0.05 ‚Üí Reject H‚ÇÄ ‚Üí Series IS stationary
- p-value ‚â• 0.05 ‚Üí Cannot reject H‚ÇÄ ‚Üí Series is NOT stationary</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">test_stationarity</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Series&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform ADF test and print results.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        series: Time series to test</span>
<span class="sd">        name: Name for display</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        True if stationary, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;=== ADF Test: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> ===&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test Statistic: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;p-value:        </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Critical Values:&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Conclusion: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> IS stationary (p &lt; 0.05)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Conclusion: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> is NOT stationary (p &gt;= 0.05)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># Test prices</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Testing SPY Prices...&#39;</span><span class="p">)</span>
<span class="n">test_stationarity</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="s1">&#39;SPY Prices&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Test returns</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Testing SPY Returns...&#39;</span><span class="p">)</span>
<span class="n">test_stationarity</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="s1">&#39;SPY Returns&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.1.3 Making Data Stationary</h2>
<p>Common transformations to achieve stationarity:</p>
<ol>
<li><strong>Differencing:</strong> X_t - X_{t-1} (converts prices to returns)</li>
<li><strong>Log transformation:</strong> ln(X_t) (stabilizes variance)</li>
<li><strong>Log returns:</strong> ln(X_t / X_{t-1}) (combines both)</li>
<li><strong>Detrending:</strong> Remove linear or polynomial trend</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Different transformations</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">spy</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>

<span class="c1"># Original prices</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Prices (Non-Stationary)&#39;</span><span class="p">)</span>

<span class="c1"># First difference</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">spy</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;First Difference (Stationary)&#39;</span><span class="p">)</span>

<span class="c1"># Log prices</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">log_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">spy</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">log_prices</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Log Prices (Still Non-Stationary)&#39;</span><span class="p">)</span>

<span class="c1"># Log returns</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">log_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Log Returns (Stationary)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Test all transformations</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Stationarity Test Results ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="n">transformations</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Original Prices&#39;</span><span class="p">:</span> <span class="n">spy</span><span class="p">,</span>
    <span class="s1">&#39;First Difference&#39;</span><span class="p">:</span> <span class="n">diff</span><span class="p">,</span>
    <span class="s1">&#39;Log Prices&#39;</span><span class="p">:</span> <span class="n">log_prices</span><span class="p">,</span>
    <span class="s1">&#39;Log Returns&#39;</span><span class="p">:</span> <span class="n">log_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">transformations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Stationary&#39;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="k">else</span> <span class="s1">&#39;Non-Stationary&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s1">20</span><span class="si">}</span><span class="s1"> p-value: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> ‚Üí </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 3.1: Test Stationarity (Guided)</h3>
<p><strong>Your Task:</strong> Build a function that tests stationarity for multiple assets and returns a summary DataFrame.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.1: Test Stationarity (Guided)</span>
<span class="k">def</span> <span class="nf">stationarity_summary</span><span class="p">(</span><span class="n">prices_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">returns_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test stationarity for all assets, both prices and returns.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        prices_df: DataFrame of prices</span>
<span class="sd">        returns_df: DataFrame of returns</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Summary DataFrame with test results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">prices_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># TODO: Run ADF test on prices</span>
        <span class="n">price_result</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">prices_df</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        <span class="n">price_pval</span> <span class="o">=</span> <span class="n">price_result</span><span class="p">[</span><span class="n">______</span><span class="p">]</span>
        
        <span class="c1"># TODO: Run ADF test on returns</span>
        <span class="n">return_result</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">returns_df</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">())</span>
        <span class="n">return_pval</span> <span class="o">=</span> <span class="n">return_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Ticker&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
            <span class="s1">&#39;Prices p-value&#39;</span><span class="p">:</span> <span class="n">price_pval</span><span class="p">,</span>
            <span class="s1">&#39;Prices Stationary&#39;</span><span class="p">:</span> <span class="n">price_pval</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;Returns p-value&#39;</span><span class="p">:</span> <span class="n">return_pval</span><span class="p">,</span>
            <span class="s1">&#39;Returns Stationary&#39;</span><span class="p">:</span> <span class="n">return_pval</span> <span class="o">&lt;</span> <span class="n">______</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span>

<span class="c1"># Test your solution</span>
<span class="c1"># summary = stationarity_summary(prices, returns)</span>
<span class="c1"># print(summary)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">stationarity_summary</span><span class="p">(</span><span class="n">prices_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">returns_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test stationarity for all assets, both prices and returns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">prices_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Run ADF test on prices</span>
        <span class="n">price_result</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">prices_df</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        <span class="n">price_pval</span> <span class="o">=</span> <span class="n">price_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Run ADF test on returns</span>
        <span class="n">return_result</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">returns_df</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        <span class="n">return_pval</span> <span class="o">=</span> <span class="n">return_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Ticker&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
            <span class="s1">&#39;Prices p-value&#39;</span><span class="p">:</span> <span class="n">price_pval</span><span class="p">,</span>
            <span class="s1">&#39;Prices Stationary&#39;</span><span class="p">:</span> <span class="n">price_pval</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;Returns p-value&#39;</span><span class="p">:</span> <span class="n">return_pval</span><span class="p">,</span>
            <span class="s1">&#39;Returns Stationary&#39;</span><span class="p">:</span> <span class="n">return_pval</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">stationarity_summary</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Key Finding: All prices are non-stationary, all returns are stationary!&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-3.2'></a></p>
<h1>Section 3.2: Autocorrelation</h1>
<p>Autocorrelation measures how today's value relates to past values. It's key for understanding predictability.</p>
<p><strong>In this section, you will learn:</strong>
- What autocorrelation means
- How to compute and visualize ACF/PACF
- What autocorrelation patterns tell us about markets</p></div>
<div class="md-cell"><h2>3.2.1 Understanding Autocorrelation</h2>
<p><strong>Autocorrelation at lag k:</strong> Correlation between X_t and X_{t-k}</p>
<p>$$\rho_k = \frac{Cov(X_t, X_{t-k})}{Var(X_t)}$$</p>
<p><strong>Interpretation:</strong>
- œÅ_k &gt; 0: Positive values tend to follow positive values (momentum)
- œÅ_k &lt; 0: Positive values tend to follow negative values (mean reversion)
- œÅ_k ‚âà 0: No linear relationship (random/efficient)</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate autocorrelation manually</span>
<span class="n">spy_ret</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=== Manual Autocorrelation Calculation ===&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
    <span class="c1"># Correlation between returns and lagged returns</span>
    <span class="n">autocorr</span> <span class="o">=</span> <span class="n">spy_ret</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">spy_ret</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Lag </span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">autocorr</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Values close to zero suggest returns are roughly independent.&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This is consistent with the Efficient Market Hypothesis!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.2.2 ACF and PACF Plots</h2>
<p><strong>ACF (Autocorrelation Function):</strong> Shows correlation at all lags</p>
<p><strong>PACF (Partial Autocorrelation Function):</strong> Shows correlation at lag k after removing effects of lags 1 to k-1</p>
<p>The blue bands represent 95% confidence intervals. Significant autocorrelations extend beyond the bands.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># ACF and PACF for returns</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># SPY Returns ACF</span>
<span class="n">plot_acf</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY Returns - ACF&#39;</span><span class="p">)</span>

<span class="c1"># SPY Returns PACF</span>
<span class="n">plot_pacf</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY Returns - PACF&#39;</span><span class="p">)</span>

<span class="c1"># SPY Squared Returns ACF (volatility clustering)</span>
<span class="n">plot_acf</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY Squared Returns - ACF (Volatility Clustering)&#39;</span><span class="p">)</span>

<span class="c1"># SPY Absolute Returns ACF</span>
<span class="n">plot_acf</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY Absolute Returns - ACF&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Returns (top): Little autocorrelation - market is efficient&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Squared Returns (bottom): Strong autocorrelation - volatility clusters!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.2.3 Testing for Significant Autocorrelation</h2>
<p>The <strong>Ljung-Box test</strong> checks if there's any significant autocorrelation up to lag k.</p>
<ul>
<li>H‚ÇÄ: No autocorrelation (returns are independent)</li>
<li>H‚ÇÅ: Significant autocorrelation exists</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">ljung_box_test</span><span class="p">(</span><span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">lags</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Series&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform Ljung-Box test for autocorrelation.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        series: Time series to test</span>
<span class="sd">        lags: Number of lags to test</span>
<span class="sd">        name: Name for display</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Test results DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">acorr_ljungbox</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;=== Ljung-Box Test: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> ===&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Testing for autocorrelation up to lag </span><span class="si">{</span><span class="n">lags</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="n">min_pval</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;lb_pvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">significant_lags</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;lb_pvalue&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Minimum p-value: </span><span class="si">{</span><span class="n">min_pval</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Significant lags (p &lt; 0.05): </span><span class="si">{</span><span class="n">significant_lags</span><span class="si">}</span><span class="s1"> out of </span><span class="si">{</span><span class="n">lags</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">min_pval</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Conclusion: Significant autocorrelation detected!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Conclusion: No significant autocorrelation (consistent with EMH)&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Test returns</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- Testing SPY Returns ---&#39;</span><span class="p">)</span>
<span class="n">lb_returns</span> <span class="o">=</span> <span class="n">ljung_box_test</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SPY Returns&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Test squared returns</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- Testing SPY Squared Returns ---&#39;</span><span class="p">)</span>
<span class="n">lb_squared</span> <span class="o">=</span> <span class="n">ljung_box_test</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SPY Squared Returns&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 3.2: Autocorrelation Analysis (Guided)</h3>
<p><strong>Your Task:</strong> Build a function that calculates autocorrelation for both returns and squared returns.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.2: Autocorrelation Analysis (Guided)</span>
<span class="k">def</span> <span class="nf">autocorrelation_analysis</span><span class="p">(</span><span class="n">returns_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">max_lag</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate autocorrelation for returns and squared returns.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns_series: Return series to analyze</span>
<span class="sd">        max_lag: Maximum lag to compute</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with autocorrelations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">squared</span> <span class="o">=</span> <span class="n">returns_series</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_lag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate autocorrelation of returns</span>
        <span class="n">ret_acf</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">returns_series</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">lag</span><span class="p">))</span>
        
        <span class="c1"># TODO: Calculate autocorrelation of squared returns</span>
        <span class="n">sq_acf</span> <span class="o">=</span> <span class="n">squared</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">squared</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">______</span><span class="p">))</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Lag&#39;</span><span class="p">:</span> <span class="n">lag</span><span class="p">,</span>
            <span class="s1">&#39;Returns ACF&#39;</span><span class="p">:</span> <span class="n">ret_acf</span><span class="p">,</span>
            <span class="s1">&#39;Squared Returns ACF&#39;</span><span class="p">:</span> <span class="n">sq_acf</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Lag&#39;</span><span class="p">)</span>

<span class="c1"># Test your solution</span>
<span class="c1"># acf_df = autocorrelation_analysis(returns[&#39;AAPL&#39;])</span>
<span class="c1"># print(acf_df)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">autocorrelation_analysis</span><span class="p">(</span><span class="n">returns_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">max_lag</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate autocorrelation for returns and squared returns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">squared</span> <span class="o">=</span> <span class="n">returns_series</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_lag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Calculate autocorrelation of returns</span>
        <span class="n">ret_acf</span> <span class="o">=</span> <span class="n">returns_series</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">returns_series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">))</span>

        <span class="c1"># Calculate autocorrelation of squared returns</span>
        <span class="n">sq_acf</span> <span class="o">=</span> <span class="n">squared</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">squared</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">))</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Lag&#39;</span><span class="p">:</span> <span class="n">lag</span><span class="p">,</span>
            <span class="s1">&#39;Returns ACF&#39;</span><span class="p">:</span> <span class="n">ret_acf</span><span class="p">,</span>
            <span class="s1">&#39;Squared Returns ACF&#39;</span><span class="p">:</span> <span class="n">sq_acf</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Lag&#39;</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">acf_df</span> <span class="o">=</span> <span class="n">autocorrelation_analysis</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">acf_df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Note: Squared returns have MUCH higher autocorrelation!&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-3.3'></a></p>
<h1>Section 3.3: Moving Statistics</h1>
<p>Moving statistics help us analyze trends and patterns that change over time.</p>
<p><strong>In this section, you will learn:</strong>
- Rolling (moving window) statistics
- Expanding (cumulative) statistics
- Exponentially weighted statistics</p></div>
<div class="md-cell"><h2>3.3.1 Rolling Statistics</h2>
<p><strong>Rolling statistics</strong> use a fixed window that moves through time.</p>
<p>Common applications:
- Rolling mean (moving average)
- Rolling volatility
- Rolling correlation
- Rolling Sharpe ratio</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate rolling statistics for SPY</span>
<span class="n">spy_ret</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>

<span class="c1"># Rolling statistics with different windows</span>
<span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">252</span><span class="p">]</span>  <span class="c1"># 1 month, 3 months, 1 year</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Rolling Mean</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_ret</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Daily Returns&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
    <span class="n">rolling_mean</span> <span class="o">=</span> <span class="n">spy_ret</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_mean</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">-day Mean&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling Mean (Moving Average)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Rolling Volatility (annualized)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
    <span class="n">rolling_vol</span> <span class="o">=</span> <span class="n">spy_ret</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">-day Vol&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling Volatility (Annualized)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Volatility&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.0%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Rolling Sharpe (annualized)</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
    <span class="n">rolling_sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">spy_ret</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">spy_ret</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_sharpe</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">-day Sharpe&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sharpe = 1&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling Sharpe Ratio&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>3.3.2 Expanding Statistics</h2>
<p><strong>Expanding statistics</strong> include all data from the start up to the current point.</p>
<p>Useful for:
- Cumulative performance
- Building samples for statistical tests
- Comparing to "all-time" metrics</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Expanding statistics</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Expanding mean</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">expanding_mean</span> <span class="o">=</span> <span class="n">spy_ret</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">expanding_mean</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Expanding Mean (Annualized)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">spy_ret</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Final Mean&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Expanding Mean Return&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Expanding volatility</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">expanding_vol</span> <span class="o">=</span> <span class="n">spy_ret</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">expanding_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Expanding Vol (Annualized)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">spy_ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Final Vol&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Expanding Volatility&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.0%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Expanding Sharpe</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">expanding_sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">expanding_mean</span> <span class="o">/</span> <span class="n">spy_ret</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">expanding_sharpe</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Expanding Sharpe Ratio&#39;</span><span class="p">)</span>

<span class="c1"># Cumulative return</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">cumulative_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">spy_ret</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cumulative_return</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.0%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>3.3.3 Exponentially Weighted Statistics</h2>
<p><strong>Exponentially weighted</strong> statistics give more weight to recent observations.</p>
<p><strong>Key parameter: span</strong> (or halflife)
- Smaller span = more weight on recent data
- Larger span = smoother, more like simple average</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exponentially weighted statistics</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># EWM Mean vs Rolling Mean</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_ret</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Daily Returns&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_ret</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;20-day Rolling Mean&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_ret</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EWM Mean (span=20)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling Mean vs Exponentially Weighted Mean&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># EWM Volatility vs Rolling Volatility</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">rolling_vol_60</span> <span class="o">=</span> <span class="n">spy_ret</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">ewm_vol_60</span> <span class="o">=</span> <span class="n">spy_ret</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_vol_60</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;60-day Rolling Vol&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ewm_vol_60</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EWM Vol (span=60)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling Volatility vs Exponentially Weighted Volatility&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Volatility&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.0%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EWM reacts faster to recent changes!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 3.3: Rolling Correlation (Guided)</h3>
<p><strong>Your Task:</strong> Build a function that calculates rolling correlation between two assets.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.3: Rolling Correlation (Guided)</span>
<span class="k">def</span> <span class="nf">rolling_correlation</span><span class="p">(</span><span class="n">series1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">series2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                        <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate rolling correlation between two series.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        series1: First return series</span>
<span class="sd">        series2: Second return series</span>
<span class="sd">        window: Rolling window size</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Rolling correlation series</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate rolling correlation</span>
    <span class="n">rolling_corr</span> <span class="o">=</span> <span class="n">series1</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">series2</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">rolling_corr</span>

<span class="k">def</span> <span class="nf">analyze_rolling_correlation</span><span class="p">(</span><span class="n">series1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">series2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                                 <span class="n">name1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze rolling correlation with summary statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rolling_corr</span> <span class="o">=</span> <span class="n">rolling_correlation</span><span class="p">(</span><span class="n">series1</span><span class="p">,</span> <span class="n">series2</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="n">series1</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">series2</span><span class="p">),</span>
        <span class="s1">&#39;rolling_mean&#39;</span><span class="p">:</span> <span class="n">rolling_corr</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;rolling_min&#39;</span><span class="p">:</span> <span class="n">rolling_corr</span><span class="o">.</span><span class="n">______</span><span class="p">(),</span>
        <span class="s1">&#39;rolling_max&#39;</span><span class="p">:</span> <span class="n">rolling_corr</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># stats = analyze_rolling_correlation(returns[&#39;SPY&#39;], returns[&#39;AAPL&#39;], &#39;SPY&#39;, &#39;AAPL&#39;)</span>
<span class="c1"># print(stats)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">rolling_correlation</span><span class="p">(</span><span class="n">series1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">series2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                        <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate rolling correlation between two series.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rolling_corr</span> <span class="o">=</span> <span class="n">series1</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">series2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rolling_corr</span>

<span class="k">def</span> <span class="nf">analyze_rolling_correlation</span><span class="p">(</span><span class="n">series1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">series2</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                                 <span class="n">name1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze rolling correlation with summary statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rolling_corr</span> <span class="o">=</span> <span class="n">rolling_correlation</span><span class="p">(</span><span class="n">series1</span><span class="p">,</span> <span class="n">series2</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="n">series1</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">series2</span><span class="p">),</span>
        <span class="s1">&#39;rolling_mean&#39;</span><span class="p">:</span> <span class="n">rolling_corr</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s1">&#39;rolling_min&#39;</span><span class="p">:</span> <span class="n">rolling_corr</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="s1">&#39;rolling_max&#39;</span><span class="p">:</span> <span class="n">rolling_corr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">analyze_rolling_correlation</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">],</span> <span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-3.4'></a></p>
<h1>Section 3.4: Volatility Modeling</h1>
<p>Volatility clustering is one of the most important stylized facts in finance. This section introduces volatility modeling.</p>
<p><strong>In this section, you will learn:</strong>
- What volatility clustering means
- Simple volatility forecasting methods
- Introduction to GARCH concepts</p></div>
<div class="md-cell"><h2>3.4.1 Visualizing Volatility Clustering</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize volatility clustering</span>
<span class="n">spy_ret</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># Returns</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_ret</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY Returns&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>

<span class="c1"># Absolute returns (volatility proxy)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_ret</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_ret</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;20-day MA&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Absolute Returns (Volatility Proxy)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;|Return|&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Squared returns</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_ret</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">spy_ret</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;20-day MA&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Squared Returns (Variance Proxy)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Return¬≤&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Notice the clustering: periods of high volatility are followed by high volatility!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.4.2 Simple Volatility Forecasting</h2>
<p>Before jumping to complex models, let's try simple approaches:</p>
<ol>
<li><strong>Historical volatility:</strong> Use past realized volatility</li>
<li><strong>EWMA:</strong> Exponentially weighted moving average</li>
<li><strong>Simple persistence:</strong> Tomorrow's vol = today's vol</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate different volatility estimates</span>
<span class="n">window</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># Historical (rolling) volatility</span>
<span class="n">hist_vol</span> <span class="o">=</span> <span class="n">spy_ret</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="c1"># EWMA volatility (RiskMetrics style)</span>
<span class="n">ewma_vol</span> <span class="o">=</span> <span class="n">spy_ret</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">-day Historical Vol&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ewma_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;EWMA Vol (span=</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Volatility Estimates Comparison&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Volatility&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.0%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EWMA responds faster to changes due to exponential weighting.&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.4.3 Introduction to GARCH</h2>
<p><strong>GARCH</strong> (Generalized Autoregressive Conditional Heteroskedasticity) is the standard model for volatility.</p>
<p><strong>GARCH(1,1) Model:</strong></p>
<p>œÉ¬≤_t = œâ + Œ± √ó Œµ¬≤_{t-1} + Œ≤ √ó œÉ¬≤_{t-1}</p>
<p>Where:
- œâ = long-run variance weight
- Œ± = weight on recent shock (yesterday's squared return)
- Œ≤ = weight on recent variance (yesterday's variance)</p>
<p><strong>Interpretation:</strong>
- High Œ±: Volatility reacts strongly to shocks
- High Œ≤: Volatility is persistent
- Œ± + Œ≤ close to 1: High persistence</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">simple_garch_variance</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">omega</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.00001</span><span class="p">,</span> 
                          <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.85</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple GARCH(1,1) variance calculation.</span>
<span class="sd">    </span>
<span class="sd">    sigma2_t = omega + alpha * epsilon2_{t-1} + beta * sigma2_{t-1}</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Return series</span>
<span class="sd">        omega: Long-run variance weight</span>
<span class="sd">        alpha: Weight on recent shock</span>
<span class="sd">        beta: Weight on recent variance</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Variance series</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">sigma2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    
    <span class="c1"># Initialize with sample variance</span>
    <span class="n">sigma2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">sigma2</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">returns</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sigma2</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1"># Calculate GARCH variance</span>
<span class="n">garch_var</span> <span class="o">=</span> <span class="n">simple_garch_variance</span><span class="p">(</span><span class="n">spy_ret</span><span class="p">)</span>
<span class="n">garch_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">garch_var</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>  <span class="c1"># Annualized</span>

<span class="c1"># Plot comparison</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Historical Vol (20-day)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ewma_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EWMA Vol&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">garch_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;GARCH-like Vol&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Volatility Model Comparison&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Volatility&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.0%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GARCH captures volatility clustering and adapts to changing market conditions.&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 3.4: Volatility Forecasting Comparison (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Calculates historical and EWMA volatility forecasts
- Evaluates forecast accuracy using RMSE
- Returns a comparison report</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.4: Volatility Forecasting Comparison (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compare_volatility_forecasts</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare historical and EWMA volatility forecasts.</span>

<span class="sd">    Args:</span>
<span class="sd">        returns: Return series</span>
<span class="sd">        window: Window size for historical vol</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with comparison metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate volatility estimates</span>
    <span class="n">hist_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">ewma_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="c1"># Shift forecasts (use yesterday&#39;s estimate to predict today)</span>
    <span class="n">hist_forecast</span> <span class="o">=</span> <span class="n">hist_vol</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ewma_forecast</span> <span class="o">=</span> <span class="n">ewma_vol</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Realized volatility proxy: absolute return</span>
    <span class="n">realized</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

    <span class="c1"># Calculate RMSE</span>
    <span class="k">def</span> <span class="nf">rmse</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="n">realized</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">forecast</span> <span class="o">-</span> <span class="n">realized</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">diff</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="n">hist_rmse</span> <span class="o">=</span> <span class="n">rmse</span><span class="p">(</span><span class="n">hist_forecast</span><span class="p">,</span> <span class="n">realized</span><span class="p">)</span>
    <span class="n">ewma_rmse</span> <span class="o">=</span> <span class="n">rmse</span><span class="p">(</span><span class="n">ewma_forecast</span><span class="p">,</span> <span class="n">realized</span><span class="p">)</span>

    <span class="c1"># Calculate correlation with realized</span>
    <span class="n">hist_corr</span> <span class="o">=</span> <span class="n">hist_forecast</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">realized</span><span class="p">)</span>
    <span class="n">ewma_corr</span> <span class="o">=</span> <span class="n">ewma_forecast</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">realized</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;hist_rmse&#39;</span><span class="p">:</span> <span class="n">hist_rmse</span><span class="p">,</span>
        <span class="s1">&#39;ewma_rmse&#39;</span><span class="p">:</span> <span class="n">ewma_rmse</span><span class="p">,</span>
        <span class="s1">&#39;hist_corr&#39;</span><span class="p">:</span> <span class="n">hist_corr</span><span class="p">,</span>
        <span class="s1">&#39;ewma_corr&#39;</span><span class="p">:</span> <span class="n">ewma_corr</span><span class="p">,</span>
        <span class="s1">&#39;better_model&#39;</span><span class="p">:</span> <span class="s1">&#39;EWMA&#39;</span> <span class="k">if</span> <span class="n">ewma_rmse</span> <span class="o">&lt;</span> <span class="n">hist_rmse</span> <span class="k">else</span> <span class="s1">&#39;Historical&#39;</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">comparison</span> <span class="o">=</span> <span class="n">compare_volatility_forecasts</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Volatility Forecast Comparison ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Historical RMSE: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;hist_rmse&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EWMA RMSE: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;ewma_rmse&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Historical Correlation: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;hist_corr&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EWMA Correlation: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;ewma_corr&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Better Model: </span><span class="si">{</span><span class="n">comparison</span><span class="p">[</span><span class="s1">&#39;better_model&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 3.5: Crisis Detection Tool (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a tool that:
- Detects high-volatility regimes using rolling volatility
- Identifies crisis periods (volatility &gt; 2 standard deviations above mean)
- Returns dates and duration of crisis periods</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.5: Crisis Detection Tool (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CrisisDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect high-volatility crisis periods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">vol_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">threshold_std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_window</span> <span class="o">=</span> <span class="n">vol_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_std</span> <span class="o">=</span> <span class="n">threshold_std</span>

        <span class="c1"># Calculate rolling volatility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rolling_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">vol_window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

        <span class="c1"># Calculate threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling_vol</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling_vol</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_mean</span> <span class="o">+</span> <span class="n">threshold_std</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_std</span>

    <span class="k">def</span> <span class="nf">detect_crises</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Identify crisis periods.&quot;&quot;&quot;</span>
        <span class="n">is_crisis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling_vol</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>

        <span class="c1"># Find crisis start and end dates</span>
        <span class="n">crisis_changes</span> <span class="o">=</span> <span class="n">is_crisis</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">starts</span> <span class="o">=</span> <span class="n">crisis_changes</span><span class="p">[</span><span class="n">crisis_changes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">ends</span> <span class="o">=</span> <span class="n">crisis_changes</span><span class="p">[</span><span class="n">crisis_changes</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="n">crises</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">starts</span><span class="p">):</span>
            <span class="c1"># Find corresponding end</span>
            <span class="n">possible_ends</span> <span class="o">=</span> <span class="n">ends</span><span class="p">[</span><span class="n">ends</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_ends</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">possible_ends</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
            <span class="n">max_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling_vol</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="n">crises</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Start&#39;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                <span class="s1">&#39;End&#39;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
                <span class="s1">&#39;Duration (days)&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
                <span class="s1">&#39;Max Vol&#39;</span><span class="p">:</span> <span class="n">max_vol</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">crises</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot volatility with crisis highlighting.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rolling_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Rolling Vol&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
                   <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Crisis Threshold (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="c1"># Highlight crisis periods</span>
        <span class="n">is_crisis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling_vol</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rolling_vol</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling_vol</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                        <span class="n">where</span><span class="o">=</span><span class="n">is_crisis</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Crisis Period&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Volatility with Crisis Detection&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Annualized Volatility&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.0%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Test</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">CrisisDetector</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>
<span class="n">crises</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">detect_crises</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Crisis Periods Detected ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">crises</span><span class="p">)</span>
<span class="n">detector</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 3.6: Time Series Analysis Dashboard (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a comprehensive time series analysis class that:
- Tests for stationarity (prices and returns)
- Calculates autocorrelation statistics
- Computes rolling statistics (mean, vol, Sharpe)
- Generates a complete analysis report</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 3.6: Time Series Analysis Dashboard (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TimeSeriesAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive time series analysis tool.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Asset&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">stationarity_test</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Test stationarity for prices and returns.&quot;&quot;&quot;</span>
        <span class="n">price_adf</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        <span class="n">return_adf</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;prices_pvalue&#39;</span><span class="p">:</span> <span class="n">price_adf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;prices_stationary&#39;</span><span class="p">:</span> <span class="n">price_adf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;returns_pvalue&#39;</span><span class="p">:</span> <span class="n">return_adf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;returns_stationary&#39;</span><span class="p">:</span> <span class="n">return_adf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">autocorrelation_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lags</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Test autocorrelation in returns and squared returns.&quot;&quot;&quot;</span>
        <span class="n">lb_returns</span> <span class="o">=</span> <span class="n">acorr_ljungbox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lb_squared</span> <span class="o">=</span> <span class="n">acorr_ljungbox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;returns_min_pvalue&#39;</span><span class="p">:</span> <span class="n">lb_returns</span><span class="p">[</span><span class="s1">&#39;lb_pvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s1">&#39;returns_autocorrelated&#39;</span><span class="p">:</span> <span class="n">lb_returns</span><span class="p">[</span><span class="s1">&#39;lb_pvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;squared_min_pvalue&#39;</span><span class="p">:</span> <span class="n">lb_squared</span><span class="p">[</span><span class="s1">&#39;lb_pvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s1">&#39;squared_autocorrelated&#39;</span><span class="p">:</span> <span class="n">lb_squared</span><span class="p">[</span><span class="s1">&#39;lb_pvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">rolling_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate current rolling statistics.&quot;&quot;&quot;</span>
        <span class="n">rolling_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">rolling_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
        <span class="n">rolling_sharpe</span> <span class="o">=</span> <span class="n">rolling_mean</span> <span class="o">/</span> <span class="n">rolling_vol</span> <span class="k">if</span> <span class="n">rolling_vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;rolling_mean_annual&#39;</span><span class="p">:</span> <span class="n">rolling_mean</span><span class="p">,</span>
            <span class="s1">&#39;rolling_vol_annual&#39;</span><span class="p">:</span> <span class="n">rolling_vol</span><span class="p">,</span>
            <span class="s1">&#39;rolling_sharpe&#39;</span><span class="p">:</span> <span class="n">rolling_sharpe</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive analysis report.&quot;&quot;&quot;</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stationarity_test</span><span class="p">()</span>
        <span class="n">acf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autocorrelation_test</span><span class="p">()</span>
        <span class="n">rolling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling_stats</span><span class="p">()</span>

        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">========================================</span>
<span class="s2">TIME SERIES ANALYSIS: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"></span>
<span class="s2">========================================</span>

<span class="s2">STATIONARITY:</span>
<span class="s2">  Prices:  </span><span class="si">{</span><span class="s1">&#39;Stationary&#39;</span> <span class="k">if</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;prices_stationary&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Non-Stationary&#39;</span><span class="si">}</span><span class="s2"> (p=</span><span class="si">{</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;prices_pvalue&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">  Returns: </span><span class="si">{</span><span class="s1">&#39;Stationary&#39;</span> <span class="k">if</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;returns_stationary&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Non-Stationary&#39;</span><span class="si">}</span><span class="s2"> (p=</span><span class="si">{</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;returns_pvalue&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)</span>

<span class="s2">AUTOCORRELATION:</span>
<span class="s2">  Returns:         </span><span class="si">{</span><span class="s1">&#39;Yes&#39;</span> <span class="k">if</span> <span class="n">acf</span><span class="p">[</span><span class="s1">&#39;returns_autocorrelated&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;No&#39;</span><span class="si">}</span><span class="s2"> (p=</span><span class="si">{</span><span class="n">acf</span><span class="p">[</span><span class="s1">&#39;returns_min_pvalue&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">  Squared Returns: </span><span class="si">{</span><span class="s1">&#39;Yes&#39;</span> <span class="k">if</span> <span class="n">acf</span><span class="p">[</span><span class="s1">&#39;squared_autocorrelated&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;No&#39;</span><span class="si">}</span><span class="s2"> (p=</span><span class="si">{</span><span class="n">acf</span><span class="p">[</span><span class="s1">&#39;squared_min_pvalue&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)</span>

<span class="s2">ROLLING STATS (60-day):</span>
<span class="s2">  Annualized Return: </span><span class="si">{</span><span class="n">rolling</span><span class="p">[</span><span class="s1">&#39;rolling_mean_annual&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  Annualized Vol:    </span><span class="si">{</span><span class="n">rolling</span><span class="p">[</span><span class="s1">&#39;rolling_vol_annual&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"></span>
<span class="s2">  Sharpe Ratio:      </span><span class="si">{</span><span class="n">rolling</span><span class="p">[</span><span class="s1">&#39;rolling_sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"></span>

<span class="s2">========================================</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">report</span>

<span class="c1"># Test</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">TimeSeriesAnalyzer</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;MSFT&#39;</span><span class="p">],</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Complete Time Series Analysis Report</h1>
<p>Create a comprehensive time series analysis for MSFT.</p>
<p><strong>Your Challenge:</strong></p>
<p>Analyze MSFT and produce a report that includes:
1. Stationarity test (prices vs returns)
2. Autocorrelation analysis (returns and squared returns)
3. Rolling statistics (60-day mean, volatility, Sharpe)
4. Volatility forecast comparison (Historical vs EWMA)</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Create a comprehensive time series analysis</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Complete Time Series Analysis for MSFT</span>

<span class="n">msft_prices</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;MSFT&#39;</span><span class="p">]</span>
<span class="n">msft_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;MSFT&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MSFT TIME SERIES ANALYSIS REPORT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># 1. Stationarity Tests</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- 1. STATIONARITY ANALYSIS ---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">price_adf</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">msft_prices</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
<span class="n">return_adf</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">msft_returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prices ADF p-value:  </span><span class="si">{</span><span class="n">price_adf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="s2">&quot;Stationary&quot;</span> <span class="k">if</span> <span class="n">price_adf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="k">else</span> <span class="s2">&quot;Non-Stationary&quot;</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Returns ADF p-value: </span><span class="si">{</span><span class="n">return_adf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="s2">&quot;Stationary&quot;</span> <span class="k">if</span> <span class="n">return_adf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="k">else</span> <span class="s2">&quot;Non-Stationary&quot;</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="c1"># 2. Autocorrelation Analysis</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- 2. AUTOCORRELATION ANALYSIS ---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Returns Autocorrelation (lags 1-5):&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
    <span class="n">acf_val</span> <span class="o">=</span> <span class="n">msft_returns</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">msft_returns</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Lag </span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">acf_val</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Squared Returns Autocorrelation (lags 1-5):&#39;</span><span class="p">)</span>
<span class="n">msft_sq</span> <span class="o">=</span> <span class="n">msft_returns</span> <span class="o">**</span> <span class="mi">2</span>
<span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
    <span class="n">acf_val</span> <span class="o">=</span> <span class="n">msft_sq</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">msft_sq</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">lag</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Lag </span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">acf_val</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Ljung-Box test</span>
<span class="n">lb_returns</span> <span class="o">=</span> <span class="n">acorr_ljungbox</span><span class="p">(</span><span class="n">msft_returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lb_squared</span> <span class="o">=</span> <span class="n">acorr_ljungbox</span><span class="p">(</span><span class="n">msft_sq</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Ljung-Box Test (lag 10):&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Returns p-value:         </span><span class="si">{</span><span class="n">lb_returns</span><span class="p">[</span><span class="s2">&quot;lb_pvalue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Squared Returns p-value: </span><span class="si">{</span><span class="n">lb_squared</span><span class="p">[</span><span class="s2">&quot;lb_pvalue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># 3. Rolling Statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- 3. ROLLING STATISTICS (60-day) ---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">rolling_mean</span> <span class="o">=</span> <span class="n">msft_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">rolling_vol</span> <span class="o">=</span> <span class="n">msft_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">rolling_sharpe</span> <span class="o">=</span> <span class="n">rolling_mean</span> <span class="o">/</span> <span class="n">rolling_vol</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current 60-day Mean Return (Ann): </span><span class="si">{</span><span class="n">rolling_mean</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current 60-day Volatility (Ann):  </span><span class="si">{</span><span class="n">rolling_vol</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current 60-day Sharpe Ratio:      </span><span class="si">{</span><span class="n">rolling_sharpe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># 4. Volatility Comparison</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- 4. VOLATILITY FORECAST COMPARISON ---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">hist_vol</span> <span class="o">=</span> <span class="n">msft_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">ewma_vol</span> <span class="o">=</span> <span class="n">msft_returns</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

<span class="n">realized_var</span> <span class="o">=</span> <span class="n">msft_returns</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">hist_forecast</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist_vol</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">ewma_forecast</span> <span class="o">=</span> <span class="p">(</span><span class="n">ewma_vol</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

<span class="n">hist_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">hist_forecast</span> <span class="o">-</span> <span class="n">realized_var</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">ewma_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">ewma_forecast</span> <span class="o">-</span> <span class="n">realized_var</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Historical Vol RMSE: </span><span class="si">{</span><span class="n">hist_rmse</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;EWMA Vol RMSE:       </span><span class="si">{</span><span class="n">ewma_rmse</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Better Model: </span><span class="si">{</span><span class="s2">&quot;EWMA&quot;</span> <span class="k">if</span> <span class="n">ewma_rmse</span> <span class="o">&lt;</span> <span class="n">hist_rmse</span> <span class="k">else</span> <span class="s2">&quot;Historical&quot;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;END OF REPORT&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Stationarity</h3>
<ul>
<li><strong>Prices are non-stationary:</strong> They trend over time (random walk)</li>
<li><strong>Returns are stationary:</strong> They fluctuate around a constant mean</li>
<li>Always work with returns for statistical modeling</li>
<li>Use the ADF test to formally test stationarity</li>
</ul>
<h3>2. Autocorrelation</h3>
<ul>
<li><strong>Returns have little autocorrelation:</strong> Consistent with market efficiency</li>
<li><strong>Squared returns have strong autocorrelation:</strong> Volatility clustering</li>
<li>Use ACF/PACF plots to visualize correlation structure</li>
<li>Ljung-Box test for formal significance testing</li>
</ul>
<h3>3. Moving Statistics</h3>
<ul>
<li><strong>Rolling:</strong> Fixed window, good for trends</li>
<li><strong>Expanding:</strong> Cumulative, good for overall statistics</li>
<li><strong>EWM:</strong> Weighted toward recent, good for volatility</li>
<li>Window size is a bias-variance tradeoff</li>
</ul>
<h3>4. Volatility Modeling</h3>
<ul>
<li><strong>Volatility clusters:</strong> Big moves follow big moves</li>
<li><strong>EWMA reacts faster</strong> than simple rolling windows</li>
<li><strong>GARCH</strong> is the standard model for volatility</li>
<li>Volatility IS predictable (unlike returns)</li>
</ul></div>
<div class="md-cell"><h2>Key Formulas</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Concept</th>
<th>Formula/Test</th>
</tr>
</thead>
<tbody>
<tr>
<td>Stationarity</td>
<td>ADF test (p &lt; 0.05 = stationary)</td>
</tr>
<tr>
<td>Autocorrelation</td>
<td>œÅ_k = Cov(X_t, X_{t-k}) / Var(X_t)</td>
</tr>
<tr>
<td>Rolling Mean</td>
<td>mean over [t-w, t] window</td>
</tr>
<tr>
<td>Rolling Vol</td>
<td>œÉ_t = std([t-w, t]) √ó ‚àö252</td>
</tr>
<tr>
<td>EWMA Vol</td>
<td>œÉ¬≤_t = ŒªœÉ¬≤_{t-1} + (1-Œª)r¬≤_{t-1}</td>
</tr>
<tr>
<td>GARCH(1,1)</td>
<td>œÉ¬≤_t = œâ + Œ±Œµ¬≤_{t-1} + Œ≤œÉ¬≤_{t-1}</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Part 2: Portfolio Theory</strong>, we'll learn:
- Modern Portfolio Theory (Markowitz)
- Mean-Variance Optimization
- Efficient Frontier
- Capital Asset Pricing Model (CAPM)</p>
<hr />
<p><em>Congratulations on completing Part 1: Statistical Foundations! You now have the statistical toolkit for quantitative finance.</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="4"><div class="md-cell module-header"><h1>Module 4: Modern Portfolio Theory</h1>
<p><strong>Course 3: Quantitative Finance</strong><br />
<strong>Part 2: Portfolio Theory</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Calculate portfolio returns and risk using matrix operations</li>
<li>Understand and quantify the diversification effect</li>
<li>Analyze the risk-return tradeoff</li>
<li>Build and analyze two-asset portfolios</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 3: Time Series Analysis</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-4.1">Section 4.1: Portfolio Returns &amp; Risk</a></li>
<li><a href="#section-4.2">Section 4.2: Diversification</a></li>
<li><a href="#section-4.3">Section 4.3: Risk-Return Tradeoff</a></li>
<li><a href="#section-4.4">Section 4.4: Two-Asset Portfolio Analysis</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Libraries loaded successfully!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download data for a diverse portfolio</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;JNJ&#39;</span><span class="p">,</span> <span class="s1">&#39;XOM&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">]</span>  <span class="c1"># Tech, Healthcare, Energy, Gold</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading portfolio data...&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Handle MultiIndex columns</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="n">prices</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Calculate annualized statistics</span>
<span class="n">annual_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">annual_volatility</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="si">}</span><span class="s2"> trading days&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assets: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-4.1'></a></p>
<h1>Section 4.1: Portfolio Returns &amp; Risk</h1>
<p>In 1952, Harry Markowitz revolutionized finance with Modern Portfolio Theory (MPT). The key insight: <strong>don't put all your eggs in one basket</strong>.</p>
<p><strong>In this section, you will learn:</strong>
- How to calculate portfolio returns as weighted averages
- Why portfolio risk is NOT a weighted average
- The role of the covariance matrix</p></div>
<div class="md-cell"><h2>4.1.1 Portfolio Return Formula</h2>
<p>The portfolio return is the <strong>weighted average</strong> of individual asset returns:</p>
<p>$$R_p = \sum_{i=1}^{n} w_i R_i = w_1 R_1 + w_2 R_2 + ... + w_n R_n$$</p>
<p>Where:
- $R_p$ = Portfolio return
- $w_i$ = Weight of asset $i$
- $R_i$ = Return of asset $i$
- $\sum w_i = 1$ (weights sum to 100%)</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Display individual asset statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Individual Asset Statistics (Annualized)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Expected Return&#39;</span><span class="p">:</span> <span class="n">annual_returns</span><span class="p">,</span>
    <span class="s1">&#39;Volatility&#39;</span><span class="p">:</span> <span class="n">annual_volatility</span><span class="p">,</span>
    <span class="s1">&#39;Sharpe (rf=0)&#39;</span><span class="p">:</span> <span class="n">annual_returns</span> <span class="o">/</span> <span class="n">annual_volatility</span>
<span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stats_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Create an equal-weighted portfolio</span>
<span class="n">equal_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">n_assets</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_assets</span><span class="p">)</span>

<span class="c1"># Portfolio expected return (weighted average)</span>
<span class="n">portfolio_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">equal_weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Equal-weighted portfolio: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">equal_weights</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Portfolio Expected Return: </span><span class="si">{</span><span class="n">portfolio_return</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">portfolio_return</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

<span class="c1"># Naive expectation of volatility (weighted average - WRONG!)</span>
<span class="n">naive_volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">equal_weights</span><span class="p">,</span> <span class="n">annual_volatility</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Naive Portfolio Volatility (weighted avg): </span><span class="si">{</span><span class="n">naive_volatility</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">naive_volatility</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>4.1.2 Portfolio Risk Formula</h2>
<p><strong>Portfolio risk is NOT a simple weighted average!</strong> It depends on how assets move together (covariance):</p>
<p>$$\sigma_p^2 = \sum_{i=1}^{n} \sum_{j=1}^{n} w_i w_j \sigma_{ij}$$</p>
<p>Or in matrix notation:</p>
<p>$$\sigma_p^2 = \mathbf{w}^T \Sigma \mathbf{w}$$</p>
<p>Where:
- $\sigma_p^2$ = Portfolio variance
- $\Sigma$ = Covariance matrix
- $\mathbf{w}$ = Weight vector</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Display the covariance matrix</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Annualized Covariance Matrix&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cov_matrix</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate TRUE portfolio volatility using matrix math</span>
<span class="n">portfolio_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">equal_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">equal_weights</span><span class="p">))</span>
<span class="n">portfolio_volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portfolio Risk Calculation&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;True Portfolio Volatility: </span><span class="si">{</span><span class="n">portfolio_volatility</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">portfolio_volatility</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Naive (weighted avg):      </span><span class="si">{</span><span class="n">naive_volatility</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">naive_volatility</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Risk Reduction from Diversification: </span><span class="si">{</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">portfolio_volatility</span><span class="o">/</span><span class="n">naive_volatility</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 4.1: Calculate Custom Portfolio Statistics (Guided)</h3>
<p><strong>Your Task:</strong> Create a custom portfolio with weights [30%, 25%, 20%, 15%, 10%] and calculate its return and volatility.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.1: Calculate Custom Portfolio Statistics (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_portfolio_stats</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                              <span class="n">expected_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                              <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate portfolio return and volatility.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate portfolio return using dot product</span>
    <span class="n">port_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">expected_returns</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate portfolio variance using matrix multiplication</span>
    <span class="n">port_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>
    
    <span class="c1"># TODO: Calculate portfolio volatility (standard deviation)</span>
    <span class="n">port_volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">port_variance</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">port_return</span><span class="p">,</span>
        <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">port_volatility</span><span class="p">,</span>
        <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">port_return</span> <span class="o">/</span> <span class="n">port_volatility</span>
    <span class="p">}</span>

<span class="c1"># Test with custom weights</span>
<span class="c1"># custom_weights = np.array([0.30, 0.25, 0.20, 0.15, 0.10])</span>
<span class="c1"># stats = calculate_portfolio_stats(custom_weights, annual_returns, cov_matrix)</span>
<span class="c1"># print(f&quot;Return: {stats[&#39;return&#39;]*100:.2f}%, Volatility: {stats[&#39;volatility&#39;]*100:.2f}%&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_portfolio_stats</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                              <span class="n">expected_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                              <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate portfolio return and volatility.&quot;&quot;&quot;</span>
    <span class="n">port_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">expected_returns</span><span class="p">)</span>
    <span class="n">port_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>
    <span class="n">port_volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">port_variance</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">port_return</span><span class="p">,</span>
        <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">port_volatility</span><span class="p">,</span>
        <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">port_return</span> <span class="o">/</span> <span class="n">port_volatility</span>
    <span class="p">}</span>

<span class="n">custom_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">])</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">calculate_portfolio_stats</span><span class="p">(</span><span class="n">custom_weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%, Volatility: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-4.2'></a></p>
<h1>Section 4.2: Diversification</h1>
<p>Diversification is the "only free lunch in finance" - you can reduce risk <strong>without</strong> reducing expected return.</p>
<p><strong>In this section, you will learn:</strong>
- The role of correlation in diversification
- How risk decreases as we add more assets
- The difference between systematic and idiosyncratic risk</p></div>
<div class="md-cell"><h2>4.2.1 The Role of Correlation</h2>
<p>Diversification benefits depend on <strong>correlation</strong> between assets:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Correlation</th>
<th>Diversification Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td>œÅ = +1</td>
<td>None (assets move perfectly together)</td>
</tr>
<tr>
<td>œÅ = 0</td>
<td>Good (assets move independently)</td>
</tr>
<tr>
<td>œÅ = -1</td>
<td>Perfect (can eliminate all risk!)</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate and visualize correlation matrix</span>
<span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Correlation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Asset Correlation Matrix&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>4.2.2 Diversification by Number of Assets</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate diversification effect</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">n_simulations</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">asset_counts</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_assets</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">avg_volatilities</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">asset_counts</span><span class="p">:</span>
    <span class="n">volatilities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_assets</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)</span>
        <span class="n">w</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">)))</span>
        <span class="n">volatilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>
    <span class="n">avg_volatilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">volatilities</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">asset_counts</span><span class="p">,</span> <span class="n">avg_volatilities</span><span class="p">,</span> <span class="s1">&#39;bo-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">avg_volatilities</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Fully diversified: </span><span class="si">{</span><span class="n">avg_volatilities</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">annual_volatility</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Avg single asset: </span><span class="si">{</span><span class="n">annual_volatility</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Assets&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average Portfolio Volatility&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Diversification Effect&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>4.2.3 Systematic vs. Idiosyncratic Risk</h2>
<p>Diversification can only eliminate <strong>idiosyncratic (unsystematic) risk</strong>‚Äîthe risk specific to individual assets.</p>
<p><strong>Systematic risk</strong> (market risk) cannot be diversified away because it affects all assets.</p>
<p>$$\text{Total Risk} = \text{Systematic Risk} + \text{Idiosyncratic Risk}$$</p></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 4.2: Find Best Diversification Pairs (Guided)</h3>
<p><strong>Your Task:</strong> Loop through all asset pairs and find the 50/50 portfolio with the lowest volatility.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.2: Find Best Diversification Pairs (Guided)</span>
<span class="k">def</span> <span class="nf">find_best_pair</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">tickers</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find the two-asset 50/50 portfolio with lowest volatility.&quot;&quot;&quot;</span>
    <span class="n">best_pair</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_volatility</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)):</span>
            <span class="c1"># TODO: Get returns for the pair</span>
            <span class="n">pair_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[[</span><span class="n">tickers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tickers</span><span class="p">[</span><span class="n">______</span><span class="p">]]]</span>
            
            <span class="c1"># Calculate annualized covariance</span>
            <span class="n">pair_cov</span> <span class="o">=</span> <span class="n">pair_returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
            
            <span class="c1"># 50/50 weights</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
            
            <span class="c1"># TODO: Calculate portfolio volatility</span>
            <span class="n">port_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">pair_cov</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>
            
            <span class="k">if</span> <span class="n">port_vol</span> <span class="o">&lt;</span> <span class="n">best_volatility</span><span class="p">:</span>
                <span class="n">best_volatility</span> <span class="o">=</span> <span class="n">port_vol</span>
                <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">tickers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tickers</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">best_pair</span><span class="p">,</span> <span class="n">best_volatility</span>

<span class="c1"># Test</span>
<span class="c1"># pair, vol = find_best_pair(returns, tickers)</span>
<span class="c1"># print(f&quot;Best pair: {pair}, Volatility: {vol*100:.2f}%&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">find_best_pair</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">tickers</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find the two-asset 50/50 portfolio with lowest volatility.&quot;&quot;&quot;</span>
    <span class="n">best_pair</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_volatility</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)):</span>
            <span class="n">pair_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[[</span><span class="n">tickers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tickers</span><span class="p">[</span><span class="n">j</span><span class="p">]]]</span>
            <span class="n">pair_cov</span> <span class="o">=</span> <span class="n">pair_returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
            <span class="n">port_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pair_cov</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">port_vol</span> <span class="o">&lt;</span> <span class="n">best_volatility</span><span class="p">:</span>
                <span class="n">best_volatility</span> <span class="o">=</span> <span class="n">port_vol</span>
                <span class="n">best_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">tickers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tickers</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">best_pair</span><span class="p">,</span> <span class="n">best_volatility</span>

<span class="n">pair</span><span class="p">,</span> <span class="n">vol</span> <span class="o">=</span> <span class="n">find_best_pair</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">tickers</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best pair: </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">, Volatility: </span><span class="si">{</span><span class="n">vol</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 4.3: Correlation Impact Analysis (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Takes two assets and simulates different correlation values (-1 to +1)
- Calculates the minimum achievable portfolio volatility for each correlation
- Returns a DataFrame showing the relationship between correlation and minimum risk</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.3: Correlation Impact Analysis (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">correlation_impact_analysis</span><span class="p">(</span><span class="n">vol_a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">vol_b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                <span class="n">ret_a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ret_b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze how correlation affects minimum portfolio risk.&quot;&quot;&quot;</span>
    <span class="n">correlations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">corr</span> <span class="ow">in</span> <span class="n">correlations</span><span class="p">:</span>
        <span class="c1"># Analytical minimum variance weight for asset A</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="n">vol_b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">vol_a</span> <span class="o">*</span> <span class="n">vol_b</span> <span class="o">*</span> <span class="n">corr</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">vol_a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vol_b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vol_a</span> <span class="o">*</span> <span class="n">vol_b</span> <span class="o">*</span> <span class="n">corr</span>

        <span class="k">if</span> <span class="n">denominator</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">w_a</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>
            <span class="n">w_a</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">w_a</span><span class="p">))</span>  <span class="c1"># Bound to [0, 1]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w_a</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="n">w_b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w_a</span>

        <span class="c1"># Calculate portfolio volatility</span>
        <span class="n">var</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_a</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vol_a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">w_b</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vol_b</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
               <span class="mi">2</span> <span class="o">*</span> <span class="n">w_a</span> <span class="o">*</span> <span class="n">w_b</span> <span class="o">*</span> <span class="n">vol_a</span> <span class="o">*</span> <span class="n">vol_b</span> <span class="o">*</span> <span class="n">corr</span><span class="p">)</span>
        <span class="n">min_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Correlation&#39;</span><span class="p">:</span> <span class="n">corr</span><span class="p">,</span>
            <span class="s1">&#39;Weight_A&#39;</span><span class="p">:</span> <span class="n">w_a</span><span class="p">,</span>
            <span class="s1">&#39;Min_Volatility&#39;</span><span class="p">:</span> <span class="n">min_vol</span><span class="p">,</span>
            <span class="s1">&#39;Risk_Reduction&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">min_vol</span> <span class="o">/</span> <span class="p">((</span><span class="n">vol_a</span> <span class="o">+</span> <span class="n">vol_b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Test with AAPL and GLD</span>
<span class="n">analysis</span> <span class="o">=</span> <span class="n">correlation_impact_analysis</span><span class="p">(</span>
    <span class="n">annual_volatility</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">],</span> <span class="n">annual_volatility</span><span class="p">[</span><span class="s1">&#39;GLD&#39;</span><span class="p">],</span>
    <span class="n">annual_returns</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">],</span> <span class="n">annual_returns</span><span class="p">[</span><span class="s1">&#39;GLD&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-4.3'></a></p>
<h1>Section 4.3: The Risk-Return Tradeoff</h1>
<p>In finance, there's a fundamental relationship: <strong>higher expected returns require taking more risk</strong>.</p>
<p><strong>In this section, you will learn:</strong>
- How to visualize the risk-return space
- The concept of dominated portfolios
- Finding optimal portfolios through random sampling</p></div>
<div class="md-cell"><h2>4.3.1 Visualizing Risk-Return Space</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate random portfolios</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">n_portfolios</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="n">portfolio_returns_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">portfolio_volatilities_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">portfolio_sharpes_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">portfolio_weights_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_portfolios</span><span class="p">):</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">)</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">/</span> <span class="n">vol</span>
    
    <span class="n">portfolio_returns_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="n">portfolio_volatilities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>
    <span class="n">portfolio_sharpes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sharpe</span><span class="p">)</span>
    <span class="n">portfolio_weights_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Plot risk-return space</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">portfolio_volatilities_list</span><span class="p">,</span> <span class="n">portfolio_returns_list</span><span class="p">,</span>
                     <span class="n">c</span><span class="o">=</span><span class="n">portfolio_sharpes_list</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">)</span>

<span class="c1"># Individual assets</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">annual_volatility</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">annual_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span>
               <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="p">(</span><span class="n">annual_volatility</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">annual_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]),</span>
                <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="c1"># Equal-weighted portfolio</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">portfolio_volatility</span><span class="p">,</span> <span class="n">portfolio_return</span><span class="p">,</span>
           <span class="n">s</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Equal-Weighted&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Volatility (Risk)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Expected Return&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Risk-Return Space: Individual Assets and Random Portfolios&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Find best portfolios from random sampling</span>
<span class="n">max_sharpe_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">portfolio_sharpes_list</span><span class="p">)</span>
<span class="n">min_vol_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">portfolio_volatilities_list</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Notable Portfolios from Random Sampling&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Maximum Sharpe Ratio Portfolio:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Return: </span><span class="si">{</span><span class="n">portfolio_returns_list</span><span class="p">[</span><span class="n">max_sharpe_idx</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">portfolio_volatilities_list</span><span class="p">[</span><span class="n">max_sharpe_idx</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe: </span><span class="si">{</span><span class="n">portfolio_sharpes_list</span><span class="p">[</span><span class="n">max_sharpe_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Minimum Volatility Portfolio:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Return: </span><span class="si">{</span><span class="n">portfolio_returns_list</span><span class="p">[</span><span class="n">min_vol_idx</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">portfolio_volatilities_list</span><span class="p">[</span><span class="n">min_vol_idx</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe: </span><span class="si">{</span><span class="n">portfolio_sharpes_list</span><span class="p">[</span><span class="n">min_vol_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 4.4: Risk Contribution Analysis (Guided)</h3>
<p><strong>Your Task:</strong> Calculate the marginal and percentage risk contribution of each asset in a portfolio.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.4: Risk Contribution Analysis (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_risk_contribution</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                                <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate risk contribution of each asset.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate portfolio volatility</span>
    <span class="n">port_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>
    
    <span class="c1"># TODO: Calculate marginal contribution to risk (MCR)</span>
    <span class="n">mcr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Calculate component contribution to risk (CCR)</span>
    <span class="n">ccr</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">______</span>
    
    <span class="c1"># Percentage contribution</span>
    <span class="n">pcr</span> <span class="o">=</span> <span class="n">ccr</span> <span class="o">/</span> <span class="n">port_vol</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Weight&#39;</span><span class="p">:</span> <span class="n">weights</span><span class="p">,</span>
        <span class="s1">&#39;Marginal_Risk&#39;</span><span class="p">:</span> <span class="n">mcr</span><span class="p">,</span>
        <span class="s1">&#39;Component_Risk&#39;</span><span class="p">:</span> <span class="n">ccr</span><span class="p">,</span>
        <span class="s1">&#39;Pct_of_Risk&#39;</span><span class="p">:</span> <span class="n">pcr</span>
    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">cov_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="c1"># risk_contrib = calculate_risk_contribution(equal_weights, cov_matrix)</span>
<span class="c1"># print(risk_contrib)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_risk_contribution</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                                <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate risk contribution of each asset.&quot;&quot;&quot;</span>
    <span class="n">port_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>
    <span class="n">mcr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">port_vol</span>
    <span class="n">ccr</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">mcr</span>
    <span class="n">pcr</span> <span class="o">=</span> <span class="n">ccr</span> <span class="o">/</span> <span class="n">port_vol</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Weight&#39;</span><span class="p">:</span> <span class="n">weights</span><span class="p">,</span>
        <span class="s1">&#39;Marginal_Risk&#39;</span><span class="p">:</span> <span class="n">mcr</span><span class="p">,</span>
        <span class="s1">&#39;Component_Risk&#39;</span><span class="p">:</span> <span class="n">ccr</span><span class="p">,</span>
        <span class="s1">&#39;Pct_of_Risk&#39;</span><span class="p">:</span> <span class="n">pcr</span>
    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">cov_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="n">risk_contrib</span> <span class="o">=</span> <span class="n">calculate_risk_contribution</span><span class="p">(</span><span class="n">equal_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">risk_contrib</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-4.4'></a></p>
<h1>Section 4.4: Two-Asset Portfolio Analysis</h1>
<p>Before tackling complex multi-asset portfolios, let's build intuition with just two assets.</p>
<p><strong>In this section, you will learn:</strong>
- The two-asset portfolio formulas
- How to find the minimum variance portfolio analytically
- The effect of correlation on the portfolio frontier</p></div>
<div class="md-cell"><h2>4.4.1 Two-Asset Portfolio Formulas</h2>
<p>For a portfolio of assets A and B:</p>
<p><strong>Return:</strong> $R_p = w_A R_A + (1-w_A) R_B$</p>
<p><strong>Variance:</strong> $\sigma_p^2 = w_A^2 \sigma_A^2 + w_B^2 \sigma_B^2 + 2 w_A w_B \sigma_A \sigma_B \rho_{AB}$</p>
<p><strong>Minimum Variance Weight:</strong>
$$w_A^* = \frac{\sigma_B^2 - \sigma_A \sigma_B \rho_{AB}}{\sigma_A^2 + \sigma_B^2 - 2\sigma_A \sigma_B \rho_{AB}}$$</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Two-asset analysis: AAPL vs GLD</span>
<span class="n">asset_a</span><span class="p">,</span> <span class="n">asset_b</span> <span class="o">=</span> <span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span>
<span class="n">ret_a</span> <span class="o">=</span> <span class="n">annual_returns</span><span class="p">[</span><span class="n">asset_a</span><span class="p">]</span>
<span class="n">ret_b</span> <span class="o">=</span> <span class="n">annual_returns</span><span class="p">[</span><span class="n">asset_b</span><span class="p">]</span>
<span class="n">vol_a</span> <span class="o">=</span> <span class="n">annual_volatility</span><span class="p">[</span><span class="n">asset_a</span><span class="p">]</span>
<span class="n">vol_b</span> <span class="o">=</span> <span class="n">annual_volatility</span><span class="p">[</span><span class="n">asset_b</span><span class="p">]</span>
<span class="n">corr_ab</span> <span class="o">=</span> <span class="n">corr_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">asset_a</span><span class="p">,</span> <span class="n">asset_b</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Two-Asset Analysis: </span><span class="si">{</span><span class="n">asset_a</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">asset_b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">asset_a</span><span class="si">}</span><span class="s2">: Return=</span><span class="si">{</span><span class="n">ret_a</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%, Vol=</span><span class="si">{</span><span class="n">vol_a</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_b</span><span class="si">}</span><span class="s2">: Return=</span><span class="si">{</span><span class="n">ret_b</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%, Vol=</span><span class="si">{</span><span class="n">vol_b</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation: </span><span class="si">{</span><span class="n">corr_ab</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate portfolios across weight combinations</span>
<span class="n">weights_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">port_returns_2asset</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">port_vols_2asset</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">w_a</span> <span class="ow">in</span> <span class="n">weights_a</span><span class="p">:</span>
    <span class="n">w_b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w_a</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">w_a</span> <span class="o">*</span> <span class="n">ret_a</span> <span class="o">+</span> <span class="n">w_b</span> <span class="o">*</span> <span class="n">ret_b</span>
    <span class="n">var</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_a</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vol_a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">w_b</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vol_b</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
           <span class="mi">2</span> <span class="o">*</span> <span class="n">w_a</span> <span class="o">*</span> <span class="n">w_b</span> <span class="o">*</span> <span class="n">vol_a</span> <span class="o">*</span> <span class="n">vol_b</span> <span class="o">*</span> <span class="n">corr_ab</span><span class="p">)</span>
    <span class="n">port_returns_2asset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="n">port_vols_2asset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

<span class="c1"># Find minimum variance</span>
<span class="n">min_var_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">port_vols_2asset</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Plot two-asset frontier</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">port_vols_2asset</span><span class="p">,</span> <span class="n">port_returns_2asset</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Portfolio Combinations&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">vol_a</span><span class="p">,</span> <span class="n">ret_a</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> 
           <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">asset_a</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">vol_b</span><span class="p">,</span> <span class="n">ret_b</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> 
           <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">asset_b</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">port_vols_2asset</span><span class="p">[</span><span class="n">min_var_idx</span><span class="p">],</span> <span class="n">port_returns_2asset</span><span class="p">[</span><span class="n">min_var_idx</span><span class="p">],</span>
           <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
           <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Min Var (</span><span class="si">{</span><span class="n">weights_a</span><span class="p">[</span><span class="n">min_var_idx</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">% </span><span class="si">{</span><span class="n">asset_a</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Volatility (Risk)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Expected Return&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Two-Asset Portfolio: </span><span class="si">{</span><span class="n">asset_a</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">asset_b</span><span class="si">}</span><span class="se">\n</span><span class="s1">(Correlation: </span><span class="si">{</span><span class="n">corr_ab</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> 
          <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 4.5: Analytical Minimum Variance (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Takes two asset volatilities and their correlation
- Calculates the optimal weight for minimum variance using the analytical formula
- Returns the optimal weights and the resulting portfolio volatility</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.5: Analytical Minimum Variance (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analytical_min_variance</span><span class="p">(</span><span class="n">vol_a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">vol_b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                            <span class="n">correlation</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate minimum variance portfolio weights analytically.</span>

<span class="sd">    Args:</span>
<span class="sd">        vol_a: Volatility of asset A</span>
<span class="sd">        vol_b: Volatility of asset B</span>
<span class="sd">        correlation: Correlation between A and B</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with optimal weights and portfolio volatility</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numerator</span> <span class="o">=</span> <span class="n">vol_b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">vol_a</span> <span class="o">*</span> <span class="n">vol_b</span> <span class="o">*</span> <span class="n">correlation</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">vol_a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vol_b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vol_a</span> <span class="o">*</span> <span class="n">vol_b</span> <span class="o">*</span> <span class="n">correlation</span>

    <span class="k">if</span> <span class="n">denominator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">w_a</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w_a</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>

    <span class="n">w_b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w_a</span>

    <span class="c1"># Calculate portfolio volatility</span>
    <span class="n">port_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_a</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vol_a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">w_b</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vol_b</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                <span class="mi">2</span> <span class="o">*</span> <span class="n">w_a</span> <span class="o">*</span> <span class="n">w_b</span> <span class="o">*</span> <span class="n">vol_a</span> <span class="o">*</span> <span class="n">vol_b</span> <span class="o">*</span> <span class="n">correlation</span><span class="p">)</span>
    <span class="n">port_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">port_var</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;weight_a&#39;</span><span class="p">:</span> <span class="n">w_a</span><span class="p">,</span>
        <span class="s1">&#39;weight_b&#39;</span><span class="p">:</span> <span class="n">w_b</span><span class="p">,</span>
        <span class="s1">&#39;portfolio_volatility&#39;</span><span class="p">:</span> <span class="n">port_vol</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">analytical_min_variance</span><span class="p">(</span><span class="n">vol_a</span><span class="p">,</span> <span class="n">vol_b</span><span class="p">,</span> <span class="n">corr_ab</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal weight A: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;weight_a&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal weight B: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;weight_b&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Min portfolio vol: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;portfolio_volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 4.6: Complete Portfolio Analyzer (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a <code>PortfolioAnalyzer</code> class that:
- Takes a list of tickers and downloads data
- Calculates all individual asset statistics
- Computes correlation and covariance matrices
- Generates random portfolios and finds the best ones
- Provides a summary method that displays all key metrics</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 4.6: Complete Portfolio Analyzer (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PortfolioAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive portfolio analysis tool.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tickers</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="o">=</span> <span class="n">tickers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">(</span><span class="n">years</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_statistics</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download and prepare price data.&quot;&quot;&quot;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">years</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calculate_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate all statistics.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annual_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annual_volatility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">portfolio_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate portfolio statistics.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">annual_returns</span><span class="p">)</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">ret</span> <span class="o">/</span> <span class="n">vol</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">find_optimal_portfolios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find optimal portfolios through random sampling.&quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

        <span class="n">best_sharpe</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">}</span>
        <span class="n">min_vol</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_stats</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>

            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_sharpe</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]:</span>
                <span class="n">best_sharpe</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_vol</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]:</span>
                <span class="n">min_vol</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;max_sharpe&#39;</span><span class="p">:</span> <span class="n">best_sharpe</span><span class="p">,</span> <span class="s1">&#39;min_volatility&#39;</span><span class="p">:</span> <span class="n">min_vol</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display comprehensive summary.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PORTFOLIO ANALYZER SUMMARY&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Asset Statistics:&quot;</span><span class="p">)</span>
        <span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annual_returns</span><span class="p">,</span>
            <span class="s1">&#39;Volatility&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annual_volatility</span><span class="p">,</span>
            <span class="s1">&#39;Sharpe&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annual_returns</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">annual_volatility</span>
        <span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">stats_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

        <span class="n">optimal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_optimal_portfolios</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimal Portfolios:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">optimal</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Return: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">PortfolioAnalyzer</span><span class="p">([</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;JNJ&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">])</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Build Your Own Diversified Portfolio</h1>
<p>Apply everything you've learned to construct and analyze a diversified portfolio.</p>
<p><strong>Your Challenge:</strong></p>
<p>Build a complete portfolio analysis that:
1. Creates a custom portfolio with your chosen weights
2. Calculates all risk and return metrics
3. Compares to individual assets and equal-weighted benchmark
4. Analyzes risk contribution by asset
5. Visualizes the results</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Complete Portfolio Analysis Project</span>

<span class="c1"># Step 1: Define custom portfolio</span>
<span class="n">my_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;My Portfolio Allocation&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">my_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="c1"># Step 2: Calculate statistics</span>
<span class="n">my_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">my_weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">)</span>
<span class="n">my_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">my_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">my_weights</span><span class="p">))</span>
<span class="n">my_volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">my_variance</span><span class="p">)</span>
<span class="n">my_sharpe</span> <span class="o">=</span> <span class="n">my_return</span> <span class="o">/</span> <span class="n">my_volatility</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Portfolio Statistics&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Return: </span><span class="si">{</span><span class="n">my_return</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">my_volatility</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe: </span><span class="si">{</span><span class="n">my_sharpe</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Step 3: Compare to benchmarks</span>
<span class="n">comparison</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;My Portfolio&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">my_return</span><span class="p">,</span> <span class="n">my_volatility</span><span class="p">,</span> <span class="n">my_sharpe</span><span class="p">],</span>
    <span class="s1">&#39;Equal-Weighted&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">portfolio_return</span><span class="p">,</span> <span class="n">portfolio_volatility</span><span class="p">,</span> <span class="n">portfolio_return</span><span class="o">/</span><span class="n">portfolio_volatility</span><span class="p">]</span>
<span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;Sharpe&#39;</span><span class="p">])</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">comparison</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">annual_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> 
                         <span class="n">annual_volatility</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> 
                         <span class="n">annual_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">/</span><span class="n">annual_volatility</span><span class="p">[</span><span class="n">ticker</span><span class="p">]]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="c1"># Step 4: Risk contribution</span>
<span class="n">mcr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">my_weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">my_volatility</span>
<span class="n">ccr</span> <span class="o">=</span> <span class="n">my_weights</span> <span class="o">*</span> <span class="n">mcr</span>
<span class="n">pcr</span> <span class="o">=</span> <span class="n">ccr</span> <span class="o">/</span> <span class="n">my_volatility</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Risk Contribution&quot;</span><span class="p">)</span>
<span class="n">risk_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Weight&#39;</span><span class="p">:</span> <span class="n">my_weights</span><span class="p">,</span>
    <span class="s1">&#39;Pct_Risk&#39;</span><span class="p">:</span> <span class="n">pcr</span>
<span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">tickers</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">risk_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># Step 5: Visualization</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">my_weights</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Weight Allocation&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">pcr</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Risk Contribution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Portfolio Returns</h3>
<ul>
<li>Portfolio return is the weighted average of asset returns</li>
<li>Formula: $R_p = \sum w_i R_i$</li>
</ul>
<h3>2. Portfolio Risk</h3>
<ul>
<li>Portfolio risk is NOT a weighted average</li>
<li>Depends on covariances between assets</li>
<li>Formula: $\sigma_p^2 = \mathbf{w}^T \Sigma \mathbf{w}$</li>
</ul>
<h3>3. Diversification</h3>
<ul>
<li>Lower correlation = better diversification</li>
<li>Can only eliminate idiosyncratic risk, not systematic risk</li>
<li>The "only free lunch" in finance</li>
</ul>
<h3>4. Two-Asset Portfolios</h3>
<ul>
<li>Analytical solutions exist for minimum variance</li>
<li>Correlation determines the shape of the frontier</li>
</ul>
<h2>Key Formulas</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Metric</th>
<th>Formula</th>
</tr>
</thead>
<tbody>
<tr>
<td>Portfolio Return</td>
<td>$R_p = \sum w_i R_i$</td>
</tr>
<tr>
<td>Portfolio Variance</td>
<td>$\sigma_p^2 = \mathbf{w}^T \Sigma \mathbf{w}$</td>
</tr>
<tr>
<td>Min Variance Weight</td>
<td>$w_A^* = \frac{\sigma_B^2 - \sigma_A\sigma_B\rho}{\sigma_A^2 + \sigma_B^2 - 2\sigma_A\sigma_B\rho}$</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 5: Mean-Variance Optimization</strong>, we'll learn how to find the <strong>optimal</strong> portfolio weights using mathematical optimization.</p>
<hr />
<p><em>Congratulations on completing Module 4!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="5"><div class="md-cell module-header"><h1>Module 5: Mean-Variance Optimization</h1>
<p><strong>Course 3: Quantitative Finance</strong><br />
<strong>Part 2: Portfolio Theory</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Formulate portfolio optimization as a mathematical problem</li>
<li>Implement optimization using scipy</li>
<li>Apply realistic constraints (long-only, position limits)</li>
<li>Find optimal portfolios for different objectives</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 4: Modern Portfolio Theory</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-5.1">Section 5.1: The Optimization Problem</a></li>
<li><a href="#section-5.2">Section 5.2: Solving with Scipy</a></li>
<li><a href="#section-5.3">Section 5.3: Portfolio Constraints</a></li>
<li><a href="#section-5.4">Section 5.4: Target Return &amp; Risk</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Libraries loaded successfully!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download data for portfolio optimization</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;JNJ&#39;</span><span class="p">,</span> <span class="s1">&#39;JPM&#39;</span><span class="p">,</span> <span class="s1">&#39;XOM&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">]</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading portfolio data...&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Handle MultiIndex columns</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="n">prices</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Calculate annualized statistics</span>
<span class="n">annual_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">annual_volatility</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="si">}</span><span class="s2"> trading days&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assets: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Display asset statistics</span>
<span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Expected Return&#39;</span><span class="p">:</span> <span class="n">annual_returns</span><span class="p">,</span>
    <span class="s1">&#39;Volatility&#39;</span><span class="p">:</span> <span class="n">annual_volatility</span><span class="p">,</span>
    <span class="s1">&#39;Sharpe (rf=0)&#39;</span><span class="p">:</span> <span class="n">annual_returns</span> <span class="o">/</span> <span class="n">annual_volatility</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Sharpe (rf=0)&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Individual Asset Statistics (Annualized)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stats_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-5.1'></a></p>
<h1>Section 5.1: The Optimization Problem</h1>
<p>Mean-Variance Optimization (MVO) is the mathematical framework that earned Harry Markowitz the Nobel Prize.</p>
<p><strong>In this section, you will learn:</strong>
- How to formulate portfolio optimization mathematically
- The minimum variance and maximum Sharpe objectives
- Core portfolio metric functions</p></div>
<div class="md-cell"><h2>5.1.1 Mathematical Formulation</h2>
<p><strong>Minimize Portfolio Variance:</strong></p>
<p>$$\min_{\mathbf{w}} \quad \mathbf{w}^T \Sigma \mathbf{w}$$</p>
<p><strong>Subject to:</strong></p>
<p>$$\mathbf{w}^T \mathbf{\mu} = R_{target} \quad \text{(target return)}$$
$$\mathbf{w}^T \mathbf{1} = 1 \quad \text{(weights sum to 1)}$$</p>
<p>Where:
- $\mathbf{w}$ = vector of portfolio weights
- $\Sigma$ = covariance matrix
- $\mathbf{\mu}$ = vector of expected returns</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Define core portfolio functions</span>
<span class="k">def</span> <span class="nf">portfolio_return</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate portfolio expected return.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">portfolio_volatility</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate portfolio volatility.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">portfolio_sharpe</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                     <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">rf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate portfolio Sharpe ratio.&quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">portfolio_return</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">-</span> <span class="n">rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">vol</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portfolio functions defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test with equal weights</span>
<span class="n">equal_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">n_assets</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_assets</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Equal-Weighted Portfolio Test&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return: </span><span class="si">{</span><span class="n">portfolio_return</span><span class="p">(</span><span class="n">equal_weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volatility: </span><span class="si">{</span><span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">equal_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Ratio: </span><span class="si">{</span><span class="n">portfolio_sharpe</span><span class="p">(</span><span class="n">equal_weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>5.1.2 The Global Minimum Variance Portfolio</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Objective functions for optimization</span>
<span class="k">def</span> <span class="nf">neg_sharpe</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Negative Sharpe ratio (for minimization).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">portfolio_sharpe</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">port_variance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Portfolio variance (for minimization).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>

<span class="c1"># Constraints: weights sum to 1</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
<span class="n">initial_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">n_assets</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_assets</span><span class="p">)</span>

<span class="c1"># Optimize for minimum variance (unconstrained - allows short selling)</span>
<span class="n">result_minvar</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
    <span class="n">port_variance</span><span class="p">,</span>
    <span class="n">initial_weights</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,),</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
<span class="p">)</span>

<span class="n">minvar_weights</span> <span class="o">=</span> <span class="n">result_minvar</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Global Minimum Variance Portfolio (Unconstrained)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimal Weights:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">minvar_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">+.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Portfolio Statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Return: </span><span class="si">{</span><span class="n">portfolio_return</span><span class="p">(</span><span class="n">minvar_weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">minvar_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 5.1: Maximum Sharpe Portfolio (Guided)</h3>
<p><strong>Your Task:</strong> Find the portfolio that maximizes the Sharpe ratio using scipy.optimize.minimize.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.1: Maximum Sharpe Portfolio (Guided)</span>
<span class="k">def</span> <span class="nf">find_max_sharpe</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find the maximum Sharpe ratio portfolio weights.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
    
    <span class="c1"># Constraint: weights sum to 1</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;______&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
    
    <span class="c1"># TODO: Minimize negative Sharpe (to maximize Sharpe)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="n">______</span><span class="p">,</span>
        <span class="n">initial</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">),</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;______&#39;</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1"># Test</span>
<span class="c1"># maxsharpe_weights = find_max_sharpe(annual_returns, cov_matrix)</span>
<span class="c1"># print(f&quot;Max Sharpe: {portfolio_sharpe(maxsharpe_weights, annual_returns, cov_matrix):.4f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">find_max_sharpe</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find the maximum Sharpe ratio portfolio weights.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>

    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="n">neg_sharpe</span><span class="p">,</span>
        <span class="n">initial</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">),</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

<span class="n">maxsharpe_weights</span> <span class="o">=</span> <span class="n">find_max_sharpe</span><span class="p">(</span><span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Sharpe: </span><span class="si">{</span><span class="n">portfolio_sharpe</span><span class="p">(</span><span class="n">maxsharpe_weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return: </span><span class="si">{</span><span class="n">portfolio_return</span><span class="p">(</span><span class="n">maxsharpe_weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volatility: </span><span class="si">{</span><span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">maxsharpe_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-5.2'></a></p>
<h1>Section 5.2: Solving with Scipy</h1>
<p>The unconstrained optimization may give extreme positions. In practice, most portfolios can't take short positions.</p>
<p><strong>In this section, you will learn:</strong>
- How to use scipy.optimize.minimize effectively
- Adding bounds for long-only constraints
- Building a reusable optimizer class</p></div>
<div class="md-cell"><h2>5.2.1 Long-Only Constraint</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Long-only constraint: 0 &lt;= w_i &lt;= 1</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_assets</span><span class="p">))</span>

<span class="c1"># Minimum variance with long-only constraint</span>
<span class="n">result_minvar_long</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
    <span class="n">port_variance</span><span class="p">,</span>
    <span class="n">initial_weights</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,),</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
    <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
<span class="p">)</span>

<span class="n">minvar_long_weights</span> <span class="o">=</span> <span class="n">result_minvar_long</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum Variance Portfolio (Long-Only)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">minvar_long_weights</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Portfolio Statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Return: </span><span class="si">{</span><span class="n">portfolio_return</span><span class="p">(</span><span class="n">minvar_long_weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">minvar_long_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare unconstrained vs long-only</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Impact of Long-Only Constraint&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unconstrained volatility: </span><span class="si">{</span><span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">minvar_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Long-only volatility:     </span><span class="si">{</span><span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">minvar_long_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="n">cost</span> <span class="o">=</span> <span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">minvar_long_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span> <span class="o">-</span> <span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">minvar_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cost of constraint: +</span><span class="si">{</span><span class="n">cost</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% volatility&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>5.2.2 Reusable Portfolio Optimizer Class</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PortfolioOptimizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Mean-variance portfolio optimization.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">rf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">cov_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">rf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_port_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_port_volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>
    
    <span class="k">def</span> <span class="nf">_port_sharpe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_port_return</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port_volatility</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">minimize_volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_return</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">long_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find minimum volatility portfolio.&quot;&quot;&quot;</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
        
        <span class="k">if</span> <span class="n">target_return</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span>
                <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port_return</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="n">target_return</span>
            <span class="p">})</span>
        
        <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">))</span> <span class="k">if</span> <span class="n">long_only</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port_volatility</span><span class="p">(</span><span class="n">w</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">maximize_sharpe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find maximum Sharpe ratio portfolio.&quot;&quot;&quot;</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">))</span> <span class="k">if</span> <span class="n">long_only</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_port_sharpe</span><span class="p">(</span><span class="n">w</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get portfolio statistics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port_return</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port_volatility</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span>
            <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port_sharpe</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span>
            <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>
        <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PortfolioOptimizer class defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test the optimizer</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">PortfolioOptimizer</span><span class="p">(</span><span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>

<span class="n">min_vol_w</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">minimize_volatility</span><span class="p">()</span>
<span class="n">max_sharpe_w</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">maximize_sharpe</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portfolio Optimizer Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Minimum Volatility Portfolio:&quot;</span><span class="p">)</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">min_vol_w</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Return: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Maximum Sharpe Portfolio:&quot;</span><span class="p">)</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">max_sharpe_w</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Return: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 5.2: Add Efficient Frontier Method (Guided)</h3>
<p><strong>Your Task:</strong> Add a method to the optimizer class that generates efficient frontier points.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.2: Add Efficient Frontier Method (Guided)</span>
<span class="k">def</span> <span class="nf">efficient_frontier</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate efficient frontier points.&quot;&quot;&quot;</span>
    <span class="c1"># Get return range</span>
    <span class="n">min_ret</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  <span class="c1"># minimum return</span>
    <span class="n">max_ret</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  <span class="c1"># maximum return</span>
    
    <span class="n">target_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_ret</span><span class="p">,</span> <span class="n">max_ret</span><span class="p">,</span> <span class="n">n_points</span><span class="p">)</span>
    
    <span class="n">frontier_vols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">frontier_rets</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">target_returns</span><span class="p">:</span>
        <span class="c1"># TODO: Find minimum volatility for this target return</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">minimize_volatility</span><span class="p">(</span><span class="n">target_return</span><span class="o">=</span><span class="n">______</span><span class="p">,</span> <span class="n">long_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frontier_rets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">_port_return</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
            <span class="n">frontier_vols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">_port_volatility</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">frontier_rets</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">frontier_vols</span><span class="p">})</span>

<span class="c1"># Test</span>
<span class="c1"># frontier = efficient_frontier(optimizer)</span>
<span class="c1"># print(frontier.head())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">efficient_frontier</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate efficient frontier points.&quot;&quot;&quot;</span>
    <span class="n">min_ret</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">max_ret</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">target_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_ret</span><span class="p">,</span> <span class="n">max_ret</span><span class="p">,</span> <span class="n">n_points</span><span class="p">)</span>

    <span class="n">frontier_vols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">frontier_rets</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">target_returns</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">minimize_volatility</span><span class="p">(</span><span class="n">target_return</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">long_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frontier_rets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">_port_return</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
            <span class="n">frontier_vols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">_port_volatility</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">frontier_rets</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">frontier_vols</span><span class="p">})</span>

<span class="n">frontier</span> <span class="o">=</span> <span class="n">efficient_frontier</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">frontier</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="c1"># Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frontier</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">],</span> <span class="n">frontier</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Volatility&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Efficient Frontier&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-5.3'></a></p>
<h1>Section 5.3: Portfolio Constraints</h1>
<p>Real-world portfolios have many constraints beyond "no short selling".</p>
<p><strong>In this section, you will learn:</strong>
- Position limits (max/min weights)
- Sector constraints
- Combining multiple constraint types</p></div>
<div class="md-cell"><h2>5.3.1 Position Limits</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Max 25% in any single asset</span>
<span class="n">max_weight</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">bounds_constrained</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_weight</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_assets</span><span class="p">))</span>

<span class="n">result_constrained</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="o">-</span><span class="n">portfolio_sharpe</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">),</span>
    <span class="n">initial_weights</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
    <span class="n">bounds</span><span class="o">=</span><span class="n">bounds_constrained</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
<span class="p">)</span>

<span class="n">constrained_weights</span> <span class="o">=</span> <span class="n">result_constrained</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum Sharpe Portfolio (Max </span><span class="si">{</span><span class="n">max_weight</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% per asset)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">constrained_weights</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot; &lt;- AT LIMIT&quot;</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">weight</span> <span class="o">-</span> <span class="n">max_weight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span><span class="si">{</span><span class="n">marker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sharpe: </span><span class="si">{</span><span class="n">portfolio_sharpe</span><span class="p">(</span><span class="n">constrained_weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>5.3.2 Sector Constraints</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Define sector mappings</span>
<span class="n">sectors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;AAPL&#39;</span><span class="p">:</span> <span class="s1">&#39;Technology&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">:</span> <span class="s1">&#39;Technology&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;GOOGL&#39;</span><span class="p">:</span> <span class="s1">&#39;Technology&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">:</span> <span class="s1">&#39;Technology&#39;</span><span class="p">,</span>
    <span class="s1">&#39;JNJ&#39;</span><span class="p">:</span> <span class="s1">&#39;Healthcare&#39;</span><span class="p">,</span> <span class="s1">&#39;JPM&#39;</span><span class="p">:</span> <span class="s1">&#39;Financial&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XOM&#39;</span><span class="p">:</span> <span class="s1">&#39;Energy&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="s1">&#39;Commodities&#39;</span>
<span class="p">}</span>

<span class="c1"># Get tech stock indices</span>
<span class="n">tech_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span> <span class="k">if</span> <span class="n">sectors</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Technology&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Technology stocks: </span><span class="si">{</span><span class="p">[</span><span class="n">tickers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tech_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Constraint: Tech sector &lt;= 50%</span>
<span class="n">max_tech</span> <span class="o">=</span> <span class="mf">0.50</span>

<span class="n">sector_constraints</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">max_tech</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tech_idx</span><span class="p">)}</span>
<span class="p">]</span>

<span class="n">result_sector</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="o">-</span><span class="n">portfolio_sharpe</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">),</span>
    <span class="n">initial_weights</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
    <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>  <span class="c1"># long-only</span>
    <span class="n">constraints</span><span class="o">=</span><span class="n">sector_constraints</span>
<span class="p">)</span>

<span class="n">sector_weights</span> <span class="o">=</span> <span class="n">result_sector</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

<span class="c1"># Calculate sector exposures</span>
<span class="n">sector_exposure</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">sector_weights</span><span class="p">):</span>
    <span class="n">sector</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
    <span class="n">sector_exposure</span><span class="p">[</span><span class="n">sector</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector_exposure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">weight</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum Sharpe Portfolio (Tech &lt;= </span><span class="si">{</span><span class="n">max_tech</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sector Exposure:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sector</span><span class="p">,</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sector_exposure</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot; &lt;- AT LIMIT&quot;</span> <span class="k">if</span> <span class="n">sector</span> <span class="o">==</span> <span class="s1">&#39;Technology&#39;</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exposure</span> <span class="o">-</span> <span class="n">max_tech</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exposure</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%</span><span class="si">{</span><span class="n">marker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 5.3: Custom Constraints (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Takes min_weight and max_weight parameters
- Ensures every asset has at least min_weight allocation
- Maximizes Sharpe ratio within these constraints
- Returns the optimal weights and portfolio statistics</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.3: Custom Constraints (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">optimize_with_bounds</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                         <span class="n">min_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> 
                         <span class="n">max_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize portfolio with minimum and maximum weight constraints.</span>

<span class="sd">    Args:</span>
<span class="sd">        returns: Expected returns</span>
<span class="sd">        cov_matrix: Covariance matrix</span>
<span class="sd">        min_weight: Minimum weight per asset</span>
<span class="sd">        max_weight: Maximum weight per asset</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with weights and statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># Bounds with min and max</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">min_weight</span><span class="p">,</span> <span class="n">max_weight</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="c1"># Constraint: weights sum to 1</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>

    <span class="c1"># Objective: maximize Sharpe (minimize negative Sharpe)</span>
    <span class="k">def</span> <span class="nf">neg_sharpe</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">)))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ret</span> <span class="o">/</span> <span class="n">vol</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="n">neg_sharpe</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">weights</span><span class="p">)),</span>
            <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="p">,</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">vol</span><span class="p">,</span>
            <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">ret</span> <span class="o">/</span> <span class="n">vol</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Test</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">optimize_with_bounds</span><span class="p">(</span><span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Constrained Portfolio (5% &lt;= w &lt;= 20%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volatility: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Weights:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">w</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-5.4'></a></p>
<h1>Section 5.4: Target Return &amp; Risk</h1>
<p>Sometimes we want a portfolio that meets specific objectives like a target return or risk budget.</p>
<p><strong>In this section, you will learn:</strong>
- Optimizing for a target return
- Optimizing for a target volatility
- Visualizing optimization results</p></div>
<div class="md-cell"><h2>5.4.1 Optimize for Target Return</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">optimize_for_target_return</span><span class="p">(</span><span class="n">target_return</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                               <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">long_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find minimum volatility portfolio for a target return.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span> <span class="o">-</span> <span class="n">target_return</span><span class="p">}</span>
    <span class="p">]</span>
    
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="k">if</span> <span class="n">long_only</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">))),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1"># Test with different targets</span>
<span class="n">target_returns</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portfolios for Different Target Returns&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">target_returns</span><span class="p">:</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">optimize_for_target_return</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target </span><span class="si">{</span><span class="n">target</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%: Volatility = </span><span class="si">{</span><span class="n">vol</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target </span><span class="si">{</span><span class="n">target</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%: Not achievable&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>5.4.2 Optimize for Target Volatility</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">optimize_for_target_volatility</span><span class="p">(</span><span class="n">target_vol</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                                   <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">long_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find maximum return portfolio for a target volatility.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">)))</span> <span class="o">-</span> <span class="n">target_vol</span><span class="p">}</span>
    <span class="p">]</span>
    
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="k">if</span> <span class="n">long_only</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">returns</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1"># Test with different targets</span>
<span class="n">target_vols</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portfolios for Different Target Volatilities&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">target_vols</span><span class="p">:</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">optimize_for_target_volatility</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">portfolio_return</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target Vol </span><span class="si">{</span><span class="n">target</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%: Return = </span><span class="si">{</span><span class="n">ret</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target Vol </span><span class="si">{</span><span class="n">target</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%: Not achievable&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 5.4: Efficient Frontier Visualization (Guided)</h3>
<p><strong>Your Task:</strong> Generate and plot the efficient frontier with random portfolios for context.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.4: Efficient Frontier Visualization (Guided)</span>
<span class="k">def</span> <span class="nf">plot_efficient_frontier</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                           <span class="n">n_frontier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">n_random</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot efficient frontier with random portfolios.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="c1"># Generate random portfolios</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">random_rets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">random_vols</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_random</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  <span class="c1"># normalize weights</span>
        <span class="n">random_rets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">returns</span><span class="p">))</span>
        <span class="n">random_vols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">))))</span>
    
    <span class="c1"># Generate efficient frontier</span>
    <span class="n">min_ret</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">max_ret</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_ret</span><span class="p">,</span> <span class="n">max_ret</span><span class="p">,</span> <span class="n">n_frontier</span><span class="p">)</span>
    
    <span class="n">frontier_rets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">frontier_vols</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">optimize_for_target_return</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frontier_rets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">returns</span><span class="p">))</span>
            <span class="n">frontier_vols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">))))</span>
    
    <span class="c1"># Plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">random_vols</span><span class="p">,</span> <span class="n">random_rets</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random Portfolios&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frontier_vols</span><span class="p">,</span> <span class="n">frontier_rets</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Efficient Frontier&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()[</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="n">cov_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="n">ticker</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">ret</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Volatility&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Expected Return&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Efficient Frontier&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Test</span>
<span class="c1"># plot_efficient_frontier(annual_returns, cov_matrix)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_efficient_frontier</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                           <span class="n">n_frontier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">n_random</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot efficient frontier with random portfolios.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">random_rets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">random_vols</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_random</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">random_rets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">returns</span><span class="p">))</span>
        <span class="n">random_vols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">))))</span>

    <span class="n">min_ret</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">max_ret</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_ret</span><span class="p">,</span> <span class="n">max_ret</span><span class="p">,</span> <span class="n">n_frontier</span><span class="p">)</span>

    <span class="n">frontier_rets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">frontier_vols</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">optimize_for_target_return</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frontier_rets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">returns</span><span class="p">))</span>
            <span class="n">frontier_vols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">))))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">random_vols</span><span class="p">,</span> <span class="n">random_rets</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random Portfolios&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frontier_vols</span><span class="p">,</span> <span class="n">frontier_rets</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Efficient Frontier&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="n">ticker</span><span class="p">])</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">ret</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Volatility&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Expected Return&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Efficient Frontier&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plot_efficient_frontier</span><span class="p">(</span><span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 5.5: Portfolio Optimizer with Multiple Strategies (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Compares multiple optimization strategies (min vol, max sharpe, equal weight)
- Calculates statistics for each
- Returns a comparison DataFrame</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.5: Portfolio Optimizer with Multiple Strategies (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compare_strategies</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare multiple portfolio optimization strategies.</span>

<span class="sd">    Args:</span>
<span class="sd">        returns: Expected returns</span>
<span class="sd">        cov_matrix: Covariance matrix</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame comparing strategies</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">strategies</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Equal weight</span>
    <span class="n">equal_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">strategies</span><span class="p">[</span><span class="s1">&#39;Equal Weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">equal_w</span>

    <span class="c1"># Minimum volatility</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">))),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
        <span class="n">strategies</span><span class="p">[</span><span class="s1">&#39;Min Volatility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

    <span class="c1"># Maximum Sharpe</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">))),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
        <span class="n">strategies</span><span class="p">[</span><span class="s1">&#39;Max Sharpe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

    <span class="c1"># Calculate stats</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">strategies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="p">,</span>
            <span class="s1">&#39;Volatility&#39;</span><span class="p">:</span> <span class="n">vol</span><span class="p">,</span>
            <span class="s1">&#39;Sharpe&#39;</span><span class="p">:</span> <span class="n">ret</span> <span class="o">/</span> <span class="n">vol</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">comparison</span> <span class="o">=</span> <span class="n">compare_strategies</span><span class="p">(</span><span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 5.6: Complete Optimization Framework (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a <code>PortfolioOptimizerPro</code> class that:
- Supports multiple optimization objectives
- Handles various constraint types (bounds, sectors)
- Includes efficient frontier generation
- Provides visualization methods</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 5.6: Complete Optimization Framework (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PortfolioOptimizerPro</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Professional portfolio optimization framework.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                 <span class="n">tickers</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">cov_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="o">=</span> <span class="n">tickers</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">rf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_calc_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ret</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">vol</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;max_sharpe&#39;</span><span class="p">,</span> 
                 <span class="n">min_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">sector_limits</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run optimization with specified objective and constraints.&quot;&quot;&quot;</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">min_weight</span><span class="p">,</span> <span class="n">max_weight</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>

        <span class="k">if</span> <span class="n">objective</span> <span class="o">==</span> <span class="s1">&#39;max_sharpe&#39;</span><span class="p">:</span>
            <span class="n">obj_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">objective</span> <span class="o">==</span> <span class="s1">&#39;min_vol&#39;</span><span class="p">:</span>
            <span class="n">obj_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown objective: </span><span class="si">{</span><span class="n">objective</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
            <span class="n">obj_func</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">objective</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_stats</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">efficient_frontier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate efficient frontier.&quot;&quot;&quot;</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">n_points</span><span class="p">)</span>
        <span class="n">frontier</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">target</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="p">}</span>
            <span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">))),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">=</span><span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)),</span>
                <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                <span class="n">frontier</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">),</span>
                    <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])))</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">frontier</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot results.&quot;&quot;&quot;</span>
        <span class="n">frontier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">efficient_frontier</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frontier</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">],</span> <span class="n">frontier</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Efficient Frontier&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> 
                       <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (SR=</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Volatility&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Portfolio Optimization Results&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Test</span>
<span class="n">opt_pro</span> <span class="o">=</span> <span class="n">PortfolioOptimizerPro</span><span class="p">(</span><span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">,</span> <span class="n">tickers</span><span class="p">)</span>
<span class="n">opt_pro</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="s1">&#39;max_sharpe&#39;</span><span class="p">)</span>
<span class="n">opt_pro</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="s1">&#39;min_vol&#39;</span><span class="p">)</span>
<span class="n">opt_pro</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Complete Portfolio Optimization Workflow</h1>
<p>Build a complete portfolio optimization workflow comparing multiple strategies.</p>
<p><strong>Your Challenge:</strong></p>
<ol>
<li>Run multiple optimization strategies</li>
<li>Compare portfolio statistics</li>
<li>Visualize weight allocations</li>
<li>Generate the efficient frontier</li>
<li>Summarize findings</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Complete Portfolio Optimization Project</span>

<span class="c1"># Step 1: Run multiple strategies</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">PortfolioOptimizer</span><span class="p">(</span><span class="n">annual_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>

<span class="n">strategies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Equal Weight&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_assets</span><span class="p">,</span>
    <span class="s1">&#39;Min Volatility&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">minimize_volatility</span><span class="p">(),</span>
    <span class="s1">&#39;Max Sharpe&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">maximize_sharpe</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1"># Step 2: Compare statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Strategy Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">comparison_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">strategies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">comparison_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Volatility&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Sharpe&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span>
    <span class="p">})</span>

<span class="n">comparison_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comparison_data</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Strategy&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Step 3: Visualize allocations</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">strategies</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">bars</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">weights</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Weight (%)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Step 4: Summary</span>
<span class="n">best_sharpe</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Sharpe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<span class="n">lowest_vol</span> <span class="o">=</span> <span class="n">comparison_df</span><span class="p">[</span><span class="s1">&#39;Volatility&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Key Findings:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Best Risk-Adjusted: </span><span class="si">{</span><span class="n">best_sharpe</span><span class="si">}</span><span class="s2"> (Sharpe = </span><span class="si">{</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_sharpe</span><span class="p">,</span> <span class="s1">&#39;Sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Lowest Risk: </span><span class="si">{</span><span class="n">lowest_vol</span><span class="si">}</span><span class="s2"> (Vol = </span><span class="si">{</span><span class="n">comparison_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lowest_vol</span><span class="p">,</span> <span class="s1">&#39;Volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Optimization Fundamentals</h3>
<ul>
<li>Minimize volatility or maximize Sharpe ratio</li>
<li>Use scipy.optimize.minimize with constraints</li>
</ul>
<h3>2. Constraints</h3>
<ul>
<li>Long-only: <code>bounds = tuple((0, 1) for _ in range(n))</code></li>
<li>Sum to 1: <code>{'type': 'eq', 'fun': lambda w: np.sum(w) - 1}</code></li>
<li>Position limits: Custom bounds</li>
<li>Sector limits: Inequality constraints</li>
</ul>
<h3>3. Target Optimization</h3>
<ul>
<li>Target return: Add return equality constraint</li>
<li>Target volatility: Add volatility equality constraint</li>
</ul>
<h3>4. Trade-offs</h3>
<ul>
<li>More constraints = Lower optimal performance</li>
<li>But more realistic, implementable portfolios</li>
</ul>
<h2>Key Code Patterns</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># Basic optimization</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
    <span class="n">objective_function</span><span class="p">,</span>
    <span class="n">initial_weights</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
    <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
<span class="p">)</span>
</code></pre></div></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 6: Advanced Portfolio Techniques</strong>, we'll explore Risk Parity, Black-Litterman, and Hierarchical Risk Parity.</p>
<hr />
<p><em>Congratulations on completing Module 5!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="6"><div class="md-cell module-header"><h1>Module 6: Advanced Portfolio Techniques</h1>
<p><strong>Course 3: Quantitative Finance</strong><br />
<strong>Part 2: Portfolio Theory</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Implement Risk Parity portfolios for equal risk contribution</li>
<li>Apply the Black-Litterman model to incorporate views</li>
<li>Build robust portfolios that reduce estimation error</li>
<li>Use Hierarchical Risk Parity (HRP) for ML-based allocation</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 5: Mean-Variance Optimization</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-6.1">Section 6.1: Risk Parity</a></li>
<li><a href="#section-6.2">Section 6.2: Black-Litterman Model</a></li>
<li><a href="#section-6.3">Section 6.3: Robust Optimization</a></li>
<li><a href="#section-6.4">Section 6.4: Hierarchical Risk Parity</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">linkage</span><span class="p">,</span> <span class="n">dendrogram</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">squareform</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Libraries loaded successfully!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download multi-asset data</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">,</span> <span class="s1">&#39;EFA&#39;</span><span class="p">,</span> <span class="s1">&#39;EEM&#39;</span><span class="p">,</span> <span class="s1">&#39;IEF&#39;</span><span class="p">,</span> <span class="s1">&#39;DBC&#39;</span><span class="p">]</span>
<span class="c1"># SPY: US Equities, TLT: Long Bonds, GLD: Gold, VNQ: REITs</span>
<span class="c1"># EFA: Developed Intl, EEM: Emerging, IEF: Intermediate Bonds, DBC: Commodities</span>

<span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading multi-asset data...&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Handle MultiIndex columns</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="n">prices</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Calculate statistics</span>
<span class="n">annual_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">annual_volatility</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="si">}</span><span class="s2"> trading days&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assets: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-6.1'></a></p>
<h1>Section 6.1: Risk Parity</h1>
<p>A 60/40 stock/bond portfolio sounds balanced, but stocks contribute ~90% of the portfolio's risk!</p>
<p><strong>In this section, you will learn:</strong>
- How to calculate risk contribution by asset
- Building portfolios where each asset contributes equal risk
- Risk budgeting with custom allocations</p></div>
<div class="md-cell"><h2>6.1.1 Risk Contribution</h2>
<p>The risk contribution of asset $i$ is:</p>
<p>$$RC_i = w_i \cdot \frac{\partial \sigma_p}{\partial w_i} = w_i \cdot \frac{(\Sigma w)_i}{\sigma_p}$$</p>
<p>For a <strong>risk parity</strong> portfolio:
$$RC_i = RC_j \quad \forall i,j$$</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Core risk functions</span>
<span class="k">def</span> <span class="nf">portfolio_volatility</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate portfolio volatility.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">risk_contribution</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate risk contribution of each asset.&quot;&quot;&quot;</span>
    <span class="n">port_vol</span> <span class="o">=</span> <span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
    <span class="n">marginal_contrib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">port_vol</span>
    <span class="k">return</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">marginal_contrib</span>

<span class="k">def</span> <span class="nf">risk_contribution_pct</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Risk contribution as percentage of total.&quot;&quot;&quot;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">risk_contribution</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rc</span> <span class="o">/</span> <span class="n">rc</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Risk functions defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Equal Weight Portfolio - Risk Contribution</span>
<span class="n">equal_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">n_assets</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_assets</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Equal Weight Portfolio - Risk Contribution&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">rc_equal</span> <span class="o">=</span> <span class="n">risk_contribution_pct</span><span class="p">(</span><span class="n">equal_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">rc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">rc_equal</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">rc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Notice: Even with equal weights, risk contribution varies widely!&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>6.1.2 Risk Parity Optimization</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">risk_parity_objective</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Objective: minimize deviation from equal risk contribution.&quot;&quot;&quot;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">risk_contribution</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">*</span> <span class="n">rc</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">rc</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">optimize_risk_parity</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find risk parity weights.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">cov_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
    
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="n">risk_parity_objective</span><span class="p">,</span>
        <span class="n">x0</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,),</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Find Risk Parity portfolio</span>
<span class="n">rp_weights</span> <span class="o">=</span> <span class="n">optimize_risk_parity</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Risk Parity Portfolio&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;Asset&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Weight&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Risk Contrib&#39;</span><span class="si">:</span><span class="s2">&gt;15</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>

<span class="n">rc_rp</span> <span class="o">=</span> <span class="n">risk_contribution_pct</span><span class="p">(</span><span class="n">rp_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">rc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">rp_weights</span><span class="p">,</span> <span class="n">rc_rp</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">w</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">rc</span><span class="si">:</span><span class="s2">&gt;14.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Portfolio Volatility: </span><span class="si">{</span><span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">rp_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 6.1: Risk Budgeting (Guided)</h3>
<p><strong>Your Task:</strong> Implement risk budgeting where you can specify custom risk allocations per asset.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.1: Risk Budgeting (Guided)</span>
<span class="k">def</span> <span class="nf">risk_budgeting_objective</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                            <span class="n">risk_budget</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Objective: match specified risk budget.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate risk contribution</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">risk_contribution</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">______</span><span class="p">)</span>
    
    <span class="c1"># TODO: Convert to percentage</span>
    <span class="n">rc_pct</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">/</span> <span class="n">rc</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># TODO: Sum of squared deviations from target budget</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">rc_pct</span> <span class="o">-</span> <span class="n">______</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">optimize_risk_budget</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                         <span class="n">risk_budget</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find weights for a given risk budget.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">cov_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>
    
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="n">risk_budgeting_objective</span><span class="p">,</span>
        <span class="n">x0</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">risk_budget</span><span class="p">),</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1"># Test: 60% equity risk, 40% defensive risk</span>
<span class="c1"># risk_budget = np.array([0.20, 0.10, 0.10, 0.10, 0.20, 0.20, 0.05, 0.05])</span>
<span class="c1"># rb_weights = optimize_risk_budget(cov_matrix, risk_budget)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">risk_budgeting_objective</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                            <span class="n">risk_budget</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Objective: match specified risk budget.&quot;&quot;&quot;</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">risk_contribution</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
    <span class="n">rc_pct</span> <span class="o">=</span> <span class="n">rc</span> <span class="o">/</span> <span class="n">rc</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">rc_pct</span> <span class="o">-</span> <span class="n">risk_budget</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">optimize_risk_budget</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                         <span class="n">risk_budget</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find weights for a given risk budget.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">cov_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>

    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="n">risk_budgeting_objective</span><span class="p">,</span>
        <span class="n">x0</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">risk_budget</span><span class="p">),</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1"># Test: 60% equity risk (SPY, EFA, EEM), 40% defensive</span>
<span class="n">risk_budget</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>
<span class="n">rb_weights</span> <span class="o">=</span> <span class="n">optimize_risk_budget</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">risk_budget</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Risk Budgeting Portfolio&quot;</span><span class="p">)</span>
<span class="n">rc_rb</span> <span class="o">=</span> <span class="n">risk_contribution_pct</span><span class="p">(</span><span class="n">rb_weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">rb_weights</span><span class="p">,</span> <span class="n">rc_rb</span><span class="p">,</span> <span class="n">risk_budget</span><span class="o">*</span><span class="mi">100</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: Weight=</span><span class="si">{</span><span class="n">w</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%, RC=</span><span class="si">{</span><span class="n">rc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%, Target=</span><span class="si">{</span><span class="n">target</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-6.2'></a></p>
<h1>Section 6.2: Black-Litterman Model</h1>
<p>MVO requires return estimates that are unreliable. Black-Litterman combines market equilibrium with investor views.</p>
<p><strong>In this section, you will learn:</strong>
- Deriving equilibrium returns from market weights
- Expressing and incorporating views
- Computing posterior expected returns</p></div>
<div class="md-cell"><h2>6.2.1 Equilibrium Returns</h2>
<p><strong>Equilibrium returns</strong> (implied by market):
$$\Pi = \delta \Sigma w_{mkt}$$</p>
<p>Where:
- $\delta$ = risk aversion coefficient (typically 2-4)
- $\Sigma$ = covariance matrix
- $w_{mkt}$ = market capitalization weights</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate equilibrium returns</span>
<span class="n">market_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">n_assets</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_assets</span><span class="p">)</span>  <span class="c1"># Simplified</span>
<span class="n">delta</span> <span class="o">=</span> <span class="mf">2.5</span>  <span class="c1"># Risk aversion</span>

<span class="n">equilibrium_returns</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">market_weights</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Equilibrium Returns (Implied by Market)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">45</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">equilibrium_returns</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ret</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>6.2.2 Black-Litterman Formula</h2>
<p><strong>Posterior expected returns:</strong>
$$E[R] = [(\tau\Sigma)^{-1} + P'\Omega^{-1}P]^{-1} [(\tau\Sigma)^{-1}\Pi + P'\Omega^{-1}Q]$$</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">black_litterman</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">market_weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                    <span class="n">P</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Q</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">omega</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                    <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Black-Litterman model.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        cov_matrix: Asset covariance matrix</span>
<span class="sd">        market_weights: Market cap weights</span>
<span class="sd">        P: View matrix (k x n)</span>
<span class="sd">        Q: View vector (k x 1)</span>
<span class="sd">        omega: View uncertainty matrix (k x k)</span>
<span class="sd">        tau: Scalar (0.025-0.05 typical)</span>
<span class="sd">        delta: Risk aversion coefficient</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (posterior_returns, posterior_cov)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Equilibrium returns</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">market_weights</span><span class="p">)</span>
    
    <span class="c1"># Scaled covariance</span>
    <span class="n">tau_sigma</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">cov_matrix</span>
    <span class="n">tau_sigma_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">tau_sigma</span><span class="p">)</span>
    <span class="n">omega_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
    
    <span class="c1"># Posterior precision and covariance</span>
    <span class="n">posterior_precision</span> <span class="o">=</span> <span class="n">tau_sigma_inv</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">omega_inv</span><span class="p">,</span> <span class="n">P</span><span class="p">))</span>
    <span class="n">posterior_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">posterior_precision</span><span class="p">)</span>
    
    <span class="c1"># Posterior mean</span>
    <span class="n">posterior_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">posterior_cov</span><span class="p">,</span> 
                               <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tau_sigma_inv</span><span class="p">,</span> <span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">omega_inv</span><span class="p">,</span> <span class="n">Q</span><span class="p">)))</span>
    
    <span class="k">return</span> <span class="n">posterior_returns</span><span class="p">,</span> <span class="n">posterior_cov</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Black-Litterman function defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Example views:</span>
<span class="c1"># View 1: SPY will return 8% (absolute)</span>
<span class="c1"># View 2: EEM will outperform EFA by 2% (relative)</span>

<span class="c1"># P matrix: rows=views, columns=assets</span>
<span class="c1"># SPY=0, TLT=1, GLD=2, VNQ=3, EFA=4, EEM=5, IEF=6, DBC=7</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>      <span class="c1"># SPY</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>      <span class="c1"># EEM - EFA</span>
<span class="p">])</span>

<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">])</span>  <span class="c1"># View returns</span>

<span class="c1"># Omega: view uncertainty (diagonal)</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Investor Views:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  View 1: SPY returns 8% (high confidence)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  View 2: EEM outperforms EFA by 2% (moderate confidence)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Apply Black-Litterman</span>
<span class="n">bl_returns</span><span class="p">,</span> <span class="n">bl_cov</span> <span class="o">=</span> <span class="n">black_litterman</span><span class="p">(</span>
    <span class="n">cov_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">market_weights</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">omega</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Black-Litterman Expected Returns&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;Asset&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Equilibrium&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;BL Return&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Change&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tickers</span><span class="p">):</span>
    <span class="n">eq_ret</span> <span class="o">=</span> <span class="n">equilibrium_returns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">bl_ret</span> <span class="o">=</span> <span class="n">bl_returns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">change</span> <span class="o">=</span> <span class="n">bl_ret</span> <span class="o">-</span> <span class="n">eq_ret</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">eq_ret</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">bl_ret</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">change</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;+9.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 6.2: Black-Litterman Optimizer (Guided)</h3>
<p><strong>Your Task:</strong> Build a complete Black-Litterman workflow with optimization.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.2: Black-Litterman Optimizer (Guided)</span>
<span class="k">def</span> <span class="nf">bl_optimize</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">long_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Optimize portfolio using Black-Litterman returns.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">neg_sharpe</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="c1"># TODO: Calculate portfolio return</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span>
        <span class="c1"># TODO: Calculate portfolio volatility</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">)))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ret</span> <span class="o">/</span> <span class="n">vol</span>
    
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;______&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="k">if</span> <span class="n">long_only</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="n">neg_sharpe</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1"># Test</span>
<span class="c1"># bl_weights = bl_optimize(bl_returns, bl_cov)</span>
<span class="c1"># print(f&quot;BL Portfolio Weights: {dict(zip(tickers, bl_weights.round(3)))}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">bl_optimize</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                <span class="n">long_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Optimize portfolio using Black-Litterman returns.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">neg_sharpe</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">w</span><span class="p">)))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ret</span> <span class="o">/</span> <span class="n">vol</span>

    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="k">if</span> <span class="n">long_only</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="n">neg_sharpe</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

<span class="n">bl_weights</span> <span class="o">=</span> <span class="n">bl_optimize</span><span class="p">(</span><span class="n">bl_returns</span><span class="p">,</span> <span class="n">bl_cov</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Black-Litterman Optimized Portfolio&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">45</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">bl_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">w</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 6.3: Custom Views Implementation (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Takes a list of view specifications (dictionaries)
- Constructs the P matrix and Q vector automatically
- Allows specifying confidence levels
- Returns Black-Litterman expected returns</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.3: Custom Views Implementation (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_views</span><span class="p">(</span><span class="n">tickers</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">views</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build P, Q, omega matrices from view specifications.</span>

<span class="sd">    Args:</span>
<span class="sd">        tickers: List of ticker symbols</span>
<span class="sd">        views: List of dicts with keys:</span>
<span class="sd">               - &#39;asset&#39;: ticker for absolute view, OR</span>
<span class="sd">               - &#39;long&#39;: ticker to go long, &#39;short&#39;: ticker to short</span>
<span class="sd">               - &#39;return&#39;: expected return</span>
<span class="sd">               - &#39;confidence&#39;: &#39;high&#39;, &#39;medium&#39;, &#39;low&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (P, Q, omega)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span>
    <span class="n">n_views</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">views</span><span class="p">)</span>
    <span class="n">ticker_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tickers</span><span class="p">)}</span>

    <span class="n">confidence_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">}</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_views</span><span class="p">,</span> <span class="n">n_assets</span><span class="p">))</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_views</span><span class="p">)</span>
    <span class="n">omega_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_views</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">views</span><span class="p">):</span>
        <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span>
        <span class="n">omega_diag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">confidence_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confidence&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">),</span> <span class="mf">0.002</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;asset&#39;</span> <span class="ow">in</span> <span class="n">view</span><span class="p">:</span>  <span class="c1"># Absolute view</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ticker_idx</span><span class="p">[</span><span class="n">view</span><span class="p">[</span><span class="s1">&#39;asset&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Relative view</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ticker_idx</span><span class="p">[</span><span class="n">view</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ticker_idx</span><span class="p">[</span><span class="n">view</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">]]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">omega_diag</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">views</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;asset&#39;</span><span class="p">:</span> <span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="s1">&#39;EEM&#39;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s1">&#39;EFA&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;asset&#39;</span><span class="p">:</span> <span class="s1">&#39;GLD&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">}</span>
<span class="p">]</span>

<span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">omega</span> <span class="o">=</span> <span class="n">build_views</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">views</span><span class="p">)</span>
<span class="n">bl_ret</span><span class="p">,</span> <span class="n">bl_cov</span> <span class="o">=</span> <span class="n">black_litterman</span><span class="p">(</span><span class="n">cov_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">market_weights</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BL Returns with Custom Views:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">bl_ret</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">r</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-6.3'></a></p>
<h1>Section 6.3: Robust Optimization</h1>
<p>MVO is highly sensitive to input estimates. Robust methods reduce this sensitivity.</p>
<p><strong>In this section, you will learn:</strong>
- Shrinkage estimators for covariance
- Resampled efficiency
- Evaluating weight stability</p></div>
<div class="md-cell"><h2>6.3.1 Shrinkage Estimators</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">ledoit_wolf_shrinkage</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">shrinkage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplified Ledoit-Wolf shrinkage.</span>
<span class="sd">    Shrinks sample covariance toward scaled identity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sample_cov</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">252</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">sample_cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Target: scaled identity</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">sample_cov</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    
    <span class="c1"># Shrunk covariance</span>
    <span class="n">shrunk_cov</span> <span class="o">=</span> <span class="n">shrinkage</span> <span class="o">*</span> <span class="n">target</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">shrinkage</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_cov</span>
    
    <span class="k">return</span> <span class="n">shrunk_cov</span>

<span class="n">shrunk_cov</span> <span class="o">=</span> <span class="n">ledoit_wolf_shrinkage</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shrinkage applied: Sample cov pulled 20% toward diagonal&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>6.3.2 Resampled Efficiency</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">resampled_optimization</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                           <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resampled efficient frontier.</span>
<span class="sd">    Bootstrap samples for more stable weights.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">all_weights</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
        <span class="c1"># Simulate returns from distribution</span>
        <span class="n">sim_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span>
            <span class="n">returns</span><span class="p">,</span> <span class="n">cov_matrix</span> <span class="o">/</span> <span class="mi">252</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">252</span>
        <span class="p">)</span>
        
        <span class="n">sim_mean</span> <span class="o">=</span> <span class="n">sim_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">sim_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_returns</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="mi">252</span>
        
        <span class="c1"># Optimize</span>
        <span class="k">def</span> <span class="nf">neg_sharpe</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">sim_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sim_cov</span><span class="p">,</span> <span class="n">w</span><span class="p">)))</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
            <span class="n">neg_sharpe</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_assets</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)),</span>
            <span class="n">constraints</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
            <span class="n">all_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
    
    <span class="c1"># Average weights</span>
    <span class="n">avg_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">avg_weights</span> <span class="o">=</span> <span class="n">avg_weights</span> <span class="o">/</span> <span class="n">avg_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">avg_weights</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_weights</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running resampled optimization (100 samples)...&quot;</span><span class="p">)</span>
<span class="n">resampled_weights</span><span class="p">,</span> <span class="n">all_resampled</span> <span class="o">=</span> <span class="n">resampled_optimization</span><span class="p">(</span>
    <span class="n">annual_returns</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resampled Efficient Portfolio&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">resampled_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">w</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 6.4: Weight Stability Analysis (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Takes the resampled weight matrix
- Calculates statistics for each asset (mean, std, confidence interval)
- Visualizes the weight uncertainty with box plots
- Returns a DataFrame with weight statistics</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.4: Weight Stability Analysis (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_weight_stability</span><span class="p">(</span><span class="n">all_weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                             <span class="n">tickers</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze stability of resampled weights.</span>

<span class="sd">    Args:</span>
<span class="sd">        all_weights: Array of shape (n_samples, n_assets)</span>
<span class="sd">        tickers: List of ticker symbols</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with weight statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tickers</span><span class="p">):</span>
        <span class="n">weights_i</span> <span class="o">=</span> <span class="n">all_weights</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Ticker&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
            <span class="s1">&#39;Mean&#39;</span><span class="p">:</span> <span class="n">weights_i</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;Std&#39;</span><span class="p">:</span> <span class="n">weights_i</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s1">&#39;Min&#39;</span><span class="p">:</span> <span class="n">weights_i</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s1">&#39;Max&#39;</span><span class="p">:</span> <span class="n">weights_i</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="s1">&#39;CI_Lower&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">weights_i</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
            <span class="s1">&#39;CI_Upper&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">weights_i</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Ticker&#39;</span><span class="p">)</span>

    <span class="c1"># Visualize</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">bp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">([</span><span class="n">all_weights</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">))],</span>
                    <span class="n">positions</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">tickers</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Weight (%)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Weight Uncertainty from Resampling&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">100</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Equal Weight&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># Test</span>
<span class="n">stability_df</span> <span class="o">=</span> <span class="n">analyze_weight_stability</span><span class="p">(</span><span class="n">all_resampled</span><span class="p">,</span> <span class="n">tickers</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stability_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-6.4'></a></p>
<h1>Section 6.4: Hierarchical Risk Parity (HRP)</h1>
<p>HRP is a modern ML-based approach that doesn't require return estimates.</p>
<p><strong>In this section, you will learn:</strong>
- Hierarchical clustering of assets
- Quasi-diagonalization
- Recursive bisection for allocation</p></div>
<div class="md-cell"><h2>6.4.1 HRP Algorithm</h2>
<ol>
<li><strong>Tree Clustering</strong>: Build hierarchy based on correlation distance</li>
<li><strong>Quasi-Diagonalization</strong>: Reorder assets to cluster similar ones</li>
<li><strong>Recursive Bisection</strong>: Split and allocate inversely to variance</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">correlation_distance</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert correlation to distance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">corr_matrix</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_quasi_diag</span><span class="p">(</span><span class="n">link</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get quasi-diagonal order from linkage.&quot;&quot;&quot;</span>
    <span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">sort_ix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">link</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">num_items</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    
    <span class="k">while</span> <span class="n">sort_ix</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">num_items</span><span class="p">:</span>
        <span class="n">sort_ix</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sort_ix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">df0</span> <span class="o">=</span> <span class="n">sort_ix</span><span class="p">[</span><span class="n">sort_ix</span> <span class="o">&gt;=</span> <span class="n">num_items</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">df0</span><span class="o">.</span><span class="n">index</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">df0</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">num_items</span>
        <span class="n">sort_ix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">df0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sort_ix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">sort_ix</span><span class="p">,</span> <span class="n">df0</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">sort_ix</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">sort_ix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">sort_ix</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_cluster_var</span><span class="p">(</span><span class="n">cov</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">cluster_items</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate variance of a cluster.&quot;&quot;&quot;</span>
    <span class="n">cov_slice</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">cluster_items</span><span class="p">,</span> <span class="n">cluster_items</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_slice</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_slice</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">hrp_allocation</span><span class="p">(</span><span class="n">cov</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">sort_ix</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Recursive bisection allocation.&quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">sort_ix</span><span class="p">)</span>
    <span class="n">cluster_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">sort_ix</span><span class="p">]</span>
    
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cluster_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster_items</span> 
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span> 
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_items</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="n">cluster_items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">cluster_items</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            
            <span class="n">var0</span> <span class="o">=</span> <span class="n">get_cluster_var</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">c0</span><span class="p">)</span>
            <span class="n">var1</span> <span class="o">=</span> <span class="n">get_cluster_var</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
            
            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">var0</span> <span class="o">/</span> <span class="p">(</span><span class="n">var0</span> <span class="o">+</span> <span class="n">var1</span><span class="p">)</span>
            <span class="n">w</span><span class="p">[</span><span class="n">c0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">alpha</span>
            <span class="n">w</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span>
    
    <span class="k">return</span> <span class="n">w</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;HRP functions defined&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Step 1: Calculate distance and cluster</span>
<span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">correlation_distance</span><span class="p">(</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">dist_array</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">link</span> <span class="o">=</span> <span class="n">linkage</span><span class="p">(</span><span class="n">dist_array</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">)</span>

<span class="c1"># Plot dendrogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">dendrogram</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">tickers</span><span class="p">,</span> <span class="n">leaf_rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Hierarchical Clustering of Assets&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Asset&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Distance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Step 2 &amp; 3: Quasi-diagonal order and allocation</span>
<span class="n">sort_ix</span> <span class="o">=</span> <span class="n">get_quasi_diag</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quasi-diagonal ordering: </span><span class="si">{</span><span class="s1">&#39; -&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">tickers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sort_ix</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cov_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cov_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n_assets</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n_assets</span><span class="p">))</span>
<span class="n">hrp_w</span> <span class="o">=</span> <span class="n">hrp_allocation</span><span class="p">(</span><span class="n">cov_df</span><span class="p">,</span> <span class="n">sort_ix</span><span class="p">)</span>

<span class="c1"># Map to original order</span>
<span class="n">hrp_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sort_ix</span><span class="p">):</span>
    <span class="n">hrp_weights</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">hrp_w</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Hierarchical Risk Parity Weights:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">hrp_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">w</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 6.5: Complete HRP Class (Guided)</h3>
<p><strong>Your Task:</strong> Build a complete HRP class encapsulating all steps.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.5: Complete HRP Class (Guided)</span>
<span class="k">class</span> <span class="nc">HierarchicalRiskParity</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Hierarchical Risk Parity portfolio allocation.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">)</span>
        <span class="c1"># TODO: Calculate covariance and correlation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run HRP algorithm.&quot;&quot;&quot;</span>
        <span class="c1"># Distance and clustering</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">correlation_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">dist_array</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">linkage</span><span class="p">(</span><span class="n">dist_array</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">)</span>
        
        <span class="c1"># Quasi-diagonalization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ix</span> <span class="o">=</span> <span class="n">get_quasi_diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>
        
        <span class="c1"># Allocation</span>
        <span class="n">cov_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                              <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">),</span> 
                              <span class="n">columns</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">))</span>
        <span class="n">hrp_w</span> <span class="o">=</span> <span class="n">hrp_allocation</span><span class="p">(</span><span class="n">cov_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_ix</span><span class="p">)</span>
        
        <span class="c1"># TODO: Map weights to original order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">______</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_ix</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">hrp_w</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return weights as dictionary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span>

<span class="c1"># Test</span>
<span class="c1"># hrp = HierarchicalRiskParity(returns).fit()</span>
<span class="c1"># print(hrp.get_weights())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">HierarchicalRiskParity</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Hierarchical Risk Parity portfolio allocation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run HRP algorithm.&quot;&quot;&quot;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">correlation_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">dist_array</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">linkage</span><span class="p">(</span><span class="n">dist_array</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_ix</span> <span class="o">=</span> <span class="n">get_quasi_diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>

        <span class="n">cov_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
                              <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">),</span> 
                              <span class="n">columns</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">))</span>
        <span class="n">hrp_w</span> <span class="o">=</span> <span class="n">hrp_allocation</span><span class="p">(</span><span class="n">cov_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_ix</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_ix</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">hrp_w</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span>

<span class="n">hrp</span> <span class="o">=</span> <span class="n">HierarchicalRiskParity</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;HRP Weights:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">hrp</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">w</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 6.6: Complete Portfolio Allocator (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build an <code>AdvancedPortfolioAllocator</code> class that:
- Implements all techniques: Equal Weight, Risk Parity, HRP
- Calculates performance statistics for each
- Provides comparison methods
- Includes visualization</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 6.6: Complete Portfolio Allocator (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AdvancedPortfolioAllocator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Advanced portfolio allocation with multiple techniques.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annual_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">equal_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Equal weight allocation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;Equal Weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_assets</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">risk_parity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Risk parity allocation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;Risk Parity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimize_risk_parity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">hrp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;HRP allocation.&quot;&quot;&quot;</span>
        <span class="n">hrp_model</span> <span class="o">=</span> <span class="n">HierarchicalRiskParity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;HRP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hrp_model</span><span class="o">.</span><span class="n">weights</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">run_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run all allocation methods.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equal_weight</span><span class="p">()</span><span class="o">.</span><span class="n">risk_parity</span><span class="p">()</span><span class="o">.</span><span class="n">hrp</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get portfolio statistics.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">annual_returns</span><span class="p">)</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">ret</span> <span class="o">/</span> <span class="n">vol</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compare all methods.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_all</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">weights</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Method&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Volatility&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Sharpe&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Method&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot weight comparison.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_all</span><span class="p">()</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tickers</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Weight (%)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Portfolio Allocation Comparison&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Test</span>
<span class="n">allocator</span> <span class="o">=</span> <span class="n">AdvancedPortfolioAllocator</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
<span class="n">allocator</span><span class="o">.</span><span class="n">run_all</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">allocator</span><span class="o">.</span><span class="n">compare</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">allocator</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Advanced Portfolio Allocation System</h1>
<p>Build a complete system implementing all advanced techniques.</p>
<p><strong>Your Challenge:</strong></p>
<ol>
<li>Implement Equal Weight, Risk Parity, and HRP</li>
<li>Compare all methods on return, risk, and Sharpe</li>
<li>Visualize weight allocations</li>
<li>Analyze risk contribution for each method</li>
<li>Summarize findings and recommendations</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="c1"># Complete Advanced Allocation Project</span>

<span class="c1"># Step 1: Run all methods</span>
<span class="n">methods</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Equal Weight&#39;</span><span class="p">:</span> <span class="n">equal_weights</span><span class="p">,</span>
    <span class="s1">&#39;Risk Parity&#39;</span><span class="p">:</span> <span class="n">rp_weights</span><span class="p">,</span>
    <span class="s1">&#39;HRP&#39;</span><span class="p">:</span> <span class="n">hrp_weights</span>
<span class="p">}</span>

<span class="c1"># Step 2: Compare statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Method Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Method&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Return&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Volatility&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Sharpe&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">annual_returns</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">portfolio_volatility</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">vol</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ret</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">vol</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">sharpe</span><span class="si">:</span><span class="s2">&gt;10.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Step 3: Visualize allocations</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">weights</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Weight (%)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Step 4: Risk contribution analysis</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Risk Contribution Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">risk_contribution_pct</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
    <span class="n">rc_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: RC Std Dev = </span><span class="si">{</span><span class="n">rc_std</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% (lower is more balanced)&quot;</span><span class="p">)</span>

<span class="c1"># Step 5: Summary</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recommendations:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - Use Risk Parity for balanced risk contribution&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - Use HRP when you distrust return forecasts&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - Equal Weight provides a simple baseline&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Risk Parity</h3>
<ul>
<li>Allocate so each asset contributes equal risk</li>
<li>Extends to risk budgeting for custom allocations</li>
<li>More intuitive than MVO</li>
</ul>
<h3>2. Black-Litterman</h3>
<ul>
<li>Combines market equilibrium with investor views</li>
<li>More stable than pure MVO</li>
<li>Widely used by institutions</li>
</ul>
<h3>3. Robust Optimization</h3>
<ul>
<li>Shrinkage reduces estimation error</li>
<li>Resampling provides weight uncertainty estimates</li>
</ul>
<h3>4. Hierarchical Risk Parity</h3>
<ul>
<li>No return estimates needed</li>
<li>Uses clustering for asset grouping</li>
<li>Often outperforms MVO out-of-sample</li>
</ul>
<h2>When to Use Each Method</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Method</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td>Risk Parity</td>
<td>Diversified multi-asset portfolios</td>
</tr>
<tr>
<td>Black-Litterman</td>
<td>When you have specific market views</td>
</tr>
<tr>
<td>Resampling</td>
<td>When uncertain about estimates</td>
</tr>
<tr>
<td>HRP</td>
<td>When you distrust return forecasts</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Part 3: Risk Modeling</strong>, we'll dive into VaR, CVaR, stress testing, and factor models.</p>
<hr />
<p><em>Congratulations on completing Module 6!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="7"><div class="md-cell module-header"><h1>Module 7: Value at Risk (VaR)</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 3: Risk Modeling</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Calculate VaR using parametric, historical, and Monte Carlo methods</li>
<li>Understand distributional assumptions behind each VaR approach</li>
<li>Scale VaR across different time horizons</li>
<li>Implement VaR backtesting and violation analysis</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 6: Advanced Portfolio Techniques</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-7.1">Section 7.1: VaR Fundamentals</a></li>
<li><a href="#section-7.2">Section 7.2: Parametric VaR</a></li>
<li><a href="#section-7.3">Section 7.3: Historical VaR</a></li>
<li><a href="#section-7.4">Section 7.4: Monte Carlo VaR</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Libraries loaded successfully!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download portfolio data</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">]</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading historical data...&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Handle MultiIndex columns</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="n">prices</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Create a portfolio (60% equities, 40% defensive)</span>
<span class="n">portfolio_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">])</span>
<span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">portfolio_weights</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="si">}</span><span class="s2"> trading days&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">portfolio_weights</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-7.1'></a></p>
<h1>Section 7.1: VaR Fundamentals</h1>
<p><strong>Value at Risk (VaR)</strong> answers a simple but powerful question: "What is the maximum loss we might experience over a given period at a given confidence level?"</p>
<p><strong>In this section, you will learn:</strong>
- The definition and interpretation of VaR
- Common confidence levels and time horizons
- How to express VaR in percentage and dollar terms</p></div>
<div class="md-cell"><h2>7.1.1 VaR Definition</h2>
<p>VaR at confidence level $\alpha$ is the $\alpha$-th percentile of the loss distribution:</p>
<p>$$P(Loss &gt; VaR_{\alpha}) = 1 - \alpha$$</p>
<p>Common parameters:
- <strong>Confidence level</strong>: 95% or 99%
- <strong>Time horizon</strong>: 1 day, 10 days, 1 month
- <strong>Position size</strong>: Dollar amount at risk</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize the concept of VaR</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Histogram of returns</span>
<span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">portfolio_returns</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="c1"># Calculate 95% VaR</span>
<span class="n">var_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

<span class="c1"># Color the tail</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">patches</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">var_95</span><span class="p">:</span>
        <span class="n">patches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">patches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Add VaR line</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">var_95</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;95% VaR = </span><span class="si">{</span><span class="n">var_95</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Return (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Value at Risk: The 5% Worst-Case Threshold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;5</span><span class="si">% o</span><span class="s1">f days</span><span class="se">\n</span><span class="s1">worse than VaR&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">var_95</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
           <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">95% Daily VaR: </span><span class="si">{</span><span class="n">var_95</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interpretation: On 95% of days, losses will not exceed </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">var_95</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># VaR in dollar terms</span>
<span class="n">portfolio_value</span> <span class="o">=</span> <span class="mi">1_000_000</span>  <span class="c1"># $1 million portfolio</span>

<span class="n">var_95_dollars</span> <span class="o">=</span> <span class="n">portfolio_value</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">var_99_dollars</span> <span class="o">=</span> <span class="n">portfolio_value</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Value: $</span><span class="si">{</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">95% Daily VaR: $</span><span class="si">{</span><span class="n">var_95_dollars</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;99% Daily VaR: $</span><span class="si">{</span><span class="n">var_99_dollars</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>7.1.2 Time Scaling VaR</h2>
<p>To convert daily VaR to different horizons (assuming i.i.d. returns):</p>
<p>$$VaR_T = VaR_1 \times \sqrt{T}$$</p>
<p>This is the <strong>square root of time</strong> rule.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Scale VaR to different horizons</span>
<span class="n">var_1d</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">horizons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">252</span><span class="p">]</span>
<span class="n">horizon_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1 Day&#39;</span><span class="p">,</span> <span class="s1">&#39;1 Week&#39;</span><span class="p">,</span> <span class="s1">&#39;2 Weeks&#39;</span><span class="p">,</span> <span class="s1">&#39;1 Month&#39;</span><span class="p">,</span> <span class="s1">&#39;1 Quarter&#39;</span><span class="p">,</span> <span class="s1">&#39;1 Year&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;95% VaR at Different Time Horizons&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Value: $</span><span class="si">{</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">horizons</span><span class="p">,</span> <span class="n">horizon_names</span><span class="p">):</span>
    <span class="n">var_h</span> <span class="o">=</span> <span class="n">var_1d</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">var_h_dollars</span> <span class="o">=</span> <span class="n">portfolio_value</span> <span class="o">*</span> <span class="n">var_h</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">var_h</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;6.2f</span><span class="si">}</span><span class="s2">%  ($</span><span class="si">{</span><span class="n">var_h_dollars</span><span class="si">:</span><span class="s2">&gt;12,.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-7.2'></a></p>
<h1>Section 7.2: Parametric VaR</h1>
<p>Parametric VaR assumes returns follow a specific distribution (usually normal) and calculates VaR analytically.</p>
<p><strong>In this section, you will learn:</strong>
- Normal distribution VaR formula
- Student-t distribution for fat tails
- Cornish-Fisher adjustment for skewness and kurtosis</p></div>
<div class="md-cell"><h2>7.2.1 Normal Distribution VaR</h2>
<p>For normally distributed returns:</p>
<p>$$VaR_{\alpha} = \mu - z_{\alpha} \cdot \sigma$$</p>
<p>Where:
- $\mu$ = Mean return
- $\sigma$ = Standard deviation
- $z_{\alpha}$ = Standard normal quantile (1.645 for 95%, 2.326 for 99%)</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">parametric_var_normal</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate VaR assuming normal distribution.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Daily return series</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (VaR, mean, std)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">var</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span>

<span class="c1"># Calculate parametric VaR</span>
<span class="n">var_95_normal</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">parametric_var_normal</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">var_99_normal</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parametric_var_normal</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parametric VaR (Normal Distribution)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">45</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean daily return: </span><span class="si">{</span><span class="n">mu</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Daily volatility: </span><span class="si">{</span><span class="n">sigma</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">95% VaR: </span><span class="si">{</span><span class="n">var_95_normal</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;99% VaR: </span><span class="si">{</span><span class="n">var_99_normal</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>7.2.2 Student-t Distribution VaR</h2>
<p>Financial returns often have fatter tails than normal. The Student-t distribution can capture this.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">parametric_var_t</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate VaR using Student-t distribution.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Daily return series</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (VaR, degrees_of_freedom, loc, scale)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">var</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span>

<span class="n">var_95_t</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">parametric_var_t</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">var_99_t</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parametric_var_t</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parametric VaR (Student-t Distribution)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">45</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Degrees of freedom: </span><span class="si">{</span><span class="n">df</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Location: </span><span class="si">{</span><span class="n">loc</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scale: </span><span class="si">{</span><span class="n">scale</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">95% VaR: </span><span class="si">{</span><span class="n">var_95_t</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;99% VaR: </span><span class="si">{</span><span class="n">var_99_t</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Note: Lower degrees of freedom = fatter tails&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>7.2.3 Cornish-Fisher Adjustment</h2>
<p>The Cornish-Fisher expansion adjusts normal VaR for skewness and kurtosis:</p>
<p>$$z_{CF} = z + \frac{1}{6}(z^2 - 1)S + \frac{1}{24}(z^3 - 3z)(K-3) - \frac{1}{36}(2z^3 - 5z)S^2$$</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">cornish_fisher_var</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    VaR with Cornish-Fisher adjustment for skewness and kurtosis.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Daily return series</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (VaR, skewness, excess_kurtosis)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">skew</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">kurt</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    
    <span class="n">z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>
    <span class="n">z_cf</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">skew</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">+</span> 
            <span class="p">(</span><span class="n">z</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">kurt</span> <span class="o">/</span> <span class="mi">24</span> <span class="o">-</span> 
            <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">skew</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">36</span><span class="p">)</span>
    
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">z_cf</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">var</span><span class="p">,</span> <span class="n">skew</span><span class="p">,</span> <span class="n">kurt</span>

<span class="n">var_95_cf</span><span class="p">,</span> <span class="n">skew</span><span class="p">,</span> <span class="n">kurt</span> <span class="o">=</span> <span class="n">cornish_fisher_var</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">var_99_cf</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cornish_fisher_var</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cornish-Fisher VaR (Adjusted for Higher Moments)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skewness: </span><span class="si">{</span><span class="n">skew</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Excess Kurtosis: </span><span class="si">{</span><span class="n">kurt</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">95% VaR: </span><span class="si">{</span><span class="n">var_95_cf</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;99% VaR: </span><span class="si">{</span><span class="n">var_99_cf</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare all parametric methods</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parametric VaR Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Method&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;95% VaR&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;99% VaR&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Normal&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_95_normal</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">var_99_normal</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Student-t&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_95_t</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">var_99_t</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Cornish-Fisher&#39;</span><span class="si">:</span><span class="s2">&lt;20</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_95_cf</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">var_99_cf</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 7.1: Portfolio Parametric VaR (Guided)</h3>
<p><strong>Your Task:</strong> Calculate the parametric VaR for a multi-asset portfolio using the covariance matrix.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.1: Portfolio Parametric VaR (Guided)</span>
<span class="k">def</span> <span class="nf">portfolio_parametric_var</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                             <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                             <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate portfolio VaR using covariance matrix.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: DataFrame of asset returns</span>
<span class="sd">        weights: Array of portfolio weights</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with VaR and portfolio statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate the covariance matrix</span>
    <span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  
    
    <span class="c1"># TODO: Calculate mean returns for each asset</span>
    <span class="n">mean_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  
    
    <span class="c1"># TODO: Calculate portfolio mean return (weighted average)</span>
    <span class="n">port_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">mean_returns</span><span class="p">)</span>  
    
    <span class="c1"># TODO: Calculate portfolio variance using w&#39; * Cov * w</span>
    <span class="n">port_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>  
    
    <span class="c1"># TODO: Calculate portfolio standard deviation</span>
    <span class="n">port_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">port_variance</span><span class="p">)</span>  
    
    <span class="c1"># Calculate VaR using normal distribution</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">port_mean</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">port_std</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
        <span class="s1">&#39;port_mean&#39;</span><span class="p">:</span> <span class="n">port_mean</span><span class="p">,</span>
        <span class="s1">&#39;port_std&#39;</span><span class="p">:</span> <span class="n">port_std</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># result = portfolio_parametric_var(returns, portfolio_weights, 0.95)</span>
<span class="c1"># print(f&quot;Portfolio VaR (95%): {result[&#39;var&#39;]*100:.2f}%&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">portfolio_parametric_var</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                             <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                             <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
    <span class="n">mean_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">port_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">mean_returns</span><span class="p">)</span>
    <span class="n">port_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>
    <span class="n">port_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">port_variance</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">port_mean</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">port_std</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
        <span class="s1">&#39;port_mean&#39;</span><span class="p">:</span> <span class="n">port_mean</span><span class="p">,</span>
        <span class="s1">&#39;port_std&#39;</span><span class="p">:</span> <span class="n">port_std</span>
    <span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">portfolio_parametric_var</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">portfolio_weights</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio VaR (95%): </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Mean: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;port_mean&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Std: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;port_std&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-7.3'></a></p>
<h1>Section 7.3: Historical VaR</h1>
<p>Historical simulation uses actual past returns‚Äîno distributional assumptions needed. The VaR is simply a percentile of historical returns.</p>
<p><strong>In this section, you will learn:</strong>
- Basic historical VaR calculation
- Age-weighted historical VaR
- Rolling VaR for time-varying risk</p></div>
<div class="md-cell"><h2>7.3.1 Basic Historical VaR</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">historical_var</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate VaR using historical simulation.&quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">var</span>

<span class="c1"># Calculate historical VaR</span>
<span class="n">var_95_hist</span> <span class="o">=</span> <span class="n">historical_var</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">var_99_hist</span> <span class="o">=</span> <span class="n">historical_var</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Historical Simulation VaR&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% VaR: </span><span class="si">{</span><span class="n">var_95_hist</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;99% VaR: </span><span class="si">{</span><span class="n">var_99_hist</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="c1"># Show worst days</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Worst 5 days in history:&quot;</span><span class="p">)</span>
<span class="n">worst_days</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">worst_days</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ret</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>7.3.2 Age-Weighted Historical VaR</h2>
<p>Recent data is often more relevant than older data. We can weight observations by recency using exponential decay.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">age_weighted_var</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                     <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> 
                     <span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.97</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Historical VaR with exponential age weighting.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Return series</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">        decay: Decay factor (lambda)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (VaR, weights)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">decay</span> <span class="o">**</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">sorted_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>
    <span class="n">sorted_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>
    
    <span class="n">cumulative_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sorted_weights</span><span class="p">)</span>
    <span class="n">var_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cumulative_weights</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">sorted_returns</span><span class="p">[</span><span class="n">var_idx</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">var</span><span class="p">,</span> <span class="n">weights</span>

<span class="n">var_95_aw</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">age_weighted_var</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">var_99_aw</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">age_weighted_var</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Age-Weighted Historical VaR (Œª = 0.97)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">45</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% VaR: </span><span class="si">{</span><span class="n">var_95_aw</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;99% VaR: </span><span class="si">{</span><span class="n">var_99_aw</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comparison with equal-weighted:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Equal-weighted 95% VaR: </span><span class="si">{</span><span class="n">var_95_hist</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Age-weighted 95% VaR: </span><span class="si">{</span><span class="n">var_95_aw</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>7.3.3 Rolling Historical VaR</h2>
<p>VaR should be monitored over time, not just calculated once.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate rolling VaR</span>
<span class="n">window</span> <span class="o">=</span> <span class="mi">252</span>  <span class="c1"># 1 year</span>

<span class="n">rolling_var_95</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">rolling_var_99</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Top: Returns vs VaR</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">portfolio_returns</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Daily Returns&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_var_95</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="n">rolling_var_95</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% VaR Threshold&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">rolling_var_95</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="n">rolling_var_95</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Return (%)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Daily Returns vs Rolling 95% VaR&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># Bottom: Rolling VaR levels</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_var_95</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_var_95</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% VaR&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_var_99</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_var_99</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;99% VaR&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;VaR (%)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling VaR Over Time (252-day window)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 7.2: Weighted Historical VaR (Guided)</h3>
<p><strong>Your Task:</strong> Implement a function that calculates historical VaR with custom weighting schemes.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.2: Weighted Historical VaR (Guided)</span>
<span class="k">def</span> <span class="nf">weighted_historical_var</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                            <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate historical VaR with custom weights.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Return series</span>
<span class="sd">        weights: Array of weights (same length as returns)</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        VaR value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Normalize weights to sum to 1</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  
    
    <span class="c1"># TODO: Sort returns from lowest to highest</span>
    <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>  
    
    <span class="c1"># Get sorted returns and corresponding weights</span>
    <span class="n">sorted_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>
    <span class="n">sorted_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>
    
    <span class="c1"># TODO: Calculate cumulative weights</span>
    <span class="n">cumulative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">sorted_weights</span><span class="p">)</span>  
    
    <span class="c1"># TODO: Find the index where cumulative weight exceeds (1-confidence)</span>
    <span class="n">var_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">cumulative</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>  
    
    <span class="c1"># Return VaR as positive number</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">sorted_returns</span><span class="p">[</span><span class="n">var_idx</span><span class="p">]</span>

<span class="c1"># Test your solution</span>
<span class="c1"># equal_weights = np.ones(len(portfolio_returns)) / len(portfolio_returns)</span>
<span class="c1"># var_equal = weighted_historical_var(portfolio_returns, equal_weights, 0.95)</span>
<span class="c1"># print(f&quot;Equal-weighted VaR: {var_equal*100:.2f}%&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">weighted_historical_var</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                            <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">sorted_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>
    <span class="n">sorted_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>
    <span class="n">cumulative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sorted_weights</span><span class="p">)</span>
    <span class="n">var_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cumulative</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">sorted_returns</span><span class="p">[</span><span class="n">var_idx</span><span class="p">]</span>

<span class="c1"># Test with equal weights</span>
<span class="n">equal_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">))</span>
<span class="n">var_equal</span> <span class="o">=</span> <span class="n">weighted_historical_var</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">equal_weights</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Equal-weighted VaR: </span><span class="si">{</span><span class="n">var_equal</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="c1"># Test with recency weights</span>
<span class="n">recency_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">var_recency</span> <span class="o">=</span> <span class="n">weighted_historical_var</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">recency_weights</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recency-weighted VaR: </span><span class="si">{</span><span class="n">var_recency</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 7.3: VaR Method Comparison (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that compares VaR estimates across multiple methods and confidence levels:
- Calculate VaR using Normal, Student-t, Historical, and Cornish-Fisher methods
- Compare results at both 95% and 99% confidence levels
- Return results as a formatted DataFrame</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.3: VaR Method Comparison (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compare_var_methods</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                        <span class="n">confidence_levels</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare VaR estimates across multiple methods.</span>

<span class="sd">    Args:</span>
<span class="sd">        returns: Return series</span>
<span class="sd">        confidence_levels: List of confidence levels</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with VaR comparisons</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">confidence_levels</span><span class="p">:</span>
        <span class="c1"># Normal VaR</span>
        <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">conf</span><span class="p">)</span>
        <span class="n">var_normal</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="c1"># Student-t VaR</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="n">var_t</span> <span class="o">=</span> <span class="o">-</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">conf</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

        <span class="c1"># Historical VaR</span>
        <span class="n">var_hist</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">conf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

        <span class="c1"># Cornish-Fisher VaR</span>
        <span class="n">skew</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="n">kurt</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="n">z_cf</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">skew</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">+</span> 
                <span class="p">(</span><span class="n">z</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">kurt</span> <span class="o">/</span> <span class="mi">24</span> <span class="o">-</span> 
                <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">skew</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">36</span><span class="p">)</span>
        <span class="n">var_cf</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">z_cf</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Confidence&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">conf</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Normal&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_normal</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Student-t&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_t</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Historical&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_hist</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Cornish-Fisher&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_cf</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">comparison</span> <span class="o">=</span> <span class="n">compare_var_methods</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VaR Method Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-7.4'></a></p>
<h1>Section 7.4: Monte Carlo VaR</h1>
<p>Monte Carlo simulation generates thousands of possible scenarios based on assumed distributions. This is flexible‚Äîwe can model fat tails, correlations, and complex portfolios.</p>
<p><strong>In this section, you will learn:</strong>
- Basic Monte Carlo VaR with normal distribution
- Monte Carlo with fat tails (Student-t)
- Correlated multi-asset Monte Carlo</p></div>
<div class="md-cell"><h2>7.4.1 Basic Monte Carlo VaR</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">monte_carlo_var</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                    <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> 
                    <span class="n">n_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> 
                    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monte Carlo VaR assuming normal distribution.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        mu: Mean return</span>
<span class="sd">        sigma: Standard deviation</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">        n_simulations: Number of simulations</span>
<span class="sd">        seed: Random seed</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (VaR, simulated_returns)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">simulated_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">simulated_returns</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">var</span><span class="p">,</span> <span class="n">simulated_returns</span>

<span class="c1"># Calculate MC VaR</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="n">var_95_mc</span><span class="p">,</span> <span class="n">sim_returns</span> <span class="o">=</span> <span class="n">monte_carlo_var</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">var_99_mc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">monte_carlo_var</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Monte Carlo VaR (10,000 simulations)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">45</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% VaR: </span><span class="si">{</span><span class="n">var_95_mc</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;99% VaR: </span><span class="si">{</span><span class="n">var_99_mc</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize simulated distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Historical vs Simulated</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">portfolio_returns</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Historical&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_returns</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MC Simulated&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="n">var_95_hist</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Hist VaR: </span><span class="si">{</span><span class="n">var_95_hist</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="n">var_95_mc</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;MC VaR: </span><span class="si">{</span><span class="n">var_95_mc</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Return (%)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Historical vs Monte Carlo Distribution&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Q-Q plot</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot: Returns vs Normal&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Q-Q plot shows fat tails: extreme returns exceed normal expectations.&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>7.4.2 Monte Carlo with Fat Tails</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">monte_carlo_var_t</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                      <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> 
                      <span class="n">n_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> 
                      <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monte Carlo VaR using fitted Student-t distribution.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Historical returns for fitting</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">        n_simulations: Number of simulations</span>
<span class="sd">        seed: Random seed</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (VaR, simulated_returns, degrees_of_freedom)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">simulated</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_simulations</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">simulated</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">var</span><span class="p">,</span> <span class="n">simulated</span><span class="p">,</span> <span class="n">df</span>

<span class="n">var_95_mc_t</span><span class="p">,</span> <span class="n">sim_t</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">monte_carlo_var_t</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">var_99_mc_t</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">monte_carlo_var_t</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Monte Carlo VaR with Student-t Distribution&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitted degrees of freedom: </span><span class="si">{</span><span class="n">df</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">95% VaR: </span><span class="si">{</span><span class="n">var_95_mc_t</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;99% VaR: </span><span class="si">{</span><span class="n">var_99_mc_t</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fat tails increase extreme risk estimates by </span><span class="si">{</span><span class="p">((</span><span class="n">var_99_mc_t</span> <span class="o">-</span> <span class="n">var_99_mc</span><span class="p">)</span><span class="o">/</span><span class="n">var_99_mc</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>7.4.3 Correlated Multi-Asset Monte Carlo</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">multivariate_mc_var</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                        <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                        <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> 
                        <span class="n">n_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> 
                        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monte Carlo VaR for multi-asset portfolio with correlations.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: DataFrame of asset returns</span>
<span class="sd">        weights: Portfolio weights</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">        n_simulations: Number of simulations</span>
<span class="sd">        seed: Random seed</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (VaR, portfolio_returns, asset_returns)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">mean_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    
    <span class="n">simulated_asset_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span>
        <span class="n">mean_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">,</span> <span class="n">n_simulations</span>
    <span class="p">)</span>
    
    <span class="n">simulated_portfolio_returns</span> <span class="o">=</span> <span class="n">simulated_asset_returns</span> <span class="o">@</span> <span class="n">weights</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">simulated_portfolio_returns</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">var</span><span class="p">,</span> <span class="n">simulated_portfolio_returns</span><span class="p">,</span> <span class="n">simulated_asset_returns</span>

<span class="n">var_95_multi</span><span class="p">,</span> <span class="n">sim_port</span><span class="p">,</span> <span class="n">sim_assets</span> <span class="o">=</span> <span class="n">multivariate_mc_var</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">portfolio_weights</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">var_99_multi</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">multivariate_mc_var</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">portfolio_weights</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multi-Asset Monte Carlo VaR (with Correlations)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">portfolio_weights</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">95% VaR: </span><span class="si">{</span><span class="n">var_95_multi</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;99% VaR: </span><span class="si">{</span><span class="n">var_99_multi</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare all VaR methods</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">VaR Method Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Method&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;95% VaR&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;99% VaR&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Parametric (Normal)&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_95_normal</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">var_99_normal</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Parametric (Student-t)&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_95_t</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">var_99_t</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Parametric (CF)&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_95_cf</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">var_99_cf</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Historical&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_95_hist</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">var_99_hist</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Age-Weighted Historical&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_95_aw</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">var_99_aw</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Monte Carlo (Normal)&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_95_mc</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">var_99_mc</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Monte Carlo (t-dist)&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_95_mc_t</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">var_99_mc_t</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;MC Multi-Asset&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_95_multi</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">var_99_multi</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 7.4: Monte Carlo Simulation Engine (Guided)</h3>
<p><strong>Your Task:</strong> Build a Monte Carlo simulator that can use different distribution assumptions.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.4: Monte Carlo Simulation Engine (Guided)</span>
<span class="k">def</span> <span class="nf">monte_carlo_engine</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                       <span class="n">n_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
                       <span class="n">distribution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span>
                       <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate Monte Carlo simulations using different distributions.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Historical returns for parameter estimation</span>
<span class="sd">        n_simulations: Number of simulations</span>
<span class="sd">        distribution: &#39;normal&#39; or &#39;t&#39;</span>
<span class="sd">        seed: Random seed</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Array of simulated returns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
        <span class="c1"># TODO: Calculate mean and std from returns</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  
        
        <span class="c1"># TODO: Generate normal random samples</span>
        <span class="n">simulated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">)</span>  
        
    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
        <span class="c1"># TODO: Fit Student-t distribution</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>  
        
        <span class="c1"># TODO: Generate Student-t random samples</span>
        <span class="n">simulated</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_simulations</span><span class="p">)</span>  
    
    <span class="k">return</span> <span class="n">simulated</span>

<span class="c1"># Test your solution</span>
<span class="c1"># sim_normal = monte_carlo_engine(portfolio_returns, distribution=&#39;normal&#39;)</span>
<span class="c1"># sim_t = monte_carlo_engine(portfolio_returns, distribution=&#39;t&#39;)</span>
<span class="c1"># print(f&quot;Normal VaR: {-np.percentile(sim_normal, 5)*100:.2f}%&quot;)</span>
<span class="c1"># print(f&quot;Student-t VaR: {-np.percentile(sim_t, 5)*100:.2f}%&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">monte_carlo_engine</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                       <span class="n">n_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
                       <span class="n">distribution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span>
                       <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">simulated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="n">simulated</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_simulations</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">simulated</span>

<span class="c1"># Test</span>
<span class="n">sim_normal</span> <span class="o">=</span> <span class="n">monte_carlo_engine</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span>
<span class="n">sim_t</span> <span class="o">=</span> <span class="n">monte_carlo_engine</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Monte Carlo Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normal 95% VaR: </span><span class="si">{</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sim_normal</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normal 99% VaR: </span><span class="si">{</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sim_normal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Student-t 95% VaR: </span><span class="si">{</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sim_t</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Student-t 99% VaR: </span><span class="si">{</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sim_t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 7.5: VaR Backtesting (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a VaR backtesting function that:
- Calculates rolling VaR over a specified window
- Counts how many times actual losses exceeded VaR (violations)
- Compares violation rate to expected rate
- Returns detailed statistics and violation dates</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.5: VaR Backtesting (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">backtest_var</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                 <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">,</span>
                 <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
                 <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;historical&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Backtest VaR model by comparing predictions to actual losses.</span>

<span class="sd">    Args:</span>
<span class="sd">        returns: Return series</span>
<span class="sd">        window: Rolling window for VaR calculation</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">        method: &#39;historical&#39; or &#39;parametric&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with backtest results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate rolling VaR</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;historical&#39;</span><span class="p">:</span>
        <span class="n">rolling_var</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">confidence</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># parametric</span>
        <span class="k">def</span> <span class="nf">calc_param_var</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">rolling_var</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">calc_param_var</span><span class="p">)</span>

    <span class="n">rolling_var</span> <span class="o">=</span> <span class="n">rolling_var</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">aligned_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rolling_var</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

    <span class="c1"># Find violations (actual loss &gt; VaR)</span>
    <span class="n">violations</span> <span class="o">=</span> <span class="n">aligned_returns</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">rolling_var</span>
    <span class="n">violation_dates</span> <span class="o">=</span> <span class="n">violations</span><span class="p">[</span><span class="n">violations</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># Statistics</span>
    <span class="n">total_days</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rolling_var</span><span class="p">)</span>
    <span class="n">violation_count</span> <span class="o">=</span> <span class="n">violations</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">expected_rate</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span>
    <span class="n">actual_rate</span> <span class="o">=</span> <span class="n">violation_count</span> <span class="o">/</span> <span class="n">total_days</span>

    <span class="c1"># Kupiec test (binomial test)</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binom_test</span><span class="p">(</span><span class="n">violation_count</span><span class="p">,</span> <span class="n">total_days</span><span class="p">,</span> <span class="n">expected_rate</span><span class="p">,</span>
                               <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_days&#39;</span><span class="p">:</span> <span class="n">total_days</span><span class="p">,</span>
        <span class="s1">&#39;violations&#39;</span><span class="p">:</span> <span class="n">violation_count</span><span class="p">,</span>
        <span class="s1">&#39;expected_violations&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_days</span> <span class="o">*</span> <span class="n">expected_rate</span><span class="p">),</span>
        <span class="s1">&#39;expected_rate&#39;</span><span class="p">:</span> <span class="n">expected_rate</span><span class="p">,</span>
        <span class="s1">&#39;actual_rate&#39;</span><span class="p">:</span> <span class="n">actual_rate</span><span class="p">,</span>
        <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
        <span class="s1">&#39;model_valid&#39;</span><span class="p">:</span> <span class="n">p_value</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="s1">&#39;violation_dates&#39;</span><span class="p">:</span> <span class="n">violation_dates</span><span class="p">,</span>
        <span class="s1">&#39;rolling_var&#39;</span><span class="p">:</span> <span class="n">rolling_var</span>
    <span class="p">}</span>

<span class="c1"># Run backtest</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">backtest_var</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VaR Backtest Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total days tested: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_days&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected violations (5%): </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;expected_violations&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Actual violations: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;violations&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Actual rate: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;actual_rate&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;P-value (Kupiec test): </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model valid (p &gt; 0.05): </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;model_valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 7.6: Complete VaR Analysis System (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a comprehensive VaR class that includes:
- Multiple calculation methods (parametric, historical, Monte Carlo)
- Time scaling to different horizons
- Dollar VaR conversion for a given portfolio value
- Backtesting capability
- Summary report method</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 7.6: Complete VaR Analysis System (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VaRAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive Value at Risk analyzer.</span>

<span class="sd">    Supports multiple calculation methods, time scaling,</span>
<span class="sd">    and backtesting capabilities.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1_000_000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">portfolio_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">parametric_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;normal_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">return</span> <span class="n">var</span>

    <span class="k">def</span> <span class="nf">parametric_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;t_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">return</span> <span class="n">var</span>

    <span class="k">def</span> <span class="nf">historical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hist_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">return</span> <span class="n">var</span>

    <span class="k">def</span> <span class="nf">monte_carlo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> 
                    <span class="n">n_sims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="n">n_sims</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sims</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mc_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">return</span> <span class="n">var</span>

    <span class="k">def</span> <span class="nf">scale_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_var</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scale daily VaR to different time horizon.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">daily_var</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dollar_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert percentage VaR to dollar amount.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">*</span> <span class="n">var_pct</span>

    <span class="k">def</span> <span class="nf">calculate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_normal</span><span class="p">(</span><span class="n">confidence</span><span class="p">),</span>
            <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_t</span><span class="p">(</span><span class="n">confidence</span><span class="p">),</span>
            <span class="s1">&#39;historical&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical</span><span class="p">(</span><span class="n">confidence</span><span class="p">),</span>
            <span class="s1">&#39;monte_carlo&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">monte_carlo</span><span class="p">(</span><span class="n">confidence</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">rolling_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">confidence</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">aligned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rolling_var</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">violations</span> <span class="o">=</span> <span class="p">(</span><span class="n">aligned</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">rolling_var</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rolling_var</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;violations&#39;</span><span class="p">:</span> <span class="n">violations</span><span class="p">,</span>
            <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span>
            <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">violations</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rolling_var</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VaR ANALYSIS SUMMARY&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Value: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_all</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">conf</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">% Confidence Level:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dollar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dollar_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">method</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">var</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;6.2f</span><span class="si">}</span><span class="s2">% ($</span><span class="si">{</span><span class="n">dollar</span><span class="si">:</span><span class="s2">&gt;12,.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">bt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Backtest Results:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Violations: </span><span class="si">{</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;violations&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (expected: </span><span class="si">{</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;expected&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Rate: </span><span class="si">{</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">VaRAnalyzer</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">)</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Production VaR Risk System</h1>
<p>Build a comprehensive VaR calculation and monitoring system suitable for production use.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductionVaRSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready Value at Risk system.</span>

<span class="sd">    Features:</span>
<span class="sd">    - Multiple VaR calculation methods</span>
<span class="sd">    - Portfolio-level and asset-level analysis</span>
<span class="sd">    - Backtesting and violation tracking</span>
<span class="sd">    - Time horizon scaling</span>
<span class="sd">    - Comprehensive reporting</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                 <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">portfolio_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1_000_000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize VaR system.</span>

<span class="sd">        Args:</span>
<span class="sd">            returns: DataFrame of asset returns</span>
<span class="sd">            weights: Portfolio weights (equal if None)</span>
<span class="sd">            portfolio_value: Dollar value of portfolio</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> \
                       <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">portfolio_value</span>

        <span class="c1"># Calculate portfolio returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>

        <span class="c1"># Store results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">parametric_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> 
                       <span class="n">distribution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate parametric VaR.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span>

        <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
            <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;cornish_fisher&#39;</span><span class="p">:</span>
            <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">skew</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="n">kurt</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>
            <span class="n">z_cf</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">skew</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">+</span> 
                    <span class="p">(</span><span class="n">z</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">kurt</span> <span class="o">/</span> <span class="mi">24</span> <span class="o">-</span> 
                    <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">z</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">skew</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">36</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">z_cf</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var_results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;parametric_</span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span> <span class="s1">&#39;dollar_var&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">historical_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
                       <span class="n">weighted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.97</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate historical VaR.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">weighted</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">decay</span> <span class="o">**</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="n">sorted_returns</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>
            <span class="n">sorted_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span>
            <span class="n">cumulative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sorted_weights</span><span class="p">)</span>
            <span class="n">var_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cumulative</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">sorted_returns</span><span class="p">[</span><span class="n">var_idx</span><span class="p">]</span>

        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;historical_weighted&#39;</span> <span class="k">if</span> <span class="n">weighted</span> <span class="k">else</span> <span class="s1">&#39;historical&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span> <span class="s1">&#39;dollar_var&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">monte_carlo_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
                        <span class="n">n_sims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
                        <span class="n">multivariate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Monte Carlo VaR.&quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">multivariate</span><span class="p">:</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">n_sims</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mean_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
            <span class="n">cov_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
            <span class="n">asset_sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span>
                <span class="n">mean_returns</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">,</span> <span class="n">n_sims</span>
            <span class="p">)</span>
            <span class="n">sims</span> <span class="o">=</span> <span class="n">asset_sims</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>

        <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sims</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;mc_multivariate&#39;</span> <span class="k">if</span> <span class="n">multivariate</span> <span class="k">else</span> <span class="s1">&#39;mc_univariate&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span> <span class="s1">&#39;dollar_var&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">scale_to_horizon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_var</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">horizon</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scale daily VaR to different time horizon.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">daily_var</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">horizon</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate VaR using all methods.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Parametric methods</span>
        <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;cornish_fisher&#39;</span><span class="p">]:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_var</span><span class="p">(</span><span class="n">confidence</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Method&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Parametric (</span><span class="si">{</span><span class="n">dist</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;VaR (%)&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s1">&#39;Dollar VaR&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;dollar_var&#39;</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="c1"># Historical methods</span>
        <span class="k">for</span> <span class="n">weighted</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_var</span><span class="p">(</span><span class="n">confidence</span><span class="p">,</span> <span class="n">weighted</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Historical (weighted)&#39;</span> <span class="k">if</span> <span class="n">weighted</span> <span class="k">else</span> <span class="s1">&#39;Historical&#39;</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Method&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;VaR (%)&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s1">&#39;Dollar VaR&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;dollar_var&#39;</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="c1"># Monte Carlo methods</span>
        <span class="k">for</span> <span class="n">multi</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monte_carlo_var</span><span class="p">(</span><span class="n">confidence</span><span class="p">,</span> <span class="n">multivariate</span><span class="o">=</span><span class="n">multi</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Monte Carlo (multi)&#39;</span> <span class="k">if</span> <span class="n">multi</span> <span class="k">else</span> <span class="s1">&#39;Monte Carlo&#39;</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Method&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;VaR (%)&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s1">&#39;Dollar VaR&#39;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;dollar_var&#39;</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Backtest VaR model.&quot;&quot;&quot;</span>
        <span class="n">rolling_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">aligned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rolling_var</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">violations</span> <span class="o">=</span> <span class="n">aligned</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">rolling_var</span>
        <span class="n">violation_count</span> <span class="o">=</span> <span class="n">violations</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total_days</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rolling_var</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">total_days</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_days&#39;</span><span class="p">:</span> <span class="n">total_days</span><span class="p">,</span>
            <span class="s1">&#39;violations&#39;</span><span class="p">:</span> <span class="n">violation_count</span><span class="p">,</span>
            <span class="s1">&#39;expected&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span>
            <span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">violation_count</span> <span class="o">/</span> <span class="n">total_days</span><span class="p">,</span>
            <span class="s1">&#39;expected_rate&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">,</span>
            <span class="s1">&#39;pass&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">violation_count</span> <span class="o">-</span> <span class="n">expected</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive VaR report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PRODUCTION VaR RISK REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Portfolio Value: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assets: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weights: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># VaR at multiple confidence levels</span>
        <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">conf</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">% VALUE AT RISK&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_all</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Dollar VaR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Dollar VaR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;VaR (%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;VaR (%)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="c1"># Time horizon scaling</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TIME HORIZON SCALING (95% Historical VaR)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">base_var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">horizons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;1 Day&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;1 Week&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;2 Weeks&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> 
                    <span class="s1">&#39;1 Month&#39;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span> <span class="s1">&#39;1 Quarter&#39;</span><span class="p">:</span> <span class="mi">63</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">days</span> <span class="ow">in</span> <span class="n">horizons</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_to_horizon</span><span class="p">(</span><span class="n">base_var</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
            <span class="n">dollar</span> <span class="o">=</span> <span class="n">scaled</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">scaled</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;6.2f</span><span class="si">}</span><span class="s2">% ($</span><span class="si">{</span><span class="n">dollar</span><span class="si">:</span><span class="s2">&gt;12,.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Backtest</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BACKTEST RESULTS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">bt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total days tested: </span><span class="si">{</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;total_days&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expected violations (5%): </span><span class="si">{</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;expected&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Actual violations: </span><span class="si">{</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;violations&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Violation rate: </span><span class="si">{</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Model status: </span><span class="si">{</span><span class="s1">&#39;PASS&#39;</span> <span class="k">if</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;pass&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;FAIL&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Test the production system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">ProductionVaRSystem</span><span class="p">(</span>
    <span class="n">returns</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="n">portfolio_weights</span><span class="p">,</span>
    <span class="n">portfolio_value</span><span class="o">=</span><span class="mi">1_000_000</span>
<span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. VaR Fundamentals</h3>
<ul>
<li>VaR measures maximum expected loss at a given confidence level</li>
<li>Common parameters: 95%/99% confidence, 1-day horizon</li>
<li>Square root of time rule for scaling horizons</li>
</ul>
<h3>2. Parametric VaR</h3>
<ul>
<li>Normal: $VaR = \mu - z_\alpha \sigma$</li>
<li>Student-t captures fat tails</li>
<li>Cornish-Fisher adjusts for skewness and kurtosis</li>
</ul>
<h3>3. Historical VaR</h3>
<ul>
<li>No distributional assumptions required</li>
<li>Age-weighted for recency bias</li>
<li>Rolling VaR for time-varying risk</li>
</ul>
<h3>4. Monte Carlo VaR</h3>
<ul>
<li>Flexible for complex portfolios</li>
<li>Can incorporate correlations and fat tails</li>
<li>Multivariate simulation for portfolio risk</li>
</ul>
<h3>VaR Limitations</h3>
<ul>
<li>Doesn't tell you how bad losses can be beyond VaR</li>
<li>Not sub-additive (can violate diversification)</li>
<li>Assumes historical patterns continue</li>
</ul></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 8: Beyond VaR</strong>, we'll explore:
- Expected Shortfall (CVaR) for tail risk
- Stress testing with historical and hypothetical scenarios
- Drawdown analysis and duration risk
- Advanced tail risk measures</p>
<hr />
<p><em>Congratulations on completing Module 7!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="8"><div class="md-cell module-header"><h1>Module 8: Beyond VaR</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 3: Risk Modeling</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Calculate Expected Shortfall (CVaR) and understand its advantages over VaR</li>
<li>Design and implement historical and hypothetical stress tests</li>
<li>Analyze drawdowns and duration risk</li>
<li>Apply advanced tail risk measures including Omega and Sortino ratios</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 7: Value at Risk</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-8.1">Section 8.1: Expected Shortfall (CVaR)</a></li>
<li><a href="#section-8.2">Section 8.2: Stress Testing</a></li>
<li><a href="#section-8.3">Section 8.3: Drawdown Analysis</a></li>
<li><a href="#section-8.4">Section 8.4: Tail Risk Measures</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Libraries loaded successfully!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download portfolio data</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2006-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Handle MultiIndex columns</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">tickers</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="n">prices</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Portfolio weights</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">])</span>
<span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data loaded: </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assets: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total observations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-8.1'></a></p>
<h1>Section 8.1: Expected Shortfall (CVaR)</h1>
<p>VaR tells you the threshold loss at a given confidence level, but it says nothing about how bad things can get when you exceed that threshold. <strong>Expected Shortfall (ES)</strong>, also called <strong>Conditional VaR (CVaR)</strong>, addresses this limitation.</p>
<p><strong>In this section, you will learn:</strong>
- The definition and interpretation of Expected Shortfall
- Why regulators prefer ES over VaR
- Multiple calculation methods for ES</p></div>
<div class="md-cell"><h2>8.1.1 Expected Shortfall Definition</h2>
<p><strong>Expected Shortfall</strong> at confidence level $\alpha$ measures the expected loss given that we've exceeded VaR:</p>
<p>$$ES_{\alpha} = E[L | L &gt; VaR_{\alpha}]$$</p>
<p>In plain English: "When bad days happen, how bad are they on average?"</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_var_es</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate VaR and Expected Shortfall using historical simulation.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Historical returns</span>
<span class="sd">        confidence: Confidence level (e.g., 0.95 for 95%)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (VaR, ES) both as positive numbers representing losses</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">returns_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span>
    
    <span class="c1"># VaR is the alpha quantile of returns</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns_arr</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    
    <span class="c1"># ES is the average of returns worse than VaR</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns_arr</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">tail_returns</span> <span class="o">=</span> <span class="n">returns_arr</span><span class="p">[</span><span class="n">returns_arr</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">]</span>
    <span class="n">es</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tail_returns</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">var</span><span class="p">,</span> <span class="n">es</span>

<span class="c1"># Calculate for SPY</span>
<span class="n">spy_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>
<span class="n">var_95</span><span class="p">,</span> <span class="n">es_95</span> <span class="o">=</span> <span class="n">calculate_var_es</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">var_99</span><span class="p">,</span> <span class="n">es_99</span> <span class="o">=</span> <span class="n">calculate_var_es</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SPY Risk Measures (Historical)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">95% Confidence:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  VaR:               </span><span class="si">{</span><span class="n">var_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expected Shortfall: </span><span class="si">{</span><span class="n">es_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ES/VaR Ratio:      </span><span class="si">{</span><span class="n">es_95</span><span class="o">/</span><span class="n">var_95</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">99% Confidence:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  VaR:               </span><span class="si">{</span><span class="n">var_99</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expected Shortfall: </span><span class="si">{</span><span class="n">es_99</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ES/VaR Ratio:      </span><span class="si">{</span><span class="n">es_99</span><span class="o">/</span><span class="n">var_99</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize the difference between VaR and ES</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Left plot: Distribution with VaR and ES</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">var_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> 
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

<span class="c1"># Color the tail</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">left_edge</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">patches</span><span class="p">,</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
    <span class="k">if</span> <span class="n">left_edge</span> <span class="o">&lt;</span> <span class="n">var_threshold</span><span class="p">:</span>
        <span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="o">-</span><span class="n">var_95</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;95% VaR: </span><span class="si">{</span><span class="n">var_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="o">-</span><span class="n">es_95</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;95% ES: </span><span class="si">{</span><span class="n">es_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Return&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;VaR vs Expected Shortfall</span><span class="se">\n</span><span class="s1">(Red area = Tail losses beyond VaR)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">)</span>

<span class="c1"># Right plot: Tail losses only</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">tail_losses</span> <span class="o">=</span> <span class="o">-</span><span class="n">spy_returns</span><span class="p">[</span><span class="n">spy_returns</span> <span class="o">&lt;</span> <span class="n">var_threshold</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tail_losses</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">var_95</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;VaR: </span><span class="si">{</span><span class="n">var_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">es_95</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ES (avg): </span><span class="si">{</span><span class="n">es_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Loss (%)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Distribution of Tail Losses</span><span class="se">\n</span><span class="s1">(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tail_losses</span><span class="p">)</span><span class="si">}</span><span class="s1"> observations beyond VaR)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Key Insight: When losses exceed VaR (</span><span class="si">{</span><span class="n">var_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%), they average </span><span class="si">{</span><span class="n">es_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>8.1.2 Why Regulators Prefer Expected Shortfall</h2>
<p>The Basel Committee shifted from VaR to ES for several reasons:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Property</th>
<th>VaR</th>
<th>Expected Shortfall</th>
</tr>
</thead>
<tbody>
<tr>
<td>Captures tail risk</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>Coherent risk measure</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>Sub-additive</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>Penalizes concentration</td>
<td>No</td>
<td>Yes</td>
</tr>
</tbody>
</table></div>
<p><strong>Sub-additivity</strong> is crucial: $Risk(A + B) \leq Risk(A) + Risk(B)$</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Demonstrate sub-additivity with portfolio diversification</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sub-Additivity Test: Diversification Benefits&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="c1"># Individual asset risk measures</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">var</span><span class="p">,</span> <span class="n">es</span> <span class="o">=</span> <span class="n">calculate_var_es</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">asset</span><span class="p">],</span> <span class="mf">0.95</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Asset&#39;</span><span class="p">:</span> <span class="n">asset</span><span class="p">,</span> <span class="s1">&#39;VaR_95&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span> <span class="s1">&#39;ES_95&#39;</span><span class="p">:</span> <span class="n">es</span><span class="p">})</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset</span><span class="si">}</span><span class="s2">: VaR = </span><span class="si">{</span><span class="n">var</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%, ES = </span><span class="si">{</span><span class="n">es</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="c1"># Equal-weighted portfolio</span>
<span class="n">port_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">port_var</span><span class="p">,</span> <span class="n">port_es</span> <span class="o">=</span> <span class="n">calculate_var_es</span><span class="p">(</span><span class="n">port_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>

<span class="c1"># Average of individual risks</span>
<span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">avg_var</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;VaR_95&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">avg_es</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;ES_95&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio (equal-weight):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  VaR:  </span><span class="si">{</span><span class="n">port_var</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%  (vs avg individual: </span><span class="si">{</span><span class="n">avg_var</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ES:   </span><span class="si">{</span><span class="n">port_es</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%  (vs avg individual: </span><span class="si">{</span><span class="n">avg_es</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Diversification Benefit:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  VaR reduction: </span><span class="si">{</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">port_var</span><span class="o">/</span><span class="n">avg_var</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ES reduction:  </span><span class="si">{</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">port_es</span><span class="o">/</span><span class="n">avg_es</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>8.1.3 Parametric Expected Shortfall</h2>
<p>For normally distributed returns, ES has a closed-form solution:</p>
<p>$$ES_{\alpha} = \mu + \sigma \cdot \frac{\phi(z_{\alpha})}{1-\alpha}$$</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">parametric_es</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                  <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span> 
                  <span class="n">distribution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Expected Shortfall using parametric methods.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Historical returns for parameter estimation</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">        distribution: &#39;normal&#39; or &#39;t&#39; for Student-t</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (VaR, ES)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">returns_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns_arr</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns_arr</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span>
    
    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
        <span class="n">z_alpha</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">z_alpha</span><span class="p">)</span>
        <span class="n">es</span> <span class="o">=</span> <span class="o">-</span><span class="n">mu</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">z_alpha</span><span class="p">)</span> <span class="o">/</span> <span class="n">alpha</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Student-t</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">returns_arr</span><span class="p">)</span>
        <span class="n">t_alpha</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">t_alpha</span><span class="p">)</span>
        <span class="n">es</span> <span class="o">=</span> <span class="o">-</span><span class="n">loc</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">t_alpha</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span> <span class="o">+</span> <span class="n">t_alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">var</span><span class="p">,</span> <span class="n">es</span>

<span class="c1"># Compare methods</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected Shortfall Comparison (SPY, 95</span><span class="si">% c</span><span class="s2">onfidence)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>

<span class="n">var_hist</span><span class="p">,</span> <span class="n">es_hist</span> <span class="o">=</span> <span class="n">calculate_var_es</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">var_norm</span><span class="p">,</span> <span class="n">es_norm</span> <span class="o">=</span> <span class="n">parametric_es</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
<span class="n">var_t</span><span class="p">,</span> <span class="n">es_t</span> <span class="o">=</span> <span class="n">parametric_es</span><span class="p">(</span><span class="n">spy_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">)</span>

<span class="n">comparison</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Method&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Historical&#39;</span><span class="p">,</span> <span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="s1">&#39;Student-t&#39;</span><span class="p">],</span>
    <span class="s1">&#39;VaR (%)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">var_hist</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">var_norm</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">var_t</span><span class="o">*</span><span class="mi">100</span><span class="p">],</span>
    <span class="s1">&#39;ES (%)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">es_hist</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">es_norm</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">es_t</span><span class="o">*</span><span class="mi">100</span><span class="p">],</span>
    <span class="s1">&#39;ES/VaR&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">es_hist</span><span class="o">/</span><span class="n">var_hist</span><span class="p">,</span> <span class="n">es_norm</span><span class="o">/</span><span class="n">var_norm</span><span class="p">,</span> <span class="n">es_t</span><span class="o">/</span><span class="n">var_t</span><span class="p">]</span>
<span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 8.1: Multi-Asset Expected Shortfall (Guided)</h3>
<p><strong>Your Task:</strong> Calculate and compare VaR and ES for all assets in the dataset. Find which asset has the highest ES/VaR ratio (fattest tail).</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.1: Multi-Asset Expected Shortfall (Guided)</span>
<span class="k">def</span> <span class="nf">analyze_tail_risk</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze tail risk metrics for multiple assets.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: DataFrame of asset returns</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with VaR, ES, and ES/VaR ratio for each asset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">:</span>  
        <span class="n">asset_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span>
        
        <span class="c1"># TODO: Calculate VaR as negative of percentile</span>
        <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">asset_returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>  
        
        <span class="c1"># TODO: Find returns below the threshold</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">asset_returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">tail_returns</span> <span class="o">=</span> <span class="n">asset_returns</span><span class="p">[</span><span class="n">asset_returns</span> <span class="n">______</span> <span class="n">threshold</span><span class="p">]</span>  
        
        <span class="c1"># TODO: Calculate ES as negative of mean of tail returns</span>
        <span class="n">es</span> <span class="o">=</span> <span class="o">-</span><span class="n">tail_returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Asset&#39;</span><span class="p">:</span> <span class="n">asset</span><span class="p">,</span>
            <span class="s1">&#39;VaR&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
            <span class="s1">&#39;ES&#39;</span><span class="p">:</span> <span class="n">es</span><span class="p">,</span>
            <span class="s1">&#39;ES_VaR_Ratio&#39;</span><span class="p">:</span> <span class="n">es</span> <span class="o">/</span> <span class="n">var</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;ES_VaR_Ratio&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Test your solution</span>
<span class="c1"># risk_analysis = analyze_tail_risk(returns, 0.95)</span>
<span class="c1"># print(risk_analysis)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_tail_risk</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">asset_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span>

        <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">asset_returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">asset_returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">tail_returns</span> <span class="o">=</span> <span class="n">asset_returns</span><span class="p">[</span><span class="n">asset_returns</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">]</span>

        <span class="n">es</span> <span class="o">=</span> <span class="o">-</span><span class="n">tail_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Asset&#39;</span><span class="p">:</span> <span class="n">asset</span><span class="p">,</span>
            <span class="s1">&#39;VaR&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
            <span class="s1">&#39;ES&#39;</span><span class="p">:</span> <span class="n">es</span><span class="p">,</span>
            <span class="s1">&#39;ES_VaR_Ratio&#39;</span><span class="p">:</span> <span class="n">es</span> <span class="o">/</span> <span class="n">var</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;ES_VaR_Ratio&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">risk_analysis</span> <span class="o">=</span> <span class="n">analyze_tail_risk</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tail Risk Analysis (95% Confidence)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">risk_analysis</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Asset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: VaR=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;VaR&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%, ES=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ES&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%, Ratio=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ES_VaR_Ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fattest tail: </span><span class="si">{</span><span class="n">risk_analysis</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Asset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-8.2'></a></p>
<h1>Section 8.2: Stress Testing</h1>
<p>VaR and ES estimate risk based on historical patterns. But what about unprecedented events? <strong>Stress testing</strong> evaluates portfolio performance under extreme scenarios.</p>
<p><strong>In this section, you will learn:</strong>
- Historical scenario analysis using past crises
- Hypothetical stress testing for unprecedented events
- Sensitivity analysis for factor changes</p></div>
<div class="md-cell"><h2>8.2.1 Historical Scenario Analysis</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Define historical crisis periods</span>
<span class="n">crisis_periods</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Global Financial Crisis&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;2008-09-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2008-11-30&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Flash Crash 2010&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;2010-05-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-05-31&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Euro Debt Crisis&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;2011-08-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2011-10-31&#39;</span><span class="p">),</span>
    <span class="s1">&#39;China Deval 2015&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;2015-08-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2015-09-30&#39;</span><span class="p">),</span>
    <span class="s1">&#39;COVID Crash&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;2020-02-15&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-03-31&#39;</span><span class="p">),</span>
    <span class="s1">&#39;Rate Hike 2022&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;2022-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-06-30&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">analyze_crisis_period</span><span class="p">(</span><span class="n">returns_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                          <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                          <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate risk metrics during a crisis period.&quot;&quot;&quot;</span>
    <span class="n">crisis_returns</span> <span class="o">=</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_date</span><span class="p">:</span><span class="n">end_date</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crisis_returns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">cumulative</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crisis_returns</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">worst_day</span> <span class="o">=</span> <span class="n">crisis_returns</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">crisis_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">crisis_returns</span><span class="p">),</span>
        <span class="s1">&#39;cumulative&#39;</span><span class="p">:</span> <span class="n">cumulative</span><span class="p">,</span>
        <span class="s1">&#39;worst_day&#39;</span><span class="p">:</span> <span class="n">worst_day</span><span class="p">,</span>
        <span class="s1">&#39;annualized_vol&#39;</span><span class="p">:</span> <span class="n">vol</span>
    <span class="p">}</span>

<span class="c1"># Analyze each crisis for SPY</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Historical Crisis Analysis: SPY&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="n">crisis_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">crisis_name</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="n">crisis_periods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">analyze_crisis_period</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">crisis_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Crisis&#39;</span><span class="p">:</span> <span class="n">crisis_name</span><span class="p">,</span>
            <span class="s1">&#39;Days&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;days&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Total Return&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;cumulative&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Worst Day&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;worst_day&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Ann. Vol&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;annualized_vol&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span>
        <span class="p">})</span>

<span class="n">df_crisis</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">crisis_results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_crisis</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Portfolio stress test across multiple allocations</span>
<span class="k">def</span> <span class="nf">stress_test_portfolio</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                          <span class="n">returns_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                          <span class="n">crisis_periods</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply historical crisis scenarios to a portfolio.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        weights: Asset weights dict</span>
<span class="sd">        returns_df: DataFrame of historical returns</span>
<span class="sd">        crisis_periods: Dict of crisis name -&gt; (start, end)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with stress test results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">assets</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">port_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">returns_df</span><span class="p">[</span><span class="n">assets</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">@</span> <span class="n">w</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">returns_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">crisis_name</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="n">crisis_periods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">crisis_ret</span> <span class="o">=</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crisis_ret</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">total_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">crisis_ret</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">max_dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">crisis_ret</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">-</span> <span class="n">crisis_ret</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">cummax</span><span class="p">())</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">worst_day</span> <span class="o">=</span> <span class="n">crisis_ret</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Scenario&#39;</span><span class="p">:</span> <span class="n">crisis_name</span><span class="p">,</span>
                <span class="s1">&#39;Portfolio Return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
                <span class="s1">&#39;Worst Day&#39;</span><span class="p">:</span> <span class="n">worst_day</span><span class="p">,</span>
                <span class="s1">&#39;Max Drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span>
            <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Define test portfolios</span>
<span class="n">portfolios</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Aggressive&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
    <span class="s1">&#39;Balanced&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="s1">&#39;Conservative&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portfolio Stress Test Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="k">for</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">port_weights</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">port_name</span><span class="si">}</span><span class="s2"> Portfolio:&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">stress_test_portfolio</span><span class="p">(</span><span class="n">port_weights</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">crisis_periods</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Portfolio Return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Portfolio Return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Worst Day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Worst Day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Max Drawdown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Max Drawdown&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h2>8.2.2 Hypothetical Stress Testing</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">hypothetical_stress_test</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">scenarios</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply hypothetical scenarios to a portfolio.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        weights: Asset -&gt; weight</span>
<span class="sd">        scenarios: Scenario name -&gt; {asset: return}</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with scenario impacts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">scenario_name</span><span class="p">,</span> <span class="n">asset_returns</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">port_return</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">asset_returns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
                         <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Scenario&#39;</span><span class="p">:</span> <span class="n">scenario_name</span><span class="p">,</span>
            <span class="s1">&#39;Portfolio Impact&#39;</span><span class="p">:</span> <span class="n">port_return</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Define hypothetical scenarios</span>
<span class="n">hypothetical_scenarios</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Market Crash (-20%)&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">},</span>
    <span class="s1">&#39;Tech Bubble Burst&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.35</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">},</span>
    <span class="s1">&#39;Stagflation&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.18</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">},</span>
    <span class="s1">&#39;Flash Crash (-10</span><span class="si">% d</span><span class="s1">ay)&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
    <span class="s1">&#39;Bond Market Crisis&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">},</span>
    <span class="s1">&#39;Dollar Collapse&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">},</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hypothetical Stress Test Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="k">for</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">port_weights</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">port_name</span><span class="si">}</span><span class="s2"> Portfolio:&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">hypothetical_stress_test</span><span class="p">(</span><span class="n">port_weights</span><span class="p">,</span> <span class="n">hypothetical_scenarios</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Portfolio Impact&#39;</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Portfolio Impact&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Portfolio Impact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">+.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 8.2: Custom Stress Scenario (Guided)</h3>
<p><strong>Your Task:</strong> Design and test a geopolitical crisis scenario that affects all assets.</p>
<p>Fill in the blanks to complete the implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.2: Custom Stress Scenario (Guided)</span>
<span class="k">def</span> <span class="nf">create_geopolitical_scenarios</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create geopolitical crisis scenarios.</span>
<span class="sd">    </span>
<span class="sd">    During geopolitical crises:</span>
<span class="sd">    - Equities fall sharply</span>
<span class="sd">    - Treasuries rally (flight to safety)</span>
<span class="sd">    - Gold rallies strongly (safe haven)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary of scenario name -&gt; asset impacts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scenarios</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Mild Tension&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="c1"># TODO: Set SPY impact (mild negative)</span>
            <span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="n">______</span><span class="p">,</span>  
            <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.07</span><span class="p">,</span>
            <span class="c1"># TODO: Set TLT impact (mild positive, flight to safety)</span>
            <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="n">______</span><span class="p">,</span>  
            <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.08</span>
        <span class="p">},</span>
        <span class="s1">&#39;Major Crisis&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span>
            <span class="c1"># TODO: Set QQQ impact (tech falls more)</span>
            <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="n">______</span><span class="p">,</span>  
            <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
            <span class="c1"># TODO: Set GLD impact (strong safe haven)</span>
            <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="n">______</span>  
        <span class="p">},</span>
        <span class="s1">&#39;Severe Conflict&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span>
            <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.30</span><span class="p">,</span>
            <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span>
            <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.35</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">scenarios</span>

<span class="c1"># Test your scenarios</span>
<span class="c1"># geo_scenarios = create_geopolitical_scenarios()</span>
<span class="c1"># for port_name, port_weights in portfolios.items():</span>
<span class="c1">#     results = hypothetical_stress_test(port_weights, geo_scenarios)</span>
<span class="c1">#     print(f&quot;{port_name}: {results[&#39;Portfolio Impact&#39;].min()*100:.1f}% worst case&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_geopolitical_scenarios</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">scenarios</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Mild Tension&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.07</span><span class="p">,</span>
            <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span>
            <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.08</span>
        <span class="p">},</span>
        <span class="s1">&#39;Major Crisis&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span>
            <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">,</span>
            <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
            <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.20</span>
        <span class="p">},</span>
        <span class="s1">&#39;Severe Conflict&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span>
            <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.30</span><span class="p">,</span>
            <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span>
            <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.35</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">scenarios</span>

<span class="c1"># Test</span>
<span class="n">geo_scenarios</span> <span class="o">=</span> <span class="n">create_geopolitical_scenarios</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Geopolitical Crisis Stress Test&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">port_weights</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">hypothetical_stress_test</span><span class="p">(</span><span class="n">port_weights</span><span class="p">,</span> <span class="n">geo_scenarios</span><span class="p">)</span>
    <span class="n">worst</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Portfolio Impact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Portfolio Impact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">port_name</span><span class="si">}</span><span class="s2">: Best </span><span class="si">{</span><span class="n">best</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">+.1f</span><span class="si">}</span><span class="s2">%, Worst </span><span class="si">{</span><span class="n">worst</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-8.3'></a></p>
<h1>Section 8.3: Drawdown Analysis</h1>
<p>VaR measures single-period risk. But investors often care more about cumulative losses over time‚Äîhow far can the portfolio fall, and how long until recovery?</p>
<p><strong>In this section, you will learn:</strong>
- Maximum drawdown calculation
- Drawdown duration analysis
- Conditional Drawdown at Risk (CDaR)</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_drawdowns</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate drawdown series and statistics.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Daily returns</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with drawdown metrics and series</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cum_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_returns</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_returns</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    
    <span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">max_dd_end</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
    <span class="n">peak_idx</span> <span class="o">=</span> <span class="n">cum_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">max_dd_end</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    
    <span class="c1"># Find recovery</span>
    <span class="n">peak_value</span> <span class="o">=</span> <span class="n">cum_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">peak_idx</span><span class="p">]</span>
    <span class="n">after_trough</span> <span class="o">=</span> <span class="n">cum_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">max_dd_end</span><span class="p">:]</span>
    <span class="n">recovery</span> <span class="o">=</span> <span class="n">after_trough</span><span class="p">[</span><span class="n">after_trough</span> <span class="o">&gt;=</span> <span class="n">peak_value</span><span class="p">]</span>
    <span class="n">recovery_date</span> <span class="o">=</span> <span class="n">recovery</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="k">if</span> <span class="n">recovery_date</span><span class="p">:</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">recovery_date</span> <span class="o">-</span> <span class="n">peak_idx</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">peak_idx</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
        <span class="s1">&#39;peak_date&#39;</span><span class="p">:</span> <span class="n">peak_idx</span><span class="p">,</span>
        <span class="s1">&#39;trough_date&#39;</span><span class="p">:</span> <span class="n">max_dd_end</span><span class="p">,</span>
        <span class="s1">&#39;recovery_date&#39;</span><span class="p">:</span> <span class="n">recovery_date</span><span class="p">,</span>
        <span class="s1">&#39;duration_days&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
        <span class="s1">&#39;drawdown_series&#39;</span><span class="p">:</span> <span class="n">drawdown</span><span class="p">,</span>
        <span class="s1">&#39;wealth_curve&#39;</span><span class="p">:</span> <span class="n">cum_returns</span>
    <span class="p">}</span>

<span class="c1"># Calculate for SPY</span>
<span class="n">spy_dd</span> <span class="o">=</span> <span class="n">calculate_drawdowns</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SPY Maximum Drawdown Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum Drawdown: </span><span class="si">{</span><span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Peak Date: </span><span class="si">{</span><span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;peak_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trough Date: </span><span class="si">{</span><span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;trough_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;recovery_date&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recovery Date: </span><span class="si">{</span><span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;recovery_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recovery Date: Not yet recovered&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duration: </span><span class="si">{</span><span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;duration_days&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> days (</span><span class="si">{</span><span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;duration_days&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">365</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> years)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize drawdowns</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Top: Wealth curve</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;wealth_curve&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SPY Cumulative Return&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;wealth_curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                 <span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;wealth_curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cummax</span><span class="p">(),</span>
                 <span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;wealth_curve&#39;</span><span class="p">],</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Drawdown Area&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return (Growth of $1)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY Wealth Curve with Drawdown Periods&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Bottom: Drawdown series</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;drawdown_series&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                 <span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;drawdown_series&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> 
                 <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">spy_dd</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Max DD: </span><span class="si">{</span><span class="n">spy_dd</span><span class="p">[</span><span class="s2">&quot;max_drawdown&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY Drawdown History&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_cdar</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Conditional Drawdown at Risk.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Daily returns</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (DaR, CDaR)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cum_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_returns</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdowns</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_returns</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span>
    <span class="n">dar</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">drawdowns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">drawdowns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">worst_drawdowns</span> <span class="o">=</span> <span class="n">drawdowns</span><span class="p">[</span><span class="n">drawdowns</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">]</span>
    <span class="n">cdar</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">worst_drawdowns</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">dar</span><span class="p">,</span> <span class="n">cdar</span>

<span class="c1"># Calculate for all assets</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Drawdown Risk Metrics Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="n">dd_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">dd_info</span> <span class="o">=</span> <span class="n">calculate_drawdowns</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">asset</span><span class="p">])</span>
    <span class="n">dar_95</span><span class="p">,</span> <span class="n">cdar_95</span> <span class="o">=</span> <span class="n">calculate_cdar</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">asset</span><span class="p">],</span> <span class="mf">0.95</span><span class="p">)</span>
    
    <span class="n">dd_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Asset&#39;</span><span class="p">:</span> <span class="n">asset</span><span class="p">,</span>
        <span class="s1">&#39;Max DD&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dd_info</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
        <span class="s1">&#39;DaR (95%)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dar_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
        <span class="s1">&#39;CDaR (95%)&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cdar_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="p">})</span>

<span class="n">df_dd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dd_metrics</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_dd</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 8.3: Portfolio Drawdown Comparison (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that compares drawdown characteristics across multiple portfolios:
- Calculate max drawdown, DaR, and CDaR for each portfolio
- Create a visualization showing drawdown series for all portfolios
- Rank portfolios by drawdown profile</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.3: Portfolio Drawdown Comparison (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compare_portfolio_drawdowns</span><span class="p">(</span><span class="n">portfolios</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                                <span class="n">returns_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare drawdown metrics across portfolios.</span>

<span class="sd">    Args:</span>
<span class="sd">        portfolios: Dict of portfolio name -&gt; weights dict</span>
<span class="sd">        returns_df: DataFrame of asset returns</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with drawdown metrics for each portfolio</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dd_series_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Calculate portfolio returns</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">port_ret</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">returns_df</span><span class="p">[</span><span class="n">assets</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">@</span> <span class="n">w</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">returns_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Calculate metrics</span>
        <span class="n">dd_info</span> <span class="o">=</span> <span class="n">calculate_drawdowns</span><span class="p">(</span><span class="n">port_ret</span><span class="p">)</span>
        <span class="n">dar</span><span class="p">,</span> <span class="n">cdar</span> <span class="o">=</span> <span class="n">calculate_cdar</span><span class="p">(</span><span class="n">port_ret</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Portfolio&#39;</span><span class="p">:</span> <span class="n">port_name</span><span class="p">,</span>
            <span class="s1">&#39;Max DD&#39;</span><span class="p">:</span> <span class="n">dd_info</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;DaR 95%&#39;</span><span class="p">:</span> <span class="n">dar</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;CDaR 95%&#39;</span><span class="p">:</span> <span class="n">cdar</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;Duration&#39;</span><span class="p">:</span> <span class="n">dd_info</span><span class="p">[</span><span class="s1">&#39;duration_days&#39;</span><span class="p">]</span>
        <span class="p">})</span>

        <span class="n">dd_series_dict</span><span class="p">[</span><span class="n">port_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd_info</span><span class="p">[</span><span class="s1">&#39;drawdown_series&#39;</span><span class="p">]</span>

    <span class="c1"># Plot comparison</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Aggressive&#39;</span><span class="p">:</span> <span class="s1">&#39;crimson&#39;</span><span class="p">,</span> <span class="s1">&#39;Balanced&#39;</span><span class="p">:</span> <span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="s1">&#39;Conservative&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">dd_series</span> <span class="ow">in</span> <span class="n">dd_series_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dd_series</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">port_name</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> 
               <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">port_name</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Portfolio Drawdown Comparison&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Max DD&#39;</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">dd_comparison</span> <span class="o">=</span> <span class="n">compare_portfolio_drawdowns</span><span class="p">(</span><span class="n">portfolios</span><span class="p">,</span> <span class="n">returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portfolio Drawdown Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dd_comparison</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-8.4'></a></p>
<h1>Section 8.4: Tail Risk Measures</h1>
<p>Beyond VaR and ES, several specialized metrics help quantify tail risk and return asymmetry.</p>
<p><strong>In this section, you will learn:</strong>
- Tail ratio and gain/loss metrics
- Sortino ratio (downside deviation only)
- Omega ratio (full distribution)</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">tail_ratio</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">percentile</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the tail ratio.</span>
<span class="sd">    </span>
<span class="sd">    Tail Ratio = 95th percentile / |5th percentile|</span>
<span class="sd">    &gt; 1.0 means positive skew (gains &gt; losses in tails)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">returns_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">right_tail</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns_arr</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">percentile</span><span class="p">)</span>
    <span class="n">left_tail</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns_arr</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">right_tail</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">left_tail</span><span class="p">)</span> <span class="k">if</span> <span class="n">left_tail</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

<span class="k">def</span> <span class="nf">sortino_ratio</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">risk_free_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Sortino ratio (only penalizes downside volatility).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">returns_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">excess</span> <span class="o">=</span> <span class="n">returns_arr</span> <span class="o">-</span> <span class="n">risk_free_rate</span> <span class="o">/</span> <span class="mi">252</span>
    <span class="n">downside</span> <span class="o">=</span> <span class="n">returns_arr</span><span class="p">[</span><span class="n">returns_arr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">downside_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">downside</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">downside</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1e-10</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns_arr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="n">downside_std</span>

<span class="k">def</span> <span class="nf">omega_ratio</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Omega ratio.</span>
<span class="sd">    </span>
<span class="sd">    Omega = Probability-weighted gains above threshold / </span>
<span class="sd">            Probability-weighted losses below threshold</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">returns_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">gains</span> <span class="o">=</span> <span class="n">returns_arr</span><span class="p">[</span><span class="n">returns_arr</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span> <span class="o">-</span> <span class="n">threshold</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">-</span> <span class="n">returns_arr</span><span class="p">[</span><span class="n">returns_arr</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">]</span>
    
    <span class="n">sum_gains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">sum_losses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1e-10</span>
    
    <span class="k">return</span> <span class="n">sum_gains</span> <span class="o">/</span> <span class="n">sum_losses</span>

<span class="c1"># Calculate for all assets</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Advanced Risk-Adjusted Metrics&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="n">advanced_metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span>
    
    <span class="n">sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
    <span class="n">sortino</span> <span class="o">=</span> <span class="n">sortino_ratio</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_ratio</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">tail_ratio</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    
    <span class="n">dd</span> <span class="o">=</span> <span class="n">calculate_drawdowns</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="n">calmar</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">])</span>
    
    <span class="n">advanced_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Asset&#39;</span><span class="p">:</span> <span class="n">asset</span><span class="p">,</span>
        <span class="s1">&#39;Sharpe&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
        <span class="s1">&#39;Sortino&#39;</span><span class="p">:</span> <span class="n">sortino</span><span class="p">,</span>
        <span class="s1">&#39;Omega&#39;</span><span class="p">:</span> <span class="n">omega</span><span class="p">,</span>
        <span class="s1">&#39;Calmar&#39;</span><span class="p">:</span> <span class="n">calmar</span><span class="p">,</span>
        <span class="s1">&#39;Tail Ratio&#39;</span><span class="p">:</span> <span class="n">tr</span>
    <span class="p">})</span>

<span class="n">df_advanced</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">advanced_metrics</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_advanced</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 8.4: Gain/Loss Analysis (Guided)</h3>
<p><strong>Your Task:</strong> Calculate gain/loss metrics including win rate, average gain/loss, and profit factor.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.4: Gain/Loss Analysis (Guided)</span>
<span class="k">def</span> <span class="nf">gain_loss_analysis</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze gain/loss characteristics.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Return series</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with gain/loss metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">returns_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    
    <span class="c1"># TODO: Separate gains and losses</span>
    <span class="n">gains</span> <span class="o">=</span> <span class="n">returns_arr</span><span class="p">[</span><span class="n">returns_arr</span> <span class="n">______</span> <span class="mi">0</span><span class="p">]</span>  
    <span class="n">losses</span> <span class="o">=</span> <span class="n">returns_arr</span><span class="p">[</span><span class="n">returns_arr</span> <span class="n">______</span> <span class="mi">0</span><span class="p">]</span>  
    
    <span class="c1"># TODO: Calculate win rate</span>
    <span class="n">win_rate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="o">/</span> <span class="n">______</span><span class="p">(</span><span class="n">returns_arr</span><span class="p">)</span>  
    
    <span class="c1"># TODO: Calculate average gain and loss</span>
    <span class="n">avg_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>  
    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>  
    
    <span class="c1"># TODO: Calculate gain/loss ratio</span>
    <span class="n">gl_ratio</span> <span class="o">=</span> <span class="n">avg_gain</span> <span class="o">/</span> <span class="n">______</span><span class="p">(</span><span class="n">avg_loss</span><span class="p">)</span> <span class="k">if</span> <span class="n">avg_loss</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>  
    
    <span class="c1"># TODO: Calculate profit factor</span>
    <span class="n">profit_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="o">/</span> <span class="n">______</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">))</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
        <span class="s1">&#39;avg_gain&#39;</span><span class="p">:</span> <span class="n">avg_gain</span><span class="p">,</span>
        <span class="s1">&#39;avg_loss&#39;</span><span class="p">:</span> <span class="n">avg_loss</span><span class="p">,</span>
        <span class="s1">&#39;gain_loss_ratio&#39;</span><span class="p">:</span> <span class="n">gl_ratio</span><span class="p">,</span>
        <span class="s1">&#39;profit_factor&#39;</span><span class="p">:</span> <span class="n">profit_factor</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># metrics = gain_loss_analysis(returns[&#39;SPY&#39;])</span>
<span class="c1"># print(f&quot;Win Rate: {metrics[&#39;win_rate&#39;]*100:.1f}%&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">gain_loss_analysis</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">returns_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

    <span class="n">gains</span> <span class="o">=</span> <span class="n">returns_arr</span><span class="p">[</span><span class="n">returns_arr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="n">returns_arr</span><span class="p">[</span><span class="n">returns_arr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">win_rate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns_arr</span><span class="p">)</span>

    <span class="n">avg_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="n">gl_ratio</span> <span class="o">=</span> <span class="n">avg_gain</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">avg_loss</span><span class="p">)</span> <span class="k">if</span> <span class="n">avg_loss</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="n">profit_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gains</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">))</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
        <span class="s1">&#39;avg_gain&#39;</span><span class="p">:</span> <span class="n">avg_gain</span><span class="p">,</span>
        <span class="s1">&#39;avg_loss&#39;</span><span class="p">:</span> <span class="n">avg_loss</span><span class="p">,</span>
        <span class="s1">&#39;gain_loss_ratio&#39;</span><span class="p">:</span> <span class="n">gl_ratio</span><span class="p">,</span>
        <span class="s1">&#39;profit_factor&#39;</span><span class="p">:</span> <span class="n">profit_factor</span>
    <span class="p">}</span>

<span class="c1"># Test for all assets</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gain/Loss Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">gain_loss_analysis</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">asset</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset</span><span class="si">}</span><span class="s2">: Win=</span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, G/L=</span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;gain_loss_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, PF=</span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;profit_factor&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 8.5: Comprehensive Risk Report (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that generates a comprehensive risk report including:
- Basic statistics (return, volatility, skewness, kurtosis)
- VaR and ES at multiple confidence levels
- Drawdown metrics
- All risk-adjusted ratios (Sharpe, Sortino, Calmar, Omega)</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.5: Comprehensive Risk Report (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">comprehensive_risk_report</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Portfolio&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate comprehensive risk report.</span>

<span class="sd">    Args:</span>
<span class="sd">        returns: Return series</span>
<span class="sd">        name: Name for display</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with all risk metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

    <span class="c1"># Basic stats</span>
    <span class="n">ann_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">*</span> <span class="mi">252</span>
    <span class="n">ann_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">skewness</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="n">kurtosis</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="c1"># VaR and ES</span>
    <span class="n">var_95</span><span class="p">,</span> <span class="n">es_95</span> <span class="o">=</span> <span class="n">calculate_var_es</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
    <span class="n">var_99</span><span class="p">,</span> <span class="n">es_99</span> <span class="o">=</span> <span class="n">calculate_var_es</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

    <span class="c1"># Drawdown</span>
    <span class="n">dd_info</span> <span class="o">=</span> <span class="n">calculate_drawdowns</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="n">dar_95</span><span class="p">,</span> <span class="n">cdar_95</span> <span class="o">=</span> <span class="n">calculate_cdar</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>

    <span class="c1"># Ratios</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="n">ann_return</span> <span class="o">/</span> <span class="n">ann_vol</span> <span class="k">if</span> <span class="n">ann_vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">sortino</span> <span class="o">=</span> <span class="n">sortino_ratio</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_ratio</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="n">calmar</span> <span class="o">=</span> <span class="n">ann_return</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dd_info</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">dd_info</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">tail_ratio</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="c1"># Gain/Loss</span>
    <span class="n">gl</span> <span class="o">=</span> <span class="n">gain_loss_analysis</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RISK REPORT: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RETURN STATISTICS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annual Return:     </span><span class="si">{</span><span class="n">ann_return</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annual Volatility: </span><span class="si">{</span><span class="n">ann_vol</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Skewness:          </span><span class="si">{</span><span class="n">skewness</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Excess Kurtosis:   </span><span class="si">{</span><span class="n">kurtosis</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">VALUE AT RISK&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  VaR (95%):         </span><span class="si">{</span><span class="n">var_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ES (95%):          </span><span class="si">{</span><span class="n">es_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  VaR (99%):         </span><span class="si">{</span><span class="n">var_99</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ES (99%):          </span><span class="si">{</span><span class="n">es_99</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DRAWDOWN METRICS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Drawdown:      </span><span class="si">{</span><span class="n">dd_info</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  DaR (95%):         </span><span class="si">{</span><span class="n">dar_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  CDaR (95%):        </span><span class="si">{</span><span class="n">cdar_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RISK-ADJUSTED RATIOS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe:            </span><span class="si">{</span><span class="n">sharpe</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sortino:           </span><span class="si">{</span><span class="n">sortino</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Omega:             </span><span class="si">{</span><span class="n">omega</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Calmar:            </span><span class="si">{</span><span class="n">calmar</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TAIL RISK&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Tail Ratio:        </span><span class="si">{</span><span class="n">tr</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Win Rate:          </span><span class="si">{</span><span class="n">gl</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Profit Factor:     </span><span class="si">{</span><span class="n">gl</span><span class="p">[</span><span class="s1">&#39;profit_factor&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;ann_return&#39;</span><span class="p">:</span> <span class="n">ann_return</span><span class="p">,</span> <span class="s1">&#39;ann_vol&#39;</span><span class="p">:</span> <span class="n">ann_vol</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">}</span>

<span class="c1"># Generate reports</span>
<span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">comprehensive_risk_report</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">asset</span><span class="p">],</span> <span class="n">asset</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 8.6: Risk Dashboard Class (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a comprehensive RiskDashboard class that:
- Calculates all risk metrics (VaR, ES, drawdowns, ratios)
- Supports stress testing
- Generates visualizations
- Produces a summary report</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 8.6: Risk Dashboard Class (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RiskDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive risk analysis dashboard.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Portfolio&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span>

        <span class="c1"># Basic stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ann_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ann_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skewness</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kurtosis</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

        <span class="c1"># VaR/ES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_95</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">es_95</span> <span class="o">=</span> <span class="n">calculate_var_es</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">es_99</span> <span class="o">=</span> <span class="n">calculate_var_es</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

        <span class="c1"># Drawdown</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">calculate_drawdowns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawdown_series</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;drawdown_series&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dar_95</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdar_95</span> <span class="o">=</span> <span class="n">calculate_cdar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>

        <span class="c1"># Ratios</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharpe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ann_return</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ann_vol</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ann_vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortino</span> <span class="o">=</span> <span class="n">sortino_ratio</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">omega_ratio</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calmar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ann_return</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tail_ratio</span> <span class="o">=</span> <span class="n">tail_ratio</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stress_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenarios</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply stress scenarios.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">impact</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Scenario&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Impact&#39;</span><span class="p">:</span> <span class="n">impact</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Create visual dashboard.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Risk Dashboard: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="c1"># Distribution with VaR/ES</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">var_95</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">es_95</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Return&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Return Distribution with Risk Measures&#39;</span><span class="p">)</span>

        <span class="c1"># Drawdown</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drawdown_series</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown_series</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Historical Drawdowns&#39;</span><span class="p">)</span>

        <span class="c1"># Rolling volatility</span>
        <span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">rolling_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_vol</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_vol</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Volatility (%)&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling 21-day Volatility&#39;</span><span class="p">)</span>

        <span class="c1"># Metrics summary</span>
        <span class="n">ax4</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        RISK METRICS SUMMARY</span>
<span class="s2">        </span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">30</span><span class="si">}</span><span class="s2"></span>

<span class="s2">        Return &amp; Volatility</span>
<span class="s2">        Annual Return:      </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ann_return</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">        Annual Volatility:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ann_vol</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%</span>

<span class="s2">        Downside Risk</span>
<span class="s2">        VaR (95%):          </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">        ES (95%):           </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">es_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%</span>
<span class="s2">        Max Drawdown:       </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%</span>

<span class="s2">        Risk-Adjusted Ratios</span>
<span class="s2">        Sharpe:             </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sharpe</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        Sortino:            </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sortino</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        Calmar:             </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calmar</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontfamily</span><span class="o">=</span><span class="s1">&#39;monospace&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.92</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Test</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">RiskDashboard</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="s2">&quot;Balanced Portfolio&quot;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">plot_dashboard</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Production Risk Management System</h1>
<p>Build a comprehensive risk management system that integrates all concepts from this module.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductionRiskSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready risk management system.</span>

<span class="sd">    Features:</span>
<span class="sd">    - VaR and Expected Shortfall calculation</span>
<span class="sd">    - Stress testing (historical and hypothetical)</span>
<span class="sd">    - Drawdown analysis</span>
<span class="sd">    - Comprehensive risk-adjusted metrics</span>
<span class="sd">    - Portfolio comparison</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                 <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">portfolio_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1_000_000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> \
                       <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">portfolio_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">returns</span><span class="o">.</span><span class="n">values</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> 
            <span class="n">index</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_all_metrics</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calculate_all_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate all risk metrics.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="p">)</span>

        <span class="c1"># Basic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ann_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ann_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

        <span class="c1"># VaR/ES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_95</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">es_95</span> <span class="o">=</span> <span class="n">calculate_var_es</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">es_99</span> <span class="o">=</span> <span class="n">calculate_var_es</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

        <span class="c1"># Drawdown</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">calculate_drawdowns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawdown_series</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;drawdown_series&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dar_95</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdar_95</span> <span class="o">=</span> <span class="n">calculate_cdar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>

        <span class="c1"># Ratios</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharpe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ann_return</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ann_vol</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ann_vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortino</span> <span class="o">=</span> <span class="n">sortino_ratio</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">omega_ratio</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calmar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ann_return</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">var_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate VaR report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">VALUE AT RISK REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Value: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">95% Confidence:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  VaR:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% ($</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_95</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ES:   </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">es_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% ($</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">es_95</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">99% Confidence:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  VaR:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_99</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% ($</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_99</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ES:   </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">es_99</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% ($</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">es_99</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stress_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenarios</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run stress tests.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">STRESS TEST RESULTS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">asset_impacts</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">impact</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">asset_impacts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">))</span>
            <span class="n">dollar_impact</span> <span class="o">=</span> <span class="n">impact</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">impact</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">+.1f</span><span class="si">}</span><span class="s2">% ($</span><span class="si">{</span><span class="n">dollar_impact</span><span class="si">:</span><span class="s2">+,.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drawdown_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate drawdown report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DRAWDOWN REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DaR (95%):     </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dar_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CDaR (95%):    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cdar_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">performance_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate performance report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">PERFORMANCE REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Annual Return:    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ann_return</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Annual Volatility: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ann_vol</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Risk-Adjusted Ratios:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sharpe</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sortino: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sortino</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Omega:   </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Calmar:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calmar</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PRODUCTION RISK MANAGEMENT REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Portfolio: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Value: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">performance_report</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_report</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawdown_report</span><span class="p">()</span>

        <span class="c1"># Stress test with default scenarios</span>
        <span class="n">scenarios</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Market Crash&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">},</span>
            <span class="s1">&#39;Stagflation&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.18</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stress_test</span><span class="p">(</span><span class="n">scenarios</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">ProductionRiskSystem</span><span class="p">(</span>
    <span class="n">returns</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
    <span class="n">portfolio_value</span><span class="o">=</span><span class="mi">1_000_000</span>
<span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">full_report</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Expected Shortfall (CVaR)</h3>
<ul>
<li>Measures average loss when VaR is breached</li>
<li>Preferred by regulators for coherence properties</li>
<li>Always greater than or equal to VaR</li>
</ul>
<h3>2. Stress Testing</h3>
<ul>
<li>Historical scenarios apply real crisis returns</li>
<li>Hypothetical scenarios test unprecedented events</li>
<li>No single portfolio is safe in all scenarios</li>
</ul>
<h3>3. Drawdown Analysis</h3>
<ul>
<li>Maximum drawdown captures peak-to-trough loss</li>
<li>Duration matters as much as magnitude</li>
<li>CDaR extends ES concept to drawdowns</li>
</ul>
<h3>4. Tail Risk Measures</h3>
<ul>
<li>Tail ratio compares extreme gains to losses</li>
<li>Sortino penalizes only downside volatility</li>
<li>Omega considers the entire distribution</li>
</ul></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 9: Factor Models</strong>, we'll explore:
- CAPM and beta estimation
- Fama-French multi-factor models
- Factor-based portfolio construction
- Style analysis and attribution</p>
<hr />
<p><em>Congratulations on completing Module 8!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="9"><div class="md-cell module-header"><h1>Module 9: Factor Models</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 3: Risk Modeling</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Understand and implement CAPM for beta estimation</li>
<li>Apply multi-factor models (Fama-French 3-factor and 5-factor)</li>
<li>Calculate alpha and evaluate statistical significance</li>
<li>Perform factor-based portfolio analysis and attribution</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 8: Beyond VaR</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-9.1">Section 9.1: CAPM and Beta</a></li>
<li><a href="#section-9.2">Section 9.2: Multi-Factor Models</a></li>
<li><a href="#section-9.3">Section 9.3: Alpha Analysis</a></li>
<li><a href="#section-9.4">Section 9.4: Factor Attribution</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Libraries loaded successfully!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download stock and market data</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;TSLA&#39;</span><span class="p">,</span> <span class="s1">&#39;JNJ&#39;</span><span class="p">,</span> <span class="s1">&#39;JPM&#39;</span><span class="p">,</span> <span class="s1">&#39;XOM&#39;</span><span class="p">]</span>
<span class="n">market_ticker</span> <span class="o">=</span> <span class="s1">&#39;SPY&#39;</span>

<span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading market and stock data...&quot;</span><span class="p">)</span>

<span class="n">all_tickers</span> <span class="o">=</span> <span class="n">tickers</span> <span class="o">+</span> <span class="p">[</span><span class="n">market_ticker</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">all_tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Handle MultiIndex columns</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">all_tickers</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="n">prices</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="c1"># Calculate returns</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Separate market and stock returns</span>
<span class="n">market_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">market_ticker</span><span class="p">]</span>
<span class="n">stock_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">tickers</span><span class="p">]</span>

<span class="c1"># Risk-free rate</span>
<span class="n">risk_free_rate</span> <span class="o">=</span> <span class="mf">0.04</span>
<span class="n">daily_rf</span> <span class="o">=</span> <span class="n">risk_free_rate</span> <span class="o">/</span> <span class="mi">252</span>

<span class="c1"># Calculate excess returns</span>
<span class="n">market_excess</span> <span class="o">=</span> <span class="n">market_returns</span> <span class="o">-</span> <span class="n">daily_rf</span>
<span class="n">stock_excess</span> <span class="o">=</span> <span class="n">stock_returns</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">daily_rf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="si">}</span><span class="s2"> trading days&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stocks: </span><span class="si">{</span><span class="n">tickers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Market proxy: </span><span class="si">{</span><span class="n">market_ticker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-9.1'></a></p>
<h1>Section 9.1: CAPM and Beta</h1>
<p>The <strong>Capital Asset Pricing Model (CAPM)</strong> tells us that expected return is determined by a single factor‚Äî<strong>market risk (beta)</strong>.</p>
<p>$$E[R_i] = R_f + \beta_i (E[R_m] - R_f)$$</p>
<p><strong>In this section, you will learn:</strong>
- Beta calculation methods
- Rolling beta for time-varying risk
- Interpreting beta components</p></div>
<div class="md-cell"><h2>9.1.1 Beta Calculation</h2>
<p>Beta measures sensitivity to market movements:</p>
<p>$$\beta_i = \frac{Cov(R_i, R_m)}{Var(R_m)} = \rho_{i,m} \cdot \frac{\sigma_i}{\sigma_m}$$</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_beta_cov</span><span class="p">(</span><span class="n">stock_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                       <span class="n">market_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate beta using covariance method.&quot;&quot;&quot;</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">stock_returns</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">market_returns</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">market_returns</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cov</span> <span class="o">/</span> <span class="n">var</span>

<span class="k">def</span> <span class="nf">calculate_beta_regression</span><span class="p">(</span><span class="n">stock_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                              <span class="n">market_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate beta using OLS regression.&quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">market_returns</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">stock_returns</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">model</span>

<span class="c1"># Calculate betas for all stocks</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Beta Calculation Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Ticker&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Cov/Var&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Regression&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;R-squared&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="n">betas</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">beta_cov</span> <span class="o">=</span> <span class="n">calculate_beta_cov</span><span class="p">(</span><span class="n">stock_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">market_returns</span><span class="p">)</span>
    <span class="n">beta_reg</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">calculate_beta_regression</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">market_excess</span><span class="p">)</span>
    <span class="n">betas</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta_reg</span>
    <span class="n">models</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">beta_cov</span><span class="si">:</span><span class="s2">&gt;10.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">beta_reg</span><span class="si">:</span><span class="s2">&gt;12.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">rsquared</span><span class="si">:</span><span class="s2">&gt;12.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize the Security Market Line</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Calculate annual market return and risk premium</span>
<span class="n">annual_market_return</span> <span class="o">=</span> <span class="n">market_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">market_risk_premium</span> <span class="o">=</span> <span class="n">annual_market_return</span> <span class="o">-</span> <span class="n">risk_free_rate</span>

<span class="c1"># SML line</span>
<span class="n">beta_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">sml_returns</span> <span class="o">=</span> <span class="n">risk_free_rate</span> <span class="o">+</span> <span class="n">beta_range</span> <span class="o">*</span> <span class="n">market_risk_premium</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">beta_range</span><span class="p">,</span> <span class="n">sml_returns</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Security Market Line&#39;</span><span class="p">)</span>

<span class="c1"># Plot each stock</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">betas</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
    <span class="n">actual_return</span> <span class="o">=</span> <span class="n">stock_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
    <span class="n">expected_return</span> <span class="o">=</span> <span class="n">risk_free_rate</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">market_risk_premium</span>
    
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">actual_return</span> <span class="o">&gt;</span> <span class="n">expected_return</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">actual_return</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> 
               <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">actual_return</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> 
                <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">annual_market_return</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> 
           <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Market (Œ≤=1)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Beta (Œ≤)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Annual Return&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Security Market Line</span><span class="se">\n</span><span class="s1">Green = Positive Alpha, Red = Negative Alpha&#39;</span><span class="p">,</span> 
         <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>9.1.2 Rolling Beta</h2>
<p>Beta is not constant over time. Rolling beta shows how market sensitivity evolves.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_rolling_beta</span><span class="p">(</span><span class="n">stock_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                           <span class="n">market_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                           <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate rolling beta over a specified window.&quot;&quot;&quot;</span>
    <span class="n">rolling_cov</span> <span class="o">=</span> <span class="n">stock_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">market_returns</span><span class="p">)</span>
    <span class="n">rolling_var</span> <span class="o">=</span> <span class="n">market_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">rolling_cov</span> <span class="o">/</span> <span class="n">rolling_var</span>

<span class="c1"># Calculate rolling betas</span>
<span class="n">window</span> <span class="o">=</span> <span class="mi">252</span>
<span class="n">rolling_betas</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">rolling_betas</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_rolling_beta</span><span class="p">(</span>
        <span class="n">stock_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">market_returns</span><span class="p">,</span> <span class="n">window</span>
    <span class="p">)</span>

<span class="n">rolling_betas</span> <span class="o">=</span> <span class="n">rolling_betas</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Plot rolling betas</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_betas</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_betas</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Market (Œ≤=1)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rolling Beta (252-day)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling Beta Over Time&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 9.1: Beta Component Analysis (Guided)</h3>
<p><strong>Your Task:</strong> Break down beta into its components: correlation and relative volatility.</p>
<p>$$\beta = \rho_{i,m} \times \frac{\sigma_i}{\sigma_m}$$</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.1: Beta Component Analysis (Guided)</span>
<span class="k">def</span> <span class="nf">beta_components</span><span class="p">(</span><span class="n">stock_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                    <span class="n">market_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate beta and its components.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        stock_returns: Stock return series</span>
<span class="sd">        market_returns: Market return series</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with beta, correlation, and volatility ratio</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate correlation between stock and market</span>
    <span class="n">correlation</span> <span class="o">=</span> <span class="n">stock_returns</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">market_returns</span><span class="p">)</span>  
    
    <span class="c1"># TODO: Calculate stock volatility</span>
    <span class="n">stock_vol</span> <span class="o">=</span> <span class="n">stock_returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  
    
    <span class="c1"># TODO: Calculate market volatility</span>
    <span class="n">market_vol</span> <span class="o">=</span> <span class="n">market_returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>  
    
    <span class="c1"># TODO: Calculate volatility ratio</span>
    <span class="n">vol_ratio</span> <span class="o">=</span> <span class="n">stock_vol</span> <span class="o">/</span> <span class="n">______</span>  
    
    <span class="c1"># TODO: Calculate beta from components</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">______</span> <span class="o">*</span> <span class="n">vol_ratio</span>  
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
        <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">correlation</span><span class="p">,</span>
        <span class="s1">&#39;vol_ratio&#39;</span><span class="p">:</span> <span class="n">vol_ratio</span><span class="p">,</span>
        <span class="s1">&#39;stock_vol&#39;</span><span class="p">:</span> <span class="n">stock_vol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span>
        <span class="s1">&#39;market_vol&#39;</span><span class="p">:</span> <span class="n">market_vol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># result = beta_components(stock_returns[&#39;AAPL&#39;], market_returns)</span>
<span class="c1"># print(f&quot;AAPL Beta: {result[&#39;beta&#39;]:.3f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">beta_components</span><span class="p">(</span><span class="n">stock_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                    <span class="n">market_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">correlation</span> <span class="o">=</span> <span class="n">stock_returns</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">market_returns</span><span class="p">)</span>
    <span class="n">stock_vol</span> <span class="o">=</span> <span class="n">stock_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">market_vol</span> <span class="o">=</span> <span class="n">market_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">vol_ratio</span> <span class="o">=</span> <span class="n">stock_vol</span> <span class="o">/</span> <span class="n">market_vol</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">correlation</span> <span class="o">*</span> <span class="n">vol_ratio</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
        <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">correlation</span><span class="p">,</span>
        <span class="s1">&#39;vol_ratio&#39;</span><span class="p">:</span> <span class="n">vol_ratio</span><span class="p">,</span>
        <span class="s1">&#39;stock_vol&#39;</span><span class="p">:</span> <span class="n">stock_vol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span>
        <span class="s1">&#39;market_vol&#39;</span><span class="p">:</span> <span class="n">market_vol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test for all stocks</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Beta Component Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Stock&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Beta&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Corr&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Vol Ratio&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Stock Vol&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">beta_components</span><span class="p">(</span><span class="n">stock_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">market_returns</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;vol_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;stock_vol&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;9.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-9.2'></a></p>
<h1>Section 9.2: Multi-Factor Models</h1>
<p>CAPM uses only one factor (market). The <strong>Fama-French</strong> models add additional factors that help explain cross-sectional returns.</p>
<p><strong>In this section, you will learn:</strong>
- Fama-French 3-factor model (Market, SMB, HML)
- Fama-French 5-factor model (adds RMW, CMA)
- Factor loading interpretation</p></div>
<div class="md-cell"><h2>9.2.1 Fama-French Factor Construction</h2>
<p>We'll simulate Fama-French factors for demonstration (in practice, use data from Kenneth French's library).</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate Fama-French factors based on market returns</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">n_days</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">market_returns</span><span class="p">)</span>

<span class="c1"># SMB (Small Minus Big) - size factor</span>
<span class="n">smb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.006</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span> <span class="o">+</span> <span class="n">market_returns</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="n">index</span><span class="o">=</span><span class="n">market_returns</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SMB&#39;</span>
<span class="p">)</span>

<span class="c1"># HML (High Minus Low) - value factor</span>
<span class="n">hml</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">n_days</span><span class="p">)</span> <span class="o">-</span> <span class="n">market_returns</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">index</span><span class="o">=</span><span class="n">market_returns</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;HML&#39;</span>
<span class="p">)</span>

<span class="c1"># RMW (Robust Minus Weak) - profitability factor</span>
<span class="n">rmw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.004</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="n">market_returns</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;RMW&#39;</span>
<span class="p">)</span>

<span class="c1"># CMA (Conservative Minus Aggressive) - investment factor</span>
<span class="n">cma</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.004</span><span class="p">,</span> <span class="n">n_days</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="n">market_returns</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;CMA&#39;</span>
<span class="p">)</span>

<span class="c1"># Create factor DataFrame</span>
<span class="n">factors_3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;MKT&#39;</span><span class="p">:</span> <span class="n">market_excess</span><span class="p">,</span>
    <span class="s1">&#39;SMB&#39;</span><span class="p">:</span> <span class="n">smb</span><span class="p">,</span>
    <span class="s1">&#39;HML&#39;</span><span class="p">:</span> <span class="n">hml</span>
<span class="p">})</span>

<span class="n">factors_5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;MKT&#39;</span><span class="p">:</span> <span class="n">market_excess</span><span class="p">,</span>
    <span class="s1">&#39;SMB&#39;</span><span class="p">:</span> <span class="n">smb</span><span class="p">,</span>
    <span class="s1">&#39;HML&#39;</span><span class="p">:</span> <span class="n">hml</span><span class="p">,</span>
    <span class="s1">&#39;RMW&#39;</span><span class="p">:</span> <span class="n">rmw</span><span class="p">,</span>
    <span class="s1">&#39;CMA&#39;</span><span class="p">:</span> <span class="n">cma</span>
<span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fama-French Factors (Simulated)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Factor Statistics (Annualized):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">factors_5</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">factors_5</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">factors_5</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: Mean=</span><span class="si">{</span><span class="n">mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%, Vol=</span><span class="si">{</span><span class="n">std</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>9.2.2 Three-Factor Model</h2>
<p>$$R_i - R_f = \alpha + \beta_{MKT}(R_m - R_f) + \beta_{SMB} \cdot SMB + \beta_{HML} \cdot HML + \epsilon$$</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">fit_factor_model</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                     <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a multi-factor model.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        stock_excess: Excess returns of the stock</span>
<span class="sd">        factors: DataFrame of factor returns</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with model results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;alpha_annual&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
        <span class="s1">&#39;alpha_tstat&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">tvalues</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;alpha_pvalue&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;betas&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
        <span class="s1">&#39;r_squared&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">rsquared</span><span class="p">,</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span>
    <span class="p">}</span>

<span class="c1"># Fit 3-factor model for all stocks</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fama-French 3-Factor Model Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Stock&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Alpha(ann)&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;MKT&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;SMB&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;HML&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;R¬≤&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

<span class="n">ff3_results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">fit_factor_model</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">factors_3</span><span class="p">)</span>
    <span class="n">ff3_results</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;alpha_annual&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;HML&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;r_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>9.2.3 Five-Factor Model</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Fit 5-factor model for all stocks</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fama-French 5-Factor Model Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Stock&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Alpha&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;MKT&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;SMB&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;HML&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;RMW&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;CMA&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;R¬≤&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">ff5_results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">fit_factor_model</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">factors_5</span><span class="p">)</span>
    <span class="n">ff5_results</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;alpha_annual&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2">% &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;HML&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;RMW&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;CMA&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;r_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 9.2: Factor Model Comparison (Guided)</h3>
<p><strong>Your Task:</strong> Compare CAPM vs 3-factor vs 5-factor models for a stock.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.2: Factor Model Comparison (Guided)</span>
<span class="k">def</span> <span class="nf">compare_factor_models</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                          <span class="n">market_excess</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                          <span class="n">factors_3</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                          <span class="n">factors_5</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare CAPM, 3-factor, and 5-factor models.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        stock_excess: Stock excess returns</span>
<span class="sd">        market_excess: Market excess returns</span>
<span class="sd">        factors_3: 3-factor DataFrame</span>
<span class="sd">        factors_5: 5-factor DataFrame</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with model comparison</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># CAPM (single factor)</span>
    <span class="n">X_capm</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">market_excess</span><span class="p">)</span>
    <span class="n">model_capm</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">,</span> <span class="n">X_capm</span><span class="p">)</span><span class="o">.</span><span class="n">____</span><span class="p">()</span>  
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="s1">&#39;CAPM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">model_capm</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;R_squared&#39;</span><span class="p">:</span> <span class="n">model_capm</span><span class="o">.</span><span class="n">______</span><span class="p">,</span>  
        <span class="s1">&#39;AIC&#39;</span><span class="p">:</span> <span class="n">model_capm</span><span class="o">.</span><span class="n">aic</span>
    <span class="p">})</span>
    
    <span class="c1"># 3-Factor</span>
    <span class="n">X_3f</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">factors_3</span><span class="p">)</span>
    <span class="n">model_3f</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">,</span> <span class="n">X_3f</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>  
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="s1">&#39;3-Factor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">model_3f</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;R_squared&#39;</span><span class="p">:</span> <span class="n">model_3f</span><span class="o">.</span><span class="n">rsquared</span><span class="p">,</span>
        <span class="s1">&#39;AIC&#39;</span><span class="p">:</span> <span class="n">model_3f</span><span class="o">.</span><span class="n">aic</span>
    <span class="p">})</span>
    
    <span class="c1"># 5-Factor</span>
    <span class="n">X_5f</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">factors_5</span><span class="p">)</span>
    <span class="n">model_5f</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">,</span> <span class="n">X_5f</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="s1">&#39;5-Factor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">model_5f</span><span class="o">.</span><span class="n">______</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>  
        <span class="s1">&#39;R_squared&#39;</span><span class="p">:</span> <span class="n">model_5f</span><span class="o">.</span><span class="n">rsquared</span><span class="p">,</span>
        <span class="s1">&#39;AIC&#39;</span><span class="p">:</span> <span class="n">model_5f</span><span class="o">.</span><span class="n">aic</span>
    <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Test your solution</span>
<span class="c1"># comparison = compare_factor_models(stock_excess[&#39;AAPL&#39;], market_excess, factors_3, factors_5)</span>
<span class="c1"># print(comparison)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compare_factor_models</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                          <span class="n">market_excess</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                          <span class="n">factors_3</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                          <span class="n">factors_5</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># CAPM</span>
    <span class="n">X_capm</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">market_excess</span><span class="p">)</span>
    <span class="n">model_capm</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">,</span> <span class="n">X_capm</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="s1">&#39;CAPM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">model_capm</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;R_squared&#39;</span><span class="p">:</span> <span class="n">model_capm</span><span class="o">.</span><span class="n">rsquared</span><span class="p">,</span>
        <span class="s1">&#39;AIC&#39;</span><span class="p">:</span> <span class="n">model_capm</span><span class="o">.</span><span class="n">aic</span>
    <span class="p">})</span>

    <span class="c1"># 3-Factor</span>
    <span class="n">X_3f</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">factors_3</span><span class="p">)</span>
    <span class="n">model_3f</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">,</span> <span class="n">X_3f</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="s1">&#39;3-Factor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">model_3f</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;R_squared&#39;</span><span class="p">:</span> <span class="n">model_3f</span><span class="o">.</span><span class="n">rsquared</span><span class="p">,</span>
        <span class="s1">&#39;AIC&#39;</span><span class="p">:</span> <span class="n">model_3f</span><span class="o">.</span><span class="n">aic</span>
    <span class="p">})</span>

    <span class="c1"># 5-Factor</span>
    <span class="n">X_5f</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">factors_5</span><span class="p">)</span>
    <span class="n">model_5f</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">,</span> <span class="n">X_5f</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;Model&#39;</span><span class="p">:</span> <span class="s1">&#39;5-Factor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">model_5f</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;R_squared&#39;</span><span class="p">:</span> <span class="n">model_5f</span><span class="o">.</span><span class="n">rsquared</span><span class="p">,</span>
        <span class="s1">&#39;AIC&#39;</span><span class="p">:</span> <span class="n">model_5f</span><span class="o">.</span><span class="n">aic</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;TSLA&#39;</span><span class="p">,</span> <span class="s1">&#39;JNJ&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2"> Model Comparison:&quot;</span><span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">compare_factor_models</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">market_excess</span><span class="p">,</span> <span class="n">factors_3</span><span class="p">,</span> <span class="n">factors_5</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-9.3'></a></p>
<h1>Section 9.3: Alpha Analysis</h1>
<p><strong>Alpha</strong> is the intercept in a factor model‚Äîthe return not explained by factor exposures.</p>
<p><strong>In this section, you will learn:</strong>
- Jensen's alpha interpretation
- Statistical significance testing
- Information ratio</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Alpha analysis with significance</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Alpha Significance Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Stock&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Alpha (ann)&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;t-stat&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;p-value&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Significant&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ff3_results</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;alpha_pvalue&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;alpha_annual&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;alpha_tstat&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;alpha_pvalue&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.4f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sig</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate Information Ratio</span>
<span class="k">def</span> <span class="nf">information_ratio</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">model_result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Information Ratio.</span>
<span class="sd">    </span>
<span class="sd">    IR = Alpha / Tracking Error</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alpha_annual</span> <span class="o">=</span> <span class="n">model_result</span><span class="p">[</span><span class="s1">&#39;alpha_annual&#39;</span><span class="p">]</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">model_result</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resid</span>
    <span class="n">tracking_error</span> <span class="o">=</span> <span class="n">residuals</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">alpha_annual</span> <span class="o">/</span> <span class="n">tracking_error</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Information Ratio Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Stock&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Alpha&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Track Error&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Info Ratio&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ff3_results</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
    <span class="n">ir</span> <span class="o">=</span> <span class="n">information_ratio</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">result</span><span class="p">)</span>
    <span class="n">te</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;alpha_annual&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2">% &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">te</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ir</span><span class="si">:</span><span class="s2">&gt;12.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Information Ratio Interpretation:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &gt; 0.5: Good | &gt; 1.0: Excellent | &gt; 1.5: Exceptional&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 9.3: Rolling Alpha Analysis (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that calculates rolling alpha with significance:
- Calculate alpha using a rolling window
- Track t-statistics over time
- Identify periods of significant alpha
- Visualize the results</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.3: Rolling Alpha Analysis (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">rolling_alpha_analysis</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                           <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                           <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate rolling alpha with significance.</span>

<span class="sd">    Args:</span>
<span class="sd">        stock_excess: Stock excess returns</span>
<span class="sd">        factors: Factor returns</span>
<span class="sd">        window: Rolling window</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with rolling alpha and t-stats</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tstats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">)):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">stock_excess</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">window</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">window</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
            <span class="n">alphas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span>  <span class="c1"># Annualized</span>
            <span class="n">tstats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tvalues</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stock_excess</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">alphas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">tstats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stock_excess</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alphas</span><span class="p">,</span>
        <span class="s1">&#39;t_stat&#39;</span><span class="p">:</span> <span class="n">tstats</span>
    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>

<span class="c1"># Calculate for AAPL</span>
<span class="n">rolling_alpha_df</span> <span class="o">=</span> <span class="n">rolling_alpha_analysis</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">],</span> <span class="n">factors_3</span><span class="p">,</span> <span class="mi">252</span><span class="p">)</span>

<span class="c1"># Visualize</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_alpha_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_alpha_df</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">rolling_alpha_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rolling_alpha_df</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">where</span><span class="o">=</span><span class="n">rolling_alpha_df</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">rolling_alpha_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rolling_alpha_df</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">where</span><span class="o">=</span><span class="n">rolling_alpha_df</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Alpha (%)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;AAPL Rolling Alpha (252-day)&#39;</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_alpha_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_alpha_df</span><span class="p">[</span><span class="s1">&#39;t_stat&#39;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.96</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;t=1.96&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="o">-</span><span class="mf">1.96</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-statistic&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Alpha Significance&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Count significant periods</span>
<span class="n">sig_positive</span> <span class="o">=</span> <span class="p">(</span><span class="n">rolling_alpha_df</span><span class="p">[</span><span class="s1">&#39;t_stat&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.96</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">sig_negative</span> <span class="o">=</span> <span class="p">(</span><span class="n">rolling_alpha_df</span><span class="p">[</span><span class="s1">&#39;t_stat&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.96</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rolling_alpha_df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant positive alpha: </span><span class="si">{</span><span class="n">sig_positive</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% of days&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant negative alpha: </span><span class="si">{</span><span class="n">sig_negative</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% of days&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-9.4'></a></p>
<h1>Section 9.4: Factor Attribution</h1>
<p>Factor attribution decomposes portfolio returns into factor contributions.</p>
<p><strong>In this section, you will learn:</strong>
- Return decomposition by factors
- Factor contribution analysis
- Style analysis</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">factor_attribution</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                       <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                       <span class="n">model_result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decompose returns by factor contributions.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        stock_excess: Stock excess returns</span>
<span class="sd">        factors: Factor returns</span>
<span class="sd">        model_result: Fitted model result</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with factor contributions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">betas</span> <span class="o">=</span> <span class="n">model_result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">model_result</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
    
    <span class="c1"># Total return</span>
    <span class="n">total_return</span> <span class="o">=</span> <span class="n">stock_excess</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
    
    <span class="c1"># Factor contributions</span>
    <span class="n">contributions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">betas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">factor_return</span> <span class="o">=</span> <span class="n">factors</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">contributions</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">factor_return</span>
    
    <span class="c1"># Alpha contribution</span>
    <span class="n">contributions</span><span class="p">[</span><span class="s1">&#39;Alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">252</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
        <span class="s1">&#39;contributions&#39;</span><span class="p">:</span> <span class="n">contributions</span>
    <span class="p">}</span>

<span class="c1"># Attribution for all stocks</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Factor Attribution Analysis (Annualized)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;TSLA&#39;</span><span class="p">,</span> <span class="s1">&#39;JNJ&#39;</span><span class="p">]:</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="n">factor_attribution</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">factors_3</span><span class="p">,</span> <span class="n">ff3_results</span><span class="p">[</span><span class="n">ticker</span><span class="p">])</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Excess Return: </span><span class="si">{</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Contributions:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">contrib</span> <span class="ow">in</span> <span class="n">attr</span><span class="p">[</span><span class="s1">&#39;contributions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">factor</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">contrib</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">+.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize factor contributions</span>
<span class="k">def</span> <span class="nf">plot_factor_attribution</span><span class="p">(</span><span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create waterfall chart for factor attribution.&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">contributions</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="s1">&#39;contributions&#39;</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">contributions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">contributions</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    
    <span class="n">bars</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    
    <span class="c1"># Add total</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Contribution (%)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1"> Factor Attribution&#39;</span><span class="p">)</span>
    
    <span class="c1"># Add value labels</span>
    <span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s1">+.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span> 
                   <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
                   <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;top&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot for a selected stock</span>
<span class="n">attr</span> <span class="o">=</span> <span class="n">factor_attribution</span><span class="p">(</span><span class="n">stock_excess</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">],</span> <span class="n">factors_3</span><span class="p">,</span> <span class="n">ff3_results</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">])</span>
<span class="n">plot_factor_attribution</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 9.4: Portfolio Factor Exposure (Guided)</h3>
<p><strong>Your Task:</strong> Calculate the aggregate factor exposures for a portfolio of stocks.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.4: Portfolio Factor Exposure (Guided)</span>
<span class="k">def</span> <span class="nf">portfolio_factor_exposure</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                              <span class="n">factor_results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate portfolio-level factor exposures.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        weights: Stock -&gt; weight</span>
<span class="sd">        factor_results: Stock -&gt; factor model results</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with portfolio factor exposures</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get list of factors from first result</span>
    <span class="n">first_result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">factor_results</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">first_result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">())</span>  
    
    <span class="c1"># Initialize portfolio exposures</span>
    <span class="n">portfolio_betas</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">}</span>
    <span class="n">portfolio_alpha</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="c1"># TODO: Calculate weighted average of betas</span>
    <span class="k">for</span> <span class="n">stock</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">factor_results</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">factor_results</span><span class="p">[</span><span class="n">stock</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
                <span class="n">portfolio_betas</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="n">______</span><span class="p">]</span>  
            <span class="n">portfolio_alpha</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;______&#39;</span><span class="p">]</span>  
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;betas&#39;</span><span class="p">:</span> <span class="n">portfolio_betas</span><span class="p">,</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">portfolio_alpha</span><span class="p">,</span>
        <span class="s1">&#39;alpha_annual&#39;</span><span class="p">:</span> <span class="n">portfolio_alpha</span> <span class="o">*</span> <span class="mi">252</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># weights = {&#39;AAPL&#39;: 0.3, &#39;MSFT&#39;: 0.3, &#39;JNJ&#39;: 0.4}</span>
<span class="c1"># port_exp = portfolio_factor_exposure(weights, ff3_results)</span>
<span class="c1"># print(f&quot;Portfolio MKT Beta: {port_exp[&#39;betas&#39;][&#39;MKT&#39;]:.3f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">portfolio_factor_exposure</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                              <span class="n">factor_results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">first_result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">factor_results</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">first_result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">portfolio_betas</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">}</span>
    <span class="n">portfolio_alpha</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">stock</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">factor_results</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">factor_results</span><span class="p">[</span><span class="n">stock</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
                <span class="n">portfolio_betas</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="n">factor</span><span class="p">]</span>
            <span class="n">portfolio_alpha</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;betas&#39;</span><span class="p">:</span> <span class="n">portfolio_betas</span><span class="p">,</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">portfolio_alpha</span><span class="p">,</span>
        <span class="s1">&#39;alpha_annual&#39;</span><span class="p">:</span> <span class="n">portfolio_alpha</span> <span class="o">*</span> <span class="mi">252</span>
    <span class="p">}</span>

<span class="c1"># Test with different portfolios</span>
<span class="n">portfolios</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Tech&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;AAPL&#39;</span><span class="p">:</span> <span class="mf">0.33</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">:</span> <span class="mf">0.34</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">:</span> <span class="mf">0.33</span><span class="p">},</span>
    <span class="s1">&#39;Defensive&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;JNJ&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;XOM&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
    <span class="s1">&#39;Growth&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;TSLA&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portfolio Factor Exposures&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">portfolio_factor_exposure</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">ff3_results</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">port_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MKT: </span><span class="si">{</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SMB: </span><span class="si">{</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  HML: </span><span class="si">{</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;HML&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Alpha (ann): </span><span class="si">{</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;alpha_annual&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 9.5: Style Analysis (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that performs style analysis:
- Determine if a stock is value/growth based on HML loading
- Determine if it's small/large cap based on SMB loading
- Create a style quadrant visualization</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.5: Style Analysis (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">style_analysis</span><span class="p">(</span><span class="n">factor_results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform style analysis based on factor loadings.</span>

<span class="sd">    Args:</span>
<span class="sd">        factor_results: Stock -&gt; factor model results</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with style classifications</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">factor_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">smb</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;SMB&#39;</span><span class="p">]</span>
        <span class="n">hml</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;HML&#39;</span><span class="p">]</span>
        <span class="n">mkt</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="s1">&#39;MKT&#39;</span><span class="p">]</span>

        <span class="c1"># Size classification</span>
        <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;Small&#39;</span> <span class="k">if</span> <span class="n">smb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Large&#39;</span>

        <span class="c1"># Value/Growth classification</span>
        <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;Value&#39;</span> <span class="k">if</span> <span class="n">hml</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Growth&#39;</span>

        <span class="c1"># Combined style box</span>
        <span class="n">quadrant</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">style</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Stock&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
            <span class="s1">&#39;SMB&#39;</span><span class="p">:</span> <span class="n">smb</span><span class="p">,</span>
            <span class="s1">&#39;HML&#39;</span><span class="p">:</span> <span class="n">hml</span><span class="p">,</span>
            <span class="s1">&#39;MKT&#39;</span><span class="p">:</span> <span class="n">mkt</span><span class="p">,</span>
            <span class="s1">&#39;Size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
            <span class="s1">&#39;Style&#39;</span><span class="p">:</span> <span class="n">style</span><span class="p">,</span>
            <span class="s1">&#39;Quadrant&#39;</span><span class="p">:</span> <span class="n">quadrant</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Perform style analysis</span>
<span class="n">styles</span> <span class="o">=</span> <span class="n">style_analysis</span><span class="p">(</span><span class="n">ff3_results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Style Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">styles</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Plot style quadrant</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">styles</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">color</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Large-Value&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;Large-Growth&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
             <span class="s1">&#39;Small-Value&#39;</span><span class="p">:</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;Small-Growth&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">}[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Quadrant&#39;</span><span class="p">]]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;HML&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> 
              <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Stock&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;HML&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SMB&#39;</span><span class="p">]),</span>
               <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Add quadrant labels</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;Small</span><span class="se">\n</span><span class="s1">Value&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;Small</span><span class="se">\n</span><span class="s1">Growth&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s1">&#39;Large</span><span class="se">\n</span><span class="s1">Value&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s1">&#39;Large</span><span class="se">\n</span><span class="s1">Growth&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;HML Loading (Value ‚Üî Growth)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;SMB Loading (Small ‚Üî Large)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Style Box Analysis&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 9.6: Complete Factor Model System (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a comprehensive FactorModel class that:
- Fits CAPM, 3-factor, and 5-factor models
- Calculates alpha with significance
- Performs factor attribution
- Generates visualizations and reports</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 9.6: Complete Factor Model System (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FactorModelAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive factor model analysis system.</span>

<span class="sd">    Supports CAPM, 3-factor, and 5-factor models with</span>
<span class="sd">    alpha analysis, attribution, and style classification.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stock_excess</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                 <span class="n">market_excess</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                 <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                 <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Stock&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stock_excess</span> <span class="o">=</span> <span class="n">stock_excess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_excess</span> <span class="o">=</span> <span class="n">market_excess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="n">factors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_all_models</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fit_all_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit CAPM and multi-factor models.&quot;&quot;&quot;</span>
        <span class="c1"># CAPM</span>
        <span class="n">X_capm</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">market_excess</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;CAPM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stock_excess</span><span class="p">,</span> <span class="n">X_capm</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="c1"># Multi-factor</span>
        <span class="n">X_mf</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;Multi-Factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stock_excess</span><span class="p">,</span> <span class="n">X_mf</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Multi-Factor&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get alpha statistics.&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;alpha_daily&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;alpha_annual&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
            <span class="s1">&#39;t_stat&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">tvalues</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;significant&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_betas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Multi-Factor&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get factor betas.&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_r_squared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Multi-Factor&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get model R-squared.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">rsquared</span>

    <span class="k">def</span> <span class="nf">factor_attribution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Decompose returns by factors.&quot;&quot;&quot;</span>
        <span class="n">betas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_betas</span><span class="p">()</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">()[</span><span class="s1">&#39;alpha_daily&#39;</span><span class="p">]</span>

        <span class="n">contributions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">betas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">contributions</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">contributions</span><span class="p">[</span><span class="s1">&#39;Alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">252</span>

        <span class="k">return</span> <span class="n">contributions</span>

    <span class="k">def</span> <span class="nf">information_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Information Ratio.&quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">()[</span><span class="s1">&#39;alpha_annual&#39;</span><span class="p">]</span>
        <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;Multi-Factor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">alpha</span> <span class="o">/</span> <span class="n">te</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print comprehensive summary.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FACTOR MODEL ANALYSIS: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Model comparison</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MODEL COMPARISON&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">40</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: R¬≤=</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">rsquared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, Alpha=</span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s2">+.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="c1"># Alpha analysis</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ALPHA ANALYSIS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">40</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alpha (annual): </span><span class="si">{</span><span class="n">alpha</span><span class="p">[</span><span class="s1">&#39;alpha_annual&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t-statistic: </span><span class="si">{</span><span class="n">alpha</span><span class="p">[</span><span class="s1">&#39;t_stat&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p-value: </span><span class="si">{</span><span class="n">alpha</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant: </span><span class="si">{</span><span class="s1">&#39;Yes&#39;</span> <span class="k">if</span> <span class="n">alpha</span><span class="p">[</span><span class="s1">&#39;significant&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;No&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Information Ratio: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">information_ratio</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Factor betas</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FACTOR LOADINGS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">40</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">beta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_betas</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">factor</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">beta</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Attribution</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FACTOR ATTRIBUTION (Annual)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">40</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">contrib</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_attribution</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">factor</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">contrib</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">+.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">FactorModelAnalyzer</span><span class="p">(</span>
    <span class="n">stock_excess</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">],</span>
    <span class="n">market_excess</span><span class="p">,</span>
    <span class="n">factors_3</span><span class="p">,</span>
    <span class="s1">&#39;AAPL&#39;</span>
<span class="p">)</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Production Factor Analysis System</h1>
<p>Build a comprehensive factor analysis system suitable for institutional use.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductionFactorSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready factor analysis system.</span>

<span class="sd">    Features:</span>
<span class="sd">    - Multi-stock factor model analysis</span>
<span class="sd">    - Rolling analysis for time-varying exposures</span>
<span class="sd">    - Portfolio-level factor attribution</span>
<span class="sd">    - Style classification</span>
<span class="sd">    - Comprehensive reporting</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                 <span class="n">market_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                 <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                 <span class="n">risk_free_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.04</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_returns</span> <span class="o">=</span> <span class="n">market_returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="n">factors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">risk_free_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_rf</span> <span class="o">=</span> <span class="n">risk_free_rate</span> <span class="o">/</span> <span class="mi">252</span>

        <span class="c1"># Calculate excess returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">excess_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_rf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_excess</span> <span class="o">=</span> <span class="n">market_returns</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_rf</span>

        <span class="c1"># Fit models for all stocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_all_models</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_fit_all_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit factor models for all stocks.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">excess_returns</span><span class="p">[</span><span class="n">ticker</span><span class="p">],</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;alpha_annual&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
                <span class="s1">&#39;alpha_tstat&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">tvalues</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;alpha_pvalue&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;betas&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                <span class="s1">&#39;r_squared&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">rsquared</span>
            <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_stock_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get summary for a single stock.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">portfolio_exposure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate portfolio-level factor exposures.&quot;&quot;&quot;</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">port_betas</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">}</span>
        <span class="n">port_alpha</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">stock</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">stock</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
                    <span class="n">port_betas</span><span class="p">[</span><span class="n">factor</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">stock</span><span class="p">][</span><span class="s1">&#39;betas&#39;</span><span class="p">][</span><span class="n">factor</span><span class="p">]</span>
                <span class="n">port_alpha</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">stock</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;betas&#39;</span><span class="p">:</span> <span class="n">port_betas</span><span class="p">,</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">port_alpha</span><span class="p">,</span>
            <span class="s1">&#39;alpha_annual&#39;</span><span class="p">:</span> <span class="n">port_alpha</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">style_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Classify stocks by style.&quot;&quot;&quot;</span>
        <span class="n">classifications</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">smb</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">hml</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HML&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;Small&#39;</span> <span class="k">if</span> <span class="n">smb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Large&#39;</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;Value&#39;</span> <span class="k">if</span> <span class="n">hml</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;Growth&#39;</span>

            <span class="n">classifications</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Stock&#39;</span><span class="p">:</span> <span class="n">ticker</span><span class="p">,</span>
                <span class="s1">&#39;Size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="s1">&#39;Style&#39;</span><span class="p">:</span> <span class="n">style</span><span class="p">,</span>
                <span class="s1">&#39;Quadrant&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">style</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">classifications</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_weights</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PRODUCTION FACTOR ANALYSIS REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

        <span class="c1"># Individual stocks</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">INDIVIDUAL STOCK ANALYSIS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Stock&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Alpha&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;MKT&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;SMB&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;HML&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;R¬≤&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ticker</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;alpha_annual&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2">% &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MKT&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HML&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;r_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Style classification</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">STYLE CLASSIFICATION&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">styles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_classification</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">styles</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="c1"># Portfolio analysis</span>
        <span class="k">if</span> <span class="n">portfolio_weights</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">PORTFOLIO FACTOR EXPOSURE&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
            <span class="n">port_exp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_exposure</span><span class="p">(</span><span class="n">portfolio_weights</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weights: </span><span class="si">{</span><span class="n">portfolio_weights</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Alpha (ann): </span><span class="si">{</span><span class="n">port_exp</span><span class="p">[</span><span class="s1">&#39;alpha_annual&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">port_exp</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">factor</span><span class="si">}</span><span class="s2"> Beta: </span><span class="si">{</span><span class="n">beta</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">ProductionFactorSystem</span><span class="p">(</span>
    <span class="n">returns</span><span class="o">=</span><span class="n">stock_returns</span><span class="p">,</span>
    <span class="n">market_returns</span><span class="o">=</span><span class="n">market_returns</span><span class="p">,</span>
    <span class="n">factors</span><span class="o">=</span><span class="n">factors_3</span>
<span class="p">)</span>

<span class="n">test_weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AAPL&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;JNJ&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;XOM&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
<span class="n">system</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">test_weights</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. CAPM and Beta</h3>
<ul>
<li>Beta measures sensitivity to market movements</li>
<li>Can be calculated via covariance or regression</li>
<li>Rolling beta shows time-varying exposure</li>
</ul>
<h3>2. Multi-Factor Models</h3>
<ul>
<li>Fama-French 3-factor: Market, Size (SMB), Value (HML)</li>
<li>5-factor adds Profitability (RMW) and Investment (CMA)</li>
<li>More factors explain more variance but risk overfitting</li>
</ul>
<h3>3. Alpha Analysis</h3>
<ul>
<li>Alpha is return not explained by factor exposures</li>
<li>Statistical significance requires t-stat &gt; 1.96</li>
<li>Information Ratio measures alpha per unit tracking error</li>
</ul>
<h3>4. Factor Attribution</h3>
<ul>
<li>Decomposes returns into factor contributions</li>
<li>Style analysis classifies by size and value loadings</li>
<li>Portfolio exposure is weighted average of stock exposures</li>
</ul></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 10: Monte Carlo Simulation</strong>, we'll explore:
- Geometric Brownian Motion simulation
- Correlated multi-asset simulation
- Option pricing with Monte Carlo
- Portfolio simulation and scenario analysis</p>
<hr />
<p><em>Congratulations on completing Module 9!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="10"><div class="md-cell module-header"><h1>Module 10: Monte Carlo Simulation</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 4: Simulation &amp; Analytics</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Generate reproducible random samples for financial simulations</li>
<li>Simulate stock price paths using Geometric Brownian Motion</li>
<li>Create correlated multi-asset simulations with Cholesky decomposition</li>
<li>Apply Monte Carlo methods to portfolio analysis and option pricing</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 7-8: Risk Modeling</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-10.1">Section 10.1: Random Number Generation</a></li>
<li><a href="#section-10.2">Section 10.2: Simulating Price Paths</a></li>
<li><a href="#section-10.3">Section 10.3: Correlated Simulations</a></li>
<li><a href="#section-10.4">Section 10.4: Applications</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">cholesky</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 10: Monte Carlo Simulation - Ready!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download data</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Handle MultiIndex columns</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span><span class="si">}</span><span class="s1"> days&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Assets: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-10.1'></a></p>
<h1>Section 10.1: Random Number Generation</h1>
<p>Monte Carlo methods depend on generating random numbers. Understanding how to properly generate and control randomness is essential for reproducible research.</p>
<p><strong>In this section, you will learn:</strong>
- Pseudo-random number generation with seeds
- Modern NumPy Generator objects
- Generating samples from different distributions</p></div>
<div class="md-cell"><h2>10.1.1 Reproducibility with Seeds</h2>
<p>Computers generate "pseudo-random" numbers - they appear random but are deterministic given a starting seed. This is crucial for reproducible research.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Basic random number generation</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Random Numbers Without Seed (different each run):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">With Seed (reproducible):&quot;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># Reset to same seed</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>  <span class="c1"># Same numbers!</span>
</code></pre></div>
<div class="md-cell"><h2>10.1.2 Modern Generator Objects</h2>
<p>NumPy's modern approach uses Generator objects for better control and performance.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Modern NumPy random generation</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using Generator object:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Standard normal: </span><span class="si">{</span><span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uniform [0,1]:   </span><span class="si">{</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Integers [1,10]: </span><span class="si">{</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Multiple independent generators</span>
<span class="n">rng1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">rng2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generator 1: </span><span class="si">{</span><span class="n">rng1</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generator 2: </span><span class="si">{</span><span class="n">rng2</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>10.1.3 Different Distributions</h2>
<p>Financial returns often have "fat tails" - extreme values occur more frequently than a normal distribution predicts.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># Generate samples from various distributions</span>
<span class="n">normal</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
<span class="n">student_t</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_t</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
<span class="n">uniform</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
<span class="n">lognormal</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>

<span class="c1"># Compare distributions</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">distributions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="s1">&#39;Normal(0, 1)&#39;</span><span class="p">,</span> <span class="s1">&#39;steelblue&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">student_t</span><span class="p">,</span> <span class="s1">&#39;Student-t (df=5)&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">uniform</span><span class="p">,</span> <span class="s1">&#39;Uniform(-1, 1)&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">lognormal</span><span class="p">,</span> <span class="s1">&#39;Log-Normal(0, 0.5)&#39;</span><span class="p">,</span> <span class="s1">&#39;crimson&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">distributions</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 10.1: Fat Tail Analysis (Guided)</h3>
<p><strong>Your Task:</strong> Compare the frequency of extreme events between Normal and Student-t distributions.</p>
<p>Fill in the blanks to complete the analysis:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.1: Fat Tail Analysis (Guided)</span>
<span class="k">def</span> <span class="nf">compare_tail_events</span><span class="p">(</span><span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare extreme events between Normal and Student-t distributions.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        n_samples: Number of samples to generate</span>
<span class="sd">        threshold: Number of standard deviations for extreme events</span>
<span class="sd">        df: Degrees of freedom for Student-t</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with extreme event counts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="c1"># TODO: Generate normal samples with mean=0, std=1</span>
    <span class="n">normal_samples</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    
    <span class="c1"># TODO: Generate Student-t samples</span>
    <span class="n">t_samples</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
    
    <span class="c1"># TODO: Count events beyond threshold std devs (use np.abs)</span>
    <span class="n">normal_extreme</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">normal_samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">t_extreme</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t_samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;normal_count&#39;</span><span class="p">:</span> <span class="n">normal_extreme</span><span class="p">,</span>
        <span class="s1">&#39;normal_pct&#39;</span><span class="p">:</span> <span class="n">normal_extreme</span> <span class="o">/</span> <span class="n">n_samples</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;t_count&#39;</span><span class="p">:</span> <span class="n">t_extreme</span><span class="p">,</span>
        <span class="s1">&#39;t_pct&#39;</span><span class="p">:</span> <span class="n">t_extreme</span> <span class="o">/</span> <span class="n">n_samples</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="n">t_extreme</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">normal_extreme</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># result = compare_tail_events()</span>
<span class="c1"># print(f&quot;Normal extreme events: {result[&#39;normal_count&#39;]} ({result[&#39;normal_pct&#39;]:.3f}%)&quot;)</span>
<span class="c1"># print(f&quot;Student-t extreme events: {result[&#39;t_count&#39;]} ({result[&#39;t_pct&#39;]:.3f}%)&quot;)</span>
<span class="c1"># print(f&quot;Student-t has {result[&#39;ratio&#39;]:.1f}x more extreme events&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compare_tail_events</span><span class="p">(</span><span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare extreme events between Normal and Student-t distributions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># Generate normal samples with mean=0, std=1</span>
    <span class="n">normal_samples</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>

    <span class="c1"># Generate Student-t samples</span>
    <span class="n">t_samples</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_t</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>

    <span class="c1"># Count events beyond threshold std devs</span>
    <span class="n">normal_extreme</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">normal_samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">t_extreme</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t_samples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;normal_count&#39;</span><span class="p">:</span> <span class="n">normal_extreme</span><span class="p">,</span>
        <span class="s1">&#39;normal_pct&#39;</span><span class="p">:</span> <span class="n">normal_extreme</span> <span class="o">/</span> <span class="n">n_samples</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;t_count&#39;</span><span class="p">:</span> <span class="n">t_extreme</span><span class="p">,</span>
        <span class="s1">&#39;t_pct&#39;</span><span class="p">:</span> <span class="n">t_extreme</span> <span class="o">/</span> <span class="n">n_samples</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="n">t_extreme</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">normal_extreme</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compare_tail_events</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normal extreme events: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;normal_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;normal_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Student-t extreme events: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;t_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;t_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Student-t has </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">x more extreme events&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-10.2'></a></p>
<h1>Section 10.2: Simulating Price Paths</h1>
<p>The standard model for stock prices assumes they follow Geometric Brownian Motion (GBM).</p>
<p><strong>In this section, you will learn:</strong>
- The GBM model and its assumptions
- Simulating single-asset price paths
- Adding fat tails to simulations</p></div>
<div class="md-cell"><h2>10.2.1 Geometric Brownian Motion</h2>
<p>The discrete-time solution for GBM is:</p>
<p>$$S_{t+1} = S_t \exp\left[(\mu - \frac{\sigma^2}{2})\Delta t + \sigma\sqrt{\Delta t} \cdot Z\right]$$</p>
<p>Where $Z \sim N(0,1)$.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">simulate_gbm</span><span class="p">(</span><span class="n">S0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                 <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate stock price paths using Geometric Brownian Motion.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        S0: Initial stock price</span>
<span class="sd">        mu: Annual drift (expected return)</span>
<span class="sd">        sigma: Annual volatility</span>
<span class="sd">        T: Time horizon in years</span>
<span class="sd">        n_steps: Number of time steps</span>
<span class="sd">        n_paths: Number of simulation paths</span>
<span class="sd">        seed: Random seed for reproducibility</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Price paths array of shape (n_steps + 1, n_paths)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">n_steps</span>
    
    <span class="c1"># Pre-compute constants</span>
    <span class="n">drift</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">diffusion</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    
    <span class="c1"># Generate random shocks</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
    
    <span class="c1"># Calculate log returns</span>
    <span class="n">log_returns</span> <span class="o">=</span> <span class="n">drift</span> <span class="o">+</span> <span class="n">diffusion</span> <span class="o">*</span> <span class="n">Z</span>
    
    <span class="c1"># Build price paths</span>
    <span class="n">log_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
    <span class="n">log_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0</span><span class="p">)</span>
    <span class="n">log_prices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">log_returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_prices</span><span class="p">)</span>

<span class="c1"># Estimate parameters from SPY</span>
<span class="n">spy_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>
<span class="n">mu_annual</span> <span class="o">=</span> <span class="n">spy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">sigma_annual</span> <span class="o">=</span> <span class="n">spy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">S0</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPY Parameters:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Current price: $</span><span class="si">{</span><span class="n">S0</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annual return (mu): </span><span class="si">{</span><span class="n">mu_annual</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annual volatility (sigma): </span><span class="si">{</span><span class="n">sigma_annual</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate 1 year of SPY prices</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1 year</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">252</span>  <span class="c1"># Daily steps</span>
<span class="n">n_paths</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">paths</span> <span class="o">=</span> <span class="n">simulate_gbm</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">mu_annual</span><span class="p">,</span> <span class="n">sigma_annual</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Visualize</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Left: Sample paths</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">time_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">)):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">paths</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Add percentile bands</span>
<span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">95</span><span class="p">]</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">th pct&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Price&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (years)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price ($)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SPY Price Simulation (</span><span class="si">{</span><span class="n">n_paths</span><span class="si">}</span><span class="s1"> paths)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1"># Right: Terminal price distribution</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">terminal_prices</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">terminal_prices</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Initial: $</span><span class="si">{</span><span class="n">S0</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_prices</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mean: $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_prices</span><span class="p">)</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Terminal Price ($)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribution of 1-Year Ending Prices&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Summary statistics</span>
<span class="n">terminal_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">terminal_prices</span> <span class="o">/</span> <span class="n">S0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Terminal Price Statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_prices</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_returns</span><span class="p">)</span><span class="si">:</span><span class="s2">+.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Median: $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">terminal_prices</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  5th percentile: $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">terminal_prices</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  95th percentile: $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">terminal_prices</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>10.2.2 Adding Fat Tails</h2>
<p>GBM assumes normal returns, but real returns have fat tails. We can use Student-t distribution instead.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">simulate_gbm_fat_tails</span><span class="p">(</span><span class="n">S0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                          <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
                          <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate price paths with fat-tailed returns (Student-t).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: Degrees of freedom for Student-t (lower = fatter tails)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">n_steps</span>
    <span class="n">drift</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
    
    <span class="c1"># Student-t has variance = df/(df-2), scale to match desired sigma</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">df</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">df</span><span class="p">)</span>
    <span class="n">diffusion</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
    
    <span class="c1"># Generate Student-t shocks</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_t</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
    <span class="n">log_returns</span> <span class="o">=</span> <span class="n">drift</span> <span class="o">+</span> <span class="n">diffusion</span> <span class="o">*</span> <span class="n">Z</span>
    
    <span class="n">log_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
    <span class="n">log_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0</span><span class="p">)</span>
    <span class="n">log_prices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">log_returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_prices</span><span class="p">)</span>

<span class="c1"># Compare normal vs fat-tailed simulations</span>
<span class="n">paths_normal</span> <span class="o">=</span> <span class="n">simulate_gbm</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">mu_annual</span><span class="p">,</span> <span class="n">sigma_annual</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">paths_fat</span> <span class="o">=</span> <span class="n">simulate_gbm_fat_tails</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">mu_annual</span><span class="p">,</span> <span class="n">sigma_annual</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Compare terminal distributions</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">paths_normal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">paths_fat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fat-tailed (df=5)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Price&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Terminal Price ($)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Terminal Price Distribution: Normal vs Fat-Tailed&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Compare tail statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tail Statistics Comparison:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  1st percentile - Normal: $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">paths_normal</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  1st percentile - Fat-tailed: $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">paths_fat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 10.2: Monte Carlo VaR Calculator (Guided)</h3>
<p><strong>Your Task:</strong> Use Monte Carlo simulation to estimate 1-day VaR at different confidence levels.</p>
<p>Fill in the blanks to complete the VaR calculator:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.2: Monte Carlo VaR Calculator (Guided)</span>
<span class="k">def</span> <span class="nf">monte_carlo_var</span><span class="p">(</span><span class="n">S0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                    <span class="n">n_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> 
                    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate 1-day VaR using Monte Carlo simulation.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        S0: Current price</span>
<span class="sd">        mu: Annual expected return</span>
<span class="sd">        sigma: Annual volatility</span>
<span class="sd">        n_simulations: Number of simulations</span>
<span class="sd">        confidence: Confidence level</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with VaR metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate daily parameters</span>
    <span class="n">daily_mu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">/</span> <span class="n">______</span>
    <span class="n">daily_sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">______</span><span class="p">)</span>
    
    <span class="c1"># TODO: Generate 1-day returns using normal distribution</span>
    <span class="n">sim_returns</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">daily_mu</span><span class="p">,</span> <span class="n">daily_sigma</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate VaR as negative percentile of returns</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">sim_returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate Expected Shortfall (mean of returns below VaR)</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sim_returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">es</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">sim_returns</span><span class="p">[</span><span class="n">sim_returns</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
        <span class="s1">&#39;var_dollar&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">*</span> <span class="n">S0</span><span class="p">,</span>
        <span class="s1">&#39;es&#39;</span><span class="p">:</span> <span class="n">es</span><span class="p">,</span>
        <span class="s1">&#39;es_dollar&#39;</span><span class="p">:</span> <span class="n">es</span> <span class="o">*</span> <span class="n">S0</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># result = monte_carlo_var(S0, mu_annual, sigma_annual, confidence=0.95)</span>
<span class="c1"># print(f&quot;95% VaR: {result[&#39;var&#39;]*100:.2f}% (${result[&#39;var_dollar&#39;]:.2f})&quot;)</span>
<span class="c1"># print(f&quot;95% ES:  {result[&#39;es&#39;]*100:.2f}% (${result[&#39;es_dollar&#39;]:.2f})&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">monte_carlo_var</span><span class="p">(</span><span class="n">S0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                    <span class="n">n_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> 
                    <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate 1-day VaR using Monte Carlo simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># Calculate daily parameters</span>
    <span class="n">daily_mu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">/</span> <span class="mi">252</span>
    <span class="n">daily_sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="c1"># Generate 1-day returns using normal distribution</span>
    <span class="n">sim_returns</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">daily_mu</span><span class="p">,</span> <span class="n">daily_sigma</span><span class="p">,</span> <span class="n">n_simulations</span><span class="p">)</span>

    <span class="c1"># Calculate VaR as negative percentile of returns</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span>
    <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sim_returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Calculate Expected Shortfall</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sim_returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">es</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_returns</span><span class="p">[</span><span class="n">sim_returns</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
        <span class="s1">&#39;var_dollar&#39;</span><span class="p">:</span> <span class="n">var</span> <span class="o">*</span> <span class="n">S0</span><span class="p">,</span>
        <span class="s1">&#39;es&#39;</span><span class="p">:</span> <span class="n">es</span><span class="p">,</span>
        <span class="s1">&#39;es_dollar&#39;</span><span class="p">:</span> <span class="n">es</span> <span class="o">*</span> <span class="n">S0</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">monte_carlo_var</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">mu_annual</span><span class="p">,</span> <span class="n">sigma_annual</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% VaR: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% ($</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;var_dollar&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;95% ES:  </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;es&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% ($</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;es_dollar&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-10.3'></a></p>
<h1>Section 10.3: Correlated Simulations</h1>
<p>Real portfolios contain multiple assets that are correlated. We need to simulate paths that preserve these correlation structures.</p>
<p><strong>In this section, you will learn:</strong>
- Cholesky decomposition for correlation
- Simulating correlated multi-asset paths
- Portfolio value simulation</p></div>
<div class="md-cell"><h2>10.3.1 Cholesky Decomposition</h2>
<p>To generate correlated random variables, we use the Cholesky decomposition:</p>
<p>$$\Sigma = LL^T$$</p>
<p>If $Z$ is a vector of independent standard normals, then $X = LZ$ has the desired correlation structure.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate correlation matrix from historical data</span>
<span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Historical Correlation Matrix:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># Cholesky decomposition</span>
<span class="n">L</span> <span class="o">=</span> <span class="n">cholesky</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cholesky matrix L (lower triangular):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># Verify: L @ L.T should equal correlation matrix</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Verification (L @ L.T):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">L</span> <span class="o">@</span> <span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">simulate_correlated_gbm</span><span class="p">(</span><span class="n">S0_vec</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">mu_vec</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">sigma_vec</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> 
                            <span class="n">corr_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                            <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate correlated multi-asset price paths.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping asset index to price paths array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">S0_vec</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">n_steps</span>
    
    <span class="c1"># Cholesky decomposition</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">cholesky</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Generate independent normals</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_assets</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
    
    <span class="c1"># Apply correlation structure</span>
    <span class="n">corr_Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
        <span class="n">corr_Z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span> <span class="o">@</span> <span class="n">Z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
    
    <span class="c1"># Calculate price paths for each asset</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_assets</span><span class="p">):</span>
        <span class="n">drift</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">diffusion</span> <span class="o">=</span> <span class="n">sigma_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">log_returns</span> <span class="o">=</span> <span class="n">drift</span> <span class="o">+</span> <span class="n">diffusion</span> <span class="o">*</span> <span class="n">corr_Z</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        
        <span class="n">log_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
        <span class="n">log_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0_vec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">log_prices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0_vec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">log_returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_prices</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">paths</span>

<span class="c1"># Get parameters for all assets</span>
<span class="n">assets</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">S0_vec</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">]</span>
<span class="n">mu_vec</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">]</span>
<span class="n">sigma_vec</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Asset Parameters:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">asset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assets</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset</span><span class="si">}</span><span class="s2">: S0=$</span><span class="si">{</span><span class="n">S0_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, mu=</span><span class="si">{</span><span class="n">mu_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, sigma=</span><span class="si">{</span><span class="n">sigma_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate correlated paths</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">252</span>
<span class="n">n_paths</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="n">corr_paths</span> <span class="o">=</span> <span class="n">simulate_correlated_gbm</span><span class="p">(</span>
    <span class="n">S0_vec</span><span class="p">,</span> <span class="n">mu_vec</span><span class="p">,</span> <span class="n">sigma_vec</span><span class="p">,</span> <span class="n">corr_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
    <span class="n">T</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># Verify correlation is preserved</span>
<span class="n">sim_returns_all</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">asset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assets</span><span class="p">):</span>
    <span class="n">path_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">corr_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sim_returns_all</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_returns</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">sim_returns_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sim_returns_all</span><span class="p">)</span>
<span class="n">sim_corr</span> <span class="o">=</span> <span class="n">sim_returns_df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulated Correlation Matrix:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sim_corr</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Difference from Original (should be near zero):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">((</span><span class="n">sim_corr</span> <span class="o">-</span> <span class="n">corr_matrix</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h2>10.3.2 Portfolio Simulation</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">simulate_portfolio_value</span><span class="p">(</span><span class="n">corr_paths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                            <span class="n">assets</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate portfolio value paths from correlated asset simulations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_steps</span><span class="p">,</span> <span class="n">n_paths</span> <span class="o">=</span> <span class="n">corr_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">port_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">asset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">:</span>
            <span class="n">normalized</span> <span class="o">=</span> <span class="n">corr_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">corr_paths</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">port_value</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">normalized</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">port_value</span> <span class="o">*</span> <span class="n">initial_value</span>

<span class="c1"># Define portfolio weights</span>
<span class="n">portfolio_weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
<span class="n">initial_value</span> <span class="o">=</span> <span class="mi">100000</span>

<span class="c1"># Calculate portfolio paths</span>
<span class="n">port_paths</span> <span class="o">=</span> <span class="n">simulate_portfolio_value</span><span class="p">(</span><span class="n">corr_paths</span><span class="p">,</span> <span class="n">portfolio_weights</span><span class="p">,</span> <span class="n">assets</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>

<span class="c1"># Visualize</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Left: Portfolio value paths</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">time_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">)):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">port_paths</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">port_paths</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">port_paths</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;5th-95th percentile&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">port_paths</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">initial_value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Value&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (years)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Value ($)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Portfolio Simulation (</span><span class="si">{</span><span class="n">n_paths</span><span class="si">}</span><span class="s1"> paths)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="c1"># Right: Terminal value distribution</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">terminal_values</span> <span class="o">=</span> <span class="n">port_paths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">terminal_values</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">initial_value</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Initial: $</span><span class="si">{</span><span class="n">initial_value</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">k&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_values</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mean: $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_values</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">k&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Terminal Value ($k)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribution of 1-Year Portfolio Values&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Summary</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Portfolio Simulation Summary (Initial: $</span><span class="si">{</span><span class="n">initial_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expected Value: $</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_values</span><span class="p">)</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Probability of Loss: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_values</span> <span class="o">&lt;</span> <span class="n">initial_value</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Probability of &gt;20% Gain: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_values</span> <span class="o">&gt;</span> <span class="n">initial_value</span><span class="o">*</span><span class="mf">1.2</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 10.3: Portfolio Risk Comparison (Guided)</h3>
<p><strong>Your Task:</strong> Compare risk metrics for different portfolio allocations using Monte Carlo.</p>
<p>Fill in the blanks to complete the comparison:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.3: Portfolio Risk Comparison (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_portfolio_risk_metrics</span><span class="p">(</span><span class="n">corr_paths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                                     <span class="n">assets</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate risk metrics for a portfolio from Monte Carlo simulation.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with risk metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">port_paths</span> <span class="o">=</span> <span class="n">simulate_portfolio_value</span><span class="p">(</span><span class="n">corr_paths</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">assets</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
    <span class="n">terminal_values</span> <span class="o">=</span> <span class="n">port_paths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    
    <span class="c1"># TODO: Calculate terminal returns as percentage</span>
    <span class="n">terminal_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">terminal_values</span> <span class="o">/</span> <span class="n">initial_value</span> <span class="o">-</span> <span class="n">______</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate VaR at 95% (negative 5th percentile)</span>
    <span class="n">var_95</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">terminal_returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate Expected Shortfall</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">terminal_returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">es_95</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">terminal_returns</span><span class="p">[</span><span class="n">terminal_returns</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean_return&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_returns</span><span class="p">),</span>
        <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">terminal_returns</span><span class="p">),</span>
        <span class="s1">&#39;var_95&#39;</span><span class="p">:</span> <span class="n">var_95</span><span class="p">,</span>
        <span class="s1">&#39;es_95&#39;</span><span class="p">:</span> <span class="n">es_95</span><span class="p">,</span>
        <span class="s1">&#39;prob_loss&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test your solution with two portfolios</span>
<span class="c1"># aggressive = {&#39;SPY&#39;: 0.7, &#39;QQQ&#39;: 0.3, &#39;TLT&#39;: 0.0, &#39;GLD&#39;: 0.0}</span>
<span class="c1"># defensive = {&#39;SPY&#39;: 0.2, &#39;QQQ&#39;: 0.0, &#39;TLT&#39;: 0.4, &#39;GLD&#39;: 0.4}</span>
<span class="c1"># </span>
<span class="c1"># agg_metrics = calculate_portfolio_risk_metrics(corr_paths, aggressive, assets, initial_value)</span>
<span class="c1"># def_metrics = calculate_portfolio_risk_metrics(corr_paths, defensive, assets, initial_value)</span>
<span class="c1"># print(f&quot;Aggressive VaR: {agg_metrics[&#39;var_95&#39;]*100:.1f}%&quot;)</span>
<span class="c1"># print(f&quot;Defensive VaR: {def_metrics[&#39;var_95&#39;]*100:.1f}%&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_portfolio_risk_metrics</span><span class="p">(</span><span class="n">corr_paths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                                     <span class="n">assets</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate risk metrics for a portfolio from Monte Carlo simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">port_paths</span> <span class="o">=</span> <span class="n">simulate_portfolio_value</span><span class="p">(</span><span class="n">corr_paths</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">assets</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
    <span class="n">terminal_values</span> <span class="o">=</span> <span class="n">port_paths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Calculate terminal returns as percentage</span>
    <span class="n">terminal_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">terminal_values</span> <span class="o">/</span> <span class="n">initial_value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate VaR at 95%</span>
    <span class="n">var_95</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">terminal_returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Calculate Expected Shortfall</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">terminal_returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">es_95</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_returns</span><span class="p">[</span><span class="n">terminal_returns</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean_return&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_returns</span><span class="p">),</span>
        <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">terminal_returns</span><span class="p">),</span>
        <span class="s1">&#39;var_95&#39;</span><span class="p">:</span> <span class="n">var_95</span><span class="p">,</span>
        <span class="s1">&#39;es_95&#39;</span><span class="p">:</span> <span class="n">es_95</span><span class="p">,</span>
        <span class="s1">&#39;prob_loss&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal_returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># Test with two portfolios</span>
<span class="n">aggressive</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
<span class="n">defensive</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">}</span>

<span class="n">agg_metrics</span> <span class="o">=</span> <span class="n">calculate_portfolio_risk_metrics</span><span class="p">(</span><span class="n">corr_paths</span><span class="p">,</span> <span class="n">aggressive</span><span class="p">,</span> <span class="n">assets</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="n">def_metrics</span> <span class="o">=</span> <span class="n">calculate_portfolio_risk_metrics</span><span class="p">(</span><span class="n">corr_paths</span><span class="p">,</span> <span class="n">defensive</span><span class="p">,</span> <span class="n">assets</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aggressive - Return: </span><span class="si">{</span><span class="n">agg_metrics</span><span class="p">[</span><span class="s1">&#39;mean_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, VaR: </span><span class="si">{</span><span class="n">agg_metrics</span><span class="p">[</span><span class="s1">&#39;var_95&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Defensive - Return: </span><span class="si">{</span><span class="n">def_metrics</span><span class="p">[</span><span class="s1">&#39;mean_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, VaR: </span><span class="si">{</span><span class="n">def_metrics</span><span class="p">[</span><span class="s1">&#39;var_95&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-10.4'></a></p>
<h1>Section 10.4: Applications</h1>
<p><strong>In this section, you will learn:</strong>
- Option pricing with Monte Carlo
- Retirement planning simulations
- Practical considerations</p></div>
<div class="md-cell"><h2>10.4.1 Option Pricing</h2>
<p>Monte Carlo can price path-dependent and exotic options that lack analytical solutions.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">monte_carlo_european_option</span><span class="p">(</span><span class="n">S0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                                <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> 
                                <span class="n">n_paths</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Price a European option using Monte Carlo simulation.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        S0: Current stock price</span>
<span class="sd">        K: Strike price</span>
<span class="sd">        T: Time to expiration (years)</span>
<span class="sd">        r: Risk-free rate</span>
<span class="sd">        sigma: Volatility</span>
<span class="sd">        option_type: &#39;call&#39; or &#39;put&#39;</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with price and statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    
    <span class="c1"># Simulate terminal stock prices under risk-neutral measure</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">n_paths</span><span class="p">)</span>
    <span class="n">ST</span> <span class="o">=</span> <span class="n">S0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">r</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">Z</span><span class="p">)</span>
    
    <span class="c1"># Calculate payoffs</span>
    <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
        <span class="n">payoffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">ST</span> <span class="o">-</span> <span class="n">K</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">payoffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">K</span> <span class="o">-</span> <span class="n">ST</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Discount expected payoff</span>
    <span class="n">discounted_payoffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">payoffs</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">discounted_payoffs</span><span class="p">)</span>
    <span class="n">std_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">discounted_payoffs</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_paths</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
        <span class="s1">&#39;std_error&#39;</span><span class="p">:</span> <span class="n">std_error</span><span class="p">,</span>
        <span class="s1">&#39;ci_95&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">std_error</span><span class="p">,</span> <span class="n">price</span> <span class="o">+</span> <span class="mf">1.96</span> <span class="o">*</span> <span class="n">std_error</span><span class="p">)</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">black_scholes</span><span class="p">(</span><span class="n">S0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                  <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analytical Black-Scholes price for comparison.&quot;&quot;&quot;</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0</span><span class="o">/</span><span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">S0</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d2</span><span class="p">)</span> <span class="o">-</span> <span class="n">S0</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">price</span>

<span class="c1"># Price an option</span>
<span class="n">S0_opt</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">105</span>
<span class="n">T_opt</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">sigma_opt</span> <span class="o">=</span> <span class="mf">0.20</span>

<span class="n">mc_result</span> <span class="o">=</span> <span class="n">monte_carlo_european_option</span><span class="p">(</span><span class="n">S0_opt</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T_opt</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma_opt</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">bs_price</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">S0_opt</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T_opt</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma_opt</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;European Call Option Pricing&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Black-Scholes Price: $</span><span class="si">{</span><span class="n">bs_price</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Monte Carlo Price:   $</span><span class="si">{</span><span class="n">mc_result</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MC Standard Error:   $</span><span class="si">{</span><span class="n">mc_result</span><span class="p">[</span><span class="s1">&#39;std_error&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Difference: $</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">mc_result</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bs_price</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>10.4.2 Retirement Planning</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">retirement_simulation</span><span class="p">(</span><span class="n">initial_savings</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">annual_contribution</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                         <span class="n">years_to_retirement</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">years_in_retirement</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                         <span class="n">annual_withdrawal</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                         <span class="n">n_paths</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate retirement outcomes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">total_years</span> <span class="o">=</span> <span class="n">years_to_retirement</span> <span class="o">+</span> <span class="n">years_in_retirement</span>
    
    <span class="c1"># Generate annual returns</span>
    <span class="n">annual_returns</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="p">(</span><span class="n">total_years</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
    
    <span class="c1"># Initialize wealth</span>
    <span class="n">wealth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">total_years</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
    <span class="n">wealth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">initial_savings</span>
    
    <span class="c1"># Accumulation phase</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">years_to_retirement</span><span class="p">):</span>
        <span class="n">wealth</span><span class="p">[</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">wealth</span><span class="p">[</span><span class="n">year</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">annual_returns</span><span class="p">[</span><span class="n">year</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="n">annual_contribution</span>
    
    <span class="c1"># Distribution phase</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">years_to_retirement</span><span class="p">,</span> <span class="n">total_years</span><span class="p">):</span>
        <span class="n">new_wealth</span> <span class="o">=</span> <span class="n">wealth</span><span class="p">[</span><span class="n">year</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">annual_returns</span><span class="p">[</span><span class="n">year</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="n">annual_withdrawal</span>
        <span class="n">wealth</span><span class="p">[</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">new_wealth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="n">final_wealth</span> <span class="o">=</span> <span class="n">wealth</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;wealth_paths&#39;</span><span class="p">:</span> <span class="n">wealth</span><span class="p">,</span>
        <span class="s1">&#39;prob_success&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">final_wealth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;median_retirement&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">wealth</span><span class="p">[</span><span class="n">years_to_retirement</span><span class="p">,</span> <span class="p">:]),</span>
        <span class="s1">&#39;median_final&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">final_wealth</span><span class="p">[</span><span class="n">final_wealth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">final_wealth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">}</span>

<span class="c1"># Run simulation</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">retirement_simulation</span><span class="p">(</span>
    <span class="n">initial_savings</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
    <span class="n">annual_contribution</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
    <span class="n">years_to_retirement</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="n">years_in_retirement</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">annual_withdrawal</span><span class="o">=</span><span class="mi">80000</span><span class="p">,</span>
    <span class="n">mu</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span>
    <span class="n">sigma</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retirement Planning Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Probability of Success: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;prob_success&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Median Wealth at Retirement: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;median_retirement&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Median Final Wealth (if successful): $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;median_final&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 10.4: Option Price Sensitivity (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Calculates option prices for a range of strike prices
- Uses Monte Carlo simulation
- Returns a DataFrame with strike, call price, and put price
- Includes confidence intervals</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.4: Option Price Sensitivity (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">option_price_sensitivity</span><span class="p">(</span><span class="n">S0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">strikes</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate option prices for multiple strikes using Monte Carlo.</span>

<span class="sd">    Args:</span>
<span class="sd">        S0: Current stock price</span>
<span class="sd">        T: Time to expiration</span>
<span class="sd">        r: Risk-free rate</span>
<span class="sd">        sigma: Volatility</span>
<span class="sd">        strikes: List of strike prices</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with strikes and option prices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># Simulate terminal prices once</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">n_paths</span><span class="p">)</span>
    <span class="n">ST</span> <span class="o">=</span> <span class="n">S0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">r</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">Z</span><span class="p">)</span>
    <span class="n">discount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="n">strikes</span><span class="p">:</span>
        <span class="c1"># Call payoffs</span>
        <span class="n">call_payoffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">ST</span> <span class="o">-</span> <span class="n">K</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">discount</span>
        <span class="n">call_price</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">call_payoffs</span><span class="p">)</span>
        <span class="n">call_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">call_payoffs</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_paths</span><span class="p">)</span>

        <span class="c1"># Put payoffs</span>
        <span class="n">put_payoffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">K</span> <span class="o">-</span> <span class="n">ST</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">discount</span>
        <span class="n">put_price</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">put_payoffs</span><span class="p">)</span>
        <span class="n">put_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">put_payoffs</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_paths</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Strike&#39;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span>
            <span class="s1">&#39;Call Price&#39;</span><span class="p">:</span> <span class="n">call_price</span><span class="p">,</span>
            <span class="s1">&#39;Call CI&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">call_price</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ¬± </span><span class="si">{</span><span class="mf">1.96</span><span class="o">*</span><span class="n">call_se</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Put Price&#39;</span><span class="p">:</span> <span class="n">put_price</span><span class="p">,</span>
            <span class="s1">&#39;Put CI&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">put_price</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ¬± </span><span class="si">{</span><span class="mf">1.96</span><span class="o">*</span><span class="n">put_se</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Moneyness&#39;</span><span class="p">:</span> <span class="n">K</span> <span class="o">/</span> <span class="n">S0</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">strikes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">]</span>
<span class="n">sensitivity_df</span> <span class="o">=</span> <span class="n">option_price_sensitivity</span><span class="p">(</span><span class="n">S0</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span> <span class="n">strikes</span><span class="o">=</span><span class="n">strikes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sensitivity_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 10.5: Retirement Scenario Analysis (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Takes multiple withdrawal rate scenarios
- Runs retirement simulations for each
- Returns success probability for each scenario
- Identifies the safe withdrawal rate (&gt;95% success)</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.5: Retirement Scenario Analysis (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">retirement_scenario_analysis</span><span class="p">(</span><span class="n">initial_savings</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">annual_contribution</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                <span class="n">years_to_retirement</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">years_in_retirement</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                <span class="n">withdrawal_rates</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                <span class="n">n_paths</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze multiple withdrawal rate scenarios.</span>

<span class="sd">    Args:</span>
<span class="sd">        withdrawal_rates: List of withdrawal rates as fraction of initial retirement wealth</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with scenario results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">total_years</span> <span class="o">=</span> <span class="n">years_to_retirement</span> <span class="o">+</span> <span class="n">years_in_retirement</span>

    <span class="c1"># Generate returns once</span>
    <span class="n">annual_returns</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="p">(</span><span class="n">total_years</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>

    <span class="c1"># Accumulation phase (same for all scenarios)</span>
    <span class="n">wealth_at_retirement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_paths</span><span class="p">)</span>
    <span class="n">wealth</span> <span class="o">=</span> <span class="n">initial_savings</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_paths</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">years_to_retirement</span><span class="p">):</span>
        <span class="n">wealth</span> <span class="o">=</span> <span class="n">wealth</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">annual_returns</span><span class="p">[</span><span class="n">year</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="n">annual_contribution</span>

    <span class="n">wealth_at_retirement</span> <span class="o">=</span> <span class="n">wealth</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rate</span> <span class="ow">in</span> <span class="n">withdrawal_rates</span><span class="p">:</span>
        <span class="c1"># Reset to retirement wealth</span>
        <span class="n">wealth</span> <span class="o">=</span> <span class="n">wealth_at_retirement</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Distribution phase with fixed withdrawal rate</span>
        <span class="n">annual_withdrawal</span> <span class="o">=</span> <span class="n">wealth_at_retirement</span> <span class="o">*</span> <span class="n">rate</span>

        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">years_to_retirement</span><span class="p">,</span> <span class="n">total_years</span><span class="p">):</span>
            <span class="n">wealth</span> <span class="o">=</span> <span class="n">wealth</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">annual_returns</span><span class="p">[</span><span class="n">year</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="n">annual_withdrawal</span>
            <span class="n">wealth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">wealth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">success_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wealth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">median_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">wealth</span><span class="p">[</span><span class="n">wealth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wealth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Withdrawal Rate&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rate</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Annual Withdrawal&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">annual_withdrawal</span><span class="p">)</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Success Rate&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">success_rate</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Median Final&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">median_final</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;Safe&#39;</span><span class="p">:</span> <span class="s1">&#39;‚úì&#39;</span> <span class="k">if</span> <span class="n">success_rate</span> <span class="o">&gt;=</span> <span class="mf">0.95</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">withdrawal_rates</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.035</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.045</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.055</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">]</span>
<span class="n">scenarios</span> <span class="o">=</span> <span class="n">retirement_scenario_analysis</span><span class="p">(</span>
    <span class="n">initial_savings</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
    <span class="n">annual_contribution</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
    <span class="n">years_to_retirement</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="n">years_in_retirement</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">withdrawal_rates</span><span class="o">=</span><span class="n">withdrawal_rates</span><span class="p">,</span>
    <span class="n">mu</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span>
    <span class="n">sigma</span><span class="o">=</span><span class="mf">0.15</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scenarios</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 10.6: Complete Monte Carlo Engine (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a comprehensive Monte Carlo simulation class that includes:
- Single and multi-asset GBM simulation
- Normal and fat-tailed distributions
- Portfolio simulation with custom weights
- Risk metrics calculation (VaR, ES)
- Option pricing capabilities</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.6: Complete Monte Carlo Engine (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MonteCarloEngine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive Monte Carlo simulation engine for financial analysis.</span>

<span class="sd">    Features:</span>
<span class="sd">    - Single and multi-asset price simulation</span>
<span class="sd">    - Normal and fat-tailed distributions</span>
<span class="sd">    - Portfolio simulation</span>
<span class="sd">    - Risk metrics calculation</span>
<span class="sd">    - Option pricing</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize with optional seed for reproducibility.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset random number generator.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simulate_gbm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fat_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">df</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simulate single-asset price paths.&quot;&quot;&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">n_steps</span>
        <span class="n">drift</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>

        <span class="k">if</span> <span class="n">fat_tails</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">df</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">diffusion</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">standard_t</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diffusion</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>

        <span class="n">log_returns</span> <span class="o">=</span> <span class="n">drift</span> <span class="o">+</span> <span class="n">diffusion</span> <span class="o">*</span> <span class="n">Z</span>
        <span class="n">log_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
        <span class="n">log_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0</span><span class="p">)</span>
        <span class="n">log_prices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">log_returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_prices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simulate_correlated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S0_vec</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">mu_vec</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">sigma_vec</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                           <span class="n">corr_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                           <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simulate correlated multi-asset paths.&quot;&quot;&quot;</span>
        <span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">S0_vec</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">n_steps</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">cholesky</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_assets</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
        <span class="n">corr_Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
            <span class="n">corr_Z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span> <span class="o">@</span> <span class="n">Z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

        <span class="n">paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_assets</span><span class="p">):</span>
            <span class="n">drift</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="n">diffusion</span> <span class="o">=</span> <span class="n">sigma_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">log_returns</span> <span class="o">=</span> <span class="n">drift</span> <span class="o">+</span> <span class="n">diffusion</span> <span class="o">*</span> <span class="n">corr_Z</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">log_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
            <span class="n">log_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0_vec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">log_prices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S0_vec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">log_returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_prices</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">paths</span>

    <span class="k">def</span> <span class="nf">calculate_risk_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                              <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate VaR and ES from simulated returns.&quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span>
        <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">es</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span> <span class="s1">&#39;es&#39;</span><span class="p">:</span> <span class="n">es</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">confidence</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">price_european_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                             <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span>
                             <span class="n">n_paths</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Price European option using Monte Carlo.&quot;&quot;&quot;</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">n_paths</span><span class="p">)</span>
        <span class="n">ST</span> <span class="o">=</span> <span class="n">S0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">r</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">Z</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="n">payoffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">ST</span> <span class="o">-</span> <span class="n">K</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">payoffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">K</span> <span class="o">-</span> <span class="n">ST</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">discounted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">payoffs</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">discounted</span><span class="p">)</span>
        <span class="n">std_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">discounted</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_paths</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;std_error&#39;</span><span class="p">:</span> <span class="n">std_error</span><span class="p">,</span>
                <span class="s1">&#39;ci_95&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">std_error</span><span class="p">,</span> <span class="n">price</span> <span class="o">+</span> <span class="mf">1.96</span><span class="o">*</span><span class="n">std_error</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">summary_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate summary statistics for simulation paths.&quot;&quot;&quot;</span>
        <span class="n">terminal</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">terminal</span> <span class="o">-</span> <span class="n">initial</span><span class="p">)</span> <span class="o">/</span> <span class="n">initial</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;mean_terminal&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal</span><span class="p">),</span>
            <span class="s1">&#39;median_terminal&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">terminal</span><span class="p">),</span>
            <span class="s1">&#39;mean_return&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span>
            <span class="s1">&#39;percentile_5&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">terminal</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s1">&#39;percentile_95&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">terminal</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
            <span class="s1">&#39;prob_gain&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal</span> <span class="o">&gt;</span> <span class="n">initial</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">mc</span> <span class="o">=</span> <span class="n">MonteCarloEngine</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Single asset simulation</span>
<span class="n">paths</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">simulate_gbm</span><span class="p">(</span><span class="n">S0</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">252</span><span class="p">,</span> <span class="n">n_paths</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">summary_stats</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean terminal: $</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean_terminal&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean return: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prob of gain: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;prob_gain&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="c1"># Option pricing</span>
<span class="n">mc</span><span class="o">.</span><span class="n">reset_seed</span><span class="p">()</span>
<span class="n">option</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">price_european_option</span><span class="p">(</span><span class="n">S0</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.20</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Option price: $</span><span class="si">{</span><span class="n">option</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ¬± $</span><span class="si">{</span><span class="n">option</span><span class="p">[</span><span class="s1">&#39;std_error&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Monte Carlo Simulator</h1>
<p>Put together everything you've learned!</p>
<p><strong>Your Challenge:</strong></p>
<p>Build a complete Monte Carlo simulation system that includes:
1. Multi-asset correlated price simulation with configurable distribution (normal or Student-t)
2. Portfolio value projection with custom asset weights
3. Comprehensive risk metrics (VaR, ES, probability of loss)
4. Option pricing with Greeks estimation
5. Summary report generation with visualization</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MonteCarloSimulator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete Monte Carlo simulation system for portfolio analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">simulate_portfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">corr_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">,</span>
                          <span class="n">n_paths</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
                          <span class="n">fat_tails</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate portfolio value paths.</span>

<span class="sd">        Args:</span>
<span class="sd">            assets: Dict of {name: {&#39;S0&#39;: price, &#39;mu&#39;: return, &#39;sigma&#39;: vol}}</span>
<span class="sd">            corr_matrix: Correlation matrix</span>
<span class="sd">            weights: Dict of {name: weight}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">asset_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">asset_names</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="n">n_steps</span>

        <span class="c1"># Cholesky decomposition</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">cholesky</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Generate correlated shocks</span>
        <span class="k">if</span> <span class="n">fat_tails</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">df</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">Z_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">standard_t</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_assets</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">Z_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">((</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">n_assets</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>

        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Z_raw</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
            <span class="n">Z</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span> <span class="o">@</span> <span class="n">Z_raw</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

        <span class="c1"># Simulate each asset</span>
        <span class="n">asset_paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">asset_names</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">assets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">drift</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="n">diffusion</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>

            <span class="n">log_returns</span> <span class="o">=</span> <span class="n">drift</span> <span class="o">+</span> <span class="n">diffusion</span> <span class="o">*</span> <span class="n">Z</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">log_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
            <span class="n">log_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;S0&#39;</span><span class="p">])</span>
            <span class="n">log_prices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;S0&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">log_returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">asset_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_prices</span><span class="p">)</span>

        <span class="c1"># Calculate portfolio value</span>
        <span class="n">port_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_paths</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">asset_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">:</span>
                <span class="n">normalized</span> <span class="o">=</span> <span class="n">asset_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">/</span> <span class="n">asset_paths</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">port_value</span> <span class="o">+=</span> <span class="n">weights</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">normalized</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">port_value</span> <span class="o">*=</span> <span class="n">initial_value</span>

        <span class="c1"># Store results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;asset_paths&#39;</span><span class="p">:</span> <span class="n">asset_paths</span><span class="p">,</span>
            <span class="s1">&#39;portfolio_paths&#39;</span><span class="p">:</span> <span class="n">port_value</span><span class="p">,</span>
            <span class="s1">&#39;initial_value&#39;</span><span class="p">:</span> <span class="n">initial_value</span><span class="p">,</span>
            <span class="s1">&#39;terminal_values&#39;</span><span class="p">:</span> <span class="n">port_value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>

    <span class="k">def</span> <span class="nf">calculate_risk_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate comprehensive risk metrics.&quot;&quot;&quot;</span>
        <span class="n">terminal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;terminal_values&#39;</span><span class="p">]</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;initial_value&#39;</span><span class="p">]</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">terminal</span> <span class="o">-</span> <span class="n">initial</span><span class="p">)</span> <span class="o">/</span> <span class="n">initial</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span>
        <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">es</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;mean_return&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span>
            <span class="sa">f</span><span class="s1">&#39;var_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;es_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">es</span><span class="p">,</span>
            <span class="s1">&#39;prob_loss&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;prob_10pct_loss&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">),</span>
            <span class="s1">&#39;prob_20pct_gain&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span> <span class="o">&gt;</span> <span class="mf">0.20</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate summary report with visualization.&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_risk_metrics</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MONTE CARLO SIMULATION REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Initial Investment: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;initial_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RETURN STATISTICS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expected Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;mean_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RISK METRICS (95%)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Value at Risk: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;var_95&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expected Shortfall: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;es_95&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">PROBABILITIES&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Probability of Loss: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;prob_loss&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Probability of &gt;10% Loss: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;prob_10pct_loss&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Probability of &gt;20% Gain: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;prob_20pct_gain&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="c1"># Visualization</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="c1"># Portfolio paths</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;portfolio_paths&#39;</span><span class="p">]</span>
        <span class="n">n_steps</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">time_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">paths</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">paths</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;initial_value&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (years)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Value ($)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Portfolio Value Simulation&#39;</span><span class="p">)</span>

        <span class="c1"># Terminal distribution</span>
        <span class="n">terminal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;terminal_values&#39;</span><span class="p">]</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">terminal</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;initial_value&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">terminal</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Terminal Value ($k)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Terminal Value Distribution&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Demo</span>
<span class="n">simulator</span> <span class="o">=</span> <span class="n">MonteCarloSimulator</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Define assets</span>
<span class="n">assets_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S0&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span> <span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="mf">0.18</span><span class="p">},</span>
    <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S0&#39;</span><span class="p">:</span> <span class="mi">380</span><span class="p">,</span> <span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">},</span>
    <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S0&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="mf">0.04</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">},</span>
    <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;S0&#39;</span><span class="p">:</span> <span class="mi">180</span><span class="p">,</span> <span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">}</span>
<span class="p">}</span>

<span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">],</span>
    <span class="p">[</span><span class="o">-</span><span class="mf">0.30</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">]</span>
<span class="p">])</span>

<span class="n">weights_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">}</span>

<span class="c1"># Run simulation</span>
<span class="n">simulator</span><span class="o">.</span><span class="n">simulate_portfolio</span><span class="p">(</span><span class="n">assets_config</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">weights_config</span><span class="p">,</span>
                            <span class="n">T</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_paths</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">initial_value</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="n">simulator</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Random Number Generation</h3>
<ul>
<li>Use seeds for reproducibility and audit trails</li>
<li>Modern NumPy Generator objects provide better control</li>
<li>Different distributions model different phenomena</li>
</ul>
<h3>2. Price Path Simulation</h3>
<ul>
<li>GBM is the standard model but assumes normal returns</li>
<li>Fat-tailed distributions better capture extreme events</li>
<li>Terminal price distribution is log-normal (positively skewed)</li>
</ul>
<h3>3. Correlated Simulations</h3>
<ul>
<li>Cholesky decomposition transforms independent normals to correlated</li>
<li>Correlation structure is preserved in multi-asset simulations</li>
<li>Portfolio risk depends on both individual volatilities and correlations</li>
</ul>
<h3>4. Applications</h3>
<ul>
<li>Monte Carlo can price complex options analytically intractable</li>
<li>Portfolio projections show probability distributions, not point estimates</li>
<li>Retirement planning benefits from probability-based thinking</li>
</ul></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 11: Performance Attribution</strong>, we'll explore:
- Decomposing portfolio returns into components
- Brinson attribution (allocation vs selection)
- Factor-based attribution
- Risk attribution and budgeting</p>
<hr />
<p><em>Congratulations on completing Module 10!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="11"><div class="md-cell module-header"><h1>Module 11: Performance Attribution</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 4: Simulation &amp; Analytics</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Decompose portfolio returns using Brinson attribution</li>
<li>Apply factor-based attribution using regression analysis</li>
<li>Calculate risk attribution and contribution metrics</li>
<li>Build comprehensive attribution reports</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 4-6: Portfolio Theory, Module 9: Factor Models</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-11.1">Section 11.1: Attribution Basics</a></li>
<li><a href="#section-11.2">Section 11.2: Brinson Attribution</a></li>
<li><a href="#section-11.3">Section 11.3: Factor Attribution</a></li>
<li><a href="#section-11.4">Section 11.4: Risk Attribution</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 11: Performance Attribution - Ready!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download sector ETF data for attribution analysis</span>
<span class="n">sector_etfs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;XLK&#39;</span><span class="p">:</span> <span class="s1">&#39;Technology&#39;</span><span class="p">,</span> <span class="s1">&#39;XLF&#39;</span><span class="p">:</span> <span class="s1">&#39;Financials&#39;</span><span class="p">,</span> <span class="s1">&#39;XLV&#39;</span><span class="p">:</span> <span class="s1">&#39;Healthcare&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLE&#39;</span><span class="p">:</span> <span class="s1">&#39;Energy&#39;</span><span class="p">,</span> <span class="s1">&#39;XLY&#39;</span><span class="p">:</span> <span class="s1">&#39;Consumer Disc&#39;</span><span class="p">,</span> <span class="s1">&#39;XLP&#39;</span><span class="p">:</span> <span class="s1">&#39;Consumer Staples&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLI&#39;</span><span class="p">:</span> <span class="s1">&#39;Industrials&#39;</span><span class="p">,</span> <span class="s1">&#39;XLU&#39;</span><span class="p">:</span> <span class="s1">&#39;Utilities&#39;</span><span class="p">,</span> <span class="s1">&#39;XLB&#39;</span><span class="p">:</span> <span class="s1">&#39;Materials&#39;</span>
<span class="p">}</span>

<span class="n">tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sector_etfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span><span class="si">}</span><span class="s1"> days&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sectors: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sector_etfs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-11.1'></a></p>
<h1>Section 11.1: Attribution Basics</h1>
<p>Performance attribution answers the crucial question: "Why did the portfolio perform the way it did?"</p>
<p><strong>In this section, you will learn:</strong>
- Why attribution matters for portfolio management
- Active return and tracking error
- Information ratio for skill measurement</p></div>
<div class="md-cell"><h2>11.1.1 Understanding Active Management</h2>
<p>Active return = Portfolio return - Benchmark return</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Define portfolio and benchmark weights</span>
<span class="n">benchmark_weights</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;XLK&#39;</span><span class="p">:</span> <span class="mf">0.28</span><span class="p">,</span> <span class="s1">&#39;XLF&#39;</span><span class="p">:</span> <span class="mf">0.13</span><span class="p">,</span> <span class="s1">&#39;XLV&#39;</span><span class="p">:</span> <span class="mf">0.13</span><span class="p">,</span> <span class="s1">&#39;XLE&#39;</span><span class="p">:</span> <span class="mf">0.04</span><span class="p">,</span>
    <span class="s1">&#39;XLY&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;XLP&#39;</span><span class="p">:</span> <span class="mf">0.07</span><span class="p">,</span> <span class="s1">&#39;XLI&#39;</span><span class="p">:</span> <span class="mf">0.09</span><span class="p">,</span> <span class="s1">&#39;XLU&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;XLB&#39;</span><span class="p">:</span> <span class="mf">0.03</span>
<span class="p">}</span>

<span class="n">portfolio_weights</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;XLK&#39;</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">,</span> <span class="s1">&#39;XLF&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span> <span class="s1">&#39;XLV&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;XLE&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>
    <span class="s1">&#39;XLY&#39;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span> <span class="s1">&#39;XLP&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;XLI&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;XLU&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;XLB&#39;</span><span class="p">:</span> <span class="mf">0.05</span>
<span class="p">}</span>

<span class="c1"># Calculate returns</span>
<span class="n">sector_tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sector_etfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">sector_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">sector_tickers</span><span class="p">]</span>

<span class="n">port_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">portfolio_weights</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sector_tickers</span><span class="p">])</span>
<span class="n">bench_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">benchmark_weights</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sector_tickers</span><span class="p">])</span>

<span class="n">portfolio_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_returns</span> <span class="o">*</span> <span class="n">port_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">benchmark_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>
<span class="n">active_returns</span> <span class="o">=</span> <span class="n">portfolio_returns</span> <span class="o">-</span> <span class="n">benchmark_returns</span>

<span class="c1"># Performance summary</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performance Summary (Annualized)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Return:  </span><span class="si">{</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Benchmark Return:  </span><span class="si">{</span><span class="n">benchmark_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active Return:     </span><span class="si">{</span><span class="n">active_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tracking Error:    </span><span class="si">{</span><span class="n">active_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Information Ratio: </span><span class="si">{</span><span class="p">(</span><span class="n">active_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">active_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 11.1: Active Return Analysis (Guided)</h3>
<p><strong>Your Task:</strong> Calculate comprehensive active return statistics including hit rate and win/loss ratio.</p>
<p>Fill in the blanks to complete the analysis:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.1: Active Return Analysis (Guided)</span>
<span class="k">def</span> <span class="nf">analyze_active_returns</span><span class="p">(</span><span class="n">portfolio_ret</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_ret</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze active return characteristics.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        portfolio_ret: Portfolio return series</span>
<span class="sd">        benchmark_ret: Benchmark return series</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with active return metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">portfolio_ret</span> <span class="o">-</span> <span class="n">benchmark_ret</span>
    
    <span class="c1"># TODO: Calculate the mean of active returns</span>
    <span class="n">mean_active</span> <span class="o">=</span> <span class="n">active</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># TODO: Calculate hit rate (proportion of positive active returns)</span>
    <span class="n">hit_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">active</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># TODO: Calculate average win and average loss</span>
    <span class="n">avg_win</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">active</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">active</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># TODO: Calculate win/loss ratio (absolute value of avg_win / avg_loss)</span>
    <span class="n">win_loss_ratio</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">avg_win</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">avg_loss</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean_active&#39;</span><span class="p">:</span> <span class="n">mean_active</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
        <span class="s1">&#39;tracking_error&#39;</span><span class="p">:</span> <span class="n">active</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span>
        <span class="s1">&#39;information_ratio&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">mean_active</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">active</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
        <span class="s1">&#39;hit_rate&#39;</span><span class="p">:</span> <span class="n">hit_rate</span><span class="p">,</span>
        <span class="s1">&#39;win_loss_ratio&#39;</span><span class="p">:</span> <span class="n">win_loss_ratio</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># metrics = analyze_active_returns(portfolio_returns, benchmark_returns)</span>
<span class="c1"># print(f&quot;Hit Rate: {metrics[&#39;hit_rate&#39;]*100:.1f}%&quot;)</span>
<span class="c1"># print(f&quot;Win/Loss Ratio: {metrics[&#39;win_loss_ratio&#39;]:.2f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_active_returns</span><span class="p">(</span><span class="n">portfolio_ret</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_ret</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze active return characteristics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">portfolio_ret</span> <span class="o">-</span> <span class="n">benchmark_ret</span>

    <span class="c1"># Calculate the mean of active returns</span>
    <span class="n">mean_active</span> <span class="o">=</span> <span class="n">active</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Calculate hit rate (proportion of positive active returns)</span>
    <span class="n">hit_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">active</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Calculate average win and average loss</span>
    <span class="n">avg_win</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">active</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">active</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Calculate win/loss ratio</span>
    <span class="n">win_loss_ratio</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">avg_win</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">avg_loss</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;mean_active&#39;</span><span class="p">:</span> <span class="n">mean_active</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
        <span class="s1">&#39;tracking_error&#39;</span><span class="p">:</span> <span class="n">active</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span>
        <span class="s1">&#39;information_ratio&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">mean_active</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">active</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
        <span class="s1">&#39;hit_rate&#39;</span><span class="p">:</span> <span class="n">hit_rate</span><span class="p">,</span>
        <span class="s1">&#39;win_loss_ratio&#39;</span><span class="p">:</span> <span class="n">win_loss_ratio</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">analyze_active_returns</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hit Rate: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;hit_rate&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win/Loss Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;win_loss_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Information Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;information_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-11.2'></a></p>
<h1>Section 11.2: Brinson Attribution</h1>
<p>The Brinson model decomposes active return into allocation, selection, and interaction effects.</p>
<p><strong>In this section, you will learn:</strong>
- Allocation effect: Value from sector weighting decisions
- Selection effect: Value from security selection within sectors
- Interaction effect: Combined impact</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">brinson_attribution</span><span class="p">(</span><span class="n">portfolio_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">benchmark_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                        <span class="n">portfolio_returns</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">benchmark_sector_returns</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                        <span class="n">benchmark_total_return</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Brinson attribution for a single period.</span>
<span class="sd">    </span>
<span class="sd">    Allocation Effect: (wp - wb) * (rb - rb_total)</span>
<span class="sd">    Selection Effect: wb * (rp - rb)</span>
<span class="sd">    Interaction Effect: (wp - wb) * (rp - rb)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">portfolio_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">wp</span> <span class="o">=</span> <span class="n">portfolio_weights</span><span class="p">[</span><span class="n">sector</span><span class="p">]</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="n">benchmark_weights</span><span class="p">[</span><span class="n">sector</span><span class="p">]</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="p">[</span><span class="n">sector</span><span class="p">]</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="n">benchmark_sector_returns</span><span class="p">[</span><span class="n">sector</span><span class="p">]</span>
        <span class="n">rb_total</span> <span class="o">=</span> <span class="n">benchmark_total_return</span>
        
        <span class="n">allocation</span> <span class="o">=</span> <span class="p">(</span><span class="n">wp</span> <span class="o">-</span> <span class="n">wb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rb</span> <span class="o">-</span> <span class="n">rb_total</span><span class="p">)</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">wb</span> <span class="o">*</span> <span class="p">(</span><span class="n">rp</span> <span class="o">-</span> <span class="n">rb</span><span class="p">)</span>
        <span class="n">interaction</span> <span class="o">=</span> <span class="p">(</span><span class="n">wp</span> <span class="o">-</span> <span class="n">wb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rp</span> <span class="o">-</span> <span class="n">rb</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">allocation</span> <span class="o">+</span> <span class="n">selection</span> <span class="o">+</span> <span class="n">interaction</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Sector&#39;</span><span class="p">:</span> <span class="n">sector</span><span class="p">,</span>
            <span class="s1">&#39;Active Weight&#39;</span><span class="p">:</span> <span class="n">wp</span> <span class="o">-</span> <span class="n">wb</span><span class="p">,</span>
            <span class="s1">&#39;Allocation&#39;</span><span class="p">:</span> <span class="n">allocation</span><span class="p">,</span>
            <span class="s1">&#39;Selection&#39;</span><span class="p">:</span> <span class="n">selection</span><span class="p">,</span>
            <span class="s1">&#39;Interaction&#39;</span><span class="p">:</span> <span class="n">interaction</span><span class="p">,</span>
            <span class="s1">&#39;Total&#39;</span><span class="p">:</span> <span class="n">total</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># Calculate cumulative returns for the period</span>
<span class="n">cum_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">sector_returns</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">benchmark_cum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">benchmark_returns</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c1"># Add simulated selection alpha</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">selection_alpha</span> <span class="o">=</span> <span class="p">{</span><span class="n">ticker</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">)</span> <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">sector_tickers</span><span class="p">}</span>

<span class="n">portfolio_sector_returns</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">cum_returns</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="n">selection_alpha</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sector_tickers</span><span class="p">}</span>
<span class="n">benchmark_sector_returns</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">cum_returns</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sector_tickers</span><span class="p">}</span>

<span class="c1"># Run attribution</span>
<span class="n">attribution_df</span> <span class="o">=</span> <span class="n">brinson_attribution</span><span class="p">(</span>
    <span class="n">portfolio_weights</span><span class="p">,</span> <span class="n">benchmark_weights</span><span class="p">,</span>
    <span class="n">portfolio_sector_returns</span><span class="p">,</span> <span class="n">benchmark_sector_returns</span><span class="p">,</span>
    <span class="nb">float</span><span class="p">(</span><span class="n">benchmark_cum</span><span class="p">)</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Brinson Attribution Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Allocation:  </span><span class="si">{</span><span class="n">attribution_df</span><span class="p">[</span><span class="s1">&#39;Allocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Selection:   </span><span class="si">{</span><span class="n">attribution_df</span><span class="p">[</span><span class="s1">&#39;Selection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Interaction: </span><span class="si">{</span><span class="n">attribution_df</span><span class="p">[</span><span class="s1">&#39;Interaction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Active:      </span><span class="si">{</span><span class="n">attribution_df</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 11.2: Monthly Brinson Attribution (Guided)</h3>
<p><strong>Your Task:</strong> Calculate Brinson attribution on a monthly basis to track attribution over time.</p>
<p>Fill in the blanks to complete the time-series attribution:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.2: Monthly Brinson Attribution (Guided)</span>
<span class="k">def</span> <span class="nf">monthly_brinson</span><span class="p">(</span><span class="n">sector_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                    <span class="n">portfolio_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">benchmark_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate monthly Brinson attribution.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with monthly attribution effects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Resample to monthly returns using compound formula</span>
    <span class="n">monthly_sector</span> <span class="o">=</span> <span class="n">sector_returns</span><span class="o">.</span><span class="n">____</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">monthly_bench</span> <span class="o">=</span> <span class="n">benchmark_returns</span><span class="o">.</span><span class="n">____</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">monthly_sector</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">sector_ret</span> <span class="o">=</span> <span class="n">monthly_sector</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">bench_ret</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">monthly_bench</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">])</span>
        
        <span class="c1"># Simulate selection alpha</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="n">port_ret</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">sector_ret</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sector_ret</span><span class="p">}</span>
        
        <span class="c1"># TODO: Calculate allocation effect for each sector and sum</span>
        <span class="n">allocation</span> <span class="o">=</span> <span class="n">____</span><span class="p">([(</span>
            <span class="n">portfolio_weights</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">benchmark_weights</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sector_ret</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">bench_ret</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">portfolio_weights</span><span class="p">])</span>
        
        <span class="c1"># TODO: Calculate selection effect</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">____</span><span class="p">([</span><span class="n">benchmark_weights</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">port_ret</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sector_ret</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> 
                         <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">portfolio_weights</span><span class="p">])</span>
        
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;Allocation&#39;</span><span class="p">:</span> <span class="n">allocation</span><span class="p">,</span>
            <span class="s1">&#39;Selection&#39;</span><span class="p">:</span> <span class="n">selection</span><span class="p">,</span>
            <span class="s1">&#39;Total&#39;</span><span class="p">:</span> <span class="n">allocation</span> <span class="o">+</span> <span class="n">selection</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>

<span class="c1"># Test your solution</span>
<span class="c1"># monthly_attr = monthly_brinson(sector_returns, benchmark_returns, portfolio_weights, benchmark_weights)</span>
<span class="c1"># print(f&quot;Mean Monthly Allocation: {monthly_attr[&#39;Allocation&#39;].mean()*100:.3f}%&quot;)</span>
<span class="c1"># print(f&quot;Mean Monthly Selection: {monthly_attr[&#39;Selection&#39;].mean()*100:.3f}%&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">monthly_brinson</span><span class="p">(</span><span class="n">sector_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                    <span class="n">portfolio_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">benchmark_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate monthly Brinson attribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Resample to monthly returns using compound formula</span>
    <span class="n">monthly_sector</span> <span class="o">=</span> <span class="n">sector_returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">monthly_bench</span> <span class="o">=</span> <span class="n">benchmark_returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">monthly_sector</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">sector_ret</span> <span class="o">=</span> <span class="n">monthly_sector</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">bench_ret</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">monthly_bench</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">])</span>

        <span class="c1"># Simulate selection alpha</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="n">port_ret</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">sector_ret</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sector_ret</span><span class="p">}</span>

        <span class="c1"># Calculate allocation effect</span>
        <span class="n">allocation</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
            <span class="p">(</span><span class="n">portfolio_weights</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">benchmark_weights</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">sector_ret</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">bench_ret</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">portfolio_weights</span>
        <span class="p">])</span>

        <span class="c1"># Calculate selection effect</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
            <span class="n">benchmark_weights</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">port_ret</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="n">sector_ret</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> 
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">portfolio_weights</span>
        <span class="p">])</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;Allocation&#39;</span><span class="p">:</span> <span class="n">allocation</span><span class="p">,</span>
            <span class="s1">&#39;Selection&#39;</span><span class="p">:</span> <span class="n">selection</span><span class="p">,</span>
            <span class="s1">&#39;Total&#39;</span><span class="p">:</span> <span class="n">allocation</span> <span class="o">+</span> <span class="n">selection</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">monthly_attr</span> <span class="o">=</span> <span class="n">monthly_brinson</span><span class="p">(</span><span class="n">sector_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">,</span> <span class="n">portfolio_weights</span><span class="p">,</span> <span class="n">benchmark_weights</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Monthly Allocation: </span><span class="si">{</span><span class="n">monthly_attr</span><span class="p">[</span><span class="s1">&#39;Allocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Monthly Selection: </span><span class="si">{</span><span class="n">monthly_attr</span><span class="p">[</span><span class="s1">&#39;Selection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Allocation Hit Rate: </span><span class="si">{</span><span class="p">(</span><span class="n">monthly_attr</span><span class="p">[</span><span class="s1">&#39;Allocation&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-11.3'></a></p>
<h1>Section 11.3: Factor Attribution</h1>
<p>Factor attribution uses regression to decompose returns by systematic factor exposures.</p>
<p><strong>In this section, you will learn:</strong>
- Regression-based factor attribution
- Alpha and beta decomposition
- Factor contribution analysis</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Create factor proxies</span>
<span class="n">factor_tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IWM&#39;</span><span class="p">,</span> <span class="s1">&#39;IWF&#39;</span><span class="p">,</span> <span class="s1">&#39;IWD&#39;</span><span class="p">]</span>  <span class="c1"># Small cap, Growth, Value</span>
<span class="n">factor_data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">factor_tickers</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">factor_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="n">factor_prices</span> <span class="o">=</span> <span class="n">factor_data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">factor_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">factor_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">factor_prices</span> <span class="o">=</span> <span class="n">factor_data</span>

<span class="n">factor_returns</span> <span class="o">=</span> <span class="n">factor_prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Create factor returns (excess over market)</span>
<span class="n">factors_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Market&#39;</span><span class="p">:</span> <span class="n">factor_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span>
    <span class="s1">&#39;SmallCap&#39;</span><span class="p">:</span> <span class="n">factor_returns</span><span class="p">[</span><span class="s1">&#39;IWM&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">factor_returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span>
    <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">factor_returns</span><span class="p">[</span><span class="s1">&#39;IWD&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">factor_returns</span><span class="p">[</span><span class="s1">&#39;IWF&#39;</span><span class="p">]</span>
<span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Factor Statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">factors_df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">factor_attribution</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform factor attribution using OLS regression.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with alpha, betas, and factor contributions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Align data</span>
    <span class="n">common_idx</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
    
    <span class="c1"># Add constant for alpha</span>
    <span class="n">X_const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
    
    <span class="c1"># OLS regression</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X_const</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">betas</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    
    <span class="c1"># Factor contributions</span>
    <span class="n">factor_contrib</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">betas</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">betas</span><span class="p">}</span>
    
    <span class="c1"># R-squared</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">X_const</span> <span class="o">@</span> <span class="n">coeffs</span>
    <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">r_squared</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ss_res</span> <span class="o">/</span> <span class="n">ss_tot</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
        <span class="s1">&#39;betas&#39;</span><span class="p">:</span> <span class="n">betas</span><span class="p">,</span>
        <span class="s1">&#39;factor_contributions&#39;</span><span class="p">:</span> <span class="n">factor_contrib</span><span class="p">,</span>
        <span class="s1">&#39;r_squared&#39;</span><span class="p">:</span> <span class="n">r_squared</span><span class="p">,</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
    <span class="p">}</span>

<span class="c1"># Run factor attribution</span>
<span class="n">common_dates</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">factors_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">port_aligned</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_dates</span><span class="p">]</span>

<span class="n">factor_attr</span> <span class="o">=</span> <span class="n">factor_attribution</span><span class="p">(</span><span class="n">port_aligned</span><span class="p">,</span> <span class="n">factors_df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Factor Attribution Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alpha (annualized): </span><span class="si">{</span><span class="n">factor_attr</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R-squared: </span><span class="si">{</span><span class="n">factor_attr</span><span class="p">[</span><span class="s1">&#39;r_squared&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Factor Betas:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">factor_attr</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">factor</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">beta</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Factor Contributions (annualized):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">contrib</span> <span class="ow">in</span> <span class="n">factor_attr</span><span class="p">[</span><span class="s1">&#39;factor_contributions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">factor</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">contrib</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 11.3: Rolling Factor Attribution (Guided)</h3>
<p><strong>Your Task:</strong> Calculate rolling factor exposures to track style drift over time.</p>
<p>Fill in the blanks to complete the rolling analysis:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.3: Rolling Factor Attribution (Guided)</span>
<span class="k">def</span> <span class="nf">rolling_factor_betas</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                         <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate rolling factor betas.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        window: Rolling window in days</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with rolling betas for each factor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">common_idx</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># TODO: Loop through dates starting from window-1 index</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">______</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="c1"># TODO: Get window of data</span>
        <span class="n">y_window</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">______</span><span class="p">]</span>
        <span class="n">X_window</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">______</span><span class="p">]</span>
        
        <span class="c1"># Add constant and run regression</span>
        <span class="n">X_const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_window</span><span class="p">)),</span> <span class="n">X_window</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X_const</span><span class="p">,</span> <span class="n">y_window</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">row</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>

<span class="c1"># Test your solution</span>
<span class="c1"># rolling_betas = rolling_factor_betas(port_aligned, factors_df, window=60)</span>
<span class="c1"># print(f&quot;Average Market Beta: {rolling_betas[&#39;Market&#39;].mean():.2f}&quot;)</span>
<span class="c1"># print(f&quot;Market Beta Range: {rolling_betas[&#39;Market&#39;].min():.2f} to {rolling_betas[&#39;Market&#39;].max():.2f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">rolling_factor_betas</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                         <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate rolling factor betas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">common_idx</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop through dates starting from window-1 index</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="c1"># Get window of data</span>
        <span class="n">y_window</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">X_window</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Add constant and run regression</span>
        <span class="n">X_const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_window</span><span class="p">)),</span> <span class="n">X_window</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X_const</span><span class="p">,</span> <span class="n">y_window</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">row</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">rolling_betas</span> <span class="o">=</span> <span class="n">rolling_factor_betas</span><span class="p">(</span><span class="n">port_aligned</span><span class="p">,</span> <span class="n">factors_df</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average Market Beta: </span><span class="si">{</span><span class="n">rolling_betas</span><span class="p">[</span><span class="s1">&#39;Market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Market Beta Range: </span><span class="si">{</span><span class="n">rolling_betas</span><span class="p">[</span><span class="s1">&#39;Market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">rolling_betas</span><span class="p">[</span><span class="s1">&#39;Market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average Alpha: </span><span class="si">{</span><span class="n">rolling_betas</span><span class="p">[</span><span class="s1">&#39;Alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-11.4'></a></p>
<h1>Section 11.4: Risk Attribution</h1>
<p>Risk attribution decomposes portfolio risk into contributions from each position.</p>
<p><strong>In this section, you will learn:</strong>
- Marginal and component contribution to risk
- Risk budgeting analysis
- Diversification measurement</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">risk_attribution</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate risk attribution metrics.</span>
<span class="sd">    </span>
<span class="sd">    MCR = (Sigma @ w) / sigma_p</span>
<span class="sd">    CCR = w * MCR</span>
<span class="sd">    PCR = CCR / sigma_p</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">port_var</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">@</span> <span class="n">cov_matrix</span> <span class="o">@</span> <span class="n">weights</span>
    <span class="n">port_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">port_var</span><span class="p">)</span>
    
    <span class="c1"># Marginal contribution</span>
    <span class="n">mcr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_matrix</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">port_vol</span>
    
    <span class="c1"># Component contribution</span>
    <span class="n">ccr</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">mcr</span>
    
    <span class="c1"># Percentage contribution</span>
    <span class="n">pcr</span> <span class="o">=</span> <span class="n">ccr</span> <span class="o">/</span> <span class="n">port_vol</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;portfolio_vol&#39;</span><span class="p">:</span> <span class="n">port_vol</span><span class="p">,</span>
        <span class="s1">&#39;marginal_risk&#39;</span><span class="p">:</span> <span class="n">mcr</span><span class="p">,</span>
        <span class="s1">&#39;component_risk&#39;</span><span class="p">:</span> <span class="n">ccr</span><span class="p">,</span>
        <span class="s1">&#39;percent_risk&#39;</span><span class="p">:</span> <span class="n">pcr</span>
    <span class="p">}</span>

<span class="c1"># Calculate risk attribution</span>
<span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">sector_returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">weights_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">portfolio_weights</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sector_tickers</span><span class="p">])</span>

<span class="n">risk_attr</span> <span class="o">=</span> <span class="n">risk_attribution</span><span class="p">(</span><span class="n">weights_array</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Volatility: </span><span class="si">{</span><span class="n">risk_attr</span><span class="p">[</span><span class="s1">&#39;portfolio_vol&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Risk Contribution by Sector:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sector_tickers</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">sector_etfs</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span><span class="si">:</span><span class="s2">18</span><span class="si">}</span><span class="s2">: Weight </span><span class="si">{</span><span class="n">weights_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">5.1f</span><span class="si">}</span><span class="s2">% -&gt; Risk </span><span class="si">{</span><span class="n">risk_attr</span><span class="p">[</span><span class="s1">&#39;percent_risk&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">5.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 11.4: Complete Attribution System (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Combines Brinson and factor attribution
- Includes risk contribution analysis
- Returns a comprehensive attribution report</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.4: Complete Attribution System (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">comprehensive_attribution</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                             <span class="n">sector_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                             <span class="n">portfolio_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">benchmark_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive attribution combining multiple methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Active return analysis</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">portfolio_returns</span> <span class="o">-</span> <span class="n">benchmark_returns</span>
    <span class="n">active_metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;active_return&#39;</span><span class="p">:</span> <span class="n">active</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
        <span class="s1">&#39;tracking_error&#39;</span><span class="p">:</span> <span class="n">active</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span>
        <span class="s1">&#39;information_ratio&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">active</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">active</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1"># Factor attribution</span>
    <span class="n">common_idx</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
    <span class="n">X_const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X_const</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">factor_metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
        <span class="s1">&#39;betas&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="p">}</span>

    <span class="c1"># Risk attribution</span>
    <span class="n">sector_tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">portfolio_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">sector_returns</span><span class="p">[</span><span class="n">sector_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">portfolio_weights</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sector_tickers</span><span class="p">])</span>
    <span class="n">port_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span> <span class="o">@</span> <span class="n">cov_matrix</span><span class="o">.</span><span class="n">values</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span>
    <span class="n">mcr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_matrix</span><span class="o">.</span><span class="n">values</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">port_vol</span>
    <span class="n">pcr</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">mcr</span><span class="p">)</span> <span class="o">/</span> <span class="n">port_vol</span>

    <span class="n">risk_metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;portfolio_vol&#39;</span><span class="p">:</span> <span class="n">port_vol</span><span class="p">,</span>
        <span class="s1">&#39;risk_contributions&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sector_tickers</span><span class="p">,</span> <span class="n">pcr</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;active_metrics&#39;</span><span class="p">:</span> <span class="n">active_metrics</span><span class="p">,</span>
        <span class="s1">&#39;factor_metrics&#39;</span><span class="p">:</span> <span class="n">factor_metrics</span><span class="p">,</span>
        <span class="s1">&#39;risk_metrics&#39;</span><span class="p">:</span> <span class="n">risk_metrics</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">comprehensive_attribution</span><span class="p">(</span>
    <span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">,</span> <span class="n">sector_returns</span><span class="p">,</span> <span class="n">factors_df</span><span class="p">,</span>
    <span class="n">portfolio_weights</span><span class="p">,</span> <span class="n">benchmark_weights</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;COMPREHENSIVE ATTRIBUTION REPORT&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ACTIVE RETURN ANALYSIS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Active Return: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;active_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;active_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Tracking Error: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;active_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;tracking_error&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Information Ratio: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;active_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;information_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FACTOR ATTRIBUTION&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Alpha: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;factor_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;factor_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> Beta: </span><span class="si">{</span><span class="n">b</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RISK ATTRIBUTION&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Portfolio Vol: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;risk_metrics&#39;</span><span class="p">][</span><span class="s1">&#39;portfolio_vol&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 11.5: Attribution Visualization (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that creates professional attribution visualizations:
- Waterfall chart for Brinson effects
- Bar chart comparing weight vs risk contribution
- Time series of rolling attribution</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.5: Attribution Visualization (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_attribution_dashboard</span><span class="p">(</span><span class="n">attribution_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                              <span class="n">risk_attr</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">sector_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create comprehensive attribution visualizations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># 1. Brinson waterfall</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Allocation&#39;</span><span class="p">,</span> <span class="s1">&#39;Selection&#39;</span><span class="p">,</span> <span class="s1">&#39;Interaction&#39;</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">attribution_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Contribution (%)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Brinson Attribution Components&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

    <span class="c1"># 2. Weight vs Risk by sector</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">sectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">sector_names</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">attribution_df</span><span class="p">[</span><span class="s1">&#39;Sector&#39;</span><span class="p">]]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sectors</span><span class="p">))</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">attribution_df</span><span class="p">[</span><span class="s1">&#39;Active Weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mf">0.1</span>  <span class="c1"># Approximate total weight</span>
    <span class="n">risk_pcts</span> <span class="o">=</span> <span class="n">risk_attr</span><span class="p">[</span><span class="s1">&#39;percent_risk&#39;</span><span class="p">]</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">weights</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Weight&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">risk_pcts</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Risk Contribution&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">sectors</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Percentage (%)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Weight vs Risk Contribution&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># 3. Attribution by sector</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">total_by_sector</span> <span class="o">=</span> <span class="n">attribution_df</span><span class="p">[</span><span class="s1">&#39;Total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">total_by_sector</span><span class="p">]</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">sectors</span><span class="p">,</span> <span class="n">total_by_sector</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Total Attribution (%)&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Attribution by Sector&#39;</span><span class="p">)</span>

    <span class="c1"># 4. Risk contribution pie</span>
    <span class="n">ax4</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">risk_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sectors</span><span class="p">,</span> <span class="n">risk_pcts</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">risk_sorted</span><span class="p">[:</span><span class="mi">5</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Other&#39;</span><span class="p">]</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">risk_sorted</span><span class="p">[:</span><span class="mi">5</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">r</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">risk_sorted</span><span class="p">[</span><span class="mi">5</span><span class="p">:])]</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Risk Contribution Distribution&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Test</span>
<span class="n">plot_attribution_dashboard</span><span class="p">(</span><span class="n">attribution_df</span><span class="p">,</span> <span class="n">risk_attr</span><span class="p">,</span> <span class="n">sector_etfs</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 11.6: Attribution Report Generator (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a class that generates a complete attribution report including:
- Executive summary with key metrics
- Detailed Brinson attribution by sector
- Factor exposure analysis
- Risk decomposition
- Time series analysis</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.6: Attribution Report Generator (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AttributionReportGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive attribution report generator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">portfolio_returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_returns</span> <span class="o">=</span> <span class="n">benchmark_returns</span>
        <span class="n">common_idx</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">benchmark_returns</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">benchmark_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">calculate_basic_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate basic performance statistics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;portfolio_return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
            <span class="s1">&#39;benchmark_return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
            <span class="s1">&#39;active_return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
            <span class="s1">&#39;tracking_error&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span>
            <span class="s1">&#39;information_ratio&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> 
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
            <span class="s1">&#39;hit_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">factor_attribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Factor-based attribution.&quot;&quot;&quot;</span>
        <span class="n">common_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
        <span class="n">X_const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X_const</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">X_const</span> <span class="o">@</span> <span class="n">coeffs</span>
        <span class="n">r_squared</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
            <span class="s1">&#39;betas&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])),</span>
            <span class="s1">&#39;r_squared&#39;</span><span class="p">:</span> <span class="n">r_squared</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate formatted attribution report.&quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_basic_stats</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PERFORMANCE ATTRIBUTION REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- PERFORMANCE SUMMARY ---&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Return:  </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;portfolio_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Benchmark Return:  </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active Return:     </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;active_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- RISK METRICS ---&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tracking Error:    </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;tracking_error&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Information Ratio: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;information_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hit Rate:          </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;hit_rate&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">factors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">factor_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_attribution</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- FACTOR ATTRIBUTION ---&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alpha:             </span><span class="si">{</span><span class="n">factor_stats</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R-squared:         </span><span class="si">{</span><span class="n">factor_stats</span><span class="p">[</span><span class="s1">&#39;r_squared&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Factor Betas:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">factor_stats</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">factor</span><span class="si">:</span><span class="s2">15</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">beta</span><span class="si">:</span><span class="s2">&gt;8.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">report_gen</span> <span class="o">=</span> <span class="n">AttributionReportGenerator</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">)</span>
<span class="n">report_gen</span><span class="o">.</span><span class="n">generate_report</span><span class="p">(</span><span class="n">factors_df</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Attribution System</h1>
<p>Put together everything you've learned!</p>
<p><strong>Your Challenge:</strong></p>
<p>Build a complete performance attribution system that includes:
1. Brinson attribution (allocation, selection, interaction)
2. Factor attribution with rolling exposures
3. Risk attribution and contribution analysis
4. Time series attribution tracking
5. Professional report generation</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PerformanceAttributionSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete performance attribution system.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">common_idx</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">benchmark_returns</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_returns</span> <span class="o">=</span> <span class="n">benchmark_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_returns</span>

    <span class="k">def</span> <span class="nf">basic_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate basic performance metrics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;portfolio_return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
            <span class="s1">&#39;benchmark_return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
            <span class="s1">&#39;active_return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
            <span class="s1">&#39;tracking_error&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span>
            <span class="s1">&#39;information_ratio&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> 
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
            <span class="s1">&#39;sharpe_portfolio&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
            <span class="s1">&#39;hit_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">brinson_attribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">benchmark_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                           <span class="n">sector_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Single-period Brinson attribution.&quot;&quot;&quot;</span>
        <span class="n">cum_sector</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">sector_returns</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">cum_bench</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_returns</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">portfolio_weights</span><span class="p">:</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="n">portfolio_weights</span><span class="p">[</span><span class="n">sector</span><span class="p">]</span>
            <span class="n">wb</span> <span class="o">=</span> <span class="n">benchmark_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">rb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cum_sector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="n">rb</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>  <span class="c1"># Simulated selection</span>

            <span class="n">allocation</span> <span class="o">=</span> <span class="p">(</span><span class="n">wp</span> <span class="o">-</span> <span class="n">wb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rb</span> <span class="o">-</span> <span class="n">cum_bench</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">wb</span> <span class="o">*</span> <span class="p">(</span><span class="n">rp</span> <span class="o">-</span> <span class="n">rb</span><span class="p">)</span>
            <span class="n">interaction</span> <span class="o">=</span> <span class="p">(</span><span class="n">wp</span> <span class="o">-</span> <span class="n">wb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rp</span> <span class="o">-</span> <span class="n">rb</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Sector&#39;</span><span class="p">:</span> <span class="n">sector</span><span class="p">,</span>
                <span class="s1">&#39;Allocation&#39;</span><span class="p">:</span> <span class="n">allocation</span><span class="p">,</span>
                <span class="s1">&#39;Selection&#39;</span><span class="p">:</span> <span class="n">selection</span><span class="p">,</span>
                <span class="s1">&#39;Interaction&#39;</span><span class="p">:</span> <span class="n">interaction</span><span class="p">,</span>
                <span class="s1">&#39;Total&#39;</span><span class="p">:</span> <span class="n">allocation</span> <span class="o">+</span> <span class="n">selection</span> <span class="o">+</span> <span class="n">interaction</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">factor_attribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Factor-based attribution.&quot;&quot;&quot;</span>
        <span class="n">common_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">factors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
        <span class="n">X_const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X_const</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">X_const</span> <span class="o">@</span> <span class="n">coeffs</span>
        <span class="n">r_squared</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
            <span class="s1">&#39;betas&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])),</span>
            <span class="s1">&#39;factor_contrib&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> 
                              <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)},</span>
            <span class="s1">&#39;r_squared&#39;</span><span class="p">:</span> <span class="n">r_squared</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">risk_attribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Risk contribution analysis.&quot;&quot;&quot;</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">])</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">cov_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">assets</span><span class="p">,</span> <span class="n">assets</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">port_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w</span> <span class="o">@</span> <span class="n">cov</span> <span class="o">@</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">mcr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov</span> <span class="o">@</span> <span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="n">port_vol</span>
        <span class="n">ccr</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">mcr</span>
        <span class="n">pcr</span> <span class="o">=</span> <span class="n">ccr</span> <span class="o">/</span> <span class="n">port_vol</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;portfolio_vol&#39;</span><span class="p">:</span> <span class="n">port_vol</span><span class="p">,</span>
            <span class="s1">&#39;risk_contributions&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">assets</span><span class="p">,</span> <span class="n">pcr</span><span class="p">))</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_weights</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                       <span class="n">benchmark_weights</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">sector_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">factors</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive attribution report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PERFORMANCE ATTRIBUTION REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>

        <span class="c1"># Basic metrics</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_metrics</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- PERFORMANCE SUMMARY ---&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Return:  </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;portfolio_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Benchmark Return:  </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active Return:     </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;active_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tracking Error:    </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;tracking_error&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Information Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;information_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hit Rate:          </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;hit_rate&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="c1"># Brinson attribution</span>
        <span class="k">if</span> <span class="n">portfolio_weights</span> <span class="ow">and</span> <span class="n">benchmark_weights</span> <span class="ow">and</span> <span class="n">sector_returns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">brinson</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">brinson_attribution</span><span class="p">(</span><span class="n">portfolio_weights</span><span class="p">,</span> <span class="n">benchmark_weights</span><span class="p">,</span> <span class="n">sector_returns</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- BRINSON ATTRIBUTION ---&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Allocation Effect:  </span><span class="si">{</span><span class="n">brinson</span><span class="p">[</span><span class="s1">&#39;Allocation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selection Effect:   </span><span class="si">{</span><span class="n">brinson</span><span class="p">[</span><span class="s1">&#39;Selection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interaction Effect: </span><span class="si">{</span><span class="n">brinson</span><span class="p">[</span><span class="s1">&#39;Interaction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="c1"># Factor attribution</span>
        <span class="k">if</span> <span class="n">factors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">factor_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_attribution</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- FACTOR ATTRIBUTION ---&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alpha:             </span><span class="si">{</span><span class="n">factor_attr</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R-squared:         </span><span class="si">{</span><span class="n">factor_attr</span><span class="p">[</span><span class="s1">&#39;r_squared&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Factor Exposures:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">factor_attr</span><span class="p">[</span><span class="s1">&#39;betas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">f</span><span class="si">:</span><span class="s2">15</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">b</span><span class="si">:</span><span class="s2">&gt;10.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>

<span class="c1"># Demo</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">PerformanceAttributionSystem</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">generate_report</span><span class="p">(</span>
    <span class="n">portfolio_weights</span><span class="o">=</span><span class="n">portfolio_weights</span><span class="p">,</span>
    <span class="n">benchmark_weights</span><span class="o">=</span><span class="n">benchmark_weights</span><span class="p">,</span>
    <span class="n">sector_returns</span><span class="o">=</span><span class="n">sector_returns</span><span class="p">,</span>
    <span class="n">factors</span><span class="o">=</span><span class="n">factors_df</span>
<span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Attribution Basics</h3>
<ul>
<li>Active return = portfolio return - benchmark return</li>
<li>Information Ratio measures risk-adjusted active return</li>
<li>Hit rate and win/loss ratio indicate consistency</li>
</ul>
<h3>2. Brinson Attribution</h3>
<ul>
<li>Allocation effect: Value from sector weighting</li>
<li>Selection effect: Value from security selection</li>
<li>Interaction effect: Combined allocation and selection</li>
</ul>
<h3>3. Factor Attribution</h3>
<ul>
<li>Regression decomposes returns by factor exposure</li>
<li>Alpha is factor-adjusted excess return</li>
<li>R-squared shows explanatory power of factors</li>
</ul>
<h3>4. Risk Attribution</h3>
<ul>
<li>Marginal contribution measures sensitivity to weight changes</li>
<li>Component contributions sum to total volatility</li>
<li>Identifies concentration risk</li>
</ul></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 12: Building Dashboards</strong>, we'll explore:
- Dashboard design principles
- Plotly and Dash fundamentals
- Interactive financial visualizations
- Real-time updates with callbacks</p>
<hr />
<p><em>Congratulations on completing Module 11!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="12"><div class="md-cell module-header"><h1>Module 12: Building Dashboards</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 4: Simulation &amp; Analytics</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Design effective financial dashboards following best practices</li>
<li>Create interactive visualizations using Plotly</li>
<li>Build multi-component dashboard layouts</li>
<li>Understand Dash callback architecture for interactivity</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 4-8: Portfolio Theory &amp; Risk</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-12.1">Section 12.1: Dashboard Design Principles</a></li>
<li><a href="#section-12.2">Section 12.2: Plotly Fundamentals</a></li>
<li><a href="#section-12.3">Section 12.3: Financial Charts</a></li>
<li><a href="#section-12.4">Section 12.4: Dash Architecture</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">from</span> <span class="nn">plotly.subplots</span> <span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 12: Building Dashboards - Ready!&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Note: Full Dash apps require running outside Jupyter.&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This notebook demonstrates Plotly visualizations and Dash concepts.&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download data for visualization examples</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span>

<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span><span class="si">}</span><span class="s1"> trading days&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-12.1'></a></p>
<h1>Section 12.1: Dashboard Design Principles</h1>
<p>Effective dashboards follow clear design principles that maximize information transfer.</p>
<p><strong>In this section, you will learn:</strong>
- Information hierarchy in dashboard design
- Color conventions for financial data
- Layout best practices</p></div>
<div class="md-cell"><h2>12.1.1 Information Hierarchy</h2>
<p>Financial dashboards should follow a clear structure:</p>
<ol>
<li><strong>Summary Metrics</strong> (top): Key numbers at a glance</li>
<li><strong>Trend Charts</strong> (middle): Performance over time</li>
<li><strong>Detailed Analysis</strong> (bottom): Drill-down capabilities</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Principle</th>
<th>Application</th>
</tr>
</thead>
<tbody>
<tr>
<td>Clarity</td>
<td>Show the most important metrics prominently</td>
</tr>
<tr>
<td>Context</td>
<td>Always include benchmarks for comparison</td>
</tr>
<tr>
<td>Consistency</td>
<td>Use consistent colors for gains (green) and losses (red)</td>
</tr>
<tr>
<td>Actionability</td>
<td>Highlight items requiring attention</td>
</tr>
<tr>
<td>Simplicity</td>
<td>Avoid chart junk and unnecessary complexity</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><hr />
<p><a id='section-12.2'></a></p>
<h1>Section 12.2: Plotly Fundamentals</h1>
<p>Plotly creates interactive visualizations that work in Jupyter and can be embedded in Dash apps.</p>
<p><strong>In this section, you will learn:</strong>
- Creating figures with go.Figure
- Adding multiple traces
- Customizing layouts and styling</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Basic line chart with Plotly</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

<span class="c1"># Normalize prices to 100</span>
<span class="n">normalized</span> <span class="o">=</span> <span class="n">prices</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">normalized</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">normalized</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">normalized</span><span class="p">[</span><span class="n">col</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span>
    <span class="p">))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Asset Performance (Normalized to 100)&#39;</span><span class="p">,</span>
    <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
    <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span>
    <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
    <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;x unified&#39;</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">yanchor</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>12.2.1 Risk-Return Scatter Plot</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate metrics</span>
<span class="n">ann_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
<span class="n">ann_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">sharpe</span> <span class="o">=</span> <span class="n">ann_returns</span> <span class="o">/</span> <span class="n">ann_vol</span>

<span class="c1"># Create scatter plot</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">ann_vol</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">ann_returns</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+text&#39;</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">size</span><span class="o">=</span><span class="n">sharpe</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">sharpe</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span>
        <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Sharpe&#39;</span><span class="p">),</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="n">text</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="n">textposition</span><span class="o">=</span><span class="s1">&#39;top center&#39;</span><span class="p">,</span>
    <span class="n">hovertemplate</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;&lt;b&gt;%</span><span class="si">{text}</span><span class="s1">&lt;/b&gt;&lt;br&gt;&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;Return: %</span><span class="si">{y:.1f}</span><span class="s1">%&lt;br&gt;&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;Volatility: %</span><span class="si">{x:.1f}</span><span class="s1">%&lt;br&gt;&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;&lt;extra&gt;&lt;/extra&gt;&#39;</span>
    <span class="p">)</span>
<span class="p">))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Risk-Return Profile&#39;</span><span class="p">,</span>
    <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Volatility (%)&#39;</span><span class="p">,</span>
    <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Return (%)&#39;</span><span class="p">,</span>
    <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 12.1: Correlation Heatmap (Guided)</h3>
<p><strong>Your Task:</strong> Create an interactive correlation heatmap using Plotly.</p>
<p>Fill in the blanks to complete the heatmap:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.1: Correlation Heatmap (Guided)</span>
<span class="k">def</span> <span class="nf">create_correlation_heatmap</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an interactive correlation heatmap.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: DataFrame of asset returns</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Plotly Figure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate correlation matrix</span>
    <span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># TODO: Create heatmap using go.Heatmap</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">______</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
            <span class="n">z</span><span class="o">=</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span>
            <span class="n">zmid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="c1"># TODO: Add text annotations showing correlation values</span>
            <span class="n">text</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">texttemplate</span><span class="o">=</span><span class="s1">&#39;%</span><span class="si">{text}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;%</span><span class="si">{x}</span><span class="s1"> vs %</span><span class="si">{y}</span><span class="s1">&lt;br&gt;Correlation: %</span><span class="si">{z:.3f}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Asset Correlation Matrix&#39;</span><span class="p">,</span>
        <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">500</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Test your solution</span>
<span class="c1"># heatmap = create_correlation_heatmap(returns)</span>
<span class="c1"># heatmap.show()</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_correlation_heatmap</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an interactive correlation heatmap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate correlation matrix</span>
    <span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

    <span class="c1"># Create heatmap</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
            <span class="n">z</span><span class="o">=</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span>
            <span class="n">zmid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">texttemplate</span><span class="o">=</span><span class="s1">&#39;%</span><span class="si">{text}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;%</span><span class="si">{x}</span><span class="s1"> vs %</span><span class="si">{y}</span><span class="s1">&lt;br&gt;Correlation: %</span><span class="si">{z:.3f}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Asset Correlation Matrix&#39;</span><span class="p">,</span>
        <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">500</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Test</span>
<span class="n">heatmap</span> <span class="o">=</span> <span class="n">create_correlation_heatmap</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
<span class="n">heatmap</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-12.3'></a></p>
<h1>Section 12.3: Financial Charts</h1>
<p><strong>In this section, you will learn:</strong>
- Candlestick charts with technical indicators
- Multi-panel layouts with subplots
- KPI indicator cards</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download OHLC data for candlestick chart</span>
<span class="n">spy_ohlc</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2023-10-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spy_ohlc</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="n">spy_ohlc</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">spy_ohlc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Create candlestick with volume</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
    <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shared_xaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">vertical_spacing</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
    <span class="n">row_heights</span><span class="o">=</span><span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Candlestick chart</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Candlestick</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">spy_ohlc</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="nb">open</span><span class="o">=</span><span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">],</span>
        <span class="n">high</span><span class="o">=</span><span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span>
        <span class="n">low</span><span class="o">=</span><span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span>
        <span class="n">close</span><span class="o">=</span><span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;SPY&#39;</span>
    <span class="p">),</span>
    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Add moving averages</span>
<span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;MA20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;MA50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spy_ohlc</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;MA20&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MA20&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Volume bars</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span> <span class="k">if</span> <span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;green&#39;</span> 
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spy_ohlc</span><span class="p">))]</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spy_ohlc</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">spy_ohlc</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">,</span> <span class="n">marker_color</span><span class="o">=</span><span class="n">colors</span><span class="p">),</span>
    <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SPY Price Chart with Volume&#39;</span><span class="p">,</span>
    <span class="n">xaxis_rangeslider_visible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">600</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>12.3.1 KPI Cards</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">create_kpi_cards</span><span class="p">(</span><span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create KPI indicator cards.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        metrics: Dict of {name: {&#39;value&#39;: x, &#39;reference&#39;: y, &#39;suffix&#39;: &#39;%&#39;}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_metrics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">n_metrics</span><span class="p">,</span>
        <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;indicator&#39;</span><span class="p">}]</span> <span class="o">*</span> <span class="n">n_metrics</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Indicator</span><span class="p">(</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;number+delta&#39;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                <span class="n">title</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;font&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">}},</span>
                <span class="n">delta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
                       <span class="s1">&#39;relative&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relative&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)},</span>
                <span class="n">number</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suffix&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;suffix&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                       <span class="s1">&#39;font&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">}}</span>
            <span class="p">),</span>
            <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Calculate metrics</span>
<span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<span class="n">port_ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;YTD Return&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">port_ret</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;suffix&#39;</span><span class="p">:</span> <span class="s1">&#39;%&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;Volatility&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">port_ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;suffix&#39;</span><span class="p">:</span> <span class="s1">&#39;%&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">port_ret</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">port_ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
        <span class="s1">&#39;reference&#39;</span><span class="p">:</span> <span class="mf">1.0</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">kpi_fig</span> <span class="o">=</span> <span class="n">create_kpi_cards</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
<span class="n">kpi_fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 12.2: Portfolio Dashboard Layout (Guided)</h3>
<p><strong>Your Task:</strong> Create a multi-panel dashboard using Plotly subplots.</p>
<p>Fill in the blanks to complete the dashboard:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.2: Portfolio Dashboard Layout (Guided)</span>
<span class="k">def</span> <span class="nf">create_portfolio_dashboard</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                               <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a comprehensive portfolio dashboard.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Plotly Figure with multiple panels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate portfolio metrics</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="n">port_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">port_cum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">port_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    
    <span class="c1"># TODO: Create 2x2 subplot layout</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="n">______</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">______</span><span class="p">,</span>
        <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Portfolio Performance&#39;</span><span class="p">,</span> <span class="s1">&#39;Asset Allocation&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Drawdown&#39;</span><span class="p">,</span> <span class="s1">&#39;Return Distribution&#39;</span><span class="p">),</span>
        <span class="n">specs</span><span class="o">=</span><span class="p">[</span>
            <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scatter&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;pie&#39;</span><span class="p">}],</span>
            <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scatter&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;histogram&#39;</span><span class="p">}]</span>
        <span class="p">]</span>
    <span class="p">)</span>
    
    <span class="c1"># Performance chart</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">port_cum</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">port_cum</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span>
                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="c1"># TODO: Add pie chart for allocation</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">values</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
               <span class="n">hole</span><span class="o">=</span><span class="mf">0.4</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    
    <span class="c1"># Drawdown chart</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">port_cum</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_cum</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> 
                  <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tozeroy&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255,0,0,0.3)&#39;</span><span class="p">,</span>
                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="c1"># TODO: Add histogram for return distribution</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">port_returns</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">nbinsx</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                  <span class="n">marker_color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Returns&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Test your solution</span>
<span class="c1"># dashboard = create_portfolio_dashboard(prices, returns, weights)</span>
<span class="c1"># dashboard.show()</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_portfolio_dashboard</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                               <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a comprehensive portfolio dashboard.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="n">port_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">port_cum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">port_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

    <span class="c1"># Create 2x2 subplot layout</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Portfolio Performance&#39;</span><span class="p">,</span> <span class="s1">&#39;Asset Allocation&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Drawdown&#39;</span><span class="p">,</span> <span class="s1">&#39;Return Distribution&#39;</span><span class="p">),</span>
        <span class="n">specs</span><span class="o">=</span><span class="p">[</span>
            <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scatter&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;pie&#39;</span><span class="p">}],</span>
            <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scatter&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;histogram&#39;</span><span class="p">}]</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Performance chart</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">port_cum</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">port_cum</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span>
                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="c1"># Pie chart for allocation</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Pie</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">values</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
               <span class="n">hole</span><span class="o">=</span><span class="mf">0.4</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>

    <span class="c1"># Drawdown chart</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">port_cum</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_cum</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> 
                  <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tozeroy&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255,0,0,0.3)&#39;</span><span class="p">,</span>
                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="c1"># Histogram for return distribution</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Histogram</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">port_returns</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">nbinsx</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                    <span class="n">marker_color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Returns&#39;</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Test</span>
<span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">create_portfolio_dashboard</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 12.3: Risk Dashboard (Guided)</h3>
<p><strong>Your Task:</strong> Create a risk monitoring dashboard with VaR, drawdown, and volatility panels.</p>
<p>Fill in the blanks to complete the dashboard:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.3: Risk Dashboard (Guided)</span>
<span class="k">def</span> <span class="nf">create_risk_dashboard</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span> 
                          <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a risk monitoring dashboard.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate rolling volatility (annualized)</span>
    <span class="n">rolling_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate rolling VaR (using quantile)</span>
    <span class="n">rolling_var</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="c1"># Calculate drawdown</span>
    <span class="n">cum_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_returns</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_returns</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    
    <span class="c1"># Create 3-panel layout</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">shared_xaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">-Day Rolling VaR (</span><span class="si">{</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Drawdown&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">-Day Rolling Volatility&#39;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    
    <span class="c1"># VaR chart</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rolling_var</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">rolling_var</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tozeroy&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255,100,100,0.3)&#39;</span><span class="p">,</span>
                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="c1"># Drawdown chart</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tozeroy&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255,0,0,0.3)&#39;</span><span class="p">,</span>
                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="c1"># Volatility chart</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rolling_vol</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">rolling_vol</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tozeroy&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255,165,0,0.3)&#39;</span><span class="p">,</span>
                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
                     <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Risk Monitoring Dashboard&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Test your solution</span>
<span class="c1"># port_returns = (returns * np.array([0.4, 0.25, 0.25, 0.1])).sum(axis=1)</span>
<span class="c1"># risk_dash = create_risk_dashboard(port_returns)</span>
<span class="c1"># risk_dash.show()</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_risk_dashboard</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span> 
                          <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a risk monitoring dashboard.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate rolling volatility (annualized)</span>
    <span class="n">rolling_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="c1"># Calculate rolling VaR (using quantile)</span>
    <span class="n">rolling_var</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># Calculate drawdown</span>
    <span class="n">cum_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_returns</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_returns</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>

    <span class="c1"># Create 3-panel layout</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">shared_xaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">-Day Rolling VaR (</span><span class="si">{</span><span class="n">confidence</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Drawdown&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s1">-Day Rolling Volatility&#39;</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rolling_var</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">rolling_var</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tozeroy&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255,100,100,0.3)&#39;</span><span class="p">,</span>
                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tozeroy&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255,0,0,0.3)&#39;</span><span class="p">,</span>
                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">rolling_vol</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">rolling_vol</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tozeroy&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255,165,0,0.3)&#39;</span><span class="p">,</span>
                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
                     <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Risk Monitoring Dashboard&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Test</span>
<span class="n">port_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">risk_dash</span> <span class="o">=</span> <span class="n">create_risk_dashboard</span><span class="p">(</span><span class="n">port_returns</span><span class="p">)</span>
<span class="n">risk_dash</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-12.4'></a></p>
<h1>Section 12.4: Dash Architecture</h1>
<p>Dash enables full interactivity through callbacks - functions that update outputs when inputs change.</p>
<p><strong>In this section, you will learn:</strong>
- Dash application structure
- Callbacks for interactivity
- Input/Output components</p></div>
<div class="md-cell"><h2>12.4.1 Dash Application Structure</h2>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">dash</span> <span class="kn">import</span> <span class="n">Dash</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">dcc</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Output</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Dash</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">([</span>
    <span class="c1"># Input components</span>
    <span class="n">dcc</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;asset-selector&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">]),</span>

    <span class="c1"># Output components</span>
    <span class="n">dcc</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;performance-chart&#39;</span><span class="p">)</span>
<span class="p">])</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
    <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;performance-chart&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
    <span class="n">Input</span><span class="p">(</span><span class="s1">&#39;asset-selector&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">update_chart</span><span class="p">(</span><span class="n">selected_asset</span><span class="p">):</span>
    <span class="c1"># Create and return figure</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run_server</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulating interactive behavior in Jupyter</span>
<span class="k">def</span> <span class="nf">create_interactive_chart</span><span class="p">(</span><span class="n">assets_to_show</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">lookback_days</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a chart that would be updated by Dash callbacks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filtered_prices</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">assets_to_show</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">lookback_days</span><span class="p">:]</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">filtered_prices</span> <span class="o">/</span> <span class="n">filtered_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">normalized</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">normalized</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">normalized</span><span class="p">[</span><span class="n">col</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span>
        <span class="p">))</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Performance Over Last </span><span class="si">{</span><span class="n">lookback_days</span><span class="si">}</span><span class="s1"> Days&#39;</span><span class="p">,</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Normalized Value&#39;</span><span class="p">,</span>
        <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;x unified&#39;</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Simulate different states</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simulating: All assets, 252 days&quot;</span><span class="p">)</span>
<span class="n">fig1</span> <span class="o">=</span> <span class="n">create_interactive_chart</span><span class="p">([</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">],</span> <span class="mi">252</span><span class="p">)</span>
<span class="n">fig1</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 12.4: Monthly Returns Heatmap (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Creates a calendar heatmap of monthly returns
- Shows months as columns and years as rows
- Uses diverging color scale centered on zero
- Includes hover information</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.4: Monthly Returns Heatmap (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_monthly_returns_heatmap</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Monthly Returns&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a calendar heatmap of monthly returns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate monthly returns</span>
    <span class="n">monthly</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Create pivot table</span>
    <span class="n">monthly_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">monthly</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
        <span class="s1">&#39;Month&#39;</span><span class="p">:</span> <span class="n">monthly</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
        <span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="n">monthly</span><span class="o">.</span><span class="n">values</span>
    <span class="p">})</span>

    <span class="n">pivot</span> <span class="o">=</span> <span class="n">monthly_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>

    <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
        <span class="n">z</span><span class="o">=</span><span class="n">pivot</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">months</span><span class="p">[:</span><span class="n">pivot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">pivot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span>
        <span class="n">zmid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pivot</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">texttemplate</span><span class="o">=</span><span class="s1">&#39;%</span><span class="si">{text}</span><span class="s1">%&#39;</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;%</span><span class="si">{y}</span><span class="s1"> %</span><span class="si">{x}</span><span class="s1">&lt;br&gt;Return: %</span><span class="si">{z:.1f}</span><span class="s1">%&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
        <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Return (%)&#39;</span><span class="p">)</span>
    <span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">300</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Test</span>
<span class="n">port_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">heatmap</span> <span class="o">=</span> <span class="n">create_monthly_returns_heatmap</span><span class="p">(</span><span class="n">port_returns</span><span class="p">,</span> <span class="s1">&#39;Portfolio Monthly Returns&#39;</span><span class="p">)</span>
<span class="n">heatmap</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 12.5: Performance Comparison Chart (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that:
- Compares multiple portfolios against a benchmark
- Shows cumulative returns over time
- Includes a summary table with key metrics
- Uses appropriate color coding</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.5: Performance Comparison Chart (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_performance_comparison</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">portfolios</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                                  <span class="n">benchmark</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SPY&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a performance comparison chart.</span>

<span class="sd">    Args:</span>
<span class="sd">        portfolios: Dict of {name: {ticker: weight}}</span>
<span class="sd">        benchmark: Benchmark ticker</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate portfolio returns</span>
    <span class="n">port_returns</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="n">port_returns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add benchmark</span>
    <span class="n">port_returns</span><span class="p">[</span><span class="s1">&#39;Benchmark&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">benchmark</span><span class="p">]</span>

    <span class="c1"># Calculate cumulative returns</span>
    <span class="n">cum_returns</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ret</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># Create figure</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cum_ret</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cum_returns</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">line_style</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dash</span><span class="o">=</span><span class="s1">&#39;dash&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Benchmark&#39;</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">cum_ret</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="n">cum_ret</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)],</span> <span class="o">**</span><span class="n">line_style</span><span class="p">)</span>
        <span class="p">))</span>

    <span class="c1"># Add metrics annotation</span>
    <span class="n">metrics_text</span> <span class="o">=</span> <span class="s2">&quot;&lt;b&gt;Annualized Metrics:&lt;/b&gt;&lt;br&gt;&quot;</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ann_ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
        <span class="n">metrics_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ann_ret</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% (SR: </span><span class="si">{</span><span class="n">sharpe</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&lt;br&gt;&quot;</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">xref</span><span class="o">=</span><span class="s1">&#39;paper&#39;</span><span class="p">,</span> <span class="n">yref</span><span class="o">=</span><span class="s1">&#39;paper&#39;</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="n">metrics_text</span><span class="p">,</span> <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
        <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">bordercolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">borderwidth</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Portfolio Performance Comparison&#39;</span><span class="p">,</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Cumulative Return (%)&#39;</span><span class="p">,</span>
        <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span><span class="p">,</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;x unified&#39;</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Test</span>
<span class="n">portfolios</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Aggressive&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
    <span class="s1">&#39;Balanced&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="s1">&#39;Defensive&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>
<span class="p">}</span>
<span class="n">comparison</span> <span class="o">=</span> <span class="n">create_performance_comparison</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">portfolios</span><span class="p">)</span>
<span class="n">comparison</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 12.6: Complete Dashboard Class (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a comprehensive dashboard class that includes:
- Performance visualization methods
- Risk charts (drawdown, VaR, volatility)
- Allocation views (pie, bar)
- Full dashboard layout generation
- Dark/light theme support</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.6: Complete Dashboard Class (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">QuantDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete quantitative finance dashboard builder.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">benchmark</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;plotly_white&#39;</span>

    <span class="k">def</span> <span class="nf">set_dark_theme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Switch to dark theme.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;plotly_dark&#39;</span>

    <span class="k">def</span> <span class="nf">performance_chart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create performance time series chart.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Performance Over Time&#39;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Normalized Value&#39;</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="s1">&#39;Value&#39;</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span>
            <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;x unified&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">drawdown_chart</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create drawdown chart.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span>

        <span class="n">cum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ret</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tozeroy&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255,0,0,0.3)&#39;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">correlation_heatmap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create correlation heatmap.&quot;&quot;&quot;</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
            <span class="n">z</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span> <span class="n">zmid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">texttemplate</span><span class="o">=</span><span class="s1">&#39;%</span><span class="si">{text}</span><span class="s1">&#39;</span>
        <span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Correlation Matrix&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">risk_return_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create risk-return scatter plot.&quot;&quot;&quot;</span>
        <span class="n">ann_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">ann_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">ann_ret</span> <span class="o">/</span> <span class="n">ann_vol</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">ann_vol</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ann_ret</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+text&#39;</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">textposition</span><span class="o">=</span><span class="s1">&#39;top center&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">sharpe</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">sharpe</span><span class="p">,</span> <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">)</span>
        <span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Risk-Return Profile&#39;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Volatility (%)&#39;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Return (%)&#39;</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">full_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create comprehensive dashboard with all components.&quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
            <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Performance&#39;</span><span class="p">,</span> <span class="s1">&#39;Risk-Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Drawdown&#39;</span><span class="p">,</span> <span class="s1">&#39;Correlation&#39;</span><span class="p">),</span>
            <span class="n">specs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scatter&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scatter&#39;</span><span class="p">}],</span>
                <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scatter&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;heatmap&#39;</span><span class="p">}]</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Get individual figures</span>
        <span class="n">perf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_chart</span><span class="p">()</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_return_scatter</span><span class="p">()</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown_chart</span><span class="p">()</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_heatmap</span><span class="p">()</span>

        <span class="c1"># Add traces</span>
        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">perf</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">rr</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">corr</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Quantitative Finance Dashboard&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Demo</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">QuantDashboard</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>
<span class="n">full_dash</span> <span class="o">=</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">full_dashboard</span><span class="p">()</span>
<span class="n">full_dash</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Portfolio Analytics Dashboard</h1>
<p>Put together everything you've learned!</p>
<p><strong>Your Challenge:</strong></p>
<p>Build a complete portfolio analytics dashboard that includes:
1. KPI cards showing key metrics (return, volatility, Sharpe)
2. Performance chart with benchmark comparison
3. Asset allocation visualization (pie chart)
4. Risk metrics panel (drawdown, VaR, volatility)
5. Monthly returns heatmap
6. Correlation matrix</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PortfolioAnalyticsDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete portfolio analytics dashboard.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">benchmark</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SPY&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;plotly_white&#39;</span>

        <span class="c1"># Calculate portfolio returns</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bench_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">benchmark</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate key portfolio metrics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_returns</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;ann_return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
            <span class="s1">&#39;ann_vol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span>
            <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
            <span class="s1">&#39;max_dd&#39;</span><span class="p">:</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">/</span> 
                      <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate complete dashboard.&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
            <span class="n">rows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">subplot_titles</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;Total Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Volatility&#39;</span><span class="p">,</span> <span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Performance vs Benchmark&#39;</span><span class="p">,</span> <span class="s1">&#39;Asset Allocation&#39;</span><span class="p">,</span> <span class="s1">&#39;Drawdown&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Monthly Returns&#39;</span><span class="p">,</span> <span class="s1">&#39;Correlation Matrix&#39;</span><span class="p">,</span> <span class="s1">&#39;Risk-Return&#39;</span>
            <span class="p">],</span>
            <span class="n">specs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;indicator&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;indicator&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;indicator&#39;</span><span class="p">}],</span>
                <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scatter&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;pie&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scatter&#39;</span><span class="p">}],</span>
                <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;heatmap&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;heatmap&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;scatter&#39;</span><span class="p">}]</span>
            <span class="p">],</span>
            <span class="n">vertical_spacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">horizontal_spacing</span><span class="o">=</span><span class="mf">0.1</span>
        <span class="p">)</span>

        <span class="c1"># KPI Cards</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Indicator</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">number</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suffix&#39;</span><span class="p">:</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;font&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">}}</span>
        <span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Indicator</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;ann_vol&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">number</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suffix&#39;</span><span class="p">:</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;font&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">}}</span>
        <span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Indicator</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">],</span>
            <span class="n">number</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;font&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">}}</span>
        <span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Performance</span>
        <span class="n">port_cum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">bench_cum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bench_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">port_cum</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">port_cum</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span>
                                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)),</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">bench_cum</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">bench_cum</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Benchmark&#39;</span><span class="p">,</span>
                                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">&#39;dash&#39;</span><span class="p">)),</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Allocation</span>
        <span class="n">active_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Pie</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">active_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> 
                            <span class="n">values</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">active_weights</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">hole</span><span class="o">=</span><span class="mf">0.4</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Drawdown</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_cum</span> <span class="o">/</span> <span class="n">port_cum</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">drawdown</span><span class="p">,</span>
                                <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;tozeroy&#39;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="s1">&#39;rgba(255,0,0,0.3)&#39;</span><span class="p">,</span>
                                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)),</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Monthly returns heatmap</span>
        <span class="n">monthly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">monthly_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">monthly</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="s1">&#39;Month&#39;</span><span class="p">:</span> <span class="n">monthly</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> 
                                   <span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="n">monthly</span><span class="o">.</span><span class="n">values</span><span class="p">})</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">monthly_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;Return&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">pivot</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)),</span> <span class="n">y</span><span class="o">=</span><span class="n">pivot</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span> <span class="n">zmid</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Correlation</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span> <span class="n">zmid</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Risk-Return</span>
        <span class="n">ann_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">ann_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">ann_vol</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ann_ret</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+text&#39;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">textposition</span><span class="o">=</span><span class="s1">&#39;top center&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">ann_ret</span> <span class="o">/</span> <span class="n">ann_vol</span><span class="p">,</span> <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">)</span>
        <span class="p">),</span> <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Portfolio Analytics Dashboard | Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;ann_return&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% | Sharpe: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;sharpe&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Demo</span>
<span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">PortfolioAnalyticsDashboard</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
<span class="n">full_dash</span> <span class="o">=</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">generate_dashboard</span><span class="p">()</span>
<span class="n">full_dash</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Dashboard Design</h3>
<ul>
<li>Follow information hierarchy: summary -&gt; trends -&gt; details</li>
<li>Use consistent color conventions (green=good, red=bad)</li>
<li>Keep it simple and actionable</li>
</ul>
<h3>2. Plotly Fundamentals</h3>
<ul>
<li>go.Figure() for custom charts</li>
<li>make_subplots() for multi-panel layouts</li>
<li>Templates for consistent styling</li>
</ul>
<h3>3. Financial Charts</h3>
<ul>
<li>Candlestick charts for price data</li>
<li>Heatmaps for correlations and calendar views</li>
<li>Scatter plots for risk-return analysis</li>
</ul>
<h3>4. Dash Architecture</h3>
<ul>
<li>Callbacks connect inputs to outputs</li>
<li>Layout defines component structure</li>
<li>Full interactivity without page refresh</li>
</ul></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 13: Professional Reporting</strong>, we'll explore:
- Automated report generation
- PDF and Excel output
- Performance tear sheets
- Scheduled report delivery</p>
<hr />
<p><em>Congratulations on completing Module 12!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="13"><div class="md-cell module-header"><h1>Module 13: Professional Reporting</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 5: Production &amp; Infrastructure</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Design professional financial reports for different audiences</li>
<li>Automate PDF report generation with ReportLab</li>
<li>Create formatted Excel workbooks with openpyxl</li>
<li>Build performance tear sheets for strategy evaluation</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 11, 12</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-13.1">Section 13.1: Report Design Principles</a></li>
<li><a href="#section-13.2">Section 13.2: Automated PDF Reports</a></li>
<li><a href="#section-13.3">Section 13.3: Excel Reports</a></li>
<li><a href="#section-13.4">Section 13.4: Performance Tear Sheets</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># PDF generation</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">reportlab.lib</span> <span class="kn">import</span> <span class="n">colors</span>
    <span class="kn">from</span> <span class="nn">reportlab.lib.pagesizes</span> <span class="kn">import</span> <span class="n">letter</span><span class="p">,</span> <span class="n">A4</span>
    <span class="kn">from</span> <span class="nn">reportlab.platypus</span> <span class="kn">import</span> <span class="n">SimpleDocTemplate</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">TableStyle</span><span class="p">,</span> <span class="n">Paragraph</span><span class="p">,</span> <span class="n">Spacer</span><span class="p">,</span> <span class="n">Image</span>
    <span class="kn">from</span> <span class="nn">reportlab.lib.styles</span> <span class="kn">import</span> <span class="n">getSampleStyleSheet</span><span class="p">,</span> <span class="n">ParagraphStyle</span>
    <span class="kn">from</span> <span class="nn">reportlab.lib.units</span> <span class="kn">import</span> <span class="n">inch</span>
    <span class="n">PDF_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">PDF_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ReportLab not installed. PDF generation will be simulated.&quot;</span><span class="p">)</span>

<span class="c1"># Excel generation</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">openpyxl</span>
    <span class="kn">from</span> <span class="nn">openpyxl.styles</span> <span class="kn">import</span> <span class="n">Font</span><span class="p">,</span> <span class="n">PatternFill</span><span class="p">,</span> <span class="n">Alignment</span><span class="p">,</span> <span class="n">Border</span><span class="p">,</span> <span class="n">Side</span>
    <span class="kn">from</span> <span class="nn">openpyxl.chart</span> <span class="kn">import</span> <span class="n">LineChart</span><span class="p">,</span> <span class="n">Reference</span><span class="p">,</span> <span class="n">BarChart</span>
    <span class="n">EXCEL_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">EXCEL_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;openpyxl not installed. Excel generation will be simulated.&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 13: Professional Reporting - Ready!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download data</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span>

<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Create sample portfolio</span>
<span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">}</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">])</span>
<span class="n">portfolio_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="n">tickers</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">benchmark_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span><span class="si">}</span><span class="s1"> trading days&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-13.1'></a></p>
<h1>Section 13.1: Report Design Principles</h1>
<p>Professional portfolio management requires clear, consistent reporting. Different audiences need different information at varying levels of detail.</p>
<p><strong>In this section, you will learn:</strong>
- Types of financial reports
- Report structure best practices
- Calculating report metrics</p></div>
<div class="md-cell"><h2>13.1.1 Types of Financial Reports</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Report Type</th>
<th>Audience</th>
<th>Frequency</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td>Client Report</td>
<td>External</td>
<td>Monthly/Quarterly</td>
<td>Performance, holdings, commentary</td>
</tr>
<tr>
<td>Risk Report</td>
<td>Internal</td>
<td>Daily</td>
<td>VaR, limits, breaches</td>
</tr>
<tr>
<td>Regulatory Report</td>
<td>Regulators</td>
<td>Quarterly/Annual</td>
<td>Compliance, positions</td>
</tr>
<tr>
<td>Tear Sheet</td>
<td>Marketing</td>
<td>On-demand</td>
<td>Strategy summary</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>13.1.2 Report Structure Best Practices</h2>
<ol>
<li><strong>Executive Summary</strong>: Key numbers at a glance</li>
<li><strong>Performance Section</strong>: Returns, attribution, benchmarks</li>
<li><strong>Risk Section</strong>: Volatility, VaR, drawdowns</li>
<li><strong>Holdings Section</strong>: Current positions, weights</li>
<li><strong>Appendix</strong>: Methodology, disclaimers</li>
</ol></div>
<div class="md-cell"><h2>13.1.3 Calculating Report Metrics</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_report_metrics</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                            <span class="n">risk_free_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate all metrics needed for a performance report.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    returns : Series</span>
<span class="sd">        Portfolio returns</span>
<span class="sd">    benchmark_returns : Series</span>
<span class="sd">        Benchmark returns</span>
<span class="sd">    risk_free_rate : float</span>
<span class="sd">        Annual risk-free rate</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict : Report metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Cumulative returns</span>
    <span class="n">cum_port</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">cum_bench</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">benchmark_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    
    <span class="c1"># Period returns</span>
    <span class="n">total_return</span> <span class="o">=</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">bench_return</span> <span class="o">=</span> <span class="n">cum_bench</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="c1"># Annualized metrics</span>
    <span class="n">n_years</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">252</span>
    <span class="n">ann_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">total_return</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n_years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">ann_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="c1"># Risk-adjusted metrics</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">ann_return</span> <span class="o">-</span> <span class="n">risk_free_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">ann_vol</span>
    
    <span class="c1"># Sortino</span>
    <span class="n">downside_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">downside_vol</span> <span class="o">=</span> <span class="n">downside_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">sortino</span> <span class="o">=</span> <span class="p">(</span><span class="n">ann_return</span> <span class="o">-</span> <span class="n">risk_free_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">downside_vol</span>
    
    <span class="c1"># Drawdown</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_port</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    <span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    
    <span class="c1"># Calmar</span>
    <span class="n">calmar</span> <span class="o">=</span> <span class="n">ann_return</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_dd</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_dd</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="c1"># Relative metrics</span>
    <span class="n">active_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">-</span> <span class="n">benchmark_returns</span>
    <span class="n">tracking_error</span> <span class="o">=</span> <span class="n">active_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    <span class="n">information_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">active_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="n">tracking_error</span>
    
    <span class="c1"># Beta and Alpha</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">var_bench</span> <span class="o">=</span> <span class="n">benchmark_returns</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="n">var_bench</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">ann_return</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">benchmark_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span>
    
    <span class="c1"># VaR and ES</span>
    <span class="n">var_95</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">es_95</span> <span class="o">=</span> <span class="o">-</span><span class="n">returns</span><span class="p">[</span><span class="n">returns</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="c1"># Win rate</span>
    <span class="n">win_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
        <span class="s1">&#39;benchmark_return&#39;</span><span class="p">:</span> <span class="n">bench_return</span><span class="p">,</span>
        <span class="s1">&#39;active_return&#39;</span><span class="p">:</span> <span class="n">total_return</span> <span class="o">-</span> <span class="n">bench_return</span><span class="p">,</span>
        <span class="s1">&#39;ann_return&#39;</span><span class="p">:</span> <span class="n">ann_return</span><span class="p">,</span>
        <span class="s1">&#39;ann_volatility&#39;</span><span class="p">:</span> <span class="n">ann_vol</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
        <span class="s1">&#39;sortino_ratio&#39;</span><span class="p">:</span> <span class="n">sortino</span><span class="p">,</span>
        <span class="s1">&#39;calmar_ratio&#39;</span><span class="p">:</span> <span class="n">calmar</span><span class="p">,</span>
        <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
        <span class="s1">&#39;tracking_error&#39;</span><span class="p">:</span> <span class="n">tracking_error</span><span class="p">,</span>
        <span class="s1">&#39;information_ratio&#39;</span><span class="p">:</span> <span class="n">information_ratio</span><span class="p">,</span>
        <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span>
        <span class="s1">&#39;var_95&#39;</span><span class="p">:</span> <span class="n">var_95</span><span class="p">,</span>
        <span class="s1">&#39;es_95&#39;</span><span class="p">:</span> <span class="n">es_95</span><span class="p">,</span>
        <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">win_rate</span><span class="p">,</span>
        <span class="s1">&#39;n_periods&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">),</span>
        <span class="s1">&#39;start_date&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;end_date&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">}</span>

<span class="c1"># Calculate metrics</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_report_metrics</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Portfolio Performance Metrics&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Period: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Return Metrics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Return:     </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Benchmark Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annualized:       </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;ann_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 13.1: Report Metrics Calculator (Guided)</h3>
<p><strong>Your Task:</strong> Complete the function to calculate rolling performance metrics for a report.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.1: Report Metrics Calculator (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_rolling_metrics</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate rolling performance metrics for reporting.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    returns : Series</span>
<span class="sd">        Daily portfolio returns</span>
<span class="sd">    window : int</span>
<span class="sd">        Rolling window size in days</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    DataFrame with rolling return, volatility, and Sharpe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate rolling mean return (annualized)</span>
    <span class="n">rolling_return</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
    
    <span class="c1"># TODO: Calculate rolling volatility (annualized)</span>
    <span class="n">rolling_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate rolling Sharpe ratio</span>
    <span class="n">rolling_sharpe</span> <span class="o">=</span> <span class="n">rolling_return</span> <span class="o">/</span> <span class="n">______</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">rolling_return</span><span class="p">,</span>
        <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">rolling_vol</span><span class="p">,</span>
        <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">rolling_sharpe</span>
    <span class="p">})</span>

<span class="c1"># Test your function</span>
<span class="c1"># rolling_metrics = calculate_rolling_metrics(portfolio_returns)</span>
<span class="c1"># print(rolling_metrics.tail())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_rolling_metrics</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate rolling performance metrics for reporting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate rolling mean return (annualized)</span>
    <span class="n">rolling_return</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>

    <span class="c1"># Calculate rolling volatility (annualized)</span>
    <span class="n">rolling_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="c1"># Calculate rolling Sharpe ratio</span>
    <span class="n">rolling_sharpe</span> <span class="o">=</span> <span class="n">rolling_return</span> <span class="o">/</span> <span class="n">rolling_vol</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">rolling_return</span><span class="p">,</span>
        <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">rolling_vol</span><span class="p">,</span>
        <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">rolling_sharpe</span>
    <span class="p">})</span>

<span class="c1"># Test</span>
<span class="n">rolling_metrics</span> <span class="o">=</span> <span class="n">calculate_rolling_metrics</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rolling_metrics</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-13.2'></a></p>
<h1>Section 13.2: Automated PDF Reports</h1>
<p>PDF reports provide professional, print-ready documents for client communications.</p>
<p><strong>In this section, you will learn:</strong>
- ReportLab basics
- Creating tables and charts for PDFs
- Building multi-page reports</p></div>
<div class="md-cell"><h2>13.2.1 Creating Charts for Reports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">create_performance_chart</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                             <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;performance.png&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a performance chart for the report.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cum_port</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">cum_bench</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">benchmark_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_port</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_port</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2E86AB&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_bench</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_bench</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Benchmark&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> 
            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Growth of $100&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Portfolio Performance vs Benchmark&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">filename</span>


<span class="k">def</span> <span class="nf">create_drawdown_chart</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;drawdown.png&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a drawdown chart for the report.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cum_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_returns</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_returns</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Portfolio Drawdown&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">filename</span>

<span class="c1"># Create charts</span>
<span class="n">perf_chart</span> <span class="o">=</span> <span class="n">create_performance_chart</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">)</span>
<span class="n">dd_chart</span> <span class="o">=</span> <span class="n">create_drawdown_chart</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charts created: </span><span class="si">{</span><span class="n">perf_chart</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">dd_chart</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>13.2.2 PDF Report Generation</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">generate_pdf_report</span><span class="p">(</span><span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;portfolio_report.pdf&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a professional PDF report.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">PDF_AVAILABLE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PDF generation simulated (ReportLab not installed)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">doc</span> <span class="o">=</span> <span class="n">SimpleDocTemplate</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="n">letter</span><span class="p">)</span>
    <span class="n">styles</span> <span class="o">=</span> <span class="n">getSampleStyleSheet</span><span class="p">()</span>
    <span class="n">story</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Title</span>
    <span class="n">title_style</span> <span class="o">=</span> <span class="n">ParagraphStyle</span><span class="p">(</span>
        <span class="s1">&#39;CustomTitle&#39;</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">styles</span><span class="p">[</span><span class="s1">&#39;Heading1&#39;</span><span class="p">],</span>
        <span class="n">fontSize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
        <span class="n">spaceAfter</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">alignment</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Paragraph</span><span class="p">(</span><span class="s1">&#39;Portfolio Performance Report&#39;</span><span class="p">,</span> <span class="n">title_style</span><span class="p">))</span>
    
    <span class="c1"># Report date</span>
    <span class="n">report_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">, %Y&#39;</span><span class="p">)</span>
    <span class="n">date_style</span> <span class="o">=</span> <span class="n">ParagraphStyle</span><span class="p">(</span><span class="s1">&#39;DateStyle&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">styles</span><span class="p">[</span><span class="s1">&#39;Normal&#39;</span><span class="p">],</span> 
                                <span class="n">fontSize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">alignment</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Paragraph</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Report Date: </span><span class="si">{</span><span class="n">report_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">date_style</span><span class="p">))</span>
    <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Spacer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    
    <span class="c1"># Summary table</span>
    <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Paragraph</span><span class="p">(</span><span class="s1">&#39;Executive Summary&#39;</span><span class="p">,</span> <span class="n">styles</span><span class="p">[</span><span class="s1">&#39;Heading2&#39;</span><span class="p">]))</span>
    <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Spacer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    
    <span class="n">summary_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;Metric&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;Total Return&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;Benchmark Return&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;Max Drawdown&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">],</span>
    <span class="p">]</span>
    
    <span class="n">summary_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">summary_data</span><span class="p">,</span> <span class="n">colWidths</span><span class="o">=</span><span class="p">[</span><span class="mf">2.5</span><span class="o">*</span><span class="n">inch</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">inch</span><span class="p">])</span>
    <span class="n">summary_table</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">TableStyle</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;BACKGROUND&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">HexColor</span><span class="p">(</span><span class="s1">&#39;#2E86AB&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;TEXTCOLOR&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">whitesmoke</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;ALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;CENTER&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;FONTNAME&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Helvetica-Bold&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;GRID&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">.</span><span class="n">black</span><span class="p">),</span>
    <span class="p">]))</span>
    <span class="n">story</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summary_table</span><span class="p">)</span>
    
    <span class="c1"># Build PDF</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">story</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span>

<span class="k">if</span> <span class="n">PDF_AVAILABLE</span><span class="p">:</span>
    <span class="n">pdf_file</span> <span class="o">=</span> <span class="n">generate_pdf_report</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF report generated: </span><span class="si">{</span><span class="n">pdf_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PDF generation skipped (install reportlab to enable)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 13.2: Monthly Summary Table (Guided)</h3>
<p><strong>Your Task:</strong> Complete the function to create a monthly returns summary table for PDF reports.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.2: Monthly Summary Table (Guided)</span>
<span class="k">def</span> <span class="nf">create_monthly_summary</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create monthly summary statistics for report table.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    returns : Series</span>
<span class="sd">        Daily returns series</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    DataFrame with monthly return, volatility, and best/worst days</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Resample returns to monthly frequency and calculate compound return</span>
    <span class="n">monthly_return</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate monthly volatility (annualized)</span>
    <span class="n">monthly_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
    
    <span class="c1"># TODO: Find best day each month</span>
    <span class="n">best_day</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># Find worst day each month</span>
    <span class="n">worst_day</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="n">monthly_return</span><span class="p">,</span>
        <span class="s1">&#39;Volatility&#39;</span><span class="p">:</span> <span class="n">monthly_vol</span><span class="p">,</span>
        <span class="s1">&#39;Best Day&#39;</span><span class="p">:</span> <span class="n">best_day</span><span class="p">,</span>
        <span class="s1">&#39;Worst Day&#39;</span><span class="p">:</span> <span class="n">worst_day</span>
    <span class="p">})</span>

<span class="c1"># Test your function</span>
<span class="c1"># summary = create_monthly_summary(portfolio_returns)</span>
<span class="c1"># print(summary.tail())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_monthly_summary</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create monthly summary statistics for report table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Resample returns to monthly frequency and calculate compound return</span>
    <span class="n">monthly_return</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate monthly volatility (annualized)</span>
    <span class="n">monthly_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="c1"># Find best day each month</span>
    <span class="n">best_day</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Find worst day each month</span>
    <span class="n">worst_day</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Return&#39;</span><span class="p">:</span> <span class="n">monthly_return</span><span class="p">,</span>
        <span class="s1">&#39;Volatility&#39;</span><span class="p">:</span> <span class="n">monthly_vol</span><span class="p">,</span>
        <span class="s1">&#39;Best Day&#39;</span><span class="p">:</span> <span class="n">best_day</span><span class="p">,</span>
        <span class="s1">&#39;Worst Day&#39;</span><span class="p">:</span> <span class="n">worst_day</span>
    <span class="p">})</span>

<span class="c1"># Test</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">create_monthly_summary</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-13.3'></a></p>
<h1>Section 13.3: Excel Reports</h1>
<p>Excel workbooks allow recipients to explore data interactively.</p>
<p><strong>In this section, you will learn:</strong>
- Creating formatted Excel workbooks
- Multi-sheet reports
- Conditional formatting</p></div>
<div class="md-cell"><h2>13.3.1 Excel Report Generation</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">generate_excel_report</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                          <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                          <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;portfolio_report.xlsx&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a comprehensive Excel report.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">EXCEL_AVAILABLE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Excel generation simulated (openpyxl not installed)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">wb</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">Workbook</span><span class="p">()</span>
    
    <span class="c1"># Define styles</span>
    <span class="n">header_font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;FFFFFF&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">header_fill</span> <span class="o">=</span> <span class="n">PatternFill</span><span class="p">(</span><span class="n">start_color</span><span class="o">=</span><span class="s1">&#39;2E86AB&#39;</span><span class="p">,</span> <span class="n">end_color</span><span class="o">=</span><span class="s1">&#39;2E86AB&#39;</span><span class="p">,</span> <span class="n">fill_type</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
    <span class="n">percent_format</span> <span class="o">=</span> <span class="s1">&#39;0.00%&#39;</span>
    
    <span class="c1"># Summary Sheet</span>
    <span class="n">ws_summary</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>
    <span class="n">ws_summary</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Summary&#39;</span>
    
    <span class="n">ws_summary</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Portfolio Performance Report&#39;</span>
    <span class="n">ws_summary</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ws_summary</span><span class="p">[</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Report Date: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
    
    <span class="c1"># Metrics</span>
    <span class="n">metrics_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;Metric&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Total Return&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;Benchmark Return&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;Max Drawdown&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]),</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics_data</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i</span>
        <span class="n">ws_summary</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="n">ws_summary</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;B</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ws_summary</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">header_font</span>
            <span class="n">ws_summary</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">header_fill</span>
            <span class="n">ws_summary</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;B</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">header_font</span>
            <span class="n">ws_summary</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;B</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">header_fill</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="o">!=</span> <span class="s1">&#39;Sharpe Ratio&#39;</span><span class="p">:</span>
            <span class="n">ws_summary</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;B</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">number_format</span> <span class="o">=</span> <span class="n">percent_format</span>
    
    <span class="n">ws_summary</span><span class="o">.</span><span class="n">column_dimensions</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">ws_summary</span><span class="o">.</span><span class="n">column_dimensions</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">15</span>
    
    <span class="c1"># Monthly Returns Sheet with conditional formatting</span>
    <span class="n">ws_monthly</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">create_sheet</span><span class="p">(</span><span class="s1">&#39;Monthly Returns&#39;</span><span class="p">)</span>
    <span class="n">monthly</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">ws_monthly</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Date&#39;</span>
    <span class="n">ws_monthly</span><span class="p">[</span><span class="s1">&#39;B1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Return&#39;</span>
    <span class="n">ws_monthly</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">header_font</span>
    <span class="n">ws_monthly</span><span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">header_fill</span>
    <span class="n">ws_monthly</span><span class="p">[</span><span class="s1">&#39;B1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">header_font</span>
    <span class="n">ws_monthly</span><span class="p">[</span><span class="s1">&#39;B1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">header_fill</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">monthly</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span>
        <span class="n">ws_monthly</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;A</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m&#39;</span><span class="p">)</span>
        <span class="n">ws_monthly</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;B</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
        <span class="n">ws_monthly</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;B</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">number_format</span> <span class="o">=</span> <span class="n">percent_format</span>
        
        <span class="c1"># Color code</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ws_monthly</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;B</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">PatternFill</span><span class="p">(</span>
                <span class="n">start_color</span><span class="o">=</span><span class="s1">&#39;C6EFCE&#39;</span><span class="p">,</span> <span class="n">end_color</span><span class="o">=</span><span class="s1">&#39;C6EFCE&#39;</span><span class="p">,</span> <span class="n">fill_type</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ws_monthly</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;B</span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">PatternFill</span><span class="p">(</span>
                <span class="n">start_color</span><span class="o">=</span><span class="s1">&#39;FFC7CE&#39;</span><span class="p">,</span> <span class="n">end_color</span><span class="o">=</span><span class="s1">&#39;FFC7CE&#39;</span><span class="p">,</span> <span class="n">fill_type</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
    
    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span>

<span class="k">if</span> <span class="n">EXCEL_AVAILABLE</span><span class="p">:</span>
    <span class="n">excel_file</span> <span class="o">=</span> <span class="n">generate_excel_report</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Excel report generated: </span><span class="si">{</span><span class="n">excel_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Excel generation skipped (install openpyxl to enable)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 13.3: Holdings Sheet Creator (Guided)</h3>
<p><strong>Your Task:</strong> Complete the function to create a formatted holdings sheet for an Excel report.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.3: Holdings Sheet Creator (Guided)</span>
<span class="k">def</span> <span class="nf">create_holdings_dataframe</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a holdings DataFrame with current values and metrics.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    weights : dict</span>
<span class="sd">        Asset weights {symbol: weight}</span>
<span class="sd">    prices : DataFrame</span>
<span class="sd">        Historical prices</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    DataFrame with holdings information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># TODO: Get the last price for this symbol</span>
        <span class="n">last_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># TODO: Calculate 1-day return</span>
        <span class="n">daily_return</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># TODO: Calculate YTD return</span>
        <span class="n">year_start</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">][</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ytd_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_price</span> <span class="o">/</span> <span class="n">year_start</span><span class="p">)</span> <span class="o">-</span> <span class="n">______</span>
        
        <span class="n">holdings</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;Weight&#39;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
            <span class="s1">&#39;Price&#39;</span><span class="p">:</span> <span class="n">last_price</span><span class="p">,</span>
            <span class="s1">&#39;1D Return&#39;</span><span class="p">:</span> <span class="n">daily_return</span><span class="p">,</span>
            <span class="s1">&#39;YTD Return&#39;</span><span class="p">:</span> <span class="n">ytd_return</span>
        <span class="p">})</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">holdings</span><span class="p">)</span>

<span class="c1"># Test your function</span>
<span class="c1"># holdings_df = create_holdings_dataframe(weights, prices)</span>
<span class="c1"># print(holdings_df)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_holdings_dataframe</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a holdings DataFrame with current values and metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">holdings</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Get the last price for this symbol</span>
        <span class="n">last_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Calculate 1-day return</span>
        <span class="n">daily_return</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Calculate YTD return</span>
        <span class="n">year_start</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">][</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ytd_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_price</span> <span class="o">/</span> <span class="n">year_start</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">holdings</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;Weight&#39;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
            <span class="s1">&#39;Price&#39;</span><span class="p">:</span> <span class="n">last_price</span><span class="p">,</span>
            <span class="s1">&#39;1D Return&#39;</span><span class="p">:</span> <span class="n">daily_return</span><span class="p">,</span>
            <span class="s1">&#39;YTD Return&#39;</span><span class="p">:</span> <span class="n">ytd_return</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">holdings</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">holdings_df</span> <span class="o">=</span> <span class="n">create_holdings_dataframe</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">holdings_df</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 13.4: Custom Report Builder (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that creates a DataFrame containing a quarterly performance summary:
- Quarterly returns (compound daily returns)
- Quarterly volatility (annualized)
- Quarterly Sharpe ratio
- Best and worst months within each quarter</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.4: Custom Report Builder (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_quarterly_summary</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create quarterly performance summary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Quarterly returns</span>
    <span class="n">quarterly_return</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Quarterly volatility (annualized)</span>
    <span class="n">quarterly_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="c1"># Quarterly Sharpe</span>
    <span class="n">quarterly_sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="n">quarterly_vol</span>

    <span class="c1"># Monthly returns for best/worst</span>
    <span class="n">monthly</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Best/worst months per quarter</span>
    <span class="n">best_months</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">worst_months</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">q_end</span> <span class="ow">in</span> <span class="n">quarterly_return</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">q_start</span> <span class="o">=</span> <span class="n">q_end</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">QuarterEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">q_months</span> <span class="o">=</span> <span class="n">monthly</span><span class="p">[(</span><span class="n">monthly</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">q_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">monthly</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">q_end</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_months</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">best_months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_months</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">worst_months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_months</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">worst_months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Quarterly Return&#39;</span><span class="p">:</span> <span class="n">quarterly_return</span><span class="p">,</span>
        <span class="s1">&#39;Volatility&#39;</span><span class="p">:</span> <span class="n">quarterly_vol</span><span class="p">,</span>
        <span class="s1">&#39;Sharpe&#39;</span><span class="p">:</span> <span class="n">quarterly_sharpe</span><span class="p">,</span>
        <span class="s1">&#39;Best Month&#39;</span><span class="p">:</span> <span class="n">best_months</span><span class="p">,</span>
        <span class="s1">&#39;Worst Month&#39;</span><span class="p">:</span> <span class="n">worst_months</span>
    <span class="p">})</span>

<span class="c1"># Test</span>
<span class="n">quarterly</span> <span class="o">=</span> <span class="n">create_quarterly_summary</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">quarterly</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-13.4'></a></p>
<h1>Section 13.4: Performance Tear Sheets</h1>
<p>Tear sheets provide a one-page summary of strategy performance for quick evaluation.</p>
<p><strong>In this section, you will learn:</strong>
- Tear sheet design principles
- Multi-panel layouts
- Key visualizations</p></div>
<div class="md-cell"><h2>13.4.1 Creating Professional Tear Sheets</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">create_tear_sheet</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                      <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a professional performance tear sheet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate metrics</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_report_metrics</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">)</span>
    
    <span class="c1"># Create figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="si">}</span><span class="s1"> Performance Tear Sheet&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
    
    <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Row 1: Key Metrics</span>
    <span class="n">ax_metrics</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">ax_metrics</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
    <span class="n">metrics_text</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Total Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%  |  &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Ann. Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;ann_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%  |  &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Volatility: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;ann_volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%  |  &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Sharpe: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">  |  &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Max DD: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
    <span class="p">)</span>
    <span class="n">ax_metrics</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">metrics_text</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax_metrics</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                   <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
                   <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">))</span>
    
    <span class="c1"># Row 2: Cumulative Returns</span>
    <span class="n">ax_cum</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">cum_port</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">cum_bench</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">benchmark_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    
    <span class="n">ax_cum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_port</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_port</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2E86AB&#39;</span><span class="p">)</span>
    <span class="n">ax_cum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_bench</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_bench</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Benchmark&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> 
               <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax_cum</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
    <span class="n">ax_cum</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
    <span class="n">ax_cum</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax_cum</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Row 3: Drawdown</span>
    <span class="n">ax_dd</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_port</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
    
    <span class="n">ax_dd</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax_dd</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax_dd</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
    <span class="n">ax_dd</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
    <span class="n">ax_dd</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Row 4: Distribution and Allocation</span>
    <span class="n">ax_dist</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ax_dist</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">ax_dist</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
                   <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="n">ax_dist</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Return (%)&#39;</span><span class="p">)</span>
    <span class="n">ax_dist</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
    <span class="n">ax_dist</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Return Distribution&#39;</span><span class="p">)</span>
    <span class="n">ax_dist</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax_dist</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">ax_pie</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ax_pie</span><span class="o">.</span><span class="n">pie</span><span class="p">([</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span>
              <span class="n">colors</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set3</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">))))</span>
    <span class="n">ax_pie</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Current Allocation&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_tearsheet.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">filename</span>

<span class="c1"># Create tear sheet</span>
<span class="n">tearsheet</span> <span class="o">=</span> <span class="n">create_tear_sheet</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="s1">&#39;Balanced Portfolio&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tear sheet saved as: </span><span class="si">{</span><span class="n">tearsheet</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 13.5: Risk Metrics Panel (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that creates a risk metrics visualization panel:
- Rolling volatility plot (21-day window)
- VaR histogram with 95% and 99% VaR lines marked
- Rolling beta to benchmark (63-day window)
- Return the figure object</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.5: Risk Metrics Panel (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_risk_panel</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a risk metrics visualization panel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="c1"># 1. Rolling volatility</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">rolling_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_vol</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_vol</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;21-Day Rolling Volatility (%)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Volatility (%)&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># 2. VaR histogram</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">var_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">var_99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">var_95</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;95% VaR: </span><span class="si">{</span><span class="n">var_95</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">var_99</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;99% VaR: </span><span class="si">{</span><span class="n">var_99</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Return Distribution with VaR&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Return (%)&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># 3. Rolling beta</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">rolling_cov</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">benchmark_returns</span><span class="p">)</span>
    <span class="n">rolling_var</span> <span class="o">=</span> <span class="n">benchmark_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
    <span class="n">rolling_beta</span> <span class="o">=</span> <span class="n">rolling_cov</span> <span class="o">/</span> <span class="n">rolling_var</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_beta</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_beta</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;63-Day Rolling Beta&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Beta&#39;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># 4. Drawdown underwater chart</span>
    <span class="n">ax4</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cum_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_returns</span> <span class="o">-</span> <span class="n">cum_returns</span><span class="o">.</span><span class="n">cummax</span><span class="p">())</span> <span class="o">/</span> <span class="n">cum_returns</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Test</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">create_risk_panel</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 13.6: Complete Reporting Suite (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a <code>ReportGenerator</code> class that:
- Takes portfolio returns, benchmark returns, and weights in the constructor
- Has a <code>calculate_all_metrics()</code> method returning a dictionary of metrics
- Has a <code>print_summary()</code> method that prints a formatted console report
- Has a <code>create_charts()</code> method that creates and saves performance/drawdown charts
- Has a <code>generate_report()</code> method that calls all above methods in sequence</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 13.6: Complete Reporting Suite (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ReportGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete financial reporting suite.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                 <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">portfolio_returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark_returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">strategy_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">calculate_all_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate comprehensive metrics.&quot;&quot;&quot;</span>
        <span class="n">cum_port</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">cum_bench</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

        <span class="n">total_return</span> <span class="o">=</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">bench_return</span> <span class="o">=</span> <span class="n">cum_bench</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">n_years</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">252</span>

        <span class="n">ann_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">total_return</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n_years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">ann_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">ann_return</span> <span class="o">/</span> <span class="n">ann_vol</span>

        <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="p">((</span><span class="n">cum_port</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;benchmark_return&#39;</span><span class="p">:</span> <span class="n">bench_return</span><span class="p">,</span>
            <span class="s1">&#39;active_return&#39;</span><span class="p">:</span> <span class="n">total_return</span> <span class="o">-</span> <span class="n">bench_return</span><span class="p">,</span>
            <span class="s1">&#39;ann_return&#39;</span><span class="p">:</span> <span class="n">ann_return</span><span class="p">,</span>
            <span class="s1">&#39;ann_volatility&#39;</span><span class="p">:</span> <span class="n">ann_vol</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;start_date&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;end_date&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print formatted summary report.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_all_metrics</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> Performance Report&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Period: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RETURNS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Return:      </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Benchmark Return:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annualized Return: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;ann_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RISK&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility:        </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;ann_volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Drawdown:      </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe Ratio:      </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_charts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create and save performance charts.&quot;&quot;&quot;</span>
        <span class="c1"># Performance chart</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

        <span class="n">cum_port</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">cum_bench</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_port</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_port</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_bench</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_bench</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Benchmark&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_port</span> <span class="o">-</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">cummax</span><span class="p">())</span> <span class="o">/</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_charts.png&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate complete report package.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_all_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
        <span class="n">chart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_charts</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charts saved: </span><span class="si">{</span><span class="n">chart_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>

<span class="c1"># Test</span>
<span class="n">reporter</span> <span class="o">=</span> <span class="n">ReportGenerator</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="s1">&#39;Balanced Growth&#39;</span><span class="p">)</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Complete Reporting Suite</h1>
<p>Build a comprehensive reporting system that combines all concepts from this module.</p>
<p><strong>Your Challenge:</strong></p>
<p>Build a <code>ReportingSuite</code> class that includes:
1. Comprehensive metrics calculation
2. Console summary printing
3. Chart generation
4. Tear sheet creation
5. Optional PDF and Excel generation</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ReportingSuite</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Professional financial reporting system.</span>

<span class="sd">    Features:</span>
<span class="sd">    - Comprehensive metrics calculation</span>
<span class="sd">    - Console summary reports</span>
<span class="sd">    - Chart generation</span>
<span class="sd">    - Performance tear sheets</span>
<span class="sd">    - Optional PDF and Excel reports</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                 <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">portfolio_returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark_returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">strategy_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate all performance metrics.&quot;&quot;&quot;</span>
        <span class="n">cum_port</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">cum_bench</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

        <span class="n">total_return</span> <span class="o">=</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">bench_return</span> <span class="o">=</span> <span class="n">cum_bench</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">n_years</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">252</span>

        <span class="n">ann_return</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">total_return</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n_years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">ann_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="n">ann_return</span> <span class="o">/</span> <span class="n">ann_vol</span>

        <span class="c1"># Downside metrics</span>
        <span class="n">downside</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">sortino</span> <span class="o">=</span> <span class="n">ann_return</span> <span class="o">/</span> <span class="p">(</span><span class="n">downside</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>

        <span class="c1"># Drawdown</span>
        <span class="n">running_max</span> <span class="o">=</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_port</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="c1"># Relative metrics</span>
        <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span>
        <span class="n">tracking_error</span> <span class="o">=</span> <span class="n">active</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
        <span class="n">info_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">active</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="n">tracking_error</span>

        <span class="c1"># Beta/Alpha</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">ann_return</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">total_return</span><span class="p">,</span>
            <span class="s1">&#39;benchmark_return&#39;</span><span class="p">:</span> <span class="n">bench_return</span><span class="p">,</span>
            <span class="s1">&#39;active_return&#39;</span><span class="p">:</span> <span class="n">total_return</span> <span class="o">-</span> <span class="n">bench_return</span><span class="p">,</span>
            <span class="s1">&#39;ann_return&#39;</span><span class="p">:</span> <span class="n">ann_return</span><span class="p">,</span>
            <span class="s1">&#39;ann_volatility&#39;</span><span class="p">:</span> <span class="n">ann_vol</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;sortino_ratio&#39;</span><span class="p">:</span> <span class="n">sortino</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span><span class="p">,</span>
            <span class="s1">&#39;tracking_error&#39;</span><span class="p">:</span> <span class="n">tracking_error</span><span class="p">,</span>
            <span class="s1">&#39;information_ratio&#39;</span><span class="p">:</span> <span class="n">info_ratio</span><span class="p">,</span>
            <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta</span><span class="p">,</span>
            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span>
            <span class="s1">&#39;var_95&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;start_date&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;end_date&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print formatted summary to console.&quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> Performance Report&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Period: </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RETURN METRICS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Return:      </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Benchmark Return:  </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Active Return:     </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;active_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annualized Return: </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;ann_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RISK METRICS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility:        </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;ann_volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Drawdown:      </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  95% VaR:           </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;var_95&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Tracking Error:    </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;tracking_error&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RISK-ADJUSTED&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe Ratio:      </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sortino Ratio:     </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;sortino_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Info Ratio:        </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;information_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_charts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate performance and drawdown charts.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

        <span class="n">cum_port</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">cum_bench</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_port</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_port</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2E86AB&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_bench</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cum_bench</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Benchmark&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> - Cumulative Returns&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_port</span> <span class="o">-</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">cummax</span><span class="p">())</span> <span class="o">/</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_charts.png&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">create_tear_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate one-page tear sheet.&quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> Tear Sheet&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>

        <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Metrics summary</span>
        <span class="n">ax_sum</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">ax_sum</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return: </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%  |  &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Vol: </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;ann_volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%  |  &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Sharpe: </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">  |  &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Max DD: </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">ax_sum</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                   <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">))</span>

        <span class="c1"># Cumulative returns</span>
        <span class="n">ax_cum</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">cum_port</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">cum_bench</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">ax_cum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_port</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax_cum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cum_bench</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Benchmark&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax_cum</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
        <span class="n">ax_cum</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax_cum</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Drawdown</span>
        <span class="n">ax_dd</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum_port</span> <span class="o">-</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">cummax</span><span class="p">())</span> <span class="o">/</span> <span class="n">cum_port</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">ax_dd</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dd</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax_dd</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
        <span class="n">ax_dd</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
        <span class="n">ax_dd</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Distribution</span>
        <span class="n">ax_hist</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">ax_hist</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
        <span class="n">ax_hist</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax_hist</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Return Distribution&#39;</span><span class="p">)</span>
        <span class="n">ax_hist</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Daily Return (%)&#39;</span><span class="p">)</span>
        <span class="n">ax_hist</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Allocation</span>
        <span class="n">ax_pie</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax_pie</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">labels</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                  <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set3</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">))))</span>
        <span class="n">ax_pie</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Allocation&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">_tearsheet.png&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">generate_all_reports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate complete report package.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating reports for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
        <span class="n">chart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_charts</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="n">tearsheet_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_tear_sheet</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reports generated:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Charts: </span><span class="si">{</span><span class="n">chart_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Tear Sheet: </span><span class="si">{</span><span class="n">tearsheet_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Report generation complete!&quot;</span><span class="p">)</span>

<span class="c1"># Demo</span>
<span class="n">suite</span> <span class="o">=</span> <span class="n">ReportingSuite</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="s1">&#39;Balanced Growth&#39;</span><span class="p">)</span>
<span class="n">suite</span><span class="o">.</span><span class="n">generate_all_reports</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Solution - Module Project</span>
<span class="k">class</span> <span class="nc">ReportingSuite</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Professional financial reporting system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                 <span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Portfolio&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">portfolio_returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark_returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">strategy_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate all performance metrics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">calculate_report_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print formatted summary to console.&quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> Performance Report&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Period: </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RETURN METRICS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Return:      </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Benchmark Return:  </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;benchmark_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annualized Return: </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;ann_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RISK METRICS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility:        </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;ann_volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Drawdown:      </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RISK-ADJUSTED&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe Ratio:      </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sortino Ratio:     </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;sortino_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">generate_all_reports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate complete report package.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating reports for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
        <span class="n">create_tear_sheet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Report generation complete!&quot;</span><span class="p">)</span>

<span class="c1"># Demo</span>
<span class="n">suite</span> <span class="o">=</span> <span class="n">ReportingSuite</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="s1">&#39;Balanced Growth&#39;</span><span class="p">)</span>
<span class="n">suite</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Report Design Principles</h3>
<ul>
<li>Structure reports with executive summary first</li>
<li>Tailor content to audience (client vs internal vs regulatory)</li>
<li>Include benchmarks for context</li>
</ul>
<h3>2. PDF Generation</h3>
<ul>
<li>ReportLab provides professional PDF output</li>
<li>Use tables for metrics, images for charts</li>
<li>Include proper disclaimers</li>
</ul>
<h3>3. Excel Reports</h3>
<ul>
<li>openpyxl enables formatted workbooks</li>
<li>Color-code positive/negative values</li>
<li>Separate sheets for different data views</li>
</ul>
<h3>4. Tear Sheets</h3>
<ul>
<li>One-page summary of strategy performance</li>
<li>Include all key metrics and visualizations</li>
<li>Useful for marketing and quick reviews</li>
</ul></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 14: Rebalancing &amp; Execution</strong>, we'll explore:
- Rebalancing strategies (calendar, threshold)
- Transaction cost analysis
- Tax-loss harvesting
- Implementation shortfall</p>
<hr />
<p><em>Congratulations on completing Module 13!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="14"><div class="md-cell module-header"><h1>Module 14: Rebalancing &amp; Execution</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 5: Production &amp; Infrastructure</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Implement calendar and threshold rebalancing strategies</li>
<li>Model and minimize transaction costs</li>
<li>Apply tax-loss harvesting techniques</li>
<li>Measure implementation shortfall and execution quality</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 5, 11</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-14.1">Section 14.1: Rebalancing Strategies</a></li>
<li><a href="#section-14.2">Section 14.2: Transaction Cost Analysis</a></li>
<li><a href="#section-14.3">Section 14.3: Tax-Loss Harvesting</a></li>
<li><a href="#section-14.4">Section 14.4: Implementation Shortfall</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 14: Rebalancing &amp; Execution - Ready!&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>Load Data</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download data</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;AGG&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">data</span>

<span class="n">returns</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Target allocation</span>
<span class="n">target_weights</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.50</span><span class="p">,</span> <span class="s1">&#39;AGG&#39;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span><span class="si">}</span><span class="s1"> trading days&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-14.1'></a></p>
<h1>Section 14.1: Rebalancing Strategies</h1>
<p>Over time, assets with higher returns grow to dominate your portfolio, increasing concentration risk and drifting away from your intended allocation.</p>
<p><strong>In this section, you will learn:</strong>
- Calendar rebalancing (fixed schedule)
- Threshold rebalancing (drift-triggered)
- Hybrid approaches</p></div>
<div class="md-cell"><h2>14.1.1 Portfolio Drift Simulation</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">simulate_portfolio_drift</span><span class="p">(</span><span class="n">initial_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">returns_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                            <span class="n">rebalance_frequency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate how portfolio weights drift over time.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    initial_weights : dict</span>
<span class="sd">        Target weights for each asset</span>
<span class="sd">    returns_df : DataFrame</span>
<span class="sd">        Daily returns for each asset</span>
<span class="sd">    rebalance_frequency : str</span>
<span class="sd">        &#39;M&#39; for monthly, &#39;Q&#39; for quarterly, None for never</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">assets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">initial_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">returns_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">assets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">current_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">initial_weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">rebalance_frequency</span><span class="p">:</span>
        <span class="n">rebalance_dates</span> <span class="o">=</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rebalance_frequency</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rebalance_dates</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_weights</span>
        <span class="n">day_returns</span> <span class="o">=</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="n">assets</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">growth</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">day_returns</span>
        <span class="n">new_values</span> <span class="o">=</span> <span class="n">current_weights</span> <span class="o">*</span> <span class="n">growth</span>
        <span class="n">current_weights</span> <span class="o">=</span> <span class="n">new_values</span> <span class="o">/</span> <span class="n">new_values</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">rebalance_dates</span><span class="p">:</span>
            <span class="n">current_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">initial_weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">weights</span>

<span class="c1"># Simulate drift scenarios</span>
<span class="n">weights_never</span> <span class="o">=</span> <span class="n">simulate_portfolio_drift</span><span class="p">(</span><span class="n">target_weights</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">weights_monthly</span> <span class="o">=</span> <span class="n">simulate_portfolio_drift</span><span class="p">(</span><span class="n">target_weights</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span>
<span class="n">weights_quarterly</span> <span class="o">=</span> <span class="n">simulate_portfolio_drift</span><span class="p">(</span><span class="n">target_weights</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final SPY weight by rebalancing approach:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Never rebalanced: </span><span class="si">{</span><span class="n">weights_never</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Monthly: </span><span class="si">{</span><span class="n">weights_monthly</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Quarterly: </span><span class="si">{</span><span class="n">weights_quarterly</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>14.1.2 Threshold Rebalancing</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ThresholdRebalancer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rebalances when any asset drifts beyond a threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span> <span class="o">=</span> <span class="n">target_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">target_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">needs_rebalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if any asset has drifted beyond threshold.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">asset</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">current_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
                 <span class="n">transaction_cost</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Backtest the threshold rebalancing strategy.&quot;&quot;&quot;</span>
        <span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">initial_value</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">portfolio_value</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">}</span>
        
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_costs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_rebalances</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">:</span>
                <span class="n">holdings</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="n">asset</span><span class="p">])</span>
            
            <span class="n">portfolio_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">holdings</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">current_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">holdings</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">/</span><span class="n">portfolio_value</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">}</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_rebalance</span><span class="p">(</span><span class="n">current_weights</span><span class="p">):</span>
                <span class="n">turnover</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_weights</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> 
                              <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">)</span> <span class="o">*</span> <span class="n">portfolio_value</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">turnover</span> <span class="o">*</span> <span class="n">transaction_cost</span>
                <span class="n">total_costs</span> <span class="o">+=</span> <span class="n">cost</span>
                <span class="n">num_rebalances</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="n">portfolio_value</span> <span class="o">-=</span> <span class="n">cost</span>
                <span class="n">holdings</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">portfolio_value</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">}</span>
            
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">portfolio_value</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">),</span> <span class="n">total_costs</span><span class="p">,</span> <span class="n">num_rebalances</span>

<span class="c1"># Compare thresholds</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Threshold Rebalancing Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">thresh</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">]:</span>
    <span class="n">rebalancer</span> <span class="o">=</span> <span class="n">ThresholdRebalancer</span><span class="p">(</span><span class="n">target_weights</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">thresh</span><span class="p">)</span>
    <span class="n">values</span><span class="p">,</span> <span class="n">costs</span><span class="p">,</span> <span class="n">num_rebal</span> <span class="o">=</span> <span class="n">rebalancer</span><span class="o">.</span><span class="n">backtest</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">thresh</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> Threshold: Final=$</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">, &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Rebalances=</span><span class="si">{</span><span class="n">num_rebal</span><span class="si">}</span><span class="s2">, Costs=$</span><span class="si">{</span><span class="n">costs</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 14.1: Drift Calculator (Guided)</h3>
<p><strong>Your Task:</strong> Complete the function to calculate portfolio drift metrics.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.1: Drift Calculator (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_drift_metrics</span><span class="p">(</span><span class="n">current_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">target_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate portfolio drift from target allocation.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    current_weights : dict</span>
<span class="sd">        Current portfolio weights</span>
<span class="sd">    target_weights : dict</span>
<span class="sd">        Target portfolio weights</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict with drift metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">drifts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">target_weights</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">current_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target_weights</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span>
        <span class="c1"># TODO: Calculate absolute drift</span>
        <span class="n">drifts</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span> <span class="o">-</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Find the maximum absolute drift</span>
    <span class="n">max_drift</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">______</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drifts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="c1"># TODO: Calculate total absolute drift (sum of all absolute drifts)</span>
    <span class="n">total_drift</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drifts</span><span class="o">.</span><span class="n">______</span><span class="p">())</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;drifts&#39;</span><span class="p">:</span> <span class="n">drifts</span><span class="p">,</span>
        <span class="s1">&#39;max_drift&#39;</span><span class="p">:</span> <span class="n">max_drift</span><span class="p">,</span>
        <span class="s1">&#39;total_drift&#39;</span><span class="p">:</span> <span class="n">total_drift</span>
    <span class="p">}</span>

<span class="c1"># Test your function</span>
<span class="c1"># current = {&#39;SPY&#39;: 0.55, &#39;AGG&#39;: 0.25, &#39;GLD&#39;: 0.12, &#39;VNQ&#39;: 0.08}</span>
<span class="c1"># metrics = calculate_drift_metrics(current, target_weights)</span>
<span class="c1"># print(f&quot;Max drift: {metrics[&#39;max_drift&#39;]:.1%}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_drift_metrics</span><span class="p">(</span><span class="n">current_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">target_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate portfolio drift from target allocation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">drifts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">target_weights</span><span class="p">:</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">current_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target_weights</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span>
        <span class="c1"># Calculate absolute drift</span>
        <span class="n">drifts</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span> <span class="o">-</span> <span class="n">target</span>

    <span class="c1"># Find the maximum absolute drift</span>
    <span class="n">max_drift</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drifts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Calculate total absolute drift</span>
    <span class="n">total_drift</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drifts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;drifts&#39;</span><span class="p">:</span> <span class="n">drifts</span><span class="p">,</span>
        <span class="s1">&#39;max_drift&#39;</span><span class="p">:</span> <span class="n">max_drift</span><span class="p">,</span>
        <span class="s1">&#39;total_drift&#39;</span><span class="p">:</span> <span class="n">total_drift</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">current</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mf">0.55</span><span class="p">,</span> <span class="s1">&#39;AGG&#39;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">}</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">calculate_drift_metrics</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">target_weights</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max drift: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;max_drift&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total drift: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_drift&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-14.2'></a></p>
<h1>Section 14.2: Transaction Cost Analysis</h1>
<p>Transaction costs can significantly impact portfolio performance.</p>
<p><strong>In this section, you will learn:</strong>
- Types of transaction costs (explicit and implicit)
- Market impact modeling
- Cost-aware portfolio construction</p></div>
<div class="md-cell"><h2>14.2.1 Transaction Cost Model</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TransactionCostModel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive transaction cost estimator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commission_per_share</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span>
                 <span class="n">commission_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission_per_share</span> <span class="o">=</span> <span class="n">commission_per_share</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission_min</span> <span class="o">=</span> <span class="n">commission_min</span>
    
    <span class="k">def</span> <span class="nf">estimate_spread_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">spread_bps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Estimate bid-ask spread cost (half spread per transaction).&quot;&quot;&quot;</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">price</span> <span class="o">*</span> <span class="p">(</span><span class="n">spread_bps</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spread</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="k">def</span> <span class="nf">estimate_market_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">avg_daily_volume</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                               <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate market impact using square-root model.</span>
<span class="sd">        Impact = sigma * sqrt(Q/V)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">participation_rate</span> <span class="o">=</span> <span class="n">trade_size</span> <span class="o">/</span> <span class="n">avg_daily_volume</span>
        <span class="n">impact_pct</span> <span class="o">=</span> <span class="n">volatility</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">participation_rate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">price</span> <span class="o">*</span> <span class="n">impact_pct</span>
    
    <span class="k">def</span> <span class="nf">total_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shares</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                   <span class="n">avg_daily_volume</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">,</span>
                   <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total transaction cost.&quot;&quot;&quot;</span>
        <span class="n">trade_value</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">*</span> <span class="n">price</span>
        
        <span class="n">commission</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shares</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission_per_share</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission_min</span><span class="p">)</span>
        <span class="n">spread_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_spread_cost</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="o">*</span> <span class="n">shares</span>
        <span class="n">impact_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_market_impact</span><span class="p">(</span>
            <span class="n">shares</span><span class="p">,</span> <span class="n">avg_daily_volume</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">volatility</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">shares</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;commission&#39;</span><span class="p">:</span> <span class="n">commission</span><span class="p">,</span>
            <span class="s1">&#39;spread&#39;</span><span class="p">:</span> <span class="n">spread_cost</span><span class="p">,</span>
            <span class="s1">&#39;market_impact&#39;</span><span class="p">:</span> <span class="n">impact_cost</span><span class="p">,</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">commission</span> <span class="o">+</span> <span class="n">spread_cost</span> <span class="o">+</span> <span class="n">impact_cost</span><span class="p">,</span>
            <span class="s1">&#39;total_bps&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">commission</span> <span class="o">+</span> <span class="n">spread_cost</span> <span class="o">+</span> <span class="n">impact_cost</span><span class="p">)</span> <span class="o">/</span> <span class="n">trade_value</span> <span class="o">*</span> <span class="mi">10000</span>
        <span class="p">}</span>

<span class="c1"># Example</span>
<span class="n">cost_model</span> <span class="o">=</span> <span class="n">TransactionCostModel</span><span class="p">()</span>
<span class="n">costs</span> <span class="o">=</span> <span class="n">cost_model</span><span class="o">.</span><span class="n">total_cost</span><span class="p">(</span><span class="n">shares</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">avg_daily_volume</span><span class="o">=</span><span class="mi">5_000_000</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transaction Cost Breakdown (1000 shares @ $150)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">45</span><span class="p">)</span>
<span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">costs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;total_bps&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 14.2: Break-Even Holding Period (Guided)</h3>
<p><strong>Your Task:</strong> Complete the function to calculate how long you need to hold a position for expected returns to overcome transaction costs.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.2: Break-Even Holding Period (Guided)</span>
<span class="k">def</span> <span class="nf">break_even_holding_period</span><span class="p">(</span><span class="n">expected_annual_return</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                              <span class="n">round_trip_cost</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate minimum holding period for returns to exceed costs.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    expected_annual_return : float</span>
<span class="sd">        Expected annual return (e.g., 0.10 for 10%)</span>
<span class="sd">    round_trip_cost : float</span>
<span class="sd">        Total cost to buy and sell (e.g., 0.002 for 20 bps)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float : Holding period in trading days</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate daily expected return (252 trading days/year)</span>
    <span class="n">daily_return</span> <span class="o">=</span> <span class="n">expected_annual_return</span> <span class="o">/</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Break-even when daily_return * days = round_trip_cost</span>
    <span class="n">break_even_days</span> <span class="o">=</span> <span class="n">round_trip_cost</span> <span class="o">/</span> <span class="n">______</span>
    
    <span class="k">return</span> <span class="n">break_even_days</span>

<span class="c1"># Test your function</span>
<span class="c1"># days = break_even_holding_period(0.10, 0.002)</span>
<span class="c1"># print(f&quot;Break-even: {days:.1f} days&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">break_even_holding_period</span><span class="p">(</span><span class="n">expected_annual_return</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                              <span class="n">round_trip_cost</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate minimum holding period for returns to exceed costs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate daily expected return (252 trading days/year)</span>
    <span class="n">daily_return</span> <span class="o">=</span> <span class="n">expected_annual_return</span> <span class="o">/</span> <span class="mi">252</span>

    <span class="c1"># Break-even when daily_return * days = round_trip_cost</span>
    <span class="n">break_even_days</span> <span class="o">=</span> <span class="n">round_trip_cost</span> <span class="o">/</span> <span class="n">daily_return</span>

    <span class="k">return</span> <span class="n">break_even_days</span>

<span class="c1"># Test</span>
<span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="s2">&quot;Stock 10</span><span class="si">% r</span><span class="s2">eturn, 20 bps cost&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">,</span> <span class="s2">&quot;Growth 20</span><span class="si">% r</span><span class="s2">eturn, 20 bps cost&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s2">&quot;Bond 5</span><span class="si">% r</span><span class="s2">eturn, 10 bps cost&quot;</span><span class="p">)</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">ret</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
    <span class="n">days</span> <span class="o">=</span> <span class="n">break_even_holding_period</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">days</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> days (</span><span class="si">{</span><span class="n">days</span><span class="o">/</span><span class="mi">21</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> months)&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-14.3'></a></p>
<h1>Section 14.3: Tax-Loss Harvesting</h1>
<p>Tax-loss harvesting strategically realizes losses to offset gains and reduce tax liability.</p>
<p><strong>In this section, you will learn:</strong>
- Identifying harvest opportunities
- Wash sale rule compliance
- Calculating tax benefits</p></div>
<div class="md-cell"><h2>14.3.1 Tax-Loss Harvesting System</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TaxLossHarvester</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements tax-loss harvesting strategy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tax_rate_short</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.37</span><span class="p">,</span>
                 <span class="n">tax_rate_long</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tax_rate_short</span> <span class="o">=</span> <span class="n">tax_rate_short</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tax_rate_long</span> <span class="o">=</span> <span class="n">tax_rate_long</span>
    
    <span class="k">def</span> <span class="nf">identify_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                               <span class="n">min_loss_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find positions with harvestable losses.</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        positions : list of dict</span>
<span class="sd">            Each has: symbol, cost_basis, current_value, purchase_date</span>
<span class="sd">        min_loss_pct : float</span>
<span class="sd">            Minimum loss percentage to trigger harvest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
            <span class="n">gain_loss</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;current_value&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;cost_basis&#39;</span><span class="p">]</span>
            <span class="n">gain_loss_pct</span> <span class="o">=</span> <span class="n">gain_loss</span> <span class="o">/</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;cost_basis&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">gain_loss_pct</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">min_loss_pct</span><span class="p">:</span>
                <span class="n">holding_period</span> <span class="o">=</span> <span class="p">(</span><span class="n">today</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;purchase_date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">days</span>
                <span class="n">is_long_term</span> <span class="o">=</span> <span class="n">holding_period</span> <span class="o">&gt;=</span> <span class="mi">365</span>
                
                <span class="n">tax_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_rate_long</span> <span class="k">if</span> <span class="n">is_long_term</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">tax_rate_short</span>
                <span class="n">tax_benefit</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">gain_loss</span><span class="p">)</span> <span class="o">*</span> <span class="n">tax_rate</span>
                
                <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">gain_loss</span><span class="p">,</span>
                    <span class="s1">&#39;loss_pct&#39;</span><span class="p">:</span> <span class="n">gain_loss_pct</span><span class="p">,</span>
                    <span class="s1">&#39;holding_days&#39;</span><span class="p">:</span> <span class="n">holding_period</span><span class="p">,</span>
                    <span class="s1">&#39;is_long_term&#39;</span><span class="p">:</span> <span class="n">is_long_term</span><span class="p">,</span>
                    <span class="s1">&#39;tax_benefit&#39;</span><span class="p">:</span> <span class="n">tax_benefit</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">opportunities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tax_benefit&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Example positions</span>
<span class="n">positions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;cost_basis&#39;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="mi">65000</span><span class="p">,</span>
     <span class="s1">&#39;purchase_date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)},</span>
    <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;cost_basis&#39;</span><span class="p">:</span> <span class="mi">40000</span><span class="p">,</span> <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="mi">38000</span><span class="p">,</span>
     <span class="s1">&#39;purchase_date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)},</span>
    <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="s1">&#39;NVDA&#39;</span><span class="p">,</span> <span class="s1">&#39;cost_basis&#39;</span><span class="p">:</span> <span class="mi">20000</span><span class="p">,</span> <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="mi">15000</span><span class="p">,</span>
     <span class="s1">&#39;purchase_date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">)},</span>
<span class="p">]</span>

<span class="n">harvester</span> <span class="o">=</span> <span class="n">TaxLossHarvester</span><span class="p">()</span>
<span class="n">opportunities</span> <span class="o">=</span> <span class="n">harvester</span><span class="o">.</span><span class="n">identify_opportunities</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tax-Loss Harvesting Opportunities&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">opp</span> <span class="ow">in</span> <span class="n">opportunities</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: Loss $</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;loss_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">), &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Tax Benefit $</span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;tax_benefit&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 14.3: Tax Benefit Calculator (Guided)</h3>
<p><strong>Your Task:</strong> Complete the function to calculate net tax savings from harvesting losses.</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.3: Tax Benefit Calculator (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_tax_savings</span><span class="p">(</span><span class="n">realized_gains</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">harvested_losses</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                          <span class="n">tax_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate tax savings from loss harvesting.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    realized_gains : float</span>
<span class="sd">        Total realized gains for the year</span>
<span class="sd">    harvested_losses : float</span>
<span class="sd">        Total harvested losses (positive number)</span>
<span class="sd">    tax_rate : float</span>
<span class="sd">        Applicable tax rate</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict with tax calculations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate tax without harvesting</span>
    <span class="n">tax_without</span> <span class="o">=</span> <span class="n">realized_gains</span> <span class="o">*</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Calculate net taxable gains after offsetting losses</span>
    <span class="n">net_gains</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">realized_gains</span> <span class="o">-</span> <span class="n">______</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate tax with harvesting</span>
    <span class="n">tax_with</span> <span class="o">=</span> <span class="n">net_gains</span> <span class="o">*</span> <span class="n">______</span>
    
    <span class="c1"># Calculate savings</span>
    <span class="n">savings</span> <span class="o">=</span> <span class="n">tax_without</span> <span class="o">-</span> <span class="n">tax_with</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;tax_without_harvesting&#39;</span><span class="p">:</span> <span class="n">tax_without</span><span class="p">,</span>
        <span class="s1">&#39;tax_with_harvesting&#39;</span><span class="p">:</span> <span class="n">tax_with</span><span class="p">,</span>
        <span class="s1">&#39;tax_savings&#39;</span><span class="p">:</span> <span class="n">savings</span>
    <span class="p">}</span>

<span class="c1"># Test your function</span>
<span class="c1"># result = calculate_tax_savings(realized_gains=15000, harvested_losses=5000)</span>
<span class="c1"># print(f&quot;Tax savings: ${result[&#39;tax_savings&#39;]:,.0f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_tax_savings</span><span class="p">(</span><span class="n">realized_gains</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">harvested_losses</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                          <span class="n">tax_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate tax savings from loss harvesting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate tax without harvesting</span>
    <span class="n">tax_without</span> <span class="o">=</span> <span class="n">realized_gains</span> <span class="o">*</span> <span class="n">tax_rate</span>

    <span class="c1"># Calculate net taxable gains after offsetting losses</span>
    <span class="n">net_gains</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">realized_gains</span> <span class="o">-</span> <span class="n">harvested_losses</span><span class="p">)</span>

    <span class="c1"># Calculate tax with harvesting</span>
    <span class="n">tax_with</span> <span class="o">=</span> <span class="n">net_gains</span> <span class="o">*</span> <span class="n">tax_rate</span>

    <span class="c1"># Calculate savings</span>
    <span class="n">savings</span> <span class="o">=</span> <span class="n">tax_without</span> <span class="o">-</span> <span class="n">tax_with</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;tax_without_harvesting&#39;</span><span class="p">:</span> <span class="n">tax_without</span><span class="p">,</span>
        <span class="s1">&#39;tax_with_harvesting&#39;</span><span class="p">:</span> <span class="n">tax_with</span><span class="p">,</span>
        <span class="s1">&#39;tax_savings&#39;</span><span class="p">:</span> <span class="n">savings</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_tax_savings</span><span class="p">(</span><span class="n">realized_gains</span><span class="o">=</span><span class="mi">15000</span><span class="p">,</span> <span class="n">harvested_losses</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tax without harvesting: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;tax_without_harvesting&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tax with harvesting: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;tax_with_harvesting&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tax savings: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;tax_savings&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 14.4: Hybrid Rebalancer (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a <code>HybridRebalancer</code> class that:
- Checks on a calendar schedule (e.g., monthly)
- Only rebalances if max drift exceeds a trigger threshold
- When rebalancing, only trades assets drifted beyond a trade threshold
- Returns the final portfolio value, total costs, and number of rebalances</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.4: Hybrid Rebalancer (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">HybridRebalancer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combines calendar checks with threshold triggers and partial rebalancing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">check_frequency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span>
                 <span class="n">trigger_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">trade_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span> <span class="o">=</span> <span class="n">target_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_frequency</span> <span class="o">=</span> <span class="n">check_frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_threshold</span> <span class="o">=</span> <span class="n">trigger_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_threshold</span> <span class="o">=</span> <span class="n">trade_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">target_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
                 <span class="n">transaction_cost</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">initial_value</span>
        <span class="n">holdings</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">portfolio_value</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">}</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_costs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_rebalances</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">check_dates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">returns_df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_frequency</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">:</span>
                <span class="n">holdings</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="n">asset</span><span class="p">])</span>

            <span class="n">portfolio_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">holdings</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">current_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">holdings</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">/</span><span class="n">portfolio_value</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">}</span>

            <span class="k">if</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">check_dates</span><span class="p">:</span>
                <span class="n">max_drift</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">current_weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> 
                               <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">max_drift</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_threshold</span><span class="p">:</span>
                    <span class="n">new_weights</span> <span class="o">=</span> <span class="n">current_weights</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">:</span>
                        <span class="n">drift</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_weights</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">asset</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">drift</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_threshold</span><span class="p">:</span>
                            <span class="n">new_weights</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">asset</span><span class="p">]</span>

                    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">new_weights</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="n">new_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">w</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">new_weights</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

                    <span class="n">turnover</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">new_weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_weights</span><span class="p">[</span><span class="n">a</span><span class="p">])</span> 
                                  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="n">turnover</span> <span class="o">*</span> <span class="n">portfolio_value</span> <span class="o">*</span> <span class="n">transaction_cost</span>
                    <span class="n">total_costs</span> <span class="o">+=</span> <span class="n">cost</span>
                    <span class="n">num_rebalances</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">portfolio_value</span> <span class="o">-=</span> <span class="n">cost</span>
                    <span class="n">holdings</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">new_weights</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="n">portfolio_value</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">}</span>

            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">portfolio_value</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">),</span> <span class="n">total_costs</span><span class="p">,</span> <span class="n">num_rebalances</span>

<span class="c1"># Test</span>
<span class="n">hybrid</span> <span class="o">=</span> <span class="n">HybridRebalancer</span><span class="p">(</span><span class="n">target_weights</span><span class="p">,</span> <span class="n">check_frequency</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span>
                          <span class="n">trigger_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">trade_threshold</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">values</span><span class="p">,</span> <span class="n">costs</span><span class="p">,</span> <span class="n">num_rebal</span> <span class="o">=</span> <span class="n">hybrid</span><span class="o">.</span><span class="n">backtest</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Value: $</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Costs: $</span><span class="si">{</span><span class="n">costs</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rebalances: </span><span class="si">{</span><span class="n">num_rebal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-14.4'></a></p>
<h1>Section 14.4: Implementation Shortfall</h1>
<p>Implementation shortfall measures the total cost of executing a trading decision.</p>
<p><strong>In this section, you will learn:</strong>
- Components of implementation shortfall
- VWAP and TWAP execution
- Measuring execution quality</p></div>
<div class="md-cell"><h2>14.4.1 Implementation Shortfall Analysis</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_implementation_shortfall</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate implementation shortfall components.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    order : dict</span>
<span class="sd">        decision_price, arrival_price, execution_price,</span>
<span class="sd">        close_price, shares_ordered, shares_filled, side</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">side_mult</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    
    <span class="c1"># Delay cost: decision to arrival</span>
    <span class="n">delay_cost</span> <span class="o">=</span> <span class="n">side_mult</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">order</span><span class="p">[</span><span class="s1">&#39;arrival_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;decision_price&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;decision_price&#39;</span><span class="p">]</span>
    
    <span class="c1"># Trading cost: arrival to execution</span>
    <span class="n">trading_cost</span> <span class="o">=</span> <span class="n">side_mult</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">order</span><span class="p">[</span><span class="s1">&#39;execution_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;arrival_price&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;decision_price&#39;</span><span class="p">]</span>
    
    <span class="c1"># Opportunity cost: unfilled portion</span>
    <span class="n">unfilled</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;shares_ordered&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;shares_filled&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">unfilled</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">opp_cost</span> <span class="o">=</span> <span class="n">side_mult</span> <span class="o">*</span> <span class="n">unfilled</span> <span class="o">/</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;shares_ordered&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">order</span><span class="p">[</span><span class="s1">&#39;close_price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;decision_price&#39;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;decision_price&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">opp_cost</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;delay_cost_bps&#39;</span><span class="p">:</span> <span class="n">delay_cost</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s1">&#39;trading_cost_bps&#39;</span><span class="p">:</span> <span class="n">trading_cost</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s1">&#39;opportunity_cost_bps&#39;</span><span class="p">:</span> <span class="n">opp_cost</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s1">&#39;total_shortfall_bps&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">delay_cost</span> <span class="o">+</span> <span class="n">trading_cost</span> <span class="o">+</span> <span class="n">opp_cost</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span>
    <span class="p">}</span>

<span class="c1"># Example</span>
<span class="n">order</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;decision_price&#39;</span><span class="p">:</span> <span class="mf">185.00</span><span class="p">,</span>
    <span class="s1">&#39;arrival_price&#39;</span><span class="p">:</span> <span class="mf">185.20</span><span class="p">,</span>
    <span class="s1">&#39;execution_price&#39;</span><span class="p">:</span> <span class="mf">185.45</span><span class="p">,</span>
    <span class="s1">&#39;close_price&#39;</span><span class="p">:</span> <span class="mf">186.00</span><span class="p">,</span>
    <span class="s1">&#39;shares_ordered&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="s1">&#39;shares_filled&#39;</span><span class="p">:</span> <span class="mi">1000</span>
<span class="p">}</span>

<span class="n">shortfall</span> <span class="o">=</span> <span class="n">calculate_implementation_shortfall</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Implementation Shortfall&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">shortfall</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 14.5: Slippage Calculator (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that calculates slippage for a list of trades:
- For buys: slippage = (actual - expected) / expected
- For sells: slippage = (expected - actual) / expected
- Return total slippage in dollars and weighted average in basis points</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.5: Slippage Calculator (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_slippage</span><span class="p">(</span><span class="n">trades</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate slippage for a list of trades.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    trades : list of dict</span>
<span class="sd">        Each has: expected_price, actual_price, shares, side</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_expected</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_slippage_dollars</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;expected_price&#39;</span><span class="p">]</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;actual_price&#39;</span><span class="p">]</span>
        <span class="n">shares</span> <span class="o">=</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;shares&#39;</span><span class="p">]</span>
        <span class="n">side</span> <span class="o">=</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span>

        <span class="n">trade_value</span> <span class="o">=</span> <span class="n">expected</span> <span class="o">*</span> <span class="n">shares</span>
        <span class="n">total_expected</span> <span class="o">+=</span> <span class="n">trade_value</span>

        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span>
            <span class="n">slippage</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual</span> <span class="o">-</span> <span class="n">expected</span><span class="p">)</span> <span class="o">*</span> <span class="n">shares</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slippage</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">*</span> <span class="n">shares</span>

        <span class="n">total_slippage_dollars</span> <span class="o">+=</span> <span class="n">slippage</span>

    <span class="n">weighted_slippage_bps</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_slippage_dollars</span> <span class="o">/</span> <span class="n">total_expected</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;total_slippage_dollars&#39;</span><span class="p">:</span> <span class="n">total_slippage_dollars</span><span class="p">,</span>
        <span class="s1">&#39;weighted_slippage_bps&#39;</span><span class="p">:</span> <span class="n">weighted_slippage_bps</span><span class="p">,</span>
        <span class="s1">&#39;total_trade_value&#39;</span><span class="p">:</span> <span class="n">total_expected</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">trades</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;expected_price&#39;</span><span class="p">:</span> <span class="mf">100.00</span><span class="p">,</span> <span class="s1">&#39;actual_price&#39;</span><span class="p">:</span> <span class="mf">100.05</span><span class="p">,</span> <span class="s1">&#39;shares&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;expected_price&#39;</span><span class="p">:</span> <span class="mf">150.00</span><span class="p">,</span> <span class="s1">&#39;actual_price&#39;</span><span class="p">:</span> <span class="mf">150.10</span><span class="p">,</span> <span class="s1">&#39;shares&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;expected_price&#39;</span><span class="p">:</span> <span class="mf">75.00</span><span class="p">,</span> <span class="s1">&#39;actual_price&#39;</span><span class="p">:</span> <span class="mf">74.90</span><span class="p">,</span> <span class="s1">&#39;shares&#39;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;sell&#39;</span><span class="p">},</span>
<span class="p">]</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_slippage</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Slippage: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_slippage_dollars&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weighted Slippage: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;weighted_slippage_bps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 14.6: Complete Rebalancing Engine (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a <code>RebalancingEngine</code> class that:
- Takes target weights and configuration options in the constructor
- Has an <code>analyze_portfolio()</code> method that returns current weights, drift, and whether rebalancing is needed
- Has a <code>generate_trades()</code> method that creates a trade list to reach targets
- Has an <code>execute_rebalance()</code> method that simulates or executes the rebalance</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 14.6: Complete Rebalancing Engine (Open-ended)</span>
<span class="c1"># Your implementation here</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RebalancingEngine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready portfolio rebalancing engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span> <span class="o">=</span> <span class="n">target_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{</span>
            <span class="s1">&#39;rebalance_threshold&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;trade_threshold&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>
            <span class="s1">&#39;transaction_cost_bps&#39;</span><span class="p">:</span> <span class="mi">10</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">target_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">analyze_portfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">holdings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze current portfolio state.&quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">holdings</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">holdings</span><span class="p">}</span>
        <span class="n">total_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">current_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">v</span><span class="o">/</span><span class="n">total_value</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">drift</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">current_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> 
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">}</span>
        <span class="n">max_drift</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drift</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">total_value</span><span class="p">,</span>
            <span class="s1">&#39;current_weights&#39;</span><span class="p">:</span> <span class="n">current_weights</span><span class="p">,</span>
            <span class="s1">&#39;drift&#39;</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span>
            <span class="s1">&#39;max_drift&#39;</span><span class="p">:</span> <span class="n">max_drift</span><span class="p">,</span>
            <span class="s1">&#39;needs_rebalance&#39;</span><span class="p">:</span> <span class="n">max_drift</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;rebalance_threshold&#39;</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">holdings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate trade list.&quot;&quot;&quot;</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_portfolio</span><span class="p">(</span><span class="n">holdings</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">:</span>
            <span class="n">drift</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;drift&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">drift</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;trade_threshold&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">target_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">*</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span>
            <span class="n">current_value</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;current_weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span>
            <span class="n">trade_value</span> <span class="o">=</span> <span class="n">target_value</span> <span class="o">-</span> <span class="n">current_value</span>
            <span class="n">shares</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trade_value</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">shares</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;shares&#39;</span><span class="p">:</span> <span class="n">shares</span><span class="p">,</span>
                    <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="n">shares</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">shares</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">execute_rebalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">holdings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute rebalance.&quot;&quot;&quot;</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_portfolio</span><span class="p">(</span><span class="n">holdings</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_trades</span><span class="p">(</span><span class="n">holdings</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>

        <span class="n">total_turnover</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">total_turnover</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;transaction_cost_bps&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10000</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;portfolio_value&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">],</span>
            <span class="s1">&#39;max_drift_before&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;max_drift&#39;</span><span class="p">],</span>
            <span class="s1">&#39;num_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;total_turnover&#39;</span><span class="p">:</span> <span class="n">total_turnover</span><span class="p">,</span>
            <span class="s1">&#39;estimated_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;trades&#39;</span><span class="p">:</span> <span class="n">trades</span><span class="p">,</span>
            <span class="s1">&#39;dry_run&#39;</span><span class="p">:</span> <span class="n">dry_run</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">RebalancingEngine</span><span class="p">(</span><span class="n">target_weights</span><span class="p">)</span>
<span class="n">holdings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;AGG&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">}</span>
<span class="n">prices</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mi">480</span><span class="p">,</span> <span class="s1">&#39;AGG&#39;</span><span class="p">:</span> <span class="mi">98</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mi">210</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">:</span> <span class="mi">85</span><span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute_rebalance</span><span class="p">(</span><span class="n">holdings</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Value: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;portfolio_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drift: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;max_drift_before&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trades: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;num_trades&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimated Cost: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;estimated_cost&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Production Rebalancing System</h1>
<p>Build a comprehensive rebalancing system that combines all concepts.</p>
<p><strong>Your Challenge:</strong></p>
<p>Build a <code>ProductionRebalancer</code> class that includes:
1. Multiple rebalancing strategies (calendar, threshold, hybrid)
2. Transaction cost modeling
3. Tax-loss harvesting integration
4. Execution quality tracking</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductionRebalancer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production-ready rebalancing system.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span> <span class="o">=</span> <span class="n">target_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;hybrid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;check_frequency&#39;</span><span class="p">:</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span>
            <span class="s1">&#39;trigger_threshold&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;trade_threshold&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>
            <span class="s1">&#39;transaction_cost_bps&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;enable_tax_harvesting&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;min_harvest_loss_pct&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;tax_rate&#39;</span><span class="p">:</span> <span class="mf">0.30</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">target_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rebalance_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">analyze_portfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">holdings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                         <span class="n">cost_basis</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Comprehensive portfolio analysis.&quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">holdings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">}</span>
        <span class="n">total_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">total_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;needs_rebalance&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="n">current_weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">v</span><span class="o">/</span><span class="n">total_value</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">drift</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">current_weights</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">}</span>
        <span class="n">max_drift</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drift</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># Tax-loss harvesting opportunities</span>
        <span class="n">harvest_opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;enable_tax_harvesting&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">cost_basis</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">cost_basis</span> <span class="ow">and</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">holdings</span><span class="p">:</span>
                    <span class="n">current_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                    <span class="n">basis</span> <span class="o">=</span> <span class="n">cost_basis</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">*</span> <span class="n">holdings</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
                    <span class="n">gain_loss_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_value</span> <span class="o">-</span> <span class="n">basis</span><span class="p">)</span> <span class="o">/</span> <span class="n">basis</span> <span class="k">if</span> <span class="n">basis</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="n">gain_loss_pct</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;min_harvest_loss_pct&#39;</span><span class="p">]:</span>
                        <span class="n">loss</span> <span class="o">=</span> <span class="n">current_value</span> <span class="o">-</span> <span class="n">basis</span>
                        <span class="n">harvest_opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                            <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span>
                            <span class="s1">&#39;tax_benefit&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tax_rate&#39;</span><span class="p">]</span>
                        <span class="p">})</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">total_value</span><span class="p">,</span>
            <span class="s1">&#39;current_weights&#39;</span><span class="p">:</span> <span class="n">current_weights</span><span class="p">,</span>
            <span class="s1">&#39;drift&#39;</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span>
            <span class="s1">&#39;max_drift&#39;</span><span class="p">:</span> <span class="n">max_drift</span><span class="p">,</span>
            <span class="s1">&#39;needs_rebalance&#39;</span><span class="p">:</span> <span class="n">max_drift</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;trigger_threshold&#39;</span><span class="p">],</span>
            <span class="s1">&#39;harvest_opportunities&#39;</span><span class="p">:</span> <span class="n">harvest_opportunities</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">holdings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                       <span class="n">analysis</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate optimal trade list.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">analysis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_portfolio</span><span class="p">(</span><span class="n">holdings</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>

        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_value</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">:</span>
            <span class="n">drift</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;drift&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">drift</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;trade_threshold&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">target_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">*</span> <span class="n">total_value</span>
            <span class="n">current_value</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;current_weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">total_value</span>
            <span class="n">trade_value</span> <span class="o">=</span> <span class="n">target_value</span> <span class="o">-</span> <span class="n">current_value</span>
            <span class="n">shares</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trade_value</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span> <span class="k">if</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">shares</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cost_bps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;transaction_cost_bps&#39;</span><span class="p">]</span>
                <span class="n">est_cost</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">shares</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span> <span class="o">*</span> <span class="n">cost_bps</span> <span class="o">/</span> <span class="mi">10000</span>

                <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;shares&#39;</span><span class="p">:</span> <span class="n">shares</span><span class="p">,</span>
                    <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="n">shares</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">],</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">shares</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]),</span>
                    <span class="s1">&#39;estimated_cost&#39;</span><span class="p">:</span> <span class="n">est_cost</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">trades</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">execute_rebalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">holdings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                         <span class="n">cost_basis</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute a rebalance operation.&quot;&quot;&quot;</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_portfolio</span><span class="p">(</span><span class="n">holdings</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">cost_basis</span><span class="p">)</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_trades</span><span class="p">(</span><span class="n">holdings</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">analysis</span><span class="p">)</span>

        <span class="n">total_turnover</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;estimated_cost&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">)</span>
        <span class="n">total_harvest</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;tax_benefit&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;harvest_opportunities&#39;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;portfolio_value&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">],</span>
            <span class="s1">&#39;max_drift_before&#39;</span><span class="p">:</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;max_drift&#39;</span><span class="p">],</span>
            <span class="s1">&#39;num_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;total_turnover&#39;</span><span class="p">:</span> <span class="n">total_turnover</span><span class="p">,</span>
            <span class="s1">&#39;turnover_pct&#39;</span><span class="p">:</span> <span class="n">total_turnover</span> <span class="o">/</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;estimated_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;cost_bps&#39;</span><span class="p">:</span> <span class="n">total_cost</span> <span class="o">/</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10000</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;tax_harvest_benefit&#39;</span><span class="p">:</span> <span class="n">total_harvest</span><span class="p">,</span>
            <span class="s1">&#39;trades&#39;</span><span class="p">:</span> <span class="n">trades</span><span class="p">,</span>
            <span class="s1">&#39;dry_run&#39;</span><span class="p">:</span> <span class="n">dry_run</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rebalance_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">summary</span>

    <span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print formatted rebalance report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;REBALANCE REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="s1">&#39;DRY RUN&#39;</span> <span class="k">if</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;dry_run&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;EXECUTED&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Value: $</span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;portfolio_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drift: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;max_drift_before&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trades: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;num_trades&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Turnover: $</span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total_turnover&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;turnover_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Est. Cost: $</span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;estimated_cost&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;cost_bps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> bps)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;tax_harvest_benefit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tax Benefit: $</span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;tax_harvest_benefit&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="c1"># Demo</span>
<span class="n">rebalancer</span> <span class="o">=</span> <span class="n">ProductionRebalancer</span><span class="p">(</span><span class="n">target_weights</span><span class="p">)</span>
<span class="n">holdings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;AGG&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">}</span>
<span class="n">prices</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mi">480</span><span class="p">,</span> <span class="s1">&#39;AGG&#39;</span><span class="p">:</span> <span class="mi">98</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mi">210</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">:</span> <span class="mi">85</span><span class="p">}</span>
<span class="n">cost_basis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;AGG&#39;</span><span class="p">:</span> <span class="mi">105</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mi">190</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">:</span> <span class="mi">95</span><span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">rebalancer</span><span class="o">.</span><span class="n">execute_rebalance</span><span class="p">(</span><span class="n">holdings</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">cost_basis</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rebalancer</span><span class="o">.</span><span class="n">print_report</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Solution - Module Project (simplified demo)</span>
<span class="k">class</span> <span class="nc">ProductionRebalancer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span> <span class="o">=</span> <span class="n">target_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">target_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">analyze_and_rebalance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">holdings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">holdings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">}</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">v</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">drift</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">[</span><span class="n">s</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">weights</span><span class="p">,</span>
            <span class="s1">&#39;max_drift&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">drift</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s1">&#39;needs_rebalance&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">drift</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">rebalancer</span> <span class="o">=</span> <span class="n">ProductionRebalancer</span><span class="p">(</span><span class="n">target_weights</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">rebalancer</span><span class="o">.</span><span class="n">analyze_and_rebalance</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;AGG&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="mi">480</span><span class="p">,</span> <span class="s1">&#39;AGG&#39;</span><span class="p">:</span> <span class="mi">98</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">:</span> <span class="mi">210</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">:</span> <span class="mi">85</span><span class="p">}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Portfolio Value: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drift: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;max_drift&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Needs Rebalance: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;needs_rebalance&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Rebalancing Strategies</h3>
<ul>
<li>Calendar rebalancing: simple but may over/under-trade</li>
<li>Threshold rebalancing: trades only when drift exceeds limit</li>
<li>Hybrid approaches combine benefits of both</li>
</ul>
<h3>2. Transaction Costs</h3>
<ul>
<li>Include explicit (commissions) and implicit (spread, impact) costs</li>
<li>Market impact grows with trade size (square-root model)</li>
<li>Break-even analysis helps determine minimum holding periods</li>
</ul>
<h3>3. Tax-Loss Harvesting</h3>
<ul>
<li>Can add 0.5-1% annually to after-tax returns</li>
<li>Must avoid wash sale rule (30-day window)</li>
<li>Use correlated substitutes to maintain exposure</li>
</ul>
<h3>4. Implementation Shortfall</h3>
<ul>
<li>Measures total cost of trading decisions</li>
<li>Components: delay, trading, opportunity costs</li>
<li>VWAP/TWAP algorithms help minimize impact</li>
</ul></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 15: Market Microstructure</strong>, we'll explore:
- Order books and price formation
- Bid-ask spread dynamics
- Market maker behavior
- Optimal execution strategies</p>
<hr />
<p><em>Congratulations on completing Module 14!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="15"><div class="md-cell module-header"><h1>Module 15: Market Microstructure</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 5: Production &amp; Infrastructure</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Understand limit order book mechanics and price-time priority</li>
<li>Analyze bid-ask spread components and estimate spreads</li>
<li>Model price impact using square-root and Almgren-Chriss models</li>
<li>Implement optimal execution algorithms (TWAP, VWAP, IS)</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2.5 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 14 (Rebalancing &amp; Execution)</td>
</tr>
</tbody>
</table></div></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-15.1">Section 15.1: Order Book Mechanics</a></li>
<li><a href="#section-15.2">Section 15.2: Bid-Ask Spread Analysis</a></li>
<li><a href="#section-15.3">Section 15.3: Price Impact Models</a></li>
<li><a href="#section-15.4">Section 15.4: Optimal Execution</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module 15: Market Microstructure&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-15.1'></a></p>
<h1>Section 15.1: Order Book Mechanics</h1>
<p>Modern electronic markets are organized around the <strong>limit order book</strong> (LOB) - a collection of buy and sell orders at various prices.</p>
<p><strong>In this section, you will learn:</strong>
- Order types (market, limit, stop)
- Price-time priority matching
- Book imbalance as a directional signal</p>
<h3>Order Types</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Order Type</th>
<th>Description</th>
<th>Execution</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Market</strong></td>
<td>Execute immediately at best available price</td>
<td>Certain execution, uncertain price</td>
</tr>
<tr>
<td><strong>Limit</strong></td>
<td>Execute only at specified price or better</td>
<td>Uncertain execution, certain price</td>
</tr>
<tr>
<td><strong>Stop</strong></td>
<td>Becomes market order when price reaches trigger</td>
<td>Risk management</td>
</tr>
</tbody>
</table></div>
<h3>Order Book Structure</h3>
<div class="highlight"><pre><span></span><code>        SELL SIDE (Asks)           |        BUY SIDE (Bids)
    Price    Quantity              |     Price    Quantity
    $100.10    500    &lt;-- Best Ask |     $100.05    800  &lt;-- Best Bid
    $100.15    300                 |     $100.00    1200
    $100.20    1000                |     $99.95     400
</code></pre></div>

<p>The <strong>spread</strong> is the gap between best bid and best ask.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">OrderSide</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">BUY</span> <span class="o">=</span> <span class="s2">&quot;buy&quot;</span>
    <span class="n">SELL</span> <span class="o">=</span> <span class="s2">&quot;sell&quot;</span>

<span class="k">class</span> <span class="nc">OrderType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">MARKET</span> <span class="o">=</span> <span class="s2">&quot;market&quot;</span>
    <span class="n">LIMIT</span> <span class="o">=</span> <span class="s2">&quot;limit&quot;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a single order.&quot;&quot;&quot;</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">side</span><span class="p">:</span> <span class="n">OrderSide</span>
    <span class="n">order_type</span><span class="p">:</span> <span class="n">OrderType</span>
    <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Trade</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents an executed trade.&quot;&quot;&quot;</span>
    <span class="n">trade_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">aggressor_side</span><span class="p">:</span> <span class="n">OrderSide</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>


<span class="k">class</span> <span class="nc">LimitOrderBook</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple limit order book implementation.</span>
<span class="sd">    </span>
<span class="sd">    Supports:</span>
<span class="sd">    - Adding limit orders</span>
<span class="sd">    - Market orders (immediate execution)</span>
<span class="sd">    - Order cancellation</span>
<span class="sd">    - Price-time priority matching</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span> <span class="o">=</span> <span class="n">tick_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bids</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asks</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trade_counter</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">_round_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span>
    
    <span class="k">def</span> <span class="nf">best_bid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bids</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bids</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bids</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">best_ask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">asks</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">asks</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">asks</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">spread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_bid</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_ask</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">ask</span> <span class="o">-</span> <span class="n">bid</span>
    
    <span class="k">def</span> <span class="nf">midpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_bid</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_ask</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">bid</span> <span class="o">+</span> <span class="n">ask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="k">def</span> <span class="nf">add_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="n">OrderSide</span><span class="p">,</span> <span class="n">order_type</span><span class="p">:</span> <span class="n">OrderType</span><span class="p">,</span> 
                  <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Order</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_round_price</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
        
        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_counter</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
            <span class="n">order_type</span><span class="o">=</span><span class="n">order_type</span><span class="p">,</span>
            <span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
            <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span>
        <span class="p">)</span>
        
        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">:</span>
            <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_market_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">order_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
                <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bids</span><span class="p">[</span><span class="n">price</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">asks</span><span class="p">[</span><span class="n">price</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">order</span><span class="p">,</span> <span class="n">trades</span>
    
    <span class="k">def</span> <span class="nf">_execute_market_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]:</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span>
        
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">:</span>
            <span class="n">book_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asks</span>
            <span class="n">price_order</span> <span class="o">=</span> <span class="nb">sorted</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">book_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bids</span>
            <span class="n">price_order</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">price_order</span><span class="p">(</span><span class="n">book_side</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">if</span> <span class="n">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">orders_at_price</span> <span class="o">=</span> <span class="n">book_side</span><span class="p">[</span><span class="n">price</span><span class="p">]</span>
            
            <span class="k">while</span> <span class="n">orders_at_price</span> <span class="ow">and</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">resting_order</span> <span class="o">=</span> <span class="n">orders_at_price</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fill_qty</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">resting_order</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_trade_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
                    <span class="n">trade_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trade_counter</span><span class="p">,</span>
                    <span class="n">price</span><span class="o">=</span><span class="n">resting_order</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                    <span class="n">quantity</span><span class="o">=</span><span class="n">fill_qty</span><span class="p">,</span>
                    <span class="n">aggressor_side</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
                    <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
                
                <span class="n">remaining</span> <span class="o">-=</span> <span class="n">fill_qty</span>
                <span class="n">resting_order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">-=</span> <span class="n">fill_qty</span>
                
                <span class="k">if</span> <span class="n">resting_order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">orders_at_price</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">resting_order</span><span class="o">.</span><span class="n">order_id</span><span class="p">]</span>
        
        <span class="n">order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">remaining</span>
        <span class="k">return</span> <span class="n">trades</span>
    
    <span class="k">def</span> <span class="nf">_match_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]:</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">asks</span><span class="p">:</span>
                <span class="n">best_ask_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_ask</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">best_ask_price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">order</span><span class="o">.</span><span class="n">price</span> <span class="o">&lt;</span> <span class="n">best_ask_price</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">orders_at_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asks</span><span class="p">[</span><span class="n">best_ask_price</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">orders_at_price</span><span class="p">:</span>
                    <span class="k">break</span>
                
                <span class="n">resting_order</span> <span class="o">=</span> <span class="n">orders_at_price</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fill_qty</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">resting_order</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_trade_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
                    <span class="n">trade_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trade_counter</span><span class="p">,</span>
                    <span class="n">price</span><span class="o">=</span><span class="n">resting_order</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                    <span class="n">quantity</span><span class="o">=</span><span class="n">fill_qty</span><span class="p">,</span>
                    <span class="n">aggressor_side</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
                    <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
                
                <span class="n">order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">-=</span> <span class="n">fill_qty</span>
                <span class="n">resting_order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">-=</span> <span class="n">fill_qty</span>
                
                <span class="k">if</span> <span class="n">resting_order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">orders_at_price</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">resting_order</span><span class="o">.</span><span class="n">order_id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bids</span><span class="p">:</span>
                <span class="n">best_bid_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_bid</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">best_bid_price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">order</span><span class="o">.</span><span class="n">price</span> <span class="o">&gt;</span> <span class="n">best_bid_price</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">orders_at_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bids</span><span class="p">[</span><span class="n">best_bid_price</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">orders_at_price</span><span class="p">:</span>
                    <span class="k">break</span>
                
                <span class="n">resting_order</span> <span class="o">=</span> <span class="n">orders_at_price</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fill_qty</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="n">resting_order</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_trade_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
                    <span class="n">trade_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_trade_counter</span><span class="p">,</span>
                    <span class="n">price</span><span class="o">=</span><span class="n">resting_order</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                    <span class="n">quantity</span><span class="o">=</span><span class="n">fill_qty</span><span class="p">,</span>
                    <span class="n">aggressor_side</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
                    <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
                
                <span class="n">order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">-=</span> <span class="n">fill_qty</span>
                <span class="n">resting_order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">-=</span> <span class="n">fill_qty</span>
                
                <span class="k">if</span> <span class="n">resting_order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">orders_at_price</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">resting_order</span><span class="o">.</span><span class="n">order_id</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">trades</span>
    
    <span class="k">def</span> <span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">order_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bids</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">price</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asks</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">price</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">get_book_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">levels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">bid_prices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bids</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bids</span><span class="p">[</span><span class="n">p</span><span class="p">]],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">levels</span><span class="p">]</span>
        <span class="n">ask_prices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">asks</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">asks</span><span class="p">[</span><span class="n">p</span><span class="p">]])[:</span><span class="n">levels</span><span class="p">]</span>
        
        <span class="n">bids</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">quantity</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bids</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">bid_prices</span><span class="p">]</span>
        <span class="n">asks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">quantity</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">asks</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ask_prices</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;bids&#39;</span><span class="p">:</span> <span class="n">bids</span><span class="p">,</span>
            <span class="s1">&#39;asks&#39;</span><span class="p">:</span> <span class="n">asks</span><span class="p">,</span>
            <span class="s1">&#39;best_bid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_bid</span><span class="p">(),</span>
            <span class="s1">&#39;best_ask&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_ask</span><span class="p">(),</span>
            <span class="s1">&#39;spread&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spread</span><span class="p">(),</span>
            <span class="s1">&#39;midpoint&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_book_state</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ORDER BOOK&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spread: $</span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;spread&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;spread&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;Spread: N/A&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Midpoint: $</span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;midpoint&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;midpoint&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;Midpoint: N/A&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;ASK&#39;</span><span class="si">:</span><span class="s2">^25</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="s1">&#39;BID&#39;</span><span class="si">:</span><span class="s2">^22</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Price&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Qty&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="s1">&#39;Price&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Qty&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        
        <span class="n">asks</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">bids</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">]</span>
        <span class="n">max_rows</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asks</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bids</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_rows</span><span class="p">):</span>
            <span class="n">ask_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">asks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">asks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10,</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">asks</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">23</span>
            <span class="n">bid_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">bids</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">bids</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10,</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bids</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">22</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ask_str</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">bid_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Create and populate an order book</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">LimitOrderBook</span><span class="p">(</span><span class="n">tick_size</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># Add buy orders (bids)</span>
<span class="n">book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mf">100.00</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mf">99.95</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mf">99.90</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mf">99.85</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mf">99.80</span><span class="p">)</span>

<span class="c1"># Add sell orders (asks)</span>
<span class="n">book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mf">100.05</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mf">100.10</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mf">100.15</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mf">100.20</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mf">100.25</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial Order Book State:&quot;</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate market order execution</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Submitting: BUY 600 shares at MARKET&quot;</span><span class="p">)</span>
<span class="n">order</span><span class="p">,</span> <span class="n">trades</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Executed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span><span class="si">}</span><span class="s2"> trade(s):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> shares @ $</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">avg_price</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">quantity</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">quantity</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Average execution price: $</span><span class="si">{</span><span class="n">avg_price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Midpoint was: $</span><span class="si">{</span><span class="p">(</span><span class="mf">100.00</span> <span class="o">+</span> <span class="mf">100.05</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slippage: $</span><span class="si">{</span><span class="n">avg_price</span> <span class="o">-</span> <span class="mf">100.025</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Order Book After Market Buy:&quot;</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 15.1: Book Imbalance Calculator (Guided)</h3>
<p><strong>Your Task:</strong> Calculate order book imbalance - the ratio of bid volume to ask volume.</p>
<p>Imbalance = (Bid Volume - Ask Volume) / (Bid Volume + Ask Volume)</p>
<p>Returns value between -1 (all asks) and +1 (all bids).</p>
<p>Fill in the blanks to complete the function:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 15.1: Book Imbalance Calculator (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_book_imbalance</span><span class="p">(</span><span class="n">book</span><span class="p">:</span> <span class="n">LimitOrderBook</span><span class="p">,</span> <span class="n">levels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate order book imbalance from top levels.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Get book state</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span>
    
    <span class="c1"># TODO: Sum bid volume from state[&#39;bids&#39;] list of (price, qty) tuples</span>
    <span class="n">bid_volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">qty</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="n">______</span><span class="p">])</span>
    
    <span class="c1"># TODO: Sum ask volume from state[&#39;asks&#39;]</span>
    <span class="n">ask_volume</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">qty</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">])</span>
    
    <span class="c1"># TODO: Calculate total volume</span>
    <span class="n">total_volume</span> <span class="o">=</span> <span class="n">bid_volume</span> <span class="o">+</span> <span class="n">______</span>
    
    <span class="k">if</span> <span class="n">total_volume</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    
    <span class="c1"># TODO: Calculate imbalance ratio</span>
    <span class="n">imbalance</span> <span class="o">=</span> <span class="p">(</span><span class="n">bid_volume</span> <span class="o">-</span> <span class="n">ask_volume</span><span class="p">)</span> <span class="o">/</span> <span class="n">______</span>
    
    <span class="k">return</span> <span class="n">imbalance</span>

<span class="c1"># Test your solution</span>
<span class="c1"># imbalance = calculate_book_imbalance(book, levels=3)</span>
<span class="c1"># print(f&quot;Book Imbalance: {imbalance:.2%}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_book_imbalance</span><span class="p">(</span><span class="n">book</span><span class="p">:</span> <span class="n">LimitOrderBook</span><span class="p">,</span> <span class="n">levels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate order book imbalance from top levels.&quot;&quot;&quot;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">get_book_state</span><span class="p">(</span><span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span>

    <span class="n">bid_volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">qty</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;bids&#39;</span><span class="p">])</span>
    <span class="n">ask_volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">qty</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;asks&#39;</span><span class="p">])</span>

    <span class="n">total_volume</span> <span class="o">=</span> <span class="n">bid_volume</span> <span class="o">+</span> <span class="n">ask_volume</span>

    <span class="k">if</span> <span class="n">total_volume</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="n">imbalance</span> <span class="o">=</span> <span class="p">(</span><span class="n">bid_volume</span> <span class="o">-</span> <span class="n">ask_volume</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_volume</span>

    <span class="k">return</span> <span class="n">imbalance</span>

<span class="c1"># Test</span>
<span class="n">imbalance</span> <span class="o">=</span> <span class="n">calculate_book_imbalance</span><span class="p">(</span><span class="n">book</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Book Imbalance (top 3 levels): </span><span class="si">{</span><span class="n">imbalance</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">imbalance</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpretation: More bid volume - bullish pressure&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">imbalance</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpretation: More ask volume - bearish pressure&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpretation: Balanced book&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-15.2'></a></p>
<h1>Section 15.2: Bid-Ask Spread Analysis</h1>
<p>The bid-ask spread is the most fundamental transaction cost. Understanding its components helps predict trading costs.</p>
<p><strong>In this section, you will learn:</strong>
- Spread components (order processing, inventory, adverse selection)
- Types of spreads (quoted, effective, realized)
- Roll model for spread estimation</p>
<h3>Spread Components</h3>
<p>The spread compensates market makers for:</p>
<ol>
<li><strong>Order Processing Costs</strong> - Fixed costs of maintaining systems</li>
<li><strong>Inventory Risk</strong> - Risk of holding inventory that may lose value</li>
<li><strong>Adverse Selection</strong> - Risk of trading with informed traders</li>
</ol>
<h3>Types of Spreads</h3>
<ul>
<li><strong>Quoted Spread</strong>: Best ask - Best bid</li>
<li><strong>Effective Spread</strong>: 2 √ó |Trade price - Midpoint|</li>
<li><strong>Realized Spread</strong>: Effective spread minus subsequent price change</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SpreadAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyzes bid-ask spread characteristics.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quotes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">bid</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ask</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record a quote update.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quotes</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">bid</span><span class="p">,</span>
            <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ask</span><span class="p">,</span>
            <span class="s1">&#39;midpoint&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">bid</span> <span class="o">+</span> <span class="n">ask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;quoted_spread&#39;</span><span class="p">:</span> <span class="n">ask</span> <span class="o">-</span> <span class="n">bid</span><span class="p">,</span>
            <span class="s1">&#39;quoted_spread_bps&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ask</span> <span class="o">-</span> <span class="n">bid</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">bid</span> <span class="o">+</span> <span class="n">ask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">add_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record a trade.&quot;&quot;&quot;</span>
        <span class="n">quote_at_trade</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quotes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">timestamp</span><span class="p">:</span>
                <span class="n">quote_at_trade</span> <span class="o">=</span> <span class="n">q</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="n">quote_at_trade</span><span class="p">:</span>
            <span class="n">midpoint</span> <span class="o">=</span> <span class="n">quote_at_trade</span><span class="p">[</span><span class="s1">&#39;midpoint&#39;</span><span class="p">]</span>
            <span class="n">effective_half_spread</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">midpoint</span><span class="p">)</span>
            <span class="n">effective_spread</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">effective_half_spread</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
                <span class="s1">&#39;midpoint_at_trade&#39;</span><span class="p">:</span> <span class="n">midpoint</span><span class="p">,</span>
                <span class="s1">&#39;effective_spread&#39;</span><span class="p">:</span> <span class="n">effective_spread</span><span class="p">,</span>
                <span class="s1">&#39;effective_spread_bps&#39;</span><span class="p">:</span> <span class="n">effective_spread</span> <span class="o">/</span> <span class="n">midpoint</span> <span class="o">*</span> <span class="mi">10000</span>
            <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">summary_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get summary statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quotes</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">quoted_spreads</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="s1">&#39;quoted_spread_bps&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">quotes</span><span class="p">]</span>
        
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;num_quotes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quotes</span><span class="p">),</span>
            <span class="s1">&#39;avg_quoted_spread_bps&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">quoted_spreads</span><span class="p">),</span>
            <span class="s1">&#39;median_quoted_spread_bps&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">quoted_spreads</span><span class="p">),</span>
            <span class="s1">&#39;min_quoted_spread_bps&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">quoted_spreads</span><span class="p">),</span>
            <span class="s1">&#39;max_quoted_spread_bps&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">quoted_spreads</span><span class="p">),</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="n">effective_spreads</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;effective_spread_bps&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">]</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;num_trades&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;avg_effective_spread_bps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">effective_spreads</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">stats</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate quote and trade data</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">SpreadAnalyzer</span><span class="p">()</span>

<span class="n">base_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">base_mid</span> <span class="o">=</span> <span class="mf">100.0</span>
<span class="n">base_spread</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">base_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">i</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">base_mid</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
    <span class="n">spread</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">base_spread</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">))</span>
    
    <span class="n">bid</span> <span class="o">=</span> <span class="n">base_mid</span> <span class="o">-</span> <span class="n">spread</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">ask</span> <span class="o">=</span> <span class="n">base_mid</span> <span class="o">+</span> <span class="n">spread</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">analyzer</span><span class="o">.</span><span class="n">add_quote</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
        <span class="n">side</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">ask</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span> <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span> <span class="k">else</span> <span class="n">bid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="n">analyzer</span><span class="o">.</span><span class="n">add_trade</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">side</span><span class="p">)</span>

<span class="n">stats</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">summary_stats</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spread Analysis Summary&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">&#39;bps&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize spread over time</span>
<span class="n">df_quotes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">quotes</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_quotes</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">df_quotes</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span> <span class="n">df_quotes</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span> 
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Bid-Ask Range&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_quotes</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">df_quotes</span><span class="p">[</span><span class="s1">&#39;midpoint&#39;</span><span class="p">],</span> 
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Midpoint&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price ($)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Quote Evolution&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_quotes</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">df_quotes</span><span class="p">[</span><span class="s1">&#39;quoted_spread_bps&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">df_quotes</span><span class="p">[</span><span class="s1">&#39;quoted_spread_bps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> 
                <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">df_quotes</span><span class="p">[</span><span class="s1">&#39;quoted_spread_bps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> bps&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spread (bps)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Quoted Spread Over Time&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 15.2: Roll Spread Estimator (Guided)</h3>
<p><strong>Your Task:</strong> Estimate the bid-ask spread using the Roll (1984) model.</p>
<p>The Roll model estimates spread from the autocovariance of price changes:</p>
<p>$$\text{Spread} = 2\sqrt{-\text{Cov}(\Delta P_t, \Delta P_{t-1})}$$</p>
<p>(Only valid when covariance is negative)</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 15.2: Roll Spread Estimator (Guided)</span>
<span class="k">def</span> <span class="nf">estimate_spread_roll</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Estimate bid-ask spread using Roll (1984) model.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate price changes using np.diff</span>
    <span class="n">delta_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate autocovariance between delta_p[1:] and delta_p[:-1]</span>
    <span class="c1"># Use np.cov and extract [0, 1] element</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">delta_p</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">delta_p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Roll model only applies when covariance is negative</span>
    <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># TODO: Spread = 2 * sqrt(-cov)</span>
    <span class="n">spread</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="o">-</span><span class="n">cov</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">spread</span>

<span class="c1"># Test your solution</span>
<span class="c1"># test_prices = [100.0, 100.05, 99.95, 100.02, 99.98, 100.03]</span>
<span class="c1"># roll_spread = estimate_spread_roll(test_prices)</span>
<span class="c1"># print(f&quot;Roll spread estimate: ${roll_spread:.4f}&quot; if roll_spread else &quot;Model not applicable&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">estimate_spread_roll</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Estimate bid-ask spread using Roll (1984) model.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

    <span class="c1"># Calculate price changes</span>
    <span class="n">delta_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

    <span class="c1"># Calculate autocovariance</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">delta_p</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">delta_p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Roll model only applies when covariance is negative</span>
    <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Spread = 2 * sqrt(-cov)</span>
    <span class="n">spread</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">cov</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spread</span>

<span class="c1"># Test with simulated trade prices</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">true_spread</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">true_mid</span> <span class="o">=</span> <span class="mf">100.0</span>

<span class="c1"># Efficient price random walk</span>
<span class="n">efficient_prices</span> <span class="o">=</span> <span class="p">[</span><span class="n">true_mid</span><span class="p">]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">efficient_prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">efficient_prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">))</span>

<span class="c1"># Transaction prices alternate bid/ask</span>
<span class="n">transaction_prices</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">eff_p</span> <span class="ow">in</span> <span class="n">efficient_prices</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">transaction_prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eff_p</span> <span class="o">+</span> <span class="n">true_spread</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transaction_prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eff_p</span> <span class="o">-</span> <span class="n">true_spread</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

<span class="n">estimated_spread</span> <span class="o">=</span> <span class="n">estimate_spread_roll</span><span class="p">(</span><span class="n">transaction_prices</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;True spread: $</span><span class="si">{</span><span class="n">true_spread</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Roll estimate: $</span><span class="si">{</span><span class="n">estimated_spread</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">estimated_spread</span> <span class="k">else</span> <span class="s2">&quot;Roll model not applicable&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-15.3'></a></p>
<h1>Section 15.3: Price Impact Models</h1>
<p>When you trade, you move the price. This <strong>price impact</strong> has two components:</p>
<ol>
<li><strong>Temporary Impact</strong>: Immediate price pressure that reverses</li>
<li><strong>Permanent Impact</strong>: Information revealed by your trade</li>
</ol>
<p><strong>In this section, you will learn:</strong>
- Square-root impact model
- Almgren-Chriss framework
- Impact estimation from trade data</p>
<h3>The Square-Root Model</h3>
<p>The most widely-used impact model:</p>
<p>$$\text{Impact} = \sigma \cdot \sqrt{\frac{Q}{V}}$$</p>
<p>Where:
- $\sigma$ = daily volatility
- $Q$ = trade quantity
- $V$ = average daily volume</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PriceImpactModel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Models price impact of trading.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">avg_daily_volume</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adv</span> <span class="o">=</span> <span class="n">avg_daily_volume</span>
    
    <span class="k">def</span> <span class="nf">square_root_impact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">permanent_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate impact using square-root model.&quot;&quot;&quot;</span>
        <span class="n">participation</span> <span class="o">=</span> <span class="n">quantity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv</span>
        
        <span class="n">total_impact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">participation</span><span class="p">)</span>
        <span class="n">permanent</span> <span class="o">=</span> <span class="n">total_impact</span> <span class="o">*</span> <span class="n">permanent_fraction</span>
        <span class="n">temporary</span> <span class="o">=</span> <span class="n">total_impact</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">permanent_fraction</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_impact_pct&#39;</span><span class="p">:</span> <span class="n">total_impact</span><span class="p">,</span>
            <span class="s1">&#39;permanent_pct&#39;</span><span class="p">:</span> <span class="n">permanent</span><span class="p">,</span>
            <span class="s1">&#39;temporary_pct&#39;</span><span class="p">:</span> <span class="n">temporary</span><span class="p">,</span>
            <span class="s1">&#39;participation_rate&#39;</span><span class="p">:</span> <span class="n">participation</span><span class="p">,</span>
            <span class="s1">&#39;total_impact_bps&#39;</span><span class="p">:</span> <span class="n">total_impact</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
            <span class="s1">&#39;permanent_bps&#39;</span><span class="p">:</span> <span class="n">permanent</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
            <span class="s1">&#39;temporary_bps&#39;</span><span class="p">:</span> <span class="n">temporary</span> <span class="o">*</span> <span class="mi">10000</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">almgren_chriss_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">time_horizon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                            <span class="n">risk_aversion</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate expected cost using Almgren-Chriss model.&quot;&quot;&quot;</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adv</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">eta</span>
        
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">risk_aversion</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">eta</span><span class="p">)</span>
        
        <span class="n">permanent_cost</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">quantity</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">temporary_cost</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">quantity</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">time_horizon</span><span class="p">)</span>
        <span class="n">timing_risk</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">quantity</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">time_horizon</span>
        
        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">permanent_cost</span> <span class="o">+</span> <span class="n">temporary_cost</span> <span class="o">+</span> <span class="n">timing_risk</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;permanent_cost&#39;</span><span class="p">:</span> <span class="n">permanent_cost</span><span class="p">,</span>
            <span class="s1">&#39;temporary_cost&#39;</span><span class="p">:</span> <span class="n">temporary_cost</span><span class="p">,</span>
            <span class="s1">&#39;timing_risk_cost&#39;</span><span class="p">:</span> <span class="n">timing_risk</span><span class="p">,</span>
            <span class="s1">&#39;total_expected_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;cost_per_share&#39;</span><span class="p">:</span> <span class="n">total_cost</span> <span class="o">/</span> <span class="n">quantity</span><span class="p">,</span>
            <span class="s1">&#39;optimal_kappa&#39;</span><span class="p">:</span> <span class="n">kappa</span>
        <span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Example: Impact of different trade sizes</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">PriceImpactModel</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">avg_daily_volume</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Price Impact Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stock: $100, Daily Vol: 1M shares, Volatility: 2%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Trade Size&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;% ADV&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Impact (bps)&#39;</span><span class="si">:</span><span class="s2">&gt;14</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Perm (bps)&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Temp (bps)&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="k">for</span> <span class="n">qty</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">500000</span><span class="p">]:</span>
    <span class="n">impact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">square_root_impact</span><span class="p">(</span><span class="n">qty</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">qty</span><span class="si">:</span><span class="s2">&gt;12,</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">impact</span><span class="p">[</span><span class="s1">&#39;participation_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;7.1%</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">impact</span><span class="p">[</span><span class="s1">&#39;total_impact_bps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;14.1f</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">impact</span><span class="p">[</span><span class="s1">&#39;permanent_bps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;12.1f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">impact</span><span class="p">[</span><span class="s1">&#39;temporary_bps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;12.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize impact curve</span>
<span class="n">quantities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">500000</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">impacts</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">square_root_impact</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="s1">&#39;total_impact_bps&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantities</span><span class="p">]</span>
<span class="n">participation_rates</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">adv</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quantities</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">quantities</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">impacts</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trade Size (thousands of shares)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Expected Impact (bps)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Price Impact vs Trade Size&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">participation_rates</span><span class="p">,</span> <span class="n">impacts</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Participation Rate (</span><span class="si">% o</span><span class="s1">f ADV)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Expected Impact (bps)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Price Impact vs Participation Rate&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Key insight: Impact grows with square root of trade size&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trading 4x the volume only doubles the impact&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 15.3: Optimal Trade Horizon (Guided)</h3>
<p><strong>Your Task:</strong> Calculate the optimal execution horizon given trade size and urgency.</p>
<p>The trade-off is:
- Trade faster ‚Üí higher market impact
- Trade slower ‚Üí more timing/volatility risk</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 15.3: Optimal Trade Horizon (Guided)</span>
<span class="k">def</span> <span class="nf">optimal_trade_horizon</span><span class="p">(</span><span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">adv</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                          <span class="n">urgency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate optimal execution horizon.</span>
<span class="sd">    </span>
<span class="sd">    Returns horizon in trading days.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate participation rate</span>
    <span class="n">participation</span> <span class="o">=</span> <span class="n">quantity</span> <span class="o">/</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Base horizon proportional to sqrt of participation</span>
    <span class="n">base_horizon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">participation</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
    
    <span class="c1"># TODO: Volatility adjustment (higher vol -&gt; shorter horizon)</span>
    <span class="n">vol_adjustment</span> <span class="o">=</span> <span class="mf">0.02</span> <span class="o">/</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Urgency adjustment (higher urgency -&gt; shorter horizon)</span>
    <span class="n">urgency_adjustment</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">______</span>
    
    <span class="c1"># Calculate optimal horizon</span>
    <span class="n">optimal_horizon</span> <span class="o">=</span> <span class="n">base_horizon</span> <span class="o">*</span> <span class="n">vol_adjustment</span> <span class="o">*</span> <span class="n">urgency_adjustment</span>
    
    <span class="c1"># TODO: Clip to reasonable range [0.1, 5.0] days</span>
    <span class="n">optimal_horizon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">optimal_horizon</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">optimal_horizon</span>

<span class="c1"># Test your solution</span>
<span class="c1"># horizon = optimal_trade_horizon(50000, 1000000, 0.02, 1.0)</span>
<span class="c1"># print(f&quot;Optimal horizon: {horizon:.2f} days&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">optimal_trade_horizon</span><span class="p">(</span><span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">adv</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                          <span class="n">urgency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate optimal execution horizon.</span>

<span class="sd">    Returns horizon in trading days.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">participation</span> <span class="o">=</span> <span class="n">quantity</span> <span class="o">/</span> <span class="n">adv</span>

    <span class="n">base_horizon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">participation</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="n">vol_adjustment</span> <span class="o">=</span> <span class="mf">0.02</span> <span class="o">/</span> <span class="n">volatility</span>

    <span class="n">urgency_adjustment</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">urgency</span>

    <span class="n">optimal_horizon</span> <span class="o">=</span> <span class="n">base_horizon</span> <span class="o">*</span> <span class="n">vol_adjustment</span> <span class="o">*</span> <span class="n">urgency_adjustment</span>

    <span class="n">optimal_horizon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">optimal_horizon</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">optimal_horizon</span>

<span class="c1"># Test with different scenarios</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimal Trade Horizons&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;Base case&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s2">&quot;High urgency&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;High volatility&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">200000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;Large order&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">5000000</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;Liquid stock&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">qty</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">urg</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
    <span class="n">horizon</span> <span class="o">=</span> <span class="n">optimal_trade_horizon</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">urg</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Order: </span><span class="si">{</span><span class="n">qty</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> shares (</span><span class="si">{</span><span class="n">qty</span><span class="o">/</span><span class="n">adv</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> of ADV)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Optimal horizon: </span><span class="si">{</span><span class="n">horizon</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> days (</span><span class="si">{</span><span class="n">horizon</span><span class="o">*</span><span class="mf">6.5</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> hours)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-15.4'></a></p>
<h1>Section 15.4: Optimal Execution</h1>
<p>Given price impact, how should we optimally execute large orders?</p>
<p><strong>In this section, you will learn:</strong>
- TWAP (Time-Weighted Average Price)
- VWAP (Volume-Weighted Average Price)
- Almgren-Chriss optimal trajectory
- Implementation shortfall algorithms</p>
<h3>Key Algorithms</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Algorithm</th>
<th>Strategy</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>TWAP</strong></td>
<td>Equal slices over time</td>
<td>Low-urgency, uniform volume</td>
</tr>
<tr>
<td><strong>VWAP</strong></td>
<td>Match market volume profile</td>
<td>Benchmark matching</td>
</tr>
<tr>
<td><strong>Implementation Shortfall</strong></td>
<td>Minimize expected shortfall</td>
<td>Alpha-decay situations</td>
</tr>
<tr>
<td><strong>Participation</strong></td>
<td>Fixed % of market volume</td>
<td>Large orders, patient</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ExecutionAlgorithm</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Implementation of common execution algorithms.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">time_horizon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">num_slices</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_quantity</span> <span class="o">=</span> <span class="n">total_quantity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_horizon</span> <span class="o">=</span> <span class="n">time_horizon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="n">num_slices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_horizon</span><span class="p">,</span> <span class="n">num_slices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">twap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Time-Weighted Average Price - equal amounts at regular intervals.&quot;&quot;&quot;</span>
        <span class="n">slice_qty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_quantity</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span>
        <span class="n">remainder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_quantity</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span>
        
        <span class="n">quantities</span> <span class="o">=</span> <span class="p">[</span><span class="n">slice_qty</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span>
        <span class="n">quantities</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">remainder</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;TWAP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;times&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
            <span class="s1">&#39;quantities&#39;</span><span class="p">:</span> <span class="n">quantities</span><span class="p">,</span>
            <span class="s1">&#39;cumulative&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">vwap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_profile</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Volume-Weighted Average Price - proportional to expected volume.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">volume_profile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">volume_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_volume_profile</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_profile</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">:</span>
            <span class="n">volume_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_profile</span><span class="p">)),</span>
                <span class="n">volume_profile</span>
            <span class="p">)</span>
        
        <span class="n">volume_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">volume_profile</span><span class="p">)</span>
        <span class="n">volume_pct</span> <span class="o">=</span> <span class="n">volume_profile</span> <span class="o">/</span> <span class="n">volume_profile</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">quantities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_quantity</span> <span class="o">*</span> <span class="n">volume_pct</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_quantity</span> <span class="o">-</span> <span class="n">quantities</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">quantities</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diff</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;VWAP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;times&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
            <span class="s1">&#39;quantities&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">quantities</span><span class="p">),</span>
            <span class="s1">&#39;cumulative&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">almgren_chriss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Almgren-Chriss optimal execution trajectory.&quot;&quot;&quot;</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">eta</span><span class="p">)</span>
        
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_horizon</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">T</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_quantity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">kappa</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">(</span><span class="n">kappa</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span>
            <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">quantities</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">quantities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_quantity</span> <span class="o">-</span> <span class="n">quantities</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">quantities</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diff</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Almgren-Chriss&#39;</span><span class="p">,</span>
            <span class="s1">&#39;times&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
            <span class="s1">&#39;quantities&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">quantities</span><span class="p">),</span>
            <span class="s1">&#39;cumulative&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">quantities</span><span class="p">),</span>
            <span class="s1">&#39;kappa&#39;</span><span class="p">:</span> <span class="n">kappa</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_default_volume_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Default U-shaped intraday volume profile.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">profile</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Compare execution algorithms</span>
<span class="n">algo</span> <span class="o">=</span> <span class="n">ExecutionAlgorithm</span><span class="p">(</span><span class="n">total_quantity</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">time_horizon</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">num_slices</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">twap</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">twap</span><span class="p">()</span>
<span class="n">vwap</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">vwap</span><span class="p">()</span>
<span class="n">ac_low</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">almgren_chriss</span><span class="p">(</span><span class="n">risk_aversion</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
<span class="n">ac_high</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">almgren_chriss</span><span class="p">(</span><span class="n">risk_aversion</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Execution Algorithm Comparison&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order: 100,000 shares over 1 day (</span><span class="si">{</span><span class="n">algo</span><span class="o">.</span><span class="n">num_slices</span><span class="si">}</span><span class="s2"> slices)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize execution trajectories</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="k">for</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">twap</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">vwap</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span> 
                             <span class="p">(</span><span class="n">ac_low</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">ac_high</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">)]:</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;Almgren&#39;</span> <span class="ow">in</span> <span class="n">label</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (kappa=</span><span class="si">{</span><span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">],</span> <span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;cumulative&#39;</span><span class="p">],</span> 
                 <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (days)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Shares Executed&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Execution Trajectories&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">width</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">twap</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">])</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">twap</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;TWAP&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">vwap</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;VWAP&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">ac_low</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AC (Patient)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">ac_high</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">],</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AC (Urgent)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (days)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Shares per Slice&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Execution Rate by Time&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 15.4: Implementation Shortfall Schedule (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a function that generates an execution schedule to minimize implementation shortfall (alpha decay).</p>
<p>The function should:
- Front-load execution to capture alpha before it decays
- Use exponential decay weighting
- Return a list of quantities for each slice
- Higher alpha_decay_rate = more aggressive front-loading</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 15.4: Implementation Shortfall Schedule (Open-ended)</span>
<span class="c1"># </span>
<span class="c1"># Build a function that:</span>
<span class="c1"># - Takes total_quantity, num_slices, and alpha_decay_rate</span>
<span class="c1"># - Uses exponential decay weighting: exp(-alpha_decay_rate * slice_index)</span>
<span class="c1"># - Normalizes weights and allocates quantities</span>
<span class="c1"># - Returns list of quantities per slice</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">implementation_shortfall_schedule</span><span class="p">(</span><span class="n">total_quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_slices</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                                       <span class="n">alpha_decay_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate execution schedule that minimizes implementation shortfall.</span>

<span class="sd">    Uses exponential decay weighting - trade more early when alpha</span>
<span class="sd">    is strongest, less as alpha decays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Exponential decay weights</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_slices</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">alpha_decay_rate</span> <span class="o">*</span> <span class="n">times</span><span class="p">)</span>

    <span class="c1"># Normalize</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Allocate quantities</span>
    <span class="n">quantities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">total_quantity</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Adjust for rounding</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">total_quantity</span> <span class="o">-</span> <span class="n">quantities</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">quantities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diff</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">quantities</span><span class="p">)</span>

<span class="c1"># Compare IS schedules with different decay rates</span>
<span class="n">total_qty</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">num_slices</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">schedules</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;TWAP (baseline)&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">total_qty</span> <span class="o">//</span> <span class="n">num_slices</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_slices</span><span class="p">,</span>
    <span class="s1">&#39;IS (slow decay)&#39;</span><span class="p">:</span> <span class="n">implementation_shortfall_schedule</span><span class="p">(</span><span class="n">total_qty</span><span class="p">,</span> <span class="n">num_slices</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
    <span class="s1">&#39;IS (medium decay)&#39;</span><span class="p">:</span> <span class="n">implementation_shortfall_schedule</span><span class="p">(</span><span class="n">total_qty</span><span class="p">,</span> <span class="n">num_slices</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">),</span>
    <span class="s1">&#39;IS (fast decay)&#39;</span><span class="p">:</span> <span class="n">implementation_shortfall_schedule</span><span class="p">(</span><span class="n">total_qty</span><span class="p">,</span> <span class="n">num_slices</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># Visualize</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_slices</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">schedules</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">schedule</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time Slice&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Shares per Slice&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Implementation Shortfall Algorithm - Front-Loading Comparison&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First 5 slices for each strategy:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schedule</span> <span class="ow">in</span> <span class="n">schedules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">first_five_pct</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">schedule</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">schedule</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">schedule</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">first_five_pct</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% in first 25% of time)&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 15.5: VWAP Tracker (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a class that tracks VWAP execution performance in real-time.</p>
<p>The class should:
- Track actual executions vs planned VWAP schedule
- Calculate slippage vs VWAP benchmark
- Provide metrics on execution quality
- Handle partial fills and timing deviations</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 15.5: VWAP Tracker (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class with:</span>
<span class="c1"># - __init__(target_quantity, planned_schedule, benchmark_vwap)</span>
<span class="c1"># - record_fill(timestamp, quantity, price) method</span>
<span class="c1"># - get_execution_stats() returning dict with:</span>
<span class="c1">#   - actual_vwap: volume-weighted avg of executions</span>
<span class="c1">#   - benchmark_vwap: target VWAP</span>
<span class="c1">#   - slippage_bps: (actual - benchmark) / benchmark * 10000</span>
<span class="c1">#   - completion_rate: executed / target quantity</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VWAPTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Tracks VWAP execution performance in real-time.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">planned_schedule</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> 
                 <span class="n">benchmark_vwap</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_quantity</span> <span class="o">=</span> <span class="n">target_quantity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planned_schedule</span> <span class="o">=</span> <span class="n">planned_schedule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_vwap</span> <span class="o">=</span> <span class="n">benchmark_vwap</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fills</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_executed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">record_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record an execution fill.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fills</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">quantity</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">quantity</span> <span class="o">*</span> <span class="n">price</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_executed</span> <span class="o">+=</span> <span class="n">quantity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">+=</span> <span class="n">quantity</span> <span class="o">*</span> <span class="n">price</span>

    <span class="k">def</span> <span class="nf">get_execution_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get execution quality statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_executed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No executions recorded&#39;</span><span class="p">}</span>

        <span class="n">actual_vwap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_executed</span>
        <span class="n">slippage</span> <span class="o">=</span> <span class="n">actual_vwap</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_vwap</span>
        <span class="n">slippage_bps</span> <span class="o">=</span> <span class="n">slippage</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_vwap</span> <span class="o">*</span> <span class="mi">10000</span>
        <span class="n">completion_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_executed</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_quantity</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;actual_vwap&#39;</span><span class="p">:</span> <span class="n">actual_vwap</span><span class="p">,</span>
            <span class="s1">&#39;benchmark_vwap&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_vwap</span><span class="p">,</span>
            <span class="s1">&#39;slippage&#39;</span><span class="p">:</span> <span class="n">slippage</span><span class="p">,</span>
            <span class="s1">&#39;slippage_bps&#39;</span><span class="p">:</span> <span class="n">slippage_bps</span><span class="p">,</span>
            <span class="s1">&#39;total_executed&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_executed</span><span class="p">,</span>
            <span class="s1">&#39;target_quantity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_quantity</span><span class="p">,</span>
            <span class="s1">&#39;completion_rate&#39;</span><span class="p">:</span> <span class="n">completion_rate</span><span class="p">,</span>
            <span class="s1">&#39;num_fills&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fills</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Test the tracker</span>
<span class="n">tracker</span> <span class="o">=</span> <span class="n">VWAPTracker</span><span class="p">(</span>
    <span class="n">target_quantity</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">planned_schedule</span><span class="o">=</span><span class="p">[</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">],</span>
    <span class="n">benchmark_vwap</span><span class="o">=</span><span class="mf">100.50</span>
<span class="p">)</span>

<span class="c1"># Simulate fills with some slippage</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">base_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="n">fills</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mf">100.52</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1500</span><span class="p">,</span> <span class="mf">100.48</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1500</span><span class="p">,</span> <span class="mf">100.55</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mf">100.51</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mf">100.53</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fills</span><span class="p">):</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">base_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">i</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">record_fill</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

<span class="n">stats</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">get_execution_stats</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VWAP Execution Report&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Benchmark VWAP: $</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;benchmark_vwap&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Actual VWAP: $</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;actual_vwap&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slippage: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;slippage_bps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completion: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;completion_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 15.6: Complete Microstructure Analyzer (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a comprehensive MicrostructureAnalyzer class that combines all the concepts.</p>
<p>The class should:
- Maintain an order book and spread analyzer
- Simulate market activity with random orders/trades
- Calculate comprehensive metrics (spreads, imbalance, impact)
- Compare execution algorithms
- Generate a formatted report</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 15.6: Complete Microstructure Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class with:</span>
<span class="c1"># - __init__(symbol, tick_size) initializing components</span>
<span class="c1"># - simulate_market(num_events, initial_price, volatility, adv)</span>
<span class="c1"># - calculate_metrics() returning comprehensive stats</span>
<span class="c1"># - analyze_execution(quantity) comparing algorithms</span>
<span class="c1"># - generate_report() returning formatted string</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MicrostructureAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive market microstructure analysis tool.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SAMPLE&#39;</span><span class="p">,</span> <span class="n">tick_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span> <span class="o">=</span> <span class="n">tick_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span> <span class="o">=</span> <span class="n">LimitOrderBook</span><span class="p">(</span><span class="n">tick_size</span><span class="o">=</span><span class="n">tick_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spread_analyzer</span> <span class="o">=</span> <span class="n">SpreadAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impact_model</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">quote_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">simulate_market</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_events</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">initial_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
                        <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">avg_daily_volume</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate market activity.&quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impact_model</span> <span class="o">=</span> <span class="n">PriceImpactModel</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">volatility</span><span class="p">,</span> <span class="n">avg_daily_volume</span><span class="o">=</span><span class="n">avg_daily_volume</span><span class="p">)</span>

        <span class="n">current_mid</span> <span class="o">=</span> <span class="n">initial_price</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="mf">0.05</span>

        <span class="c1"># Populate initial book</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">bid</span> <span class="o">=</span> <span class="n">current_mid</span> <span class="o">-</span> <span class="n">spread</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span>
            <span class="n">ask</span> <span class="o">=</span> <span class="n">current_mid</span> <span class="o">+</span> <span class="n">spread</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span>
            <span class="n">qty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">bid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">ask</span><span class="p">)</span>

        <span class="n">base_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_events</span><span class="p">):</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">base_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="n">current_mid</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">volatility</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>

            <span class="n">bid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_bid</span><span class="p">()</span>
            <span class="n">ask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_ask</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bid</span> <span class="ow">and</span> <span class="n">ask</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spread_analyzer</span><span class="o">.</span><span class="n">add_quote</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">quote_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">bid</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ask</span><span class="p">})</span>

            <span class="n">event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="s1">&#39;cancel&#39;</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
                <span class="n">side</span> <span class="o">=</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span>
                <span class="n">qty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
                <span class="n">price</span> <span class="o">=</span> <span class="n">current_mid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span> <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span> <span class="k">else</span> <span class="n">current_mid</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">side</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;market&#39;</span><span class="p">:</span>
                <span class="n">side</span> <span class="o">=</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span>
                <span class="n">qty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
                <span class="n">order</span><span class="p">,</span> <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">side</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spread_analyzer</span><span class="o">.</span><span class="n">add_trade</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> <span class="n">side</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">trade</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">trade</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="o">.</span><span class="n">value</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
                    <span class="n">order_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulated </span><span class="si">{</span><span class="n">num_events</span><span class="si">}</span><span class="s2"> events: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quote_history</span><span class="p">)</span><span class="si">}</span><span class="s2"> quotes, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="p">)</span><span class="si">}</span><span class="s2"> trades&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate comprehensive metrics.&quot;&quot;&quot;</span>
        <span class="n">spread_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spread_analyzer</span><span class="o">.</span><span class="n">summary_stats</span><span class="p">()</span>
        <span class="n">imbalance</span> <span class="o">=</span> <span class="n">calculate_book_imbalance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="p">:</span>
            <span class="n">df_trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="p">)</span>
            <span class="n">buy_volume</span> <span class="o">=</span> <span class="n">df_trades</span><span class="p">[</span><span class="n">df_trades</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">sell_volume</span> <span class="o">=</span> <span class="n">df_trades</span><span class="p">[</span><span class="n">df_trades</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sell&#39;</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">order_flow_imbalance</span> <span class="o">=</span> <span class="p">(</span><span class="n">buy_volume</span> <span class="o">-</span> <span class="n">sell_volume</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">buy_volume</span> <span class="o">+</span> <span class="n">sell_volume</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">buy_volume</span> <span class="o">+</span> <span class="n">sell_volume</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">avg_trade_size</span> <span class="o">=</span> <span class="n">df_trades</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">prices</span> <span class="o">=</span> <span class="n">df_trades</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">roll_spread</span> <span class="o">=</span> <span class="n">estimate_spread_roll</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order_flow_imbalance</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">avg_trade_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">roll_spread</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;spread_stats&#39;</span><span class="p">:</span> <span class="n">spread_stats</span><span class="p">,</span>
            <span class="s1">&#39;book_imbalance&#39;</span><span class="p">:</span> <span class="n">imbalance</span><span class="p">,</span>
            <span class="s1">&#39;order_flow_imbalance&#39;</span><span class="p">:</span> <span class="n">order_flow_imbalance</span><span class="p">,</span>
            <span class="s1">&#39;avg_trade_size&#39;</span><span class="p">:</span> <span class="n">avg_trade_size</span><span class="p">,</span>
            <span class="s1">&#39;roll_spread_estimate&#39;</span><span class="p">:</span> <span class="n">roll_spread</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">analyze_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compare execution strategies.&quot;&quot;&quot;</span>
        <span class="n">algo</span> <span class="o">=</span> <span class="n">ExecutionAlgorithm</span><span class="p">(</span><span class="n">total_quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span> <span class="n">time_horizon</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;TWAP&#39;</span><span class="p">:</span> <span class="n">algo</span><span class="o">.</span><span class="n">twap</span><span class="p">(),</span>
            <span class="s1">&#39;VWAP&#39;</span><span class="p">:</span> <span class="n">algo</span><span class="o">.</span><span class="n">vwap</span><span class="p">(),</span>
            <span class="s1">&#39;Almgren-Chriss&#39;</span><span class="p">:</span> <span class="n">algo</span><span class="o">.</span><span class="n">almgren_chriss</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">impact_model</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schedule</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">total_impact</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">impact_model</span><span class="o">.</span><span class="n">square_root_impact</span><span class="p">(</span><span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;total_impact_bps&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">qty</span>
                    <span class="k">for</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">schedule</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">schedule</span><span class="p">[</span><span class="s1">&#39;estimated_cost_bps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_impact</span> <span class="o">/</span> <span class="n">quantity</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate formatted report.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;MICROSTRUCTURE ANALYSIS REPORT - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SPREAD ANALYSIS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span>
        <span class="p">]</span>

        <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spread_stats&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">ss</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average Quoted Spread: </span><span class="si">{</span><span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avg_quoted_spread_bps&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roll_spread_estimate&#39;</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Roll Spread Estimate: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;roll_spread_estimate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ORDER BOOK STATE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Book Imbalance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;book_imbalance&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Best Bid: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_bid</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_bid</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;Best Bid: N/A&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Best Ask: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_ask</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_ask</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;Best Ask: N/A&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TRADING ACTIVITY&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Total Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Average Trade Size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avg_trade_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> shares&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Order Flow Imbalance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_flow_imbalance&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># Run the analyzer</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">MicrostructureAnalyzer</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;DEMO&#39;</span><span class="p">)</span>
<span class="n">analyzer</span><span class="o">.</span><span class="n">simulate_market</span><span class="p">(</span><span class="n">num_events</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">initial_price</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>

<span class="c1"># Analyze execution</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Execution Analysis for 10,000 shares:&quot;</span><span class="p">)</span>
<span class="n">exec_results</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">analyze_execution</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">exec_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estimated_cost_bps&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps estimated impact&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cost</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Production Microstructure System</h1>
<p>Put together everything you've learned to build a comprehensive microstructure analysis system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
<span class="c1"># Build a complete microstructure analysis system that:</span>
<span class="c1"># 1. Simulates realistic order book activity</span>
<span class="c1"># 2. Calculates spread metrics (quoted, effective, Roll estimate)</span>
<span class="c1"># 3. Models price impact for different order sizes</span>
<span class="c1"># 4. Compares execution algorithms (TWAP, VWAP, AC, IS)</span>
<span class="c1"># 5. Generates a comprehensive analysis report</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ProductionMicrostructureSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete microstructure analysis system for production use.</span>

<span class="sd">    Features:</span>
<span class="sd">    - Order book simulation and analysis</span>
<span class="sd">    - Spread decomposition (quoted, effective, Roll)</span>
<span class="sd">    - Price impact estimation</span>
<span class="sd">    - Execution algorithm comparison</span>
<span class="sd">    - Comprehensive reporting</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tick_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span> <span class="o">=</span> <span class="n">tick_size</span>

        <span class="c1"># Core components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span> <span class="o">=</span> <span class="n">LimitOrderBook</span><span class="p">(</span><span class="n">tick_size</span><span class="o">=</span><span class="n">tick_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spread_analyzer</span> <span class="o">=</span> <span class="n">SpreadAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impact_model</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Data storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_analysis</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">initialize_market</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span> 
                          <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
                          <span class="n">avg_daily_volume</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1_000_000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize market parameters.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_price</span> <span class="o">=</span> <span class="n">initial_price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span> <span class="o">=</span> <span class="n">volatility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adv</span> <span class="o">=</span> <span class="n">avg_daily_volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impact_model</span> <span class="o">=</span> <span class="n">PriceImpactModel</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">volatility</span><span class="p">,</span> <span class="n">avg_daily_volume</span><span class="o">=</span><span class="n">avg_daily_volume</span><span class="p">)</span>

        <span class="c1"># Build initial book</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">bid</span> <span class="o">=</span> <span class="n">initial_price</span> <span class="o">-</span> <span class="n">spread</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span>
            <span class="n">ask</span> <span class="o">=</span> <span class="n">initial_price</span> <span class="o">+</span> <span class="n">spread</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick_size</span>
            <span class="n">qty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">bid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">ask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simulate_trading_day</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_events</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate a full trading day.&quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">current_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_price</span>
        <span class="n">base_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="mf">0.05</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_events</span><span class="p">):</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">base_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">i</span> <span class="o">*</span> <span class="mf">23.4</span><span class="p">)</span>  <span class="c1"># ~6.5 hours</span>
            <span class="n">current_mid</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

            <span class="c1"># Record quote</span>
            <span class="n">bid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_bid</span><span class="p">()</span>
            <span class="n">ask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_ask</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bid</span> <span class="ow">and</span> <span class="n">ask</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spread_analyzer</span><span class="o">.</span><span class="n">add_quote</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">bid</span><span class="p">,</span> <span class="n">ask</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">quote_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">bid</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ask</span><span class="p">,</span>
                    <span class="s1">&#39;midpoint&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">bid</span> <span class="o">+</span> <span class="n">ask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="p">})</span>

            <span class="c1"># Random event</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="s1">&#39;cancel&#39;</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
                <span class="n">side</span> <span class="o">=</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span>
                <span class="n">qty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>
                <span class="n">price</span> <span class="o">=</span> <span class="n">current_mid</span> <span class="o">-</span> <span class="n">offset</span> <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span> <span class="k">else</span> <span class="n">current_mid</span> <span class="o">+</span> <span class="n">offset</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">side</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;market&#39;</span><span class="p">:</span>
                <span class="n">side</span> <span class="o">=</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span>
                <span class="n">qty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
                <span class="n">order</span><span class="p">,</span> <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">add_order</span><span class="p">(</span><span class="n">side</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spread_analyzer</span><span class="o">.</span><span class="n">add_trade</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">trade</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> <span class="n">side</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
                        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">trade</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                        <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">trade</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
                        <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="o">.</span><span class="n">value</span>
                    <span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
                    <span class="n">order_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_all_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate comprehensive metrics.&quot;&quot;&quot;</span>
        <span class="c1"># Spread metrics</span>
        <span class="n">spread_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spread_analyzer</span><span class="o">.</span><span class="n">summary_stats</span><span class="p">()</span>

        <span class="c1"># Book imbalance</span>
        <span class="n">book_imbalance</span> <span class="o">=</span> <span class="n">calculate_book_imbalance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Trade metrics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="p">:</span>
            <span class="n">df_trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="p">)</span>
            <span class="n">buy_vol</span> <span class="o">=</span> <span class="n">df_trades</span><span class="p">[</span><span class="n">df_trades</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">sell_vol</span> <span class="o">=</span> <span class="n">df_trades</span><span class="p">[</span><span class="n">df_trades</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sell&#39;</span><span class="p">][</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">total_vol</span> <span class="o">=</span> <span class="n">buy_vol</span> <span class="o">+</span> <span class="n">sell_vol</span>

            <span class="n">order_flow_imbalance</span> <span class="o">=</span> <span class="p">(</span><span class="n">buy_vol</span> <span class="o">-</span> <span class="n">sell_vol</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_vol</span> <span class="k">if</span> <span class="n">total_vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">avg_trade_size</span> <span class="o">=</span> <span class="n">df_trades</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="c1"># Roll spread</span>
            <span class="n">prices</span> <span class="o">=</span> <span class="n">df_trades</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">roll_spread</span> <span class="o">=</span> <span class="n">estimate_spread_roll</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order_flow_imbalance</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">avg_trade_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">roll_spread</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;spread&#39;</span><span class="p">:</span> <span class="n">spread_stats</span><span class="p">,</span>
            <span class="s1">&#39;book_imbalance&#39;</span><span class="p">:</span> <span class="n">book_imbalance</span><span class="p">,</span>
            <span class="s1">&#39;order_flow_imbalance&#39;</span><span class="p">:</span> <span class="n">order_flow_imbalance</span><span class="p">,</span>
            <span class="s1">&#39;avg_trade_size&#39;</span><span class="p">:</span> <span class="n">avg_trade_size</span><span class="p">,</span>
            <span class="s1">&#39;roll_spread&#39;</span><span class="p">:</span> <span class="n">roll_spread</span><span class="p">,</span>
            <span class="s1">&#39;num_quotes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quote_history</span><span class="p">),</span>
            <span class="s1">&#39;num_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_history</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>

    <span class="k">def</span> <span class="nf">analyze_execution_strategies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze execution strategies for various order sizes.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">order_sizes</span><span class="p">:</span>
            <span class="n">algo</span> <span class="o">=</span> <span class="n">ExecutionAlgorithm</span><span class="p">(</span><span class="n">total_quantity</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">time_horizon</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="n">strategies</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;TWAP&#39;</span><span class="p">:</span> <span class="n">algo</span><span class="o">.</span><span class="n">twap</span><span class="p">(),</span>
                <span class="s1">&#39;VWAP&#39;</span><span class="p">:</span> <span class="n">algo</span><span class="o">.</span><span class="n">vwap</span><span class="p">(),</span>
                <span class="s1">&#39;Almgren-Chriss&#39;</span><span class="p">:</span> <span class="n">algo</span><span class="o">.</span><span class="n">almgren_chriss</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schedule</span> <span class="ow">in</span> <span class="n">strategies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">impact_model</span><span class="p">:</span>
                    <span class="n">total_impact</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">impact_model</span><span class="o">.</span><span class="n">square_root_impact</span><span class="p">(</span><span class="n">qty</span><span class="p">)[</span><span class="s1">&#39;total_impact_bps&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">qty</span>
                        <span class="k">for</span> <span class="n">qty</span> <span class="ow">in</span> <span class="n">schedule</span><span class="p">[</span><span class="s1">&#39;quantities&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">schedule</span><span class="p">[</span><span class="s1">&#39;estimated_cost_bps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_impact</span> <span class="o">/</span> <span class="n">size</span>

            <span class="n">results</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategies</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">execution_analysis</span> <span class="o">=</span> <span class="n">results</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">generate_full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive analysis report.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_all_metrics</span><span class="p">()</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;MICROSTRUCTURE ANALYSIS REPORT&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Symbol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;1. MARKET OVERVIEW&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;   Initial Price: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;   Volatility: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">volatility</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;   Avg Daily Volume: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">adv</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;   Quotes Recorded: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;num_quotes&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;   Trades Executed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;num_trades&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2. SPREAD ANALYSIS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span>
        <span class="p">]</span>

        <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spread&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">ss</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">&quot;   Avg Quoted Spread: </span><span class="si">{</span><span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avg_quoted_spread_bps&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;   Median Quoted Spread: </span><span class="si">{</span><span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;median_quoted_spread_bps&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;   Spread Range: </span><span class="si">{</span><span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_quoted_spread_bps&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">ss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_quoted_spread_bps&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps&quot;</span>
            <span class="p">])</span>

        <span class="k">if</span> <span class="n">ss</span> <span class="ow">and</span> <span class="s1">&#39;avg_effective_spread_bps&#39;</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Avg Effective Spread: </span><span class="si">{</span><span class="n">ss</span><span class="p">[</span><span class="s1">&#39;avg_effective_spread_bps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roll_spread&#39;</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Roll Model Estimate: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;roll_spread&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;3. ORDER BOOK STATE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;   Best Bid: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_bid</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_bid</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;   Best Bid: N/A&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;   Best Ask: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_ask</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">best_ask</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;   Best Ask: N/A&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;   Current Spread: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">spread</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">spread</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;   Current Spread: N/A&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;   Book Imbalance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;book_imbalance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;4. TRADING ACTIVITY&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;   Average Trade Size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;avg_trade_size&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> shares&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;   Order Flow Imbalance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;order_flow_imbalance&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_analysis</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;5. EXECUTION ANALYSIS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span>
            <span class="p">])</span>

            <span class="k">for</span> <span class="n">size</span><span class="p">,</span> <span class="n">strategies</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_analysis</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Order Size: </span><span class="si">{</span><span class="n">size</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> shares (</span><span class="si">{</span><span class="n">size</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">adv</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> of ADV)&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">strategies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estimated_cost_bps&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps&quot;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;END OF REPORT&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<span class="c1"># Run complete analysis</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">ProductionMicrostructureSystem</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">initialize_market</span><span class="p">(</span><span class="n">initial_price</span><span class="o">=</span><span class="mf">175.0</span><span class="p">,</span> <span class="n">volatility</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">avg_daily_volume</span><span class="o">=</span><span class="mi">50_000_000</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">simulate_trading_day</span><span class="p">(</span><span class="n">num_events</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">calculate_all_metrics</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">analyze_execution_strategies</span><span class="p">([</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">500000</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">generate_full_report</span><span class="p">())</span>
<span class="n">system</span><span class="o">.</span><span class="n">order_book</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Order Book Mechanics</h3>
<ul>
<li>Limit order books match orders by price-time priority</li>
<li>Market orders provide immediate execution but pay the spread</li>
<li>Book imbalance can predict short-term price direction</li>
</ul>
<h3>2. Bid-Ask Spread</h3>
<ul>
<li>Compensates market makers for inventory risk and adverse selection</li>
<li>Effective spread often differs from quoted spread</li>
<li>Roll model estimates spread from price autocovariance</li>
</ul>
<h3>3. Price Impact</h3>
<ul>
<li>Grows with square root of trade size (not linearly)</li>
<li>Has permanent (information) and temporary (pressure) components</li>
<li>Key input for execution optimization</li>
</ul>
<h3>4. Optimal Execution</h3>
<ul>
<li>TWAP: Simple, equal slices over time</li>
<li>VWAP: Match market volume profile</li>
<li>Almgren-Chriss: Optimal risk-cost tradeoff</li>
<li>Implementation Shortfall: Front-load when alpha decays</li>
</ul>
<h3>Best Practices</h3>
<ol>
<li>Understand your stock's typical spread and impact</li>
<li>Size orders relative to ADV (&lt; 10% participation is typical)</li>
<li>Choose algorithm based on urgency and information</li>
<li>Monitor execution quality vs benchmarks</li>
</ol></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 16: High-Frequency Concepts</strong>, we'll explore:
- Latency and co-location
- HFT strategies and market making
- Regulations and market structure</p>
<hr />
<p><em>Congratulations on completing Module 15!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="16"><div class="md-cell module-header"><h1>Module 16: High-Frequency Concepts</h1>
<p><strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong><br />
<strong>Part 5: Production &amp; Infrastructure</strong></p>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Understand latency measurement and optimization concepts</li>
<li>Calculate network latency based on distance and medium</li>
<li>Analyze co-location infrastructure and ROI</li>
<li>Implement basic HFT strategy simulations</li>
</ol>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Duration</td>
<td>~2 hours</td>
</tr>
<tr>
<td>Exercises</td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
<tr>
<td>Prerequisites</td>
<td>Module 15 (Market Microstructure)</td>
</tr>
</tbody>
</table></div>
<p><strong>Important Note</strong>: This module is educational. Building actual HFT systems requires significant capital, specialized infrastructure, and regulatory compliance.</p></div>
<div class="md-cell"><h2>Table of Contents</h2>
<ol>
<li><a href="#section-16.1">Section 16.1: Latency and Speed</a></li>
<li><a href="#section-16.2">Section 16.2: Co-Location Basics</a></li>
<li><a href="#section-16.3">Section 16.3: Common HFT Strategies</a></li>
<li><a href="#section-16.4">Section 16.4: Regulatory Considerations</a></li>
<li><a href="#project">Module Project</a></li>
<li><a href="#takeaways">Key Takeaways</a></li>
</ol></div>
<div class="md-cell"><h2>Setup and Imports</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module 16: High-Frequency Concepts&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">45</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<p><a id='section-16.1'></a></p>
<h1>Section 16.1: Latency and Speed</h1>
<p>In HFT, <strong>latency</strong> is everything. A system that's 10 microseconds faster can capture opportunities others miss.</p>
<p><strong>In this section, you will learn:</strong>
- Types of latency in trading systems
- Latency measurement techniques
- Statistical analysis of latency distributions</p>
<h3>What is Latency?</h3>
<p>Latency is the time delay in a system. For trading, we care about:</p>
<ol>
<li><strong>Market Data Latency</strong>: Time for price updates to reach your system</li>
<li><strong>Processing Latency</strong>: Time for your system to make a decision</li>
<li><strong>Order Latency</strong>: Time for your order to reach the exchange</li>
<li><strong>Round-Trip Latency</strong>: Total time from signal to execution confirmation</li>
</ol>
<h3>Latency Benchmarks</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Component</th>
<th>Typical Range</th>
<th>HFT Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>Network (co-located)</td>
<td>1-10 Œºs</td>
<td>&lt; 5 Œºs</td>
</tr>
<tr>
<td>Network (remote)</td>
<td>1-100 ms</td>
<td>N/A</td>
</tr>
<tr>
<td>Software processing</td>
<td>10-1000 Œºs</td>
<td>&lt; 10 Œºs</td>
</tr>
<tr>
<td>Exchange matching</td>
<td>5-50 Œºs</td>
<td>-</td>
</tr>
<tr>
<td>Round-trip (co-lo)</td>
<td>20-100 Œºs</td>
<td>&lt; 50 Œºs</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">LatencyMeasurement</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Tool for measuring and analyzing latency.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start timing.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter_ns</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stop timing and record measurement.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Timer not started&quot;</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter_ns</span><span class="p">()</span>
        <span class="n">latency_ns</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latency_ns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">latency_ns</span>
    
    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latency_ns</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Directly record a latency measurement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latency_ns</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate latency statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">measurements</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurements</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
            <span class="s1">&#39;mean_ns&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
            <span class="s1">&#39;mean_us&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s1">&#39;median_us&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s1">&#39;std_ns&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
            <span class="s1">&#39;min_ns&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
            <span class="s1">&#39;max_ns&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
            <span class="s1">&#39;p50_ns&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s1">&#39;p95_ns&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
            <span class="s1">&#39;p99_ns&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
            <span class="s1">&#39;p99_9_ns&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">),</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">LatencyProfiler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Profile latency across multiple components.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LatencyMeasurement</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">LatencyMeasurement</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LatencyMeasurement</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">statistics</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;Component&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;Count&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Mean (Œºs)&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean_us&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;Median (Œºs)&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median_us&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;P95 (Œºs)&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;p95_ns&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
                    <span class="s1">&#39;P99 (Œºs)&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;p99_ns&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
                    <span class="s1">&#39;Max (Œºs)&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max_ns&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Demonstrate latency measurement</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Latency Measurement Demo&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">profiler</span> <span class="o">=</span> <span class="n">LatencyProfiler</span><span class="p">()</span>

<span class="c1"># Component 1: Dictionary lookup</span>
<span class="n">dict_lookup</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="s2">&quot;dict_lookup&quot;</span><span class="p">)</span>
<span class="n">test_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)}</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">dict_lookup</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">test_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;5000&quot;</span><span class="p">)</span>
    <span class="n">dict_lookup</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="c1"># Component 2: List append</span>
<span class="n">list_append</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="s2">&quot;list_append&quot;</span><span class="p">)</span>
<span class="n">test_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">list_append</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">test_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">list_append</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="c1"># Component 3: NumPy operation</span>
<span class="n">numpy_op</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="s2">&quot;numpy_mean&quot;</span><span class="p">)</span>
<span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">numpy_op</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">numpy_op</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">profiler</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Note: These are Python operations - HFT systems use C++ for nanosecond-level operations&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate the impact of different latency levels on trading</span>
<span class="k">class</span> <span class="nc">LatencySimulator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simulate how latency affects trading outcomes.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opportunity_duration_us</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opportunity_duration</span> <span class="o">=</span> <span class="n">opportunity_duration_us</span>
    
    <span class="k">def</span> <span class="nf">simulate_arbitrage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latency_us</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">initial_spread_bps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> 
                           <span class="n">num_opportunities</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simulate arbitrage capture with given latency.&quot;&quot;&quot;</span>
        <span class="n">captured</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">missed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">partial</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_profit_bps</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_opportunities</span><span class="p">):</span>
            <span class="n">remaining_spread</span> <span class="o">=</span> <span class="n">initial_spread_bps</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">latency_us</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">opportunity_duration</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">latency_us</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opportunity_duration</span><span class="p">:</span>
                <span class="n">missed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">remaining_spread</span> <span class="o">&gt;=</span> <span class="n">initial_spread_bps</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">captured</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">total_profit_bps</span> <span class="o">+=</span> <span class="n">remaining_spread</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">partial</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">total_profit_bps</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">remaining_spread</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;latency_us&#39;</span><span class="p">:</span> <span class="n">latency_us</span><span class="p">,</span>
            <span class="s1">&#39;opportunities&#39;</span><span class="p">:</span> <span class="n">num_opportunities</span><span class="p">,</span>
            <span class="s1">&#39;captured&#39;</span><span class="p">:</span> <span class="n">captured</span><span class="p">,</span>
            <span class="s1">&#39;partial&#39;</span><span class="p">:</span> <span class="n">partial</span><span class="p">,</span>
            <span class="s1">&#39;missed&#39;</span><span class="p">:</span> <span class="n">missed</span><span class="p">,</span>
            <span class="s1">&#39;capture_rate&#39;</span><span class="p">:</span> <span class="n">captured</span> <span class="o">/</span> <span class="n">num_opportunities</span><span class="p">,</span>
            <span class="s1">&#39;total_profit_bps&#39;</span><span class="p">:</span> <span class="n">total_profit_bps</span><span class="p">,</span>
            <span class="s1">&#39;avg_profit_bps&#39;</span><span class="p">:</span> <span class="n">total_profit_bps</span> <span class="o">/</span> <span class="n">num_opportunities</span>
        <span class="p">}</span>

<span class="c1"># Compare different latency levels</span>
<span class="n">simulator</span> <span class="o">=</span> <span class="n">LatencySimulator</span><span class="p">(</span><span class="n">opportunity_duration_us</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">latencies</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">simulator</span><span class="o">.</span><span class="n">simulate_arbitrage</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">initial_spread_bps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">lat</span> <span class="ow">in</span> <span class="n">latencies</span><span class="p">]</span>
<span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Impact of Latency on Arbitrage Capture&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Opportunity duration: 100 Œºs, Initial spread: 10 bps</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_results</span><span class="p">[[</span><span class="s1">&#39;latency_us&#39;</span><span class="p">,</span> <span class="s1">&#39;capture_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;avg_profit_bps&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize latency impact</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;latency_us&#39;</span><span class="p">],</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;capture_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;latency_us&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;capture_rate&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Latency (Œºs)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Capture Rate (%)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Arbitrage Capture Rate vs Latency&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;latency_us&#39;</span><span class="p">],</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;avg_profit_bps&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;latency_us&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;avg_profit_bps&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Latency (Œºs)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average Profit (bps)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Profit per Opportunity vs Latency&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Key insight: In competitive HFT, even 10 Œºs can mean the difference&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;between capturing an opportunity and missing it entirely.&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 16.1: Latency Budget Calculator (Guided)</h3>
<p><strong>Your Task:</strong> Calculate how to allocate a total latency budget across different system components.</p>
<p>Components that are harder to optimize should get larger allocations.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 16.1: Latency Budget Calculator (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_latency_budget</span><span class="p">(</span><span class="n">total_budget_us</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">component_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allocate latency budget across components.</span>
<span class="sd">    </span>
<span class="sd">    Higher weight = harder to optimize = larger allocation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate total weight by summing all values</span>
    <span class="n">total_weight</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">component_weights</span><span class="o">.</span><span class="n">______</span><span class="p">())</span>
    
    <span class="n">allocations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">component_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># TODO: Calculate allocation as proportion of total budget</span>
        <span class="n">allocation</span> <span class="o">=</span> <span class="n">total_budget_us</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight</span> <span class="o">/</span> <span class="n">______</span><span class="p">)</span>
        
        <span class="c1"># TODO: Calculate percentage of total</span>
        <span class="n">pct_of_total</span> <span class="o">=</span> <span class="p">(</span><span class="n">______</span> <span class="o">/</span> <span class="n">total_weight</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="n">allocations</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;budget_us&#39;</span><span class="p">:</span> <span class="n">allocation</span><span class="p">,</span>
            <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
            <span class="s1">&#39;pct_of_total&#39;</span><span class="p">:</span> <span class="n">pct_of_total</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">allocations</span>

<span class="c1"># Test your solution</span>
<span class="c1"># components = {&#39;market_data&#39;: 2.0, &#39;strategy&#39;: 1.0, &#39;risk&#39;: 0.5, &#39;network&#39;: 3.0}</span>
<span class="c1"># budget = calculate_latency_budget(100, components)</span>
<span class="c1"># for comp, alloc in budget.items():</span>
<span class="c1">#     print(f&quot;{comp}: {alloc[&#39;budget_us&#39;]:.1f} Œºs ({alloc[&#39;pct_of_total&#39;]:.1f}%)&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_latency_budget</span><span class="p">(</span><span class="n">total_budget_us</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">component_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allocate latency budget across components.</span>

<span class="sd">    Higher weight = harder to optimize = larger allocation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">component_weights</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="n">allocations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">component_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">allocation</span> <span class="o">=</span> <span class="n">total_budget_us</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight</span> <span class="o">/</span> <span class="n">total_weight</span><span class="p">)</span>
        <span class="n">pct_of_total</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight</span> <span class="o">/</span> <span class="n">total_weight</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="n">allocations</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;budget_us&#39;</span><span class="p">:</span> <span class="n">allocation</span><span class="p">,</span>
            <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
            <span class="s1">&#39;pct_of_total&#39;</span><span class="p">:</span> <span class="n">pct_of_total</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">allocations</span>

<span class="c1"># Test</span>
<span class="n">components</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;market_data_parsing&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="s1">&#39;strategy_logic&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s1">&#39;risk_check&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="s1">&#39;order_construction&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="s1">&#39;network_io&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">budget</span> <span class="o">=</span> <span class="n">calculate_latency_budget</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">components</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Latency Budget Allocation (100 Œºs total)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">alloc</span> <span class="ow">in</span> <span class="n">budget</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="si">:</span><span class="s2">25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;budget_us&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">6.1f</span><span class="si">}</span><span class="s2"> Œºs (</span><span class="si">{</span><span class="n">alloc</span><span class="p">[</span><span class="s1">&#39;pct_of_total&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">4.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-16.2'></a></p>
<h1>Section 16.2: Co-Location Basics</h1>
<p><strong>Co-location</strong> means placing your trading servers physically close to the exchange's matching engine.</p>
<p><strong>In this section, you will learn:</strong>
- Why physical proximity matters
- Network latency calculations
- Co-location infrastructure costs and ROI</p>
<h3>Why Co-Location Matters</h3>
<p>Light travels at approximately:
- 299,792 km/s in vacuum
- ~200,000 km/s in fiber optic cable</p>
<p>This means:
- 1 km of fiber = ~5 Œºs latency
- NY to Chicago (~1,200 km) = ~6 ms minimum
- NY to London (~5,500 km) = ~27 ms minimum</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">NetworkLatencyCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate network latency based on distance and medium.&quot;&quot;&quot;</span>
    
    <span class="n">SPEEDS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;vacuum&#39;</span><span class="p">:</span> <span class="mi">299792</span><span class="p">,</span>
        <span class="s1">&#39;fiber&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span>
        <span class="s1">&#39;microwave&#39;</span><span class="p">:</span> <span class="mi">299792</span><span class="p">,</span>
        <span class="s1">&#39;copper&#39;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="n">EXCHANGES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;NYSE&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;Mahwah, NJ&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="mf">41.08</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">74.14</span><span class="p">},</span>
        <span class="s1">&#39;NASDAQ&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;Carteret, NJ&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="mf">40.58</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">74.23</span><span class="p">},</span>
        <span class="s1">&#39;CME&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;Aurora, IL&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="mf">41.76</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">88.29</span><span class="p">},</span>
        <span class="s1">&#39;LSE&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;Basildon, UK&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="mf">51.57</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="mf">0.49</span><span class="p">},</span>
        <span class="s1">&#39;TSE&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;Tokyo, JP&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="mf">35.68</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="mf">139.75</span><span class="p">},</span>
    <span class="p">}</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">distance_km</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lat1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lon1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lat2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lon2</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate distance using Haversine formula.&quot;&quot;&quot;</span>
        <span class="n">R</span> <span class="o">=</span> <span class="mi">6371</span>
        <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">,</span> <span class="p">[</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">])</span>
        <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">latency_one_way</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">distance_km</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">medium</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;fiber&#39;</span><span class="p">,</span> 
                        <span class="n">overhead_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate one-way latency.&quot;&quot;&quot;</span>
        <span class="n">effective_distance</span> <span class="o">=</span> <span class="n">distance_km</span> <span class="o">*</span> <span class="n">overhead_factor</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SPEEDS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">medium</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SPEEDS</span><span class="p">[</span><span class="s1">&#39;fiber&#39;</span><span class="p">])</span>
        <span class="n">latency_seconds</span> <span class="o">=</span> <span class="n">effective_distance</span> <span class="o">/</span> <span class="n">speed</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;distance_km&#39;</span><span class="p">:</span> <span class="n">distance_km</span><span class="p">,</span>
            <span class="s1">&#39;effective_distance_km&#39;</span><span class="p">:</span> <span class="n">effective_distance</span><span class="p">,</span>
            <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="n">medium</span><span class="p">,</span>
            <span class="s1">&#39;latency_ms&#39;</span><span class="p">:</span> <span class="n">latency_seconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s1">&#39;latency_us&#39;</span><span class="p">:</span> <span class="n">latency_seconds</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">,</span>
            <span class="s1">&#39;round_trip_ms&#39;</span><span class="p">:</span> <span class="n">latency_seconds</span> <span class="o">*</span> <span class="mi">2000</span>
        <span class="p">}</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">exchange_to_exchange</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exchange1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exchange2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                              <span class="n">medium</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;fiber&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate latency between two exchanges.&quot;&quot;&quot;</span>
        <span class="n">loc1</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">EXCHANGES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">exchange1</span><span class="p">)</span>
        <span class="n">loc2</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">EXCHANGES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">exchange2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">loc1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">loc2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">distance_km</span><span class="p">(</span><span class="n">loc1</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">loc1</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">loc2</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">loc2</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">latency_one_way</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">medium</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exchange1</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">loc1</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">exchange2</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">loc2</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate latencies between major exchanges</span>
<span class="n">calc</span> <span class="o">=</span> <span class="n">NetworkLatencyCalculator</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Network Latency Between Major Exchanges&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="n">routes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;NYSE&#39;</span><span class="p">,</span> <span class="s1">&#39;NASDAQ&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;NYSE&#39;</span><span class="p">,</span> <span class="s1">&#39;CME&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;NYSE&#39;</span><span class="p">,</span> <span class="s1">&#39;LSE&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;NYSE&#39;</span><span class="p">,</span> <span class="s1">&#39;TSE&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CME&#39;</span><span class="p">,</span> <span class="s1">&#39;LSE&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">ex1</span><span class="p">,</span> <span class="n">ex2</span> <span class="ow">in</span> <span class="n">routes</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">exchange_to_exchange</span><span class="p">(</span><span class="n">ex1</span><span class="p">,</span> <span class="n">ex2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ex1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">ex2</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Distance: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2"> km&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  One-way (fiber): </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;latency_ms&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ms&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Round-trip: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;round_trip_ms&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ms&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Co-location advantage visualization</span>
<span class="n">distances</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
<span class="n">latencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc</span><span class="o">.</span><span class="n">latency_one_way</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;fiber&#39;</span><span class="p">,</span> <span class="n">overhead_factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)[</span><span class="s1">&#39;latency_us&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">distances</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">latencies</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">annotations</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="s2">&quot;Same rack (10m)&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;Same data center (100m)&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;Same city (10km)&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;Cross-country (1000km)&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">latencies</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Distance (km)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;One-way Latency (Œºs)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Network Latency vs Distance (Fiber Optic)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Key distances:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">latencies</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">d</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s2">&gt;8.0f</span><span class="si">}</span><span class="s2"> meters: </span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">&gt;10.1f</span><span class="si">}</span><span class="s2"> Œºs&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 16.2: Co-Location ROI Calculator (Guided)</h3>
<p><strong>Your Task:</strong> Calculate the return on investment for a co-location setup.</p>
<p>Compare latency advantage against competitors to estimate profit potential.</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 16.2: Co-Location ROI Calculator (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_colocation_roi</span><span class="p">(</span><span class="n">setup_cost</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">monthly_cost</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                              <span class="n">our_latency_us</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">competitor_latency_us</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                              <span class="n">profit_per_us_saved</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate ROI of co-location setup.</span>
<span class="sd">    </span>
<span class="sd">    Returns dict with profit estimates and payback period.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate latency advantage (competitor minus ours)</span>
    <span class="n">latency_advantage</span> <span class="o">=</span> <span class="n">competitor_latency_us</span> <span class="o">-</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Calculate daily profit (only if we have an advantage)</span>
    <span class="n">daily_profit</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">latency_advantage</span> <span class="o">*</span> <span class="n">profit_per_us_saved</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate monthly profit (21 trading days)</span>
    <span class="n">monthly_profit</span> <span class="o">=</span> <span class="n">daily_profit</span> <span class="o">*</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Calculate net monthly (profit minus costs)</span>
    <span class="n">net_monthly</span> <span class="o">=</span> <span class="n">monthly_profit</span> <span class="o">-</span> <span class="n">______</span>
    
    <span class="c1"># Calculate payback period</span>
    <span class="k">if</span> <span class="n">net_monthly</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">payback_months</span> <span class="o">=</span> <span class="n">setup_cost</span> <span class="o">/</span> <span class="n">net_monthly</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">payback_months</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;latency_advantage_us&#39;</span><span class="p">:</span> <span class="n">latency_advantage</span><span class="p">,</span>
        <span class="s1">&#39;daily_profit&#39;</span><span class="p">:</span> <span class="n">daily_profit</span><span class="p">,</span>
        <span class="s1">&#39;monthly_profit&#39;</span><span class="p">:</span> <span class="n">monthly_profit</span><span class="p">,</span>
        <span class="s1">&#39;monthly_cost&#39;</span><span class="p">:</span> <span class="n">monthly_cost</span><span class="p">,</span>
        <span class="s1">&#39;net_monthly&#39;</span><span class="p">:</span> <span class="n">net_monthly</span><span class="p">,</span>
        <span class="s1">&#39;setup_cost&#39;</span><span class="p">:</span> <span class="n">setup_cost</span><span class="p">,</span>
        <span class="s1">&#39;payback_months&#39;</span><span class="p">:</span> <span class="n">payback_months</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># roi = calculate_colocation_roi(100000, 30000, 5, 20, 500)</span>
<span class="c1"># print(f&quot;Latency advantage: {roi[&#39;latency_advantage_us&#39;]} Œºs&quot;)</span>
<span class="c1"># print(f&quot;Net monthly: ${roi[&#39;net_monthly&#39;]:,.0f}&quot;)</span>
<span class="c1"># print(f&quot;Payback: {roi[&#39;payback_months&#39;]:.1f} months&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_colocation_roi</span><span class="p">(</span><span class="n">setup_cost</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">monthly_cost</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                              <span class="n">our_latency_us</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">competitor_latency_us</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                              <span class="n">profit_per_us_saved</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate ROI of co-location setup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">latency_advantage</span> <span class="o">=</span> <span class="n">competitor_latency_us</span> <span class="o">-</span> <span class="n">our_latency_us</span>
    <span class="n">daily_profit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">latency_advantage</span> <span class="o">*</span> <span class="n">profit_per_us_saved</span><span class="p">)</span>
    <span class="n">monthly_profit</span> <span class="o">=</span> <span class="n">daily_profit</span> <span class="o">*</span> <span class="mi">21</span>
    <span class="n">net_monthly</span> <span class="o">=</span> <span class="n">monthly_profit</span> <span class="o">-</span> <span class="n">monthly_cost</span>

    <span class="k">if</span> <span class="n">net_monthly</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">payback_months</span> <span class="o">=</span> <span class="n">setup_cost</span> <span class="o">/</span> <span class="n">net_monthly</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">payback_months</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;latency_advantage_us&#39;</span><span class="p">:</span> <span class="n">latency_advantage</span><span class="p">,</span>
        <span class="s1">&#39;daily_profit&#39;</span><span class="p">:</span> <span class="n">daily_profit</span><span class="p">,</span>
        <span class="s1">&#39;monthly_profit&#39;</span><span class="p">:</span> <span class="n">monthly_profit</span><span class="p">,</span>
        <span class="s1">&#39;monthly_cost&#39;</span><span class="p">:</span> <span class="n">monthly_cost</span><span class="p">,</span>
        <span class="s1">&#39;net_monthly&#39;</span><span class="p">:</span> <span class="n">net_monthly</span><span class="p">,</span>
        <span class="s1">&#39;setup_cost&#39;</span><span class="p">:</span> <span class="n">setup_cost</span><span class="p">,</span>
        <span class="s1">&#39;payback_months&#39;</span><span class="p">:</span> <span class="n">payback_months</span>
    <span class="p">}</span>

<span class="c1"># Compare setups</span>
<span class="n">setups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;Basic (no FPGA)&#39;</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Premium (with FPGA)&#39;</span><span class="p">,</span> <span class="mi">150000</span><span class="p">,</span> <span class="mi">35000</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Co-Location ROI Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Competitor latency: 20 Œºs&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Profit per Œºs saved: $500/day</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">setup</span><span class="p">,</span> <span class="n">monthly</span><span class="p">,</span> <span class="n">latency</span> <span class="ow">in</span> <span class="n">setups</span><span class="p">:</span>
    <span class="n">roi</span> <span class="o">=</span> <span class="n">calculate_colocation_roi</span><span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="n">monthly</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Setup: $</span><span class="si">{</span><span class="n">setup</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">, Monthly: $</span><span class="si">{</span><span class="n">monthly</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Our latency: </span><span class="si">{</span><span class="n">latency</span><span class="si">}</span><span class="s2"> Œºs, Advantage: </span><span class="si">{</span><span class="n">roi</span><span class="p">[</span><span class="s1">&#39;latency_advantage_us&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Œºs&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Net monthly: $</span><span class="si">{</span><span class="n">roi</span><span class="p">[</span><span class="s1">&#39;net_monthly&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Payback: </span><span class="si">{</span><span class="n">roi</span><span class="p">[</span><span class="s1">&#39;payback_months&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> months&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-16.3'></a></p>
<h1>Section 16.3: Common HFT Strategies</h1>
<p>HFT strategies exploit speed advantages in various ways.</p>
<p><strong>In this section, you will learn:</strong>
- Market making mechanics
- Statistical arbitrage concepts
- Latency arbitrage basics</p>
<h3>Strategy Categories</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Strategy</th>
<th>Description</th>
<th>Key Risk</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Market Making</strong></td>
<td>Provide liquidity, earn spread</td>
<td>Inventory risk</td>
</tr>
<tr>
<td><strong>Statistical Arbitrage</strong></td>
<td>Exploit price discrepancies</td>
<td>Model risk</td>
</tr>
<tr>
<td><strong>Latency Arbitrage</strong></td>
<td>Trade on info faster</td>
<td>Speed competition</td>
</tr>
<tr>
<td><strong>Event Arbitrage</strong></td>
<td>React to news quickly</td>
<td>Information risk</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">HFTMarketMaker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simplified HFT market making simulator.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">inventory_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> 
                 <span class="n">base_spread_bps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span> <span class="o">=</span> <span class="n">inventory_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_spread_bps</span> <span class="o">=</span> <span class="n">base_spread_bps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span> <span class="o">=</span> <span class="n">volatility</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pnl_history</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">calculate_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mid_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">market_volatility</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate bid and ask quotes with inventory skew.&quot;&quot;&quot;</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">market_volatility</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span>
        <span class="n">spread_pct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_spread_bps</span> <span class="o">/</span> <span class="mi">10000</span>
        <span class="n">spread_pct</span> <span class="o">*=</span> <span class="n">vol</span> <span class="o">/</span> <span class="mf">0.02</span>
        
        <span class="n">inventory_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span>
        <span class="n">skew</span> <span class="o">=</span> <span class="n">inventory_ratio</span> <span class="o">*</span> <span class="n">spread_pct</span> <span class="o">*</span> <span class="mf">0.5</span>
        
        <span class="n">half_spread</span> <span class="o">=</span> <span class="n">spread_pct</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">bid</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">half_spread</span> <span class="o">-</span> <span class="n">skew</span><span class="p">)</span>
        <span class="n">ask</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">half_spread</span> <span class="o">-</span> <span class="n">skew</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">bid</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ask</span><span class="p">,</span> <span class="s1">&#39;spread_pct&#39;</span><span class="p">:</span> <span class="n">spread_pct</span><span class="p">,</span> <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="n">skew</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">:</span> <span class="n">mid_price</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">process_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process a fill.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">+=</span> <span class="n">quantity</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">-=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">quantity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">-=</span> <span class="n">quantity</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">quantity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">quantity</span><span class="p">,</span> <span class="s1">&#39;inventory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">simulate_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">num_ticks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> 
                         <span class="n">fill_probability</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simulate a trading session.&quot;&quot;&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">initial_price</span>
        
        <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_ticks</span><span class="p">):</span>
            <span class="n">price</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span>
            <span class="n">quotes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_quotes</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">fill_probability</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span><span class="p">:</span>
                        <span class="n">qty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">process_fill</span><span class="p">(</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="n">quotes</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">],</span> <span class="n">qty</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">&gt;</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory_limit</span><span class="p">:</span>
                        <span class="n">qty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">process_fill</span><span class="p">(</span><span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="n">quotes</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">],</span> <span class="n">qty</span><span class="p">)</span>
            
            <span class="n">mtm_pnl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span> <span class="o">*</span> <span class="n">price</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pnl_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;tick&#39;</span><span class="p">:</span> <span class="n">tick</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;inventory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">,</span> 
                                     <span class="s1">&#39;cash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">,</span> <span class="s1">&#39;mtm_pnl&#39;</span><span class="p">:</span> <span class="n">mtm_pnl</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pnl_history</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run market making simulation</span>
<span class="n">mm</span> <span class="o">=</span> <span class="n">HFTMarketMaker</span><span class="p">(</span><span class="s1">&#39;DEMO&#39;</span><span class="p">,</span> <span class="n">inventory_limit</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">base_spread_bps</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">simulate_session</span><span class="p">(</span><span class="n">initial_price</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">num_ticks</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market Making Simulation Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Inventory: </span><span class="si">{</span><span class="n">mm</span><span class="o">.</span><span class="n">inventory</span><span class="si">}</span><span class="s2"> shares&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Cash: $</span><span class="si">{</span><span class="n">mm</span><span class="o">.</span><span class="n">cash</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final MTM PnL: $</span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;mtm_pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize market making session</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;tick&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price ($)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Price Evolution&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;tick&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;inventory&#39;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;tick&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;inventory&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Inventory&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Inventory Position&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;tick&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;mtm_pnl&#39;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;tick&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;mtm_pnl&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MTM PnL ($)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Tick&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mark-to-Market PnL&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PairsArbitrage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simple pairs trading / stat arb strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_zscore</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">exit_zscore</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_zscore</span> <span class="o">=</span> <span class="n">entry_zscore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_zscore</span> <span class="o">=</span> <span class="n">exit_zscore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spread_history</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">lookback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">update_and_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price_a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price_b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update spread history and generate trading signal.&quot;&quot;&quot;</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">price_a</span> <span class="o">-</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">price_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spread_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spread</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spread_history</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;wait&#39;</span><span class="p">,</span> <span class="s1">&#39;zscore&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        
        <span class="n">spread_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spread_history</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spread_array</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">spread_array</span><span class="p">)</span>
        <span class="n">zscore</span> <span class="o">=</span> <span class="p">(</span><span class="n">spread</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span> <span class="k">if</span> <span class="n">std</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;hold&#39;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zscore</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_zscore</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;short_spread&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">zscore</span> <span class="o">&lt;</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">entry_zscore</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;long_spread&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">zscore</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_zscore</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;close_long&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">zscore</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_zscore</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;close_short&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span> <span class="s1">&#39;zscore&#39;</span><span class="p">:</span> <span class="n">zscore</span><span class="p">,</span> <span class="s1">&#39;spread&#39;</span><span class="p">:</span> <span class="n">spread</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate pairs trading</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">n_points</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">common_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">noise_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="n">noise_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)</span>

<span class="n">price_a</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">common_factor</span> <span class="o">+</span> <span class="n">noise_a</span>
<span class="n">price_b</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">common_factor</span> <span class="o">+</span> <span class="n">noise_b</span>

<span class="n">pairs</span> <span class="o">=</span> <span class="n">PairsArbitrage</span><span class="p">(</span><span class="n">entry_zscore</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">exit_zscore</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">pairs</span><span class="o">.</span><span class="n">update_and_signal</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">pb</span><span class="p">)</span> <span class="k">for</span> <span class="n">pa</span><span class="p">,</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">price_a</span><span class="p">,</span> <span class="n">price_b</span><span class="p">)]</span>
<span class="n">df_signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>

<span class="n">signal_counts</span> <span class="o">=</span> <span class="n">df_signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pairs Trading Simulation&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Signal Counts:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sig</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">signal_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 16.3: Market Maker Spread Calculator (Guided)</h3>
<p><strong>Your Task:</strong> Calculate optimal bid-ask spreads based on inventory and volatility.</p>
<p>The spread should widen when:
- Inventory is high (to reduce position)
- Volatility is high (to compensate for risk)</p>
<p>Fill in the blanks:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 16.3: Market Maker Spread Calculator (Guided)</span>
<span class="k">def</span> <span class="nf">calculate_optimal_spread</span><span class="p">(</span><span class="n">mid_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">base_spread_bps</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                              <span class="n">inventory</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">inventory_limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">base_volatility</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate optimal bid-ask spread.</span>
<span class="sd">    </span>
<span class="sd">    Returns bid, ask, and spread components.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Convert base spread from bps to decimal</span>
    <span class="n">spread_pct</span> <span class="o">=</span> <span class="n">base_spread_bps</span> <span class="o">/</span> <span class="n">______</span>
    
    <span class="c1"># TODO: Adjust spread for volatility (higher vol = wider spread)</span>
    <span class="n">vol_multiplier</span> <span class="o">=</span> <span class="n">volatility</span> <span class="o">/</span> <span class="n">______</span>
    <span class="n">adjusted_spread</span> <span class="o">=</span> <span class="n">spread_pct</span> <span class="o">*</span> <span class="n">vol_multiplier</span>
    
    <span class="c1"># TODO: Calculate inventory ratio for skewing</span>
    <span class="n">inventory_ratio</span> <span class="o">=</span> <span class="n">inventory</span> <span class="o">/</span> <span class="n">______</span>
    
    <span class="c1"># Skew quotes based on inventory (positive inventory = lower bid)</span>
    <span class="n">skew</span> <span class="o">=</span> <span class="n">inventory_ratio</span> <span class="o">*</span> <span class="n">adjusted_spread</span> <span class="o">*</span> <span class="mf">0.5</span>
    
    <span class="c1"># Calculate final quotes</span>
    <span class="n">half_spread</span> <span class="o">=</span> <span class="n">adjusted_spread</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">bid</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">half_spread</span> <span class="o">-</span> <span class="n">______</span><span class="p">)</span>
    <span class="n">ask</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">half_spread</span> <span class="o">-</span> <span class="n">skew</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">bid</span><span class="p">,</span>
        <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ask</span><span class="p">,</span>
        <span class="s1">&#39;spread_bps&#39;</span><span class="p">:</span> <span class="n">adjusted_spread</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s1">&#39;skew_bps&#39;</span><span class="p">:</span> <span class="n">skew</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s1">&#39;vol_multiplier&#39;</span><span class="p">:</span> <span class="n">vol_multiplier</span>
    <span class="p">}</span>

<span class="c1"># Test your solution</span>
<span class="c1"># result = calculate_optimal_spread(100, 5, 200, 1000, 0.03, 0.02)</span>
<span class="c1"># print(f&quot;Bid: ${result[&#39;bid&#39;]:.4f}, Ask: ${result[&#39;ask&#39;]:.4f}&quot;)</span>
<span class="c1"># print(f&quot;Spread: {result[&#39;spread_bps&#39;]:.2f} bps, Skew: {result[&#39;skew_bps&#39;]:.2f} bps&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_optimal_spread</span><span class="p">(</span><span class="n">mid_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">base_spread_bps</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                              <span class="n">inventory</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">inventory_limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">base_volatility</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate optimal bid-ask spread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spread_pct</span> <span class="o">=</span> <span class="n">base_spread_bps</span> <span class="o">/</span> <span class="mi">10000</span>
    <span class="n">vol_multiplier</span> <span class="o">=</span> <span class="n">volatility</span> <span class="o">/</span> <span class="n">base_volatility</span>
    <span class="n">adjusted_spread</span> <span class="o">=</span> <span class="n">spread_pct</span> <span class="o">*</span> <span class="n">vol_multiplier</span>
    <span class="n">inventory_ratio</span> <span class="o">=</span> <span class="n">inventory</span> <span class="o">/</span> <span class="n">inventory_limit</span>
    <span class="n">skew</span> <span class="o">=</span> <span class="n">inventory_ratio</span> <span class="o">*</span> <span class="n">adjusted_spread</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="n">half_spread</span> <span class="o">=</span> <span class="n">adjusted_spread</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">bid</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">half_spread</span> <span class="o">-</span> <span class="n">skew</span><span class="p">)</span>
    <span class="n">ask</span> <span class="o">=</span> <span class="n">mid_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">half_spread</span> <span class="o">-</span> <span class="n">skew</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">bid</span><span class="p">,</span>
        <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">ask</span><span class="p">,</span>
        <span class="s1">&#39;spread_bps&#39;</span><span class="p">:</span> <span class="n">adjusted_spread</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s1">&#39;skew_bps&#39;</span><span class="p">:</span> <span class="n">skew</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s1">&#39;vol_multiplier&#39;</span><span class="p">:</span> <span class="n">vol_multiplier</span>
    <span class="p">}</span>

<span class="c1"># Test with different scenarios</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market Maker Spread Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;Neutral inventory, low vol&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Long inventory, low vol&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Short inventory, low vol&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Neutral inventory, high vol&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;Long inventory, high vol&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">desc</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="n">vol</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_optimal_spread</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bid: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Ask: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Spread: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;spread_bps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps, Skew: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;skew_bps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> bps&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<p><a id='section-16.4'></a></p>
<h1>Section 16.4: Regulatory Considerations</h1>
<p>HFT operates in a heavily regulated environment.</p>
<p><strong>In this section, you will learn:</strong>
- Key regulations (Reg NMS, MiFID II)
- Prohibited practices (spoofing, layering)
- Pre-trade risk controls</p>
<h3>Prohibited Practices</h3>
<ul>
<li><strong>Spoofing</strong>: Placing orders you intend to cancel</li>
<li><strong>Layering</strong>: Creating false impression of supply/demand</li>
<li><strong>Quote Stuffing</strong>: Flooding exchanges with orders to create latency</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ComplianceChecker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Basic compliance checking for trading activities.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{</span>
            <span class="s1">&#39;max_order_rate_per_second&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;max_cancel_ratio&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
            <span class="s1">&#39;max_position_size&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
            <span class="s1">&#39;max_daily_orders&#39;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_timestamps</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders_sent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders_canceled</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders_filled</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">violations</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">check_order_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if order rate exceeds limit.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_timestamps</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_timestamps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order_timestamps</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        
        <span class="n">current_rate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">order_timestamps</span><span class="p">)</span>
        <span class="n">max_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_order_rate_per_second&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">current_rate</span> <span class="o">&gt;=</span> <span class="n">max_rate</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Order rate </span><span class="si">{</span><span class="n">current_rate</span><span class="si">}</span><span class="s1">/s exceeds limit </span><span class="si">{</span><span class="n">max_rate</span><span class="si">}</span><span class="s1">/s&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">check_cancel_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if cancellation ratio is suspicious.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders_sent</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        
        <span class="n">cancel_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders_canceled</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders_sent</span>
        <span class="n">max_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_cancel_ratio&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">cancel_ratio</span> <span class="o">&gt;</span> <span class="n">max_ratio</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Cancel ratio </span><span class="si">{</span><span class="n">cancel_ratio</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1"> exceeds limit </span><span class="si">{</span><span class="n">max_ratio</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">check_position_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_position</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">order_qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if order would exceed position limits.&quot;&quot;&quot;</span>
        <span class="n">max_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_position_size&#39;</span><span class="p">]</span>
        <span class="n">resulting_position</span> <span class="o">=</span> <span class="n">current_position</span> <span class="o">+</span> <span class="n">order_qty</span>
        
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">resulting_position</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_pos</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Position </span><span class="si">{</span><span class="n">resulting_position</span><span class="si">}</span><span class="s1"> exceeds limit </span><span class="si">{</span><span class="n">max_pos</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;passed&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">pre_order_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run all pre-order compliance checks.&quot;&quot;&quot;</span>
        <span class="n">checks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;order_rate&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_order_rate</span><span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;cancel_ratio&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_cancel_ratio</span><span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;position_limit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_position_limit</span><span class="p">(</span>
                <span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_position&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quantity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="p">]</span>
        
        <span class="n">all_passed</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;passed&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">checks</span><span class="p">)</span>
        <span class="n">failed_checks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">checks</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;passed&#39;</span><span class="p">]]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_passed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span> <span class="s1">&#39;failed_checks&#39;</span><span class="p">:</span> <span class="n">failed_checks</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;approved&#39;</span><span class="p">:</span> <span class="n">all_passed</span><span class="p">,</span> <span class="s1">&#39;checks&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">checks</span><span class="p">),</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="n">failed_checks</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">record_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders_sent</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">record_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders_canceled</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">record_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders_filled</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;orders_sent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders_sent</span><span class="p">,</span>
            <span class="s1">&#39;orders_canceled&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders_canceled</span><span class="p">,</span>
            <span class="s1">&#39;orders_filled&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders_filled</span><span class="p">,</span>
            <span class="s1">&#39;cancel_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders_canceled</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders_sent</span><span class="p">),</span>
            <span class="s1">&#39;fill_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders_filled</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders_sent</span><span class="p">),</span>
            <span class="s1">&#39;violations&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">violations</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Demo compliance checker</span>
<span class="n">checker</span> <span class="o">=</span> <span class="n">ComplianceChecker</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="s1">&#39;TEST&#39;</span><span class="p">,</span>
        <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;current_position&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">50</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="mi">2500</span>
    <span class="p">}</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">checker</span><span class="o">.</span><span class="n">pre_order_check</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;approved&#39;</span><span class="p">]:</span>
        <span class="n">checker</span><span class="o">.</span><span class="n">record_order</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.85</span><span class="p">:</span>
            <span class="n">checker</span><span class="o">.</span><span class="n">record_cancel</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checker</span><span class="o">.</span><span class="n">record_fill</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compliance Summary&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">checker</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">checker</span><span class="o">.</span><span class="n">violations</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">checker</span><span class="o">.</span><span class="n">violations</span><span class="p">)</span><span class="si">}</span><span class="s2"> compliance violations detected!&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 16.4: Spoofing Detector (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a class that detects potential spoofing behavior by analyzing order patterns.</p>
<p>The detector should:
- Track orders and their outcomes (filled vs canceled)
- Flag suspicious patterns (high cancel rate, short order lifetime)
- Calculate a spoofing risk score</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 16.4: Spoofing Detector (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class with:</span>
<span class="c1"># - __init__(cancel_threshold, min_lifetime_ms)</span>
<span class="c1"># - record_order(order_id, timestamp, side, price, quantity)</span>
<span class="c1"># - record_cancel(order_id, timestamp)</span>
<span class="c1"># - record_fill(order_id, timestamp)</span>
<span class="c1"># - calculate_risk_score() returning score and flags</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SpoofingDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect potential spoofing behavior.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cancel_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">min_lifetime_ms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_threshold</span> <span class="o">=</span> <span class="n">cancel_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_lifetime_ms</span> <span class="o">=</span> <span class="n">min_lifetime_ms</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canceled_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filled_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_lived_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">record_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> 
                     <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record a new order.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="n">quantity</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;active&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">record_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record order cancellation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span>
        <span class="n">lifetime_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;canceled&#39;</span>
        <span class="n">order</span><span class="p">[</span><span class="s1">&#39;lifetime_ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lifetime_ms</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canceled_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">lifetime_ms</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_lifetime_ms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">short_lived_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">record_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record order fill.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">[</span><span class="n">order_id</span><span class="p">]</span>
        <span class="n">lifetime_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;filled&#39;</span>
        <span class="n">order</span><span class="p">[</span><span class="s1">&#39;lifetime_ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lifetime_ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filled_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">calculate_risk_score</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate spoofing risk score.&quot;&quot;&quot;</span>
        <span class="n">total_orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canceled_count</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled_count</span>

        <span class="k">if</span> <span class="n">total_orders</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="n">cancel_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canceled_count</span> <span class="o">/</span> <span class="n">total_orders</span>
        <span class="n">short_lived_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_lived_count</span> <span class="o">/</span> <span class="n">total_orders</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">cancel_ratio</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_threshold</span><span class="p">:</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;High cancel ratio: </span><span class="si">{</span><span class="n">cancel_ratio</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">50</span>

        <span class="k">if</span> <span class="n">short_lived_ratio</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Many short-lived orders: </span><span class="si">{</span><span class="n">short_lived_ratio</span><span class="si">:</span><span class="s1">.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">30</span>

        <span class="k">if</span> <span class="n">cancel_ratio</span> <span class="o">&gt;</span> <span class="mf">0.95</span> <span class="ow">and</span> <span class="n">short_lived_ratio</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;CRITICAL: Pattern consistent with spoofing&#39;</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">20</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">score</span><span class="p">),</span>
            <span class="s1">&#39;cancel_ratio&#39;</span><span class="p">:</span> <span class="n">cancel_ratio</span><span class="p">,</span>
            <span class="s1">&#39;short_lived_ratio&#39;</span><span class="p">:</span> <span class="n">short_lived_ratio</span><span class="p">,</span>
            <span class="s1">&#39;flags&#39;</span><span class="p">:</span> <span class="n">flags</span><span class="p">,</span>
            <span class="s1">&#39;total_orders&#39;</span><span class="p">:</span> <span class="n">total_orders</span>
        <span class="p">}</span>

<span class="c1"># Test the detector</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">SpoofingDetector</span><span class="p">(</span><span class="n">cancel_threshold</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">min_lifetime_ms</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">base_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">order_time</span> <span class="o">=</span> <span class="n">base_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="n">i</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">record_order</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;order_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">order_time</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.95</span><span class="p">:</span>
        <span class="n">cancel_time</span> <span class="o">=</span> <span class="n">order_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">record_cancel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;order_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cancel_time</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fill_time</span> <span class="o">=</span> <span class="n">order_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">record_fill</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;order_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fill_time</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">calculate_risk_score</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spoofing Detection Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Risk Score: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/100&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancel Ratio: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;cancel_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;flags&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 16.5: Latency Anomaly Detector (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a class that detects latency anomalies (spikes) in a trading system.</p>
<p>The detector should:
- Track latency measurements over time
- Identify anomalies using percentile thresholds
- Provide statistics and anomaly counts</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 16.5: Latency Anomaly Detector (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class with:</span>
<span class="c1"># - __init__(window_size, anomaly_percentile)</span>
<span class="c1"># - record_latency(timestamp, latency_us)</span>
<span class="c1"># - is_anomaly(latency_us) returning bool</span>
<span class="c1"># - get_statistics() returning dict with mean, p99, anomaly count</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LatencyAnomalyDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect latency anomalies in trading systems.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">anomaly_percentile</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">99</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anomaly_percentile</span> <span class="o">=</span> <span class="n">anomaly_percentile</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">latencies</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anomaly_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">record_latency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">latency_us</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record a latency measurement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latency_us</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_anomaly</span><span class="p">(</span><span class="n">latency_us</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anomaly_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">is_anomaly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latency_us</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if latency is an anomaly.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latencies</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latencies</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">anomaly_percentile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">latency_us</span> <span class="o">&gt;</span> <span class="n">threshold</span>

    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get latency statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">latencies</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">latencies</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
            <span class="s1">&#39;mean_us&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
            <span class="s1">&#39;median_us&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
            <span class="s1">&#39;std_us&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
            <span class="s1">&#39;min_us&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
            <span class="s1">&#39;max_us&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span>
            <span class="s1">&#39;p95_us&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">95</span><span class="p">),</span>
            <span class="s1">&#39;p99_us&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
            <span class="s1">&#39;anomaly_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">anomaly_count</span><span class="p">,</span>
            <span class="s1">&#39;anomaly_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">anomaly_count</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_count</span><span class="p">)</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">LatencyAnomalyDetector</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">anomaly_percentile</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">base_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">):</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">base_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">microseconds</span><span class="o">=</span><span class="n">i</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">base_latency</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">:</span>
        <span class="n">latency</span> <span class="o">=</span> <span class="n">base_latency</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">latency</span> <span class="o">=</span> <span class="n">base_latency</span>

    <span class="n">detector</span><span class="o">.</span><span class="n">record_latency</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">latency</span><span class="p">)</span>

<span class="n">stats</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Latency Anomaly Detection&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean_us&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Œºs&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;P99: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;p99_us&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Œºs&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Anomalies: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;anomaly_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;anomaly_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 16.6: Complete HFT System Analyzer (Open-ended)</h3>
<p><strong>Your Task:</strong></p>
<p>Build a comprehensive HFT system analyzer that combines latency profiling, compliance checking, and performance metrics.</p>
<p>The analyzer should:
- Profile latency across multiple components
- Run compliance checks on simulated orders
- Detect latency anomalies
- Generate a comprehensive report</p>
<p>Your implementation:</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 16.6: Complete HFT System Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class with:</span>
<span class="c1"># - __init__(name) initializing profiler, compliance checker</span>
<span class="c1"># - simulate_tick(base_latencies) simulating one tick</span>
<span class="c1"># - run_simulation(num_ticks) running full simulation</span>
<span class="c1"># - latency_breakdown() returning DataFrame</span>
<span class="c1"># - generate_report() returning comprehensive analysis string</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary><b>Click to reveal solution</b></summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">HFTSystemAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive HFT system analysis tool.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;HFT System&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span> <span class="o">=</span> <span class="n">LatencyProfiler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compliance</span> <span class="o">=</span> <span class="n">ComplianceChecker</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;market_data_recv&#39;</span><span class="p">,</span> <span class="s1">&#39;data_parsing&#39;</span><span class="p">,</span> <span class="s1">&#39;strategy_compute&#39;</span><span class="p">,</span>
            <span class="s1">&#39;risk_check&#39;</span><span class="p">,</span> <span class="s1">&#39;order_send&#39;</span><span class="p">,</span> <span class="s1">&#39;order_ack&#39;</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tick_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">simulate_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_latencies</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simulate a single tick.&quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">base_latencies</span> <span class="ow">or</span> <span class="p">{</span>
            <span class="s1">&#39;market_data_recv&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;data_parsing&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;strategy_compute&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;risk_check&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;order_send&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;order_ack&#39;</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">}</span>

        <span class="n">tick_latencies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">total_latency</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">base_us</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">actual_us</span> <span class="o">=</span> <span class="n">base_us</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
            <span class="n">actual_ns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">actual_us</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">actual_ns</span><span class="p">)</span>
            <span class="n">tick_latencies</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">actual_us</span>
            <span class="n">total_latency</span> <span class="o">+=</span> <span class="n">actual_us</span>

        <span class="n">tick_latencies</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_latency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tick_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tick_latencies</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tick_latencies</span>

    <span class="k">def</span> <span class="nf">run_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_ticks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run full simulation.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_ticks</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulate_tick</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tick_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">latency_breakdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get latency breakdown.&quot;&quot;&quot;</span>
        <span class="n">breakdown</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_mean</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span><span class="o">.</span><span class="n">statistics</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
                <span class="n">breakdown</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;component&#39;</span><span class="p">:</span> <span class="n">comp</span><span class="p">,</span>
                    <span class="s1">&#39;mean_us&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean_us&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;p99_us&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;p99_ns&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span>
                <span class="p">})</span>
                <span class="n">total_mean</span> <span class="o">+=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean_us&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">breakdown</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;pct_of_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;mean_us&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_mean</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">breakdown</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive report.&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;HFT SYSTEM ANALYSIS REPORT: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;COMPONENT SUMMARY&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LATENCY BREAKDOWN&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span>
        <span class="p">]</span>

        <span class="n">breakdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latency_breakdown</span><span class="p">()</span>
        <span class="n">total_mean</span> <span class="o">=</span> <span class="n">breakdown</span><span class="p">[</span><span class="s1">&#39;mean_us&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total_p99</span> <span class="o">=</span> <span class="n">breakdown</span><span class="p">[</span><span class="s1">&#39;p99_us&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">breakdown</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">report</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Total Mean Latency: </span><span class="si">{</span><span class="n">total_mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Œºs&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Total P99 Latency: </span><span class="si">{</span><span class="n">total_p99</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Œºs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RECOMMENDATIONS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span>
        <span class="p">])</span>

        <span class="n">bottleneck</span> <span class="o">=</span> <span class="n">breakdown</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">breakdown</span><span class="p">[</span><span class="s1">&#39;mean_us&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1. Primary bottleneck: </span><span class="si">{</span><span class="n">bottleneck</span><span class="p">[</span><span class="s1">&#39;component&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">bottleneck</span><span class="p">[</span><span class="s1">&#39;pct_of_total&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total_mean</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;2. Consider FPGA acceleration&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_p99</span> <span class="o">&gt;</span> <span class="n">total_mean</span> <span class="o">*</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;3. High jitter - investigate sources&quot;</span><span class="p">)</span>

        <span class="n">report</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

<span class="c1"># Run</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">HFTSystemAnalyzer</span><span class="p">(</span><span class="s2">&quot;Production Trading System&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">run_simulation</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<p><a id='project'></a></p>
<h1>Module Project: Complete HFT Analysis Suite</h1>
<p>Build a production-ready HFT analysis system combining all concepts.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># YOUR CODE HERE - Module Project</span>
<span class="c1"># Build a complete HFT analysis suite that:</span>
<span class="c1"># 1. Profiles latency across all system components</span>
<span class="c1"># 2. Simulates market making with inventory management</span>
<span class="c1"># 3. Runs compliance checks on all orders</span>
<span class="c1"># 4. Detects latency anomalies and spoofing patterns</span>
<span class="c1"># 5. Generates a comprehensive report with recommendations</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<p><a id='takeaways'></a></p>
<h1>Key Takeaways</h1>
<h2>What You Learned</h2>
<h3>1. Latency and Speed</h3>
<ul>
<li>In HFT, microseconds matter - 10Œºs can mean profit or loss</li>
<li>Measure latency at each component to identify bottlenecks</li>
<li>Focus on tail latencies (P99) not just mean</li>
</ul>
<h3>2. Co-Location</h3>
<ul>
<li>Physical proximity to exchanges dramatically reduces latency</li>
<li>Speed of light limits minimum latency based on distance</li>
<li>Co-location is expensive but essential for competitive HFT</li>
</ul>
<h3>3. HFT Strategies</h3>
<ul>
<li>Market making: Provide liquidity, earn the spread</li>
<li>Statistical arbitrage: Exploit price discrepancies</li>
<li>Latency arbitrage: React faster than others</li>
</ul>
<h3>4. Regulatory Compliance</h3>
<ul>
<li>HFT is heavily regulated</li>
<li>Prohibited: spoofing, layering, quote stuffing</li>
<li>Pre-trade risk controls are required</li>
</ul>
<h3>Reality Check</h3>
<ul>
<li>Building HFT systems requires millions in capital</li>
<li>Competition has compressed returns</li>
<li>Most retail traders should focus on longer-term strategies</li>
</ul></div>
<div class="md-cell"><h2>Coming Up Next</h2>
<p>In <strong>Module 17: Cloud Deployment</strong>, we'll learn how to deploy trading systems in the cloud - a more accessible approach for most traders.</p>
<hr />
<p><em>Congratulations on completing Module 16!</em></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="17"><div class="md-cell module-header"><h1>Module 17: Cloud Deployment</h1>
<h2>Part 5: Production &amp; Infrastructure</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:
- Design cloud architectures for trading systems on AWS/GCP/Azure
- Containerize trading applications with Docker
- Build serverless functions for event-driven workflows
- Implement CI/CD pipelines for automated deployment</p>
<hr /></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Environment setup</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module 17: Cloud Deployment&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Note: This module covers cloud concepts and configuration.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Actual deployment requires cloud provider accounts.&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 17.1: Cloud Architecture</h2>
<h3>Major Cloud Providers</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Provider</th>
<th>Strengths</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>AWS</strong></td>
<td>Most services, market leader</td>
<td>General purpose, enterprise</td>
</tr>
<tr>
<td><strong>GCP</strong></td>
<td>Data analytics, ML, networking</td>
<td>Data-heavy applications</td>
</tr>
<tr>
<td><strong>Azure</strong></td>
<td>Microsoft integration, enterprise</td>
<td>Corporate environments</td>
</tr>
</tbody>
</table></div>
<h3>Key Services for Trading Systems</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Service Type</th>
<th>AWS</th>
<th>GCP</th>
<th>Azure</th>
</tr>
</thead>
<tbody>
<tr>
<td>Compute</td>
<td>EC2</td>
<td>Compute Engine</td>
<td>Virtual Machines</td>
</tr>
<tr>
<td>Serverless</td>
<td>Lambda</td>
<td>Cloud Functions</td>
<td>Functions</td>
</tr>
<tr>
<td>Containers</td>
<td>ECS/EKS</td>
<td>GKE</td>
<td>AKS</td>
</tr>
<tr>
<td>Database</td>
<td>RDS/DynamoDB</td>
<td>Cloud SQL/Firestore</td>
<td>SQL Database</td>
</tr>
<tr>
<td>Message Queue</td>
<td>SQS/SNS</td>
<td>Pub/Sub</td>
<td>Service Bus</td>
</tr>
<tr>
<td>Storage</td>
<td>S3</td>
<td>Cloud Storage</td>
<td>Blob Storage</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CloudService</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a cloud service configuration.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># aws, gcp, azure</span>
    <span class="n">service_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tier</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">region</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">estimated_monthly_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Estimate monthly cost based on tier.&quot;&quot;&quot;</span>
        <span class="c1"># Simplified cost estimates</span>
        <span class="n">base_costs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;compute&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span>
            <span class="s1">&#39;serverless&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span>
            <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span>
            <span class="s1">&#39;storage&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
            <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">base_costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service_type</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tier</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CloudArchitecture</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Design and plan cloud architecture for trading systems.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;aws&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CloudService</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># (from_service, to_service)</span>
    
    <span class="k">def</span> <span class="nf">add_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">service_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                    <span class="n">tier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">,</span>
                    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CloudService</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a service to the architecture.&quot;&quot;&quot;</span>
        <span class="n">service</span> <span class="o">=</span> <span class="n">CloudService</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
            <span class="n">service_type</span><span class="o">=</span><span class="n">service_type</span><span class="p">,</span>
            <span class="n">tier</span><span class="o">=</span><span class="n">tier</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">service</span>
    
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_service</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_service</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define a connection between services.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">from_service</span><span class="p">,</span> <span class="n">to_service</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">total_estimated_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total estimated monthly cost.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">estimated_monthly_cost</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">generate_terraform</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate basic Terraform configuration.&quot;&quot;&quot;</span>
        <span class="n">tf_config</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# Terraform configuration for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# Provider: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Provider block</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;aws&#39;</span><span class="p">:</span>
            <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;provider &quot;aws&quot; {&#39;</span><span class="p">)</span>
            <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  region = &quot;us-east-1&quot;&#39;</span><span class="p">)</span>
            <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;gcp&#39;</span><span class="p">:</span>
            <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;provider &quot;google&quot; {&#39;</span><span class="p">)</span>
            <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  project = &quot;your-project-id&quot;&#39;</span><span class="p">)</span>
            <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  region  = &quot;us-central1&quot;&#39;</span><span class="p">)</span>
            <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        
        <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="c1"># Resource blocks</span>
        <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">:</span>
            <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# </span><span class="si">{</span><span class="n">service</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">service</span><span class="o">.</span><span class="n">service_type</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">resource_name</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">service</span><span class="o">.</span><span class="n">service_type</span> <span class="o">==</span> <span class="s1">&#39;compute&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;aws&#39;</span><span class="p">:</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;resource &quot;aws_instance&quot; &quot;</span><span class="si">{</span><span class="n">resource_name</span><span class="si">}</span><span class="s1">&quot; </span><span class="se">{{</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  ami           = &quot;ami-0c55b159cbfafe1f0&quot;&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  instance_type = &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_instance_type</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">tier</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  tags = </span><span class="se">{{</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;    Name = &quot;</span><span class="si">{</span><span class="n">service</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">service</span><span class="o">.</span><span class="n">service_type</span> <span class="o">==</span> <span class="s1">&#39;serverless&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;aws&#39;</span><span class="p">:</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;resource &quot;aws_lambda_function&quot; &quot;</span><span class="si">{</span><span class="n">resource_name</span><span class="si">}</span><span class="s1">&quot; </span><span class="se">{{</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  function_name = &quot;</span><span class="si">{</span><span class="n">resource_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  runtime       = &quot;python3.9&quot;&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  handler       = &quot;handler.main&quot;&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  memory_size   = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_lambda_memory</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">tier</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">service</span><span class="o">.</span><span class="n">service_type</span> <span class="o">==</span> <span class="s1">&#39;database&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;aws&#39;</span><span class="p">:</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;resource &quot;aws_db_instance&quot; &quot;</span><span class="si">{</span><span class="n">resource_name</span><span class="si">}</span><span class="s1">&quot; </span><span class="se">{{</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  identifier        = &quot;</span><span class="si">{</span><span class="n">resource_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  engine            = &quot;postgres&quot;&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  instance_class    = &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_db_instance</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">tier</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  allocated_storage = 20&#39;</span><span class="p">)</span>
                    <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
            
            <span class="n">tf_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tf_config</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_instance_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get AWS instance type for tier.&quot;&quot;&quot;</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="s1">&#39;t3.micro&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="s1">&#39;t3.medium&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="s1">&#39;t3.xlarge&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tier</span><span class="p">,</span> <span class="s1">&#39;t3.medium&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_lambda_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get Lambda memory for tier.&quot;&quot;&quot;</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tier</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_db_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get RDS instance class for tier.&quot;&quot;&quot;</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="s1">&#39;db.t3.micro&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="s1">&#39;db.t3.medium&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="s1">&#39;db.r5.large&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tier</span><span class="p">,</span> <span class="s1">&#39;db.t3.medium&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">display_architecture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display architecture summary.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cloud Architecture: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Provider: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Services:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">estimated_monthly_cost</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">service_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Tier: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">tier</span><span class="si">}</span><span class="s2">, Region: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      Est. Cost: $</span><span class="si">{</span><span class="n">cost</span><span class="si">}</span><span class="s2">/month&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connections:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">from_s</span><span class="p">,</span> <span class="n">to_s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">from_s</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">to_s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Estimated Cost: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_estimated_cost</span><span class="p">()</span><span class="si">}</span><span class="s2">/month&quot;</span><span class="p">)</span>

<span class="c1"># Design a trading system architecture</span>
<span class="n">arch</span> <span class="o">=</span> <span class="n">CloudArchitecture</span><span class="p">(</span><span class="s2">&quot;Quantitative Trading Platform&quot;</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span>

<span class="c1"># Add services</span>
<span class="n">arch</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;Market Data Processor&quot;</span><span class="p">,</span> <span class="s2">&quot;serverless&quot;</span><span class="p">,</span> <span class="n">tier</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
<span class="n">arch</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;Strategy Engine&quot;</span><span class="p">,</span> <span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="n">tier</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
<span class="n">arch</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;Order Manager&quot;</span><span class="p">,</span> <span class="s2">&quot;serverless&quot;</span><span class="p">,</span> <span class="n">tier</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">)</span>
<span class="n">arch</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;Trade Database&quot;</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="n">tier</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
<span class="n">arch</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;Market Data Storage&quot;</span><span class="p">,</span> <span class="s2">&quot;storage&quot;</span><span class="p">,</span> <span class="n">tier</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>
<span class="n">arch</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;Event Queue&quot;</span><span class="p">,</span> <span class="s2">&quot;queue&quot;</span><span class="p">,</span> <span class="n">tier</span><span class="o">=</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>

<span class="c1"># Define connections</span>
<span class="n">arch</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;Market Data Processor&quot;</span><span class="p">,</span> <span class="s2">&quot;Event Queue&quot;</span><span class="p">)</span>
<span class="n">arch</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;Event Queue&quot;</span><span class="p">,</span> <span class="s2">&quot;Strategy Engine&quot;</span><span class="p">)</span>
<span class="n">arch</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;Strategy Engine&quot;</span><span class="p">,</span> <span class="s2">&quot;Order Manager&quot;</span><span class="p">)</span>
<span class="n">arch</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;Strategy Engine&quot;</span><span class="p">,</span> <span class="s2">&quot;Trade Database&quot;</span><span class="p">)</span>
<span class="n">arch</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;Market Data Processor&quot;</span><span class="p">,</span> <span class="s2">&quot;Market Data Storage&quot;</span><span class="p">)</span>

<span class="n">arch</span><span class="o">.</span><span class="n">display_architecture</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate Terraform configuration</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated Terraform Configuration:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">arch</span><span class="o">.</span><span class="n">generate_terraform</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 17.1: Service Cost Calculator (Guided)</h3>
<p>Create a function that calculates optimal service tiers based on budget constraints.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 17.1: Service Cost Calculator (Guided)</span>

<span class="k">def</span> <span class="nf">calculate_optimal_tiers</span><span class="p">(</span><span class="n">services</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">budget</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate optimal service tiers within budget.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        services: Dict of {service_name: service_type}</span>
<span class="sd">        budget: Monthly budget in dollars</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dict with allocations and analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Cost estimates by service type and tier</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;compute&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span>
        <span class="s1">&#39;serverless&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span>
        <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span>
        <span class="s1">&#39;storage&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
    <span class="p">}</span>
    
    <span class="n">tiers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">]</span>
    <span class="n">allocations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># TODO: Calculate number of services</span>
    <span class="n">num_services</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">services</span><span class="p">)</span>
    
    <span class="c1"># TODO: Calculate budget per service</span>
    <span class="n">budget_per_service</span> <span class="o">=</span> <span class="n">budget</span> <span class="o">/</span> <span class="n">______</span>
    
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">svc_type</span> <span class="ow">in</span> <span class="n">services</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># TODO: Get cost table for this service type</span>
        <span class="n">type_costs</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">svc_type</span><span class="p">,</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">])</span>
        
        <span class="c1"># Find best tier within budget</span>
        <span class="n">selected_tier</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span>
        <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="n">tiers</span><span class="p">:</span>
            <span class="n">tier_cost</span> <span class="o">=</span> <span class="n">type_costs</span><span class="p">[</span><span class="n">tier</span><span class="p">]</span>
            <span class="c1"># TODO: Check if tier is affordable</span>
            <span class="k">if</span> <span class="n">tier_cost</span> <span class="o">&lt;=</span> <span class="n">______</span><span class="p">:</span>
                <span class="n">selected_tier</span> <span class="o">=</span> <span class="n">tier</span>
        
        <span class="n">allocations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">svc_type</span><span class="p">,</span>
            <span class="s1">&#39;tier&#39;</span><span class="p">:</span> <span class="n">selected_tier</span><span class="p">,</span>
            <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">type_costs</span><span class="p">[</span><span class="n">selected_tier</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="c1"># TODO: Add to running total</span>
        <span class="n">total_cost</span> <span class="n">______</span> <span class="n">type_costs</span><span class="p">[</span><span class="n">selected_tier</span><span class="p">]</span>
    
    <span class="c1"># TODO: Calculate remaining budget</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">budget</span> <span class="n">______</span> <span class="n">total_cost</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;allocations&#39;</span><span class="p">:</span> <span class="n">allocations</span><span class="p">,</span>
        <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
        <span class="s1">&#39;budget&#39;</span><span class="p">:</span> <span class="n">budget</span><span class="p">,</span>
        <span class="s1">&#39;remaining&#39;</span><span class="p">:</span> <span class="n">remaining</span><span class="p">,</span>
        <span class="c1"># TODO: Calculate utilization percentage</span>
        <span class="s1">&#39;utilization&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">total_cost</span> <span class="o">/</span> <span class="n">______</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">services</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;API Server&#39;</span><span class="p">:</span> <span class="s1">&#39;compute&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Data Processor&#39;</span><span class="p">:</span> <span class="s1">&#39;serverless&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Trade DB&#39;</span><span class="p">:</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Cache&#39;</span><span class="p">:</span> <span class="s1">&#39;storage&#39;</span>
<span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_optimal_tiers</span><span class="p">(</span><span class="n">services</span><span class="p">,</span> <span class="n">budget</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Budget: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;budget&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Cost: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_cost&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remaining: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;remaining&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Utilization: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;utilization&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Allocations:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;allocations&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;tier&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ($</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/mo)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_optimal_tiers</span><span class="p">(</span><span class="n">services</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">budget</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate optimal service tiers within budget.</span>

<span class="sd">    Args:</span>
<span class="sd">        services: Dict of {service_name: service_type}</span>
<span class="sd">        budget: Monthly budget in dollars</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict with allocations and analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;compute&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span>
        <span class="s1">&#39;serverless&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span>
        <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span>
        <span class="s1">&#39;storage&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="n">tiers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">]</span>
    <span class="n">allocations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">num_services</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">services</span><span class="p">)</span>
    <span class="n">budget_per_service</span> <span class="o">=</span> <span class="n">budget</span> <span class="o">/</span> <span class="n">num_services</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">svc_type</span> <span class="ow">in</span> <span class="n">services</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">type_costs</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">svc_type</span><span class="p">,</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">])</span>

        <span class="n">selected_tier</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span>
        <span class="k">for</span> <span class="n">tier</span> <span class="ow">in</span> <span class="n">tiers</span><span class="p">:</span>
            <span class="n">tier_cost</span> <span class="o">=</span> <span class="n">type_costs</span><span class="p">[</span><span class="n">tier</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tier_cost</span> <span class="o">&lt;=</span> <span class="n">budget_per_service</span><span class="p">:</span>
                <span class="n">selected_tier</span> <span class="o">=</span> <span class="n">tier</span>

        <span class="n">allocations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">svc_type</span><span class="p">,</span>
            <span class="s1">&#39;tier&#39;</span><span class="p">:</span> <span class="n">selected_tier</span><span class="p">,</span>
            <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">type_costs</span><span class="p">[</span><span class="n">selected_tier</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">type_costs</span><span class="p">[</span><span class="n">selected_tier</span><span class="p">]</span>

    <span class="n">remaining</span> <span class="o">=</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">total_cost</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;allocations&#39;</span><span class="p">:</span> <span class="n">allocations</span><span class="p">,</span>
        <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
        <span class="s1">&#39;budget&#39;</span><span class="p">:</span> <span class="n">budget</span><span class="p">,</span>
        <span class="s1">&#39;remaining&#39;</span><span class="p">:</span> <span class="n">remaining</span><span class="p">,</span>
        <span class="s1">&#39;utilization&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">total_cost</span> <span class="o">/</span> <span class="n">budget</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 17.2: Containerization</h2>
<p><strong>Containers</strong> package your application with all its dependencies, ensuring it runs the same everywhere.</p>
<h3>Why Docker?</h3>
<ul>
<li><strong>Consistency</strong>: "Works on my machine" becomes "works everywhere"</li>
<li><strong>Isolation</strong>: Each service runs in its own environment</li>
<li><strong>Portability</strong>: Move between cloud providers easily</li>
<li><strong>Scaling</strong>: Spin up multiple instances quickly</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">DockerfileGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate Dockerfiles for trading applications.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;python-trading&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># Python Trading Application</span>
<span class="s1">FROM python:3.10-slim</span>

<span class="s1"># Set working directory</span>
<span class="s1">WORKDIR /app</span>

<span class="s1"># Install system dependencies</span>
<span class="s1">RUN apt-get update &amp;&amp; apt-get install -y </span><span class="se">\\</span><span class="s1"></span>
<span class="s1">    gcc </span><span class="se">\\</span><span class="s1"></span>
<span class="s1">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span>

<span class="s1"># Copy requirements first (for caching)</span>
<span class="s1">COPY requirements.txt .</span>
<span class="s1">RUN pip install --no-cache-dir -r requirements.txt</span>

<span class="s1"># Copy application code</span>
<span class="s1">COPY . .</span>

<span class="s1"># Set environment variables</span>
<span class="s1">ENV PYTHONUNBUFFERED=1</span>
<span class="s1">ENV PYTHONDONTWRITEBYTECODE=1</span>

<span class="s1"># Expose port</span>
<span class="s1">EXPOSE </span><span class="si">{port}</span><span class="s1"></span>

<span class="s1"># Run the application</span>
<span class="s1">CMD [&quot;python&quot;, &quot;</span><span class="si">{entrypoint}</span><span class="s1">&quot;]</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">,</span>
        
        <span class="s1">&#39;python-api&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># Python API Service</span>
<span class="s1">FROM python:3.10-slim</span>

<span class="s1">WORKDIR /app</span>

<span class="s1"># Install dependencies</span>
<span class="s1">COPY requirements.txt .</span>
<span class="s1">RUN pip install --no-cache-dir -r requirements.txt</span>

<span class="s1"># Copy application</span>
<span class="s1">COPY . .</span>

<span class="s1"># Environment</span>
<span class="s1">ENV PYTHONUNBUFFERED=1</span>

<span class="s1">EXPOSE </span><span class="si">{port}</span><span class="s1"></span>

<span class="s1"># Use gunicorn for production</span>
<span class="s1">CMD [&quot;gunicorn&quot;, &quot;--bind&quot;, &quot;0.0.0.0:</span><span class="si">{port}</span><span class="s1">&quot;, &quot;--workers&quot;, &quot;4&quot;, &quot;</span><span class="si">{entrypoint}</span><span class="s1">:app&quot;]</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">,</span>
        
        <span class="s1">&#39;python-jupyter&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1"># Jupyter Notebook for Research</span>
<span class="s1">FROM python:3.10</span>

<span class="s1">WORKDIR /notebooks</span>

<span class="s1"># Install dependencies</span>
<span class="s1">COPY requirements.txt .</span>
<span class="s1">RUN pip install --no-cache-dir -r requirements.txt</span>
<span class="s1">RUN pip install jupyter</span>

<span class="s1"># Copy notebooks</span>
<span class="s1">COPY . .</span>

<span class="s1">EXPOSE 8888</span>

<span class="s1">CMD [&quot;jupyter&quot;, &quot;notebook&quot;, &quot;--ip=0.0.0.0&quot;, &quot;--port=8888&quot;, &quot;--no-browser&quot;, &quot;--allow-root&quot;]</span>
<span class="s1">&#39;&#39;&#39;</span>
    <span class="p">}</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">,</span> 
                 <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate Dockerfile from template.&quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TEMPLATES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TEMPLATES</span><span class="p">[</span><span class="s1">&#39;python-trading&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="n">entrypoint</span><span class="p">)</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">generate_requirements</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">packages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate requirements.txt content.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">packages</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DockerComposeGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate Docker Compose configurations for multi-service applications.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">networks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">build</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">ports</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">depends_on</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">volumes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a service to the compose file.&quot;&quot;&quot;</span>
        <span class="n">service</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>
        <span class="k">if</span> <span class="n">build</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build</span>
        <span class="k">if</span> <span class="n">ports</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;ports&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ports</span>
        <span class="k">if</span> <span class="n">environment</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">environment</span>
        <span class="k">if</span> <span class="n">depends_on</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;depends_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">depends_on</span>
        <span class="k">if</span> <span class="n">volumes</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;volumes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volumes</span>
        <span class="k">if</span> <span class="n">command</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span>
        
        <span class="n">service</span><span class="p">[</span><span class="s1">&#39;restart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unless-stopped&#39;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">service</span>
    
    <span class="k">def</span> <span class="nf">add_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a named volume.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate docker-compose.yml content.&quot;&quot;&quot;</span>
        <span class="n">compose</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;3.8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">:</span>
            <span class="n">compose</span><span class="p">[</span><span class="s1">&#39;volumes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">compose</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Generate Dockerfile for a trading application</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dockerfile for Trading Application:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">dockerfile</span> <span class="o">=</span> <span class="n">DockerfileGenerator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="s1">&#39;python-trading&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="s1">&#39;trading_bot&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dockerfile</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate Docker Compose for complete trading system</span>
<span class="n">compose</span> <span class="o">=</span> <span class="n">DockerComposeGenerator</span><span class="p">(</span><span class="s2">&quot;trading-system&quot;</span><span class="p">)</span>

<span class="c1"># Database</span>
<span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
    <span class="n">image</span><span class="o">=</span><span class="s1">&#39;postgres:15&#39;</span><span class="p">,</span>
    <span class="n">ports</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;5432:5432&#39;</span><span class="p">],</span>
    <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;POSTGRES_DB&#39;</span><span class="p">:</span> <span class="s1">&#39;trading&#39;</span><span class="p">,</span>
        <span class="s1">&#39;POSTGRES_USER&#39;</span><span class="p">:</span> <span class="s1">&#39;trader&#39;</span><span class="p">,</span>
        <span class="s1">&#39;POSTGRES_PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;$</span><span class="si">{DB_PASSWORD}</span><span class="s1">&#39;</span>
    <span class="p">},</span>
    <span class="n">volumes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;postgres_data:/var/lib/postgresql/data&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Redis for caching</span>
<span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;redis&#39;</span><span class="p">,</span>
    <span class="n">image</span><span class="o">=</span><span class="s1">&#39;redis:7-alpine&#39;</span><span class="p">,</span>
    <span class="n">ports</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;6379:6379&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Market data collector</span>
<span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;data-collector&#39;</span><span class="p">,</span>
    <span class="n">build</span><span class="o">=</span><span class="s1">&#39;./data_collector&#39;</span><span class="p">,</span>
    <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;API_KEY&#39;</span><span class="p">:</span> <span class="s1">&#39;$</span><span class="si">{MARKET_API_KEY}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;REDIS_URL&#39;</span><span class="p">:</span> <span class="s1">&#39;redis://redis:6379&#39;</span>
    <span class="p">},</span>
    <span class="n">depends_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;redis&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Strategy engine</span>
<span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;strategy-engine&#39;</span><span class="p">,</span>
    <span class="n">build</span><span class="o">=</span><span class="s1">&#39;./strategy&#39;</span><span class="p">,</span>
    <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql://trader:$</span><span class="si">{DB_PASSWORD}</span><span class="s1">@postgres:5432/trading&#39;</span><span class="p">,</span>
        <span class="s1">&#39;REDIS_URL&#39;</span><span class="p">:</span> <span class="s1">&#39;redis://redis:6379&#39;</span>
    <span class="p">},</span>
    <span class="n">depends_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="s1">&#39;data-collector&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># API server</span>
<span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
    <span class="n">build</span><span class="o">=</span><span class="s1">&#39;./api&#39;</span><span class="p">,</span>
    <span class="n">ports</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;8000:8000&#39;</span><span class="p">],</span>
    <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">:</span> <span class="s1">&#39;postgresql://trader:$</span><span class="si">{DB_PASSWORD}</span><span class="s1">@postgres:5432/trading&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">:</span> <span class="s1">&#39;$</span><span class="si">{API_SECRET_KEY}</span><span class="s1">&#39;</span>
    <span class="p">},</span>
    <span class="n">depends_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;postgres&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Dashboard</span>
<span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dashboard&#39;</span><span class="p">,</span>
    <span class="n">build</span><span class="o">=</span><span class="s1">&#39;./dashboard&#39;</span><span class="p">,</span>
    <span class="n">ports</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;8050:8050&#39;</span><span class="p">],</span>
    <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;API_URL&#39;</span><span class="p">:</span> <span class="s1">&#39;http://api:8000&#39;</span>
    <span class="p">},</span>
    <span class="n">depends_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;api&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">compose</span><span class="o">.</span><span class="n">add_volume</span><span class="p">(</span><span class="s1">&#39;postgres_data&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Docker Compose Configuration:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">compose</span><span class="o">.</span><span class="n">generate</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 17.2: Docker Service Builder (Guided)</h3>
<p>Build a function that generates Docker Compose service configurations with proper dependencies.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 17.2: Docker Service Builder (Guided)</span>

<span class="k">def</span> <span class="nf">build_docker_services</span><span class="p">(</span><span class="n">components</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build Docker Compose services with dependency resolution.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        components: List of component specs with name, type, dependencies</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Docker Compose services dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Port mappings by service type</span>
    <span class="n">default_ports</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;api&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span>
        <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="s1">&#39;cache&#39;</span><span class="p">:</span> <span class="mi">6379</span><span class="p">,</span>
        <span class="s1">&#39;dashboard&#39;</span><span class="p">:</span> <span class="mi">8050</span><span class="p">,</span>
        <span class="s1">&#39;worker&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">}</span>
    
    <span class="c1"># Docker images by type</span>
    <span class="n">default_images</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;postgres:15&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cache&#39;</span><span class="p">:</span> <span class="s1">&#39;redis:7-alpine&#39;</span>
    <span class="p">}</span>
    
    <span class="n">services</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">component</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">svc_type</span> <span class="o">=</span> <span class="n">component</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="c1"># TODO: Get dependencies with default empty list</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">_______</span><span class="p">,</span> <span class="p">[])</span>
        
        <span class="n">service</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;restart&#39;</span><span class="p">:</span> <span class="s1">&#39;unless-stopped&#39;</span><span class="p">}</span>
        
        <span class="c1"># Set image or build context</span>
        <span class="k">if</span> <span class="n">svc_type</span> <span class="ow">in</span> <span class="n">default_images</span><span class="p">:</span>
            <span class="c1"># TODO: Assign image from default_images</span>
            <span class="n">service</span><span class="p">[</span><span class="n">______</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_images</span><span class="p">[</span><span class="n">svc_type</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: Set build context</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./</span><span class="si">{</span><span class="n">______</span><span class="si">}</span><span class="s1">&#39;</span>
        
        <span class="c1"># Set ports if applicable</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">default_ports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">svc_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">port</span><span class="p">:</span>
            <span class="c1"># TODO: Create port mapping string</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;ports&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">______</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        
        <span class="c1"># Add dependencies</span>
        <span class="c1"># TODO: Check if deps is not empty</span>
        <span class="k">if</span> <span class="n">______</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;depends_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deps</span>
        
        <span class="n">services</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">service</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;3.8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="n">services</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">components</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="p">[]},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cache&#39;</span><span class="p">,</span> <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="p">[]},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;redis&#39;</span><span class="p">]},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;worker&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;worker&#39;</span><span class="p">,</span> <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;redis&#39;</span><span class="p">]},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;dashboard&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;dashboard&#39;</span><span class="p">,</span> <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;api&#39;</span><span class="p">]}</span>
<span class="p">]</span>

<span class="n">compose_config</span> <span class="o">=</span> <span class="n">build_docker_services</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">compose_config</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_docker_services</span><span class="p">(</span><span class="n">components</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build Docker Compose services with dependency resolution.</span>

<span class="sd">    Args:</span>
<span class="sd">        components: List of component specs with name, type, dependencies</span>

<span class="sd">    Returns:</span>
<span class="sd">        Docker Compose services dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_ports</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;api&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span>
        <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
        <span class="s1">&#39;cache&#39;</span><span class="p">:</span> <span class="mi">6379</span><span class="p">,</span>
        <span class="s1">&#39;dashboard&#39;</span><span class="p">:</span> <span class="mi">8050</span><span class="p">,</span>
        <span class="s1">&#39;worker&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">}</span>

    <span class="n">default_images</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="s1">&#39;postgres:15&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cache&#39;</span><span class="p">:</span> <span class="s1">&#39;redis:7-alpine&#39;</span>
    <span class="p">}</span>

    <span class="n">services</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">component</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">svc_type</span> <span class="o">=</span> <span class="n">component</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dependencies&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">service</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;restart&#39;</span><span class="p">:</span> <span class="s1">&#39;unless-stopped&#39;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">svc_type</span> <span class="ow">in</span> <span class="n">default_images</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_images</span><span class="p">[</span><span class="n">svc_type</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">port</span> <span class="o">=</span> <span class="n">default_ports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">svc_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">port</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;ports&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">deps</span><span class="p">:</span>
            <span class="n">service</span><span class="p">[</span><span class="s1">&#39;depends_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deps</span>

        <span class="n">services</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">service</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;3.8&#39;</span><span class="p">,</span>
        <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="n">services</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 17.3: Serverless Functions</h2>
<p><strong>Serverless</strong> computing lets you run code without managing servers. You pay only for execution time.</p>
<h3>Use Cases for Trading</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Use Case</th>
<th>Function Type</th>
<th>Trigger</th>
</tr>
</thead>
<tbody>
<tr>
<td>Market data processing</td>
<td>Data pipeline</td>
<td>Schedule/Event</td>
</tr>
<tr>
<td>Alert notifications</td>
<td>Notification</td>
<td>Event</td>
</tr>
<tr>
<td>Report generation</td>
<td>Batch</td>
<td>Schedule</td>
</tr>
<tr>
<td>API webhooks</td>
<td>API handler</td>
<td>HTTP</td>
</tr>
<tr>
<td>Data backup</td>
<td>Maintenance</td>
<td>Schedule</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">LambdaFunctionGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate AWS Lambda function templates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">market_data_fetcher</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate market data fetcher Lambda.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">import json</span>
<span class="s1">import boto3</span>
<span class="s1">import yfinance as yf</span>
<span class="s1">from datetime import datetime</span>

<span class="s1">s3 = boto3.client(&#39;s3&#39;)</span>
<span class="s1">sns = boto3.client(&#39;sns&#39;)</span>

<span class="s1">def handler(event, context):</span>
<span class="s1">    &quot;&quot;&quot;</span>
<span class="s1">    Fetch market data and store in S3.</span>
<span class="s1">    Triggered by CloudWatch Events (schedule).</span>
<span class="s1">    &quot;&quot;&quot;</span>
<span class="s1">    # Configuration</span>
<span class="s1">    symbols = event.get(&#39;symbols&#39;, [&#39;SPY&#39;, &#39;QQQ&#39;, &#39;IWM&#39;])</span>
<span class="s1">    bucket = event.get(&#39;bucket&#39;, &#39;my-market-data-bucket&#39;)</span>
<span class="s1">    </span>
<span class="s1">    results = []</span>
<span class="s1">    </span>
<span class="s1">    for symbol in symbols:</span>
<span class="s1">        try:</span>
<span class="s1">            # Fetch data</span>
<span class="s1">            ticker = yf.Ticker(symbol)</span>
<span class="s1">            data = ticker.history(period=&#39;1d&#39;)</span>
<span class="s1">            </span>
<span class="s1">            if not data.empty:</span>
<span class="s1">                # Store in S3</span>
<span class="s1">                date_str = datetime.now().strftime(&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;)</span>
<span class="s1">                key = f&quot;daily/</span><span class="si">{symbol}</span><span class="s1">/</span><span class="si">{date_str}</span><span class="s1">.json&quot;</span>
<span class="s1">                </span>
<span class="s1">                s3.put_object(</span>
<span class="s1">                    Bucket=bucket,</span>
<span class="s1">                    Key=key,</span>
<span class="s1">                    Body=data.to_json(),</span>
<span class="s1">                    ContentType=&#39;application/json&#39;</span>
<span class="s1">                )</span>
<span class="s1">                </span>
<span class="s1">                results.append({</span>
<span class="s1">                    &#39;symbol&#39;: symbol,</span>
<span class="s1">                    &#39;status&#39;: &#39;success&#39;,</span>
<span class="s1">                    &#39;key&#39;: key</span>
<span class="s1">                })</span>
<span class="s1">            else:</span>
<span class="s1">                results.append({</span>
<span class="s1">                    &#39;symbol&#39;: symbol,</span>
<span class="s1">                    &#39;status&#39;: &#39;no_data&#39;</span>
<span class="s1">                })</span>
<span class="s1">                </span>
<span class="s1">        except Exception as e:</span>
<span class="s1">            results.append({</span>
<span class="s1">                &#39;symbol&#39;: symbol,</span>
<span class="s1">                &#39;status&#39;: &#39;error&#39;,</span>
<span class="s1">                &#39;error&#39;: str(e)</span>
<span class="s1">            })</span>
<span class="s1">    </span>
<span class="s1">    return {</span>
<span class="s1">        &#39;statusCode&#39;: 200,</span>
<span class="s1">        &#39;body&#39;: json.dumps({</span>
<span class="s1">            &#39;timestamp&#39;: datetime.now().isoformat(),</span>
<span class="s1">            &#39;results&#39;: results</span>
<span class="s1">        })</span>
<span class="s1">    }</span>
<span class="s1">&#39;&#39;&#39;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">price_alert_checker</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate price alert checker Lambda.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">import json</span>
<span class="s1">import boto3</span>
<span class="s1">import yfinance as yf</span>
<span class="s1">from datetime import datetime</span>

<span class="s1">dynamodb = boto3.resource(&#39;dynamodb&#39;)</span>
<span class="s1">sns = boto3.client(&#39;sns&#39;)</span>

<span class="s1">def handler(event, context):</span>
<span class="s1">    &quot;&quot;&quot;</span>
<span class="s1">    Check price alerts and send notifications.</span>
<span class="s1">    Triggered by CloudWatch Events (every 5 minutes during market hours).</span>
<span class="s1">    &quot;&quot;&quot;</span>
<span class="s1">    # Get active alerts from DynamoDB</span>
<span class="s1">    table = dynamodb.Table(&#39;price_alerts&#39;)</span>
<span class="s1">    alerts = table.scan(</span>
<span class="s1">        FilterExpression=&#39;active = :active&#39;,</span>
<span class="s1">        ExpressionAttributeValues={&#39;:active&#39;: True}</span>
<span class="s1">    )[&#39;Items&#39;]</span>
<span class="s1">    </span>
<span class="s1">    triggered_alerts = []</span>
<span class="s1">    </span>
<span class="s1">    for alert in alerts:</span>
<span class="s1">        symbol = alert[&#39;symbol&#39;]</span>
<span class="s1">        target_price = float(alert[&#39;target_price&#39;])</span>
<span class="s1">        condition = alert[&#39;condition&#39;]  # &#39;above&#39; or &#39;below&#39;</span>
<span class="s1">        topic_arn = alert[&#39;topic_arn&#39;]</span>
<span class="s1">        </span>
<span class="s1">        # Get current price</span>
<span class="s1">        ticker = yf.Ticker(symbol)</span>
<span class="s1">        current_price = ticker.fast_info[&#39;lastPrice&#39;]</span>
<span class="s1">        </span>
<span class="s1">        # Check condition</span>
<span class="s1">        triggered = False</span>
<span class="s1">        if condition == &#39;above&#39; and current_price &gt;= target_price:</span>
<span class="s1">            triggered = True</span>
<span class="s1">        elif condition == &#39;below&#39; and current_price &lt;= target_price:</span>
<span class="s1">            triggered = True</span>
<span class="s1">        </span>
<span class="s1">        if triggered:</span>
<span class="s1">            # Send notification</span>
<span class="s1">            message = f&quot;&quot;&quot;PRICE ALERT TRIGGERED</span>
<span class="s1">            </span>
<span class="s1">Symbol: </span><span class="si">{symbol}</span><span class="s1"></span>
<span class="s1">Condition: Price </span><span class="si">{condition}</span><span class="s1"> $</span><span class="si">{target_price}</span><span class="s1"></span>
<span class="s1">Current Price: $</span><span class="si">{current_price:.2f}</span><span class="s1"></span>
<span class="s1">Time: {datetime.now().isoformat()}</span>
<span class="s1">&quot;&quot;&quot;</span>
<span class="s1">            </span>
<span class="s1">            sns.publish(</span>
<span class="s1">                TopicArn=topic_arn,</span>
<span class="s1">                Message=message,</span>
<span class="s1">                Subject=f&#39;Price Alert: </span><span class="si">{symbol}</span><span class="s1">&#39;</span>
<span class="s1">            )</span>
<span class="s1">            </span>
<span class="s1">            # Deactivate alert</span>
<span class="s1">            table.update_item(</span>
<span class="s1">                Key={&#39;alert_id&#39;: alert[&#39;alert_id&#39;]},</span>
<span class="s1">                UpdateExpression=&#39;SET active = :false&#39;,</span>
<span class="s1">                ExpressionAttributeValues={&#39;:false&#39;: False}</span>
<span class="s1">            )</span>
<span class="s1">            </span>
<span class="s1">            triggered_alerts.append(alert[&#39;alert_id&#39;])</span>
<span class="s1">    </span>
<span class="s1">    return {</span>
<span class="s1">        &#39;statusCode&#39;: 200,</span>
<span class="s1">        &#39;body&#39;: json.dumps({</span>
<span class="s1">            &#39;checked&#39;: len(alerts),</span>
<span class="s1">            &#39;triggered&#39;: triggered_alerts</span>
<span class="s1">        })</span>
<span class="s1">    }</span>
<span class="s1">&#39;&#39;&#39;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">report_generator</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate report generator Lambda.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">import json</span>
<span class="s1">import boto3</span>
<span class="s1">import pandas as pd</span>
<span class="s1">from datetime import datetime, timedelta</span>
<span class="s1">from io import BytesIO</span>

<span class="s1">s3 = boto3.client(&#39;s3&#39;)</span>
<span class="s1">ses = boto3.client(&#39;ses&#39;)</span>

<span class="s1">def handler(event, context):</span>
<span class="s1">    &quot;&quot;&quot;</span>
<span class="s1">    Generate daily performance report.</span>
<span class="s1">    Triggered by CloudWatch Events (end of day).</span>
<span class="s1">    &quot;&quot;&quot;</span>
<span class="s1">    bucket = event.get(&#39;bucket&#39;, &#39;my-trading-bucket&#39;)</span>
<span class="s1">    recipient = event.get(&#39;email&#39;, &#39;trader@example.com&#39;)</span>
<span class="s1">    </span>
<span class="s1">    # Load trades from S3</span>
<span class="s1">    date_str = datetime.now().strftime(&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;)</span>
<span class="s1">    trades_key = f&quot;trades/</span><span class="si">{date_str}</span><span class="s1">.json&quot;</span>
<span class="s1">    </span>
<span class="s1">    try:</span>
<span class="s1">        response = s3.get_object(Bucket=bucket, Key=trades_key)</span>
<span class="s1">        trades_df = pd.read_json(response[&#39;Body&#39;])</span>
<span class="s1">    except:</span>
<span class="s1">        trades_df = pd.DataFrame()</span>
<span class="s1">    </span>
<span class="s1">    # Generate report</span>
<span class="s1">    if not trades_df.empty:</span>
<span class="s1">        total_pnl = trades_df[&#39;pnl&#39;].sum()</span>
<span class="s1">        num_trades = len(trades_df)</span>
<span class="s1">        win_rate = (trades_df[&#39;pnl&#39;] &gt; 0).mean()</span>
<span class="s1">        </span>
<span class="s1">        report = f&quot;&quot;&quot;</span>
<span class="s1">DAILY TRADING REPORT - </span><span class="si">{date_str}</span><span class="s1"></span>
<span class="s1">================================</span>

<span class="s1">Summary:</span>
<span class="s1">- Total Trades: </span><span class="si">{num_trades}</span><span class="s1"></span>
<span class="s1">- Total P&amp;L: $</span><span class="si">{total_pnl:,.2f}</span><span class="s1"></span>
<span class="s1">- Win Rate: </span><span class="si">{win_rate:.1%}</span><span class="s1"></span>

<span class="s1">Top Performers:</span>
<span class="s1">{trades_df.nlargest(3, &#39;pnl&#39;)[[&#39;symbol&#39;, &#39;pnl&#39;]].to_string()}</span>

<span class="s1">Worst Performers:</span>
<span class="s1">{trades_df.nsmallest(3, &#39;pnl&#39;)[[&#39;symbol&#39;, &#39;pnl&#39;]].to_string()}</span>
<span class="s1">&quot;&quot;&quot;</span>
<span class="s1">    else:</span>
<span class="s1">        report = f&quot;DAILY REPORT - </span><span class="si">{date_str}</span><span class="se">\\</span><span class="s1">n</span><span class="se">\\</span><span class="s1">nNo trades executed today.&quot;</span>
<span class="s1">    </span>
<span class="s1">    # Send email via SES</span>
<span class="s1">    ses.send_email(</span>
<span class="s1">        Source=&#39;reports@trading-system.com&#39;,</span>
<span class="s1">        Destination={&#39;ToAddresses&#39;: [recipient]},</span>
<span class="s1">        Message={</span>
<span class="s1">            &#39;Subject&#39;: {&#39;Data&#39;: f&#39;Daily Trading Report - </span><span class="si">{date_str}</span><span class="s1">&#39;},</span>
<span class="s1">            &#39;Body&#39;: {&#39;Text&#39;: {&#39;Data&#39;: report}}</span>
<span class="s1">        }</span>
<span class="s1">    )</span>
<span class="s1">    </span>
<span class="s1">    return {</span>
<span class="s1">        &#39;statusCode&#39;: 200,</span>
<span class="s1">        &#39;body&#39;: json.dumps({&#39;report_sent&#39;: True})</span>
<span class="s1">    }</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="c1"># Display Lambda function examples</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market Data Fetcher Lambda:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">LambdaFunctionGenerator</span><span class="o">.</span><span class="n">market_data_fetcher</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 17.3: Lambda Configuration Builder (Guided)</h3>
<p>Create a function that builds Lambda function configurations with memory and timeout settings.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 17.3: Lambda Configuration Builder (Guided)</span>

<span class="k">def</span> <span class="nf">build_lambda_config</span><span class="p">(</span><span class="n">functions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build Lambda function configurations with resource allocation.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        functions: List of function specs</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Lambda configuration dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Memory tiers (MB)</span>
    <span class="n">memory_tiers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;light&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
        <span class="s1">&#39;standard&#39;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span>
        <span class="s1">&#39;heavy&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s1">&#39;compute&#39;</span><span class="p">:</span> <span class="mi">2048</span>
    <span class="p">}</span>
    
    <span class="c1"># Timeout presets (seconds)</span>
    <span class="n">timeout_presets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;quick&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="s1">&#39;standard&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">900</span>
    <span class="p">}</span>
    
    <span class="n">configs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">total_memory</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="c1"># TODO: Get memory tier with default &#39;standard&#39;</span>
        <span class="n">mem_tier</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">_______</span><span class="p">,</span> <span class="s1">&#39;standard&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: Get timeout preset with default &#39;standard&#39;</span>
        <span class="n">timeout_type</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="n">______</span><span class="p">)</span>
        
        <span class="c1"># TODO: Look up memory from tiers dict</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="n">memory_tiers</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">mem_tier</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
        <span class="c1"># TODO: Look up timeout from presets dict</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout_presets</span><span class="p">[</span><span class="n">______</span><span class="p">]</span>
        
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;function_name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;runtime&#39;</span><span class="p">:</span> <span class="s1">&#39;python3.10&#39;</span><span class="p">,</span>
            <span class="s1">&#39;handler&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.handler&#39;</span><span class="p">,</span>
            <span class="s1">&#39;memory_size&#39;</span><span class="p">:</span> <span class="n">memory</span><span class="p">,</span>
            <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">timeout</span><span class="p">,</span>
            <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="p">}</span>
        
        <span class="c1"># Add trigger if specified</span>
        <span class="k">if</span> <span class="s1">&#39;schedule&#39;</span> <span class="ow">in</span> <span class="n">func</span><span class="p">:</span>
            <span class="c1"># TODO: Set trigger config</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;trigger&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;schedule&#39;</span><span class="p">,</span>
                <span class="s1">&#39;expression&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">[</span><span class="n">______</span><span class="p">]</span>
            <span class="p">}</span>
        
        <span class="n">configs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
        <span class="c1"># TODO: Add memory to running total</span>
        <span class="n">total_memory</span> <span class="n">______</span> <span class="n">memory</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;functions&#39;</span><span class="p">:</span> <span class="n">configs</span><span class="p">,</span>
        <span class="c1"># TODO: Count number of functions</span>
        <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">______</span><span class="p">(</span><span class="n">configs</span><span class="p">),</span>
        <span class="s1">&#39;total_memory_mb&#39;</span><span class="p">:</span> <span class="n">total_memory</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">functions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;market_data_fetcher&#39;</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">:</span> <span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="s1">&#39;standard&#39;</span><span class="p">,</span>
     <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;rate(5 minutes)&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;price_alert&#39;</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">:</span> <span class="s1">&#39;light&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="s1">&#39;quick&#39;</span><span class="p">,</span>
     <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;rate(1 minute)&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;report_generator&#39;</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">:</span> <span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span>
     <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;cron(0 21 ? * MON-FRI *)&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;backtest_runner&#39;</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">:</span> <span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="s1">&#39;max&#39;</span><span class="p">}</span>
<span class="p">]</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">build_lambda_config</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Functions: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Memory: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;total_memory_mb&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Configurations:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;functions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Memory: </span><span class="si">{</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;memory_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Timeout: </span><span class="si">{</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;trigger&#39;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Schedule: </span><span class="si">{</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;trigger&#39;</span><span class="p">][</span><span class="s1">&#39;expression&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">build_lambda_config</span><span class="p">(</span><span class="n">functions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build Lambda function configurations with resource allocation.</span>

<span class="sd">    Args:</span>
<span class="sd">        functions: List of function specs</span>

<span class="sd">    Returns:</span>
<span class="sd">        Lambda configuration dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">memory_tiers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;light&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
        <span class="s1">&#39;standard&#39;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span>
        <span class="s1">&#39;heavy&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="s1">&#39;compute&#39;</span><span class="p">:</span> <span class="mi">2048</span>
    <span class="p">}</span>

    <span class="n">timeout_presets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;quick&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="s1">&#39;standard&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">900</span>
    <span class="p">}</span>

    <span class="n">configs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">total_memory</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">mem_tier</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="s1">&#39;standard&#39;</span><span class="p">)</span>
        <span class="n">timeout_type</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;standard&#39;</span><span class="p">)</span>

        <span class="n">memory</span> <span class="o">=</span> <span class="n">memory_tiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mem_tier</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout_presets</span><span class="p">[</span><span class="n">timeout_type</span><span class="p">]</span>

        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;function_name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;runtime&#39;</span><span class="p">:</span> <span class="s1">&#39;python3.10&#39;</span><span class="p">,</span>
            <span class="s1">&#39;handler&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.handler&#39;</span><span class="p">,</span>
            <span class="s1">&#39;memory_size&#39;</span><span class="p">:</span> <span class="n">memory</span><span class="p">,</span>
            <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">timeout</span><span class="p">,</span>
            <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s1">&#39;schedule&#39;</span> <span class="ow">in</span> <span class="n">func</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;trigger&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;schedule&#39;</span><span class="p">,</span>
                <span class="s1">&#39;expression&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">[</span><span class="s1">&#39;schedule&#39;</span><span class="p">]</span>
            <span class="p">}</span>

        <span class="n">configs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
        <span class="n">total_memory</span> <span class="o">+=</span> <span class="n">memory</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;functions&#39;</span><span class="p">:</span> <span class="n">configs</span><span class="p">,</span>
        <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">configs</span><span class="p">),</span>
        <span class="s1">&#39;total_memory_mb&#39;</span><span class="p">:</span> <span class="n">total_memory</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Generate CloudFormation template for Lambda deployment</span>
<span class="k">class</span> <span class="nc">CloudFormationGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate CloudFormation templates for serverless deployment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">lambda_stack</span><span class="p">(</span><span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">runtime</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;python3.10&#39;</span><span class="p">,</span>
                     <span class="n">memory</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate CloudFormation template for Lambda function.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;AWSTemplateFormatVersion&#39;</span><span class="p">:</span> <span class="s1">&#39;2010-09-09&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Description&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Lambda function: </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Parameters&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Environment&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;String&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Default&#39;</span><span class="p">:</span> <span class="s1">&#39;dev&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;AllowedValues&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dev&#39;</span><span class="p">,</span> <span class="s1">&#39;staging&#39;</span><span class="p">,</span> <span class="s1">&#39;prod&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;Resources&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;LambdaExecutionRole&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;AWS::IAM::Role&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Properties&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;AssumeRolePolicyDocument&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;Version&#39;</span><span class="p">:</span> <span class="s1">&#39;2012-10-17&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Statement&#39;</span><span class="p">:</span> <span class="p">[{</span>
                                <span class="s1">&#39;Effect&#39;</span><span class="p">:</span> <span class="s1">&#39;Allow&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Principal&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Service&#39;</span><span class="p">:</span> <span class="s1">&#39;lambda.amazonaws.com&#39;</span><span class="p">},</span>
                                <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="s1">&#39;sts:AssumeRole&#39;</span>
                            <span class="p">}]</span>
                        <span class="p">},</span>
                        <span class="s1">&#39;ManagedPolicyArns&#39;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="s1">&#39;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&#39;</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s1">&#39;LambdaFunction&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;AWS::Lambda::Function&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Properties&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;FunctionName&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Fn::Sub&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s1">-$</span><span class="se">{{</span><span class="s1">Environment</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">},</span>
                        <span class="s1">&#39;Runtime&#39;</span><span class="p">:</span> <span class="n">runtime</span><span class="p">,</span>
                        <span class="s1">&#39;Handler&#39;</span><span class="p">:</span> <span class="s1">&#39;handler.handler&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;MemorySize&#39;</span><span class="p">:</span> <span class="n">memory</span><span class="p">,</span>
                        <span class="s1">&#39;Timeout&#39;</span><span class="p">:</span> <span class="n">timeout</span><span class="p">,</span>
                        <span class="s1">&#39;Role&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Fn::GetAtt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;LambdaExecutionRole&#39;</span><span class="p">,</span> <span class="s1">&#39;Arn&#39;</span><span class="p">]},</span>
                        <span class="s1">&#39;Environment&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;Variables&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;ENVIRONMENT&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Ref&#39;</span><span class="p">:</span> <span class="s1">&#39;Environment&#39;</span><span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s1">&#39;ScheduleRule&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;AWS::Events::Rule&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Properties&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;ScheduleExpression&#39;</span><span class="p">:</span> <span class="s1">&#39;rate(5 minutes)&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;State&#39;</span><span class="p">:</span> <span class="s1">&#39;ENABLED&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Targets&#39;</span><span class="p">:</span> <span class="p">[{</span>
                            <span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="s1">&#39;LambdaTarget&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Arn&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Fn::GetAtt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;LambdaFunction&#39;</span><span class="p">,</span> <span class="s1">&#39;Arn&#39;</span><span class="p">]}</span>
                        <span class="p">}]</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;Outputs&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;FunctionArn&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Fn::GetAtt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;LambdaFunction&#39;</span><span class="p">,</span> <span class="s1">&#39;Arn&#39;</span><span class="p">]}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

<span class="n">cf_template</span> <span class="o">=</span> <span class="n">CloudFormationGenerator</span><span class="o">.</span><span class="n">lambda_stack</span><span class="p">(</span>
    <span class="s1">&#39;market-data-fetcher&#39;</span><span class="p">,</span>
    <span class="n">memory</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CloudFormation Template:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cf_template</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 17.4: CI/CD Pipelines</h2>
<p><strong>CI/CD</strong> (Continuous Integration/Continuous Deployment) automates testing and deployment.</p>
<h3>Pipeline Stages</h3>
<ol>
<li><strong>Build</strong>: Compile code, install dependencies</li>
<li><strong>Test</strong>: Run unit tests, integration tests</li>
<li><strong>Analyze</strong>: Code quality, security scanning</li>
<li><strong>Deploy</strong>: Push to staging/production</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">CICDPipelineGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate CI/CD pipeline configurations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">github_actions_workflow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate GitHub Actions workflow for trading application.&quot;&quot;&quot;</span>
        <span class="n">workflow</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Trading System CI/CD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;on&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;push&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;branches&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="s1">&#39;develop&#39;</span><span class="p">]},</span>
                <span class="s1">&#39;pull_request&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;branches&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]}</span>
            <span class="p">},</span>
            <span class="s1">&#39;env&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;PYTHON_VERSION&#39;</span><span class="p">:</span> <span class="s1">&#39;3.10&#39;</span><span class="p">,</span>
                <span class="s1">&#39;AWS_REGION&#39;</span><span class="p">:</span> <span class="s1">&#39;us-east-1&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;jobs&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;runs-on&#39;</span><span class="p">:</span> <span class="s1">&#39;ubuntu-latest&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s1">&#39;uses&#39;</span><span class="p">:</span> <span class="s1">&#39;actions/checkout@v4&#39;</span><span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Set up Python&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;uses&#39;</span><span class="p">:</span> <span class="s1">&#39;actions/setup-python@v4&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;with&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;python-version&#39;</span><span class="p">:</span> <span class="s1">&#39;${{ env.PYTHON_VERSION }}&#39;</span><span class="p">}</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Install dependencies&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="s1">&#39;pip install -r requirements.txt -r requirements-dev.txt&#39;</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Run linting&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="s1">&#39;flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics&#39;</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Run tests&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="s1">&#39;pytest tests/ -v --cov=src --cov-report=xml&#39;</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Upload coverage&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;uses&#39;</span><span class="p">:</span> <span class="s1">&#39;codecov/codecov-action@v3&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;with&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="s1">&#39;coverage.xml&#39;</span><span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="s1">&#39;build&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;needs&#39;</span><span class="p">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;runs-on&#39;</span><span class="p">:</span> <span class="s1">&#39;ubuntu-latest&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;if&#39;</span><span class="p">:</span> <span class="s2">&quot;github.ref == &#39;refs/heads/main&#39;&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s1">&#39;uses&#39;</span><span class="p">:</span> <span class="s1">&#39;actions/checkout@v4&#39;</span><span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Configure AWS credentials&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;uses&#39;</span><span class="p">:</span> <span class="s1">&#39;aws-actions/configure-aws-credentials@v4&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;with&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;aws-access-key-id&#39;</span><span class="p">:</span> <span class="s1">&#39;${{ secrets.AWS_ACCESS_KEY_ID }}&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;aws-secret-access-key&#39;</span><span class="p">:</span> <span class="s1">&#39;${{ secrets.AWS_SECRET_ACCESS_KEY }}&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;aws-region&#39;</span><span class="p">:</span> <span class="s1">&#39;${{ env.AWS_REGION }}&#39;</span>
                            <span class="p">}</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Login to ECR&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;uses&#39;</span><span class="p">:</span> <span class="s1">&#39;aws-actions/amazon-ecr-login@v2&#39;</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Build and push Docker image&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;&#39;|</span>
<span class="s1">                                docker build -t trading-system .</span>
<span class="s1">                                docker tag trading-system:latest ${{ secrets.ECR_REGISTRY }}/trading-system:${{ github.sha }}</span>
<span class="s1">                                docker push ${{ secrets.ECR_REGISTRY }}/trading-system:${{ github.sha }}</span>
<span class="s1">                            &#39;&#39;&#39;</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="s1">&#39;deploy-staging&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;needs&#39;</span><span class="p">:</span> <span class="s1">&#39;build&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;runs-on&#39;</span><span class="p">:</span> <span class="s1">&#39;ubuntu-latest&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="s1">&#39;staging&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s1">&#39;uses&#39;</span><span class="p">:</span> <span class="s1">&#39;actions/checkout@v4&#39;</span><span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Deploy to ECS Staging&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="s1">&#39;aws ecs update-service --cluster staging --service trading-system --force-new-deployment&#39;</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="s1">&#39;deploy-production&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;needs&#39;</span><span class="p">:</span> <span class="s1">&#39;deploy-staging&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;runs-on&#39;</span><span class="p">:</span> <span class="s1">&#39;ubuntu-latest&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="s1">&#39;production&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s1">&#39;uses&#39;</span><span class="p">:</span> <span class="s1">&#39;actions/checkout@v4&#39;</span><span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Deploy to ECS Production&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="s1">&#39;aws ecs update-service --cluster production --service trading-system --force-new-deployment&#39;</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">pre_commit_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate pre-commit configuration.&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;repos&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;repo&#39;</span><span class="p">:</span> <span class="s1">&#39;https://github.com/pre-commit/pre-commit-hooks&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;rev&#39;</span><span class="p">:</span> <span class="s1">&#39;v4.4.0&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hooks&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;trailing-whitespace&#39;</span><span class="p">},</span>
                        <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;end-of-file-fixer&#39;</span><span class="p">},</span>
                        <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;check-yaml&#39;</span><span class="p">},</span>
                        <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;check-json&#39;</span><span class="p">},</span>
                        <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;check-merge-conflict&#39;</span><span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;repo&#39;</span><span class="p">:</span> <span class="s1">&#39;https://github.com/psf/black&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;rev&#39;</span><span class="p">:</span> <span class="s1">&#39;23.9.1&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hooks&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;language_version&#39;</span><span class="p">:</span> <span class="s1">&#39;python3.10&#39;</span><span class="p">}]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;repo&#39;</span><span class="p">:</span> <span class="s1">&#39;https://github.com/PyCQA/flake8&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;rev&#39;</span><span class="p">:</span> <span class="s1">&#39;6.1.0&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hooks&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;flake8&#39;</span><span class="p">}]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;repo&#39;</span><span class="p">:</span> <span class="s1">&#39;https://github.com/PyCQA/isort&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;rev&#39;</span><span class="p">:</span> <span class="s1">&#39;5.12.0&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hooks&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;isort&#39;</span><span class="p">}]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;repo&#39;</span><span class="p">:</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;hooks&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;pytest&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;pytest&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="s1">&#39;pytest tests/ -x&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;language&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;pass_filenames&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;always_run&#39;</span><span class="p">:</span> <span class="kc">True</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GitHub Actions Workflow:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">CICDPipelineGenerator</span><span class="o">.</span><span class="n">github_actions_workflow</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pre-commit Configuration:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">CICDPipelineGenerator</span><span class="o">.</span><span class="n">pre_commit_config</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 17.4: Complete Infrastructure Generator (Open-ended)</h3>
<p>Build a class that generates complete infrastructure configurations for a trading platform, including cloud architecture, Docker setup, and CI/CD pipeline.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 17.4: Complete Infrastructure Generator (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class that:</span>
<span class="c1"># - Takes a project configuration (services, environments, provider)</span>
<span class="c1"># - Generates cloud architecture with cost estimates</span>
<span class="c1"># - Creates Docker Compose for local development</span>
<span class="c1"># - Outputs CI/CD pipeline configuration</span>
<span class="c1"># - Produces environment variable templates</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">InfrastructureGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate complete infrastructure configurations for trading platforms.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;aws&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environments</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dev&#39;</span><span class="p">,</span> <span class="s1">&#39;staging&#39;</span><span class="p">,</span> <span class="s1">&#39;prod&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">service_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;medium&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a service to the infrastructure.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">service_type</span><span class="p">,</span>
            <span class="s1">&#39;tier&#39;</span><span class="p">:</span> <span class="n">tier</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">generate_architecture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate cloud architecture configuration.&quot;&quot;&quot;</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;compute&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span>
            <span class="s1">&#39;serverless&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span>
            <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span>
            <span class="s1">&#39;storage&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
            <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="n">architecture</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;provider&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
            <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span>
            <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">svc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">svc</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">svc</span><span class="p">[</span><span class="s1">&#39;tier&#39;</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>
            <span class="n">architecture</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="o">**</span><span class="n">svc</span><span class="p">,</span>
                <span class="s1">&#39;estimated_cost&#39;</span><span class="p">:</span> <span class="n">cost</span>
            <span class="p">})</span>
            <span class="n">architecture</span><span class="p">[</span><span class="s1">&#39;total_cost&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cost</span>

        <span class="k">return</span> <span class="n">architecture</span>

    <span class="k">def</span> <span class="nf">generate_docker_compose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate Docker Compose configuration.&quot;&quot;&quot;</span>
        <span class="n">compose</span> <span class="o">=</span> <span class="n">DockerComposeGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">svc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">svc</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;database&#39;</span><span class="p">:</span>
                <span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">svc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">image</span><span class="o">=</span><span class="s1">&#39;postgres:15&#39;</span><span class="p">,</span>
                    <span class="n">ports</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;5432:5432&#39;</span><span class="p">],</span>
                    <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;POSTGRES_PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;$</span><span class="si">{DB_PASSWORD}</span><span class="s1">&#39;</span><span class="p">}</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">svc</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;storage&#39;</span><span class="p">:</span>
                <span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">svc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">image</span><span class="o">=</span><span class="s1">&#39;redis:7-alpine&#39;</span><span class="p">,</span>
                    <span class="n">ports</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;6379:6379&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">svc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">build</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">svc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">compose</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generate_cicd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate CI/CD pipeline configuration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CICDPipelineGenerator</span><span class="o">.</span><span class="n">github_actions_workflow</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generate_env_template</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate environment variable template.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;# Environment Configuration&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">svc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# </span><span class="si">{</span><span class="n">svc</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">svc</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;database&#39;</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;DATABASE_URL=postgresql://user:password@localhost:5432/db&#39;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;DB_PASSWORD=changeme&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">svc</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;storage&#39;</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;REDIS_URL=redis://localhost:6379&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="s1">&#39;# API Keys&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MARKET_DATA_API_KEY=your_key&#39;</span><span class="p">,</span>
            <span class="s1">&#39;BROKER_API_KEY=your_key&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;# Application&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ENVIRONMENT=development&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SECRET_KEY=changeme&#39;</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate all infrastructure files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;architecture.json&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_architecture</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;docker-compose.yml&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_docker_compose</span><span class="p">(),</span>
            <span class="s1">&#39;.github/workflows/ci-cd.yml&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cicd</span><span class="p">(),</span>
            <span class="s1">&#39;.env.example&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_env_template</span><span class="p">()</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">infra</span> <span class="o">=</span> <span class="n">InfrastructureGenerator</span><span class="p">(</span><span class="s1">&#39;QuantTradingPlatform&#39;</span><span class="p">,</span> <span class="s1">&#39;aws&#39;</span><span class="p">)</span>
<span class="n">infra</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span>
<span class="n">infra</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;strategy-engine&#39;</span><span class="p">,</span> <span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">)</span>
<span class="n">infra</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span>
<span class="n">infra</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="s1">&#39;storage&#39;</span><span class="p">,</span> <span class="s1">&#39;small&#39;</span><span class="p">)</span>
<span class="n">infra</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;data-fetcher&#39;</span><span class="p">,</span> <span class="s1">&#39;serverless&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span>

<span class="n">files</span> <span class="o">=</span> <span class="n">infra</span><span class="o">.</span><span class="n">generate_all</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">arch</span> <span class="o">=</span> <span class="n">infra</span><span class="o">.</span><span class="n">generate_architecture</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total Monthly Cost: $</span><span class="si">{</span><span class="n">arch</span><span class="p">[</span><span class="s1">&#39;total_cost&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 17.5: Multi-Environment Deployer (Open-ended)</h3>
<p>Create a deployment manager that handles multiple environments with proper configuration isolation.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 17.5: Multi-Environment Deployer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class that:</span>
<span class="c1"># - Manages configurations for dev, staging, and prod environments</span>
<span class="c1"># - Generates environment-specific Terraform configurations</span>
<span class="c1"># - Validates configuration consistency across environments</span>
<span class="c1"># - Supports service tier scaling between environments</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiEnvironmentDeployer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manage deployments across multiple environments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Tier scaling by environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tier_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;dev&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">},</span>
            <span class="s1">&#39;staging&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">},</span>
            <span class="s1">&#39;prod&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="s1">&#39;large&#39;</span><span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">add_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an environment.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environments</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="n">region</span><span class="p">,</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">add_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">service_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_tier</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;medium&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a service (applies to all environments with tier scaling).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">service_type</span><span class="p">,</span>
            <span class="s1">&#39;base_tier&#39;</span><span class="p">:</span> <span class="n">base_tier</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_environment_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get configuration for specific environment.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">env_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environments</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown environment: </span><span class="si">{</span><span class="n">env_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environments</span><span class="p">[</span><span class="n">env_name</span><span class="p">]</span>
        <span class="n">tier_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tier_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">env_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tier_mapping</span><span class="p">[</span><span class="s1">&#39;dev&#39;</span><span class="p">])</span>

        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="n">env_name</span><span class="p">,</span>
            <span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">],</span>
            <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">svc_name</span><span class="p">,</span> <span class="n">svc_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">scaled_tier</span> <span class="o">=</span> <span class="n">tier_map</span><span class="p">[</span><span class="n">svc_config</span><span class="p">[</span><span class="s1">&#39;base_tier&#39;</span><span class="p">]]</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="n">svc_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">svc_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;tier&#39;</span><span class="p">:</span> <span class="n">scaled_tier</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">generate_terraform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate Terraform for specific environment.&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environment_config</span><span class="p">(</span><span class="n">env_name</span><span class="p">)</span>

        <span class="n">tf_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s1">&#39;# Terraform configuration for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;# Environment: </span><span class="si">{</span><span class="n">env_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;provider &quot;aws&quot; {&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;  region = &quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;locals {&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;  environment = &quot;</span><span class="si">{</span><span class="n">env_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;  project     = &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;}&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&#39;</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">svc_name</span><span class="p">,</span> <span class="n">svc_config</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tf_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# </span><span class="si">{</span><span class="n">svc_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">tf_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# Type: </span><span class="si">{</span><span class="n">svc_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, Tier: </span><span class="si">{</span><span class="n">svc_config</span><span class="p">[</span><span class="s2">&quot;tier&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">tf_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tf_lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate configuration consistency.&quot;&quot;&quot;</span>
        <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check all environments have required services</span>
        <span class="k">for</span> <span class="n">env_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environments</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environment_config</span><span class="p">(</span><span class="n">env_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">):</span>
                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env_name</span><span class="si">}</span><span class="s2">: service count mismatch&quot;</span><span class="p">)</span>

        <span class="c1"># Check tier scaling makes sense</span>
        <span class="k">for</span> <span class="n">svc_name</span><span class="p">,</span> <span class="n">svc_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dev_tier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tier_mapping</span><span class="p">[</span><span class="s1">&#39;dev&#39;</span><span class="p">][</span><span class="n">svc_config</span><span class="p">[</span><span class="s1">&#39;base_tier&#39;</span><span class="p">]]</span>
            <span class="n">prod_tier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tier_mapping</span><span class="p">[</span><span class="s1">&#39;prod&#39;</span><span class="p">][</span><span class="n">svc_config</span><span class="p">[</span><span class="s1">&#39;base_tier&#39;</span><span class="p">]]</span>

            <span class="n">tier_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tier_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dev_tier</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tier_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">prod_tier</span><span class="p">):</span>
                <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">svc_name</span><span class="si">}</span><span class="s2">: dev tier &gt; prod tier&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">issues</span><span class="p">,</span>
            <span class="s1">&#39;environments_checked&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environments</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="s1">&#39;services_checked&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">estimate_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Estimate costs per environment.&quot;&quot;&quot;</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;compute&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span>
            <span class="s1">&#39;serverless&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">},</span>
            <span class="s1">&#39;database&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">},</span>
            <span class="s1">&#39;storage&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="n">estimates</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">env_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environments</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environment_config</span><span class="p">(</span><span class="n">env_name</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">svc_config</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">svc_costs</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">svc_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">costs</span><span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">])</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">svc_costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">svc_config</span><span class="p">[</span><span class="s1">&#39;tier&#39;</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>

            <span class="n">estimates</span><span class="p">[</span><span class="n">env_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span>

        <span class="n">estimates</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">estimates</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">estimates</span>

<span class="c1"># Test</span>
<span class="n">deployer</span> <span class="o">=</span> <span class="n">MultiEnvironmentDeployer</span><span class="p">(</span><span class="s1">&#39;TradingPlatform&#39;</span><span class="p">)</span>

<span class="c1"># Add environments</span>
<span class="n">deployer</span><span class="o">.</span><span class="n">add_environment</span><span class="p">(</span><span class="s1">&#39;dev&#39;</span><span class="p">,</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="n">deployer</span><span class="o">.</span><span class="n">add_environment</span><span class="p">(</span><span class="s1">&#39;staging&#39;</span><span class="p">,</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
<span class="n">deployer</span><span class="o">.</span><span class="n">add_environment</span><span class="p">(</span><span class="s1">&#39;prod&#39;</span><span class="p">,</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>

<span class="c1"># Add services</span>
<span class="n">deployer</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span>
<span class="n">deployer</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">)</span>
<span class="n">deployer</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span>

<span class="c1"># Validate</span>
<span class="n">validation</span> <span class="o">=</span> <span class="n">deployer</span><span class="o">.</span><span class="n">validate_consistency</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration Valid: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Estimate costs</span>
<span class="n">costs</span> <span class="o">=</span> <span class="n">deployer</span><span class="o">.</span><span class="n">estimate_costs</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Monthly Cost Estimates:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">env</span><span class="p">,</span> <span class="n">cost</span> <span class="ow">in</span> <span class="n">costs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">env</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">cost</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 17.6: Deployment Health Checker (Open-ended)</h3>
<p>Create a system that monitors deployment health and generates status reports.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 17.6: Deployment Health Checker (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class that:</span>
<span class="c1"># - Simulates health checks for deployed services</span>
<span class="c1"># - Tracks response times and availability</span>
<span class="c1"># - Generates health status reports</span>
<span class="c1"># - Identifies unhealthy services and suggests remediation</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">class</span> <span class="nc">DeploymentHealthChecker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monitor deployment health and generate reports.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">critical</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a service for health monitoring.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;endpoint&#39;</span><span class="p">:</span> <span class="n">endpoint</span><span class="p">,</span>
            <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="n">critical</span><span class="p">,</span>
            <span class="s1">&#39;checks&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">simulate_health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simulate a health check (normally would make HTTP request).&quot;&quot;&quot;</span>
        <span class="c1"># Simulate realistic response times and occasional failures</span>
        <span class="n">is_healthy</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.05</span>  <span class="c1"># 95% success rate</span>
        <span class="n">response_time</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_healthy</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="n">service_name</span><span class="p">,</span>
            <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="n">is_healthy</span><span class="p">,</span>
            <span class="s1">&#39;response_time_ms&#39;</span><span class="p">:</span> <span class="n">response_time</span><span class="p">,</span>
            <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">200</span> <span class="k">if</span> <span class="n">is_healthy</span> <span class="k">else</span> <span class="mi">500</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">service_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">[</span><span class="n">service_name</span><span class="p">][</span><span class="s1">&#39;checks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">run_all_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run health checks on all services.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">critical_failures</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_health_check</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;critical&#39;</span><span class="p">]:</span>
                <span class="n">critical_failures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">healthy_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">])</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;total_services&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
            <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="n">healthy_count</span><span class="p">,</span>
            <span class="s1">&#39;unhealthy&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">-</span> <span class="n">healthy_count</span><span class="p">,</span>
            <span class="s1">&#39;availability&#39;</span><span class="p">:</span> <span class="n">healthy_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">results</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;critical_failures&#39;</span><span class="p">:</span> <span class="n">critical_failures</span><span class="p">,</span>
            <span class="s1">&#39;overall_status&#39;</span><span class="p">:</span> <span class="s1">&#39;CRITICAL&#39;</span> <span class="k">if</span> <span class="n">critical_failures</span> <span class="k">else</span> <span class="p">(</span>
                <span class="s1">&#39;HEALTHY&#39;</span> <span class="k">if</span> <span class="n">healthy_count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;DEGRADED&#39;</span>
            <span class="p">),</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">results</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">health_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">summary</span>

    <span class="k">def</span> <span class="nf">get_service_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get statistics for a specific service.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">service_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Service not found&#39;</span><span class="p">}</span>

        <span class="n">checks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">[</span><span class="n">service_name</span><span class="p">][</span><span class="s1">&#39;checks&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">checks</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No health checks recorded&#39;</span><span class="p">}</span>

        <span class="n">healthy_checks</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">checks</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]]</span>
        <span class="n">response_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;response_time_ms&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">healthy_checks</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;response_time_ms&#39;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;service&#39;</span><span class="p">:</span> <span class="n">service_name</span><span class="p">,</span>
            <span class="s1">&#39;total_checks&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">checks</span><span class="p">),</span>
            <span class="s1">&#39;successful&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">healthy_checks</span><span class="p">),</span>
            <span class="s1">&#39;availability&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">healthy_checks</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">checks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;avg_response_time&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">response_times</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_times</span><span class="p">)</span> <span class="k">if</span> <span class="n">response_times</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;min_response_time&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">response_times</span><span class="p">)</span> <span class="k">if</span> <span class="n">response_times</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;max_response_time&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">response_times</span><span class="p">)</span> <span class="k">if</span> <span class="n">response_times</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate health status report.&quot;&quot;&quot;</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_all_checks</span><span class="p">()</span>

        <span class="n">report_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;DEPLOYMENT HEALTH REPORT - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Overall Status: </span><span class="si">{</span><span class="n">latest</span><span class="p">[</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Availability: </span><span class="si">{</span><span class="n">latest</span><span class="p">[</span><span class="s1">&#39;availability&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Services: </span><span class="si">{</span><span class="n">latest</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">latest</span><span class="p">[</span><span class="s1">&#39;total_services&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> healthy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;critical_failures&#39;</span><span class="p">]:</span>
            <span class="n">report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;CRITICAL FAILURES:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">svc</span> <span class="ow">in</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;critical_failures&#39;</span><span class="p">]:</span>
                <span class="n">report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">svc</span><span class="si">}</span><span class="s2"> [IMMEDIATE ACTION REQUIRED]&quot;</span><span class="p">)</span>
            <span class="n">report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Service Details:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span> <span class="k">if</span> <span class="n">detail</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;FAIL&quot;</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">detail</span><span class="p">[</span><span class="s1">&#39;response_time_ms&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">ms&quot;</span> <span class="k">if</span> <span class="n">detail</span><span class="p">[</span><span class="s1">&#39;response_time_ms&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
            <span class="n">report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">detail</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">rt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add recommendations</span>
        <span class="n">report_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Recommendations:&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">detail</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]:</span>
                <span class="n">report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Investigate </span><span class="si">{</span><span class="n">detail</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: check logs, restart if needed&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">detail</span><span class="p">[</span><span class="s1">&#39;response_time_ms&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">detail</span><span class="p">[</span><span class="s1">&#39;response_time_ms&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">:</span>
                <span class="n">report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">detail</span><span class="p">[</span><span class="s1">&#39;service&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: high latency, consider scaling&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report_lines</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">checker</span> <span class="o">=</span> <span class="n">DeploymentHealthChecker</span><span class="p">(</span><span class="s1">&#39;TradingPlatform&#39;</span><span class="p">)</span>
<span class="n">checker</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;http://api:8000/health&#39;</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">checker</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;strategy-engine&#39;</span><span class="p">,</span> <span class="s1">&#39;http://strategy:8001/health&#39;</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">checker</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;http://postgres:5432&#39;</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">checker</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="s1">&#39;http://redis:6379/ping&#39;</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">checker</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">,</span> <span class="s1">&#39;http://dashboard:8050/health&#39;</span><span class="p">,</span> <span class="n">critical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Run multiple checks</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">checker</span><span class="o">.</span><span class="n">run_all_checks</span><span class="p">()</span>

<span class="c1"># Generate report</span>
<span class="nb">print</span><span class="p">(</span><span class="n">checker</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Cloud Deployment Template</h2>
<p>Build a complete deployment template generator for a trading system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">generate_trading_requirements</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate requirements.txt for a trading application.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># Core data handling</span>
        <span class="s1">&#39;pandas&gt;=2.0.0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;numpy&gt;=1.24.0&#39;</span><span class="p">,</span>
        
        <span class="c1"># Market data</span>
        <span class="s1">&#39;yfinance&gt;=0.2.0&#39;</span><span class="p">,</span>
        
        <span class="c1"># Web framework</span>
        <span class="s1">&#39;fastapi&gt;=0.100.0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;uvicorn&gt;=0.23.0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gunicorn&gt;=21.0.0&#39;</span><span class="p">,</span>
        
        <span class="c1"># Database</span>
        <span class="s1">&#39;sqlalchemy&gt;=2.0.0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;psycopg2-binary&gt;=2.9.0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;alembic&gt;=1.12.0&#39;</span><span class="p">,</span>
        
        <span class="c1"># Visualization</span>
        <span class="s1">&#39;plotly&gt;=5.15.0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dash&gt;=2.14.0&#39;</span><span class="p">,</span>
        
        <span class="c1"># Utilities</span>
        <span class="s1">&#39;python-dotenv&gt;=1.0.0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pydantic&gt;=2.0.0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;redis&gt;=4.6.0&#39;</span><span class="p">,</span>
        
        <span class="c1"># Scheduling</span>
        <span class="s1">&#39;schedule&gt;=1.2.0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;celery&gt;=5.3.0&#39;</span><span class="p">,</span>
        
        <span class="c1"># Scientific computing</span>
        <span class="s1">&#39;scipy&gt;=1.11.0&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">packages</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CloudDeploymentTemplate</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete cloud deployment template generator.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Multi-environment support</span>
<span class="sd">    - Container configuration</span>
<span class="sd">    - Infrastructure as code</span>
<span class="sd">    - CI/CD pipeline</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">provider</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;aws&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span> <span class="o">=</span> <span class="n">CloudArchitecture</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_standard_services</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add standard services for a trading system.&quot;&quot;&quot;</span>
        <span class="c1"># Core services</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;api-server&quot;</span><span class="p">,</span> <span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;strategy-engine&quot;</span><span class="p">,</span> <span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;data-processor&quot;</span><span class="p">,</span> <span class="s2">&quot;serverless&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;cache&quot;</span><span class="p">,</span> <span class="s2">&quot;storage&quot;</span><span class="p">,</span> <span class="s2">&quot;small&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s2">&quot;message-queue&quot;</span><span class="p">,</span> <span class="s2">&quot;queue&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">)</span>
        
        <span class="c1"># Connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;data-processor&quot;</span><span class="p">,</span> <span class="s2">&quot;message-queue&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;message-queue&quot;</span><span class="p">,</span> <span class="s2">&quot;strategy-engine&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;strategy-engine&quot;</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;api-server&quot;</span><span class="p">,</span> <span class="s2">&quot;database&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;api-server&quot;</span><span class="p">,</span> <span class="s2">&quot;cache&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">generate_all_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate all deployment files.&quot;&quot;&quot;</span>
        <span class="c1"># Dockerfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;Dockerfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DockerfileGenerator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
            <span class="s1">&#39;python-api&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">entrypoint</span><span class="o">=</span><span class="s1">&#39;main&#39;</span>
        <span class="p">)</span>
        
        <span class="c1"># Docker Compose</span>
        <span class="n">compose</span> <span class="o">=</span> <span class="n">DockerComposeGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">)</span>
        <span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">ports</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;8000:8000&#39;</span><span class="p">],</span>
                           <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">:</span> <span class="s1">&#39;$</span><span class="si">{DATABASE_URL}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s1">&#39;postgres:15&#39;</span><span class="p">,</span>
                           <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;POSTGRES_PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;$</span><span class="si">{DB_PASSWORD}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="n">compose</span><span class="o">.</span><span class="n">add_service</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s1">&#39;redis:7-alpine&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;docker-compose.yml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compose</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
        
        <span class="c1"># Requirements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;requirements.txt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_trading_requirements</span><span class="p">()</span>
        
        <span class="c1"># GitHub Actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;.github/workflows/ci-cd.yml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CICDPipelineGenerator</span><span class="o">.</span><span class="n">github_actions_workflow</span><span class="p">()</span>
        
        <span class="c1"># Pre-commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;.pre-commit-config.yaml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CICDPipelineGenerator</span><span class="o">.</span><span class="n">pre_commit_config</span><span class="p">()</span>
        
        <span class="c1"># Terraform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;terraform/main.tf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">generate_terraform</span><span class="p">()</span>
        
        <span class="c1"># Environment template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;.env.example&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_env_template</span><span class="p">()</span>
        
        <span class="c1"># Makefile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;Makefile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_makefile</span><span class="p">()</span>
        
        <span class="c1"># README</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;README.md&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_readme</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span>
    
    <span class="k">def</span> <span class="nf">_generate_env_template</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate environment variable template.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;&#39;# Database</span>
<span class="s1">DATABASE_URL=postgresql://user:password@localhost:5432/trading</span>
<span class="s1">DB_PASSWORD=your_secure_password</span>

<span class="s1"># Redis</span>
<span class="s1">REDIS_URL=redis://localhost:6379</span>

<span class="s1"># API Keys</span>
<span class="s1">MARKET_DATA_API_KEY=your_api_key</span>
<span class="s1">BROKER_API_KEY=your_broker_key</span>
<span class="s1">BROKER_SECRET=your_broker_secret</span>

<span class="s1"># AWS (for deployment)</span>
<span class="s1">AWS_ACCESS_KEY_ID=your_access_key</span>
<span class="s1">AWS_SECRET_ACCESS_KEY=your_secret_key</span>
<span class="s1">AWS_REGION=us-east-1</span>

<span class="s1"># Application</span>
<span class="s1">ENVIRONMENT=development</span>
<span class="s1">DEBUG=true</span>
<span class="s1">SECRET_KEY=your_secret_key_for_jwt</span>
<span class="s1">&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">_generate_makefile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate Makefile for common commands.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;# Makefile for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s1"></span>

<span class="s1">.PHONY: install test lint run docker-build docker-up docker-down deploy</span>

<span class="s1">install:</span>
<span class="se">\t</span><span class="s1">pip install -r requirements.txt</span>
<span class="se">\t</span><span class="s1">pre-commit install</span>

<span class="s1">test:</span>
<span class="se">\t</span><span class="s1">pytest tests/ -v --cov=src</span>

<span class="s1">lint:</span>
<span class="se">\t</span><span class="s1">flake8 src/ tests/</span>
<span class="se">\t</span><span class="s1">black --check src/ tests/</span>

<span class="s1">format:</span>
<span class="se">\t</span><span class="s1">black src/ tests/</span>
<span class="se">\t</span><span class="s1">isort src/ tests/</span>

<span class="s1">run:</span>
<span class="se">\t</span><span class="s1">uvicorn main:app --reload --port 8000</span>

<span class="s1">docker-build:</span>
<span class="se">\t</span><span class="s1">docker-compose build</span>

<span class="s1">docker-up:</span>
<span class="se">\t</span><span class="s1">docker-compose up -d</span>

<span class="s1">docker-down:</span>
<span class="se">\t</span><span class="s1">docker-compose down</span>

<span class="s1">docker-logs:</span>
<span class="se">\t</span><span class="s1">docker-compose logs -f</span>

<span class="s1">deploy-staging:</span>
<span class="se">\t</span><span class="s1">cd terraform &amp;&amp; terraform workspace select staging</span>
<span class="se">\t</span><span class="s1">cd terraform &amp;&amp; terraform apply -auto-approve</span>

<span class="s1">deploy-prod:</span>
<span class="se">\t</span><span class="s1">cd terraform &amp;&amp; terraform workspace select production</span>
<span class="se">\t</span><span class="s1">cd terraform &amp;&amp; terraform apply</span>
<span class="s1">&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">_generate_readme</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate README documentation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;# </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s1"></span>

<span class="s1">Quantitative trading system deployed on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">.</span>

<span class="s1">## Quick Start</span>

<span class="s1">```bash</span>
<span class="s1"># Clone repository</span>
<span class="s1">git clone &lt;repo-url&gt;</span>
<span class="s1">cd </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1"></span>

<span class="s1"># Setup environment</span>
<span class="s1">cp .env.example .env</span>
<span class="s1">make install</span>

<span class="s1"># Run locally</span>
<span class="s1">make docker-up</span>
<span class="s1">```</span>

<span class="s1">## Architecture</span>

<span class="s1">- **API Server**: REST API for client access</span>
<span class="s1">- **Strategy Engine**: Executes trading strategies</span>
<span class="s1">- **Data Processor**: Collects and processes market data</span>
<span class="s1">- **Database**: PostgreSQL for persistent storage</span>
<span class="s1">- **Cache**: Redis for high-speed data access</span>

<span class="s1">## Deployment</span>

<span class="s1">```bash</span>
<span class="s1"># Deploy to staging</span>
<span class="s1">make deploy-staging</span>

<span class="s1"># Deploy to production</span>
<span class="s1">make deploy-prod</span>
<span class="s1">```</span>

<span class="s1">## Development</span>

<span class="s1">```bash</span>
<span class="s1"># Run tests</span>
<span class="s1">make test</span>

<span class="s1"># Lint code</span>
<span class="s1">make lint</span>

<span class="s1"># Format code</span>
<span class="s1">make format</span>
<span class="s1">```</span>

<span class="s1">## Estimated Monthly Cost</span>

<span class="s1">$</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">total_estimated_cost</span><span class="p">()</span><span class="si">}</span><span class="s1">/month (varies with usage)</span>
<span class="s1">&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">display_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display deployment template summary.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cloud Deployment Template: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated Files:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">display_architecture</span><span class="p">()</span>

<span class="c1"># Generate complete deployment template</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">CloudDeploymentTemplate</span><span class="p">(</span><span class="s2">&quot;Quant Trading Platform&quot;</span><span class="p">,</span> <span class="n">provider</span><span class="o">=</span><span class="s1">&#39;aws&#39;</span><span class="p">)</span>
<span class="n">template</span><span class="o">.</span><span class="n">add_standard_services</span><span class="p">()</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">generate_all_files</span><span class="p">()</span>

<span class="n">template</span><span class="o">.</span><span class="n">display_summary</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Display generated Makefile</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generated Makefile:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;Makefile&#39;</span><span class="p">])</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<h3>Cloud Architecture</h3>
<ul>
<li>Choose provider based on your needs (AWS for breadth, GCP for ML, Azure for enterprise)</li>
<li>Design for scalability and fault tolerance</li>
<li>Use Infrastructure as Code (Terraform, CloudFormation)</li>
</ul>
<h3>Containerization</h3>
<ul>
<li>Docker ensures consistent environments</li>
<li>Use multi-stage builds to reduce image size</li>
<li>Docker Compose for local development</li>
</ul>
<h3>Serverless</h3>
<ul>
<li>Ideal for event-driven workloads</li>
<li>Pay only for execution time</li>
<li>Cold starts can add latency</li>
</ul>
<h3>CI/CD</h3>
<ul>
<li>Automate testing and deployment</li>
<li>Use pre-commit hooks for code quality</li>
<li>Deploy to staging before production</li>
</ul>
<h3>Best Practices</h3>
<ol>
<li>Never commit secrets - use environment variables</li>
<li>Tag Docker images with git commit SHA</li>
<li>Run tests before every deployment</li>
<li>Monitor costs and set billing alerts</li>
<li>Use multiple environments (dev, staging, prod)</li>
</ol>
<hr />
<p><strong>Next: Module 18 - Performance Monitoring</strong></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="18"><div class="md-cell module-header"><h1>Module 18: 24/7 Operation</h1>
<h2>Part 5: Production &amp; Infrastructure</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
</tbody>
</table></div>
<h3>Learning Objectives</h3>
<p>By the end of this module, you will be able to:
- Implement comprehensive system monitoring with metrics collection
- Design and configure alerting systems for trading operations
- Manage incidents with structured response processes
- Build backup and recovery strategies for critical data</p>
<hr /></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Environment setup</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module 18: 24/7 Operation&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Section 18.1: System Monitoring</h2>
<p>You can't fix what you can't see. Monitoring is the foundation of reliable operations.</p>
<h3>What to Monitor</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Category</th>
<th>Metrics</th>
<th>Why It Matters</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Infrastructure</strong></td>
<td>CPU, memory, disk, network</td>
<td>Resource exhaustion</td>
</tr>
<tr>
<td><strong>Application</strong></td>
<td>Latency, errors, throughput</td>
<td>User experience</td>
</tr>
<tr>
<td><strong>Business</strong></td>
<td>Orders executed, PnL, positions</td>
<td>Trading outcomes</td>
</tr>
<tr>
<td><strong>Dependencies</strong></td>
<td>Database, API, broker</td>
<td>External failures</td>
</tr>
</tbody>
</table></div>
<h3>The Four Golden Signals (SRE)</h3>
<ol>
<li><strong>Latency</strong>: How long requests take</li>
<li><strong>Traffic</strong>: How many requests you're handling</li>
<li><strong>Errors</strong>: Rate of failed requests</li>
<li><strong>Saturation</strong>: How "full" your service is</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MetricType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">GAUGE</span> <span class="o">=</span> <span class="s2">&quot;gauge&quot;</span>      <span class="c1"># Current value (e.g., CPU usage)</span>
    <span class="n">COUNTER</span> <span class="o">=</span> <span class="s2">&quot;counter&quot;</span>  <span class="c1"># Cumulative count (e.g., total requests)</span>
    <span class="n">HISTOGRAM</span> <span class="o">=</span> <span class="s2">&quot;histogram&quot;</span>  <span class="c1"># Distribution (e.g., latency)</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Metric</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A single metric measurement.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span> <span class="o">=</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">GAUGE</span>

<span class="k">class</span> <span class="nc">MetricsCollector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collects and stores system metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retention_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retention_hours</span> <span class="o">=</span> <span class="n">retention_hours</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Metric</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">metric_type</span><span class="p">:</span> <span class="n">MetricType</span> <span class="o">=</span> <span class="n">MetricType</span><span class="o">.</span><span class="n">GAUGE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record a metric value.&quot;&quot;&quot;</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">Metric</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="n">metric_type</span><span class="o">=</span><span class="n">metric_type</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increment a counter metric.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">counters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counters</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">metric_type</span><span class="o">=</span><span class="n">MetricType</span><span class="o">.</span><span class="n">COUNTER</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove old metrics beyond retention period.&quot;&quot;&quot;</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retention_hours</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">cutoff</span>
        <span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_latest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the most recent value for a metric.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">get_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get time series data for a metric.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">cutoff</span>
        <span class="p">]</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get statistics for a metric over time period.&quot;&quot;&quot;</span>
        <span class="n">series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_series</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">hours</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">values</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
            <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
            <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
            <span class="s1">&#39;p50&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">50</span><span class="p">)),</span>
            <span class="s1">&#39;p95&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">95</span><span class="p">)),</span>
            <span class="s1">&#39;p99&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">99</span><span class="p">)),</span>
            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="p">}</span>

<span class="k">class</span> <span class="nc">HealthChecker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs health checks on system components.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">register_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">check_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a health check function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_func</span>
    
    <span class="k">def</span> <span class="nf">run_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Run all registered health checks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">check_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">check_func</span><span class="p">()</span>
                <span class="n">healthy</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;healthy&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">healthy</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            
            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="n">healthy</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                <span class="s1">&#39;duration_ms&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">is_healthy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if all components are healthy.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_checks</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get overall system status.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_checks</span><span class="p">()</span>
        
        <span class="n">healthy_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">])</span>
        <span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_healthy</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;unhealthy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;healthy_checks&#39;</span><span class="p">:</span> <span class="n">healthy_count</span><span class="p">,</span>
            <span class="s1">&#39;total_checks&#39;</span><span class="p">:</span> <span class="n">total_count</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;checks&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
        <span class="p">}</span>

<span class="c1"># Create metrics collector and simulate data</span>
<span class="n">collector</span> <span class="o">=</span> <span class="n">MetricsCollector</span><span class="p">()</span>

<span class="c1"># Simulate collecting metrics over time</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">base_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">120</span><span class="p">):</span>  <span class="c1"># 2 hours of data at 1-minute intervals</span>
    <span class="c1"># Simulated metrics</span>
    <span class="n">cpu</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>  <span class="c1"># Periodic load</span>
    <span class="n">memory</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">latency</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># Long tail</span>
    
    <span class="n">collector</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s1">&#39;cpu_percent&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)))</span>
    <span class="n">collector</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s1">&#39;memory_percent&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">memory</span><span class="p">)))</span>
    <span class="n">collector</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s1">&#39;api_latency_ms&#39;</span><span class="p">,</span> <span class="n">latency</span><span class="p">)</span>
    <span class="n">collector</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="s1">&#39;requests_total&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
    <span class="n">collector</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="s1">&#39;errors_total&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>

<span class="c1"># Display statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;System Metrics Summary (Last Hour)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cpu_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;memory_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;api_latency_ms&#39;</span><span class="p">]:</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  P50:  </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;p50&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  P95:  </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;p95&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  P99:  </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;p99&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Set up health checks</span>
<span class="n">health</span> <span class="o">=</span> <span class="n">HealthChecker</span><span class="p">()</span>

<span class="c1"># Simulated health check functions</span>
<span class="k">def</span> <span class="nf">check_database</span><span class="p">():</span>
    <span class="c1"># Simulate database connectivity check</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Database connected&#39;</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">check_broker_api</span><span class="p">():</span>
    <span class="c1"># Simulate broker API check</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Broker API responding&#39;</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">check_market_data</span><span class="p">():</span>
    <span class="c1"># Simulate market data feed check</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Market data streaming&#39;</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">check_disk_space</span><span class="p">():</span>
    <span class="c1"># Simulate disk space check</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="n">usage</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">,</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Disk usage: </span><span class="si">{</span><span class="n">usage</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span>
    <span class="p">}</span>

<span class="n">health</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="n">check_database</span><span class="p">)</span>
<span class="n">health</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="s1">&#39;broker_api&#39;</span><span class="p">,</span> <span class="n">check_broker_api</span><span class="p">)</span>
<span class="n">health</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="s1">&#39;market_data&#39;</span><span class="p">,</span> <span class="n">check_market_data</span><span class="p">)</span>
<span class="n">health</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="s1">&#39;disk_space&#39;</span><span class="p">,</span> <span class="n">check_disk_space</span><span class="p">)</span>

<span class="c1"># Run health checks</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">health</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Health Check Results&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overall Status: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Healthy: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;healthy_checks&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;total_checks&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;checks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">status_icon</span> <span class="o">=</span> <span class="s2">&quot;‚úì&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;‚úó&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">status_icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;duration_ms&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">ms)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 18.1: Position Risk Health Check (Guided)</h3>
<p>Create a health check that monitors position risk and returns unhealthy if any position exceeds a maximum size.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 18.1: Position Risk Health Check (Guided)</span>

<span class="k">def</span> <span class="nf">check_position_risk</span><span class="p">(</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">max_position_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if any position exceeds maximum allowed size.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        positions: Dict of {symbol: position_value}</span>
<span class="sd">        max_position_pct: Maximum allowed position as % of total</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Health check result dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Handle empty positions</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">______</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;No positions&#39;</span><span class="p">}</span>
    
    <span class="c1"># TODO: Calculate total portfolio value using absolute values</span>
    <span class="n">total_value</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">______</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">positions</span><span class="o">.</span><span class="n">______</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="n">total_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;No positions&#39;</span><span class="p">}</span>
    
    <span class="n">violations</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># TODO: Calculate position percentage</span>
        <span class="n">position_pct</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">______</span>
        
        <span class="c1"># TODO: Check if exceeds limit</span>
        <span class="k">if</span> <span class="n">position_pct</span> <span class="n">______</span> <span class="n">max_position_pct</span><span class="p">:</span>
            <span class="n">violations</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">position_pct</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># TODO: Return unhealthy if violations exist</span>
    <span class="k">if</span> <span class="n">______</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Position limits exceeded: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;All positions within </span><span class="si">{</span><span class="n">max_position_pct</span><span class="si">:</span><span class="s1">.0%</span><span class="si">}</span><span class="s1"> limit&#39;</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">test_positions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;AAPL&#39;</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span>
    <span class="s1">&#39;MSFT&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
    <span class="s1">&#39;GOOGL&#39;</span><span class="p">:</span> <span class="mi">25000</span><span class="p">,</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test 1 (all within limits):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">check_position_risk</span><span class="p">(</span><span class="n">test_positions</span><span class="p">,</span> <span class="n">max_position_pct</span><span class="o">=</span><span class="mf">0.50</span><span class="p">))</span>

<span class="n">test_positions_violation</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;AAPL&#39;</span><span class="p">:</span> <span class="mi">60000</span><span class="p">,</span>  <span class="c1"># ~50% - may exceed limit</span>
    <span class="s1">&#39;MSFT&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
    <span class="s1">&#39;GOOGL&#39;</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test 2 (AAPL exceeds 40</span><span class="si">% li</span><span class="s2">mit):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">check_position_risk</span><span class="p">(</span><span class="n">test_positions_violation</span><span class="p">,</span> <span class="n">max_position_pct</span><span class="o">=</span><span class="mf">0.40</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">check_position_risk</span><span class="p">(</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">max_position_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if any position exceeds maximum allowed size.</span>

<span class="sd">    Args:</span>
<span class="sd">        positions: Dict of {symbol: position_value}</span>
<span class="sd">        max_position_pct: Maximum allowed position as % of total</span>

<span class="sd">    Returns:</span>
<span class="sd">        Health check result dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">positions</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;No positions&#39;</span><span class="p">}</span>

    <span class="n">total_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">total_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;No positions&#39;</span><span class="p">}</span>

    <span class="n">violations</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">position_pct</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_value</span>

        <span class="k">if</span> <span class="n">position_pct</span> <span class="o">&gt;</span> <span class="n">max_position_pct</span><span class="p">:</span>
            <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">position_pct</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">violations</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Position limits exceeded: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;All positions within </span><span class="si">{</span><span class="n">max_position_pct</span><span class="si">:</span><span class="s1">.0%</span><span class="si">}</span><span class="s1"> limit&#39;</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 18.2: Alerting Systems</h2>
<p>Monitoring is useless if no one sees the problems. Alerting bridges that gap.</p>
<h3>Alert Design Principles</h3>
<ol>
<li><strong>Actionable</strong>: Every alert should require action</li>
<li><strong>Urgent</strong>: Reserve alerts for time-sensitive issues</li>
<li><strong>Meaningful</strong>: Avoid alert fatigue from false positives</li>
<li><strong>Informative</strong>: Include enough context to diagnose</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">AlertSeverity</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">INFO</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span>
    <span class="n">WARNING</span> <span class="o">=</span> <span class="s2">&quot;warning&quot;</span>
    <span class="n">CRITICAL</span> <span class="o">=</span> <span class="s2">&quot;critical&quot;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Alert</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a system alert.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">severity</span><span class="p">:</span> <span class="n">AlertSeverity</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">resolved</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">resolved_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AlertRule</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Defines when an alert should fire.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span>  <span class="c1"># Function that returns True if alert should fire</span>
    <span class="n">severity</span><span class="p">:</span> <span class="n">AlertSeverity</span>
    <span class="n">message_template</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">cooldown_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Minimum time between alerts</span>
    <span class="n">last_fired</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">AlertManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages alert rules, firing, and notification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AlertRule</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_alerts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Alert</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Alert</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notification_channels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">severity</span><span class="p">:</span> <span class="n">AlertSeverity</span><span class="p">,</span>
                 <span class="n">message_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cooldown_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an alert rule.&quot;&quot;&quot;</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="n">AlertRule</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="n">severity</span><span class="p">,</span>
            <span class="n">message_template</span><span class="o">=</span><span class="n">message_template</span><span class="p">,</span>
            <span class="n">cooldown_minutes</span><span class="o">=</span><span class="n">cooldown_minutes</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_notification_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a notification channel (function that receives alerts).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notification_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">check_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Alert</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check all rules and fire alerts as needed.</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        context : dict</span>
<span class="sd">            Current system state for rule evaluation</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        List[Alert] : New alerts that were fired</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="c1"># Check cooldown</span>
            <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">last_fired</span><span class="p">:</span>
                <span class="n">cooldown_end</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">last_fired</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">cooldown_minutes</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">cooldown_end</span><span class="p">:</span>
                    <span class="k">continue</span>
            
            <span class="c1"># Evaluate condition</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">should_fire</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">condition</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">should_fire</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">if</span> <span class="n">should_fire</span><span class="p">:</span>
                <span class="c1"># Create alert</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">message_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">)</span>
                <span class="n">alert</span> <span class="o">=</span> <span class="n">Alert</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">severity</span><span class="o">=</span><span class="n">rule</span><span class="o">.</span><span class="n">severity</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">message</span>
                <span class="p">)</span>
                
                <span class="c1"># Record and notify</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
                <span class="n">new_alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">last_fired</span> <span class="o">=</span> <span class="n">now</span>
                
                <span class="c1"># Send to notification channels</span>
                <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">notification_channels</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">channel</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Notification failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">new_alerts</span>
    
    <span class="k">def</span> <span class="nf">resolve_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resolve active alerts by name.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_alerts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alert</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">alert_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">alert</span><span class="o">.</span><span class="n">resolved</span><span class="p">:</span>
                <span class="n">alert</span><span class="o">.</span><span class="n">resolved</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">alert</span><span class="o">.</span><span class="n">resolved_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="c1"># Remove resolved alerts from active list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_alerts</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_alerts</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">resolved</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_active_alerts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Alert</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all active (unresolved) alerts.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_alerts</span>
    
    <span class="k">def</span> <span class="nf">get_alert_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get summary of alert activity.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;active_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_alerts</span><span class="p">),</span>
            <span class="s1">&#39;critical_count&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_alerts</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="n">AlertSeverity</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">),</span>
            <span class="s1">&#39;warning_count&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_alerts</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="n">AlertSeverity</span><span class="o">.</span><span class="n">WARNING</span><span class="p">),</span>
            <span class="s1">&#39;total_fired_24h&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="mi">1</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alert_history</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s1">&#39;active_alerts&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">message</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_alerts</span>
            <span class="p">]</span>
        <span class="p">}</span>

<span class="c1"># Create alert manager</span>
<span class="n">alerts</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>

<span class="c1"># Add notification channel (just print for demo)</span>
<span class="k">def</span> <span class="nf">console_notification</span><span class="p">(</span><span class="n">alert</span><span class="p">:</span> <span class="n">Alert</span><span class="p">):</span>
    <span class="n">severity_emoji</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="s1">&#39;‚ÑπÔ∏è&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="s1">&#39;‚ö†Ô∏è&#39;</span><span class="p">,</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="s1">&#39;üö®&#39;</span><span class="p">}</span>
    <span class="n">emoji</span> <span class="o">=</span> <span class="n">severity_emoji</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alert</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;üì¢&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">alert</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">alert</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">alert</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">alerts</span><span class="o">.</span><span class="n">add_notification_channel</span><span class="p">(</span><span class="n">console_notification</span><span class="p">)</span>

<span class="c1"># Add alert rules</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;high_cpu&#39;</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpu_percent&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">severity</span><span class="o">=</span><span class="n">AlertSeverity</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
    <span class="n">message_template</span><span class="o">=</span><span class="s1">&#39;CPU usage at </span><span class="si">{cpu_percent:.1f}</span><span class="s1">%&#39;</span><span class="p">,</span>
    <span class="n">cooldown_minutes</span><span class="o">=</span><span class="mi">5</span>
<span class="p">)</span>

<span class="n">alerts</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;critical_cpu&#39;</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpu_percent&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">95</span><span class="p">,</span>
    <span class="n">severity</span><span class="o">=</span><span class="n">AlertSeverity</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span>
    <span class="n">message_template</span><span class="o">=</span><span class="s1">&#39;CRITICAL: CPU at </span><span class="si">{cpu_percent:.1f}</span><span class="s1">%!&#39;</span><span class="p">,</span>
    <span class="n">cooldown_minutes</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">alerts</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;high_error_rate&#39;</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">,</span>
    <span class="n">severity</span><span class="o">=</span><span class="n">AlertSeverity</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
    <span class="n">message_template</span><span class="o">=</span><span class="s1">&#39;Error rate elevated: </span><span class="si">{error_rate:.1%}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">cooldown_minutes</span><span class="o">=</span><span class="mi">5</span>
<span class="p">)</span>

<span class="n">alerts</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;large_drawdown&#39;</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drawdown_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.10</span><span class="p">,</span>
    <span class="n">severity</span><span class="o">=</span><span class="n">AlertSeverity</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span>
    <span class="n">message_template</span><span class="o">=</span><span class="s1">&#39;Large drawdown: </span><span class="si">{drawdown_pct:.1%}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">cooldown_minutes</span><span class="o">=</span><span class="mi">15</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Alert Rules Configured&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">alerts</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">rule</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">:</span><span class="s2">8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Simulate system states and check alerts</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Simulating Alert Scenarios&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="c1"># Normal state</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">1. Normal state:&quot;</span><span class="p">)</span>
<span class="n">context_normal</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cpu_percent&#39;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span> <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s1">&#39;drawdown_pct&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">}</span>
<span class="n">new_alerts</span> <span class="o">=</span> <span class="n">alerts</span><span class="o">.</span><span class="n">check_rules</span><span class="p">(</span><span class="n">context_normal</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">new_alerts</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   No alerts fired&quot;</span><span class="p">)</span>

<span class="c1"># High CPU</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">2. High CPU:&quot;</span><span class="p">)</span>
<span class="n">context_high_cpu</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cpu_percent&#39;</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s1">&#39;drawdown_pct&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">}</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">check_rules</span><span class="p">(</span><span class="n">context_high_cpu</span><span class="p">)</span>

<span class="c1"># Critical situation</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">3. Critical situation:&quot;</span><span class="p">)</span>
<span class="n">context_critical</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cpu_percent&#39;</span><span class="p">:</span> <span class="mi">97</span><span class="p">,</span> <span class="s1">&#39;error_rate&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span> <span class="s1">&#39;drawdown_pct&#39;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">}</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">check_rules</span><span class="p">(</span><span class="n">context_critical</span><span class="p">)</span>

<span class="c1"># Summary</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Alert Summary:&quot;</span><span class="p">)</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">alerts</span><span class="o">.</span><span class="n">get_alert_summary</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Active alerts: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;active_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Critical: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;critical_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Warning: </span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;warning_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 18.2: Alert Rule Builder (Guided)</h3>
<p>Build a function that creates alert rules with proper threshold configuration.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 18.2: Alert Rule Builder (Guided)</span>

<span class="k">def</span> <span class="nf">create_threshold_alert</span><span class="p">(</span><span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">warning_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                          <span class="n">critical_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">comparison</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;above&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create warning and critical alert rules for a metric.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        metric_name: Name of the metric to monitor</span>
<span class="sd">        warning_threshold: Threshold for warning alerts</span>
<span class="sd">        critical_threshold: Threshold for critical alerts</span>
<span class="sd">        comparison: &#39;above&#39; or &#39;below&#39;</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        List of alert rule configurations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Create comparison function based on direction</span>
    <span class="k">if</span> <span class="n">comparison</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span><span class="p">:</span>
        <span class="c1"># TODO: Create warning condition - metric above warning threshold</span>
        <span class="n">warning_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="n">______</span> <span class="n">warning_threshold</span>
        <span class="c1"># TODO: Create critical condition - metric above critical threshold</span>
        <span class="n">critical_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">______</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO: Create conditions for &#39;below&#39; comparison</span>
        <span class="n">warning_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span> <span class="n">______</span> <span class="n">warning_threshold</span>
        <span class="n">critical_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">critical_threshold</span>
    
    <span class="c1"># Warning rule</span>
    <span class="n">warning_rule</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># TODO: Create rule name</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s1">______warning&#39;</span><span class="p">,</span>
        <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="n">warning_condition</span><span class="p">,</span>
        <span class="c1"># TODO: Set severity</span>
        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">AlertSeverity</span><span class="o">.</span><span class="n">______</span><span class="p">,</span>
        <span class="s1">&#39;message_template&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">metric_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">}}</span><span class="s1"> </span><span class="si">{</span><span class="n">comparison</span><span class="si">}</span><span class="s1"> warning threshold (</span><span class="si">{</span><span class="n">warning_threshold</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="p">}</span>
    
    <span class="c1"># Critical rule</span>
    <span class="n">critical_rule</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s1">_critical&#39;</span><span class="p">,</span>
        <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="n">critical_condition</span><span class="p">,</span>
        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">AlertSeverity</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span>
        <span class="c1"># TODO: Create message template with threshold</span>
        <span class="s1">&#39;message_template&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">metric_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">}}</span><span class="s1"> </span><span class="si">{</span><span class="n">comparison</span><span class="si">}</span><span class="s1"> critical threshold (</span><span class="si">{</span><span class="n">______</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="p">}</span>
    
    <span class="c1"># TODO: Add rules to list</span>
    <span class="n">rules</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">warning_rule</span><span class="p">)</span>
    <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">______</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">rules</span>

<span class="c1"># Test</span>
<span class="n">cpu_rules</span> <span class="o">=</span> <span class="n">create_threshold_alert</span><span class="p">(</span><span class="s1">&#39;cpu_percent&#39;</span><span class="p">,</span> <span class="n">warning_threshold</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">critical_threshold</span><span class="o">=</span><span class="mi">95</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CPU Alert Rules:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">cpu_rules</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">memory_rules</span> <span class="o">=</span> <span class="n">create_threshold_alert</span><span class="p">(</span><span class="s1">&#39;free_memory_mb&#39;</span><span class="p">,</span> <span class="n">warning_threshold</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> 
                                      <span class="n">critical_threshold</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">comparison</span><span class="o">=</span><span class="s1">&#39;below&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Memory Alert Rules:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">memory_rules</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">rule</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_threshold_alert</span><span class="p">(</span><span class="n">metric_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">warning_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                          <span class="n">critical_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">comparison</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;above&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create warning and critical alert rules for a metric.</span>

<span class="sd">    Args:</span>
<span class="sd">        metric_name: Name of the metric to monitor</span>
<span class="sd">        warning_threshold: Threshold for warning alerts</span>
<span class="sd">        critical_threshold: Threshold for critical alerts</span>
<span class="sd">        comparison: &#39;above&#39; or &#39;below&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of alert rule configurations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">comparison</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span><span class="p">:</span>
        <span class="n">warning_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">warning_threshold</span>
        <span class="n">critical_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">critical_threshold</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warning_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">warning_threshold</span>
        <span class="n">critical_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">critical_threshold</span>

    <span class="n">warning_rule</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s1">_warning&#39;</span><span class="p">,</span>
        <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="n">warning_condition</span><span class="p">,</span>
        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">AlertSeverity</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
        <span class="s1">&#39;message_template&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">metric_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">}}</span><span class="s1"> </span><span class="si">{</span><span class="n">comparison</span><span class="si">}</span><span class="s1"> warning threshold (</span><span class="si">{</span><span class="n">warning_threshold</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="p">}</span>

    <span class="n">critical_rule</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s1">_critical&#39;</span><span class="p">,</span>
        <span class="s1">&#39;condition&#39;</span><span class="p">:</span> <span class="n">critical_condition</span><span class="p">,</span>
        <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">AlertSeverity</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span>
        <span class="s1">&#39;message_template&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">metric_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">}}</span><span class="s1"> </span><span class="si">{</span><span class="n">comparison</span><span class="si">}</span><span class="s1"> critical threshold (</span><span class="si">{</span><span class="n">critical_threshold</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="p">}</span>

    <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">warning_rule</span><span class="p">)</span>
    <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">critical_rule</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rules</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 18.3: Incident Response</h2>
<p>When things go wrong (and they will), having a systematic response process is crucial.</p>
<h3>Incident Lifecycle</h3>
<ol>
<li><strong>Detection</strong>: Alert fires or user reports issue</li>
<li><strong>Triage</strong>: Assess severity and impact</li>
<li><strong>Response</strong>: Follow runbook, mitigate impact</li>
<li><strong>Resolution</strong>: Fix the root cause</li>
<li><strong>Post-mortem</strong>: Learn and prevent recurrence</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">IncidentSeverity</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">SEV1</span> <span class="o">=</span> <span class="s2">&quot;sev1&quot;</span>  <span class="c1"># Critical: Trading halted, major financial impact</span>
    <span class="n">SEV2</span> <span class="o">=</span> <span class="s2">&quot;sev2&quot;</span>  <span class="c1"># High: Degraded performance, significant impact</span>
    <span class="n">SEV3</span> <span class="o">=</span> <span class="s2">&quot;sev3&quot;</span>  <span class="c1"># Medium: Minor issues, limited impact</span>
    <span class="n">SEV4</span> <span class="o">=</span> <span class="s2">&quot;sev4&quot;</span>  <span class="c1"># Low: Cosmetic issues, no financial impact</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Incident</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a system incident.&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">severity</span><span class="p">:</span> <span class="n">IncidentSeverity</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
    <span class="n">resolved_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;open&quot;</span>  <span class="c1"># open, investigating, mitigating, resolved</span>
    <span class="n">timeline</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">affected_systems</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">impact</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">root_cause</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Runbook</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A runbook for incident response.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">symptoms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>  <span class="c1"># {step: str, expected_outcome: str}</span>
    <span class="n">escalation</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">estimated_time_minutes</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">IncidentManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages incident lifecycle and documentation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Incident</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runbooks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Runbook</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_incident_counter</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">create_incident</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">severity</span><span class="p">:</span> <span class="n">IncidentSeverity</span><span class="p">,</span>
                       <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">affected_systems</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Incident</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a new incident.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_incident_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">incident_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;INC-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_incident_counter</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="n">incident</span> <span class="o">=</span> <span class="n">Incident</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">incident_id</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">severity</span><span class="o">=</span><span class="n">severity</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">affected_systems</span><span class="o">=</span><span class="n">affected_systems</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="p">)</span>
        
        <span class="c1"># Add creation to timeline</span>
        <span class="n">incident</span><span class="o">.</span><span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;Incident created&#39;</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">description</span>
        <span class="p">})</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">[</span><span class="n">incident_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">incident</span>
        <span class="k">return</span> <span class="n">incident</span>
    
    <span class="k">def</span> <span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incident_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update incident status.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">incident_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incident </span><span class="si">{</span><span class="n">incident_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        
        <span class="n">incident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">[</span><span class="n">incident_id</span><span class="p">]</span>
        <span class="n">old_status</span> <span class="o">=</span> <span class="n">incident</span><span class="o">.</span><span class="n">status</span>
        <span class="n">incident</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">new_status</span>
        
        <span class="n">incident</span><span class="o">.</span><span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Status changed: </span><span class="si">{</span><span class="n">old_status</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">new_status</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">notes</span>
        <span class="p">})</span>
        
        <span class="k">if</span> <span class="n">new_status</span> <span class="o">==</span> <span class="s1">&#39;resolved&#39;</span><span class="p">:</span>
            <span class="n">incident</span><span class="o">.</span><span class="n">resolved_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">add_timeline_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incident_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an entry to the incident timeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">incident_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incident </span><span class="si">{</span><span class="n">incident_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">[</span><span class="n">incident_id</span><span class="p">]</span><span class="o">.</span><span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">details</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">add_runbook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runbook</span><span class="p">:</span> <span class="n">Runbook</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a runbook to the library.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runbooks</span><span class="p">[</span><span class="n">runbook</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">runbook</span>
    
    <span class="k">def</span> <span class="nf">find_runbook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symptoms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Runbook</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find a runbook matching given symptoms.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">runbook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runbooks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">matching</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symptoms</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">rs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">runbook</span><span class="o">.</span><span class="n">symptoms</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">matching</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">runbook</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">generate_postmortem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incident_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate a post-mortem report for an incident.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">incident_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incident </span><span class="si">{</span><span class="n">incident_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        
        <span class="n">incident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">[</span><span class="n">incident_id</span><span class="p">]</span>
        
        <span class="n">duration</span> <span class="o">=</span> <span class="s2">&quot;Ongoing&quot;</span>
        <span class="k">if</span> <span class="n">incident</span><span class="o">.</span><span class="n">resolved_at</span><span class="p">:</span>
            <span class="n">duration_mins</span> <span class="o">=</span> <span class="p">(</span><span class="n">incident</span><span class="o">.</span><span class="n">resolved_at</span> <span class="o">-</span> <span class="n">incident</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">duration_mins</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> minutes&quot;</span>
        
        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># Post-Mortem Report: </span><span class="si">{</span><span class="n">incident</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"></span>

<span class="s2">## Summary</span>
<span class="s2">- **Title**: </span><span class="si">{</span><span class="n">incident</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"></span>
<span class="s2">- **Severity**: </span><span class="si">{</span><span class="n">incident</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"></span>
<span class="s2">- **Duration**: </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"></span>
<span class="s2">- **Status**: </span><span class="si">{</span><span class="n">incident</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2"></span>

<span class="s2">## Impact</span>
<span class="si">{</span><span class="n">incident</span><span class="o">.</span><span class="n">impact</span> <span class="ow">or</span> <span class="s1">&#39;Not documented&#39;</span><span class="si">}</span><span class="s2"></span>

<span class="s2">## Affected Systems</span>
<span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">incident</span><span class="o">.</span><span class="n">affected_systems</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;Not specified&#39;</span><span class="si">}</span><span class="s2"></span>

<span class="s2">## Timeline</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">incident</span><span class="o">.</span><span class="n">timeline</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- **</span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">**: </span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;details&#39;</span><span class="p">):</span>
                <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="n">report</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">## Root Cause</span>
<span class="si">{</span><span class="n">incident</span><span class="o">.</span><span class="n">root_cause</span> <span class="ow">or</span> <span class="s1">&#39;Under investigation&#39;</span><span class="si">}</span><span class="s2"></span>

<span class="s2">## Resolution</span>
<span class="si">{</span><span class="n">incident</span><span class="o">.</span><span class="n">resolution</span> <span class="ow">or</span> <span class="s1">&#39;Not yet resolved&#39;</span><span class="si">}</span><span class="s2"></span>

<span class="s2">## Action Items</span>
<span class="s2">- [ ] Document lessons learned</span>
<span class="s2">- [ ] Update monitoring/alerting</span>
<span class="s2">- [ ] Review and update runbooks</span>
<span class="s2">- [ ] Schedule follow-up review</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">report</span>

<span class="c1"># Create incident manager and add runbooks</span>
<span class="n">incidents</span> <span class="o">=</span> <span class="n">IncidentManager</span><span class="p">()</span>

<span class="c1"># Add some runbooks</span>
<span class="n">runbook_db</span> <span class="o">=</span> <span class="n">Runbook</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;database_connection_failure&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Steps to diagnose and recover from database connection issues&#39;</span><span class="p">,</span>
    <span class="n">symptoms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;database connection&#39;</span><span class="p">,</span> <span class="s1">&#39;connection refused&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;postgres&#39;</span><span class="p">],</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;Check database server status&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_outcome&#39;</span><span class="p">:</span> <span class="s1">&#39;Server should be running&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;Verify network connectivity&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_outcome&#39;</span><span class="p">:</span> <span class="s1">&#39;Ping should succeed&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;Check connection pool exhaustion&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_outcome&#39;</span><span class="p">:</span> <span class="s1">&#39;Connections &lt; max_pool&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;Review database logs&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_outcome&#39;</span><span class="p">:</span> <span class="s1">&#39;Identify error messages&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;Restart connection pool if needed&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_outcome&#39;</span><span class="p">:</span> <span class="s1">&#39;Connections restored&#39;</span><span class="p">},</span>
    <span class="p">],</span>
    <span class="n">escalation</span><span class="o">=</span><span class="s1">&#39;If not resolved in 15 minutes, page on-call DBA&#39;</span><span class="p">,</span>
    <span class="n">estimated_time_minutes</span><span class="o">=</span><span class="mi">30</span>
<span class="p">)</span>

<span class="n">runbook_api</span> <span class="o">=</span> <span class="n">Runbook</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;broker_api_failure&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Steps to handle broker API failures&#39;</span><span class="p">,</span>
    <span class="n">symptoms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;broker&#39;</span><span class="p">,</span> <span class="s1">&#39;api error&#39;</span><span class="p">,</span> <span class="s1">&#39;401&#39;</span><span class="p">,</span> <span class="s1">&#39;403&#39;</span><span class="p">,</span> <span class="s1">&#39;500&#39;</span><span class="p">,</span> <span class="s1">&#39;order rejected&#39;</span><span class="p">],</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;Check broker status page&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_outcome&#39;</span><span class="p">:</span> <span class="s1">&#39;Identify if broker-wide issue&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;Verify API credentials&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_outcome&#39;</span><span class="p">:</span> <span class="s1">&#39;Credentials should be valid&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;Check rate limits&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_outcome&#39;</span><span class="p">:</span> <span class="s1">&#39;Should be within limits&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;Enable backup broker if available&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_outcome&#39;</span><span class="p">:</span> <span class="s1">&#39;Orders route to backup&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;Pause new order submission&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_outcome&#39;</span><span class="p">:</span> <span class="s1">&#39;Prevent further failures&#39;</span><span class="p">},</span>
    <span class="p">],</span>
    <span class="n">escalation</span><span class="o">=</span><span class="s1">&#39;Contact broker support and notify risk team&#39;</span><span class="p">,</span>
    <span class="n">estimated_time_minutes</span><span class="o">=</span><span class="mi">15</span>
<span class="p">)</span>

<span class="n">incidents</span><span class="o">.</span><span class="n">add_runbook</span><span class="p">(</span><span class="n">runbook_db</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">add_runbook</span><span class="p">(</span><span class="n">runbook_api</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Runbooks Loaded:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">rb</span> <span class="ow">in</span> <span class="n">incidents</span><span class="o">.</span><span class="n">runbooks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">rb</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 18.3: Backup Job Configuration (Guided)</h3>
<p>Create a function that validates backup job configurations and calculates retention requirements.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 18.3: Backup Job Configuration (Guided)</span>

<span class="k">def</span> <span class="nf">validate_backup_config</span><span class="p">(</span><span class="n">jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate backup job configurations and calculate storage needs.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        jobs: List of backup job configurations</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Validation results and storage estimates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;jobs&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;total_daily_storage_gb&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;total_retention_storage_gb&#39;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
    
    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency_hours&#39;</span><span class="p">,</span> <span class="s1">&#39;retention_days&#39;</span><span class="p">,</span> <span class="s1">&#39;estimated_size_gb&#39;</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
        <span class="n">job_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        
        <span class="c1"># Check required fields</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">:</span>
            <span class="c1"># TODO: Check if field is missing</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="n">______</span> <span class="n">job</span><span class="p">:</span>
                <span class="n">job_result</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_result</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: missing </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_result</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_result</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="c1"># Calculate backups per day</span>
        <span class="c1"># TODO: Calculate number of backups per day</span>
        <span class="n">backups_per_day</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">/</span> <span class="n">job</span><span class="p">[</span><span class="n">______</span><span class="p">]</span>
        
        <span class="c1"># Daily storage requirement</span>
        <span class="c1"># TODO: Calculate daily storage</span>
        <span class="n">daily_storage</span> <span class="o">=</span> <span class="n">backups_per_day</span> <span class="o">*</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;estimated_size_gb&#39;</span><span class="p">]</span>
        <span class="n">job_result</span><span class="p">[</span><span class="s1">&#39;daily_storage_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span>
        
        <span class="c1"># Total retention storage</span>
        <span class="c1"># TODO: Calculate total retention storage</span>
        <span class="n">retention_storage</span> <span class="o">=</span> <span class="n">daily_storage</span> <span class="o">*</span> <span class="n">job</span><span class="p">[</span><span class="n">______</span><span class="p">]</span>
        <span class="n">job_result</span><span class="p">[</span><span class="s1">&#39;retention_storage_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retention_storage</span>
        
        <span class="c1"># Add to totals</span>
        <span class="c1"># TODO: Accumulate totals</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_daily_storage_gb&#39;</span><span class="p">]</span> <span class="n">______</span> <span class="n">daily_storage</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_retention_storage_gb&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">______</span>
        
        <span class="c1"># Warnings for potential issues</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;retention_days&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: retention less than 7 days&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">backups_per_day</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: backup frequency &gt; 24 hours&quot;</span><span class="p">)</span>
        
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_result</span><span class="p">)</span>
    
    <span class="c1"># TODO: Set overall validity</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
    
    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Test</span>
<span class="n">backup_jobs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;trade_database&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency_hours&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;retention_days&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="s1">&#39;estimated_size_gb&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;config_files&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency_hours&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span> <span class="s1">&#39;retention_days&#39;</span><span class="p">:</span> <span class="mi">365</span><span class="p">,</span> <span class="s1">&#39;estimated_size_gb&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;market_data&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency_hours&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span> <span class="s1">&#39;retention_days&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;estimated_size_gb&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency_hours&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span> <span class="s1">&#39;retention_days&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;estimated_size_gb&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
<span class="p">]</span>

<span class="n">validation</span> <span class="o">=</span> <span class="n">validate_backup_config</span><span class="p">(</span><span class="n">backup_jobs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration Valid: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Daily Storage: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;total_daily_storage_gb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Retention Storage: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;total_retention_storage_gb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">validation</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warnings: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_backup_config</span><span class="p">(</span><span class="n">jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate backup job configurations and calculate storage needs.</span>

<span class="sd">    Args:</span>
<span class="sd">        jobs: List of backup job configurations</span>

<span class="sd">    Returns:</span>
<span class="sd">        Validation results and storage estimates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;jobs&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;total_daily_storage_gb&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;total_retention_storage_gb&#39;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency_hours&#39;</span><span class="p">,</span> <span class="s1">&#39;retention_days&#39;</span><span class="p">,</span> <span class="s1">&#39;estimated_size_gb&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
        <span class="n">job_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">),</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
                <span class="n">job_result</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_result</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: missing </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_result</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_result</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">backups_per_day</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">/</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;frequency_hours&#39;</span><span class="p">]</span>

        <span class="n">daily_storage</span> <span class="o">=</span> <span class="n">backups_per_day</span> <span class="o">*</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;estimated_size_gb&#39;</span><span class="p">]</span>
        <span class="n">job_result</span><span class="p">[</span><span class="s1">&#39;daily_storage_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_storage</span>

        <span class="n">retention_storage</span> <span class="o">=</span> <span class="n">daily_storage</span> <span class="o">*</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;retention_days&#39;</span><span class="p">]</span>
        <span class="n">job_result</span><span class="p">[</span><span class="s1">&#39;retention_storage_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retention_storage</span>

        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_daily_storage_gb&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">daily_storage</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_retention_storage_gb&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">retention_storage</span>

        <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;retention_days&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: retention less than 7 days&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">backups_per_day</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: backup frequency &gt; 24 hours&quot;</span><span class="p">)</span>

        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_result</span><span class="p">)</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Section 18.4: Backup &amp; Recovery</h2>
<p>Data is your most valuable asset. Losing trade history, positions, or configuration can be catastrophic.</p>
<h3>Backup Strategy</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Data Type</th>
<th>Backup Frequency</th>
<th>Retention</th>
<th>Recovery Time Objective</th>
</tr>
</thead>
<tbody>
<tr>
<td>Trade database</td>
<td>Continuous (replication)</td>
<td>90 days</td>
<td>&lt; 1 hour</td>
</tr>
<tr>
<td>Configuration</td>
<td>On change</td>
<td>Forever</td>
<td>&lt; 15 minutes</td>
</tr>
<tr>
<td>Market data</td>
<td>Daily</td>
<td>30 days</td>
<td>&lt; 4 hours</td>
</tr>
<tr>
<td>Logs</td>
<td>Daily</td>
<td>7 days</td>
<td>&lt; 1 hour</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BackupJob</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a backup job.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">schedule</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># cron expression or description</span>
    <span class="n">retention_days</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">last_run</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">last_status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;never_run&quot;</span>
    <span class="n">last_size_mb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Backup</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a completed backup.&quot;&quot;&quot;</span>
    <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">size_mb</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">checksum</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BackupManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages backup jobs and recovery.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BackupJob</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backups</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Backup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">BackupJob</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a backup job.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
    
    <span class="k">def</span> <span class="nf">simulate_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Backup</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate running a backup job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        
        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">job_name</span><span class="p">]</span>
        
        <span class="c1"># Simulate backup creation</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">size_mb</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>  <span class="c1"># Simulated size</span>
        <span class="n">checksum</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sha256:</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="si">:</span><span class="s2">064x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">[:</span><span class="mi">72</span><span class="p">]</span>
        
        <span class="n">backup</span> <span class="o">=</span> <span class="n">Backup</span><span class="p">(</span>
            <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">destination</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.backup&quot;</span><span class="p">,</span>
            <span class="n">size_mb</span><span class="o">=</span><span class="n">size_mb</span><span class="p">,</span>
            <span class="n">checksum</span><span class="o">=</span><span class="n">checksum</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="s1">&#39;compression&#39;</span><span class="p">:</span> <span class="s1">&#39;gzip&#39;</span><span class="p">,</span>
                <span class="s1">&#39;encrypted&#39;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">}</span>
        <span class="p">)</span>
        
        <span class="c1"># Update job status</span>
        <span class="n">job</span><span class="o">.</span><span class="n">last_run</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="n">job</span><span class="o">.</span><span class="n">last_status</span> <span class="o">=</span> <span class="s1">&#39;success&#39;</span>
        <span class="n">job</span><span class="o">.</span><span class="n">last_size_mb</span> <span class="o">=</span> <span class="n">size_mb</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">backups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">backup</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">backup</span>
    
    <span class="k">def</span> <span class="nf">list_backups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Backup</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;List recent backups.&quot;&quot;&quot;</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
        
        <span class="n">backups</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backups</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">cutoff</span> <span class="ow">and</span> <span class="p">(</span><span class="n">job_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">b</span><span class="o">.</span><span class="n">job_name</span> <span class="o">==</span> <span class="n">job_name</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">backups</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_backup_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate backup status report.&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;jobs&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;total_backups&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backups</span><span class="p">),</span>
            <span class="s1">&#39;total_size_gb&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">size_mb</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backups</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">recent_backups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_backups</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
            
            <span class="n">job_report</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">schedule</span><span class="p">,</span>
                <span class="s1">&#39;last_run&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">last_run</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">last_run</span> <span class="k">else</span> <span class="s1">&#39;Never&#39;</span><span class="p">,</span>
                <span class="s1">&#39;last_status&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">last_status</span><span class="p">,</span>
                <span class="s1">&#39;backups_last_7d&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_backups</span><span class="p">),</span>
                <span class="s1">&#39;retention_days&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">retention_days</span>
            <span class="p">}</span>
            
            <span class="n">report</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_report</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">report</span>

<span class="c1"># Create backup manager and jobs</span>
<span class="n">backups</span> <span class="o">=</span> <span class="n">BackupManager</span><span class="p">()</span>

<span class="c1"># Add backup jobs</span>
<span class="n">backups</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">BackupJob</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;trade_database&#39;</span><span class="p">,</span>
    <span class="n">source</span><span class="o">=</span><span class="s1">&#39;postgresql://localhost:5432/trading&#39;</span><span class="p">,</span>
    <span class="n">destination</span><span class="o">=</span><span class="s1">&#39;s3://backups/database&#39;</span><span class="p">,</span>
    <span class="n">schedule</span><span class="o">=</span><span class="s1">&#39;0 */4 * * *&#39;</span><span class="p">,</span>  <span class="c1"># Every 4 hours</span>
    <span class="n">retention_days</span><span class="o">=</span><span class="mi">90</span>
<span class="p">))</span>

<span class="n">backups</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">BackupJob</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;configuration&#39;</span><span class="p">,</span>
    <span class="n">source</span><span class="o">=</span><span class="s1">&#39;/etc/trading/&#39;</span><span class="p">,</span>
    <span class="n">destination</span><span class="o">=</span><span class="s1">&#39;s3://backups/config&#39;</span><span class="p">,</span>
    <span class="n">schedule</span><span class="o">=</span><span class="s1">&#39;On change&#39;</span><span class="p">,</span>
    <span class="n">retention_days</span><span class="o">=</span><span class="mi">365</span>
<span class="p">))</span>

<span class="c1"># Simulate some backups</span>
<span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="n">backups</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">backups</span><span class="o">.</span><span class="n">simulate_backup</span><span class="p">(</span><span class="n">job_name</span><span class="p">)</span>

<span class="c1"># Display report</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">backups</span><span class="o">.</span><span class="n">get_backup_report</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backup Status Report&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Backups: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;total_backups&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Size: </span><span class="si">{</span><span class="n">report</span><span class="p">[</span><span class="s1">&#39;total_size_gb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]:</span>
    <span class="n">status_icon</span> <span class="o">=</span> <span class="s2">&quot;‚úì&quot;</span> <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;last_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span> <span class="k">else</span> <span class="s2">&quot;‚úó&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status_icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Schedule: </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;schedule&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Last Run: </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Retention: </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;retention_days&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 18.4: Complete Monitoring System (Open-ended)</h3>
<p>Build a comprehensive monitoring system that tracks system health, collects metrics, and generates status reports.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 18.4: Complete Monitoring System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class that:</span>
<span class="c1"># - Collects and stores multiple types of metrics (gauges, counters, histograms)</span>
<span class="c1"># - Runs health checks on configurable components</span>
<span class="c1"># - Calculates statistics over configurable time windows</span>
<span class="c1"># - Generates formatted status reports</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MonitoringSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive system monitoring with metrics, health checks, and reporting.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">retention_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retention_hours</span> <span class="o">=</span> <span class="n">retention_hours</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_checks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">record_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">metric_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;gauge&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record a metric value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">metric_type</span>
        <span class="p">})</span>

        <span class="c1"># Cleanup old entries</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retention_hours</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_metric_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get statistics for a metric.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">register_health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">check_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a health check function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_checks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_func</span>

    <span class="k">def</span> <span class="nf">run_health_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run all health checks.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">check_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_checks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">check_func</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">health_results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;healthy&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">health_results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_results</span>

    <span class="k">def</span> <span class="nf">is_healthy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if system is healthy.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_health_checks</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate status report.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_health_checks</span><span class="p">()</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;MONITORING REPORT: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Time: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Overall Health: </span><span class="si">{</span><span class="s1">&#39;HEALTHY&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_healthy</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;UNHEALTHY&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HEALTH CHECKS:&quot;</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;‚úì&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;‚úó&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">METRICS:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metric_stats</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: current=</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, mean=</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">monitor</span> <span class="o">=</span> <span class="n">MonitoringSystem</span><span class="p">(</span><span class="s2">&quot;Trading System&quot;</span><span class="p">)</span>

<span class="c1"># Add health checks</span>
<span class="n">monitor</span><span class="o">.</span><span class="n">register_health_check</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Connected&#39;</span><span class="p">})</span>
<span class="n">monitor</span><span class="o">.</span><span class="n">register_health_check</span><span class="p">(</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Responding&#39;</span><span class="p">})</span>

<span class="c1"># Record metrics</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">record_metric</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">70</span><span class="p">))</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">record_metric</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>

<span class="c1"># Generate report</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monitor</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 18.5: Incident Management System (Open-ended)</h3>
<p>Create a comprehensive incident management system with runbooks and post-mortem generation.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 18.5: Incident Management System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class that:</span>
<span class="c1"># - Creates and tracks incidents through their lifecycle</span>
<span class="c1"># - Stores and matches runbooks to symptoms</span>
<span class="c1"># - Maintains incident timeline with updates</span>
<span class="c1"># - Generates post-mortem reports</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">IncidentManagementSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive incident management with runbooks and reporting.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runbooks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">add_runbook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">symptoms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                   <span class="n">escalation</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a runbook to the library.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runbooks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;symptoms&#39;</span><span class="p">:</span> <span class="n">symptoms</span><span class="p">,</span>
            <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="n">steps</span><span class="p">,</span>
            <span class="s1">&#39;escalation&#39;</span><span class="p">:</span> <span class="n">escalation</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">find_runbook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symptoms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find matching runbook for symptoms.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">runbook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runbooks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">symptom</span> <span class="ow">in</span> <span class="n">symptoms</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">symptom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">rb_symptom</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
                       <span class="k">for</span> <span class="n">rb_symptom</span> <span class="ow">in</span> <span class="n">runbook</span><span class="p">[</span><span class="s1">&#39;symptoms&#39;</span><span class="p">]):</span>
                    <span class="k">return</span> <span class="n">name</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">create_incident</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">severity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">affected_systems</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a new incident.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">incident_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;INC-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_counter</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">[</span><span class="n">incident_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s1">&#39;severity&#39;</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span>
            <span class="s1">&#39;affected_systems&#39;</span><span class="p">:</span> <span class="n">affected_systems</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;resolved_at&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;timeline&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;Incident created&#39;</span><span class="p">,</span>
                <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">description</span>
            <span class="p">}],</span>
            <span class="s1">&#39;root_cause&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">incident_id</span>

    <span class="k">def</span> <span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incident_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update incident status.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">incident_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incident </span><span class="si">{</span><span class="n">incident_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="n">incident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">[</span><span class="n">incident_id</span><span class="p">]</span>
        <span class="n">old_status</span> <span class="o">=</span> <span class="n">incident</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
        <span class="n">incident</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>

        <span class="n">incident</span><span class="p">[</span><span class="s1">&#39;timeline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Status: </span><span class="si">{</span><span class="n">old_status</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">notes</span>
        <span class="p">})</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;resolved&#39;</span><span class="p">:</span>
            <span class="n">incident</span><span class="p">[</span><span class="s1">&#39;resolved_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incident_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add timeline note to incident.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">incident_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incident </span><span class="si">{</span><span class="n">incident_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">[</span><span class="n">incident_id</span><span class="p">][</span><span class="s1">&#39;timeline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">details</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">generate_postmortem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incident_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate post-mortem report.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">incident_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incident </span><span class="si">{</span><span class="n">incident_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="n">inc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span><span class="p">[</span><span class="n">incident_id</span><span class="p">]</span>

        <span class="n">duration</span> <span class="o">=</span> <span class="s2">&quot;Ongoing&quot;</span>
        <span class="k">if</span> <span class="n">inc</span><span class="p">[</span><span class="s1">&#39;resolved_at&#39;</span><span class="p">]:</span>
            <span class="n">mins</span> <span class="o">=</span> <span class="p">(</span><span class="n">inc</span><span class="p">[</span><span class="s1">&#39;resolved_at&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">inc</span><span class="p">[</span><span class="s1">&#39;created_at&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mins</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> minutes&quot;</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;POST-MORTEM: </span><span class="si">{</span><span class="n">incident_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Title: </span><span class="si">{</span><span class="n">inc</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Severity: </span><span class="si">{</span><span class="n">inc</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Duration: </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">inc</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TIMELINE:&quot;</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">inc</span><span class="p">[</span><span class="s1">&#39;timeline&#39;</span><span class="p">]:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;details&#39;</span><span class="p">):</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; </span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;ROOT CAUSE: </span><span class="si">{</span><span class="n">inc</span><span class="p">[</span><span class="s1">&#39;root_cause&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;TBD&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;RESOLUTION: </span><span class="si">{</span><span class="n">inc</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;TBD&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">ims</span> <span class="o">=</span> <span class="n">IncidentManagementSystem</span><span class="p">()</span>

<span class="c1"># Add runbook</span>
<span class="n">ims</span><span class="o">.</span><span class="n">add_runbook</span><span class="p">(</span>
    <span class="s1">&#39;database_issues&#39;</span><span class="p">,</span>
    <span class="n">symptoms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">],</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Check server status&#39;</span><span class="p">,</span> <span class="s1">&#39;Verify connectivity&#39;</span><span class="p">,</span> <span class="s1">&#39;Restart if needed&#39;</span><span class="p">],</span>
    <span class="n">escalation</span><span class="o">=</span><span class="s1">&#39;Page DBA&#39;</span>
<span class="p">)</span>

<span class="c1"># Create and manage incident</span>
<span class="n">inc_id</span> <span class="o">=</span> <span class="n">ims</span><span class="o">.</span><span class="n">create_incident</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Database Connection Issues&#39;</span><span class="p">,</span>
    <span class="n">severity</span><span class="o">=</span><span class="s1">&#39;SEV2&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Multiple connection timeouts&#39;</span><span class="p">,</span>
    <span class="n">affected_systems</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;api&#39;</span><span class="p">,</span> <span class="s1">&#39;orders&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">ims</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">inc_id</span><span class="p">,</span> <span class="s1">&#39;investigating&#39;</span><span class="p">,</span> <span class="s1">&#39;Engineer assigned&#39;</span><span class="p">)</span>
<span class="n">ims</span><span class="o">.</span><span class="n">add_note</span><span class="p">(</span><span class="n">inc_id</span><span class="p">,</span> <span class="s1">&#39;Root cause identified&#39;</span><span class="p">,</span> <span class="s1">&#39;Connection pool exhausted&#39;</span><span class="p">)</span>
<span class="n">ims</span><span class="o">.</span><span class="n">incidents</span><span class="p">[</span><span class="n">inc_id</span><span class="p">][</span><span class="s1">&#39;root_cause&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Connection pool exhaustion&#39;</span>
<span class="n">ims</span><span class="o">.</span><span class="n">incidents</span><span class="p">[</span><span class="n">inc_id</span><span class="p">][</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Restarted services&#39;</span>
<span class="n">ims</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">inc_id</span><span class="p">,</span> <span class="s1">&#39;resolved&#39;</span><span class="p">,</span> <span class="s1">&#39;Services restored&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ims</span><span class="o">.</span><span class="n">generate_postmortem</span><span class="p">(</span><span class="n">inc_id</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><hr />
<h3>Exercise 18.6: Operations Dashboard (Open-ended)</h3>
<p>Build a unified operations dashboard that combines monitoring, alerts, incidents, and backups into a single view.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 18.6: Operations Dashboard (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class that:</span>
<span class="c1"># - Aggregates data from metrics, health checks, alerts, and backups</span>
<span class="c1"># - Determines overall system status (healthy/warning/critical)</span>
<span class="c1"># - Generates a comprehensive text-based dashboard</span>
<span class="c1"># - Tracks key business metrics alongside infrastructure metrics</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">OperationsDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unified operations dashboard combining all monitoring components.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">MetricsCollector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">HealthChecker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backups</span> <span class="o">=</span> <span class="n">BackupManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_incidents</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">collect_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collect system metrics.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">check_rules</span><span class="p">(</span><span class="n">metrics_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">check_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a health check.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">check_func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_backup_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">BackupJob</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a backup job.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backups</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_overall_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine overall system status.&quot;&quot;&quot;</span>
        <span class="c1"># Check for critical alerts</span>
        <span class="n">alert_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">get_alert_summary</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">alert_summary</span><span class="p">[</span><span class="s1">&#39;critical_count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;critical&#39;</span>

        <span class="c1"># Check health</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">is_healthy</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;warning&#39;</span>

        <span class="c1"># Check for warnings</span>
        <span class="k">if</span> <span class="n">alert_summary</span><span class="p">[</span><span class="s1">&#39;warning_count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;warning&#39;</span>

        <span class="k">return</span> <span class="s1">&#39;healthy&#39;</span>

    <span class="k">def</span> <span class="nf">generate_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive dashboard display.&quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_overall_status</span><span class="p">()</span>
        <span class="n">status_emoji</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="s1">&#39;üü¢&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="s1">&#39;üü°&#39;</span><span class="p">,</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="s1">&#39;üî¥&#39;</span><span class="p">}</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;OPERATIONS DASHBOARD: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Time: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;OVERALL STATUS: </span><span class="si">{</span><span class="n">status_emoji</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s1">&#39;‚ö™&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span>
        <span class="p">]</span>

        <span class="c1"># Health checks</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;HEALTH CHECKS&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">health_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">health_status</span><span class="p">[</span><span class="s1">&#39;healthy_checks&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">health_status</span><span class="p">[</span><span class="s1">&#39;total_checks&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> healthy&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">health_status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;‚úì&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;‚úó&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Alerts</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ALERTS&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">alert_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">get_alert_summary</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active: </span><span class="si">{</span><span class="n">alert_summary</span><span class="p">[</span><span class="s1">&#39;active_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Critical: </span><span class="si">{</span><span class="n">alert_summary</span><span class="p">[</span><span class="s1">&#39;critical_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Warning: </span><span class="si">{</span><span class="n">alert_summary</span><span class="p">[</span><span class="s1">&#39;warning_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">alert_summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_alerts&#39;</span><span class="p">,</span> <span class="p">[])[:</span><span class="mi">5</span><span class="p">]:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;severity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Key metrics</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;KEY METRICS&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="s1">&#39;latency&#39;</span><span class="p">]:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">: mean=</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, p95=</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;p95&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Backups</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;BACKUPS&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">backup_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backups</span><span class="o">.</span><span class="n">get_backup_report</span><span class="p">()</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total: </span><span class="si">{</span><span class="n">backup_report</span><span class="p">[</span><span class="s1">&#39;total_backups&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> backups&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">backup_report</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]:</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;‚úì&quot;</span> <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;last_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span> <span class="k">else</span> <span class="s2">&quot;‚úó&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;last_status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">OperationsDashboard</span><span class="p">(</span><span class="s2">&quot;Quant Trading System&quot;</span><span class="p">)</span>

<span class="c1"># Setup health checks</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">add_health_check</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Connected&#39;</span><span class="p">})</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">add_health_check</span><span class="p">(</span><span class="s1">&#39;broker&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;API responding&#39;</span><span class="p">})</span>

<span class="c1"># Setup alert rules</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
    <span class="s1">&#39;high_cpu&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">AlertSeverity</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="s1">&#39;CPU at </span><span class="si">{cpu}</span><span class="s1">%&#39;</span>
<span class="p">)</span>

<span class="c1"># Add backup job</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">add_backup_job</span><span class="p">(</span><span class="n">BackupJob</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;database&#39;</span><span class="p">,</span>
    <span class="n">source</span><span class="o">=</span><span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
    <span class="n">destination</span><span class="o">=</span><span class="s1">&#39;s3://backups&#39;</span><span class="p">,</span>
    <span class="n">schedule</span><span class="o">=</span><span class="s1">&#39;0 */4 * * *&#39;</span><span class="p">,</span>
    <span class="n">retention_days</span><span class="o">=</span><span class="mi">90</span>
<span class="p">))</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">backups</span><span class="o">.</span><span class="n">simulate_backup</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">)</span>

<span class="c1"># Collect metrics</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">dashboard</span><span class="o">.</span><span class="n">collect_metrics</span><span class="p">({</span>
        <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span>
        <span class="s1">&#39;memory&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span>
        <span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="mi">30</span>
    <span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">dashboard</span><span class="o">.</span><span class="n">generate_dashboard</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h2>Module Project: Complete Operations System</h2>
<p>Build a comprehensive operations system that brings together all monitoring, alerting, and incident management components.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TradingOperationsSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete operations system for trading infrastructure.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Real-time metrics collection</span>
<span class="sd">    - Health monitoring</span>
<span class="sd">    - Alert management</span>
<span class="sd">    - Incident tracking</span>
<span class="sd">    - Backup management</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Trading Operations&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">MetricsCollector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">HealthChecker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="n">AlertManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incidents</span> <span class="o">=</span> <span class="n">IncidentManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backups</span> <span class="o">=</span> <span class="n">BackupManager</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_defaults</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_setup_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup default monitoring configuration.&quot;&quot;&quot;</span>
        <span class="c1"># Default health checks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Connected&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="s1">&#39;broker_api&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Responding&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">register_check</span><span class="p">(</span><span class="s1">&#39;market_data&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Streaming&#39;</span><span class="p">})</span>
        
        <span class="c1"># Default alert rules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
            <span class="s1">&#39;high_cpu&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">,</span>
            <span class="n">AlertSeverity</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="s1">&#39;CPU at </span><span class="si">{cpu:.1f}</span><span class="s1">%&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
            <span class="s1">&#39;high_latency&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;latency&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">,</span>
            <span class="n">AlertSeverity</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="s1">&#39;Latency at </span><span class="si">{latency:.0f}</span><span class="s1">ms&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
            <span class="s1">&#39;large_drawdown&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drawdown&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.10</span><span class="p">,</span>
            <span class="n">AlertSeverity</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span> <span class="s1">&#39;Drawdown at </span><span class="si">{drawdown:.1%}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        
        <span class="c1"># Default backup jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backups</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">BackupJob</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;trade_database&#39;</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="s1">&#39;postgresql://localhost/trading&#39;</span><span class="p">,</span>
            <span class="n">destination</span><span class="o">=</span><span class="s1">&#39;s3://backups/db&#39;</span><span class="p">,</span>
            <span class="n">schedule</span><span class="o">=</span><span class="s1">&#39;0 */4 * * *&#39;</span><span class="p">,</span>
            <span class="n">retention_days</span><span class="o">=</span><span class="mi">90</span>
        <span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">collect_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collect system metrics and check alerts.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">check_rules</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_system_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get comprehensive system status.&quot;&quot;&quot;</span>
        <span class="n">health_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
        <span class="n">alert_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">get_alert_summary</span><span class="p">()</span>
        
        <span class="c1"># Determine overall status</span>
        <span class="k">if</span> <span class="n">alert_summary</span><span class="p">[</span><span class="s1">&#39;critical_count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;critical&#39;</span>
        <span class="k">elif</span> <span class="n">alert_summary</span><span class="p">[</span><span class="s1">&#39;warning_count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">health_status</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;healthy&#39;</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;warning&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;healthy&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;overall_status&#39;</span><span class="p">:</span> <span class="n">overall</span><span class="p">,</span>
            <span class="s1">&#39;health&#39;</span><span class="p">:</span> <span class="n">health_status</span><span class="p">,</span>
            <span class="s1">&#39;alerts&#39;</span><span class="p">:</span> <span class="n">alert_summary</span><span class="p">,</span>
            <span class="s1">&#39;backup_status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">backups</span><span class="o">.</span><span class="n">get_backup_report</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate text-based dashboard.&quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_system_status</span><span class="p">()</span>
        <span class="n">emoji</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;healthy&#39;</span><span class="p">:</span> <span class="s1">&#39;üü¢&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="s1">&#39;üü°&#39;</span><span class="p">,</span> <span class="s1">&#39;critical&#39;</span><span class="p">:</span> <span class="s1">&#39;üî¥&#39;</span><span class="p">}</span>
        
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;OPERATIONS DASHBOARD: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Time: </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;OVERALL: </span><span class="si">{</span><span class="n">emoji</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;overall_status&#39;</span><span class="p">],</span> <span class="s1">&#39;‚ö™&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HEALTH CHECKS:&quot;</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;health&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;‚úì&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;healthy&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;‚úó&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ALERTS:&quot;</span><span class="p">)</span>
        <span class="n">alerts</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;alerts&#39;</span><span class="p">]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Active: </span><span class="si">{</span><span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;active_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Critical: </span><span class="si">{</span><span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;critical_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Warning: </span><span class="si">{</span><span class="n">alerts</span><span class="p">[</span><span class="s1">&#39;warning_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">BACKUPS:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;backup_status&#39;</span><span class="p">][</span><span class="s1">&#39;jobs&#39;</span><span class="p">]:</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;‚úì&quot;</span> <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;last_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span> <span class="k">else</span> <span class="s2">&quot;‚úó&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;last_status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="c1"># Create and test system</span>
<span class="n">ops</span> <span class="o">=</span> <span class="n">TradingOperationsSystem</span><span class="p">(</span><span class="s2">&quot;Quant Trading Platform&quot;</span><span class="p">)</span>

<span class="c1"># Simulate operations</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">ops</span><span class="o">.</span><span class="n">collect_metrics</span><span class="p">({</span>
        <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span>
        <span class="s1">&#39;memory&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span>
        <span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="mi">30</span><span class="p">,</span>
        <span class="s1">&#39;drawdown&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="p">})</span>

<span class="c1"># Run backup</span>
<span class="n">ops</span><span class="o">.</span><span class="n">backups</span><span class="o">.</span><span class="n">simulate_backup</span><span class="p">(</span><span class="s1">&#39;trade_database&#39;</span><span class="p">)</span>

<span class="c1"># Display dashboard</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">generate_dashboard</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h2>Key Takeaways</h2>
<h3>System Monitoring</h3>
<ul>
<li>Monitor the Four Golden Signals: latency, traffic, errors, saturation</li>
<li>Health checks should be fast and deterministic</li>
<li>Track both infrastructure and business metrics</li>
</ul>
<h3>Alerting</h3>
<ul>
<li>Every alert should be actionable</li>
<li>Use appropriate severity levels</li>
<li>Implement cooldowns to prevent alert storms</li>
<li>Route critical alerts to on-call systems</li>
</ul>
<h3>Incident Response</h3>
<ul>
<li>Have runbooks for common issues</li>
<li>Document everything in the incident timeline</li>
<li>Conduct post-mortems to prevent recurrence</li>
<li>Focus on "how to prevent" not "who to blame"</li>
</ul>
<h3>Backup &amp; Recovery</h3>
<ul>
<li>Define RPO (Recovery Point Objective) and RTO (Recovery Time Objective)</li>
<li>Test restores regularly</li>
<li>Encrypt backups at rest and in transit</li>
<li>Automate backup verification</li>
</ul>
<h3>Best Practices</h3>
<ol>
<li>Design for failure - everything will break eventually</li>
<li>Automate repetitive operational tasks</li>
<li>Keep runbooks up to date</li>
<li>Practice incident response with game days</li>
<li>Monitor your monitoring (meta-monitoring)</li>
</ol>
<hr />
<p><strong>Congratulations on completing all modules! Now proceed to the Capstone Project to bring everything together.</strong></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="19"><div class="md-cell module-header"><h1>Capstone Project: Complete Quantitative Trading System</h1>
<h2>Course 3: Quantitative Finance &amp; Portfolio Theory</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~4-5 hours</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6 (3 guided + 3 open-ended)</td>
</tr>
</tbody>
</table></div>
<h3>Project Overview</h3>
<p>You will build a <strong>complete quantitative trading system</strong> that integrates:</p>
<ol>
<li><strong>Data Pipeline</strong> - Market data collection and storage</li>
<li><strong>Strategy Engine</strong> - Multi-strategy portfolio management</li>
<li><strong>Risk Management</strong> - Real-time risk monitoring and limits</li>
<li><strong>Execution</strong> - Order management with cost awareness</li>
<li><strong>Dashboard &amp; Reporting</strong> - Performance visualization and reports</li>
</ol>
<h3>Learning Integration</h3>
<p>This project draws from every module in the course:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Component</th>
<th>Modules Used</th>
</tr>
</thead>
<tbody>
<tr>
<td>Portfolio Optimization</td>
<td>4, 5, 6</td>
</tr>
<tr>
<td>Risk Management</td>
<td>7, 8, 9</td>
</tr>
<tr>
<td>Simulation &amp; Analysis</td>
<td>10, 11</td>
</tr>
<tr>
<td>Dashboard &amp; Reporting</td>
<td>12, 13</td>
</tr>
<tr>
<td>Execution</td>
<td>14, 15</td>
</tr>
<tr>
<td>Infrastructure</td>
<td>16, 17, 18</td>
</tr>
</tbody>
</table></div>
<hr /></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Environment setup</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Display settings</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Capstone Project: Complete Quantitative Trading System&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Part 1: Data Pipeline</h2>
<p>Build a data pipeline that:
- Fetches market data from multiple sources
- Calculates derived metrics (returns, volatility, etc.)
- Stores data efficiently</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">DataPipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Market data pipeline for the trading system.</span>
<span class="sd">    </span>
<span class="sd">    Responsibilities:</span>
<span class="sd">    - Fetch historical and live market data</span>
<span class="sd">    - Calculate returns and risk metrics</span>
<span class="sd">    - Provide data to other system components</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">fetch_historical_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch historical price data.&quot;&quot;&quot;</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching data for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span><span class="si">}</span><span class="s2"> symbols...&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># Handle MultiIndex columns</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;Adj Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">data</span>
        
        <span class="c1"># Ensure proper column order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">]</span>
        
        <span class="c1"># Calculate returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span><span class="si">}</span><span class="s2"> days of data&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate key metrics for all assets.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data loaded. Call fetch_historical_data first.&quot;</span><span class="p">)</span>
        
        <span class="n">recent_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">lookback_days</span><span class="p">)</span>
        
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">recent_returns</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;annual_return&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">,</span>
                <span class="s1">&#39;annual_volatility&#39;</span><span class="p">:</span> <span class="n">ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">),</span>
                <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)),</span>
                <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_max_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">lookback_days</span><span class="p">)),</span>
                <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">metrics</span>
    
    <span class="k">def</span> <span class="nf">_calculate_max_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate maximum drawdown.&quot;&quot;&quot;</span>
        <span class="n">cummax</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span> <span class="o">-</span> <span class="n">cummax</span><span class="p">)</span> <span class="o">/</span> <span class="n">cummax</span>
        <span class="k">return</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get correlation matrix.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">lookback_days</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">,</span> <span class="n">annualize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get covariance matrix.&quot;&quot;&quot;</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">lookback_days</span><span class="p">)</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">annualize</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="k">return</span> <span class="n">cov</span>
    
    <span class="k">def</span> <span class="nf">get_latest_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get most recent prices.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Initialize data pipeline</span>
<span class="n">UNIVERSE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="s1">&#39;IWM&#39;</span><span class="p">,</span> <span class="s1">&#39;EFA&#39;</span><span class="p">,</span> <span class="s1">&#39;EEM&#39;</span><span class="p">,</span> <span class="s1">&#39;TLT&#39;</span><span class="p">,</span> <span class="s1">&#39;GLD&#39;</span><span class="p">,</span> <span class="s1">&#39;VNQ&#39;</span><span class="p">]</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">DataPipeline</span><span class="p">(</span><span class="n">UNIVERSE</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">fetch_historical_data</span><span class="p">(</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">)</span>

<span class="c1"># Display metrics</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Asset Metrics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">metrics_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="nb">print</span><span class="p">(</span><span class="n">metrics_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h3>Exercise C.1: Data Quality Validator (Guided)</h3>
<p>Add data quality validation to the data pipeline to check for missing values and outliers.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise C.1: Data Quality Validator (Guided)</span>

<span class="k">def</span> <span class="nf">validate_data_quality</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate data quality and identify issues.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        prices: Price DataFrame</span>
<span class="sd">        returns: Returns DataFrame</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Validation results with quality metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
    
    <span class="c1"># Check for missing values in prices</span>
    <span class="c1"># TODO: Count missing values per column</span>
    <span class="n">missing_counts</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">______</span><span class="p">()</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;missing_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_counts</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    
    <span class="c1"># TODO: Check if any column has missing values</span>
    <span class="k">if</span> <span class="n">missing_counts</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Missing values detected&#39;</span><span class="p">)</span>
    
    <span class="c1"># Check for outliers in returns (&gt;5 standard deviations)</span>
    <span class="n">outlier_threshold</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">outlier_counts</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># TODO: Calculate mean and standard deviation</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        
        <span class="c1"># TODO: Count outliers beyond threshold</span>
        <span class="n">outliers</span> <span class="o">=</span> <span class="p">((</span><span class="n">returns</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">outlier_threshold</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">outlier_counts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span>
    
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;outlier_counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlier_counts</span>
    
    <span class="c1"># TODO: Check if total outliers exceed threshold</span>
    <span class="n">total_outliers</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">outlier_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">total_outliers</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># More than 1% outliers</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;High outlier count: </span><span class="si">{</span><span class="n">total_outliers</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># Check data coverage</span>
    <span class="c1"># TODO: Calculate trading days</span>
    <span class="n">trading_days</span> <span class="o">=</span> <span class="n">______</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;trading_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trading_days</span>
    
    <span class="c1"># Set overall validity</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
    
    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Test</span>
<span class="n">validation</span> <span class="o">=</span> <span class="n">validate_data_quality</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data Valid: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trading Days: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;trading_days&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issues: </span><span class="si">{</span><span class="n">validation</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">validate_data_quality</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate data quality and identify issues.</span>

<span class="sd">    Args:</span>
<span class="sd">        prices: Price DataFrame</span>
<span class="sd">        returns: Returns DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        Validation results with quality metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="n">missing_counts</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;missing_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_counts</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">missing_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Missing values detected&#39;</span><span class="p">)</span>

    <span class="n">outlier_threshold</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">outlier_counts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="n">outliers</span> <span class="o">=</span> <span class="p">((</span><span class="n">returns</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">outlier_threshold</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">outlier_counts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">outliers</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;outlier_counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlier_counts</span>

    <span class="n">total_outliers</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">outlier_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">total_outliers</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;High outlier count: </span><span class="si">{</span><span class="n">total_outliers</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">trading_days</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="s1">&#39;trading_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trading_days</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;issues&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Part 2: Strategy Engine</h2>
<p>Build a multi-strategy engine that:
- Implements multiple portfolio optimization strategies
- Manages strategy weights and allocation
- Generates trading signals</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">Strategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for trading strategies.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    
    <span class="k">def</span> <span class="nf">calculate_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataPipeline</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate target weights. Override in subclass.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<span class="k">class</span> <span class="nc">MeanVarianceStrategy</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mean-Variance Optimization Strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_return</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.10</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;Mean-Variance&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_return</span> <span class="o">=</span> <span class="n">target_return</span>
    
    <span class="k">def</span> <span class="nf">calculate_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataPipeline</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">returns</span>
        <span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">252</span>
        
        <span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">w</span> <span class="o">@</span> <span class="n">cov</span> <span class="o">@</span> <span class="n">w</span>
        
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ineq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">w</span> <span class="o">@</span> <span class="n">mu</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_return</span><span class="p">}</span>
        <span class="p">]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)]</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)</span><span class="o">/</span><span class="n">n_assets</span><span class="p">,</span>
                         <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">RiskParityStrategy</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Risk Parity Strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;Risk Parity&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataPipeline</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">returns</span>
        <span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
        
        <span class="n">cov</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">target_risk</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">n_assets</span>
        
        <span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="n">port_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w</span> <span class="o">@</span> <span class="n">cov</span> <span class="o">@</span> <span class="n">w</span><span class="p">)</span>
            <span class="n">marginal_contrib</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">@</span> <span class="n">w</span>
            <span class="n">risk_contrib</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">marginal_contrib</span> <span class="o">/</span> <span class="n">port_vol</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">risk_contrib</span> <span class="o">-</span> <span class="n">target_risk</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)]</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)</span><span class="o">/</span><span class="n">n_assets</span><span class="p">,</span>
                         <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MinimumVolatilityStrategy</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Minimum Volatility Strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;Minimum Volatility&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataPipeline</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">returns</span>
        <span class="n">n_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
        
        <span class="n">cov</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">252</span>
        
        <span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w</span> <span class="o">@</span> <span class="n">cov</span> <span class="o">@</span> <span class="n">w</span><span class="p">)</span>
        
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)]</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_assets</span><span class="p">)</span><span class="o">/</span><span class="n">n_assets</span><span class="p">,</span>
                         <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">StrategyEngine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multi-strategy portfolio engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_pipeline</span><span class="p">:</span> <span class="n">DataPipeline</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Strategy</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy_allocations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combined_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">,</span> <span class="n">allocation</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a strategy with given allocation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="p">[</span><span class="n">strategy</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy_allocations</span><span class="p">[</span><span class="n">strategy</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">allocation</span>
    
    <span class="k">def</span> <span class="nf">calculate_all_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate weights for all strategies.&quot;&quot;&quot;</span>
        <span class="n">all_weights</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">calculate_weights</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">all_weights</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calculating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> weights: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
                <span class="n">all_weights</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="n">all_weights</span>
    
    <span class="k">def</span> <span class="nf">combine_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Combine strategy weights based on allocations.&quot;&quot;&quot;</span>
        <span class="n">all_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_all_weights</span><span class="p">()</span>
        
        <span class="n">combined</span> <span class="o">=</span> <span class="p">{</span><span class="n">symbol</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">}</span>
        
        <span class="k">for</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">strategy_weights</span> <span class="ow">in</span> <span class="n">all_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">allocation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy_allocations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">strategy_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">strategy_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">combined</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">allocation</span>
        
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">combined</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">w</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">combined</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">combined_weights</span> <span class="o">=</span> <span class="n">combined</span>
        <span class="k">return</span> <span class="n">combined</span>
    
    <span class="k">def</span> <span class="nf">get_strategy_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get comparison of all strategy weights.&quot;&quot;&quot;</span>
        <span class="n">all_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_all_weights</span><span class="p">()</span>
        <span class="n">all_weights</span><span class="p">[</span><span class="s1">&#39;Combined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_weights</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_weights</span><span class="p">)</span>

<span class="c1"># Create strategy engine</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">StrategyEngine</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

<span class="c1"># Add strategies with allocations</span>
<span class="n">engine</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">MeanVarianceStrategy</span><span class="p">(</span><span class="n">target_return</span><span class="o">=</span><span class="mf">0.08</span><span class="p">),</span> <span class="mf">0.40</span><span class="p">)</span>
<span class="n">engine</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">RiskParityStrategy</span><span class="p">(),</span> <span class="mf">0.35</span><span class="p">)</span>
<span class="n">engine</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">MinimumVolatilityStrategy</span><span class="p">(),</span> <span class="mf">0.25</span><span class="p">)</span>

<span class="c1"># Calculate and display weights</span>
<span class="n">comparison</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_strategy_comparison</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Strategy Weight Comparison:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h3>Exercise C.2: Strategy Performance Tracker (Guided)</h3>
<p>Build a function that tracks and compares historical performance of each strategy.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise C.2: Strategy Performance Tracker (Guided)</span>

<span class="k">def</span> <span class="nf">calculate_strategy_performance</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                                   <span class="n">strategy_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate historical performance for each strategy.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Asset returns DataFrame</span>
<span class="sd">        strategy_weights: Dict of {strategy_name: {symbol: weight}}</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Performance metrics for each strategy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">strategy_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># TODO: Convert weights to array in same order as returns columns</span>
        <span class="n">weight_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">______</span><span class="p">])</span>
        
        <span class="c1"># TODO: Calculate portfolio returns</span>
        <span class="n">port_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="n">______</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># TODO: Calculate cumulative returns</span>
        <span class="n">cumulative</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">port_returns</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        
        <span class="c1"># Calculate drawdown</span>
        <span class="n">running_max</span> <span class="o">=</span> <span class="n">cumulative</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cumulative</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
        
        <span class="c1"># TODO: Calculate annual return</span>
        <span class="n">annual_return</span> <span class="o">=</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="c1"># TODO: Calculate annual volatility</span>
        <span class="n">annual_vol</span> <span class="o">=</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">______</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
        
        <span class="n">performance</span><span class="p">[</span><span class="n">strategy_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># TODO: Calculate total return</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">cumulative</span><span class="o">.</span><span class="n">______</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;annual_return&#39;</span><span class="p">:</span> <span class="n">annual_return</span><span class="p">,</span>
            <span class="s1">&#39;annual_volatility&#39;</span><span class="p">:</span> <span class="n">annual_vol</span><span class="p">,</span>
            <span class="c1"># TODO: Calculate Sharpe ratio</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">annual_return</span> <span class="o">/</span> <span class="n">______</span> <span class="k">if</span> <span class="n">annual_vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">performance</span>

<span class="c1"># Test</span>
<span class="n">strategy_weights</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">calculate_all_weights</span><span class="p">()</span>
<span class="n">perf</span> <span class="o">=</span> <span class="n">calculate_strategy_performance</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">returns</span><span class="p">,</span> <span class="n">strategy_weights</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Strategy Performance:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metrics</span> <span class="ow">in</span> <span class="n">perf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Drawdown: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_strategy_performance</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                                   <span class="n">strategy_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate historical performance for each strategy.</span>

<span class="sd">    Args:</span>
<span class="sd">        returns: Asset returns DataFrame</span>
<span class="sd">        strategy_weights: Dict of {strategy_name: {symbol: weight}}</span>

<span class="sd">    Returns:</span>
<span class="sd">        Performance metrics for each strategy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">performance</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">strategy_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">weight_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>

        <span class="n">port_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="n">weight_array</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">cumulative</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">port_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

        <span class="n">running_max</span> <span class="o">=</span> <span class="n">cumulative</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cumulative</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>

        <span class="n">annual_return</span> <span class="o">=</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        <span class="n">annual_vol</span> <span class="o">=</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

        <span class="n">performance</span><span class="p">[</span><span class="n">strategy_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="n">cumulative</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;annual_return&#39;</span><span class="p">:</span> <span class="n">annual_return</span><span class="p">,</span>
            <span class="s1">&#39;annual_volatility&#39;</span><span class="p">:</span> <span class="n">annual_vol</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">annual_return</span> <span class="o">/</span> <span class="n">annual_vol</span> <span class="k">if</span> <span class="n">annual_vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">performance</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Part 3: Risk Management</h2>
<p>Build a risk management system that:
- Monitors portfolio risk in real-time
- Enforces risk limits
- Calculates VaR and other risk metrics</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RiskLimits</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Risk limit configuration.&quot;&quot;&quot;</span>
    <span class="n">max_position_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span>
    <span class="n">max_sector_exposure</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.40</span>
    <span class="n">max_portfolio_var</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="n">max_drawdown</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.15</span>
    <span class="n">min_cash</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="k">class</span> <span class="nc">RiskManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Portfolio risk management system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_pipeline</span><span class="p">:</span> <span class="n">DataPipeline</span><span class="p">,</span> <span class="n">limits</span><span class="p">:</span> <span class="n">RiskLimits</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="n">limits</span> <span class="ow">or</span> <span class="n">RiskLimits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">calculate_portfolio_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> 
                                <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
                                <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;historical&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate portfolio Value at Risk.&quot;&quot;&quot;</span>
        <span class="n">weight_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">])</span>
        <span class="n">port_returns</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">returns</span> <span class="o">*</span> <span class="n">weight_array</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;historical&#39;</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">port_returns</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;parametric&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="n">var</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">var</span>
    
    <span class="k">def</span> <span class="nf">calculate_portfolio_cvar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                                  <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Conditional Value at Risk.&quot;&quot;&quot;</span>
        <span class="n">weight_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">])</span>
        <span class="n">port_returns</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">returns</span> <span class="o">*</span> <span class="n">weight_array</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_portfolio_var</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">confidence</span><span class="p">)</span>
        <span class="n">cvar</span> <span class="o">=</span> <span class="o">-</span><span class="n">port_returns</span><span class="p">[</span><span class="n">port_returns</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">cvar</span>
    
    <span class="k">def</span> <span class="nf">calculate_risk_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate comprehensive risk metrics.&quot;&quot;&quot;</span>
        <span class="n">weight_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">])</span>
        <span class="n">port_returns</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">returns</span> <span class="o">*</span> <span class="n">weight_array</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_covariance_matrix</span><span class="p">()</span>
        <span class="n">port_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weight_array</span> <span class="o">@</span> <span class="n">cov</span><span class="o">.</span><span class="n">values</span> <span class="o">@</span> <span class="n">weight_array</span><span class="p">)</span>
        
        <span class="n">port_return</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">weight_array</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>
        
        <span class="n">cumulative</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">port_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">running_max</span> <span class="o">=</span> <span class="n">cumulative</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cumulative</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span>
        <span class="n">max_drawdown</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;annual_return&#39;</span><span class="p">:</span> <span class="n">port_return</span><span class="p">,</span>
            <span class="s1">&#39;annual_volatility&#39;</span><span class="p">:</span> <span class="n">port_vol</span><span class="p">,</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="n">port_return</span> <span class="o">/</span> <span class="n">port_vol</span> <span class="k">if</span> <span class="n">port_vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;var_95&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_portfolio_var</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
            <span class="s1">&#39;cvar_95&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_portfolio_cvar</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_drawdown</span><span class="p">,</span>
            <span class="s1">&#39;current_drawdown&#39;</span><span class="p">:</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">check_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check if weights violate any risk limits.&quot;&quot;&quot;</span>
        <span class="n">violations</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">max_position_size</span><span class="p">:</span>
                <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;position_size&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
                    <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">max_position_size</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> weight </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> exceeds limit </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">max_position_size</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">})</span>
        
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_portfolio_var</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">max_portfolio_var</span><span class="p">:</span>
            <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
                <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">max_portfolio_var</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Portfolio VaR </span><span class="si">{</span><span class="n">var</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> exceeds limit </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">max_portfolio_var</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">})</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="n">violations</span>
        <span class="k">return</span> <span class="n">violations</span>
    
    <span class="k">def</span> <span class="nf">get_risk_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate risk report.&quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_risk_metrics</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_limits</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        
        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RISK MANAGEMENT REPORT&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Portfolio Risk Metrics:&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expected Return:  </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;annual_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility:       </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;annual_volatility&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe Ratio:     </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  VaR (95%):        </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;var_95&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Drawdown:     </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Limit Violations:&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">violations</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">violations</span><span class="p">:</span>
                <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ‚ö†Ô∏è </span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  ‚úì All limits within bounds&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

<span class="c1"># Create risk manager</span>
<span class="n">risk_manager</span> <span class="o">=</span> <span class="n">RiskManager</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

<span class="c1"># Get combined weights</span>
<span class="n">combined_weights</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">combine_weights</span><span class="p">()</span>

<span class="c1"># Generate risk report</span>
<span class="nb">print</span><span class="p">(</span><span class="n">risk_manager</span><span class="o">.</span><span class="n">get_risk_report</span><span class="p">(</span><span class="n">combined_weights</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><hr />
<h3>Exercise C.3: Dynamic Risk Adjustment (Guided)</h3>
<p>Create a function that adjusts portfolio weights to respect risk limits.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise C.3: Dynamic Risk Adjustment (Guided)</span>

<span class="k">def</span> <span class="nf">adjust_weights_for_risk</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> 
                           <span class="n">risk_manager</span><span class="p">:</span> <span class="n">RiskManager</span><span class="p">,</span>
                           <span class="n">max_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjust weights to meet risk limits.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        weights: Target portfolio weights</span>
<span class="sd">        risk_manager: RiskManager instance</span>
<span class="sd">        max_iterations: Max adjustment iterations</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Adjusted weights and adjustment info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Create copy of weights</span>
    <span class="n">adjusted</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    <span class="n">adjustments_made</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
        <span class="c1"># TODO: Check current limits</span>
        <span class="n">violations</span> <span class="o">=</span> <span class="n">risk_manager</span><span class="o">.</span><span class="n">______</span><span class="p">(</span><span class="n">adjusted</span><span class="p">)</span>
        
        <span class="c1"># TODO: Exit if no violations</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">______</span><span class="p">:</span>
            <span class="k">break</span>
        
        <span class="k">for</span> <span class="n">violation</span> <span class="ow">in</span> <span class="n">violations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">violation</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;position_size&#39;</span><span class="p">:</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="n">violation</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span>
                <span class="c1"># TODO: Get limit from violation</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="n">violation</span><span class="p">[</span><span class="n">______</span><span class="p">]</span>
                
                <span class="c1"># Calculate excess</span>
                <span class="n">excess</span> <span class="o">=</span> <span class="n">adjusted</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">-</span> <span class="n">limit</span>
                <span class="c1"># TODO: Cap at limit</span>
                <span class="n">adjusted</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">______</span>
                
                <span class="c1"># Redistribute excess to other positions</span>
                <span class="n">other_symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">adjusted</span> <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">symbol</span><span class="p">]</span>
                <span class="c1"># TODO: Calculate redistribution per symbol</span>
                <span class="n">per_symbol</span> <span class="o">=</span> <span class="n">excess</span> <span class="o">/</span> <span class="n">______</span><span class="p">(</span><span class="n">other_symbols</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">other_symbols</span><span class="p">:</span>
                    <span class="n">adjusted</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">per_symbol</span>
                
                <span class="n">adjustments_made</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Capped </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">limit</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">violation</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;var&#39;</span><span class="p">:</span>
                <span class="c1"># Scale down all positions</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">0.9</span>
                <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">adjusted</span><span class="p">:</span>
                    <span class="c1"># TODO: Scale down each weight</span>
                    <span class="n">adjusted</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="n">______</span> <span class="n">scale_factor</span>
                
                <span class="n">adjustments_made</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaled down by </span><span class="si">{</span><span class="mi">1</span><span class="o">-</span><span class="n">scale_factor</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Normalize</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">adjusted</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">adjusted</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">w</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">adjusted</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;original_weights&#39;</span><span class="p">:</span> <span class="n">weights</span><span class="p">,</span>
        <span class="s1">&#39;adjusted_weights&#39;</span><span class="p">:</span> <span class="n">adjusted</span><span class="p">,</span>
        <span class="s1">&#39;adjustments&#39;</span><span class="p">:</span> <span class="n">adjustments_made</span><span class="p">,</span>
        <span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="n">iteration</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">adjust_weights_for_risk</span><span class="p">(</span><span class="n">combined_weights</span><span class="p">,</span> <span class="n">risk_manager</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adjustments made: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;adjustments&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iterations: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;adjustments&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">adj</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;adjustments&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">adj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">adjust_weights_for_risk</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> 
                           <span class="n">risk_manager</span><span class="p">:</span> <span class="n">RiskManager</span><span class="p">,</span>
                           <span class="n">max_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjust weights to meet risk limits.</span>

<span class="sd">    Args:</span>
<span class="sd">        weights: Target portfolio weights</span>
<span class="sd">        risk_manager: RiskManager instance</span>
<span class="sd">        max_iterations: Max adjustment iterations</span>

<span class="sd">    Returns:</span>
<span class="sd">        Adjusted weights and adjustment info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adjusted</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">adjustments_made</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
        <span class="n">violations</span> <span class="o">=</span> <span class="n">risk_manager</span><span class="o">.</span><span class="n">check_limits</span><span class="p">(</span><span class="n">adjusted</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">violations</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">for</span> <span class="n">violation</span> <span class="ow">in</span> <span class="n">violations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">violation</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;position_size&#39;</span><span class="p">:</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="n">violation</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="n">violation</span><span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">]</span>

                <span class="n">excess</span> <span class="o">=</span> <span class="n">adjusted</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">-</span> <span class="n">limit</span>
                <span class="n">adjusted</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span>

                <span class="n">other_symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">adjusted</span> <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">symbol</span><span class="p">]</span>
                <span class="n">per_symbol</span> <span class="o">=</span> <span class="n">excess</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_symbols</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">other_symbols</span><span class="p">:</span>
                    <span class="n">adjusted</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="n">per_symbol</span>

                <span class="n">adjustments_made</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Capped </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">limit</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">violation</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;var&#39;</span><span class="p">:</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">0.9</span>
                <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">adjusted</span><span class="p">:</span>
                    <span class="n">adjusted</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">*=</span> <span class="n">scale_factor</span>

                <span class="n">adjustments_made</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaled down by </span><span class="si">{</span><span class="mi">1</span><span class="o">-</span><span class="n">scale_factor</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">adjusted</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">adjusted</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">w</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">adjusted</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;original_weights&#39;</span><span class="p">:</span> <span class="n">weights</span><span class="p">,</span>
        <span class="s1">&#39;adjusted_weights&#39;</span><span class="p">:</span> <span class="n">adjusted</span><span class="p">,</span>
        <span class="s1">&#39;adjustments&#39;</span><span class="p">:</span> <span class="n">adjustments_made</span><span class="p">,</span>
        <span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="n">iteration</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">}</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Part 4: Execution Engine</h2>
<p>Build an execution system that:
- Calculates required trades to reach target weights
- Estimates transaction costs
- Manages order generation</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Trade</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a trade order.&quot;&quot;&quot;</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">side</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="k">class</span> <span class="nc">ExecutionEngine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trade execution engine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_pipeline</span><span class="p">:</span> <span class="n">DataPipeline</span><span class="p">,</span> 
                 <span class="n">transaction_cost_bps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="n">min_trade_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_cost_bps</span> <span class="o">=</span> <span class="n">transaction_cost_bps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_trade_value</span> <span class="o">=</span> <span class="n">min_trade_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">calculate_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_holdings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
                        <span class="n">target_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                        <span class="n">portfolio_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate trades to reach target weights.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_latest_prices</span><span class="p">()</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">target_weights</span><span class="p">:</span>
            <span class="n">current_shares</span> <span class="o">=</span> <span class="n">current_holdings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">current_value</span> <span class="o">=</span> <span class="n">current_shares</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
            <span class="n">current_weight</span> <span class="o">=</span> <span class="n">current_value</span> <span class="o">/</span> <span class="n">portfolio_value</span> <span class="k">if</span> <span class="n">portfolio_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="n">target_weight</span> <span class="o">=</span> <span class="n">target_weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">target_value</span> <span class="o">=</span> <span class="n">target_weight</span> <span class="o">*</span> <span class="n">portfolio_value</span>
            <span class="n">target_shares</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_value</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>
            
            <span class="n">shares_diff</span> <span class="o">=</span> <span class="n">target_shares</span> <span class="o">-</span> <span class="n">current_shares</span>
            <span class="n">trade_value</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">shares_diff</span> <span class="o">*</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">trade_value</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_trade_value</span><span class="p">:</span>
                <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
                    <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
                    <span class="n">side</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="n">shares_diff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span>
                    <span class="n">quantity</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">shares_diff</span><span class="p">),</span>
                    <span class="n">price</span><span class="o">=</span><span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">],</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">trade_value</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rebalance: </span><span class="si">{</span><span class="n">current_weight</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">target_weight</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        
        <span class="n">trades</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_trades</span> <span class="o">=</span> <span class="n">trades</span>
        <span class="k">return</span> <span class="n">trades</span>
    
    <span class="k">def</span> <span class="nf">estimate_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Trade</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Estimate transaction costs.&quot;&quot;&quot;</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_trades</span>
        
        <span class="n">total_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trades</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="n">total_value</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_cost_bps</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;num_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;total_value&#39;</span><span class="p">:</span> <span class="n">total_value</span><span class="p">,</span>
            <span class="s1">&#39;estimated_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
            <span class="s1">&#39;cost_bps&#39;</span><span class="p">:</span> <span class="n">total_cost</span> <span class="o">/</span> <span class="n">total_value</span> <span class="o">*</span> <span class="mi">10000</span> <span class="k">if</span> <span class="n">total_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_trade_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get summary of pending trades.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span>
            <span class="p">{</span>
                <span class="s1">&#39;Symbol&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;Side&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">side</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                <span class="s1">&#39;Quantity&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
                <span class="s1">&#39;Price&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_trades</span>
        <span class="p">])</span>

<span class="c1"># Create execution engine</span>
<span class="n">execution</span> <span class="o">=</span> <span class="n">ExecutionEngine</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">transaction_cost_bps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Simulate current holdings</span>
<span class="n">portfolio_value</span> <span class="o">=</span> <span class="mi">1_000_000</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_latest_prices</span><span class="p">()</span>

<span class="n">initial_weight</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">UNIVERSE</span><span class="p">)</span>
<span class="n">current_holdings</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">UNIVERSE</span><span class="p">:</span>
    <span class="n">target_value</span> <span class="o">=</span> <span class="n">portfolio_value</span> <span class="o">*</span> <span class="n">initial_weight</span>
    <span class="n">current_holdings</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_value</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>

<span class="c1"># Calculate trades</span>
<span class="n">trades</span> <span class="o">=</span> <span class="n">execution</span><span class="o">.</span><span class="n">calculate_trades</span><span class="p">(</span><span class="n">current_holdings</span><span class="p">,</span> <span class="n">combined_weights</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trade Summary:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">execution</span><span class="o">.</span><span class="n">get_trade_summary</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cost Estimate:&quot;</span><span class="p">)</span>
<span class="n">costs</span> <span class="o">=</span> <span class="n">execution</span><span class="o">.</span><span class="n">estimate_costs</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total value: $</span><span class="si">{</span><span class="n">costs</span><span class="p">[</span><span class="s1">&#39;total_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Estimated cost: $</span><span class="si">{</span><span class="n">costs</span><span class="p">[</span><span class="s1">&#39;estimated_cost&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h3>Exercise C.4: Complete Trading System (Open-ended)</h3>
<p>Integrate all components into a unified trading system class.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise C.4: Complete Trading System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a TradingSystem class that:</span>
<span class="c1"># - Integrates data pipeline, strategy engine, risk manager, and execution engine</span>
<span class="c1"># - Implements a run_cycle() method that:</span>
<span class="c1">#   1. Updates market data</span>
<span class="c1">#   2. Calculates target weights from strategies</span>
<span class="c1">#   3. Checks risk limits and adjusts if needed</span>
<span class="c1">#   4. Generates trades and estimates costs</span>
<span class="c1"># - Tracks portfolio state (holdings, value, PnL)</span>
<span class="c1"># - Generates comprehensive reports</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete quantitative trading system.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">universe</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">universe</span>

        <span class="c1"># Components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataPipeline</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span> <span class="o">=</span> <span class="n">StrategyEngine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk</span> <span class="o">=</span> <span class="n">RiskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution</span> <span class="o">=</span> <span class="n">ExecutionEngine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># State</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holdings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_initialized</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the trading system.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fetch_historical_data</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holdings</span> <span class="o">=</span> <span class="p">{</span><span class="n">symbol</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_initialized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;System initialized with $</span><span class="si">{</span><span class="n">initial_capital</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">,</span> <span class="n">allocation</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a strategy to the system.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">allocation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run one trading cycle.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;System not initialized&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="c1"># Calculate target weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="o">.</span><span class="n">combine_weights</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;target_weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Calculated target weights&#39;</span><span class="p">)</span>

        <span class="c1"># Check risk limits</span>
        <span class="n">violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">check_limits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;risk_violations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">violations</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span><span class="si">}</span><span class="s1"> risk violations&#39;</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;risk_alert&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Risk limits OK&#39;</span><span class="p">)</span>

        <span class="c1"># Calculate trades</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution</span><span class="o">.</span><span class="n">calculate_trades</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">holdings</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span>
        <span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;num_trades&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span><span class="si">}</span><span class="s1"> trades&#39;</span><span class="p">)</span>

        <span class="c1"># Estimate costs</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;estimated_costs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution</span><span class="o">.</span><span class="n">estimate_costs</span><span class="p">()</span>

        <span class="c1"># Risk metrics</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;risk_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">calculate_risk_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive system report.&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRADING SYSTEM REPORT: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;PORTFOLIO SUMMARY&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Value: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Universe: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span><span class="si">}</span><span class="s2"> assets&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strategies: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategies</span><span class="o">.</span><span class="n">strategies</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;TARGET ALLOCATION&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">calculate_risk_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_weights</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RISK METRICS&quot;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expected Return: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;annual_return&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;annual_volatility&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe Ratio: </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  VaR (95%): </span><span class="si">{</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;var_95&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">TradingSystem</span><span class="p">(</span><span class="s2">&quot;Capstone System&quot;</span><span class="p">,</span> <span class="n">UNIVERSE</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="mi">1_000_000</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">MeanVarianceStrategy</span><span class="p">(</span><span class="n">target_return</span><span class="o">=</span><span class="mf">0.08</span><span class="p">),</span> <span class="mf">0.40</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">RiskParityStrategy</span><span class="p">(),</span> <span class="mf">0.35</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">MinimumVolatilityStrategy</span><span class="p">(),</span> <span class="mf">0.25</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">run_cycle</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trades: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;num_trades&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">generate_report</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h3>Exercise C.5: Performance Dashboard (Open-ended)</h3>
<p>Create a performance visualization dashboard for the trading system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise C.5: Performance Dashboard (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a function that creates a 4-panel visualization:</span>
<span class="c1"># - Panel 1: Cumulative returns (portfolio vs benchmark)</span>
<span class="c1"># - Panel 2: Drawdown chart</span>
<span class="c1"># - Panel 3: Portfolio allocation pie chart</span>
<span class="c1"># - Panel 4: Rolling Sharpe ratio</span>
<span class="c1">#</span>
<span class="c1"># The function should also print summary statistics:</span>
<span class="c1"># - Total return, alpha, max drawdown, Sharpe ratio</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_performance_dashboard</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                                 <span class="n">weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                                 <span class="n">benchmark_symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SPY&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a comprehensive performance dashboard.</span>

<span class="sd">    Args:</span>
<span class="sd">        returns: Asset returns DataFrame</span>
<span class="sd">        weights: Portfolio weights</span>
<span class="sd">        benchmark_symbol: Benchmark ticker</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate portfolio returns</span>
    <span class="n">weight_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="n">port_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">*</span> <span class="n">weight_array</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">port_cumulative</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">port_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

    <span class="c1"># Benchmark returns</span>
    <span class="n">bench_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="p">[</span><span class="n">benchmark_symbol</span><span class="p">]</span>
    <span class="n">bench_cumulative</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">bench_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

    <span class="c1"># Drawdown</span>
    <span class="n">running_max</span> <span class="o">=</span> <span class="n">port_cumulative</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">port_cumulative</span> <span class="o">-</span> <span class="n">running_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">running_max</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="c1"># Rolling Sharpe</span>
    <span class="n">rolling_sharpe</span> <span class="o">=</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="c1"># Create figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Panel 1: Cumulative returns</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">port_cumulative</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">port_cumulative</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Portfolio&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bench_cumulative</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bench_cumulative</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">benchmark_symbol</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Growth of $1&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Panel 2: Drawdown</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">drawdown</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Panel 3: Allocation</span>
    <span class="n">sorted_weights</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Set3</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_weights</span><span class="p">)))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sorted_weights</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">labels</span><span class="o">=</span><span class="n">sorted_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> 
                   <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Target Allocation&#39;</span><span class="p">)</span>

    <span class="c1"># Panel 4: Rolling Sharpe</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolling_sharpe</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">rolling_sharpe</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">rolling_sharpe</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> 
                       <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mean: </span><span class="si">{</span><span class="n">rolling_sharpe</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Rolling Sharpe Ratio (63-day)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Print summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performance Summary:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Return: </span><span class="si">{</span><span class="p">(</span><span class="n">port_cumulative</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Benchmark Return: </span><span class="si">{</span><span class="p">(</span><span class="n">bench_cumulative</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Alpha: </span><span class="si">{</span><span class="p">(</span><span class="n">port_cumulative</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bench_cumulative</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Drawdown: </span><span class="si">{</span><span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe Ratio: </span><span class="si">{</span><span class="n">port_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">port_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">create_performance_dashboard</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">returns</span><span class="p">,</span> <span class="n">combined_weights</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h3>Exercise C.6: System Extensions (Open-ended)</h3>
<p>Extend the trading system with additional features.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise C.6: System Extensions (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Choose ONE of the following extensions to implement:</span>
<span class="c1">#</span>
<span class="c1"># Option A: Momentum Strategy</span>
<span class="c1"># - Implement a momentum strategy that ranks assets by recent performance</span>
<span class="c1"># - Weight assets based on momentum score</span>
<span class="c1"># - Add to the strategy engine</span>
<span class="c1">#</span>
<span class="c1"># Option B: Portfolio Rebalancing Logic</span>
<span class="c1"># - Implement a rebalancing trigger (drift-based or calendar-based)</span>
<span class="c1"># - Only generate trades when rebalancing is triggered</span>
<span class="c1"># - Track rebalancing history</span>
<span class="c1">#</span>
<span class="c1"># Option C: Performance Attribution</span>
<span class="c1"># - Implement Brinson attribution (allocation + selection effects)</span>
<span class="c1"># - Break down performance by asset contribution</span>
<span class="c1"># - Generate attribution reports</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click for solution (Option A: Momentum Strategy)</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MomentumStrategy</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Momentum-based strategy.</span>

<span class="sd">    Ranks assets by recent performance and overweights winners.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">,</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;Momentum&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback_days</span> <span class="o">=</span> <span class="n">lookback_days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_n</span> <span class="o">=</span> <span class="n">top_n</span>

    <span class="k">def</span> <span class="nf">calculate_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">DataPipeline</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="c1"># Calculate momentum scores (total return over lookback)</span>
        <span class="n">recent_prices</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback_days</span><span class="p">)</span>
        <span class="n">momentum</span> <span class="o">=</span> <span class="p">(</span><span class="n">recent_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">recent_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># Rank and select top performers</span>
        <span class="n">rankings</span> <span class="o">=</span> <span class="n">momentum</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Weight based on momentum score</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">total_momentum</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rankings</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_n</span><span class="p">:</span>
                <span class="c1"># Only invest in top N performers</span>
                <span class="n">score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">momentum</span><span class="p">[</span><span class="n">symbol</span><span class="p">],</span> <span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Floor at small positive</span>
                <span class="n">weights</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">total_momentum</span> <span class="o">+=</span> <span class="n">score</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weights</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Normalize weights</span>
        <span class="k">if</span> <span class="n">total_momentum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">w</span> <span class="o">/</span> <span class="n">total_momentum</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Equal weight fallback</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">weights</span>

<span class="c1"># Test the momentum strategy</span>
<span class="n">momentum_strat</span> <span class="o">=</span> <span class="n">MomentumStrategy</span><span class="p">(</span><span class="n">lookback_days</span><span class="o">=</span><span class="mi">126</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">momentum_weights</span> <span class="o">=</span> <span class="n">momentum_strat</span><span class="o">.</span><span class="n">calculate_weights</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Momentum Strategy Weights:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">momentum_weights</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Add to strategy engine</span>
<span class="n">engine</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">momentum_strat</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">)</span>  <span class="c1"># 20% allocation</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h2>Capstone Completion Checklist</h2>
<h3>Core Components</h3>
<ul>
<li>[ ] Data pipeline fetches and processes market data</li>
<li>[ ] Multiple strategies implemented and combined</li>
<li>[ ] Risk management with VaR, limits, and alerts</li>
<li>[ ] Execution engine calculates trades and costs</li>
<li>[ ] System integration with run cycle</li>
</ul>
<h3>Exercises Completed</h3>
<ul>
<li>[ ] C.1: Data Quality Validator</li>
<li>[ ] C.2: Strategy Performance Tracker</li>
<li>[ ] C.3: Dynamic Risk Adjustment</li>
<li>[ ] C.4: Complete Trading System</li>
<li>[ ] C.5: Performance Dashboard</li>
<li>[ ] C.6: System Extensions</li>
</ul>
<hr />
<h2>Congratulations!</h2>
<p>You've completed <strong>Course 3: Quantitative Finance &amp; Portfolio Theory</strong>!</p>
<h3>What You've Built</h3>
<p>A complete quantitative trading system with:
- Multi-source data pipeline
- Multi-strategy portfolio optimization
- Real-time risk management
- Cost-aware execution
- Performance visualization</p>
<h3>Key Skills Developed</h3>
<ul>
<li><strong>Portfolio Theory</strong>: Mean-variance, risk parity, factor models</li>
<li><strong>Risk Management</strong>: VaR, CVaR, stress testing, limits</li>
<li><strong>System Design</strong>: Component integration, state management</li>
<li><strong>Production Skills</strong>: Monitoring, execution, deployment</li>
</ul>
<h3>Next Steps</h3>
<ol>
<li><strong>Paper Trade</strong>: Test your system with simulated trading</li>
<li><strong>Iterate</strong>: Refine strategies based on performance</li>
<li><strong>Deploy</strong>: Move to cloud infrastructure (see Modules 17-18)</li>
<li><strong>Continue Learning</strong>: Course 4 (ML for Finance) awaits!</li>
</ol>
<p>Good luck on your quantitative trading journey!</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
    </main>

    <script>
        window.courseId = 'course3_quant_finance';
        
// State
let currentModule = 0;
const modules = document.querySelectorAll('.module-section');
const sidebarItems = document.querySelectorAll('.sidebar-item');
const sidebar = document.querySelector('.sidebar');
const overlay = document.querySelector('.sidebar-overlay');
const headerModule = document.querySelector('.header-module');

function showModule(idx) {
    if (idx < 0 || idx >= modules.length) return;

    // Hide all, show target
    modules.forEach(m => m.classList.remove('active'));
    modules[idx].classList.add('active');

    // Update sidebar active state
    sidebarItems.forEach(s => s.classList.remove('active'));
    sidebarItems[idx].classList.add('active');

    // Update header
    const label = sidebarItems[idx].textContent.trim();
    if (headerModule) headerModule.textContent = label;

    // Update prev/next buttons
    updateNavButtons(idx);

    // Save & scroll
    currentModule = idx;
    try { localStorage.setItem(window.courseId + '_module', idx); } catch(e) {}
    window.scrollTo(0, 0);

    // Close sidebar on mobile
    closeSidebar();
}

function updateNavButtons(idx) {
    const section = modules[idx];
    const prevBtn = section.querySelector('.prev-btn');
    const nextBtn = section.querySelector('.next-btn');

    if (prevBtn) {
        // Clone to remove old listeners
        const newPrev = prevBtn.cloneNode(true);
        prevBtn.parentNode.replaceChild(newPrev, prevBtn);
        if (idx === 0) {
            newPrev.classList.add('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = '';
        } else {
            newPrev.classList.remove('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = sidebarItems[idx - 1].textContent.trim();
            newPrev.addEventListener('click', () => showModule(idx - 1));
        }
    }
    if (nextBtn) {
        const newNext = nextBtn.cloneNode(true);
        nextBtn.parentNode.replaceChild(newNext, nextBtn);
        if (idx === modules.length - 1) {
            newNext.classList.add('disabled');
            newNext.querySelector('.nav-btn-name').textContent = '';
        } else {
            newNext.classList.remove('disabled');
            newNext.querySelector('.nav-btn-name').textContent = sidebarItems[idx + 1].textContent.trim();
            newNext.addEventListener('click', () => showModule(idx + 1));
        }
    }
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('open');
}

// Copy code button
function copyCode(btn) {
    const code = btn.parentElement.querySelector('pre code');
    const text = code.textContent;
    navigator.clipboard.writeText(text).then(() => {
        btn.textContent = '‚úì';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = 'üìã';
            btn.classList.remove('copied');
        }, 1500);
    }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        btn.textContent = '‚úì';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = 'üìã';
            btn.classList.remove('copied');
        }, 1500);
    });
}

// Init: bind sidebar items
sidebarItems.forEach((item, idx) => {
    item.addEventListener('click', () => showModule(idx));
});

// Restore last viewed module
document.addEventListener('DOMContentLoaded', () => {
    let saved = 0;
    try { saved = parseInt(localStorage.getItem(window.courseId + '_module')) || 0; } catch(e) {}
    if (saved >= 0 && saved < modules.length) {
        showModule(saved);
    } else {
        showModule(0);
    }
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' && currentModule > 0) showModule(currentModule - 1);
    if (e.key === 'ArrowRight' && currentModule < modules.length - 1) showModule(currentModule + 1);
    if (e.key === 'Escape') closeSidebar();
});

    </script>
</body>
</html>