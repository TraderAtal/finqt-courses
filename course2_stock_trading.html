<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Stock Algo Trading ‚Äî FinQT</title>
    <style>
/* === Reset & Base === */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --bg: #0a0a0a;
    --bg-secondary: #111111;
    --bg-sidebar: #0d0d0d;
    --text: #e0e0e0;
    --text-dim: #888888;
    --green: #00c853;
    --green-dim: #1b5e20;
    --green-glow: rgba(0, 200, 83, 0.15);
    --code-bg: #141420;
    --border: #1e1e1e;
    --header-height: 52px;
}

html {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.65;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
}

/* === Header === */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    z-index: 1000;
    gap: 12px;
}

.hamburger {
    background: none;
    border: none;
    color: var(--text);
    font-size: 22px;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    line-height: 1;
    flex-shrink: 0;
}
.hamburger:hover {
    background: rgba(255,255,255,0.08);
}

.header-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--green);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.header-module {
    font-size: 13px;
    color: var(--text-dim);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-left: auto;
}

/* === Sidebar === */
.sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1001;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}
.sidebar-overlay.open {
    opacity: 1;
    pointer-events: auto;
}

.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 280px;
    max-width: 85vw;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    z-index: 1002;
    transform: translateX(-100%);
    transition: transform 0.25s ease;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 12px;
    padding-bottom: 24px;
}
.sidebar.open {
    transform: translateX(0);
}

.sidebar-header {
    padding: 12px 16px 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
}
.sidebar-header h2 {
    font-size: 15px;
    color: var(--green);
    font-weight: 600;
}

.sidebar-part {
    padding: 10px 16px 4px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.6px;
}

.sidebar-item {
    display: block;
    padding: 8px 16px 8px 24px;
    font-size: 13px;
    color: var(--text);
    text-decoration: none;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: all 0.15s;
}
.sidebar-item:hover {
    background: rgba(255,255,255,0.04);
}
.sidebar-item.active {
    color: var(--green);
    border-left-color: var(--green);
    background: var(--green-glow);
    font-weight: 600;
}

/* === Main Content === */
.main {
    margin-top: var(--header-height);
    padding: 20px 16px 80px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.module-section {
    display: none;
}
.module-section.active {
    display: block;
}

/* === Typography === */
.md-cell h1 {
    font-size: 1.7rem;
    font-weight: 700;
    color: var(--green);
    margin: 1.5em 0 0.5em;
    line-height: 1.25;
}
.md-cell h2 {
    font-size: 1.35rem;
    font-weight: 600;
    color: var(--green);
    margin: 1.4em 0 0.4em;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
}
.md-cell h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #cccccc;
    margin: 1.2em 0 0.3em;
}
.md-cell h4, .md-cell h5, .md-cell h6 {
    font-size: 1rem;
    font-weight: 600;
    color: #bbbbbb;
    margin: 1em 0 0.3em;
}

.md-cell p {
    margin: 0.6em 0;
}

.md-cell a {
    color: var(--green);
    text-decoration: none;
}
.md-cell a:hover {
    text-decoration: underline;
}

.md-cell strong {
    color: #f0f0f0;
}

.md-cell ul, .md-cell ol {
    margin: 0.5em 0;
    padding-left: 1.5em;
}
.md-cell li {
    margin: 0.25em 0;
}

.md-cell hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.5em 0;
}

.md-cell blockquote {
    border-left: 3px solid var(--green-dim);
    padding: 0.5em 1em;
    margin: 0.8em 0;
    color: var(--text-dim);
    background: rgba(255,255,255,0.02);
    border-radius: 0 6px 6px 0;
}

/* Inline code (not inside pre blocks) */
.md-cell code {
    background: rgba(255,255,255,0.08);
    padding: 2px 6px;
    border-radius: 3px;
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.88em;
    color: #e8e8e8;
}
.md-cell pre code {
    background: transparent !important;
    padding: 0;
    border-radius: 0;
    color: inherit;
}

/* Fenced code blocks inside markdown */
.md-cell pre {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    overflow-x: auto;
    margin: 0.8em 0;
    -webkit-overflow-scrolling: touch;
}
.md-cell pre code {
    background: none;
    padding: 0;
    border-radius: 0;
    font-size: 0.85rem;
    line-height: 1.5;
    color: #e8e8e8;
}

/* === Module Header (first cell) === */
.module-header {
    padding-bottom: 0.5em;
    margin-bottom: 0.5em;
}
.module-header h1 {
    font-size: 1.8rem;
    margin-top: 0;
}

/* === Tables === */
.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0.8em 0;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.md-cell table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
}
.md-cell th {
    background: var(--bg-secondary);
    color: var(--green);
    font-weight: 600;
    text-align: left;
    padding: 10px 12px;
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
}
.md-cell td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
}
.md-cell tr:last-child td {
    border-bottom: none;
}

/* === Code Cells === */
.code-cell {
    position: relative;
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin: 0.6em 0;
    overflow: hidden;
}
.code-cell pre {
    margin: 0;
    padding: 14px 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.code-cell pre code {
    font-family: "SF Mono", "Fira Code", "Cascadia Code", Menlo, monospace;
    font-size: 0.82rem;
    line-height: 1.55;
    background: transparent !important;
    padding: 0;
    border-radius: 0;
}

.copy-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(255,255,255,0.08);
    border: none;
    border-radius: 4px;
    padding: 4px 7px;
    font-size: 13px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 5;
}
.code-cell:hover .copy-btn {
    opacity: 1;
}
.copy-btn:hover {
    background: rgba(255,255,255,0.15);
}
.copy-btn.copied {
    opacity: 1;
}

/* === Exercise Styling === */
.exercise-header {
    background: rgba(0, 200, 83, 0.04);
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 12px 16px;
    margin: 1em 0 0.3em;
}
.exercise-header h3 {
    color: var(--green);
    margin-top: 0;
}

.exercise-code {
    border-color: var(--green-dim);
}

/* === Solution (details) blocks === */
.solution-block details {
    border-left: 3px solid var(--green);
    border-radius: 0 8px 8px 0;
    margin: 0.5em 0 1em;
    background: rgba(0, 200, 83, 0.03);
}
.solution-block summary {
    padding: 10px 14px;
    cursor: pointer;
    color: var(--green);
    font-weight: 600;
    font-size: 0.9rem;
    user-select: none;
    -webkit-user-select: none;
}
.solution-block summary:hover {
    background: rgba(0, 200, 83, 0.06);
}
.solution-block details[open] summary {
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
}
.solution-block details > :not(summary) {
    padding: 0 14px;
}
.solution-block details pre {
    margin: 10px 0;
}

/* === Module Project === */
.module-project {
    border: 1px solid var(--green-dim);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
    background: rgba(0, 200, 83, 0.03);
}
.module-project h1 {
    font-size: 1.4rem;
}

/* === Key Takeaways === */
.key-takeaways {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin: 1.5em 0;
}
.key-takeaways h1 {
    font-size: 1.3rem;
    margin-top: 0;
}

/* === Prev/Next Navigation === */
.nav-buttons {
    display: flex;
    gap: 12px;
    margin-top: 2em;
    padding-top: 1.5em;
    border-top: 1px solid var(--border);
}
.nav-btn {
    flex: 1;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: inherit;
    font-size: 0.9rem;
    cursor: pointer;
    text-align: center;
    transition: all 0.15s;
    text-decoration: none;
    -webkit-appearance: none;
    -webkit-tap-highlight-color: rgba(0, 200, 83, 0.2);
}
.nav-btn:hover {
    border-color: var(--green);
    color: var(--green);
}
.nav-btn.disabled {
    opacity: 0.3;
    pointer-events: none;
}
.nav-btn-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-bottom: 2px;
}

/* === Syntax Highlighting (Pygments Monokai) === */
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.code-cell pre code .hll { background-color: #49483e }
.code-cell pre code { background: #272822; color: #f8f8f2 }
.code-cell pre code .c { color: #75715e } /* Comment */
.code-cell pre code .err { color: #960050; background-color: #1e0010 } /* Error */
.code-cell pre code .esc { color: #f8f8f2 } /* Escape */
.code-cell pre code .g { color: #f8f8f2 } /* Generic */
.code-cell pre code .k { color: #66d9ef } /* Keyword */
.code-cell pre code .l { color: #ae81ff } /* Literal */
.code-cell pre code .n { color: #f8f8f2 } /* Name */
.code-cell pre code .o { color: #f92672 } /* Operator */
.code-cell pre code .x { color: #f8f8f2 } /* Other */
.code-cell pre code .p { color: #f8f8f2 } /* Punctuation */
.code-cell pre code .ch { color: #75715e } /* Comment.Hashbang */
.code-cell pre code .cm { color: #75715e } /* Comment.Multiline */
.code-cell pre code .cp { color: #75715e } /* Comment.Preproc */
.code-cell pre code .cpf { color: #75715e } /* Comment.PreprocFile */
.code-cell pre code .c1 { color: #75715e } /* Comment.Single */
.code-cell pre code .cs { color: #75715e } /* Comment.Special */
.code-cell pre code .gd { color: #f92672 } /* Generic.Deleted */
.code-cell pre code .ge { color: #f8f8f2; font-style: italic } /* Generic.Emph */
.code-cell pre code .gr { color: #f8f8f2 } /* Generic.Error */
.code-cell pre code .gh { color: #f8f8f2 } /* Generic.Heading */
.code-cell pre code .gi { color: #a6e22e } /* Generic.Inserted */
.code-cell pre code .go { color: #66d9ef } /* Generic.Output */
.code-cell pre code .gp { color: #f92672; font-weight: bold } /* Generic.Prompt */
.code-cell pre code .gs { color: #f8f8f2; font-weight: bold } /* Generic.Strong */
.code-cell pre code .gu { color: #75715e } /* Generic.Subheading */
.code-cell pre code .gt { color: #f8f8f2 } /* Generic.Traceback */
.code-cell pre code .kc { color: #66d9ef } /* Keyword.Constant */
.code-cell pre code .kd { color: #66d9ef } /* Keyword.Declaration */
.code-cell pre code .kn { color: #f92672 } /* Keyword.Namespace */
.code-cell pre code .kp { color: #66d9ef } /* Keyword.Pseudo */
.code-cell pre code .kr { color: #66d9ef } /* Keyword.Reserved */
.code-cell pre code .kt { color: #66d9ef } /* Keyword.Type */
.code-cell pre code .ld { color: #e6db74 } /* Literal.Date */
.code-cell pre code .m { color: #ae81ff } /* Literal.Number */
.code-cell pre code .s { color: #e6db74 } /* Literal.String */
.code-cell pre code .na { color: #a6e22e } /* Name.Attribute */
.code-cell pre code .nb { color: #f8f8f2 } /* Name.Builtin */
.code-cell pre code .nc { color: #a6e22e } /* Name.Class */
.code-cell pre code .no { color: #66d9ef } /* Name.Constant */
.code-cell pre code .nd { color: #a6e22e } /* Name.Decorator */
.code-cell pre code .ni { color: #f8f8f2 } /* Name.Entity */
.code-cell pre code .ne { color: #a6e22e } /* Name.Exception */
.code-cell pre code .nf { color: #a6e22e } /* Name.Function */
.code-cell pre code .nl { color: #f8f8f2 } /* Name.Label */
.code-cell pre code .nn { color: #f8f8f2 } /* Name.Namespace */
.code-cell pre code .nx { color: #a6e22e } /* Name.Other */
.code-cell pre code .py { color: #f8f8f2 } /* Name.Property */
.code-cell pre code .nt { color: #f92672 } /* Name.Tag */
.code-cell pre code .nv { color: #f8f8f2 } /* Name.Variable */
.code-cell pre code .ow { color: #f92672 } /* Operator.Word */
.code-cell pre code .w { color: #f8f8f2 } /* Text.Whitespace */
.code-cell pre code .mb { color: #ae81ff } /* Literal.Number.Bin */
.code-cell pre code .mf { color: #ae81ff } /* Literal.Number.Float */
.code-cell pre code .mh { color: #ae81ff } /* Literal.Number.Hex */
.code-cell pre code .mi { color: #ae81ff } /* Literal.Number.Integer */
.code-cell pre code .mo { color: #ae81ff } /* Literal.Number.Oct */
.code-cell pre code .sa { color: #e6db74 } /* Literal.String.Affix */
.code-cell pre code .sb { color: #e6db74 } /* Literal.String.Backtick */
.code-cell pre code .sc { color: #e6db74 } /* Literal.String.Char */
.code-cell pre code .dl { color: #e6db74 } /* Literal.String.Delimiter */
.code-cell pre code .sd { color: #e6db74 } /* Literal.String.Doc */
.code-cell pre code .s2 { color: #e6db74 } /* Literal.String.Double */
.code-cell pre code .se { color: #ae81ff } /* Literal.String.Escape */
.code-cell pre code .sh { color: #e6db74 } /* Literal.String.Heredoc */
.code-cell pre code .si { color: #e6db74 } /* Literal.String.Interpol */
.code-cell pre code .sx { color: #e6db74 } /* Literal.String.Other */
.code-cell pre code .sr { color: #e6db74 } /* Literal.String.Regex */
.code-cell pre code .s1 { color: #e6db74 } /* Literal.String.Single */
.code-cell pre code .ss { color: #e6db74 } /* Literal.String.Symbol */
.code-cell pre code .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
.code-cell pre code .fm { color: #a6e22e } /* Name.Function.Magic */
.code-cell pre code .vc { color: #f8f8f2 } /* Name.Variable.Class */
.code-cell pre code .vg { color: #f8f8f2 } /* Name.Variable.Global */
.code-cell pre code .vi { color: #f8f8f2 } /* Name.Variable.Instance */
.code-cell pre code .vm { color: #f8f8f2 } /* Name.Variable.Magic */
.code-cell pre code .il { color: #ae81ff } /* Literal.Number.Integer.Long */

/* === Responsive === */
@media (min-width: 1024px) {
    .sidebar {
        transform: translateX(0);
        top: var(--header-height);
        padding-top: 8px;
        border-top: none;
    }
    .sidebar-overlay {
        display: none;
    }
    .main {
        margin-left: 296px;
    }
    .hamburger {
        display: none;
    }
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}
::-webkit-scrollbar-track {
    background: transparent;
}
::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.15);
    border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.25);
}
</style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">‚ò∞</button>
        <span class="header-title">Stock Algo Trading</span>
        <span class="header-module"></span>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>Stock Algo Trading</h2>
        </div>
        <div class="sidebar-part">Overview</div>
<div class="sidebar-item">Course Overview</div>
<div class="sidebar-part">Part 1: Stock Market Foundations</div>
<div class="sidebar-item">Module 1: Stock Market Basics</div>
<div class="sidebar-item">Module 2: Fundamental Analysis</div>
<div class="sidebar-item">Module 3: Technical Analysis - Trend &amp; Momentum</div>
<div class="sidebar-item">Module 4: Technical Analysis - Volatility &amp; Volume</div>
<div class="sidebar-item">Module 5: Stock Screening</div>
<div class="sidebar-part">Part 2: Strategy Development</div>
<div class="sidebar-item">Module 6: Earnings-Based Strategies</div>
<div class="sidebar-item">Module 7: Momentum &amp; Trend Strategies</div>
<div class="sidebar-item">Module 8: Sector &amp; ETF Strategies</div>
<div class="sidebar-item">Module 9: Backtesting &amp; Risk Management</div>
<div class="sidebar-part">Part 3: Options Trading</div>
<div class="sidebar-item">Module 10: Options Fundamentals</div>
<div class="sidebar-item">Module 11: Options Strategies</div>
<div class="sidebar-item">Module 12: Options Automation</div>
<div class="sidebar-part">Part 4: Automation &amp; Production</div>
<div class="sidebar-item">Module 13: Paper Trading with Alpaca</div>
<div class="sidebar-item">Module 14: SEC Filings &amp; Alternative Data</div>
<div class="sidebar-item">Module 15: Automation &amp; Monitoring</div>
<div class="sidebar-item">Module 16: Trading Psychology &amp; Journaling</div>
<div class="sidebar-part">Capstone</div>
<div class="sidebar-item">Capstone Project</div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <div class="module-section active" data-idx="0"><div class="md-cell module-header"><h1>Course 2: Stock Market Algorithmic Trading</h1>
<h2>Complete Course Overview</h2>
<hr />
<p><strong>Level:</strong> Intermediate<br />
<strong>Duration:</strong> ~40 hours<br />
<strong>Prerequisites:</strong> Course 0 (Python for Finance)<br />
<strong>Exercises:</strong> ~100</p>
<hr />
<h2>Course Description</h2>
<p>Master algorithmic trading in the stock market. Learn fundamental and technical analysis, build screening tools, implement options strategies, and automate trading with broker APIs.</p>
<hr />
<h2>What You'll Learn</h2>
<p>By completing this course, you will be able to:</p>
<ol>
<li><strong>Understand Stock Markets</strong>: How exchanges work, order types, market structure</li>
<li><strong>Analyze Fundamentals</strong>: Read financial statements, calculate ratios, compare companies</li>
<li><strong>Apply Technical Analysis</strong>: Implement indicators, identify patterns, generate signals</li>
<li><strong>Build Screeners</strong>: Filter stocks using fundamental and technical criteria</li>
<li><strong>Develop Strategies</strong>: Create momentum, trend-following, and mean-reversion systems</li>
<li><strong>Trade Options</strong>: Understand options mechanics and implement basic strategies</li>
<li><strong>Automate Trading</strong>: Connect to broker APIs and execute trades programmatically</li>
<li><strong>Manage Risk</strong>: Position sizing, stop losses, portfolio management</li>
</ol></div>
<div class="md-cell"><hr />
<h2>Course Structure</h2>
<h3>Part 1: Stock Market Foundations (Modules 1-5) ‚úÖ COMPLETE</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Module</th>
<th>Title</th>
<th>Duration</th>
<th>Exercises</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Stock Market Basics</td>
<td>~2.5h</td>
<td>6</td>
</tr>
<tr>
<td>2</td>
<td>Fundamental Analysis</td>
<td>~2.5h</td>
<td>6</td>
</tr>
<tr>
<td>3</td>
<td>Technical Analysis - Trend &amp; Momentum</td>
<td>~2.5h</td>
<td>6</td>
</tr>
<tr>
<td>4</td>
<td>Technical Analysis - Volatility &amp; Volume</td>
<td>~2.5h</td>
<td>6</td>
</tr>
<tr>
<td>5</td>
<td>Stock Screening</td>
<td>~2.5h</td>
<td>6</td>
</tr>
</tbody>
</table></div>
<p><strong>Part 1 Total: ~12.5 hours, 30 exercises</strong></p>
<h3>Part 2: Strategy Development (Modules 6-9)</h3>
<ul>
<li>Module 6: Earnings-Based Strategies</li>
<li>Module 7: Momentum &amp; Trend Strategies</li>
<li>Module 8: Sector &amp; ETF Strategies</li>
<li>Module 9: Backtesting &amp; Risk Management</li>
</ul>
<h3>Part 3: Options Trading (Modules 10-12)</h3>
<ul>
<li>Module 10: Options Fundamentals</li>
<li>Module 11: Options Strategies</li>
<li>Module 12: Options Automation</li>
</ul>
<h3>Part 4: Automation &amp; Production (Modules 13-16)</h3>
<ul>
<li>Module 13: Paper Trading with Alpaca</li>
<li>Module 14: SEC Filings &amp; Alternative Data</li>
<li>Module 15: Automation &amp; Monitoring</li>
<li>Module 16: Trading Psychology &amp; Journaling</li>
</ul>
<h3>Capstone Project</h3>
<p>Build a complete stock trading system</p></div>
<div class="md-cell"><hr />
<h2>Part 1 Module Details</h2>
<h3>Module 1: Stock Market Basics</h3>
<ul>
<li>How stock exchanges work (NYSE, NASDAQ)</li>
<li>Market hours and trading sessions</li>
<li>Order types (market, limit, stop)</li>
<li>Bid-ask spread and trading costs</li>
<li>Fetching data with yfinance</li>
<li>Adjusted prices and corporate actions</li>
</ul>
<h3>Module 2: Fundamental Analysis</h3>
<ul>
<li>Financial statements (Income, Balance, Cash Flow)</li>
<li>Profitability ratios (ROE, margins)</li>
<li>Valuation ratios (P/E, P/B, EV/EBITDA)</li>
<li>Leverage ratios (D/E, current ratio)</li>
<li>Peer comparison and sector analysis</li>
</ul>
<h3>Module 3: Technical Analysis - Trend &amp; Momentum</h3>
<ul>
<li>Moving averages (SMA, EMA)</li>
<li>MA crossover systems</li>
<li>RSI (Relative Strength Index)</li>
<li>MACD (Moving Average Convergence Divergence)</li>
<li>Stochastic Oscillator</li>
</ul>
<h3>Module 4: Technical Analysis - Volatility &amp; Volume</h3>
<ul>
<li>ATR (Average True Range)</li>
<li>Bollinger Bands and squeeze detection</li>
<li>Volume analysis and confirmation</li>
<li>OBV (On-Balance Volume)</li>
<li>Support and resistance levels</li>
</ul>
<h3>Module 5: Stock Screening</h3>
<ul>
<li>Building screening frameworks</li>
<li>Universe selection and management</li>
<li>Growth screening strategies</li>
<li>Value screening strategies</li>
<li>Multi-factor ranking systems</li>
</ul></div>
<div class="md-cell"><hr />
<h2>Stock Universe</h2>
<p>Throughout this course, we'll use a consistent set of stocks for examples:</p>
<p><strong>FAANG Stocks:</strong>
- AAPL (Apple)
- AMZN (Amazon)
- META (Meta/Facebook)
- NFLX (Netflix)
- GOOGL (Alphabet/Google)</p>
<p>These stocks provide:
- High liquidity for realistic examples
- Diverse business models
- Consistent data availability
- Familiar names for context</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Standard imports used throughout the course</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Our consistent stock universe</span>
<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Course 2: Stock Market Algorithmic Trading&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stock Universe: </span><span class="si">{</span><span class="n">FAANG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;yfinance version: </span><span class="si">{</span><span class="n">yf</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h2>Getting Started</h2>
<h3>Prerequisites</h3>
<ol>
<li>Complete Course 0 (Python for Finance)</li>
<li>Install required packages:</li>
</ol>
<div class="highlight"><pre><span></span><code>pip install <span class="nv">yfinance</span><span class="o">==</span><span class="m">1</span>.0 pandas numpy matplotlib
</code></pre></div>

<h3>How to Use This Course</h3>
<ol>
<li>Start with Module 1 and progress through modules in order</li>
<li>Read the explanations and run all code cells</li>
<li>Complete the exercises (both guided and open-ended)</li>
<li>Build the module project at the end of each module</li>
</ol>
<h3>Exercise Types</h3>
<ul>
<li><strong>Guided (fill-in-blank)</strong>: Complete the TODO sections, check solution</li>
<li><strong>Open-ended</strong>: Design and implement your own solution</li>
</ul>
<p><strong>Let's begin with Module 1!</strong></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="1"><div class="md-cell module-header"><h1>Module 1: Stock Market Basics</h1>
<h2>Part 1: Stock Market Foundations</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Course 0 (Python for Finance)</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Explain how stock exchanges work and the role of market participants</li>
<li>Understand market hours, sessions, and their impact on trading</li>
<li>Differentiate between order types and calculate trading costs</li>
<li>Fetch and process stock data using yfinance</li>
<li>Handle adjusted prices and identify corporate actions</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Required imports for this module</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">zoneinfo</span> <span class="kn">import</span> <span class="n">ZoneInfo</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="c1"># Our consistent stock universe for this course</span>
<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;yfinance version: </span><span class="si">{</span><span class="n">yf</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stock universe: </span><span class="si">{</span><span class="n">FAANG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: How the Stock Market Works</h1>
<h2>1.1 Stock Exchanges</h2>
<p>A <strong>stock exchange</strong> is an organized marketplace where buyers and sellers trade securities. In the United States, the two major exchanges are:</p>
<h3>New York Stock Exchange (NYSE)</h3>
<ul>
<li><strong>Founded:</strong> 1792</li>
<li><strong>Type:</strong> Hybrid (floor trading + electronic)</li>
<li><strong>Notable for:</strong> Blue-chip stocks, traditional companies</li>
<li><strong>Examples:</strong> JPM, WMT, KO, DIS, V</li>
</ul>
<h3>NASDAQ</h3>
<ul>
<li><strong>Founded:</strong> 1971</li>
<li><strong>Type:</strong> Fully electronic</li>
<li><strong>Notable for:</strong> Technology companies, growth stocks</li>
<li><strong>Examples:</strong> AAPL, MSFT, GOOGL, AMZN, NVDA</li>
</ul>
<h3>Key Differences</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Aspect</th>
<th>NYSE</th>
<th>NASDAQ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Trading</td>
<td>Auction + Electronic</td>
<td>Dealer-based Electronic</td>
</tr>
<tr>
<td>Listing Requirements</td>
<td>Stricter</td>
<td>More flexible</td>
</tr>
<tr>
<td>Company Types</td>
<td>Established</td>
<td>Growth-oriented</td>
</tr>
<tr>
<td>Market Makers</td>
<td>Designated (DMM)</td>
<td>Multiple</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exchange information dictionary</span>
<span class="n">EXCHANGES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;NYSE&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;New York Stock Exchange&#39;</span><span class="p">,</span>
        <span class="s1">&#39;founded&#39;</span><span class="p">:</span> <span class="mi">1792</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Hybrid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;JPM&#39;</span><span class="p">,</span> <span class="s1">&#39;WMT&#39;</span><span class="p">,</span> <span class="s1">&#39;KO&#39;</span><span class="p">,</span> <span class="s1">&#39;DIS&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s1">&#39;NASDAQ&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;NASDAQ Stock Market&#39;</span><span class="p">,</span>
        <span class="s1">&#39;founded&#39;</span><span class="p">:</span> <span class="mi">1971</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Electronic&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">:</span> <span class="n">FAANG</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">EXCHANGES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Founded: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;founded&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Type: </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Examples: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;examples&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 Market Hours and Sessions</h2>
<p>US stock markets operate on a fixed schedule (all times Eastern Time):</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Session</th>
<th>Hours (ET)</th>
<th>Characteristics</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Pre-Market</strong></td>
<td>4:00 AM - 9:30 AM</td>
<td>Lower volume, wider spreads</td>
</tr>
<tr>
<td><strong>Regular</strong></td>
<td>9:30 AM - 4:00 PM</td>
<td>Full liquidity, tightest spreads</td>
</tr>
<tr>
<td><strong>After-Hours</strong></td>
<td>4:00 PM - 8:00 PM</td>
<td>Lower volume, price gaps possible</td>
</tr>
</tbody>
</table></div>
<h3>Why Market Hours Matter for Algorithmic Trading</h3>
<ol>
<li><strong>Liquidity:</strong> Regular hours have the most trading volume</li>
<li><strong>Volatility:</strong> First and last 30 minutes are typically most volatile</li>
<li><strong>Gaps:</strong> Overnight news causes opening gaps</li>
<li><strong>Execution:</strong> Extended hours have wider bid-ask spreads</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MarketHours</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;US Stock Market trading hours.&quot;&quot;&quot;</span>
    
    <span class="n">TZ</span> <span class="o">=</span> <span class="n">ZoneInfo</span><span class="p">(</span><span class="s1">&#39;America/New_York&#39;</span><span class="p">)</span>
    
    <span class="n">SESSIONS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;pre_market&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">time</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">30</span><span class="p">)),</span>
        <span class="s1">&#39;regular&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">time</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
        <span class="s1">&#39;after_hours&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">time</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">current_session</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current trading session.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">TZ</span><span class="p">)</span>
        
        <span class="c1"># Weekend check</span>
        <span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;closed (weekend)&#39;</span>
        
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">session</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SESSIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">current_time</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">session</span>
        
        <span class="k">return</span> <span class="s1">&#39;closed&#39;</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_regular_hours</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if regular market hours.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">current_session</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;regular&#39;</span>

<span class="c1"># Check current session</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current session: </span><span class="si">{</span><span class="n">MarketHours</span><span class="o">.</span><span class="n">current_session</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regular hours: </span><span class="si">{</span><span class="n">MarketHours</span><span class="o">.</span><span class="n">is_regular_hours</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.3 Order Types</h2>
<p>Understanding order types is essential for controlling trade execution.</p>
<h3>Market Order</h3>
<ul>
<li><strong>What:</strong> Execute immediately at best available price</li>
<li><strong>Pros:</strong> Guaranteed execution</li>
<li><strong>Cons:</strong> No price guarantee (slippage risk)</li>
<li><strong>Use when:</strong> You need to enter/exit quickly</li>
</ul>
<h3>Limit Order</h3>
<ul>
<li><strong>What:</strong> Execute only at specified price or better</li>
<li><strong>Pros:</strong> Price control</li>
<li><strong>Cons:</strong> May not fill</li>
<li><strong>Use when:</strong> You have a specific entry/exit price</li>
</ul>
<h3>Stop Order</h3>
<ul>
<li><strong>What:</strong> Becomes market order when stop price is reached</li>
<li><strong>Pros:</strong> Protects against large losses</li>
<li><strong>Cons:</strong> Can trigger on temporary spikes</li>
<li><strong>Use when:</strong> Setting stop losses</li>
</ul>
<h3>Stop-Limit Order</h3>
<ul>
<li><strong>What:</strong> Becomes limit order when stop price is reached</li>
<li><strong>Pros:</strong> Price protection after trigger</li>
<li><strong>Cons:</strong> May not fill in fast markets</li>
<li><strong>Use when:</strong> You want stop protection with price limit</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">OrderType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">MARKET</span> <span class="o">=</span> <span class="s1">&#39;market&#39;</span>
    <span class="n">LIMIT</span> <span class="o">=</span> <span class="s1">&#39;limit&#39;</span>
    <span class="n">STOP</span> <span class="o">=</span> <span class="s1">&#39;stop&#39;</span>
    <span class="n">STOP_LIMIT</span> <span class="o">=</span> <span class="s1">&#39;stop_limit&#39;</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Represents a stock order.&quot;&quot;&quot;</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">order_type</span><span class="p">:</span> <span class="n">OrderType</span>
    <span class="n">side</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;buy&#39; or &#39;sell&#39;</span>
    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">limit_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stop_price</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">side</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;@ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;limit $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_price</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;stop $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

<span class="c1"># Example orders</span>
<span class="n">orders</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Order</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="n">Order</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mf">250.00</span><span class="p">),</span>
    <span class="n">Order</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">STOP</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">stop_price</span><span class="o">=</span><span class="mf">240.00</span><span class="p">),</span>
    <span class="n">Order</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">STOP_LIMIT</span><span class="p">,</span> <span class="s1">&#39;sell&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mf">239.00</span><span class="p">,</span> <span class="n">stop_price</span><span class="o">=</span><span class="mf">240.00</span><span class="p">)</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example Orders:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.4 Bid-Ask Spread</h2>
<p>The <strong>bid-ask spread</strong> is the difference between:
- <strong>Bid:</strong> Highest price buyers are willing to pay
- <strong>Ask:</strong> Lowest price sellers are willing to accept</p>
<h3>Why It Matters</h3>
<ol>
<li><strong>Transaction Cost:</strong> You pay the spread on every trade</li>
<li><strong>Liquidity Indicator:</strong> Tight spreads = high liquidity</li>
<li><strong>Profitability Hurdle:</strong> You must overcome the spread to profit</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Quote</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Stock quote with bid-ask spread analysis.&quot;&quot;&quot;</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">bid</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">ask</span><span class="p">:</span> <span class="nb">float</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Absolute spread in dollars.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bid</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Mid price.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bid</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spread_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Spread as percentage of mid price.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spread</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">round_trip_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shares</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate cost of buying then selling immediately.</span>
<span class="sd">        This represents the minimum cost to trade.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buy_cost</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span>
        <span class="n">sell_proceeds</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bid</span>
        <span class="n">spread_cost</span> <span class="o">=</span> <span class="n">buy_cost</span> <span class="o">-</span> <span class="n">sell_proceeds</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;buy_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask</span><span class="p">,</span>
            <span class="s1">&#39;sell_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bid</span><span class="p">,</span>
            <span class="s1">&#39;spread_cost&#39;</span><span class="p">:</span> <span class="n">spread_cost</span><span class="p">,</span>
            <span class="s1">&#39;cost_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">spread_cost</span> <span class="o">/</span> <span class="n">buy_cost</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>

<span class="c1"># Compare liquid vs less liquid stocks</span>
<span class="n">quotes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Quote</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="mf">259.50</span><span class="p">,</span> <span class="mf">259.52</span><span class="p">),</span>    <span class="c1"># Very liquid</span>
    <span class="n">Quote</span><span class="p">(</span><span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="mf">321.80</span><span class="p">,</span> <span class="mf">321.95</span><span class="p">),</span>   <span class="c1"># Liquid</span>
    <span class="n">Quote</span><span class="p">(</span><span class="s1">&#39;SMALL&#39;</span><span class="p">,</span> <span class="mf">12.40</span><span class="p">,</span> <span class="mf">12.60</span><span class="p">),</span>     <span class="c1"># Less liquid (example)</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spread Comparison (100 shares):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quotes</span><span class="p">:</span>
    <span class="n">rt</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">round_trip_cost</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Spread: $</span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">spread</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">spread_pct</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Round-trip cost: $</span><span class="si">{</span><span class="n">rt</span><span class="p">[</span><span class="s1">&#39;spread_cost&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 1.1: Trading Cost Calculator (Guided)</h3>
<p>Complete the function to calculate total trading costs including spread and commission.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_trading_costs</span><span class="p">(</span><span class="n">bid</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ask</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">shares</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                           <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate total cost of a round-trip trade.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        bid: Current bid price</span>
<span class="sd">        ask: Current ask price</span>
<span class="sd">        shares: Number of shares to trade</span>
<span class="sd">        commission: Per-trade commission (applied to buy AND sell)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict with:</span>
<span class="sd">        - spread_cost: Cost due to bid-ask spread</span>
<span class="sd">        - commission_cost: Total commission (2 x commission)</span>
<span class="sd">        - total_cost: spread_cost + commission_cost</span>
<span class="sd">        - breakeven_move_pct: % price must move to break even</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate buy cost (shares x ask price)</span>
    <span class="n">buy_cost</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Your code here</span>
    
    <span class="c1"># TODO: Calculate sell proceeds (shares x bid price)</span>
    <span class="n">sell_proceeds</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Your code here</span>
    
    <span class="c1"># TODO: Calculate spread cost (buy_cost - sell_proceeds)</span>
    <span class="n">spread_cost</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Your code here</span>
    
    <span class="c1"># TODO: Calculate total commission (commission x 2)</span>
    <span class="n">commission_cost</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Your code here</span>
    
    <span class="c1"># TODO: Calculate total cost</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Your code here</span>
    
    <span class="c1"># TODO: Calculate breakeven move percentage</span>
    <span class="c1"># (total_cost / buy_cost) x 100</span>
    <span class="n">breakeven_move_pct</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Your code here</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;spread_cost&#39;</span><span class="p">:</span> <span class="n">spread_cost</span><span class="p">,</span>
        <span class="s1">&#39;commission_cost&#39;</span><span class="p">:</span> <span class="n">commission_cost</span><span class="p">,</span>
        <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
        <span class="s1">&#39;breakeven_move_pct&#39;</span><span class="p">:</span> <span class="n">breakeven_move_pct</span>
    <span class="p">}</span>

<span class="c1"># Test your function</span>
<span class="c1"># result = calculate_trading_costs(50.00, 50.10, 100, commission=1.00)</span>
<span class="c1"># Expected: spread_cost=10.00, commission_cost=2.00, total_cost=12.00</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_trading_costs</span><span class="p">(</span><span class="n">bid</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ask</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">shares</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                           <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">buy_cost</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">*</span> <span class="n">ask</span>
    <span class="n">sell_proceeds</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">*</span> <span class="n">bid</span>
    <span class="n">spread_cost</span> <span class="o">=</span> <span class="n">buy_cost</span> <span class="o">-</span> <span class="n">sell_proceeds</span>
    <span class="n">commission_cost</span> <span class="o">=</span> <span class="n">commission</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="n">spread_cost</span> <span class="o">+</span> <span class="n">commission_cost</span>
    <span class="n">breakeven_move_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_cost</span> <span class="o">/</span> <span class="n">buy_cost</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;spread_cost&#39;</span><span class="p">:</span> <span class="n">spread_cost</span><span class="p">,</span>
        <span class="s1">&#39;commission_cost&#39;</span><span class="p">:</span> <span class="n">commission_cost</span><span class="p">,</span>
        <span class="s1">&#39;total_cost&#39;</span><span class="p">:</span> <span class="n">total_cost</span><span class="p">,</span>
        <span class="s1">&#39;breakeven_move_pct&#39;</span><span class="p">:</span> <span class="n">breakeven_move_pct</span>
    <span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_trading_costs</span><span class="p">(</span><span class="mf">50.00</span><span class="p">,</span> <span class="mf">50.10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">commission</span><span class="o">=</span><span class="mf">1.00</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spread cost: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;spread_cost&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Commission: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;commission_cost&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total cost: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;total_cost&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Need </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;breakeven_move_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% move to break even&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Stock Data with yfinance</h1>
<h2>2.1 Introduction to yfinance</h2>
<p><strong>yfinance</strong> is a popular Python library for downloading financial data from Yahoo Finance. It provides:</p>
<ul>
<li>Historical price data (OHLCV)</li>
<li>Company fundamentals</li>
<li>Financial statements</li>
<li>Options data</li>
</ul>
<h3>Key Usage Patterns</h3>
<ol>
<li><strong>Single stock:</strong> Use <code>yf.Ticker(symbol).history()</code> - returns clean DataFrames</li>
<li><strong>Multiple stocks:</strong> Use <code>yf.download()</code> - efficient bulk download</li>
</ol>
<p><strong>Note:</strong> Pin the version for stability: <code>pip install yfinance==1.0</code></p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Single stock using Ticker.history()</span>
<span class="n">aapl</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>

<span class="c1"># Basic info</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">aapl</span><span class="o">.</span><span class="n">info</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Company: </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;longName&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sector: </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sector&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Industry: </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;industry&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Market Cap: $</span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marketCap&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e12</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">T&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Price: $</span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentPrice&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.2 OHLCV Data</h2>
<p><strong>OHLCV</strong> stands for:
- <strong>O</strong>pen: First trade price of the period
- <strong>H</strong>igh: Highest trade price of the period
- <strong>L</strong>ow: Lowest trade price of the period
- <strong>C</strong>lose: Last trade price of the period
- <strong>V</strong>olume: Number of shares traded</p>
<p>This is the fundamental data format for price analysis.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download historical data using Ticker.history()</span>
<span class="c1"># period options: 1d, 5d, 1mo, 3mo, 6mo, 1y, 2y, 5y, 10y, ytd, max</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">aapl</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1mo&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="s2"> days of data&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columns: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recent prices:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">[[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download data for specific date range</span>
<span class="n">history_range</span> <span class="o">=</span> <span class="n">aapl</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2024-06-30&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Date range: </span><span class="si">{</span><span class="n">history_range</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">history_range</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trading days: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">history_range</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.3 Downloading Multiple Stocks</h2>
<p>For portfolio analysis, we often need data for multiple stocks simultaneously.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Download multiple stocks at once using yf.download()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">FAANG</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s1">&#39;3mo&#39;</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data shape: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Extract just closing prices</span>
<span class="n">close_prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Closing prices shape: </span><span class="si">{</span><span class="n">close_prices</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">close_prices</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Calculate daily returns</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">close_prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Summary statistics</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Mean Daily Return (%)&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s1">&#39;Daily Volatility (%)&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s1">&#39;Annualized Return (%)&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s1">&#39;Annualized Vol (%)&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="p">})</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FAANG Return Summary&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 1.2: Stock Data Fetcher Class (Open-ended)</h3>
<p>Build a reusable class for fetching stock data.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">StockDataFetcher</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch and process stock data from yfinance.</span>
<span class="sd">    </span>
<span class="sd">    Requirements:</span>
<span class="sd">    1. Initialize with a list of symbols</span>
<span class="sd">    2. Method to get historical prices (use yf.download for multiple)</span>
<span class="sd">    3. Method to get company info (use yf.Ticker for single)</span>
<span class="sd">    4. Method to calculate returns</span>
<span class="sd">    5. Method to get summary statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># TODO: Store symbols and initialize data storage</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">fetch_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1y&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: Download closing prices for all symbols using yf.download()</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">fetch_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># TODO: Get company info for a single symbol using yf.Ticker()</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: Calculate daily returns</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: Return summary stats (mean, std, sharpe, etc.)</span>
        <span class="k">pass</span>

<span class="c1"># Test your implementation</span>
<span class="c1"># fetcher = StockDataFetcher(FAANG)</span>
<span class="c1"># fetcher.fetch_prices(&#39;3mo&#39;)</span>
<span class="c1"># print(fetcher.get_summary())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StockDataFetcher</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fetch and process stock data from yfinance.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">fetch_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1y&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Download closing prices for all symbols.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span>

    <span class="k">def</span> <span class="nf">fetch_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get company info for a single symbol.&quot;&quot;&quot;</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">info</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;longName&#39;</span><span class="p">),</span>
            <span class="s1">&#39;sector&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sector&#39;</span><span class="p">),</span>
            <span class="s1">&#39;market_cap&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marketCap&#39;</span><span class="p">),</span>
            <span class="s1">&#39;pe_ratio&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trailingPE&#39;</span><span class="p">),</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentPrice&#39;</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">calculate_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate daily returns.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_prices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span>

    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return summary statistics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_returns</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;Total Return (%)&#39;</span><span class="p">:</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;Ann. Return (%)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;Ann. Vol (%)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;Sharpe&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
        <span class="p">})</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">fetcher</span> <span class="o">=</span> <span class="n">StockDataFetcher</span><span class="p">(</span><span class="n">FAANG</span><span class="p">)</span>
<span class="n">fetcher</span><span class="o">.</span><span class="n">fetch_prices</span><span class="p">(</span><span class="s1">&#39;3mo&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fetcher</span><span class="o">.</span><span class="n">get_summary</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Adjusted Prices and Corporate Actions</h1>
<h2>3.1 Why Adjusted Prices Matter</h2>
<p><strong>Raw (unadjusted) prices</strong> don't account for corporate actions like:
- Stock splits
- Dividends
- Rights offerings</p>
<p><strong>Adjusted prices</strong> modify historical prices to maintain comparability.</p>
<h3>Example: 2-for-1 Stock Split</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Day</th>
<th>Unadjusted</th>
<th>Adjusted</th>
<th>What Happened</th>
</tr>
</thead>
<tbody>
<tr>
<td>Day 1</td>
<td>$200</td>
<td>$100</td>
<td>Pre-split</td>
</tr>
<tr>
<td>Day 2</td>
<td>$204</td>
<td>$102</td>
<td>Pre-split</td>
</tr>
<tr>
<td>Day 3</td>
<td>$102</td>
<td>$102</td>
<td>Split! Price halves, shares double</td>
</tr>
<tr>
<td>Day 4</td>
<td>$104</td>
<td>$104</td>
<td>Post-split</td>
</tr>
</tbody>
</table></div>
<p>Without adjustment, it looks like the stock dropped 50%!</p>
<p><strong>Rule:</strong> Always use adjusted prices for return calculations.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># yfinance provides adjusted data by default</span>
<span class="c1"># The &#39;Close&#39; column in Ticker.history() is adjusted</span>

<span class="c1"># Check for historical splits</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">splits</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AAPL Stock Split History:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">splits</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Check dividend history</span>
<span class="n">dividends</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">dividends</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">AAPL Dividend History (last 10):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dividends</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 1.3: Corporate Action Analyzer (Guided)</h3>
<p>Complete the class to analyze corporate actions.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">CorporateActionAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze corporate actions for a stock.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get stock split history.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Return self.ticker.splits</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_dividends</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get dividend history.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Return self.ticker.dividends</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">annual_dividend_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate trailing 12-month dividend yield.</span>
<span class="sd">        Yield = (Sum of last year&#39;s dividends) / Current Price x 100</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Get dividends from last year</span>
        <span class="c1"># TODO: Sum them and divide by current price</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return summary of corporate actions.&quot;&quot;&quot;</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_splits</span><span class="p">()</span>
        <span class="n">dividends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dividends</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_splits&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">),</span>
            <span class="s1">&#39;last_split&#39;</span><span class="p">:</span> <span class="n">splits</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;total_dividends&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dividends</span><span class="p">),</span>
            <span class="s1">&#39;annual_dividend_yield&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annual_dividend_yield</span><span class="p">()</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="c1"># analyzer = CorporateActionAnalyzer(&#39;AAPL&#39;)</span>
<span class="c1"># print(analyzer.summary())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CorporateActionAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze corporate actions for a stock.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get stock split history.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">splits</span>

    <span class="k">def</span> <span class="nf">get_dividends</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get dividend history.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">dividends</span>

    <span class="k">def</span> <span class="nf">annual_dividend_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate trailing 12-month dividend yield.&quot;&quot;&quot;</span>
        <span class="n">dividends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dividends</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dividends</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># Get dividends from last 365 days</span>
        <span class="n">one_year_ago</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>
        <span class="n">recent_divs</span> <span class="o">=</span> <span class="n">dividends</span><span class="p">[</span><span class="n">dividends</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">one_year_ago</span><span class="p">]</span>

        <span class="n">annual_div</span> <span class="o">=</span> <span class="n">recent_divs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">current_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentPrice&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">round</span><span class="p">((</span><span class="n">annual_div</span> <span class="o">/</span> <span class="n">current_price</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return summary of corporate actions.&quot;&quot;&quot;</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_splits</span><span class="p">()</span>
        <span class="n">dividends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dividends</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_splits&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">),</span>
            <span class="s1">&#39;last_split&#39;</span><span class="p">:</span> <span class="n">splits</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;total_dividends&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dividends</span><span class="p">),</span>
            <span class="s1">&#39;annual_dividend_yield&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annual_dividend_yield</span><span class="p">()</span>
        <span class="p">}</span>

<span class="n">analyzer</span> <span class="o">=</span> <span class="n">CorporateActionAnalyzer</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AAPL Corporate Actions:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Data Quality</h1>
<h2>4.1 Common Data Issues</h2>
<p>When working with stock data, watch for:</p>
<ol>
<li><strong>Missing Data:</strong> Gaps in price history</li>
<li><strong>Corporate Actions:</strong> Splits, dividends affecting prices</li>
<li><strong>Outliers:</strong> Erroneous data points</li>
<li><strong>OHLC Consistency:</strong> High &gt;= Low, etc.</li>
</ol>
<h2>4.2 Data Validation</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">validate_stock_data</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate stock data quality.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with OHLCV data</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict with validation results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Check for missing values</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">missing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing values: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check for zero or negative prices</span>
    <span class="k">if</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">invalid_prices</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">invalid_prices</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid prices: </span><span class="si">{</span><span class="n">invalid_prices</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check for extreme daily moves (&gt;20%)</span>
    <span class="k">if</span> <span class="s1">&#39;Close&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">extreme_moves</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">extreme_moves</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extreme moves (&gt;20%): </span><span class="si">{</span><span class="n">extreme_moves</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check OHLC consistency</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]):</span>
        <span class="n">inconsistent</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">])</span> <span class="o">|</span> 
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">|</span> 
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span> <span class="o">|</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">|</span> 
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">inconsistent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">issues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OHLC inconsistencies: </span><span class="si">{</span><span class="n">inconsistent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
        <span class="s1">&#39;date_range&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;issues&#39;</span><span class="p">:</span> <span class="n">issues</span>
    <span class="p">}</span>

<span class="c1"># Test validation</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
<span class="n">validation</span> <span class="o">=</span> <span class="n">validate_stock_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data Validation Results:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">validation</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 1.4: Robust Data Fetcher (Open-ended)</h3>
<p>Build a data fetcher with validation and error handling.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">RobustDataFetcher</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Robust stock data fetcher with validation.</span>
<span class="sd">    </span>
<span class="sd">    Requirements:</span>
<span class="sd">    1. Handle download errors gracefully</span>
<span class="sd">    2. Validate data after download</span>
<span class="sd">    3. Fill small gaps (up to 5 days)</span>
<span class="sd">    4. Log any issues found</span>
<span class="sd">    5. Return clean data or skip if invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1y&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># TODO: Implement robust fetching using yf.Ticker().history()</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># TODO: Implement validation (check missing %, invalid prices)</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: Clean data (forward fill gaps up to 5 days)</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># TODO: Return summary of fetched data and any errors</span>
        <span class="k">pass</span>

<span class="c1"># Test with some valid and invalid symbols</span>
<span class="c1"># fetcher = RobustDataFetcher(FAANG + [&#39;INVALID_XYZ&#39;])</span>
<span class="c1"># fetcher.fetch(&#39;3mo&#39;)</span>
<span class="c1"># print(fetcher.get_report())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RobustDataFetcher</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Robust stock data fetcher with validation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1y&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch data for all symbols with error handling.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: No data returned&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: Validation failed&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate data quality.&quot;&quot;&quot;</span>
        <span class="c1"># Check for too much missing data (&gt;10%)</span>
        <span class="n">missing_pct</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">missing_pct</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check for valid prices</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clean data by filling small gaps.&quot;&quot;&quot;</span>
        <span class="c1"># Forward fill gaps up to 5 days</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1"># Backward fill any remaining at start</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return summary report.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;requested&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">),</span>
            <span class="s1">&#39;successful&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;failed&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">),</span>
            <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span>
        <span class="p">}</span>

<span class="n">fetcher</span> <span class="o">=</span> <span class="n">RobustDataFetcher</span><span class="p">(</span><span class="n">FAANG</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;INVALID_XYZ&#39;</span><span class="p">])</span>
<span class="n">fetcher</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;3mo&#39;</span><span class="p">)</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">fetcher</span><span class="o">.</span><span class="n">get_report</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fetch Report:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h1>Module Project: Stock Data Pipeline</h1>
<p>Build a complete data pipeline that:
1. Fetches data for multiple stocks
2. Validates data quality
3. Calculates basic statistics
4. Provides a summary report</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">StockDataPipeline</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete stock data pipeline.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Fetch OHLCV data for multiple stocks</span>
<span class="sd">    - Validate and clean data</span>
<span class="sd">    - Calculate returns and statistics</span>
<span class="sd">    - Generate summary report</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1y&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;StockDataPipeline&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute the full pipeline.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_and_clean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_stats</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch raw data using Ticker.history() for clean output.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_validate_and_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate and clean data.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Clean: forward fill small gaps</span>
            <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            
            <span class="c1"># Validate: must have data and valid prices</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clean</span>
    
    <span class="k">def</span> <span class="nf">_calculate_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate statistics for each stock.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">returns</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;start_price&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;end_price&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_drawdown</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s1">&#39;trading_days&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_max_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate maximum drawdown.&quot;&quot;&quot;</span>
        <span class="n">cummax</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span> <span class="o">-</span> <span class="n">cummax</span><span class="p">)</span> <span class="o">/</span> <span class="n">cummax</span>
        <span class="k">return</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return summary DataFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return DataFrame of closing prices.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test the pipeline</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">StockDataPipeline</span><span class="p">(</span><span class="n">FAANG</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;6mo&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pipeline Summary:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">get_summary</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Prices shape: </span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">get_prices</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 1.5: Extend the Pipeline (Open-ended)</h3>
<p>Add the following features to the pipeline:</p>
<ol>
<li>Method to calculate correlation matrix</li>
<li>Method to identify best/worst performing stock</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your extension code here</span>
<span class="c1"># Hint: Add methods correlation_matrix() and best_worst_performers() to StockDataPipeline</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 1.6: Mini-Analysis (Open-ended)</h3>
<p>Using the pipeline, answer:
1. Which FAANG stock had the highest return over the last 6 months?
2. Which had the lowest volatility?
3. Which had the smallest maximum drawdown?</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your analysis code here</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>Exchanges:</strong> NYSE (traditional) vs NASDAQ (electronic, tech-focused)</li>
<li><strong>Market Hours:</strong> Regular 9:30 AM - 4:00 PM ET has best liquidity</li>
<li><strong>Order Types:</strong> Market (speed) vs Limit (price control)</li>
<li><strong>Bid-Ask Spread:</strong> Transaction cost, narrower = more liquid</li>
<li><strong>yfinance Patterns:</strong></li>
<li>Single stock: <code>yf.Ticker(symbol).history()</code></li>
<li>Multiple stocks: <code>yf.download(symbols)</code></li>
<li><strong>Adjusted Prices:</strong> Always use for return calculations</li>
<li><strong>Data Quality:</strong> Validate before analysis</li>
</ol>
<hr />
<p><strong>Next Module:</strong> Fundamental Analysis</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="2"><div class="md-cell module-header"><h1>Module 2: Fundamental Analysis</h1>
<h2>Part 1: Stock Market Foundations</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Module 1</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Read and interpret the three main financial statements</li>
<li>Calculate and analyze key financial ratios</li>
<li>Perform company valuation using multiple metrics</li>
<li>Compare companies within sectors using peer analysis</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Required imports</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Our consistent stock universe</span>
<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stock universe: </span><span class="si">{</span><span class="n">FAANG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: Financial Statements</h1>
<h2>1.1 The Three Financial Statements</h2>
<p>Every public company reports three main financial statements:</p>
<h3>Income Statement (Profit &amp; Loss)</h3>
<p>Shows profitability over a period (quarterly/annually).</p>
<p><strong>Key items:</strong>
- <strong>Revenue (Sales):</strong> Total money earned from business operations
- <strong>Cost of Revenue (COGS):</strong> Direct costs to produce goods/services
- <strong>Gross Profit:</strong> Revenue - COGS
- <strong>Operating Expenses:</strong> R&amp;D, Sales &amp; Marketing, General &amp; Admin
- <strong>Operating Income (EBIT):</strong> Gross Profit - Operating Expenses
- <strong>Net Income:</strong> Final profit after all expenses and taxes</p>
<h3>Balance Sheet</h3>
<p>Shows what a company owns and owes at a specific point in time.</p>
<p><strong>Key items:</strong>
- <strong>Assets:</strong> Cash, inventory, property, equipment
- <strong>Liabilities:</strong> Debts, accounts payable, loans
- <strong>Equity:</strong> Assets - Liabilities (shareholders' stake)</p>
<h3>Cash Flow Statement</h3>
<p>Shows actual cash moving in and out.</p>
<p><strong>Key sections:</strong>
- <strong>Operating Activities:</strong> Cash from core business
- <strong>Investing Activities:</strong> Cash for/from investments, acquisitions
- <strong>Financing Activities:</strong> Cash from/to shareholders, debt</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Fetch financial statements for Apple</span>
<span class="n">aapl</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>

<span class="c1"># Income Statement</span>
<span class="n">income_stmt</span> <span class="o">=</span> <span class="n">aapl</span><span class="o">.</span><span class="n">income_stmt</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Income Statement Shape:&quot;</span><span class="p">,</span> <span class="n">income_stmt</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Years available:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">income_stmt</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
<span class="nb">print</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Key income statement items</span>
<span class="n">key_items</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Total Revenue&#39;</span><span class="p">,</span> <span class="s1">&#39;Gross Profit&#39;</span><span class="p">,</span> <span class="s1">&#39;Operating Income&#39;</span><span class="p">,</span> <span class="s1">&#39;Net Income&#39;</span><span class="p">]</span>

<span class="c1"># Filter to key items that exist</span>
<span class="n">available_items</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">key_items</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">income_stmt</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">income_summary</span> <span class="o">=</span> <span class="n">income_stmt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">available_items</span><span class="p">]</span>

<span class="c1"># Format in billions</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AAPL Income Statement (in billions):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">((</span><span class="n">income_summary</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Balance Sheet</span>
<span class="n">balance_sheet</span> <span class="o">=</span> <span class="n">aapl</span><span class="o">.</span><span class="n">balance_sheet</span>

<span class="n">balance_items</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Total Assets&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Liabilities Net Minority Interest&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;Total Debt&#39;</span><span class="p">,</span> <span class="s1">&#39;Cash And Cash Equivalents&#39;</span><span class="p">,</span> <span class="s1">&#39;Stockholders Equity&#39;</span><span class="p">]</span>
<span class="n">available_balance</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">balance_items</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">balance_sheet</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AAPL Balance Sheet (in billions):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">((</span><span class="n">balance_sheet</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">available_balance</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Cash Flow Statement</span>
<span class="n">cashflow</span> <span class="o">=</span> <span class="n">aapl</span><span class="o">.</span><span class="n">cashflow</span>

<span class="n">cf_items</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Operating Cash Flow&#39;</span><span class="p">,</span> <span class="s1">&#39;Free Cash Flow&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;Capital Expenditure&#39;</span><span class="p">,</span> <span class="s1">&#39;Repurchase Of Capital Stock&#39;</span><span class="p">]</span>
<span class="n">available_cf</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cf_items</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cashflow</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AAPL Cash Flow (in billions):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">((</span><span class="n">cashflow</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">available_cf</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 2.1: Financial Statement Extractor (Guided)</h3>
<p>Build a class to extract key financial data from statements.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">FinancialStatements</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Extract and organize financial statement data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_revenue_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get revenue for available years.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Return &#39;Total Revenue&#39; row from income_stmt</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_profit_margins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate profit margins for each year.</span>
<span class="sd">        Returns: gross_margin, operating_margin, net_margin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Calculate margins as percentages</span>
        <span class="c1"># gross_margin = Gross Profit / Total Revenue</span>
        <span class="c1"># operating_margin = Operating Income / Total Revenue</span>
        <span class="c1"># net_margin = Net Income / Total Revenue</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_debt_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current debt information.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Extract total debt and cash from most recent balance sheet</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># fs = FinancialStatements(&#39;AAPL&#39;)</span>
<span class="c1"># print(fs.get_profit_margins())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FinancialStatements</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Extract and organize financial statement data.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_revenue_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get revenue for available years.&quot;&quot;&quot;</span>
        <span class="n">income</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">income_stmt</span>
        <span class="k">if</span> <span class="s1">&#39;Total Revenue&#39;</span> <span class="ow">in</span> <span class="n">income</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">income</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Total Revenue&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_profit_margins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate profit margins for each year.&quot;&quot;&quot;</span>
        <span class="n">income</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">income_stmt</span>

        <span class="n">revenue</span> <span class="o">=</span> <span class="n">income</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Total Revenue&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Total Revenue&#39;</span> <span class="ow">in</span> <span class="n">income</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">revenue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">margins</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;Gross Profit&#39;</span> <span class="ow">in</span> <span class="n">income</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">margins</span><span class="p">[</span><span class="s1">&#39;gross_margin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Gross Profit&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">revenue</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;Operating Income&#39;</span> <span class="ow">in</span> <span class="n">income</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">margins</span><span class="p">[</span><span class="s1">&#39;operating_margin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Operating Income&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">revenue</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;Net Income&#39;</span> <span class="ow">in</span> <span class="n">income</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">margins</span><span class="p">[</span><span class="s1">&#39;net_margin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">income</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Net Income&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">revenue</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">margins</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_debt_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current debt information.&quot;&quot;&quot;</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">balance_sheet</span>

        <span class="c1"># Get most recent column</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">balance</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_debt&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Total Debt&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;cash&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cash And Cash Equivalents&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;net_debt&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Total Debt&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">latest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cash And Cash Equivalents&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>

<span class="n">fs</span> <span class="o">=</span> <span class="n">FinancialStatements</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Profit Margins (%):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_profit_margins</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Debt Info:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_debt_info</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">v</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">B&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Financial Ratios</h1>
<h2>2.1 Categories of Financial Ratios</h2>
<p>Financial ratios help evaluate company performance across different dimensions:</p>
<h3>Profitability Ratios</h3>
<p>Measure how efficiently a company generates profit.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Ratio</th>
<th>Formula</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gross Margin</td>
<td>Gross Profit / Revenue</td>
<td>Pricing power, production efficiency</td>
</tr>
<tr>
<td>Operating Margin</td>
<td>Operating Income / Revenue</td>
<td>Operational efficiency</td>
</tr>
<tr>
<td>Net Margin</td>
<td>Net Income / Revenue</td>
<td>Overall profitability</td>
</tr>
<tr>
<td>ROE</td>
<td>Net Income / Equity</td>
<td>Return to shareholders</td>
</tr>
<tr>
<td>ROA</td>
<td>Net Income / Assets</td>
<td>Asset utilization</td>
</tr>
</tbody>
</table></div>
<h3>Valuation Ratios</h3>
<p>Compare price to fundamental value.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Ratio</th>
<th>Formula</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td>P/E</td>
<td>Price / EPS</td>
<td>Earnings multiple</td>
</tr>
<tr>
<td>P/B</td>
<td>Price / Book Value</td>
<td>Asset-based valuation</td>
</tr>
<tr>
<td>P/S</td>
<td>Price / Sales per share</td>
<td>Revenue multiple</td>
</tr>
<tr>
<td>EV/EBITDA</td>
<td>Enterprise Value / EBITDA</td>
<td>Acquisition multiple</td>
</tr>
</tbody>
</table></div>
<h3>Leverage Ratios</h3>
<p>Measure financial risk from debt.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Ratio</th>
<th>Formula</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td>D/E</td>
<td>Total Debt / Equity</td>
<td>Debt vs. ownership</td>
</tr>
<tr>
<td>Current Ratio</td>
<td>Current Assets / Current Liabilities</td>
<td>Short-term liquidity</td>
</tr>
<tr>
<td>Quick Ratio</td>
<td>(Current Assets - Inventory) / Current Liabilities</td>
<td>Immediate liquidity</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">FinancialRatios</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate financial ratios from yfinance data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">info</span>
    
    <span class="k">def</span> <span class="nf">profitability_ratios</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get profitability ratios.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;gross_margin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grossMargins&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;operating_margin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;operatingMargins&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;net_margin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profitMargins&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;roe&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;returnOnEquity&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;roa&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;returnOnAssets&#39;</span><span class="p">))</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">valuation_ratios</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get valuation ratios.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pe_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trailingPE&#39;</span><span class="p">),</span>
            <span class="s1">&#39;forward_pe&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;forwardPE&#39;</span><span class="p">),</span>
            <span class="s1">&#39;pb_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priceToBook&#39;</span><span class="p">),</span>
            <span class="s1">&#39;ps_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priceToSalesTrailing12Months&#39;</span><span class="p">),</span>
            <span class="s1">&#39;peg_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pegRatio&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">leverage_ratios</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get leverage ratios.&quot;&quot;&quot;</span>
        <span class="n">de</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debtToEquity&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;debt_to_equity&#39;</span><span class="p">:</span> <span class="n">de</span> <span class="o">/</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">de</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># yfinance returns as %</span>
            <span class="s1">&#39;current_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentRatio&#39;</span><span class="p">),</span>
            <span class="s1">&#39;quick_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quickRatio&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">all_ratios</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get all ratios combined.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">profitability_ratios</span><span class="p">(),</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">valuation_ratios</span><span class="p">(),</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">leverage_ratios</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert decimal to percentage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">ratios</span> <span class="o">=</span> <span class="n">FinancialRatios</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AAPL Profitability Ratios:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ratios</span><span class="o">.</span><span class="n">profitability_ratios</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">%&quot;</span> <span class="k">if</span> <span class="n">v</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: N/A&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">AAPL Valuation Ratios:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ratios</span><span class="o">.</span><span class="n">valuation_ratios</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">v</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: N/A&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 2.2: Ratio Comparison Tool (Open-ended)</h3>
<p>Build a tool to compare ratios across multiple stocks.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">RatioComparison</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare financial ratios across multiple stocks.</span>
<span class="sd">    </span>
<span class="sd">    Requirements:</span>
<span class="sd">    1. Fetch ratios for multiple symbols</span>
<span class="sd">    2. Create comparison DataFrame</span>
<span class="sd">    3. Identify best/worst in each category</span>
<span class="sd">    4. Calculate sector averages</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">fetch_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Fetch ratios for all symbols</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;valuation&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: Return comparison DataFrame</span>
        <span class="c1"># ratio_type: &#39;profitability&#39;, &#39;valuation&#39;, &#39;leverage&#39;</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">best_in_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">higher_is_better</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># TODO: Return symbol with best ratio</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># comp = RatioComparison(FAANG)</span>
<span class="c1"># comp.fetch_all()</span>
<span class="c1"># print(comp.compare(&#39;valuation&#39;))</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RatioComparison</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compare financial ratios across multiple stocks.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">fetch_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch ratios for all symbols.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fr</span> <span class="o">=</span> <span class="n">FinancialRatios</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">all_ratios</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;valuation&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return comparison DataFrame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">()</span>

        <span class="c1"># Define ratio groups</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;profitability&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gross_margin&#39;</span><span class="p">,</span> <span class="s1">&#39;operating_margin&#39;</span><span class="p">,</span> <span class="s1">&#39;net_margin&#39;</span><span class="p">,</span> <span class="s1">&#39;roe&#39;</span><span class="p">,</span> <span class="s1">&#39;roa&#39;</span><span class="p">],</span>
            <span class="s1">&#39;valuation&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;forward_pe&#39;</span><span class="p">,</span> <span class="s1">&#39;pb_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;ps_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;peg_ratio&#39;</span><span class="p">],</span>
            <span class="s1">&#39;leverage&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;debt_to_equity&#39;</span><span class="p">,</span> <span class="s1">&#39;current_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;quick_ratio&#39;</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="n">ratios</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ratio_type</span><span class="p">,</span> <span class="n">groups</span><span class="p">[</span><span class="s1">&#39;valuation&#39;</span><span class="p">])</span>

        <span class="c1"># Build comparison</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ratios</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">best_in_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">higher_is_better</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return symbol with best ratio.&quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">higher_is_better</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>

<span class="n">comp</span> <span class="o">=</span> <span class="n">RatioComparison</span><span class="p">(</span><span class="n">FAANG</span><span class="p">)</span>
<span class="n">comp</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Valuation Comparison:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="s1">&#39;valuation&#39;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Lowest P/E: </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">best_in_category</span><span class="p">(</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="n">higher_is_better</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Highest Net Margin: </span><span class="si">{</span><span class="n">comp</span><span class="o">.</span><span class="n">best_in_category</span><span class="p">(</span><span class="s1">&#39;net_margin&#39;</span><span class="p">,</span> <span class="n">higher_is_better</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Company Valuation</h1>
<h2>3.1 Key Valuation Metrics</h2>
<h3>Market Capitalization</h3>
<p>Total market value of outstanding shares.</p>
<div class="highlight"><pre><span></span><code>Market Cap = Share Price √ó Shares Outstanding
</code></pre></div>

<p><strong>Market Cap Tiers:</strong>
- Mega Cap: &gt;$200B
- Large Cap: $10B - $200B
- Mid Cap: $2B - $10B
- Small Cap: $300M - $2B
- Micro Cap: &lt;$300M</p>
<h3>Enterprise Value (EV)</h3>
<p>Total value of a company including debt.</p>
<div class="highlight"><pre><span></span><code>EV = Market Cap + Total Debt - Cash
</code></pre></div>

<p>Enterprise Value is used for acquisition analysis because an acquirer must pay off debt and receives the cash.</p>
<h3>EV/EBITDA</h3>
<p>Enterprise Value relative to earnings before interest, taxes, depreciation, and amortization.</p>
<ul>
<li>Lower = potentially undervalued</li>
<li>Industry comparisons are most meaningful</li>
<li>Generally, EV/EBITDA &lt; 10 is considered cheap</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">Valuation</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Company valuation metrics.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">info</span>
    
    <span class="k">def</span> <span class="nf">market_cap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get market cap and tier.&quot;&quot;&quot;</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marketCap&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">cap</span> <span class="o">&gt;=</span> <span class="mf">200e9</span><span class="p">:</span>
            <span class="n">tier</span> <span class="o">=</span> <span class="s1">&#39;Mega Cap&#39;</span>
        <span class="k">elif</span> <span class="n">cap</span> <span class="o">&gt;=</span> <span class="mf">10e9</span><span class="p">:</span>
            <span class="n">tier</span> <span class="o">=</span> <span class="s1">&#39;Large Cap&#39;</span>
        <span class="k">elif</span> <span class="n">cap</span> <span class="o">&gt;=</span> <span class="mf">2e9</span><span class="p">:</span>
            <span class="n">tier</span> <span class="o">=</span> <span class="s1">&#39;Mid Cap&#39;</span>
        <span class="k">elif</span> <span class="n">cap</span> <span class="o">&gt;=</span> <span class="mf">300e6</span><span class="p">:</span>
            <span class="n">tier</span> <span class="o">=</span> <span class="s1">&#39;Small Cap&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tier</span> <span class="o">=</span> <span class="s1">&#39;Micro Cap&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;market_cap&#39;</span><span class="p">:</span> <span class="n">cap</span><span class="p">,</span>
            <span class="s1">&#39;market_cap_b&#39;</span><span class="p">:</span> <span class="n">cap</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
            <span class="s1">&#39;tier&#39;</span><span class="p">:</span> <span class="n">tier</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">enterprise_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate enterprise value.&quot;&quot;&quot;</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enterpriseValue&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;enterprise_value&#39;</span><span class="p">:</span> <span class="n">ev</span><span class="p">,</span>
            <span class="s1">&#39;enterprise_value_b&#39;</span><span class="p">:</span> <span class="n">ev</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
            <span class="s1">&#39;ev_to_revenue&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enterpriseToRevenue&#39;</span><span class="p">),</span>
            <span class="s1">&#39;ev_to_ebitda&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enterpriseToEbitda&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">earnings_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get earnings-based metrics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;trailing_eps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trailingEps&#39;</span><span class="p">),</span>
            <span class="s1">&#39;forward_eps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;forwardEps&#39;</span><span class="p">),</span>
            <span class="s1">&#39;pe_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trailingPE&#39;</span><span class="p">),</span>
            <span class="s1">&#39;forward_pe&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;forwardPE&#39;</span><span class="p">),</span>
            <span class="s1">&#39;peg_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pegRatio&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Complete valuation summary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;longName&#39;</span><span class="p">),</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentPrice&#39;</span><span class="p">),</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">market_cap</span><span class="p">(),</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">enterprise_value</span><span class="p">(),</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">earnings_metrics</span><span class="p">()</span>
        <span class="p">}</span>

<span class="c1"># Test</span>
<span class="n">val</span> <span class="o">=</span> <span class="n">Valuation</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AAPL Valuation Summary:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 2.3: Valuation Screener (Guided)</h3>
<p>Build a screener to find undervalued stocks based on valuation metrics.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ValuationScreener</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Screen stocks based on valuation criteria.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">fetch_valuations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch valuation data for all symbols.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Fetch valuation metrics for each symbol</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">screen_by_pe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_pe</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find stocks with P/E below threshold.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Filter and return symbols meeting criteria</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">screen_by_peg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_peg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find stocks with PEG ratio below threshold.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Filter by PEG ratio</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">rank_by_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rank stocks by value score.</span>
<span class="sd">        Lower P/E, P/B, PEG = higher value score.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Create composite value score and rank</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># screener = ValuationScreener(FAANG)</span>
<span class="c1"># screener.fetch_valuations()</span>
<span class="c1"># print(&quot;Low P/E stocks:&quot;, screener.screen_by_pe(35))</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ValuationScreener</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Screen stocks based on valuation criteria.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">fetch_valuations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch valuation data for all symbols.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">Valuation</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">screen_by_pe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_pe</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find stocks with P/E below threshold.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_valuations</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_pe</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">screen_by_peg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_peg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find stocks with PEG ratio below threshold.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_valuations</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;peg_ratio&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;peg_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_peg</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">rank_by_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rank stocks by composite value score.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_valuations</span><span class="p">()</span>

        <span class="c1"># Create DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Calculate percentile ranks (lower = better for valuation)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;peg_ratio&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># Rank: lower values get higher score</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">score</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">score</span><span class="p">[</span><span class="s1">&#39;total_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;total_score&#39;</span><span class="p">)</span>

        <span class="c1"># Add key metrics</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;peg_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;peg_ratio&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">screener</span> <span class="o">=</span> <span class="n">ValuationScreener</span><span class="p">(</span><span class="n">FAANG</span><span class="p">)</span>
<span class="n">screener</span><span class="o">.</span><span class="n">fetch_valuations</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Low P/E stocks (&lt; 35):&quot;</span><span class="p">,</span> <span class="n">screener</span><span class="o">.</span><span class="n">screen_by_pe</span><span class="p">(</span><span class="mi">35</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Value Ranking:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">screener</span><span class="o">.</span><span class="n">rank_by_value</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Peer Comparison</h1>
<h2>4.1 Why Compare Companies?</h2>
<p>Individual ratios have limited meaning without context. A P/E of 25 could be:
- Expensive for a utility company (typical: 15-18)
- Cheap for a high-growth tech company (typical: 30-50)</p>
<p><strong>Peer comparison</strong> puts metrics in context by comparing similar companies.</p>
<h2>4.2 GICS Sectors</h2>
<p>The Global Industry Classification Standard (GICS) organizes companies into:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Sector</th>
<th>Examples</th>
<th>Typical P/E</th>
</tr>
</thead>
<tbody>
<tr>
<td>Technology</td>
<td>AAPL, MSFT, NVDA</td>
<td>25-40</td>
</tr>
<tr>
<td>Healthcare</td>
<td>JNJ, UNH, PFE</td>
<td>15-25</td>
</tr>
<tr>
<td>Financials</td>
<td>JPM, BAC, V</td>
<td>10-15</td>
</tr>
<tr>
<td>Consumer Discretionary</td>
<td>AMZN, TSLA, HD</td>
<td>20-40</td>
</tr>
<tr>
<td>Communication</td>
<td>GOOGL, META, DIS</td>
<td>15-25</td>
</tr>
<tr>
<td>Consumer Staples</td>
<td>PG, KO, WMT</td>
<td>20-25</td>
</tr>
<tr>
<td>Industrials</td>
<td>HON, CAT, UNP</td>
<td>15-20</td>
</tr>
<tr>
<td>Energy</td>
<td>XOM, CVX, COP</td>
<td>8-15</td>
</tr>
<tr>
<td>Utilities</td>
<td>NEE, DUK, SO</td>
<td>15-20</td>
</tr>
<tr>
<td>Real Estate</td>
<td>AMT, PLD, SPG</td>
<td>30-50 (FFO-based)</td>
</tr>
<tr>
<td>Materials</td>
<td>LIN, APD, SHW</td>
<td>15-20</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PeerComparison</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compare a stock against its peers.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">peers</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
        
        <span class="c1"># Use provided peers or default by sector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peers</span> <span class="o">=</span> <span class="n">peers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_peers</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_get_default_peers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get default peer list by sector.&quot;&quot;&quot;</span>
        <span class="n">sector_peers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Technology&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NVDA&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Consumer Cyclical&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;TSLA&#39;</span><span class="p">,</span> <span class="s1">&#39;HD&#39;</span><span class="p">,</span> <span class="s1">&#39;NKE&#39;</span><span class="p">,</span> <span class="s1">&#39;MCD&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Communication Services&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;DIS&#39;</span><span class="p">,</span> <span class="s1">&#39;VZ&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Healthcare&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;JNJ&#39;</span><span class="p">,</span> <span class="s1">&#39;UNH&#39;</span><span class="p">,</span> <span class="s1">&#39;PFE&#39;</span><span class="p">,</span> <span class="s1">&#39;ABBV&#39;</span><span class="p">,</span> <span class="s1">&#39;MRK&#39;</span><span class="p">],</span>
            <span class="s1">&#39;Financial Services&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;JPM&#39;</span><span class="p">,</span> <span class="s1">&#39;BAC&#39;</span><span class="p">,</span> <span class="s1">&#39;WFC&#39;</span><span class="p">,</span> <span class="s1">&#39;GS&#39;</span><span class="p">,</span> <span class="s1">&#39;MS&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">sector_peers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sector</span><span class="p">,</span> <span class="n">FAANG</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">fetch_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch key metrics for target and peers.&quot;&quot;&quot;</span>
        <span class="n">all_symbols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">peers</span><span class="p">))</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">all_symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;longName&#39;</span><span class="p">,</span> <span class="n">symbol</span><span class="p">),</span>
                    <span class="s1">&#39;market_cap_b&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marketCap&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
                    <span class="s1">&#39;pe_ratio&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trailingPE&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;pb_ratio&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priceToBook&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;profit_margin&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profitMargins&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profitMargins&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;revenue_growth&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;revenueGrowth&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;revenueGrowth&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">relative_valuation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compare target to peer average.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_comparison</span><span class="p">()</span>
        
        <span class="c1"># Calculate peer averages (excluding target)</span>
        <span class="n">peer_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        
        <span class="n">target</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">}</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;pb_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;profit_margin&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">peer_avg</span> <span class="o">=</span> <span class="n">peer_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">target_val</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">target_val</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">peer_avg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">peer_avg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_val</span>
                    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_peer_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">peer_avg</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">_vs_peers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">((</span><span class="n">target_val</span> <span class="o">/</span> <span class="n">peer_avg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span>
        
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Test</span>
<span class="n">peer</span> <span class="o">=</span> <span class="n">PeerComparison</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sector: </span><span class="si">{</span><span class="n">peer</span><span class="o">.</span><span class="n">sector</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Peers: </span><span class="si">{</span><span class="n">peer</span><span class="o">.</span><span class="n">peers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comparison:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">peer</span><span class="o">.</span><span class="n">fetch_comparison</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 2.4: Sector Analyzer (Open-ended)</h3>
<p>Build a comprehensive sector analysis tool.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SectorAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze stocks within a sector.</span>
<span class="sd">    </span>
<span class="sd">    Requirements:</span>
<span class="sd">    1. Compare all stocks in a sector</span>
<span class="sd">    2. Calculate sector averages</span>
<span class="sd">    3. Find leaders (best metrics)</span>
<span class="sd">    4. Find laggards (worst metrics)</span>
<span class="sd">    5. Generate sector summary report</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: Fetch and analyze all symbols</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">sector_averages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># TODO: Calculate average metrics</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">find_leaders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># TODO: Find top performers by various metrics</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">find_laggards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># TODO: Find worst performers</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># analyzer = SectorAnalyzer(FAANG)</span>
<span class="c1"># print(analyzer.analyze())</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 2.5: Quality Score (Guided)</h3>
<p>Create a composite quality score combining multiple fundamental metrics.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">calculate_quality_score</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a quality score (0-100) based on:</span>
<span class="sd">    - Profitability (30 pts): ROE, profit margin</span>
<span class="sd">    - Growth (30 pts): Revenue growth, earnings growth</span>
<span class="sd">    - Financial Health (20 pts): Current ratio, D/E</span>
<span class="sd">    - Valuation (20 pts): P/E vs forward P/E (earnings growth implied)</span>
<span class="sd">    </span>
<span class="sd">    Returns dict with component scores and total.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement scoring logic</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># for symbol in FAANG:</span>
<span class="c1">#     score = calculate_quality_score(symbol)</span>
<span class="c1">#     print(f&quot;{symbol}: {score.get(&#39;total_score&#39;, 0)}/100&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_quality_score</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate a composite quality score (0-100).&quot;&quot;&quot;</span>
    <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">info</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s1">&#39;profitability&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;growth&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;financial_health&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valuation&#39;</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>

    <span class="c1"># Profitability (30 pts)</span>
    <span class="n">roe</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;returnOnEquity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profitMargins&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>

    <span class="c1"># ROE: 15% = 15 pts, cap at 30%</span>
    <span class="n">roe_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">roe</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="c1"># Margin: 20% = 15 pts, cap at 40%</span>
    <span class="n">margin_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">margin</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.375</span>
    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;profitability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">roe_score</span> <span class="o">+</span> <span class="n">margin_score</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

    <span class="c1"># Growth (30 pts)</span>
    <span class="n">rev_growth</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;revenueGrowth&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="n">earn_growth</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;earningsGrowth&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>

    <span class="c1"># 20% growth = 15 pts each, cap at 50%</span>
    <span class="n">rev_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">rev_growth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span>
    <span class="n">earn_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">earn_growth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span>
    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rev_score</span> <span class="o">+</span> <span class="n">earn_score</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

    <span class="c1"># Financial Health (20 pts)</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentRatio&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="n">de</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debtToEquity&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">100</span>

    <span class="c1"># Current ratio: 1.5 = 10 pts</span>
    <span class="n">current_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
    <span class="c1"># D/E: lower is better, 50% = 10 pts</span>
    <span class="n">de_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="p">(</span><span class="n">de</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;financial_health&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">current_score</span> <span class="o">+</span> <span class="n">de_score</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

    <span class="c1"># Valuation (20 pts) - based on P/E relative to growth</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trailingPE&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="n">peg</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pegRatio&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>

    <span class="c1"># PEG &lt; 1 = 20 pts, &gt; 2 = 0 pts</span>
    <span class="k">if</span> <span class="n">peg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">peg_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span> <span class="o">-</span> <span class="p">(</span><span class="n">peg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">peg_score</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">pe</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="k">else</span> <span class="mi">5</span>
    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;valuation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">peg_score</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;total_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;profitability&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">]</span> <span class="o">+</span> 
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;financial_health&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;valuation&#39;</span><span class="p">],</span> <span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">scores</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quality Scores:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">FAANG</span><span class="p">:</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">calculate_quality_score</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;total_score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/100&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Profit: </span><span class="si">{</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;profitability&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, Growth: </span><span class="si">{</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;growth&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Health: </span><span class="si">{</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;financial_health&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, Value: </span><span class="si">{</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;valuation&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h1>Module Project: Fundamental Analysis Dashboard</h1>
<p>Build a comprehensive fundamental analysis system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">FundamentalDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete fundamental analysis dashboard.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Financial statement summary</span>
<span class="sd">    - Key ratios</span>
<span class="sd">    - Valuation metrics</span>
<span class="sd">    - Peer comparison</span>
<span class="sd">    - Quality scoring</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">info</span>
    
    <span class="k">def</span> <span class="nf">company_overview</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Basic company information.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;longName&#39;</span><span class="p">),</span>
            <span class="s1">&#39;sector&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sector&#39;</span><span class="p">),</span>
            <span class="s1">&#39;industry&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;industry&#39;</span><span class="p">),</span>
            <span class="s1">&#39;employees&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fullTimeEmployees&#39;</span><span class="p">),</span>
            <span class="s1">&#39;website&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;website&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">financial_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Key financial metrics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;market_cap_b&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marketCap&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
            <span class="s1">&#39;revenue_b&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;totalRevenue&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
            <span class="s1">&#39;net_income_b&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;netIncomeToCommon&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
            <span class="s1">&#39;cash_b&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;totalCash&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
            <span class="s1">&#39;debt_b&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;totalDebt&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e9</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">ratios_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Key financial ratios.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pe_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trailingPE&#39;</span><span class="p">),</span>
            <span class="s1">&#39;pb_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priceToBook&#39;</span><span class="p">),</span>
            <span class="s1">&#39;profit_margin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profitMargins&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;roe&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;returnOnEquity&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;debt_to_equity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debtToEquity&#39;</span><span class="p">),</span>
            <span class="s1">&#39;current_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentRatio&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">growth_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Growth indicators.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;revenue_growth&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;revenueGrowth&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;earnings_growth&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;earningsGrowth&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;peg_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pegRatio&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate complete analysis report.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;overview&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">company_overview</span><span class="p">(),</span>
            <span class="s1">&#39;financials&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">financial_summary</span><span class="p">(),</span>
            <span class="s1">&#39;ratios&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratios_summary</span><span class="p">(),</span>
            <span class="s1">&#39;growth&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">growth_metrics</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print formatted report.&quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_report</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FUNDAMENTAL ANALYSIS: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert to percentage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test the dashboard</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">FundamentalDashboard</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">print_report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 2.6: Compare FAANG Fundamentals (Open-ended)</h3>
<p>Use the tools built in this module to:
1. Generate fundamental reports for all FAANG stocks
2. Identify which stock has the best profitability
3. Identify which stock appears most undervalued
4. Create a ranking based on overall quality</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your analysis code here</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>Three Statements:</strong> Income (profitability), Balance (financial position), Cash Flow (actual cash)</li>
<li><strong>Profitability Ratios:</strong> Margins, ROE, ROA measure efficiency</li>
<li><strong>Valuation Ratios:</strong> P/E, P/B, EV/EBITDA compare price to fundamentals</li>
<li><strong>Leverage Ratios:</strong> D/E, current ratio measure financial risk</li>
<li><strong>Context Matters:</strong> Compare within sectors for meaningful analysis</li>
<li><strong>Composite Scores:</strong> Combine multiple metrics for holistic view</li>
</ol>
<hr />
<p><strong>Next Module:</strong> Technical Analysis - Trend &amp; Momentum</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="3"><div class="md-cell module-header"><h1>Module 3: Technical Analysis - Trend &amp; Momentum</h1>
<h2>Part 1: Stock Market Foundations</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Modules 1-2</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Calculate and interpret moving averages (SMA, EMA)</li>
<li>Identify trends using moving average systems</li>
<li>Calculate momentum indicators (RSI, MACD, Stochastic)</li>
<li>Generate trading signals from technical indicators</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Required imports</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Our consistent stock universe</span>
<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="c1"># Fetch sample data</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> days of AAPL data&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: Moving Averages</h1>
<h2>1.1 What Are Moving Averages?</h2>
<p>Moving averages smooth price data to reveal trends by averaging prices over a specific period.</p>
<h3>Simple Moving Average (SMA)</h3>
<p>Equal weight to all prices in the period.</p>
<p>$$SMA_n = \frac{P_1 + P_2 + ... + P_n}{n}$$</p>
<h3>Exponential Moving Average (EMA)</h3>
<p>More weight to recent prices, reacts faster to changes.</p>
<p>$$EMA_t = P_t \times k + EMA_{t-1} \times (1-k)$$</p>
<p>where $k = \frac{2}{n+1}$ (smoothing factor)</p>
<h3>Common Periods</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Period</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>10-day</td>
<td>Short-term trend</td>
</tr>
<tr>
<td>20-day</td>
<td>Short-term trend, Bollinger Bands</td>
</tr>
<tr>
<td>50-day</td>
<td>Medium-term trend</td>
</tr>
<tr>
<td>200-day</td>
<td>Long-term trend</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MovingAverages</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate various moving averages.&quot;&quot;&quot;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simple Moving Average.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ema</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Exponential Moving Average.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">prices</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">wma</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Weighted Moving Average (linear weights).&quot;&quot;&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">period</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dema</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Double Exponential Moving Average (less lag).&quot;&quot;&quot;</span>
        <span class="n">ema1</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ema2</span> <span class="o">=</span> <span class="n">ema1</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">period</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ema1</span> <span class="o">-</span> <span class="n">ema2</span>

<span class="c1"># Calculate MAs</span>
<span class="n">close</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;EMA_12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">ema</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;EMA_26&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">ema</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Moving Averages (last 5 days):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;SMA_20&#39;</span><span class="p">,</span> <span class="s1">&#39;SMA_50&#39;</span><span class="p">,</span> <span class="s1">&#39;EMA_12&#39;</span><span class="p">,</span> <span class="s1">&#39;EMA_26&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize moving averages</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot last 100 days for clarity</span>
<span class="n">plot_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;SMA_20&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SMA(20)&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;SMA_50&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SMA(50)&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;AAPL Price with Moving Averages&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price ($)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 Moving Average Crossovers</h2>
<p>Crossovers generate trading signals:</p>
<ul>
<li><strong>Golden Cross:</strong> Short MA crosses above long MA ‚Üí Bullish</li>
<li><strong>Death Cross:</strong> Short MA crosses below long MA ‚Üí Bearish</li>
</ul>
<p>Common pairs:
- 9/21 EMA (short-term)
- 50/200 SMA (long-term, "Golden Cross")</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TrendDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect trends using moving averages.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">ma_crossover_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">long_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate crossover signals.</span>
<span class="sd">        Returns DataFrame with signal column: 1 (buy), -1 (sell), 0 (hold)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">short_ma</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span> <span class="n">short_period</span><span class="p">)</span>
        <span class="n">long_ma</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span> <span class="n">long_period</span><span class="p">)</span>
        
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;short_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">short_ma</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;long_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_ma</span>
        
        <span class="c1"># Position: 1 when short &gt; long, else 0</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">short_ma</span> <span class="o">&gt;</span> <span class="n">long_ma</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Signal: 1 on crossover up, -1 on crossover down</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">trend_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measure trend strength using MA slope.</span>
<span class="sd">        Returns percentage change of MA over 5 periods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">slope</span>
    
    <span class="k">def</span> <span class="nf">identify_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">long_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Identify current trend.&quot;&quot;&quot;</span>
        <span class="n">short_ma</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span> <span class="n">short_period</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">long_ma</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span> <span class="n">long_period</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">short_ma</span> <span class="o">&gt;</span> <span class="n">long_ma</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Strong Uptrend&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">long_ma</span> <span class="ow">and</span> <span class="n">short_ma</span> <span class="o">&gt;</span> <span class="n">long_ma</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Uptrend&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">short_ma</span> <span class="o">&lt;</span> <span class="n">long_ma</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Strong Downtrend&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">long_ma</span> <span class="ow">and</span> <span class="n">short_ma</span> <span class="o">&lt;</span> <span class="n">long_ma</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Downtrend&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Sideways&#39;</span>

<span class="c1"># Test trend detection</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">TrendDetector</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Trend: </span><span class="si">{</span><span class="n">detector</span><span class="o">.</span><span class="n">identify_trend</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trend Strength (MA slope): </span><span class="si">{</span><span class="n">detector</span><span class="o">.</span><span class="n">trend_strength</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="c1"># Get crossover signals</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">ma_crossover_signals</span><span class="p">()</span>
<span class="n">buy_signals</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">sell_signals</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Buy signals in period: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">buy_signals</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sell signals in period: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sell_signals</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 3.1: Multi-Timeframe MA Analysis (Guided)</h3>
<p>Build a system that analyzes multiple MA timeframes.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">multi_timeframe_ma_analysis</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze multiple MA timeframes.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict with:</span>
<span class="sd">        - short_term: Analysis of 10/20 MA</span>
<span class="sd">        - medium_term: Analysis of 20/50 MA</span>
<span class="sd">        - long_term: Analysis of 50/200 MA</span>
<span class="sd">        - overall_bias: Combined view</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate MAs for each timeframe</span>
    <span class="c1"># TODO: Determine bias for each (bullish/bearish/neutral)</span>
    <span class="c1"># TODO: Calculate overall bias based on majority</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># analysis = multi_timeframe_ma_analysis(df[&#39;Close&#39;])</span>
<span class="c1"># print(analysis)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">multi_timeframe_ma_analysis</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze multiple MA timeframes.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_bias</span><span class="p">(</span><span class="n">short_ma</span><span class="p">,</span> <span class="n">long_ma</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="n">short_val</span> <span class="o">=</span> <span class="n">short_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">long_val</span> <span class="o">=</span> <span class="n">long_ma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">price_val</span> <span class="o">=</span> <span class="n">price</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">short_val</span> <span class="o">&gt;</span> <span class="n">long_val</span> <span class="ow">and</span> <span class="n">price_val</span> <span class="o">&gt;</span> <span class="n">short_val</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Bullish&#39;</span>
        <span class="k">elif</span> <span class="n">short_val</span> <span class="o">&lt;</span> <span class="n">long_val</span> <span class="ow">and</span> <span class="n">price_val</span> <span class="o">&lt;</span> <span class="n">short_val</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Bearish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Neutral&#39;</span>

    <span class="c1"># Calculate all MAs</span>
    <span class="n">ma_10</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">ma_20</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">ma_50</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">ma_200</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="c1"># Analyze each timeframe</span>
    <span class="n">short_term</span> <span class="o">=</span> <span class="n">get_bias</span><span class="p">(</span><span class="n">ma_10</span><span class="p">,</span> <span class="n">ma_20</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>
    <span class="n">medium_term</span> <span class="o">=</span> <span class="n">get_bias</span><span class="p">(</span><span class="n">ma_20</span><span class="p">,</span> <span class="n">ma_50</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>
    <span class="n">long_term</span> <span class="o">=</span> <span class="n">get_bias</span><span class="p">(</span><span class="n">ma_50</span><span class="p">,</span> <span class="n">ma_200</span><span class="p">,</span> <span class="n">prices</span><span class="p">)</span>

    <span class="c1"># Overall bias</span>
    <span class="n">biases</span> <span class="o">=</span> <span class="p">[</span><span class="n">short_term</span><span class="p">,</span> <span class="n">medium_term</span><span class="p">,</span> <span class="n">long_term</span><span class="p">]</span>
    <span class="n">bullish</span> <span class="o">=</span> <span class="n">biases</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;Bullish&#39;</span><span class="p">)</span>
    <span class="n">bearish</span> <span class="o">=</span> <span class="n">biases</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;Bearish&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bullish</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;Bullish&#39;</span>
    <span class="k">elif</span> <span class="n">bearish</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;Bearish&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;Mixed&#39;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;short_term (10/20)&#39;</span><span class="p">:</span> <span class="n">short_term</span><span class="p">,</span>
        <span class="s1">&#39;medium_term (20/50)&#39;</span><span class="p">:</span> <span class="n">medium_term</span><span class="p">,</span>
        <span class="s1">&#39;long_term (50/200)&#39;</span><span class="p">:</span> <span class="n">long_term</span><span class="p">,</span>
        <span class="s1">&#39;overall_bias&#39;</span><span class="p">:</span> <span class="n">overall</span><span class="p">,</span>
        <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;ma_20&#39;</span><span class="p">:</span> <span class="n">ma_20</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;ma_50&#39;</span><span class="p">:</span> <span class="n">ma_50</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;ma_200&#39;</span><span class="p">:</span> <span class="n">ma_200</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">}</span>

<span class="n">analysis</span> <span class="o">=</span> <span class="n">multi_timeframe_ma_analysis</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multi-Timeframe MA Analysis:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">analysis</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: RSI (Relative Strength Index)</h1>
<h2>2.1 Understanding RSI</h2>
<p>RSI measures the speed and magnitude of price changes to identify overbought/oversold conditions.</p>
<p>$$RSI = 100 - \frac{100}{1 + RS}$$</p>
<p>where $RS = \frac{Average Gain}{Average Loss}$</p>
<h3>Interpretation</h3>
<ul>
<li><strong>RSI &gt; 70:</strong> Overbought (potential sell)</li>
<li><strong>RSI &lt; 30:</strong> Oversold (potential buy)</li>
<li><strong>RSI = 50:</strong> Neutral</li>
</ul>
<h3>Advanced Usage</h3>
<ul>
<li><strong>Divergence:</strong> Price makes new high but RSI doesn't ‚Üí potential reversal</li>
<li><strong>Centerline Crossover:</strong> RSI crossing 50 confirms trend direction</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">RSI</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Relative Strength Index calculator.&quot;&quot;&quot;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate RSI.&quot;&quot;&quot;</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">avg_gain</span> <span class="o">=</span> <span class="n">gain</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="n">rs</span> <span class="o">=</span> <span class="n">avg_gain</span> <span class="o">/</span> <span class="n">avg_loss</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">rsi</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_signal</span><span class="p">(</span><span class="n">rsi_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">overbought</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span> <span class="n">oversold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get signal from RSI value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rsi_value</span> <span class="o">&gt;=</span> <span class="n">overbought</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Overbought&#39;</span>
        <span class="k">elif</span> <span class="n">rsi_value</span> <span class="o">&lt;=</span> <span class="n">oversold</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Oversold&#39;</span>
        <span class="k">elif</span> <span class="n">rsi_value</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Bullish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Bearish&#39;</span>

<span class="c1"># Calculate RSI</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RSI</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="n">current_rsi</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current RSI: </span><span class="si">{</span><span class="n">current_rsi</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal: </span><span class="si">{</span><span class="n">RSI</span><span class="o">.</span><span class="n">get_signal</span><span class="p">(</span><span class="n">current_rsi</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Show RSI history</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RSI (last 5 days):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;RSI&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize RSI</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">plot_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>

<span class="c1"># Price chart</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;AAPL Price&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price ($)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># RSI chart</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RSI(14)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Overbought (70)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Oversold (30)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RSI&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;RSI&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 3.2: RSI Divergence Detector (Open-ended)</h3>
<p>Build a divergence detector that identifies when price and RSI diverge.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">RSIDivergence</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect RSI divergences.</span>
<span class="sd">    </span>
<span class="sd">    Bullish Divergence: Price makes lower low, RSI makes higher low</span>
<span class="sd">    Bearish Divergence: Price makes higher high, RSI makes lower high</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">rsi</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="n">rsi</span>
    
    <span class="k">def</span> <span class="nf">find_divergences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find divergences in the last `lookback` periods.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Implement divergence detection</span>
        <span class="c1"># Hint: Compare recent highs/lows in price vs RSI</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># divergence = RSIDivergence(df[&#39;Close&#39;], df[&#39;RSI&#39;])</span>
<span class="c1"># print(divergence.find_divergences())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 3: MACD (Moving Average Convergence Divergence)</h1>
<h2>3.1 Understanding MACD</h2>
<p>MACD shows the relationship between two moving averages.</p>
<p><strong>Components:</strong>
1. <strong>MACD Line:</strong> EMA(12) - EMA(26)
2. <strong>Signal Line:</strong> EMA(9) of MACD Line
3. <strong>Histogram:</strong> MACD Line - Signal Line</p>
<p><strong>Signals:</strong>
- MACD crosses above Signal ‚Üí Bullish
- MACD crosses below Signal ‚Üí Bearish
- Histogram growing ‚Üí Trend strengthening
- Histogram shrinking ‚Üí Trend weakening</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MACD</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;MACD indicator calculator.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">fast</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">slow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">26</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast</span> <span class="o">=</span> <span class="n">fast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="n">slow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_period</span> <span class="o">=</span> <span class="n">signal</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate MACD components.&quot;&quot;&quot;</span>
        <span class="n">ema_fast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fast</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">ema_slow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slow</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">macd_line</span> <span class="o">=</span> <span class="n">ema_fast</span> <span class="o">-</span> <span class="n">ema_slow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macd_line</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_period</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">histogram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macd_line</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_line</span>
    
    <span class="k">def</span> <span class="nf">get_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current signal.&quot;&quot;&quot;</span>
        <span class="n">macd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macd_line</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_line</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histogram</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prev_hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histogram</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">macd</span> <span class="o">&gt;</span> <span class="n">signal</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;Bullish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;Bearish&#39;</span>
        
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">prev_hist</span><span class="p">):</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="s1">&#39;Strengthening&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strength</span> <span class="o">=</span> <span class="s1">&#39;Weakening&#39;</span>
        
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">trend</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">strength</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">def</span> <span class="nf">get_crossover_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get crossover signals: 1 (bullish), -1 (bearish), 0 (none).&quot;&quot;&quot;</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macd_line</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_line</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">position</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">as_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return all components as DataFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;macd&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">macd_line</span><span class="p">,</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_line</span><span class="p">,</span>
            <span class="s1">&#39;histogram&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">histogram</span>
        <span class="p">})</span>

<span class="c1"># Calculate MACD</span>
<span class="n">macd</span> <span class="o">=</span> <span class="n">MACD</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current MACD: </span><span class="si">{</span><span class="n">macd</span><span class="o">.</span><span class="n">macd_line</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Signal: </span><span class="si">{</span><span class="n">macd</span><span class="o">.</span><span class="n">signal_line</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Histogram: </span><span class="si">{</span><span class="n">macd</span><span class="o">.</span><span class="n">histogram</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal: </span><span class="si">{</span><span class="n">macd</span><span class="o">.</span><span class="n">get_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize MACD</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">plot_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
<span class="n">macd_df</span> <span class="o">=</span> <span class="n">macd</span><span class="o">.</span><span class="n">as_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>

<span class="c1"># Price chart</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;AAPL Price&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price ($)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># MACD chart</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">macd_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">macd_df</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MACD&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">macd_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">macd_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Signal&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>

<span class="c1"># Histogram</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">macd_df</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">]]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">macd_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">macd_df</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Histogram&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;MACD&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;MACD&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 3.3: MACD Signal Generator (Guided)</h3>
<p>Build a signal generator that combines MACD with trend filter.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">macd_signal_generator</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate MACD signals with trend filter.</span>
<span class="sd">    </span>
<span class="sd">    Rules:</span>
<span class="sd">    - Only take bullish MACD signals when price &gt; 50 SMA</span>
<span class="sd">    - Only take bearish MACD signals when price &lt; 50 SMA</span>
<span class="sd">    </span>
<span class="sd">    Returns DataFrame with columns:</span>
<span class="sd">    - price, macd, signal, histogram</span>
<span class="sd">    - trend_filter (1 = above 50 SMA, -1 = below)</span>
<span class="sd">    - raw_signal (from MACD crossover)</span>
<span class="sd">    - filtered_signal (raw signal confirmed by trend)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement signal generation</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># signals = macd_signal_generator(df[&#39;Close&#39;])</span>
<span class="c1"># print(signals[signals[&#39;filtered_signal&#39;] != 0].tail(10))</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">macd_signal_generator</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate MACD signals with trend filter.&quot;&quot;&quot;</span>

    <span class="c1"># Calculate MACD</span>
    <span class="n">macd_calc</span> <span class="o">=</span> <span class="n">MACD</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

    <span class="c1"># Calculate trend filter</span>
    <span class="n">sma_50</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

    <span class="c1"># Build DataFrame</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sma_50</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd_calc</span><span class="o">.</span><span class="n">macd_line</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd_calc</span><span class="o">.</span><span class="n">signal_line</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd_calc</span><span class="o">.</span><span class="n">histogram</span>

    <span class="c1"># Trend filter: 1 if price &gt; SMA, -1 if below</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;trend_filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prices</span> <span class="o">&gt;</span> <span class="n">sma_50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Raw MACD signals</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;raw_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd_calc</span><span class="o">.</span><span class="n">get_crossover_signals</span><span class="p">()</span>

    <span class="c1"># Filtered signals</span>
    <span class="c1"># Bullish (1) only if trend is up (1)</span>
    <span class="c1"># Bearish (-1) only if trend is down (-1)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;filtered_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">bullish_confirmed</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;raw_signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;trend_filter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bearish_confirmed</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;raw_signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;trend_filter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bullish_confirmed</span><span class="p">,</span> <span class="s1">&#39;filtered_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bearish_confirmed</span><span class="p">,</span> <span class="s1">&#39;filtered_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="n">signals</span> <span class="o">=</span> <span class="n">macd_signal_generator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recent MACD Signals:&quot;</span><span class="p">)</span>
<span class="n">signal_days</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;filtered_signal&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal_days</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">signal_days</span><span class="p">[[</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;filtered_signal&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No confirmed signals in recent period&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total Buy Signals: </span><span class="si">{</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;filtered_signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Sell Signals: </span><span class="si">{</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;filtered_signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Stochastic Oscillator</h1>
<h2>4.1 Understanding Stochastic</h2>
<p>The Stochastic Oscillator compares closing price to the price range.</p>
<p>$$\%K = \frac{Close - Lowest Low}{Highest High - Lowest Low} \times 100$$</p>
<p>$$\%D = SMA(\%K, 3)$$</p>
<p><strong>Interpretation:</strong>
- <strong>%K &gt; 80:</strong> Overbought
- <strong>%K &lt; 20:</strong> Oversold
- <strong>%K crosses above %D:</strong> Bullish
- <strong>%K crosses below %D:</strong> Bearish</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">Stochastic</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Stochastic Oscillator calculator.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                 <span class="n">k_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">d_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_period</span> <span class="o">=</span> <span class="n">k_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_period</span> <span class="o">=</span> <span class="n">d_period</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate %K and %D.&quot;&quot;&quot;</span>
        <span class="n">lowest_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">highest_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k_period</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">-</span> <span class="n">lowest_low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">highest_high</span> <span class="o">-</span> <span class="n">lowest_low</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">d_period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overbought</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span> <span class="n">oversold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current signal.&quot;&quot;&quot;</span>
        <span class="n">k_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">d_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">k_val</span> <span class="o">&gt;=</span> <span class="n">overbought</span><span class="p">:</span>
            <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;Overbought&#39;</span>
        <span class="k">elif</span> <span class="n">k_val</span> <span class="o">&lt;=</span> <span class="n">oversold</span><span class="p">:</span>
            <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;Oversold&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;Neutral&#39;</span>
        
        <span class="k">if</span> <span class="n">k_val</span> <span class="o">&gt;</span> <span class="n">d_val</span><span class="p">:</span>
            <span class="n">momentum</span> <span class="o">=</span> <span class="s1">&#39;Bullish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">momentum</span> <span class="o">=</span> <span class="s1">&#39;Bearish&#39;</span>
        
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zone</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">momentum</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">def</span> <span class="nf">as_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return as DataFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span>
            <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>
        <span class="p">})</span>

<span class="c1"># Calculate Stochastic</span>
<span class="n">stoch</span> <span class="o">=</span> <span class="n">Stochastic</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current %K: </span><span class="si">{</span><span class="n">stoch</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current %D: </span><span class="si">{</span><span class="n">stoch</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal: </span><span class="si">{</span><span class="n">stoch</span><span class="o">.</span><span class="n">get_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 3.4: Momentum Dashboard (Open-ended)</h3>
<p>Build a combined momentum indicator dashboard.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MomentumDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combined momentum indicator dashboard.</span>
<span class="sd">    </span>
<span class="sd">    Combines RSI, MACD, and Stochastic into a single view.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;df must have High, Low, Close columns.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">calculate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate all momentum indicators.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Calculate RSI, MACD, Stochastic</span>
        <span class="c1"># TODO: Return combined DataFrame</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_consensus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get consensus signal based on all indicators.</span>
<span class="sd">        </span>
<span class="sd">        Returns: &#39;Strong Buy&#39;, &#39;Buy&#39;, &#39;Neutral&#39;, &#39;Sell&#39;, &#39;Strong Sell&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Implement consensus logic</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get summary of all indicators.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Return dict with current values and signals</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># dashboard = MomentumDashboard(df)</span>
<span class="c1"># print(dashboard.summary())</span>
</code></pre></div>
<div class="md-cell module-project"><hr />
<h1>Module Project: Trend &amp; Momentum System</h1>
<p>Build a complete trend and momentum analysis system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TrendMomentumSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete trend and momentum analysis system.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Trend identification (MA-based)</span>
<span class="sd">    - Momentum indicators (RSI, MACD, Stochastic)</span>
<span class="sd">    - Signal generation</span>
<span class="sd">    - Overall market view</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1y&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_indicators</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate all indicators.&quot;&quot;&quot;</span>
        <span class="n">close</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span>
        <span class="n">low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span>
        
        <span class="c1"># Moving Averages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_50&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_200&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MovingAverages</span><span class="o">.</span><span class="n">sma</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        
        <span class="c1"># RSI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RSI</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        
        <span class="c1"># MACD</span>
        <span class="n">macd</span> <span class="o">=</span> <span class="n">MACD</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="o">.</span><span class="n">macd_line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD_Signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="o">.</span><span class="n">signal_line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD_Hist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="o">.</span><span class="n">histogram</span>
        
        <span class="c1"># Stochastic</span>
        <span class="n">stoch</span> <span class="o">=</span> <span class="n">Stochastic</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stoch_K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stoch</span><span class="o">.</span><span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stoch_D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stoch</span><span class="o">.</span><span class="n">d</span>
    
    <span class="k">def</span> <span class="nf">get_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get trend analysis.&quot;&quot;&quot;</span>
        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sma_20</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_20&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sma_50</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_50&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sma_200</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SMA_200&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Trend determination</span>
        <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">sma_20</span> <span class="o">&gt;</span> <span class="n">sma_50</span> <span class="o">&gt;</span> <span class="n">sma_200</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;Strong Uptrend&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">sma_50</span> <span class="o">&gt;</span> <span class="n">sma_200</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;Uptrend&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">sma_20</span> <span class="o">&lt;</span> <span class="n">sma_50</span> <span class="o">&lt;</span> <span class="n">sma_200</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;Strong Downtrend&#39;</span>
        <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">sma_50</span> <span class="o">&lt;</span> <span class="n">sma_200</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;Downtrend&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trend</span> <span class="o">=</span> <span class="s1">&#39;Sideways&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">trend</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;sma_20&#39;</span><span class="p">:</span> <span class="n">sma_20</span><span class="p">,</span>
            <span class="s1">&#39;sma_50&#39;</span><span class="p">:</span> <span class="n">sma_50</span><span class="p">,</span>
            <span class="s1">&#39;sma_200&#39;</span><span class="p">:</span> <span class="n">sma_200</span><span class="p">,</span>
            <span class="s1">&#39;above_20&#39;</span><span class="p">:</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">sma_20</span><span class="p">,</span>
            <span class="s1">&#39;above_50&#39;</span><span class="p">:</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">sma_50</span><span class="p">,</span>
            <span class="s1">&#39;above_200&#39;</span><span class="p">:</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">sma_200</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get momentum analysis.&quot;&quot;&quot;</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;RSI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">macd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">macd_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD_Signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">stoch_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stoch_K&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">rsi</span><span class="p">,</span>
            <span class="s1">&#39;rsi_signal&#39;</span><span class="p">:</span> <span class="n">RSI</span><span class="o">.</span><span class="n">get_signal</span><span class="p">(</span><span class="n">rsi</span><span class="p">),</span>
            <span class="s1">&#39;macd&#39;</span><span class="p">:</span> <span class="n">macd</span><span class="p">,</span>
            <span class="s1">&#39;macd_bullish&#39;</span><span class="p">:</span> <span class="n">macd</span> <span class="o">&gt;</span> <span class="n">macd_signal</span><span class="p">,</span>
            <span class="s1">&#39;stoch_k&#39;</span><span class="p">:</span> <span class="n">stoch_k</span><span class="p">,</span>
            <span class="s1">&#39;stoch_signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Overbought&#39;</span> <span class="k">if</span> <span class="n">stoch_k</span> <span class="o">&gt;</span> <span class="mi">80</span> <span class="k">else</span> <span class="s1">&#39;Oversold&#39;</span> <span class="k">if</span> <span class="n">stoch_k</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="k">else</span> <span class="s1">&#39;Neutral&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_overall_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get overall market signal.&quot;&quot;&quot;</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trend</span><span class="p">()</span>
        <span class="n">momentum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_momentum</span><span class="p">()</span>
        
        <span class="c1"># Score based on conditions</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Trend score</span>
        <span class="k">if</span> <span class="s1">&#39;Uptrend&#39;</span> <span class="ow">in</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">2</span> <span class="k">if</span> <span class="s1">&#39;Strong&#39;</span> <span class="ow">in</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="s1">&#39;Downtrend&#39;</span> <span class="ow">in</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">2</span> <span class="k">if</span> <span class="s1">&#39;Strong&#39;</span> <span class="ow">in</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
        
        <span class="c1"># RSI score</span>
        <span class="k">if</span> <span class="n">momentum</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Oversold = potential buy</span>
        <span class="k">elif</span> <span class="n">momentum</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># Overbought = potential sell</span>
        
        <span class="c1"># MACD score</span>
        <span class="k">if</span> <span class="n">momentum</span><span class="p">[</span><span class="s1">&#39;macd_bullish&#39;</span><span class="p">]:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>
        
        <span class="c1"># Convert score to signal</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Strong Buy&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Buy&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Strong Sell&#39;</span>
        <span class="k">elif</span> <span class="n">score</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Sell&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Neutral&#39;</span>
    
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print full analysis report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TREND &amp; MOMENTUM ANALYSIS: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        
        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trend</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TREND: </span><span class="si">{</span><span class="n">trend</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Price: $</span><span class="si">{</span><span class="n">trend</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SMA 20: $</span><span class="si">{</span><span class="n">trend</span><span class="p">[</span><span class="s1">&#39;sma_20&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="s1">&#39;Above&#39;</span> <span class="k">if</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;above_20&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Below&#39;</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SMA 50: $</span><span class="si">{</span><span class="n">trend</span><span class="p">[</span><span class="s1">&#39;sma_50&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="s1">&#39;Above&#39;</span> <span class="k">if</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;above_50&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Below&#39;</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SMA 200: $</span><span class="si">{</span><span class="n">trend</span><span class="p">[</span><span class="s1">&#39;sma_200&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="s1">&#39;Above&#39;</span> <span class="k">if</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;above_200&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Below&#39;</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="n">momentum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_momentum</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MOMENTUM:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RSI: </span><span class="si">{</span><span class="n">momentum</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">momentum</span><span class="p">[</span><span class="s1">&#39;rsi_signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  MACD: </span><span class="si">{</span><span class="n">momentum</span><span class="p">[</span><span class="s1">&#39;macd&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="s1">&#39;Bullish&#39;</span> <span class="k">if</span> <span class="n">momentum</span><span class="p">[</span><span class="s1">&#39;macd_bullish&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Bearish&#39;</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Stochastic: </span><span class="si">{</span><span class="n">momentum</span><span class="p">[</span><span class="s1">&#39;stoch_k&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">momentum</span><span class="p">[</span><span class="s1">&#39;stoch_signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">OVERALL SIGNAL: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_overall_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test the system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">TrendMomentumSystem</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 3.5: Analyze All FAANG Stocks (Open-ended)</h3>
<p>Use the TrendMomentumSystem to analyze all FAANG stocks and rank them.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your code here - analyze all FAANG stocks</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 3.6: Custom Signal Strategy (Open-ended)</h3>
<p>Create your own signal strategy combining:
- At least 2 trend indicators
- At least 2 momentum indicators
- Clear entry/exit rules</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your custom strategy here</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>Moving Averages:</strong> SMA (simple), EMA (more responsive)</li>
<li><strong>MA Crossovers:</strong> Golden Cross (bullish), Death Cross (bearish)</li>
<li><strong>RSI:</strong> Overbought (&gt;70), Oversold (&lt;30)</li>
<li><strong>MACD:</strong> Line, Signal, Histogram - momentum and trend</li>
<li><strong>Stochastic:</strong> %K, %D - momentum within range</li>
<li><strong>Combine Indicators:</strong> Multiple confirmations = stronger signals</li>
</ol>
<hr />
<p><strong>Next Module:</strong> Technical Analysis - Volatility &amp; Volume</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="4"><div class="md-cell module-header"><h1>Module 4: Technical Analysis - Volatility &amp; Volume</h1>
<h2>Part 1: Stock Market Foundations</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Modules 1-3</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Calculate and interpret volatility indicators (ATR, Bollinger Bands)</li>
<li>Analyze volume patterns and their significance</li>
<li>Identify support and resistance levels</li>
<li>Combine volatility and volume for better signal confirmation</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Required imports</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Our consistent stock universe</span>
<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="c1"># Fetch sample data</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> days of AAPL data&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: Volatility Indicators</h1>
<h2>1.1 What is Volatility?</h2>
<p><strong>Volatility</strong> measures the degree of price variation over time. High volatility means larger price swings.</p>
<h3>Types of Volatility</h3>
<ul>
<li><strong>Historical Volatility:</strong> Based on past price movements</li>
<li><strong>Implied Volatility:</strong> Derived from options prices (future expectation)</li>
</ul>
<h3>Why Volatility Matters</h3>
<ol>
<li><strong>Risk Assessment:</strong> Higher volatility = higher risk</li>
<li><strong>Position Sizing:</strong> Adjust position size based on volatility</li>
<li><strong>Stop Loss Placement:</strong> Set stops based on typical price range</li>
<li><strong>Breakout Confirmation:</strong> Volatility expansion confirms breakouts</li>
</ol></div>
<div class="md-cell"><h2>1.2 Average True Range (ATR)</h2>
<p>ATR measures the average range of price movement, accounting for gaps.</p>
<p><strong>True Range</strong> is the greatest of:
1. Current High - Current Low
2. |Current High - Previous Close|
3. |Current Low - Previous Close|</p>
<p><strong>ATR</strong> = Moving average of True Range (typically 14 periods)</p>
<h3>Uses of ATR</h3>
<ul>
<li>Setting stop losses (e.g., 2√ó ATR from entry)</li>
<li>Comparing volatility across different stocks</li>
<li>Detecting volatility expansion/contraction</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ATR</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Average True Range calculator.&quot;&quot;&quot;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">true_range</span><span class="p">(</span><span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate True Range.&quot;&quot;&quot;</span>
        <span class="n">prev_close</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">tr1</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span>
        <span class="n">tr2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">prev_close</span><span class="p">)</span>
        <span class="n">tr3</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">prev_close</span><span class="p">)</span>
        
        <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">tr3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tr</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                  <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate ATR.&quot;&quot;&quot;</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">ATR</span><span class="o">.</span><span class="n">true_range</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
        <span class="n">atr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">atr</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">atr_percent</span><span class="p">(</span><span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                    <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;ATR as percentage of price.&quot;&quot;&quot;</span>
        <span class="n">atr</span> <span class="o">=</span> <span class="n">ATR</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">atr</span> <span class="o">/</span> <span class="n">close</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

<span class="c1"># Calculate ATR</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATR</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR_Pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATR</span><span class="o">.</span><span class="n">atr_percent</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current ATR: $</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current ATR %: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR_Pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ATR (last 5 days):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;ATR&#39;</span><span class="p">,</span> <span class="s1">&#39;ATR_Pct&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ATRStopLoss</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;ATR-based stop loss calculator.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                 <span class="n">atr_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr</span> <span class="o">=</span> <span class="n">ATR</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="n">atr_period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span>
    
    <span class="k">def</span> <span class="nf">long_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stop loss for long positions (below price).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">short_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Stop loss for short positions (above price).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">current_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current stop levels.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;atr&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;multiplier&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">,</span>
            <span class="s1">&#39;long_stop&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_stop</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;short_stop&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_stop</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;risk_per_share&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span>
        <span class="p">}</span>

<span class="c1"># Calculate ATR stops</span>
<span class="n">stops</span> <span class="o">=</span> <span class="n">ATRStopLoss</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">multiplier</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">levels</span> <span class="o">=</span> <span class="n">stops</span><span class="o">.</span><span class="n">current_levels</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ATR-Based Stop Levels:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Current Price: $</span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ATR (14): $</span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Long Stop (2x ATR): $</span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;long_stop&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Short Stop (2x ATR): $</span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;short_stop&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Risk per Share: $</span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;risk_per_share&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.3 Bollinger Bands</h2>
<p>Bollinger Bands show volatility through expanding/contracting bands around a moving average.</p>
<p><strong>Components:</strong>
- <strong>Middle Band:</strong> SMA(20)
- <strong>Upper Band:</strong> SMA + (2 √ó Standard Deviation)
- <strong>Lower Band:</strong> SMA - (2 √ó Standard Deviation)</p>
<p><strong>Interpretation:</strong>
- <strong>Band Width:</strong> Measures volatility (wider = more volatile)
- <strong>%B:</strong> Position within bands (above 1 = overbought, below 0 = oversold)
- <strong>Squeeze:</strong> Narrow bands often precede breakouts</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">BollingerBands</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Bollinger Bands calculator.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">std_dev</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std_dev</span> <span class="o">=</span> <span class="n">std_dev</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate bands.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">middle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middle</span> <span class="o">+</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_dev</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middle</span> <span class="o">-</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_dev</span><span class="p">)</span>
        
        <span class="c1"># Band width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">middle</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># %B - position within bands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percent_b</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current signal based on band position.&quot;&quot;&quot;</span>
        <span class="n">pct_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">percent_b</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">pct_b</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Above Upper Band (Overbought)&#39;</span>
        <span class="k">elif</span> <span class="n">pct_b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Below Lower Band (Oversold)&#39;</span>
        <span class="k">elif</span> <span class="n">pct_b</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Near Upper Band&#39;</span>
        <span class="k">elif</span> <span class="n">pct_b</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Near Lower Band&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Within Bands (Neutral)&#39;</span>
    
    <span class="k">def</span> <span class="nf">is_squeeze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect if bands are in a squeeze (low volatility).&quot;&quot;&quot;</span>
        <span class="n">current_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandwidth</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">avg_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandwidth</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">current_bw</span> <span class="o">&lt;</span> <span class="n">avg_bw</span> <span class="o">*</span> <span class="mf">0.75</span>  <span class="c1"># 25% below average</span>
    
    <span class="k">def</span> <span class="nf">as_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return all components as DataFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span>
            <span class="s1">&#39;upper&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span>
            <span class="s1">&#39;middle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">middle</span><span class="p">,</span>
            <span class="s1">&#39;lower&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span>
            <span class="s1">&#39;bandwidth&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">,</span>
            <span class="s1">&#39;percent_b&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">percent_b</span>
        <span class="p">})</span>

<span class="c1"># Calculate Bollinger Bands</span>
<span class="n">bb</span> <span class="o">=</span> <span class="n">BollingerBands</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upper Band: $</span><span class="si">{</span><span class="n">bb</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Middle Band: $</span><span class="si">{</span><span class="n">bb</span><span class="o">.</span><span class="n">middle</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lower Band: $</span><span class="si">{</span><span class="n">bb</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bandwidth: </span><span class="si">{</span><span class="n">bb</span><span class="o">.</span><span class="n">bandwidth</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%B: </span><span class="si">{</span><span class="n">bb</span><span class="o">.</span><span class="n">percent_b</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal: </span><span class="si">{</span><span class="n">bb</span><span class="o">.</span><span class="n">get_signal</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Squeeze: </span><span class="si">{</span><span class="n">bb</span><span class="o">.</span><span class="n">is_squeeze</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize Bollinger Bands</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">bb_df</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">as_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>

<span class="c1"># Price with bands</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bb_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bb_df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bb_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bb_df</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Upper Band&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bb_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bb_df</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">],</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Middle Band&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bb_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bb_df</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="s1">&#39;g--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Lower Band&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">bb_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bb_df</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="n">bb_df</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;AAPL with Bollinger Bands&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price ($)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Bandwidth</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bb_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bb_df</span><span class="p">[</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Bandwidth %&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">bb_df</span><span class="p">[</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Bollinger Bandwidth&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Bandwidth %&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 4.1: Volatility Breakout Strategy (Guided)</h3>
<p>Build a strategy that trades Bollinger Band breakouts with ATR confirmation.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">volatility_breakout_signals</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate breakout signals using Bollinger Bands.</span>
<span class="sd">    </span>
<span class="sd">    Entry Rules:</span>
<span class="sd">    - Buy: Price closes above upper band after squeeze</span>
<span class="sd">    - Sell: Price closes below lower band after squeeze</span>
<span class="sd">    </span>
<span class="sd">    Confirmation:</span>
<span class="sd">    - ATR expanding (current ATR &gt; ATR 5 periods ago)</span>
<span class="sd">    </span>
<span class="sd">    Returns DataFrame with signal column: 1 (buy), -1 (sell), 0 (none)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate Bollinger Bands</span>
    <span class="c1"># TODO: Calculate ATR</span>
    <span class="c1"># TODO: Detect squeeze periods</span>
    <span class="c1"># TODO: Generate signals on breakout from squeeze</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># signals = volatility_breakout_signals(df)</span>
<span class="c1"># print(f&quot;Buy signals: {(signals[&#39;signal&#39;] == 1).sum()}&quot;)</span>
<span class="c1"># print(f&quot;Sell signals: {(signals[&#39;signal&#39;] == -1).sum()}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">volatility_breakout_signals</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate breakout signals using Bollinger Bands.&quot;&quot;&quot;</span>

    <span class="c1"># Calculate indicators</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">BollingerBands</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>
    <span class="n">atr</span> <span class="o">=</span> <span class="n">ATR</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">upper</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">lower</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">bandwidth</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atr</span>

    <span class="c1"># Detect squeeze (bandwidth below 75% of 50-period average)</span>
    <span class="n">avg_bw</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">bandwidth</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;squeeze&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">bandwidth</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">avg_bw</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">)</span>

    <span class="c1"># ATR expansion (current &gt; 5 periods ago)</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;atr_expanding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atr</span> <span class="o">&gt;</span> <span class="n">atr</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Initialize signals</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Buy signal: Close above upper band + was in squeeze + ATR expanding</span>
    <span class="n">buy_condition</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bb</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span> <span class="o">&amp;</span> 
        <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;squeeze&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>  <span class="c1"># Was in squeeze</span>
        <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;atr_expanding&#39;</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># Sell signal: Close below lower band + was in squeeze + ATR expanding</span>
    <span class="n">sell_condition</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bb</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> 
        <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;squeeze&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;atr_expanding&#39;</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">buy_condition</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sell_condition</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="n">signals</span> <span class="o">=</span> <span class="n">volatility_breakout_signals</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Buy signals: </span><span class="si">{</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sell signals: </span><span class="si">{</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Show signal dates</span>
<span class="n">signal_days</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal_days</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recent signals:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">signal_days</span><span class="p">[[</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Volume Analysis</h1>
<h2>2.1 Why Volume Matters</h2>
<p>Volume measures the number of shares traded. It confirms price movements:</p>
<ul>
<li><strong>High Volume + Price Up:</strong> Strong buying pressure (bullish)</li>
<li><strong>High Volume + Price Down:</strong> Strong selling pressure (bearish)</li>
<li><strong>Low Volume + Price Move:</strong> Weak move, likely to reverse</li>
</ul>
<h3>Volume Patterns</h3>
<ul>
<li><strong>Climax Volume:</strong> Extremely high volume often marks reversals</li>
<li><strong>Dry Up:</strong> Decreasing volume in a trend suggests exhaustion</li>
<li><strong>Accumulation:</strong> Rising prices on increasing volume</li>
<li><strong>Distribution:</strong> Falling prices on increasing volume</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">VolumeAnalysis</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Volume analysis tools.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span>
    
    <span class="k">def</span> <span class="nf">average_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Simple moving average of volume.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">relative_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Current volume relative to average (1.0 = average).&quot;&quot;&quot;</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_volume</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">/</span> <span class="n">avg</span>
    
    <span class="k">def</span> <span class="nf">is_high_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Flag days with volume &gt; threshold √ó average.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_volume</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">threshold</span>
    
    <span class="k">def</span> <span class="nf">volume_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Volume trend: positive = increasing, negative = decreasing.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">price_volume_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze price-volume relationship.&quot;&quot;&quot;</span>
        <span class="n">price_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">high_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_high_volume</span><span class="p">()</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;price_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_change</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;high_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">high_vol</span>
        
        <span class="c1"># Classify days</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Normal&#39;</span>
        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_change</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">high_vol</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Strong Buying&#39;</span>
        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_change</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">high_vol</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Strong Selling&#39;</span>
        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_change</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">high_vol</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Weak Buying&#39;</span>
        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_change</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">high_vol</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Weak Selling&#39;</span>
        
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Analyze volume</span>
<span class="n">vol_analysis</span> <span class="o">=</span> <span class="n">VolumeAnalysis</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">])</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Avg_Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol_analysis</span><span class="o">.</span><span class="n">average_volume</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Rel_Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol_analysis</span><span class="o">.</span><span class="n">relative_volume</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Volume: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average Volume (20): </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Avg_Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative Volume: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Rel_Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>

<span class="c1"># Today&#39;s pattern</span>
<span class="n">pv</span> <span class="o">=</span> <span class="n">vol_analysis</span><span class="o">.</span><span class="n">price_volume_trend</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Today&#39;s Pattern: </span><span class="si">{</span><span class="n">pv</span><span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.2 On-Balance Volume (OBV)</h2>
<p>OBV is a cumulative indicator that adds volume on up days and subtracts on down days.</p>
<p><strong>Calculation:</strong>
- If Close &gt; Previous Close: OBV = Previous OBV + Volume
- If Close &lt; Previous Close: OBV = Previous OBV - Volume
- If Close = Previous Close: OBV = Previous OBV</p>
<p><strong>Interpretation:</strong>
- Rising OBV = Accumulation (buying)
- Falling OBV = Distribution (selling)
- Divergence between OBV and price can signal reversals</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">OBV</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;On-Balance Volume calculator.&quot;&quot;&quot;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate OBV.&quot;&quot;&quot;</span>
        <span class="n">price_change</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        
        <span class="c1"># Direction: 1 if up, -1 if down, 0 if unchanged</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">price_change</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> 
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">price_change</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="c1"># OBV is cumulative sum of signed volume</span>
        <span class="n">obv</span> <span class="o">=</span> <span class="p">(</span><span class="n">volume</span> <span class="o">*</span> <span class="n">direction</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">obv</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">trend</span><span class="p">(</span><span class="n">obv</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine OBV trend.&quot;&quot;&quot;</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">obv</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">obv</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s1">&#39;Bullish (Above MA)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Bearish (Below MA)&#39;</span>

<span class="c1"># Calculate OBV</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;OBV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OBV</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current OBV: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;OBV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OBV Trend: </span><span class="si">{</span><span class="n">OBV</span><span class="o">.</span><span class="n">trend</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;OBV&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.3 Volume-Price Trend (VPT)</h2>
<p>VPT combines price change percentage with volume.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">VPT</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Volume-Price Trend calculator.&quot;&quot;&quot;</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate VPT.&quot;&quot;&quot;</span>
        <span class="n">pct_change</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        <span class="n">vpt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pct_change</span> <span class="o">*</span> <span class="n">volume</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">vpt</span>

<span class="c1"># Calculate VPT</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;VPT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VPT</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current VPT: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;VPT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 4.2: Volume Confirmation System (Open-ended)</h3>
<p>Build a system that uses volume to confirm price signals.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">VolumeConfirmation</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use volume to confirm price signals.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    1. Check if breakouts are volume-confirmed</span>
<span class="sd">    2. Detect accumulation/distribution</span>
<span class="sd">    3. Find divergences between price and OBV</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">is_breakout_confirmed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># TODO: Check if recent high is on above-average volume</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">accumulation_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># TODO: Determine if stock is being accumulated or distributed</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">detect_divergence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># TODO: Find OBV divergence from price</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># vc = VolumeConfirmation(df)</span>
<span class="c1"># print(vc.accumulation_distribution())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 3: Support and Resistance</h1>
<h2>3.1 Understanding S/R Levels</h2>
<p><strong>Support:</strong> Price level where buying pressure exceeds selling (floor)
<strong>Resistance:</strong> Price level where selling pressure exceeds buying (ceiling)</p>
<h3>How S/R Forms</h3>
<ol>
<li><strong>Previous Highs/Lows:</strong> Price "remembers" past turning points</li>
<li><strong>Round Numbers:</strong> Psychological barriers ($100, $200, etc.)</li>
<li><strong>Moving Averages:</strong> Dynamic support/resistance</li>
<li><strong>Volume Nodes:</strong> Areas of high trading activity</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SupportResistance</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Identify support and resistance levels.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">close</span>
    
    <span class="k">def</span> <span class="nf">pivot_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate classic pivot points.</span>
<span class="sd">        Uses previous day&#39;s H, L, C.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Yesterday&#39;s high</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>   <span class="c1"># Yesterday&#39;s low</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># Yesterday&#39;s close</span>
        
        <span class="n">pivot</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">l</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;R3&#39;</span><span class="p">:</span> <span class="n">pivot</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">l</span><span class="p">),</span>
            <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">pivot</span> <span class="o">+</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">l</span><span class="p">),</span>
            <span class="s1">&#39;R1&#39;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pivot</span> <span class="o">-</span> <span class="n">l</span><span class="p">,</span>
            <span class="s1">&#39;Pivot&#39;</span><span class="p">:</span> <span class="n">pivot</span><span class="p">,</span>
            <span class="s1">&#39;S1&#39;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pivot</span> <span class="o">-</span> <span class="n">h</span><span class="p">,</span>
            <span class="s1">&#39;S2&#39;</span><span class="p">:</span> <span class="n">pivot</span> <span class="o">-</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">l</span><span class="p">),</span>
            <span class="s1">&#39;S3&#39;</span><span class="p">:</span> <span class="n">pivot</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">recent_extremes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find recent high and low.&quot;&quot;&quot;</span>
        <span class="n">recent</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="n">lookback</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;recent_high&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="p">[</span><span class="n">recent</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="s1">&#39;recent_low&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">[</span><span class="n">recent</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">round_number_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find nearby round number levels.&quot;&quot;&quot;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Determine step based on price</span>
        <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="k">elif</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="k">elif</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">5</span>
        
        <span class="c1"># Find levels around current price</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">current</span> <span class="o">/</span> <span class="n">step</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="n">base</span> <span class="o">-</span> <span class="n">step</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">step</span><span class="p">]</span>

<span class="c1"># Calculate S/R levels</span>
<span class="n">sr</span> <span class="o">=</span> <span class="n">SupportResistance</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pivot Points:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sr</span><span class="o">.</span><span class="n">pivot_points</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recent Extremes:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sr</span><span class="o">.</span><span class="n">recent_extremes</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Round Numbers: </span><span class="si">{</span><span class="n">sr</span><span class="o">.</span><span class="n">round_number_levels</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 4.3: Automated S/R Detector (Guided)</h3>
<p>Build an algorithm to find significant support/resistance levels.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">find_sr_levels</span><span class="p">(</span><span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                   <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">num_levels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find significant support and resistance levels.</span>
<span class="sd">    </span>
<span class="sd">    Method:</span>
<span class="sd">    1. Find local highs (resistance candidates)</span>
<span class="sd">    2. Find local lows (support candidates)</span>
<span class="sd">    3. Cluster nearby levels</span>
<span class="sd">    4. Return most significant levels</span>
<span class="sd">    </span>
<span class="sd">    Returns dict with &#39;support&#39; and &#39;resistance&#39; lists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement S/R detection</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># levels = find_sr_levels(df[&#39;High&#39;], df[&#39;Low&#39;])</span>
<span class="c1"># print(&quot;Support levels:&quot;, levels[&#39;support&#39;])</span>
<span class="c1"># print(&quot;Resistance levels:&quot;, levels[&#39;resistance&#39;])</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">find_sr_levels</span><span class="p">(</span><span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                   <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">num_levels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find significant support and resistance levels.&quot;&quot;&quot;</span>

    <span class="c1"># Get recent data</span>
    <span class="n">recent_high</span> <span class="o">=</span> <span class="n">high</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">:]</span>
    <span class="n">recent_low</span> <span class="o">=</span> <span class="n">low</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">:]</span>

    <span class="c1"># Find local maxima (resistance candidates)</span>
    <span class="k">def</span> <span class="nf">find_local_extremes</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">is_high</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">extremes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">-</span> <span class="n">order</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_high</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">order</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                    <span class="n">extremes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">order</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
                    <span class="n">extremes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">extremes</span>

    <span class="n">resistance_candidates</span> <span class="o">=</span> <span class="n">find_local_extremes</span><span class="p">(</span><span class="n">recent_high</span><span class="p">,</span> <span class="n">is_high</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">support_candidates</span> <span class="o">=</span> <span class="n">find_local_extremes</span><span class="p">(</span><span class="n">recent_low</span><span class="p">,</span> <span class="n">is_high</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Cluster nearby levels (within 1%)</span>
    <span class="k">def</span> <span class="nf">cluster_levels</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">levels</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">levels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_cluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">-</span> <span class="n">current_cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">current_cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
                <span class="n">current_cluster</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">current_cluster</span><span class="p">))</span>
                <span class="n">current_cluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">level</span><span class="p">]</span>

        <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">current_cluster</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">clusters</span>

    <span class="n">resistance</span> <span class="o">=</span> <span class="n">cluster_levels</span><span class="p">(</span><span class="n">resistance_candidates</span><span class="p">)</span>
    <span class="n">support</span> <span class="o">=</span> <span class="n">cluster_levels</span><span class="p">(</span><span class="n">support_candidates</span><span class="p">)</span>

    <span class="c1"># Get current price to filter levels</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">high</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Use last price as reference</span>

    <span class="c1"># Filter: resistance above current, support below</span>
    <span class="n">resistance</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resistance</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">current</span><span class="p">])[:</span><span class="n">num_levels</span><span class="p">]</span>
    <span class="n">support</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">support</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">current</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">num_levels</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;support&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">support</span><span class="p">],</span>
        <span class="s1">&#39;resistance&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resistance</span><span class="p">]</span>
    <span class="p">}</span>

<span class="n">levels</span> <span class="o">=</span> <span class="n">find_sr_levels</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current price: $</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Support levels: </span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;support&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resistance levels: </span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Complete Technical Dashboard</h1>
<p>Combining all volatility and volume indicators.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">VolatilityVolumeDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete volatility and volume analysis dashboard.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1y&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_indicators</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_calculate_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate all indicators.&quot;&quot;&quot;</span>
        <span class="n">high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span>
        <span class="n">low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span>
        <span class="n">close</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span>
        
        <span class="c1"># Volatility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATR</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR_Pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATR</span><span class="o">.</span><span class="n">atr_percent</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span>
        
        <span class="n">bb</span> <span class="o">=</span> <span class="n">BollingerBands</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_Upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">upper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_Lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_Width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">bandwidth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_PctB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">percent_b</span>
        
        <span class="c1"># Volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;OBV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OBV</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">close</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Avg_Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Rel_Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Avg_Volume&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">volatility_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get volatility summary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;atr&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;atr_pct&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR_Pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;bb_width&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_Width&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;bb_pct_b&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_PctB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;volatility_state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_volatility_state</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_volatility_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine volatility state.&quot;&quot;&quot;</span>
        <span class="n">bb_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_Width&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">avg_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_Width&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">bb_width</span> <span class="o">&lt;</span> <span class="n">avg_width</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Low (Squeeze)&#39;</span>
        <span class="k">elif</span> <span class="n">bb_width</span> <span class="o">&gt;</span> <span class="n">avg_width</span> <span class="o">*</span> <span class="mf">1.25</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;High (Expansion)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Normal&#39;</span>
    
    <span class="k">def</span> <span class="nf">volume_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get volume summary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;current_volume&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;avg_volume&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Avg_Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;relative_volume&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Rel_Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;obv_trend&#39;</span><span class="p">:</span> <span class="n">OBV</span><span class="o">.</span><span class="n">trend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;OBV&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;volume_state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_volume_state</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_volume_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Determine volume state.&quot;&quot;&quot;</span>
        <span class="n">rel_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Rel_Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">rel_vol</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;High&#39;</span>
        <span class="k">elif</span> <span class="n">rel_vol</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Low&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Normal&#39;</span>
    
    <span class="k">def</span> <span class="nf">sr_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get support/resistance levels.&quot;&quot;&quot;</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">SupportResistance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pivot_points&#39;</span><span class="p">:</span> <span class="n">sr</span><span class="o">.</span><span class="n">pivot_points</span><span class="p">(),</span>
            <span class="s1">&#39;recent_extremes&#39;</span><span class="p">:</span> <span class="n">sr</span><span class="o">.</span><span class="n">recent_extremes</span><span class="p">(),</span>
            <span class="s1">&#39;round_numbers&#39;</span><span class="p">:</span> <span class="n">sr</span><span class="o">.</span><span class="n">round_number_levels</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print full report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VOLATILITY &amp; VOLUME ANALYSIS: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Price: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility_summary</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">VOLATILITY:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ATR: $</span><span class="si">{</span><span class="n">vol</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">vol</span><span class="p">[</span><span class="s1">&#39;atr_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  BB Width: </span><span class="si">{</span><span class="n">vol</span><span class="p">[</span><span class="s1">&#39;bb_width&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  %B: </span><span class="si">{</span><span class="n">vol</span><span class="p">[</span><span class="s1">&#39;bb_pct_b&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  State: </span><span class="si">{</span><span class="n">vol</span><span class="p">[</span><span class="s1">&#39;volatility_state&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_summary</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">VOLUME:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Current: </span><span class="si">{</span><span class="n">volume</span><span class="p">[</span><span class="s1">&#39;current_volume&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Relative: </span><span class="si">{</span><span class="n">volume</span><span class="p">[</span><span class="s1">&#39;relative_volume&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x average&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OBV Trend: </span><span class="si">{</span><span class="n">volume</span><span class="p">[</span><span class="s1">&#39;obv_trend&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  State: </span><span class="si">{</span><span class="n">volume</span><span class="p">[</span><span class="s1">&#39;volume_state&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sr_levels</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">KEY LEVELS:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pivot: $</span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;pivot_points&#39;</span><span class="p">][</span><span class="s1">&#39;Pivot&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  R1: $</span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;pivot_points&#39;</span><span class="p">][</span><span class="s1">&#39;R1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  S1: $</span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;pivot_points&#39;</span><span class="p">][</span><span class="s1">&#39;S1&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Recent High: $</span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;recent_extremes&#39;</span><span class="p">][</span><span class="s1">&#39;recent_high&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Recent Low: $</span><span class="si">{</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;recent_extremes&#39;</span><span class="p">][</span><span class="s1">&#39;recent_low&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test the dashboard</span>
<span class="n">dashboard</span> <span class="o">=</span> <span class="n">VolatilityVolumeDashboard</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 4.4: Analyze FAANG Volatility (Open-ended)</h3>
<p>Compare volatility across all FAANG stocks.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your code here - compare FAANG volatility</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 4.5: Volume Anomaly Detector (Guided)</h3>
<p>Build a system to detect unusual volume patterns.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">detect_volume_anomalies</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect days with unusual volume.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with Volume column</span>
<span class="sd">        threshold: Multiple of average to flag as anomaly</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with anomaly dates and details</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate average volume</span>
    <span class="c1"># TODO: Find days above threshold</span>
    <span class="c1"># TODO: Classify as accumulation or distribution</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># anomalies = detect_volume_anomalies(df)</span>
<span class="c1"># print(anomalies)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 4.6: Complete Technical System (Open-ended)</h3>
<p>Combine Modules 3 and 4 indicators into a complete analysis system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your complete technical analysis system here</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>ATR:</strong> Measures average price range, useful for stops</li>
<li><strong>Bollinger Bands:</strong> Show volatility through expanding/contracting bands</li>
<li><strong>BB Squeeze:</strong> Low volatility often precedes breakouts</li>
<li><strong>Volume Confirmation:</strong> Strong moves need high volume</li>
<li><strong>OBV:</strong> Cumulative volume shows accumulation/distribution</li>
<li><strong>Support/Resistance:</strong> Key levels where price may reverse</li>
<li><strong>Combine Indicators:</strong> Volume + Volatility = Better signals</li>
</ol>
<hr />
<p><strong>Next Module:</strong> Stock Screening</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="5"><div class="md-cell module-header"><h1>Module 5: Stock Screening</h1>
<h2>Part 1: Stock Market Foundations</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Modules 1-4</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Build stock screeners combining fundamental and technical criteria</li>
<li>Define and manage stock universes</li>
<li>Create growth and value screening strategies</li>
<li>Rank and filter stocks systematically</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Required imports</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="c1"># Our consistent stock universe</span>
<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="c1"># Extended universe for screening examples</span>
<span class="n">TECH_STOCKS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NVDA&#39;</span><span class="p">,</span> <span class="s1">&#39;TSLA&#39;</span><span class="p">,</span> <span class="s1">&#39;AMD&#39;</span><span class="p">,</span> <span class="s1">&#39;INTC&#39;</span><span class="p">,</span> <span class="s1">&#39;CRM&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FAANG: </span><span class="si">{</span><span class="n">FAANG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tech universe: </span><span class="si">{</span><span class="n">TECH_STOCKS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: Building Stock Screeners</h1>
<h2>1.1 What is Stock Screening?</h2>
<p><strong>Stock screening</strong> is the process of filtering stocks based on specific criteria to find candidates that match your investment strategy.</p>
<h3>Types of Screens</h3>
<ol>
<li><strong>Fundamental Screens:</strong> Based on financial metrics (P/E, ROE, etc.)</li>
<li><strong>Technical Screens:</strong> Based on price/volume patterns</li>
<li><strong>Combined Screens:</strong> Both fundamental and technical criteria</li>
</ol>
<h3>Screening Process</h3>
<ol>
<li>Define your universe (what stocks to consider)</li>
<li>Set filtering criteria (what makes a stock pass/fail)</li>
<li>Rank passing stocks (which are best)</li>
<li>Review results (human judgment still matters)</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">StockDataCollector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Collect data for screening.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">collect_fundamentals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Collect fundamental data for all symbols.&quot;&quot;&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">info</span>
                
                <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;longName&#39;</span><span class="p">,</span> <span class="n">symbol</span><span class="p">),</span>
                    <span class="s1">&#39;sector&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sector&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;market_cap&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marketCap&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentPrice&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;pe_ratio&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trailingPE&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;forward_pe&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;forwardPE&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;peg_ratio&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pegRatio&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;pb_ratio&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priceToBook&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;ps_ratio&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priceToSalesTrailing12Months&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;profit_margin&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profitMargins&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;roe&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;returnOnEquity&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;roa&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;returnOnAssets&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;revenue_growth&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;revenueGrowth&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;earnings_growth&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;earningsGrowth&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;debt_to_equity&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debtToEquity&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;current_ratio&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentRatio&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;dividend_yield&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dividendYield&#39;</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error collecting </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fundamentals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fundamentals&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">collect_technicals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;6mo&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Collect technical data for all symbols.&quot;&quot;&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="n">close</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
                <span class="n">high</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span>
                <span class="n">low</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span>
                
                <span class="c1"># Calculate technicals</span>
                <span class="n">sma_20</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">sma_50</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="c1"># RSI</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
                <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
                <span class="n">rsi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">)))</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="c1"># Returns</span>
                <span class="n">returns_1m</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">21</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">21</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">returns_3m</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">63</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">63</span> <span class="k">else</span> <span class="kc">None</span>
                
                <span class="c1"># 52-week high</span>
                <span class="n">high_52w</span> <span class="o">=</span> <span class="n">high</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">pct_from_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">high_52w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                
                <span class="c1"># Volume</span>
                <span class="n">avg_volume</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">rel_volume</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">avg_volume</span>
                
                <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;sma_20&#39;</span><span class="p">:</span> <span class="n">sma_20</span><span class="p">,</span>
                    <span class="s1">&#39;sma_50&#39;</span><span class="p">:</span> <span class="n">sma_50</span><span class="p">,</span>
                    <span class="s1">&#39;above_sma20&#39;</span><span class="p">:</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sma_20</span><span class="p">,</span>
                    <span class="s1">&#39;above_sma50&#39;</span><span class="p">:</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sma_50</span><span class="p">,</span>
                    <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">rsi</span><span class="p">,</span>
                    <span class="s1">&#39;return_1m&#39;</span><span class="p">:</span> <span class="n">returns_1m</span><span class="p">,</span>
                    <span class="s1">&#39;return_3m&#39;</span><span class="p">:</span> <span class="n">returns_3m</span><span class="p">,</span>
                    <span class="s1">&#39;pct_from_52w_high&#39;</span><span class="p">:</span> <span class="n">pct_from_high</span><span class="p">,</span>
                    <span class="s1">&#39;avg_volume&#39;</span><span class="p">:</span> <span class="n">avg_volume</span><span class="p">,</span>
                    <span class="s1">&#39;rel_volume&#39;</span><span class="p">:</span> <span class="n">rel_volume</span>
                <span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error collecting technicals for </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;technicals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;technicals&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">collect_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;6mo&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Collect and merge all data.&quot;&quot;&quot;</span>
        <span class="n">fund</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_fundamentals</span><span class="p">()</span>
        <span class="n">tech</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_technicals</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        
        <span class="c1"># Merge on symbol</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="n">tech</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_tech&#39;</span><span class="p">))</span>
        
        <span class="c1"># Use technical price if fundamental price missing</span>
        <span class="k">if</span> <span class="s1">&#39;price_tech&#39;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;price_tech&#39;</span><span class="p">])</span>
            <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;price_tech&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;merged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span>
        <span class="k">return</span> <span class="n">merged</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Collect data for our tech universe</span>
<span class="n">collector</span> <span class="o">=</span> <span class="n">StockDataCollector</span><span class="p">(</span><span class="n">TECH_STOCKS</span><span class="p">)</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">collect_all</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collected data for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stock_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> stocks&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columns: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">stock_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample data:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stock_data</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;return_1m&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 Basic Screener Framework</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ScreenCriterion</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A single screening criterion.&quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">column</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">operator</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;gt&#39;, &#39;lt&#39;, &#39;gte&#39;, &#39;lte&#39;, &#39;eq&#39;, &#39;between&#39;</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">any</span>
    <span class="n">value2</span><span class="p">:</span> <span class="nb">any</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># For &#39;between&#39; operator</span>
    
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply criterion to DataFrame, return boolean mask.&quot;&quot;&quot;</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;gt&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">col</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;lt&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;gte&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">col</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;lte&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">col</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;eq&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">col</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;between&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">col</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown operator: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">StockScreener</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Flexible stock screening framework.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criterion</span><span class="p">:</span> <span class="n">ScreenCriterion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;StockScreener&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a screening criterion.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">criterion</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">add_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">operator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                   <span class="n">value</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">value2</span><span class="p">:</span> <span class="nb">any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;StockScreener&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convenience method to add filter.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ScreenCriterion</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value2</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">screen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply all criteria and return passing stocks.&quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">criterion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">criterion_mask</span> <span class="o">=</span> <span class="n">criterion</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="c1"># Handle NaN - treat as not passing</span>
                <span class="n">criterion_mask</span> <span class="o">=</span> <span class="n">criterion_mask</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">criterion_mask</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Column </span><span class="si">{</span><span class="n">criterion</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;StockScreener&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clear all criteria.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get summary of active criteria.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Active Criteria:&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;between&#39;</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">value2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">column</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">operator</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Example: Basic value screen</span>
<span class="n">screener</span> <span class="o">=</span> <span class="n">StockScreener</span><span class="p">(</span><span class="n">stock_data</span><span class="p">)</span>

<span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;Low P/E&quot;</span><span class="p">,</span> <span class="s2">&quot;pe_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
<span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;Positive Momentum&quot;</span><span class="p">,</span> <span class="s2">&quot;return_1m&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;Above 50 SMA&quot;</span><span class="p">,</span> <span class="s2">&quot;above_sma50&quot;</span><span class="p">,</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">screener</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">screener</span><span class="o">.</span><span class="n">screen</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stocks passing screen: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;return_1m&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 5.1: Custom Screener Criteria (Guided)</h3>
<p>Build a screener with multiple criteria.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">quality_growth_screen</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Screen for quality growth stocks.</span>
<span class="sd">    </span>
<span class="sd">    Criteria:</span>
<span class="sd">    - Profit margin &gt; 10%</span>
<span class="sd">    - ROE &gt; 15%</span>
<span class="sd">    - Revenue growth &gt; 10%</span>
<span class="sd">    - P/E between 15 and 40</span>
<span class="sd">    - Above 50-day SMA</span>
<span class="sd">    </span>
<span class="sd">    Returns filtered DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement screening logic</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># results = quality_growth_screen(stock_data)</span>
<span class="c1"># print(results)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">quality_growth_screen</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Screen for quality growth stocks.&quot;&quot;&quot;</span>
    <span class="n">screener</span> <span class="o">=</span> <span class="n">StockScreener</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Profit margin &gt; 10% (stored as decimal)</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;Profit Margin &gt; 10%&quot;</span><span class="p">,</span> <span class="s2">&quot;profit_margin&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>

    <span class="c1"># ROE &gt; 15% (stored as decimal)</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;ROE &gt; 15%&quot;</span><span class="p">,</span> <span class="s2">&quot;roe&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>

    <span class="c1"># Revenue growth &gt; 10% (stored as decimal)</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;Revenue Growth &gt; 10%&quot;</span><span class="p">,</span> <span class="s2">&quot;revenue_growth&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>

    <span class="c1"># P/E between 15 and 40</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;P/E 15-40&quot;</span><span class="p">,</span> <span class="s2">&quot;pe_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;between&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>

    <span class="c1"># Above 50 SMA</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;Above 50 SMA&quot;</span><span class="p">,</span> <span class="s2">&quot;above_sma50&quot;</span><span class="p">,</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">screener</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">screener</span><span class="o">.</span><span class="n">screen</span><span class="p">()</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">quality_growth_screen</span><span class="p">(</span><span class="n">stock_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Stocks passing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;profit_margin&#39;</span><span class="p">,</span> <span class="s1">&#39;roe&#39;</span><span class="p">,</span> <span class="s1">&#39;revenue_growth&#39;</span><span class="p">,</span> <span class="s1">&#39;pe_ratio&#39;</span><span class="p">]])</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Universe Selection</h1>
<h2>2.1 Defining Your Universe</h2>
<p>The <strong>universe</strong> is the set of stocks you consider for screening. Common universes:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Universe</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>S&amp;P 500</td>
<td>500</td>
<td>Large-cap US stocks</td>
</tr>
<tr>
<td>NASDAQ 100</td>
<td>100</td>
<td>Large tech/growth</td>
</tr>
<tr>
<td>Russell 2000</td>
<td>2000</td>
<td>Small-cap US stocks</td>
</tr>
<tr>
<td>Sector-specific</td>
<td>Varies</td>
<td>Focus on one sector</td>
</tr>
<tr>
<td>Custom</td>
<td>Varies</td>
<td>Your own selection</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">UniverseManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage stock universes.&quot;&quot;&quot;</span>
    
    <span class="c1"># Predefined universes</span>
    <span class="n">UNIVERSES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;faang&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">],</span>
        <span class="s1">&#39;mag7&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;NVDA&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;TSLA&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tech_large&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NVDA&#39;</span><span class="p">,</span> <span class="s1">&#39;TSLA&#39;</span><span class="p">,</span> 
                       <span class="s1">&#39;AMD&#39;</span><span class="p">,</span> <span class="s1">&#39;INTC&#39;</span><span class="p">,</span> <span class="s1">&#39;CRM&#39;</span><span class="p">,</span> <span class="s1">&#39;ORCL&#39;</span><span class="p">,</span> <span class="s1">&#39;ADBE&#39;</span><span class="p">,</span> <span class="s1">&#39;CSCO&#39;</span><span class="p">,</span> <span class="s1">&#39;IBM&#39;</span><span class="p">],</span>
        <span class="s1">&#39;financials&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;JPM&#39;</span><span class="p">,</span> <span class="s1">&#39;BAC&#39;</span><span class="p">,</span> <span class="s1">&#39;WFC&#39;</span><span class="p">,</span> <span class="s1">&#39;GS&#39;</span><span class="p">,</span> <span class="s1">&#39;MS&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;BLK&#39;</span><span class="p">,</span> <span class="s1">&#39;SCHW&#39;</span><span class="p">],</span>
        <span class="s1">&#39;healthcare&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;JNJ&#39;</span><span class="p">,</span> <span class="s1">&#39;UNH&#39;</span><span class="p">,</span> <span class="s1">&#39;PFE&#39;</span><span class="p">,</span> <span class="s1">&#39;ABBV&#39;</span><span class="p">,</span> <span class="s1">&#39;MRK&#39;</span><span class="p">,</span> <span class="s1">&#39;LLY&#39;</span><span class="p">,</span> <span class="s1">&#39;TMO&#39;</span><span class="p">,</span> <span class="s1">&#39;ABT&#39;</span><span class="p">],</span>
        <span class="s1">&#39;consumer&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;WMT&#39;</span><span class="p">,</span> <span class="s1">&#39;PG&#39;</span><span class="p">,</span> <span class="s1">&#39;KO&#39;</span><span class="p">,</span> <span class="s1">&#39;PEP&#39;</span><span class="p">,</span> <span class="s1">&#39;COST&#39;</span><span class="p">,</span> <span class="s1">&#39;HD&#39;</span><span class="p">,</span> <span class="s1">&#39;MCD&#39;</span><span class="p">,</span> <span class="s1">&#39;NKE&#39;</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_universes</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get a universe by name.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNIVERSES</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNIVERSES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_universes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_universes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown universe: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_custom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Add a custom universe.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_universes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbols</span>
    
    <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Combine multiple universes.&quot;&quot;&quot;</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">combined</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>  <span class="c1"># Remove duplicates</span>
    
    <span class="k">def</span> <span class="nf">filter_by_market_cap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                             <span class="n">min_cap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                             <span class="n">max_cap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Filter symbols by market cap.&quot;&quot;&quot;</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
                <span class="n">cap</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marketCap&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">min_cap</span> <span class="ow">and</span> <span class="n">cap</span> <span class="o">&lt;</span> <span class="n">min_cap</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">max_cap</span> <span class="ow">and</span> <span class="n">cap</span> <span class="o">&gt;</span> <span class="n">max_cap</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="n">filtered</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">return</span> <span class="n">filtered</span>
    
    <span class="k">def</span> <span class="nf">list_available</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;List all available universes.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UNIVERSES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_universes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># Test universe manager</span>
<span class="n">universe</span> <span class="o">=</span> <span class="n">UniverseManager</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available universes:&quot;</span><span class="p">,</span> <span class="n">universe</span><span class="o">.</span><span class="n">list_available</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MAG7: </span><span class="si">{</span><span class="n">universe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mag7&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Combined tech + financials: </span><span class="si">{</span><span class="n">universe</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="s1">&#39;tech_large&#39;</span><span class="p">,</span> <span class="s1">&#39;financials&#39;</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 5.2: Dynamic Universe Builder (Open-ended)</h3>
<p>Build a universe dynamically based on criteria.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">DynamicUniverse</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a universe dynamically based on criteria.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    1. Start with base universe</span>
<span class="sd">    2. Filter by sector</span>
<span class="sd">    3. Filter by market cap tier</span>
<span class="sd">    4. Filter by liquidity (average volume)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">base_symbols</span>
    
    <span class="k">def</span> <span class="nf">filter_by_sector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sectors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;DynamicUniverse&#39;</span><span class="p">:</span>
        <span class="c1"># TODO: Filter to only specified sectors</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">filter_by_cap_tier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;DynamicUniverse&#39;</span><span class="p">:</span>
        <span class="c1"># TODO: Filter by market cap tier (mega, large, mid, small)</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">filter_by_liquidity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_avg_volume</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;DynamicUniverse&#39;</span><span class="p">:</span>
        <span class="c1"># TODO: Filter by minimum average volume</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span>

<span class="c1"># Test</span>
<span class="c1"># dynamic = DynamicUniverse(TECH_STOCKS)</span>
<span class="c1"># dynamic.filter_by_sector([&#39;Technology&#39;])</span>
<span class="c1"># print(dynamic.get_symbols())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 3: Growth &amp; Value Screens</h1>
<h2>3.1 Growth Screening</h2>
<p>Growth investors look for companies with strong earnings and revenue growth.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">GrowthScreener</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Screen for growth stocks.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
    
    <span class="k">def</span> <span class="nf">high_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_revenue_growth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
                    <span class="n">min_earnings_growth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find high-growth stocks.</span>
<span class="sd">        </span>
<span class="sd">        Criteria:</span>
<span class="sd">        - Revenue growth &gt; threshold</span>
<span class="sd">        - Earnings growth &gt; threshold</span>
<span class="sd">        - Positive profit margin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;revenue_growth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_revenue_growth</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;earnings_growth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_earnings_growth</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;profit_margin&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">momentum_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_return_3m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Growth stocks with price momentum.</span>
<span class="sd">        </span>
<span class="sd">        Criteria:</span>
<span class="sd">        - Positive revenue growth</span>
<span class="sd">        - 3-month return &gt; threshold</span>
<span class="sd">        - Above 50-day SMA</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;revenue_growth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_3m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_return_3m</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;above_sma50&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">garp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_peg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Growth At Reasonable Price (GARP).</span>
<span class="sd">        </span>
<span class="sd">        Criteria:</span>
<span class="sd">        - PEG ratio &lt; threshold</span>
<span class="sd">        - Positive growth</span>
<span class="sd">        - Reasonable P/E (&lt; 50)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;peg_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_peg</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;peg_ratio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;revenue_growth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Test growth screens</span>
<span class="n">growth</span> <span class="o">=</span> <span class="n">GrowthScreener</span><span class="p">(</span><span class="n">stock_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;High Growth Stocks:&quot;</span><span class="p">)</span>
<span class="n">high_growth</span> <span class="o">=</span> <span class="n">growth</span><span class="o">.</span><span class="n">high_growth</span><span class="p">(</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>  <span class="c1"># Lower thresholds for demo</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">high_growth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">high_growth</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;revenue_growth&#39;</span><span class="p">,</span> <span class="s1">&#39;earnings_growth&#39;</span><span class="p">,</span> <span class="s1">&#39;profit_margin&#39;</span><span class="p">]])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No stocks passed the screen&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">GARP Stocks:&quot;</span><span class="p">)</span>
<span class="n">garp</span> <span class="o">=</span> <span class="n">growth</span><span class="o">.</span><span class="n">garp</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>  <span class="c1"># Higher threshold for demo</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">garp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">garp</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;peg_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;revenue_growth&#39;</span><span class="p">]])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No stocks passed the screen&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.2 Value Screening</h2>
<p>Value investors look for stocks trading below their intrinsic value.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ValueScreener</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Screen for value stocks.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
    
    <span class="k">def</span> <span class="nf">deep_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_pe</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">max_pb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deep value screen.</span>
<span class="sd">        </span>
<span class="sd">        Criteria:</span>
<span class="sd">        - P/E &lt; threshold</span>
<span class="sd">        - P/B &lt; threshold</span>
<span class="sd">        - Positive earnings (P/E &gt; 0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_pe</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pb_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_pb</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pb_ratio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">quality_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_pe</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">min_roe</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.12</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Quality at a value price.</span>
<span class="sd">        </span>
<span class="sd">        Criteria:</span>
<span class="sd">        - P/E &lt; threshold (value)</span>
<span class="sd">        - ROE &gt; threshold (quality)</span>
<span class="sd">        - Positive profit margin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_pe</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;roe&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_roe</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;profit_margin&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">dividend_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_yield</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">max_pe</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dividend value stocks.</span>
<span class="sd">        </span>
<span class="sd">        Criteria:</span>
<span class="sd">        - Dividend yield &gt; threshold</span>
<span class="sd">        - P/E &lt; threshold</span>
<span class="sd">        - Profitable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dividend_yield&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_yield</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_pe</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Test value screens</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">ValueScreener</span><span class="p">(</span><span class="n">stock_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deep Value Stocks:&quot;</span><span class="p">)</span>
<span class="n">deep</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">deep_value</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># Relaxed for tech stocks</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">deep</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">deep</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;pb_ratio&#39;</span><span class="p">]])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No stocks passed (tech stocks rarely pass deep value screens)&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Quality Value Stocks:&quot;</span><span class="p">)</span>
<span class="n">quality</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">quality_value</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">quality</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">quality</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;roe&#39;</span><span class="p">,</span> <span class="s1">&#39;profit_margin&#39;</span><span class="p">]])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No stocks passed the screen&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 5.3: Combined Growth-Value Screen (Guided)</h3>
<p>Build a screen that finds stocks with both growth and value characteristics.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">growth_at_value_screen</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find stocks with growth characteristics at value prices.</span>
<span class="sd">    </span>
<span class="sd">    Growth criteria:</span>
<span class="sd">    - Revenue growth &gt; 5%</span>
<span class="sd">    - Positive earnings growth</span>
<span class="sd">    </span>
<span class="sd">    Value criteria:</span>
<span class="sd">    - P/E &lt; 30</span>
<span class="sd">    - PEG &lt; 2</span>
<span class="sd">    </span>
<span class="sd">    Quality filter:</span>
<span class="sd">    - ROE &gt; 10%</span>
<span class="sd">    </span>
<span class="sd">    Technical filter:</span>
<span class="sd">    - RSI between 30 and 70 (not overbought/oversold)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement combined screen</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># results = growth_at_value_screen(stock_data)</span>
<span class="c1"># print(results)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">growth_at_value_screen</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find stocks with growth characteristics at value prices.&quot;&quot;&quot;</span>

    <span class="n">screener</span> <span class="o">=</span> <span class="n">StockScreener</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># Growth criteria</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;Revenue Growth &gt; 5%&quot;</span><span class="p">,</span> <span class="s2">&quot;revenue_growth&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;Positive Earnings Growth&quot;</span><span class="p">,</span> <span class="s2">&quot;earnings_growth&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Value criteria</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;P/E &lt; 30&quot;</span><span class="p">,</span> <span class="s2">&quot;pe_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;P/E &gt; 0&quot;</span><span class="p">,</span> <span class="s2">&quot;pe_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;PEG &lt; 2&quot;</span><span class="p">,</span> <span class="s2">&quot;peg_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Quality filter</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;ROE &gt; 10%&quot;</span><span class="p">,</span> <span class="s2">&quot;roe&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>

    <span class="c1"># Technical filter</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;RSI &gt; 30&quot;</span><span class="p">,</span> <span class="s2">&quot;rsi&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;RSI &lt; 70&quot;</span><span class="p">,</span> <span class="s2">&quot;rsi&quot;</span><span class="p">,</span> <span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">screener</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">screener</span><span class="o">.</span><span class="n">screen</span><span class="p">()</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">growth_at_value_screen</span><span class="p">(</span><span class="n">stock_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Stocks passing: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">display_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;revenue_growth&#39;</span><span class="p">,</span> <span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;peg_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;roe&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">]</span>
    <span class="n">available_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">display_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">available_cols</span><span class="p">])</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Ranking and Scoring</h1>
<h2>4.1 Ranking Stocks</h2>
<p>After filtering, rank stocks to find the best candidates.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">StockRanker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Rank stocks based on multiple factors.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">add_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                   <span class="n">ascending</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a ranking factor.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name: Factor name</span>
<span class="sd">            column: Data column to use</span>
<span class="sd">            ascending: If True, lower values are better</span>
<span class="sd">            weight: Factor weight in final score</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Rank the column (1 = best)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Handle missing values</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        
        <span class="c1"># Percentile rank (0-100, higher = better after adjustment)</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">,</span> <span class="n">pct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ranks</span> <span class="o">*</span> <span class="n">weight</span>
        
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">calculate_composite</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate composite score from all factors.&quot;&quot;&quot;</span>
        <span class="c1"># Get all rank columns</span>
        <span class="n">rank_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_rank&#39;</span><span class="p">)]</span>
        
        <span class="c1"># Average of all ranks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;composite_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">rank_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Merge with original data</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;composite_score&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">rank_cols</span><span class="p">],</span>
            <span class="n">on</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;composite_score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">top_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get top N ranked stocks.&quot;&quot;&quot;</span>
        <span class="n">ranked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_composite</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ranked</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Example: Multi-factor ranking</span>
<span class="n">ranker</span> <span class="o">=</span> <span class="n">StockRanker</span><span class="p">(</span><span class="n">stock_data</span><span class="p">)</span>

<span class="c1"># Add factors (weight indicates importance)</span>
<span class="n">ranker</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span> <span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># Lower P/E = better</span>
<span class="n">ranker</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span><span class="s1">&#39;Growth&#39;</span><span class="p">,</span> <span class="s1">&#39;revenue_growth&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># Higher growth = better</span>
<span class="n">ranker</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span><span class="s1">&#39;Momentum&#39;</span><span class="p">,</span> <span class="s1">&#39;return_3m&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Higher return = better</span>
<span class="n">ranker</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span><span class="s1">&#39;Quality&#39;</span><span class="p">,</span> <span class="s1">&#39;roe&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># Higher ROE = better</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top 5 Ranked Stocks:&quot;</span><span class="p">)</span>
<span class="n">top</span> <span class="o">=</span> <span class="n">ranker</span><span class="o">.</span><span class="n">top_n</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">top</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;composite_score&#39;</span><span class="p">,</span> <span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;revenue_growth&#39;</span><span class="p">,</span> <span class="s1">&#39;roe&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 5.4: Custom Scoring System (Open-ended)</h3>
<p>Build your own scoring system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">CustomScorer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom stock scoring system.</span>
<span class="sd">    </span>
<span class="sd">    Create a 0-100 score based on:</span>
<span class="sd">    1. Valuation score (25 pts)</span>
<span class="sd">    2. Growth score (25 pts)</span>
<span class="sd">    3. Quality score (25 pts)</span>
<span class="sd">    4. Technical score (25 pts)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
    
    <span class="k">def</span> <span class="nf">valuation_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># TODO: Score based on P/E, PEG, P/B</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">growth_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># TODO: Score based on revenue/earnings growth</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">quality_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># TODO: Score based on ROE, margins</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">technical_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># TODO: Score based on RSI, momentum</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">calculate_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: Calculate all scores and return ranked DataFrame</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># scorer = CustomScorer(stock_data)</span>
<span class="c1"># print(scorer.calculate_scores())</span>
</code></pre></div>
<div class="md-cell module-project"><hr />
<h1>Module Project: Complete Screening System</h1>
<p>Build a comprehensive stock screening system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ComprehensiveScreener</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete stock screening system.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Multiple predefined screens</span>
<span class="sd">    - Custom screen builder</span>
<span class="sd">    - Ranking system</span>
<span class="sd">    - Report generation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collector</span> <span class="o">=</span> <span class="n">StockDataCollector</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">refresh_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ComprehensiveScreener&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Refresh all data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collector</span><span class="o">.</span><span class="n">collect_all</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">growth_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run growth stock screen.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">GrowthScreener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">high_growth</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">value_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run value stock screen.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ValueScreener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">quality_value</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">momentum_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Screen for momentum stocks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_data</span><span class="p">()</span>
        
        <span class="n">screener</span> <span class="o">=</span> <span class="n">StockScreener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;Positive 1M Return&quot;</span><span class="p">,</span> <span class="s2">&quot;return_1m&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;Positive 3M Return&quot;</span><span class="p">,</span> <span class="s2">&quot;return_3m&quot;</span><span class="p">,</span> <span class="s2">&quot;gt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;Above 50 SMA&quot;</span><span class="p">,</span> <span class="s2">&quot;above_sma50&quot;</span><span class="p">,</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;RSI &lt; 70&quot;</span><span class="p">,</span> <span class="s2">&quot;rsi&quot;</span><span class="p">,</span> <span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">screener</span><span class="o">.</span><span class="n">screen</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">custom_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run custom screen.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            criteria: List of (name, column, operator, value) tuples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_data</span><span class="p">()</span>
        
        <span class="n">screener</span> <span class="o">=</span> <span class="n">StockScreener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
            <span class="n">screener</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">screener</span><span class="o">.</span><span class="n">screen</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">rank_stocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rank all stocks.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            factors: List of (name, column, ascending, weight) tuples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_data</span><span class="p">()</span>
        
        <span class="n">ranker</span> <span class="o">=</span> <span class="n">StockRanker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">ascending</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
            <span class="n">ranker</span><span class="o">.</span><span class="n">add_factor</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">ascending</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">ranker</span><span class="o">.</span><span class="n">calculate_composite</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">summary_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print summary of all screens.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refresh_data</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STOCK SCREENING SUMMARY&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Universe: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span><span class="si">}</span><span class="s2"> stocks&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data collected: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> stocks&quot;</span><span class="p">)</span>
        
        <span class="c1"># Growth screen</span>
        <span class="n">growth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">growth_screen</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">GROWTH SCREEN: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">growth</span><span class="p">)</span><span class="si">}</span><span class="s2"> stocks&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">growth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Top: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">growth</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Value screen</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_screen</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">VALUE SCREEN: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2"> stocks&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Top: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Momentum screen</span>
        <span class="n">momentum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum_screen</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MOMENTUM SCREEN: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">momentum</span><span class="p">)</span><span class="si">}</span><span class="s2"> stocks&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">momentum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Top: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">momentum</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Overall ranking</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span> <span class="s1">&#39;pe_ratio&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Growth&#39;</span><span class="p">,</span> <span class="s1">&#39;revenue_growth&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Quality&#39;</span><span class="p">,</span> <span class="s1">&#39;roe&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Momentum&#39;</span><span class="p">,</span> <span class="s1">&#39;return_3m&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">ranked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_stocks</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">OVERALL TOP 5 (Multi-Factor Rank):&quot;</span><span class="p">)</span>
        <span class="n">top5</span> <span class="o">=</span> <span class="n">ranked</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top5</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: Score </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;composite_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Test the comprehensive screener</span>
<span class="n">screener</span> <span class="o">=</span> <span class="n">ComprehensiveScreener</span><span class="p">(</span><span class="n">TECH_STOCKS</span><span class="p">)</span>
<span class="n">screener</span><span class="o">.</span><span class="n">refresh_data</span><span class="p">()</span>
<span class="n">screener</span><span class="o">.</span><span class="n">summary_report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 5.5: Screen FAANG Stocks (Open-ended)</h3>
<p>Use the screening tools to analyze FAANG stocks.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your FAANG analysis here</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 5.6: Build Your Own Screen (Open-ended)</h3>
<p>Design and implement your own custom screening strategy.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your custom screening strategy here</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>Screening Process:</strong> Universe ‚Üí Filter ‚Üí Rank ‚Üí Review</li>
<li><strong>Universe Matters:</strong> Start with appropriate stock universe</li>
<li><strong>Combine Criteria:</strong> Fundamental + Technical = Better results</li>
<li><strong>Growth Screens:</strong> Focus on revenue/earnings growth</li>
<li><strong>Value Screens:</strong> Focus on P/E, P/B, PEG ratios</li>
<li><strong>Ranking:</strong> Multi-factor ranking finds best candidates</li>
<li><strong>Flexibility:</strong> Build reusable, customizable tools</li>
</ol>
<hr />
<h1>Part 1 Complete!</h1>
<p>You've completed the Stock Market Foundations section. You now have:</p>
<ul>
<li>‚úÖ Understanding of stock market mechanics</li>
<li>‚úÖ Skills to fetch and process stock data</li>
<li>‚úÖ Fundamental analysis tools</li>
<li>‚úÖ Technical analysis indicators</li>
<li>‚úÖ Stock screening capabilities</li>
</ul>
<p><strong>Next:</strong> Part 2 - Strategy Development</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="6"><div class="md-cell module-header"><h1>Module 6: Earnings-Based Strategies</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Part 1 (Modules 1-5)</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Access and analyze earnings calendar data</li>
<li>Calculate and interpret earnings surprises</li>
<li>Implement pre-earnings and post-earnings strategies</li>
<li>Manage risk around earnings announcements</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Required imports</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># Our consistent stock universe</span>
<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Module 6: Earnings-Based Strategies&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stock Universe: </span><span class="si">{</span><span class="n">FAANG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: Earnings Calendar</h1>
<h2>1.1 Why Earnings Matter</h2>
<p>Earnings announcements are among the most significant events for stocks:</p>
<ul>
<li><strong>Volatility Spike:</strong> Price swings of 5-20% are common</li>
<li><strong>Information Release:</strong> New data about company performance</li>
<li><strong>Expectation Reset:</strong> Analyst estimates get updated</li>
<li><strong>Trading Opportunity:</strong> Both before and after announcements</li>
</ul>
<h3>Key Earnings Metrics</h3>
<ul>
<li><strong>EPS (Earnings Per Share):</strong> Net income divided by shares outstanding</li>
<li><strong>Revenue:</strong> Total sales</li>
<li><strong>Guidance:</strong> Forward-looking estimates from management</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">EarningsCalendar</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Access earnings calendar data.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_earnings_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get historical and upcoming earnings dates.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get earnings dates from yfinance</span>
            <span class="n">earnings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">earnings_dates</span>
            <span class="k">if</span> <span class="n">earnings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">earnings</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">earnings</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching earnings dates: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_quarterly_earnings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get quarterly earnings history.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">earnings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">quarterly_earnings</span>
            <span class="k">if</span> <span class="n">earnings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">earnings</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">earnings</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching quarterly earnings: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">next_earnings_date</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the next earnings date.&quot;&quot;&quot;</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_earnings_dates</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dates</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Find future dates</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">future_dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="n">dates</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">future_dates</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">future_dates</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">days_to_earnings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Days until next earnings.&quot;&quot;&quot;</span>
        <span class="n">next_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_earnings_date</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">next_date</span><span class="p">:</span>
            <span class="c1"># Handle timezone-aware datetime</span>
            <span class="k">if</span> <span class="n">next_date</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">next_date</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">next_date</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Test earnings calendar</span>
<span class="n">cal</span> <span class="o">=</span> <span class="n">EarningsCalendar</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AAPL Earnings Dates:&quot;</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">get_earnings_dates</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">dates</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No earnings dates available&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Next earnings: </span><span class="si">{</span><span class="n">cal</span><span class="o">.</span><span class="n">next_earnings_date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Days to earnings: </span><span class="si">{</span><span class="n">cal</span><span class="o">.</span><span class="n">days_to_earnings</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MultiStockEarningsCalendar</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track earnings for multiple stocks.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
    
    <span class="k">def</span> <span class="nf">upcoming_earnings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days_ahead</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get upcoming earnings for all symbols.&quot;&quot;&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="n">cal</span> <span class="o">=</span> <span class="n">EarningsCalendar</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">next_date</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">next_earnings_date</span><span class="p">()</span>
            <span class="n">days</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">days_to_earnings</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">days</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">days</span> <span class="o">&lt;=</span> <span class="n">days_ahead</span><span class="p">:</span>
                <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;earnings_date&#39;</span><span class="p">:</span> <span class="n">next_date</span><span class="p">,</span>
                    <span class="s1">&#39;days_until&#39;</span><span class="p">:</span> <span class="n">days</span>
                <span class="p">})</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;days_until&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">earnings_this_week</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get stocks reporting this week.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upcoming_earnings</span><span class="p">(</span><span class="n">days_ahead</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="c1"># Check FAANG earnings</span>
<span class="n">multi_cal</span> <span class="o">=</span> <span class="n">MultiStockEarningsCalendar</span><span class="p">(</span><span class="n">FAANG</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Upcoming FAANG Earnings (next 60 days):&quot;</span><span class="p">)</span>
<span class="n">upcoming</span> <span class="o">=</span> <span class="n">multi_cal</span><span class="o">.</span><span class="n">upcoming_earnings</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">upcoming</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">upcoming</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No earnings scheduled in this period&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 2: Earnings Surprise Analysis</h1>
<h2>2.1 What is an Earnings Surprise?</h2>
<p><strong>Earnings Surprise</strong> = Actual EPS - Expected EPS</p>
<ul>
<li><strong>Positive Surprise (Beat):</strong> Actual &gt; Expected ‚Üí Usually bullish</li>
<li><strong>Negative Surprise (Miss):</strong> Actual &lt; Expected ‚Üí Usually bearish</li>
<li><strong>In-Line:</strong> Actual ‚âà Expected ‚Üí Mixed reaction</li>
</ul>
<h3>Post-Earnings Announcement Drift (PEAD)</h3>
<p>Research shows stocks tend to continue moving in the direction of the surprise for weeks or months after the announcement.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">EarningsSurprise</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze earnings surprises.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_surprise_history</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get historical earnings surprises.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">earnings_dates</span>
            <span class="k">if</span> <span class="n">dates</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dates</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            
            <span class="c1"># Filter for past earnings with actual data</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="c1"># Check for expected columns</span>
            <span class="k">if</span> <span class="s1">&#39;EPS Estimate&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;Reported EPS&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Reported EPS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;surprise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Reported EPS&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;EPS Estimate&#39;</span><span class="p">]</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;surprise_pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;surprise&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;EPS Estimate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;surprise&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            
            <span class="k">return</span> <span class="n">df</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">surprise_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate surprise statistics.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_surprise_history</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="s1">&#39;beat&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No surprise data available&#39;</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_quarters&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="s1">&#39;beats&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="s1">&#39;misses&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="s1">&#39;beat_rate&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;avg_surprise_pct&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;surprise_pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;largest_beat_pct&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;surprise_pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="s1">&#39;largest_miss_pct&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;surprise_pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="p">}</span>

<span class="c1"># Analyze AAPL earnings surprises</span>
<span class="n">surprise</span> <span class="o">=</span> <span class="n">EarningsSurprise</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AAPL Earnings Surprise History:&quot;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">surprise</span><span class="o">.</span><span class="n">get_surprise_history</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="s1">&#39;surprise_pct&#39;</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">[[</span><span class="s1">&#39;EPS Estimate&#39;</span><span class="p">,</span> <span class="s1">&#39;Reported EPS&#39;</span><span class="p">,</span> <span class="s1">&#39;surprise&#39;</span><span class="p">,</span> <span class="s1">&#39;surprise_pct&#39;</span><span class="p">,</span> <span class="s1">&#39;beat&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Surprise Statistics:&quot;</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">surprise</span><span class="o">.</span><span class="n">surprise_stats</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Limited earnings data available&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">EarningsReaction</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze price reaction to earnings.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_reaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">earnings_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> 
                     <span class="n">days_before</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
                     <span class="n">days_after</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get price data around an earnings date.</span>
<span class="sd">        </span>
<span class="sd">        Returns DataFrame with price and returns around the event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert to date if datetime</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">earnings_date</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">):</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">earnings_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">earnings_date</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="k">else</span> <span class="n">earnings_date</span><span class="o">.</span><span class="n">date</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">earnings_date</span>
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_before</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_after</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
        
        <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># Calculate returns</span>
        <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;daily_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="n">hist</span>
    
    <span class="k">def</span> <span class="nf">earnings_day_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">earnings_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the earnings day price move (%).&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reaction</span><span class="p">(</span><span class="n">earnings_date</span><span class="p">,</span> <span class="n">days_before</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">days_after</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Find the day after earnings (when reaction shows)</span>
        <span class="c1"># Note: Earnings usually announced after hours or before open</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">earnings_date</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">):</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">earnings_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">earnings_date</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="k">else</span> <span class="n">earnings_date</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">earnings_date</span><span class="p">)</span>
        
        <span class="c1"># Look for trading days around the earnings date</span>
        <span class="n">trading_days</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        
        <span class="c1"># Find closest trading day on or after earnings</span>
        <span class="n">post_days</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">trading_days</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">date</span><span class="o">.</span><span class="n">date</span><span class="p">()]</span>
        
        <span class="k">if</span> <span class="n">post_days</span> <span class="ow">and</span> <span class="s1">&#39;daily_return&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">post_days</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;daily_return&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Test earnings reaction</span>
<span class="n">reaction</span> <span class="o">=</span> <span class="n">EarningsReaction</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>

<span class="c1"># Get a recent earnings date</span>
<span class="n">cal</span> <span class="o">=</span> <span class="n">EarningsCalendar</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">get_earnings_dates</span><span class="p">()</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">dates</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="c1"># Get a past earnings date (not future)</span>
    <span class="n">past_dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="n">dates</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">past_dates</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">recent_date</span> <span class="o">=</span> <span class="n">past_dates</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing reaction to </span><span class="si">{</span><span class="n">recent_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> earnings:&quot;</span><span class="p">)</span>
        
        <span class="n">move</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">earnings_day_move</span><span class="p">(</span><span class="n">recent_date</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">move</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Earnings day move: </span><span class="si">{</span><span class="n">move</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="n">price_data</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">get_reaction</span><span class="p">(</span><span class="n">recent_date</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">price_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Price data around earnings:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">price_data</span><span class="p">[[</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;daily_return&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 6.1: Earnings Surprise Scanner (Guided)</h3>
<p>Build a scanner to find stocks with consistent earnings beats.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">scan_earnings_beaters</span><span class="p">(</span><span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">min_beat_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find stocks that consistently beat earnings.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        symbols: List of stock symbols</span>
<span class="sd">        min_beat_rate: Minimum beat rate (0.75 = 75%)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with symbols and their earnings stats</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Loop through symbols</span>
    <span class="c1"># TODO: Calculate beat rate for each</span>
    <span class="c1"># TODO: Filter for those above min_beat_rate</span>
    <span class="c1"># TODO: Return sorted DataFrame</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># beaters = scan_earnings_beaters(FAANG + [&#39;MSFT&#39;, &#39;NVDA&#39;])</span>
<span class="c1"># print(beaters)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">scan_earnings_beaters</span><span class="p">(</span><span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">min_beat_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find stocks that consistently beat earnings.&quot;&quot;&quot;</span>

    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">surprise</span> <span class="o">=</span> <span class="n">EarningsSurprise</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">surprise</span><span class="o">.</span><span class="n">surprise_stats</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
                <span class="n">beat_rate</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;beat_rate&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># Convert to decimal</span>

                <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;beat_rate&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;beat_rate&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;total_quarters&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total_quarters&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;beats&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;beats&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;avg_surprise_pct&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;avg_surprise_pct&#39;</span><span class="p">]</span>
                <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># Filter for minimum beat rate</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;beat_rate&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_beat_rate</span> <span class="o">*</span> <span class="mi">100</span><span class="p">]</span>

    <span class="c1"># Sort by beat rate descending</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;beat_rate&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="n">beaters</span> <span class="o">=</span> <span class="n">scan_earnings_beaters</span><span class="p">(</span><span class="n">FAANG</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;NVDA&#39;</span><span class="p">],</span> <span class="n">min_beat_rate</span><span class="o">=</span><span class="mf">0.50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Consistent Earnings Beaters:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">beaters</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Earnings Trading Strategies</h1>
<h2>3.1 Pre-Earnings Momentum</h2>
<p>Stocks often drift in the direction of expected results before earnings.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PreEarningsStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Pre-earnings momentum strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pre_earnings_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days_before</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate momentum leading into earnings.</span>
<span class="sd">        </span>
<span class="sd">        Returns the return over the days_before period for each earnings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cal</span> <span class="o">=</span> <span class="n">EarningsCalendar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">earnings_dates</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">get_earnings_dates</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">earnings_dates</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>
        
        <span class="c1"># Get historical price data</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;2y&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>
        
        <span class="n">momentum</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">earnings_dates</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Find trading days before earnings</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">date</span>
                <span class="n">pre_data</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">days_before</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">pre_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                    <span class="n">momentum</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">momentum</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">pre_earnings_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_momentum</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate pre-earnings trading signal.</span>
<span class="sd">        </span>
<span class="sd">        Signal Logic:</span>
<span class="sd">        - Buy if stock has positive momentum and history of beats</span>
<span class="sd">        - Sell/Avoid if stock has negative momentum or history of misses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get current momentum</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1mo&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;no data&#39;</span><span class="p">}</span>
        
        <span class="n">recent_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Get beat history</span>
        <span class="n">surprise</span> <span class="o">=</span> <span class="n">EarningsSurprise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">surprise</span><span class="o">.</span><span class="n">surprise_stats</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">beat_rate</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Assume neutral</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beat_rate</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;beat_rate&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
        
        <span class="c1"># Generate signal</span>
        <span class="k">if</span> <span class="n">recent_return</span> <span class="o">&gt;</span> <span class="n">min_momentum</span> <span class="ow">and</span> <span class="n">beat_rate</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Positive momentum (</span><span class="si">{</span><span class="n">recent_return</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%) + high beat rate (</span><span class="si">{</span><span class="n">beat_rate</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">%)&#39;</span>
        <span class="k">elif</span> <span class="n">recent_return</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">min_momentum</span> <span class="ow">or</span> <span class="n">beat_rate</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Weak momentum (</span><span class="si">{</span><span class="n">recent_return</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%) or low beat rate (</span><span class="si">{</span><span class="n">beat_rate</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">%)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Mixed signals&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
            <span class="s1">&#39;momentum_10d&#39;</span><span class="p">:</span> <span class="n">recent_return</span><span class="p">,</span>
            <span class="s1">&#39;beat_rate&#39;</span><span class="p">:</span> <span class="n">beat_rate</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>

<span class="c1"># Test pre-earnings strategy</span>
<span class="n">pre_strat</span> <span class="o">=</span> <span class="n">PreEarningsStrategy</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pre-Earnings Momentum History:&quot;</span><span class="p">)</span>
<span class="n">momentum</span> <span class="o">=</span> <span class="n">pre_strat</span><span class="o">.</span><span class="n">pre_earnings_momentum</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">momentum</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average pre-earnings return: </span><span class="si">{</span><span class="n">momentum</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Positive momentum rate: </span><span class="si">{</span><span class="p">(</span><span class="n">momentum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current Signal:&quot;</span><span class="p">)</span>
<span class="n">signal</span> <span class="o">=</span> <span class="n">pre_strat</span><span class="o">.</span><span class="n">pre_earnings_signal</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">signal</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.2 Post-Earnings Drift Strategy</h2>
<p>Trade in the direction of the earnings surprise after the announcement.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PostEarningsDrift</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Post-Earnings Announcement Drift (PEAD) strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">holding_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate post-earnings drift for historical earnings.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            holding_days: Days to hold after earnings</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with surprise and subsequent return</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">surprise</span> <span class="o">=</span> <span class="n">EarningsSurprise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">surprise_data</span> <span class="o">=</span> <span class="n">surprise</span><span class="o">.</span><span class="n">get_surprise_history</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">surprise_data</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="s1">&#39;beat&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">surprise_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># Get price history</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;3y&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">surprise_data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get post-earnings prices</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">date</span>
                <span class="n">post_data</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">holding_days</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">post_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">holding_days</span><span class="p">:</span>
                    <span class="n">entry_price</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">exit_price</span> <span class="o">=</span> <span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">holding_days</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">drift_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_price</span> <span class="o">/</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                    
                    <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
                        <span class="s1">&#39;beat&#39;</span><span class="p">:</span> <span class="n">surprise_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;beat&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;surprise_pct&#39;</span><span class="p">:</span> <span class="n">surprise_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;surprise_pct&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;surprise_pct&#39;</span> <span class="ow">in</span> <span class="n">surprise_data</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s1">&#39;drift_return&#39;</span><span class="p">:</span> <span class="n">drift_return</span>
                    <span class="p">})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">analyze_drift</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze drift by surprise direction.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_drift</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No drift data available&#39;</span><span class="p">}</span>
        
        <span class="c1"># Split by beat/miss</span>
        <span class="n">beats</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
        <span class="n">misses</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_events&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="s1">&#39;avg_drift_after_beat&#39;</span><span class="p">:</span> <span class="n">beats</span><span class="p">[</span><span class="s1">&#39;drift_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">beats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;avg_drift_after_miss&#39;</span><span class="p">:</span> <span class="n">misses</span><span class="p">[</span><span class="s1">&#39;drift_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">misses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;beat_positive_drift_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">beats</span><span class="p">[</span><span class="s1">&#39;drift_return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">beats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;miss_negative_drift_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">misses</span><span class="p">[</span><span class="s1">&#39;drift_return&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">misses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>

<span class="c1"># Test PEAD</span>
<span class="n">pead</span> <span class="o">=</span> <span class="n">PostEarningsDrift</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Post-Earnings Drift Analysis:&quot;</span><span class="p">)</span>
<span class="n">drift</span> <span class="o">=</span> <span class="n">pead</span><span class="o">.</span><span class="n">calculate_drift</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">drift</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">drift</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Drift Statistics:&quot;</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">pead</span><span class="o">.</span><span class="n">analyze_drift</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 6.2: PEAD Trading System (Open-ended)</h3>
<p>Build a complete post-earnings drift trading system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PEADTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Post-Earnings Announcement Drift Trading System.</span>
<span class="sd">    </span>
<span class="sd">    Strategy:</span>
<span class="sd">    1. After earnings, check if it was a beat or miss</span>
<span class="sd">    2. If beat, go long; if miss, go short (or avoid)</span>
<span class="sd">    3. Hold for specified number of days</span>
<span class="sd">    4. Track performance</span>
<span class="sd">    </span>
<span class="sd">    Implement:</span>
<span class="sd">    - Signal generation after earnings</span>
<span class="sd">    - Position sizing based on surprise magnitude</span>
<span class="sd">    - Performance tracking</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: Check recent earnings for each symbol</span>
        <span class="c1"># TODO: Generate buy/sell signals based on surprise</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">holding_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># TODO: Backtest the strategy</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># system = PEADTradingSystem(FAANG)</span>
<span class="c1"># signals = system.generate_signals()</span>
<span class="c1"># print(signals)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 4: Earnings Risk Management</h1>
<h2>4.1 Volatility Around Earnings</h2>
<p>Earnings create significant volatility risk.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">EarningsVolatility</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze volatility around earnings.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">historical_moves</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get historical earnings day moves.</span>
<span class="sd">        </span>
<span class="sd">        Returns Series of absolute percentage moves.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cal</span> <span class="o">=</span> <span class="n">EarningsCalendar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">get_earnings_dates</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">dates</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>
        
        <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;3y&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>
        
        <span class="n">moves</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Find the trading day after earnings</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">date</span>
                <span class="n">post</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">post</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">move</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">post</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                    <span class="n">moves</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">move</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">moves</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">expected_move</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate expected move for next earnings.&quot;&quot;&quot;</span>
        <span class="n">moves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historical_moves</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">moves</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No data&#39;</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;average_move&#39;</span><span class="p">:</span> <span class="n">moves</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;median_move&#39;</span><span class="p">:</span> <span class="n">moves</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
            <span class="s1">&#39;max_move&#39;</span><span class="p">:</span> <span class="n">moves</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="s1">&#39;min_move&#39;</span><span class="p">:</span> <span class="n">moves</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="s1">&#39;std_dev&#39;</span><span class="p">:</span> <span class="n">moves</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">risk_assessment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assess risk for holding through earnings.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            position_size: Dollar amount of position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_move</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expected</span>
        
        <span class="n">avg_move</span> <span class="o">=</span> <span class="n">expected</span><span class="p">[</span><span class="s1">&#39;average_move&#39;</span><span class="p">]</span>
        <span class="n">max_move</span> <span class="o">=</span> <span class="n">expected</span><span class="p">[</span><span class="s1">&#39;max_move&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;position_size&#39;</span><span class="p">:</span> <span class="n">position_size</span><span class="p">,</span>
            <span class="s1">&#39;expected_move_pct&#39;</span><span class="p">:</span> <span class="n">avg_move</span><span class="p">,</span>
            <span class="s1">&#39;expected_dollar_risk&#39;</span><span class="p">:</span> <span class="n">position_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">avg_move</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span>
            <span class="s1">&#39;max_move_pct&#39;</span><span class="p">:</span> <span class="n">max_move</span><span class="p">,</span>
            <span class="s1">&#39;max_dollar_risk&#39;</span><span class="p">:</span> <span class="n">position_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_move</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;High Risk&#39;</span> <span class="k">if</span> <span class="n">avg_move</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;Moderate Risk&#39;</span> <span class="k">if</span> <span class="n">avg_move</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="s1">&#39;Lower Risk&#39;</span>
        <span class="p">}</span>

<span class="c1"># Analyze earnings volatility</span>
<span class="n">vol</span> <span class="o">=</span> <span class="n">EarningsVolatility</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AAPL Historical Earnings Moves:&quot;</span><span class="p">)</span>
<span class="n">moves</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">historical_moves</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">moves</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average move: </span><span class="si">{</span><span class="n">moves</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max move: </span><span class="si">{</span><span class="n">moves</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Risk Assessment ($10,000 position):&quot;</span><span class="p">)</span>
<span class="n">risk</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">risk_assessment</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">risk</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="s1">&#39;dollar&#39;</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">EarningsPositionSizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Position sizing for earnings trades.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            account_size: Total account value</span>
<span class="sd">            max_risk_pct: Maximum risk per trade (default 2%)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_size</span> <span class="o">=</span> <span class="n">account_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_pct</span> <span class="o">=</span> <span class="n">max_risk_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_dollars</span> <span class="o">=</span> <span class="n">account_size</span> <span class="o">*</span> <span class="n">max_risk_pct</span>
    
    <span class="k">def</span> <span class="nf">calculate_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate appropriate position size for earnings trade.</span>
<span class="sd">        </span>
<span class="sd">        Uses expected move to size position so max loss = max_risk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">EarningsVolatility</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">expected_move</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Cannot calculate - no volatility data&#39;</span><span class="p">}</span>
        
        <span class="c1"># Use 1.5x average move as expected risk</span>
        <span class="n">expected_risk_pct</span> <span class="o">=</span> <span class="n">expected</span><span class="p">[</span><span class="s1">&#39;average_move&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.5</span>
        
        <span class="c1"># Position size = max risk / expected risk</span>
        <span class="n">position_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_dollars</span> <span class="o">/</span> <span class="p">(</span><span class="n">expected_risk_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="c1"># Get current price</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">info</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentPrice&#39;</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;regularMarketPrice&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shares</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">position_size</span> <span class="o">/</span> <span class="n">price</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shares</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;account_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_size</span><span class="p">,</span>
            <span class="s1">&#39;max_risk_dollars&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_dollars</span><span class="p">,</span>
            <span class="s1">&#39;expected_move_pct&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="p">[</span><span class="s1">&#39;average_move&#39;</span><span class="p">],</span>
            <span class="s1">&#39;adjusted_risk_pct&#39;</span><span class="p">:</span> <span class="n">expected_risk_pct</span><span class="p">,</span>
            <span class="s1">&#39;suggested_position&#39;</span><span class="p">:</span> <span class="n">position_size</span><span class="p">,</span>
            <span class="s1">&#39;current_price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;suggested_shares&#39;</span><span class="p">:</span> <span class="n">shares</span><span class="p">,</span>
            <span class="s1">&#39;actual_position&#39;</span><span class="p">:</span> <span class="n">shares</span> <span class="o">*</span> <span class="n">price</span> <span class="k">if</span> <span class="n">shares</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>

<span class="c1"># Test position sizing</span>
<span class="n">sizer</span> <span class="o">=</span> <span class="n">EarningsPositionSizer</span><span class="p">(</span><span class="n">account_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">max_risk_pct</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Position Sizing for Earnings Trade:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">]:</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">sizer</span><span class="o">.</span><span class="n">calculate_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="s1">&#39;dollar&#39;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="s1">&#39;position&#39;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="s1">&#39;price&#39;</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 6.3: Earnings Filter (Guided)</h3>
<p>Build a filter to identify when to avoid trading due to earnings.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">earnings_filter</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">avoid_days_before</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                    <span class="n">avoid_days_after</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a stock should be avoided due to upcoming/recent earnings.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        symbol: Stock symbol</span>
<span class="sd">        avoid_days_before: Days before earnings to avoid</span>
<span class="sd">        avoid_days_after: Days after earnings to avoid</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict with:</span>
<span class="sd">        - avoid: bool - True if should avoid</span>
<span class="sd">        - reason: str - Why to avoid (or &#39;clear&#39;)</span>
<span class="sd">        - days_to_earnings: int or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Get earnings calendar</span>
    <span class="c1"># TODO: Check if within avoid window</span>
    <span class="c1"># TODO: Return appropriate dict</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># for symbol in FAANG:</span>
<span class="c1">#     result = earnings_filter(symbol)</span>
<span class="c1">#     print(f&quot;{symbol}: {result}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">earnings_filter</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">avoid_days_before</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                    <span class="n">avoid_days_after</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check if a stock should be avoided due to upcoming/recent earnings.&quot;&quot;&quot;</span>

    <span class="n">cal</span> <span class="o">=</span> <span class="n">EarningsCalendar</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">get_earnings_dates</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">dates</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;avoid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;No earnings data - proceed with caution&#39;</span><span class="p">,</span>
            <span class="s1">&#39;days_to_earnings&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="c1"># Check for upcoming earnings</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="c1"># Handle timezone</span>
        <span class="k">if</span> <span class="n">date</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">now_tz</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">now_tz</span> <span class="o">=</span> <span class="n">now</span>

        <span class="n">days_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">date</span> <span class="o">-</span> <span class="n">now_tz</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

        <span class="c1"># Check if within avoid window</span>
        <span class="k">if</span> <span class="o">-</span><span class="n">avoid_days_after</span> <span class="o">&lt;=</span> <span class="n">days_diff</span> <span class="o">&lt;=</span> <span class="n">avoid_days_before</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">days_diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Earnings in </span><span class="si">{</span><span class="n">days_diff</span><span class="si">}</span><span class="s1"> days&#39;</span>
            <span class="k">elif</span> <span class="n">days_diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Earnings TODAY&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Earnings </span><span class="si">{</span><span class="o">-</span><span class="n">days_diff</span><span class="si">}</span><span class="s1"> days ago&#39;</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;avoid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
                <span class="s1">&#39;days_to_earnings&#39;</span><span class="p">:</span> <span class="n">days_diff</span><span class="p">,</span>
                <span class="s1">&#39;earnings_date&#39;</span><span class="p">:</span> <span class="n">date</span>
            <span class="p">}</span>

    <span class="c1"># Find next earnings</span>
    <span class="n">future</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">]</span>
    <span class="n">days_to_next</span> <span class="o">=</span> <span class="p">(</span><span class="n">future</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="n">future</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s1">&#39;avoid&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Clear - no nearby earnings&#39;</span><span class="p">,</span>
        <span class="s1">&#39;days_to_earnings&#39;</span><span class="p">:</span> <span class="n">days_to_next</span>
    <span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Earnings Filter Results:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">FAANG</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">earnings_filter</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;‚ö†Ô∏è AVOID&#39;</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;avoid&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;‚úÖ CLEAR&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h1>Module Project: Complete Earnings Trading System</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">EarningsTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete earnings-based trading system.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Earnings calendar tracking</span>
<span class="sd">    - Surprise analysis</span>
<span class="sd">    - Pre/post earnings signals</span>
<span class="sd">    - Risk management</span>
<span class="sd">    - Position sizing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">account_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_size</span> <span class="o">=</span> <span class="n">account_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sizer</span> <span class="o">=</span> <span class="n">EarningsPositionSizer</span><span class="p">(</span><span class="n">account_size</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">scan_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days_ahead</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scan for earnings trading opportunities.&quot;&quot;&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get earnings info</span>
                <span class="n">cal</span> <span class="o">=</span> <span class="n">EarningsCalendar</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">days</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">days_to_earnings</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">days</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">days</span> <span class="o">&gt;</span> <span class="n">days_ahead</span> <span class="ow">or</span> <span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Get surprise stats</span>
                <span class="n">surprise</span> <span class="o">=</span> <span class="n">EarningsSurprise</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="n">surprise</span><span class="o">.</span><span class="n">surprise_stats</span><span class="p">()</span>
                
                <span class="c1"># Get volatility</span>
                <span class="n">vol</span> <span class="o">=</span> <span class="n">EarningsVolatility</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">expected</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">expected_move</span><span class="p">()</span>
                
                <span class="c1"># Pre-earnings signal</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="n">PreEarningsStrategy</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">pre_earnings_signal</span><span class="p">()</span>
                
                <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;days_to_earnings&#39;</span><span class="p">:</span> <span class="n">days</span><span class="p">,</span>
                    <span class="s1">&#39;beat_rate&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beat_rate&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;avg_surprise&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;avg_surprise_pct&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;expected_move&#39;</span><span class="p">:</span> <span class="n">expected</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average_move&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;momentum_10d&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;momentum_10d&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error scanning </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;days_to_earnings&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">generate_trade_ideas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate specific trade ideas.&quot;&quot;&quot;</span>
        <span class="n">opps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_opportunities</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">opps</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="n">ideas</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">opps</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># Only generate ideas for bullish signals with high beat rates</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;beat_rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                <span class="c1"># Get position sizing</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sizer</span><span class="o">.</span><span class="n">calculate_position</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">])</span>
                
                <span class="n">ideas</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;Pre-Earnings Momentum&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;days_to_earnings&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;days_to_earnings&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;beat_rate&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;beat_rate&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;expected_move&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;expected_move&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;suggested_shares&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;suggested_shares&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;position_value&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;actual_position&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Strong momentum + </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;beat_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% beat rate&quot;</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">ideas</span>
    
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate complete earnings report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EARNINGS TRADING SYSTEM REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Universe: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span><span class="si">}</span><span class="s2"> stocks&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Account Size: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">account_size</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Upcoming earnings</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UPCOMING EARNINGS (Next 14 Days):&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        
        <span class="n">opps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_opportunities</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opps</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">opps</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No earnings in the next 14 days&quot;</span><span class="p">)</span>
        
        <span class="c1"># Trade ideas</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TRADE IDEAS:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        
        <span class="n">ideas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_trade_ideas</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ideas</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idea</span> <span class="ow">in</span> <span class="n">ideas</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">idea</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">idea</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Strategy: </span><span class="si">{</span><span class="n">idea</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Days to Earnings: </span><span class="si">{</span><span class="n">idea</span><span class="p">[</span><span class="s1">&#39;days_to_earnings&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Position: </span><span class="si">{</span><span class="n">idea</span><span class="p">[</span><span class="s1">&#39;suggested_shares&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> shares ($</span><span class="si">{</span><span class="n">idea</span><span class="p">[</span><span class="s1">&#39;position_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Notes: </span><span class="si">{</span><span class="n">idea</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No trade ideas at this time&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run the earnings trading system</span>
<span class="n">extended_universe</span> <span class="o">=</span> <span class="n">FAANG</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;NVDA&#39;</span><span class="p">,</span> <span class="s1">&#39;TSLA&#39;</span><span class="p">,</span> <span class="s1">&#39;AMD&#39;</span><span class="p">,</span> <span class="s1">&#39;CRM&#39;</span><span class="p">]</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">EarningsTradingSystem</span><span class="p">(</span><span class="n">extended_universe</span><span class="p">,</span> <span class="n">account_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 6.4: Earnings Watchlist (Open-ended)</h3>
<p>Create your own earnings watchlist system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your earnings watchlist here</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 6.5: Earnings Quality Score (Guided)</h3>
<p>Create a score to rate earnings quality.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">earnings_quality_score</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate an earnings quality score (0-100).</span>
<span class="sd">    </span>
<span class="sd">    Components:</span>
<span class="sd">    - Beat consistency (40 pts): Higher beat rate = more points</span>
<span class="sd">    - Surprise magnitude (30 pts): Larger positive surprises = more points</span>
<span class="sd">    - Reaction predictability (30 pts): Consistent post-earnings moves</span>
<span class="sd">    </span>
<span class="sd">    Returns dict with score and components.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate beat consistency score</span>
    <span class="c1"># TODO: Calculate surprise magnitude score</span>
    <span class="c1"># TODO: Calculate reaction predictability score</span>
    <span class="c1"># TODO: Return total score and breakdown</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># for symbol in FAANG:</span>
<span class="c1">#     score = earnings_quality_score(symbol)</span>
<span class="c1">#     print(f&quot;{symbol}: {score}&quot;)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 6.6: Backtest Earnings Strategy (Open-ended)</h3>
<p>Backtest a complete earnings trading strategy.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your backtest here</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>Earnings Calendar:</strong> Track upcoming announcements to prepare</li>
<li><strong>Earnings Surprise:</strong> Beat rate predicts future performance</li>
<li><strong>Pre-Earnings Momentum:</strong> Stocks drift in expected direction before earnings</li>
<li><strong>PEAD:</strong> Post-earnings drift continues for weeks after announcement</li>
<li><strong>Volatility Risk:</strong> Earnings cause large moves - size positions accordingly</li>
<li><strong>Position Sizing:</strong> Use expected move to determine appropriate size</li>
<li><strong>Filter:</strong> Know when to avoid trading due to earnings risk</li>
</ol>
<hr />
<p><strong>Next Module:</strong> Momentum &amp; Trend Strategies</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="7"><div class="md-cell module-header"><h1>Module 7: Momentum &amp; Trend Strategies</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Part 1 (Modules 1-5), Module 6</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Implement price momentum strategies</li>
<li>Build moving average crossover systems</li>
<li>Create breakout detection systems</li>
<li>Develop mean reversion strategies</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Required imports</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="c1"># Our consistent stock universe</span>
<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="c1"># Get sample data</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;2y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> days of AAPL data&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: Price Momentum</h1>
<h2>1.1 What is Momentum?</h2>
<p><strong>Momentum</strong> is the tendency of stocks that have performed well to continue performing well, and vice versa.</p>
<h3>Types of Momentum</h3>
<ul>
<li><strong>Absolute Momentum:</strong> Stock's own past performance</li>
<li><strong>Relative Momentum:</strong> Performance compared to peers/benchmark</li>
<li><strong>Cross-Sectional:</strong> Ranking stocks against each other</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MomentumCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate various momentum metrics.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">absolute_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Absolute momentum: Return over lookback period.</span>
<span class="sd">        Positive = bullish, Negative = bearish</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">lookback</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">rate_of_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rate of Change (ROC) indicator.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">period</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">momentum_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">21</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">252</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Composite momentum score across multiple timeframes.</span>
<span class="sd">        </span>
<span class="sd">        Higher score = stronger momentum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
            <span class="c1"># Rank transform to 0-1 scale</span>
            <span class="n">scores</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mom_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">pct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">scores</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">trend_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trend strength: Price position relative to SMA.</span>
<span class="sd">        Positive = above SMA, Negative = below.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">/</span> <span class="n">sma</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

<span class="c1"># Calculate momentum</span>
<span class="n">mom</span> <span class="o">=</span> <span class="n">MomentumCalculator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mom_1M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">absolute_momentum</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mom_3M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">absolute_momentum</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mom_6M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">absolute_momentum</span><span class="p">(</span><span class="mi">126</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mom_12M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">absolute_momentum</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mom_Score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">momentum_score</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current Momentum:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  1-Month: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mom_1M&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  3-Month: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mom_3M&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  6-Month: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mom_6M&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  12-Month: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mom_12M&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Composite Score: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mom_Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">/100&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">RelativeMomentum</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate relative momentum across multiple stocks.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1y&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_data</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_fetch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch price data for all symbols.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">return</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">rank_by_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">126</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rank stocks by momentum.</span>
<span class="sd">        </span>
<span class="sd">        Returns DataFrame with returns and ranks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">values</span>
        <span class="p">})</span>
        
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">top_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">126</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get top N momentum stocks.&quot;&quot;&quot;</span>
        <span class="n">ranked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_by_momentum</span><span class="p">(</span><span class="n">lookback</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ranked</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">bottom_momentum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">126</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get bottom N momentum stocks.&quot;&quot;&quot;</span>
        <span class="n">ranked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_by_momentum</span><span class="p">(</span><span class="n">lookback</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ranked</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">n</span><span class="p">)[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Rank FAANG by momentum</span>
<span class="n">rel_mom</span> <span class="o">=</span> <span class="n">RelativeMomentum</span><span class="p">(</span><span class="n">FAANG</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FAANG Momentum Ranking (6-Month):&quot;</span><span class="p">)</span>
<span class="n">ranking</span> <span class="o">=</span> <span class="n">rel_mom</span><span class="o">.</span><span class="n">rank_by_momentum</span><span class="p">(</span><span class="mi">126</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ranking</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top Momentum: </span><span class="si">{</span><span class="n">rel_mom</span><span class="o">.</span><span class="n">top_momentum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bottom Momentum: </span><span class="si">{</span><span class="n">rel_mom</span><span class="o">.</span><span class="n">bottom_momentum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 Momentum Strategy</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MomentumStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple momentum strategy.</span>
<span class="sd">    </span>
<span class="sd">    Rules:</span>
<span class="sd">    - Buy: 12-month return &gt; 0 AND 1-month return &gt; 0</span>
<span class="sd">    - Sell: 12-month return &lt; 0 OR 1-month return &lt; -5%</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mom</span> <span class="o">=</span> <span class="n">MomentumCalculator</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate buy/sell signals.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span>
        
        <span class="c1"># Calculate momentum</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_12m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mom</span><span class="o">.</span><span class="n">absolute_momentum</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_1m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mom</span><span class="o">.</span><span class="n">absolute_momentum</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
        
        <span class="c1"># Generate signals</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Buy signal</span>
        <span class="n">buy_condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_12m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_1m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">buy_condition</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># Sell signal</span>
        <span class="n">sell_condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_12m&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_1m&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sell_condition</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">current_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current trading signal.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">()</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;BUY&#39;</span>
        <span class="k">elif</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;SELL&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;HOLD&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
            <span class="s1">&#39;mom_12m&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;mom_12m&#39;</span><span class="p">],</span>
            <span class="s1">&#39;mom_1m&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;mom_1m&#39;</span><span class="p">]</span>
        <span class="p">}</span>

<span class="c1"># Test momentum strategy</span>
<span class="n">strat</span> <span class="o">=</span> <span class="n">MomentumStrategy</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AAPL Momentum Strategy Signal:&quot;</span><span class="p">)</span>
<span class="n">signal</span> <span class="o">=</span> <span class="n">strat</span><span class="o">.</span><span class="n">current_signal</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">signal</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 7.1: Multi-Timeframe Momentum (Guided)</h3>
<p>Build a momentum strategy that requires alignment across multiple timeframes.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">multi_timeframe_momentum</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate signals requiring momentum alignment.</span>
<span class="sd">    </span>
<span class="sd">    Strong Buy: 1M, 3M, 6M, and 12M momentum all positive</span>
<span class="sd">    Buy: 3 of 4 timeframes positive</span>
<span class="sd">    Neutral: 2 positive, 2 negative</span>
<span class="sd">    Sell: 3 of 4 timeframes negative</span>
<span class="sd">    Strong Sell: All 4 timeframes negative</span>
<span class="sd">    </span>
<span class="sd">    Returns DataFrame with signal column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate momentum for all timeframes</span>
    <span class="c1"># TODO: Count positive/negative timeframes</span>
    <span class="c1"># TODO: Generate signal based on alignment</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># signals = multi_timeframe_momentum(df[&#39;Close&#39;])</span>
<span class="c1"># print(signals.tail())</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">multi_timeframe_momentum</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate signals requiring momentum alignment.&quot;&quot;&quot;</span>

    <span class="n">mom</span> <span class="o">=</span> <span class="n">MomentumCalculator</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

    <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>

    <span class="c1"># Calculate all timeframes</span>
    <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_1m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">absolute_momentum</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
    <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">absolute_momentum</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>
    <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_6m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">absolute_momentum</span><span class="p">(</span><span class="mi">126</span><span class="p">)</span>
    <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_12m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">absolute_momentum</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>

    <span class="c1"># Count positive timeframes</span>
    <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;positive_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_1m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span>
        <span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_3m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span>
        <span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_6m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span>
        <span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mom_12m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Generate signals</span>
    <span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Strong Buy&#39;</span>
        <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Buy&#39;</span>
        <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Neutral&#39;</span>
        <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Sell&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Strong Sell&#39;</span>

    <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;positive_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">classify</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">signals</span>

<span class="n">signals</span> <span class="o">=</span> <span class="n">multi_timeframe_momentum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multi-Timeframe Momentum:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">signals</span><span class="p">[[</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;mom_1m&#39;</span><span class="p">,</span> <span class="s1">&#39;mom_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;mom_6m&#39;</span><span class="p">,</span> <span class="s1">&#39;mom_12m&#39;</span><span class="p">,</span> <span class="s1">&#39;positive_count&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current Signal: </span><span class="si">{</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Moving Average Systems</h1>
<h2>2.1 MA Crossover Strategies</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MACrossoverSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Moving Average Crossover Trading System.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">fast</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">slow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fast</span> <span class="o">=</span> <span class="n">fast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow</span> <span class="o">=</span> <span class="n">slow</span>
    
    <span class="k">def</span> <span class="nf">calculate_mas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate moving averages.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fast</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slow</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate crossover signals.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_mas</span><span class="p">()</span>
        
        <span class="c1"># Position: 1 when fast &gt; slow, -1 when fast &lt; slow</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Signal: Only when position changes</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        
        <span class="c1"># Crossover direction</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;crossover&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;crossover&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;golden&#39;</span>  <span class="c1"># Fast crosses above slow</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;crossover&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;death&#39;</span>  <span class="c1"># Fast crosses below slow</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">current_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current system state.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">()</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Distance between MAs</span>
        <span class="n">ma_spread</span> <span class="o">=</span> <span class="p">(</span><span class="n">latest</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
            <span class="s1">&#39;fast_ma&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;fast_ma&#39;</span><span class="p">],</span>
            <span class="s1">&#39;slow_ma&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;slow_ma&#39;</span><span class="p">],</span>
            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="s1">&#39;Long&#39;</span> <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;Short&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ma_spread_pct&#39;</span><span class="p">:</span> <span class="n">ma_spread</span><span class="p">,</span>
            <span class="s1">&#39;last_crossover&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;crossover&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">find_recent_crossovers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find recent crossover events.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">()</span>
        <span class="n">crossovers</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;crossover&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">crossovers</span><span class="p">[[</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;crossover&#39;</span><span class="p">]]</span>

<span class="c1"># Test MA crossover</span>
<span class="n">ma_system</span> <span class="o">=</span> <span class="n">MACrossoverSystem</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">fast</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">slow</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MA Crossover System (20/50):&quot;</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">ma_system</span><span class="o">.</span><span class="n">current_state</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recent Crossovers:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ma_system</span><span class="o">.</span><span class="n">find_recent_crossovers</span><span class="p">())</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TripleMASystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Triple Moving Average System for trend confirmation.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                 <span class="n">short</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">medium</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">long</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="n">short</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">medium</span> <span class="o">=</span> <span class="n">medium</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long</span> <span class="o">=</span> <span class="n">long</span>
    
    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate all MAs and alignment.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;short_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">medium</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;long_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Check alignment</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bullish_aligned&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;short_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">])</span> <span class="o">&amp;</span> 
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;long_ma&#39;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bearish_aligned&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;short_ma&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">])</span> <span class="o">&amp;</span> 
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;long_ma&#39;</span><span class="p">])</span>
        <span class="p">)</span>
        
        <span class="c1"># Trend state</span>
        <span class="k">def</span> <span class="nf">get_trend</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;bullish_aligned&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;Bullish&#39;</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;bearish_aligned&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="s1">&#39;Bearish&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Mixed&#39;</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_trend</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">current_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current trend state.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Test triple MA</span>
<span class="n">triple</span> <span class="o">=</span> <span class="n">TripleMASystem</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Triple MA Trend: </span><span class="si">{</span><span class="n">triple</span><span class="o">.</span><span class="n">current_trend</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">triple</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MA Values:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Short (10): $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;short_ma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Medium (20): $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;medium_ma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Long (50): $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;long_ma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 7.2: Adaptive MA System (Open-ended)</h3>
<p>Build a system that adapts MA periods based on volatility.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">AdaptiveMASystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adaptive Moving Average System.</span>
<span class="sd">    </span>
<span class="sd">    Idea: Use shorter MAs in high volatility (faster signals)</span>
<span class="sd">          Use longer MAs in low volatility (fewer whipsaws)</span>
<span class="sd">    </span>
<span class="sd">    Implement:</span>
<span class="sd">    - Calculate volatility (ATR or std dev)</span>
<span class="sd">    - Determine volatility regime (high/normal/low)</span>
<span class="sd">    - Adjust MA periods accordingly</span>
<span class="sd">    - Generate signals with adaptive MAs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">get_volatility_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># TODO: Calculate and classify volatility</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_adaptive_periods</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="c1"># TODO: Return (fast, slow) periods based on regime</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: Generate signals with adaptive MAs</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># adaptive = AdaptiveMASystem(df)</span>
<span class="c1"># print(adaptive.get_volatility_regime())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 3: Breakout Strategies</h1>
<h2>3.1 Price Breakouts</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">BreakoutDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect price breakouts.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> 
                 <span class="n">volume</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">low</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span>
    
    <span class="k">def</span> <span class="nf">donchian_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate Donchian Channel.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span>
        <span class="k">return</span> <span class="n">df</span>
    
    <span class="k">def</span> <span class="nf">detect_breakouts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect breakouts above/below Donchian Channel.&quot;&quot;&quot;</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        
        <span class="c1"># Shift to use previous day&#39;s channel</span>
        <span class="n">prev_upper</span> <span class="o">=</span> <span class="n">channel</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prev_lower</span> <span class="o">=</span> <span class="n">channel</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Detect breakouts</span>
        <span class="n">channel</span><span class="p">[</span><span class="s1">&#39;breakout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">&gt;</span> <span class="n">prev_upper</span><span class="p">,</span> <span class="s1">&#39;breakout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">&lt;</span> <span class="n">prev_lower</span><span class="p">,</span> <span class="s1">&#39;breakout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
        
        <span class="k">return</span> <span class="n">channel</span>
    
    <span class="k">def</span> <span class="nf">volume_confirmed_breakout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> 
                                   <span class="n">vol_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect breakouts with volume confirmation.&quot;&quot;&quot;</span>
        <span class="n">breakouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_breakouts</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        
        <span class="c1"># Calculate relative volume</span>
        <span class="n">avg_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rel_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">/</span> <span class="n">avg_vol</span>
        
        <span class="n">breakouts</span><span class="p">[</span><span class="s1">&#39;relative_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_vol</span>
        <span class="n">breakouts</span><span class="p">[</span><span class="s1">&#39;volume_confirmed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_vol</span> <span class="o">&gt;</span> <span class="n">vol_threshold</span>
        
        <span class="c1"># Confirmed breakouts</span>
        <span class="n">breakouts</span><span class="p">[</span><span class="s1">&#39;confirmed_breakout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">breakouts</span><span class="p">[</span><span class="s1">&#39;breakout&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">breakouts</span><span class="p">[</span><span class="s1">&#39;volume_confirmed&#39;</span><span class="p">]</span>
        <span class="n">breakouts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;confirmed_breakout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">breakouts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;breakout&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">breakouts</span>
    
    <span class="k">def</span> <span class="nf">fifty_two_week_high</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Detect 52-week high breakouts.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;52w_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;new_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;52w_high&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pct_from_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;52w_high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">df</span>

<span class="c1"># Test breakout detector</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">BreakoutDetector</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Donchian Channel (20-day):&quot;</span><span class="p">)</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">donchian_channel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Upper: $</span><span class="si">{</span><span class="n">channel</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Lower: $</span><span class="si">{</span><span class="n">channel</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Close: $</span><span class="si">{</span><span class="n">channel</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">52-Week High Status:&quot;</span><span class="p">)</span>
<span class="n">high_52</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">fifty_two_week_high</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  52W High: $</span><span class="si">{</span><span class="n">high_52</span><span class="p">[</span><span class="s1">&#39;52w_high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  At New High: </span><span class="si">{</span><span class="n">high_52</span><span class="p">[</span><span class="s1">&#39;new_high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  % From High: </span><span class="si">{</span><span class="n">high_52</span><span class="p">[</span><span class="s1">&#39;pct_from_high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">BreakoutStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete breakout trading strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">BreakoutDetector</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> 
                         <span class="n">vol_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate breakout signals.</span>
<span class="sd">        </span>
<span class="sd">        Buy: Bullish breakout with volume confirmation</span>
<span class="sd">        Sell: Bearish breakout or close below middle of channel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">breakouts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">volume_confirmed_breakout</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="n">vol_threshold</span><span class="p">)</span>
        
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">breakouts</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">breakouts</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">breakouts</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;breakout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">breakouts</span><span class="p">[</span><span class="s1">&#39;confirmed_breakout&#39;</span><span class="p">]</span>
        
        <span class="c1"># Trading signal</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;breakout&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;breakout&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;middle&#39;</span><span class="p">],</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">current_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current trading signal.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">()</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Determine position relative to channel</span>
        <span class="n">close</span> <span class="o">=</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">close</span> <span class="o">&gt;=</span> <span class="n">upper</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="s1">&#39;At Resistance&#39;</span>
        <span class="k">elif</span> <span class="n">close</span> <span class="o">&lt;=</span> <span class="n">lower</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="s1">&#39;At Support&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pct_in_channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span> <span class="o">-</span> <span class="n">lower</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">upper</span> <span class="o">-</span> <span class="n">lower</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">position</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pct_in_channel</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">% in Channel&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">close</span><span class="p">,</span>
            <span class="s1">&#39;upper&#39;</span><span class="p">:</span> <span class="n">upper</span><span class="p">,</span>
            <span class="s1">&#39;lower&#39;</span><span class="p">:</span> <span class="n">lower</span><span class="p">,</span>
            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="n">position</span><span class="p">,</span>
            <span class="s1">&#39;breakout&#39;</span><span class="p">:</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;breakout&#39;</span><span class="p">],</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Buy&#39;</span> <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;Sell&#39;</span> <span class="k">if</span> <span class="n">latest</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;Hold&#39;</span>
        <span class="p">}</span>

<span class="c1"># Test breakout strategy</span>
<span class="n">strat</span> <span class="o">=</span> <span class="n">BreakoutStrategy</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Breakout Strategy Signal:&quot;</span><span class="p">)</span>
<span class="n">signal</span> <span class="o">=</span> <span class="n">strat</span><span class="o">.</span><span class="n">current_signal</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">signal</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 7.3: Consolidation Breakout (Guided)</h3>
<p>Detect stocks breaking out of consolidation patterns.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">detect_consolidation_breakout</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                                  <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                                  <span class="n">max_range_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect if stock is breaking out of consolidation.</span>
<span class="sd">    </span>
<span class="sd">    Consolidation: Price range &lt; max_range_pct over lookback period</span>
<span class="sd">    Breakout: Today&#39;s close &gt; consolidation high</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with OHLCV data</span>
<span class="sd">        lookback: Days to check for consolidation</span>
<span class="sd">        max_range_pct: Maximum % range for consolidation</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict with consolidation status and breakout signal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate range over lookback period</span>
    <span class="c1"># TODO: Check if range &lt; max_range_pct (consolidation)</span>
    <span class="c1"># TODO: Check if current close &gt; consolidation high (breakout)</span>
    <span class="c1"># TODO: Return status</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># result = detect_consolidation_breakout(df)</span>
<span class="c1"># print(result)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">detect_consolidation_breakout</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                                  <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                                  <span class="n">max_range_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect if stock is breaking out of consolidation.&quot;&quot;&quot;</span>

    <span class="c1"># Get lookback period data (excluding today)</span>
    <span class="n">lookback_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">lookback</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Calculate consolidation range</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">lookback_data</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">lookback_data</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">range_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="n">low</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="c1"># Check if in consolidation</span>
    <span class="n">in_consolidation</span> <span class="o">=</span> <span class="n">range_pct</span> <span class="o">&lt;</span> <span class="n">max_range_pct</span>

    <span class="c1"># Check for breakout</span>
    <span class="n">breakout_up</span> <span class="o">=</span> <span class="n">today</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">high</span>
    <span class="n">breakout_down</span> <span class="o">=</span> <span class="n">today</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">low</span>

    <span class="k">if</span> <span class="n">in_consolidation</span> <span class="ow">and</span> <span class="n">breakout_up</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Bullish Breakout&#39;</span>
    <span class="k">elif</span> <span class="n">in_consolidation</span> <span class="ow">and</span> <span class="n">breakout_down</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Bearish Breakout&#39;</span>
    <span class="k">elif</span> <span class="n">in_consolidation</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Consolidating&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Trending&#39;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
        <span class="s1">&#39;range_pct&#39;</span><span class="p">:</span> <span class="n">range_pct</span><span class="p">,</span>
        <span class="s1">&#39;consolidation_high&#39;</span><span class="p">:</span> <span class="n">high</span><span class="p">,</span>
        <span class="s1">&#39;consolidation_low&#39;</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span>
        <span class="s1">&#39;current_close&#39;</span><span class="p">:</span> <span class="n">today</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span>
        <span class="s1">&#39;in_consolidation&#39;</span><span class="p">:</span> <span class="n">in_consolidation</span><span class="p">,</span>
        <span class="s1">&#39;breakout_up&#39;</span><span class="p">:</span> <span class="n">breakout_up</span><span class="p">,</span>
        <span class="s1">&#39;breakout_down&#39;</span><span class="p">:</span> <span class="n">breakout_down</span>
    <span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">detect_consolidation_breakout</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Consolidation Breakout Analysis:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Mean Reversion</h1>
<h2>4.1 Mean Reversion Concept</h2>
<p>Mean reversion assumes prices tend to return to their average. Trade against extremes.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MeanReversionStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Mean reversion trading strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">z_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate z-score: how many std devs from mean.&quot;&quot;&quot;</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span>
    
    <span class="k">def</span> <span class="nf">rsi_mean_reversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> 
                           <span class="n">oversold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> 
                           <span class="n">overbought</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">70</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;RSI-based mean reversion signals.&quot;&quot;&quot;</span>
        <span class="c1"># Calculate RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
        
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsi</span>
        
        <span class="c1"># Signals</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rsi</span> <span class="o">&lt;</span> <span class="n">oversold</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Buy oversold</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rsi</span> <span class="o">&gt;</span> <span class="n">overbought</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Sell overbought</span>
        
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">bollinger_mean_reversion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> 
                                  <span class="n">std_dev</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Bollinger Bands mean reversion.&quot;&quot;&quot;</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">-</span> <span class="p">(</span><span class="n">std</span> <span class="o">*</span> <span class="n">std_dev</span><span class="p">)</span>
        
        <span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span>
        
        <span class="c1"># Signals</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Buy below lower band</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Sell above upper band</span>
        
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">combined_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Combined mean reversion signal.&quot;&quot;&quot;</span>
        <span class="n">rsi_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsi_mean_reversion</span><span class="p">()</span>
        <span class="n">bb_signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bollinger_mean_reversion</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_score</span><span class="p">()</span>
        
        <span class="c1"># Get latest values</span>
        <span class="n">rsi_signal</span> <span class="o">=</span> <span class="n">rsi_signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">bb_signal</span> <span class="o">=</span> <span class="n">bb_signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">z_score</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Combined signal requires agreement</span>
        <span class="k">if</span> <span class="n">rsi_signal</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bb_signal</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;Strong Buy (Oversold)&#39;</span>
        <span class="k">elif</span> <span class="n">rsi_signal</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">bb_signal</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;Strong Sell (Overbought)&#39;</span>
        <span class="k">elif</span> <span class="n">rsi_signal</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">bb_signal</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;Weak Buy&#39;</span>
        <span class="k">elif</span> <span class="n">rsi_signal</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">bb_signal</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;Weak Sell&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;Neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">rsi_signals</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;z_score&#39;</span><span class="p">:</span> <span class="n">z_score</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;bb_upper&#39;</span><span class="p">:</span> <span class="n">bb_signals</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;bb_lower&#39;</span><span class="p">:</span> <span class="n">bb_signals</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>

<span class="c1"># Test mean reversion</span>
<span class="n">mr</span> <span class="o">=</span> <span class="n">MeanReversionStrategy</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean Reversion Analysis:&quot;</span><span class="p">)</span>
<span class="n">signal</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">combined_signal</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">signal</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 7.4: Mean Reversion Scanner (Open-ended)</h3>
<p>Build a scanner to find oversold/overbought stocks.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your mean reversion scanner here</span>
</code></pre></div>
<div class="md-cell module-project"><hr />
<h1>Module Project: Complete Trading Strategy System</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TradingStrategySystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete trading strategy system combining multiple approaches.</span>
<span class="sd">    </span>
<span class="sd">    Strategies:</span>
<span class="sd">    - Momentum</span>
<span class="sd">    - MA Crossover</span>
<span class="sd">    - Breakout</span>
<span class="sd">    - Mean Reversion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
    
    <span class="k">def</span> <span class="nf">analyze_stock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run all strategies on a single stock.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No data&#39;</span><span class="p">}</span>
            
            <span class="c1"># Momentum</span>
            <span class="n">mom</span> <span class="o">=</span> <span class="n">MomentumStrategy</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>
            <span class="n">mom_signal</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">current_signal</span><span class="p">()</span>
            
            <span class="c1"># MA Crossover</span>
            <span class="n">ma</span> <span class="o">=</span> <span class="n">MACrossoverSystem</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>
            <span class="n">ma_state</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">current_state</span><span class="p">()</span>
            
            <span class="c1"># Breakout</span>
            <span class="n">breakout</span> <span class="o">=</span> <span class="n">BreakoutStrategy</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">breakout_signal</span> <span class="o">=</span> <span class="n">breakout</span><span class="o">.</span><span class="n">current_signal</span><span class="p">()</span>
            
            <span class="c1"># Mean Reversion</span>
            <span class="n">mr</span> <span class="o">=</span> <span class="n">MeanReversionStrategy</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>
            <span class="n">mr_signal</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">combined_signal</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="n">mom_signal</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">],</span>
                <span class="s1">&#39;ma_position&#39;</span><span class="p">:</span> <span class="n">ma_state</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span>
                <span class="s1">&#39;breakout&#39;</span><span class="p">:</span> <span class="n">breakout_signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span>
                <span class="s1">&#39;mean_reversion&#39;</span><span class="p">:</span> <span class="n">mr_signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span>
                <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">mr_signal</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">],</span>
                <span class="s1">&#39;mom_12m&#39;</span><span class="p">:</span> <span class="n">mom_signal</span><span class="p">[</span><span class="s1">&#39;mom_12m&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
    
    <span class="k">def</span> <span class="nf">scan_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scan all symbols.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_stock</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">consensus_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find stocks where multiple strategies agree.&quot;&quot;&quot;</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_all</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        
        <span class="c1"># Count bullish signals</span>
        <span class="k">def</span> <span class="nf">count_bullish</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ma_position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Long&#39;</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;breakout&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Buy&#39;</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s1">&#39;Buy&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mean_reversion&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)):</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">count</span>
        
        <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;bullish_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">count_bullish</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;bullish_count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">scan</span>
    
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate strategy report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TRADING STRATEGY SYSTEM REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        
        <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">consensus_signals</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Universe: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">)</span><span class="si">}</span><span class="s2"> stocks&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;Symbol&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Price&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Mom&#39;</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;MA&#39;</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Break&#39;</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;MeanRev&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Score&#39;</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ma_position&#39;</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;breakout&#39;</span><span class="p">])[:</span><span class="mi">5</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;mean_reversion&#39;</span><span class="p">])[:</span><span class="mi">11</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;bullish_count&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Top picks</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="s1">&#39;bullish_count&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TOP PICKS (3+ bullish signals):&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;bullish_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> bullish signals&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run the trading strategy system</span>
<span class="n">extended</span> <span class="o">=</span> <span class="n">FAANG</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;NVDA&#39;</span><span class="p">,</span> <span class="s1">&#39;TSLA&#39;</span><span class="p">,</span> <span class="s1">&#39;AMD&#39;</span><span class="p">]</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">TradingStrategySystem</span><span class="p">(</span><span class="n">extended</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 7.5: Strategy Backtester (Guided)</h3>
<p>Build a simple backtester for any strategy.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">backtest_strategy</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">signals</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple strategy backtester.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        prices: Price series</span>
<span class="sd">        signals: Signal series (1=long, -1=short, 0=flat)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict with:</span>
<span class="sd">        - total_return</span>
<span class="sd">        - sharpe_ratio</span>
<span class="sd">        - max_drawdown</span>
<span class="sd">        - win_rate</span>
<span class="sd">        - num_trades</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate daily returns</span>
    <span class="c1"># TODO: Calculate strategy returns (signals * daily returns)</span>
    <span class="c1"># TODO: Calculate cumulative returns</span>
    <span class="c1"># TODO: Calculate max drawdown</span>
    <span class="c1"># TODO: Calculate Sharpe ratio</span>
    <span class="c1"># TODO: Count trades and win rate</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># mom_strat = MomentumStrategy(df[&#39;Close&#39;])</span>
<span class="c1"># signals = mom_strat.generate_signals()</span>
<span class="c1"># results = backtest_strategy(df[&#39;Close&#39;], signals[&#39;signal&#39;])</span>
<span class="c1"># print(results)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 7.6: Custom Strategy (Open-ended)</h3>
<p>Design and implement your own trading strategy.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your custom strategy here</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>Momentum:</strong> Winning stocks tend to keep winning</li>
<li><strong>Multiple Timeframes:</strong> Stronger signals when timeframes align</li>
<li><strong>MA Crossovers:</strong> Classic trend-following approach</li>
<li><strong>Breakouts:</strong> Trade new highs with volume confirmation</li>
<li><strong>Mean Reversion:</strong> Trade against extremes</li>
<li><strong>Consensus:</strong> Best signals when multiple strategies agree</li>
<li><strong>Backtest:</strong> Always validate strategies with historical data</li>
</ol>
<hr />
<p><strong>Next Module:</strong> Sector &amp; ETF Strategies</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="8"><div class="md-cell module-header"><h1>Module 8: Sector &amp; ETF Strategies</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Part 1, Modules 6-7</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Analyze sector performance and rotation</li>
<li>Build sector rotation strategies</li>
<li>Trade ETFs effectively</li>
<li>Detect and adapt to market regimes</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Required imports</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="c1"># Sector ETFs (SPDR Select Sector)</span>
<span class="n">SECTOR_ETFS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;XLK&#39;</span><span class="p">:</span> <span class="s1">&#39;Technology&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLF&#39;</span><span class="p">:</span> <span class="s1">&#39;Financials&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLV&#39;</span><span class="p">:</span> <span class="s1">&#39;Healthcare&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLE&#39;</span><span class="p">:</span> <span class="s1">&#39;Energy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLY&#39;</span><span class="p">:</span> <span class="s1">&#39;Consumer Discretionary&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLP&#39;</span><span class="p">:</span> <span class="s1">&#39;Consumer Staples&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLI&#39;</span><span class="p">:</span> <span class="s1">&#39;Industrials&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLB&#39;</span><span class="p">:</span> <span class="s1">&#39;Materials&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLU&#39;</span><span class="p">:</span> <span class="s1">&#39;Utilities&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLRE&#39;</span><span class="p">:</span> <span class="s1">&#39;Real Estate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;XLC&#39;</span><span class="p">:</span> <span class="s1">&#39;Communication Services&#39;</span>
<span class="p">}</span>

<span class="c1"># Market ETFs</span>
<span class="n">MARKET_ETFS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;SPY&#39;</span><span class="p">:</span> <span class="s1">&#39;S&amp;P 500&#39;</span><span class="p">,</span>
    <span class="s1">&#39;QQQ&#39;</span><span class="p">:</span> <span class="s1">&#39;NASDAQ 100&#39;</span><span class="p">,</span>
    <span class="s1">&#39;IWM&#39;</span><span class="p">:</span> <span class="s1">&#39;Russell 2000&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DIA&#39;</span><span class="p">:</span> <span class="s1">&#39;Dow Jones&#39;</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tracking </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">SECTOR_ETFS</span><span class="p">)</span><span class="si">}</span><span class="s2"> sectors and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">MARKET_ETFS</span><span class="p">)</span><span class="si">}</span><span class="s2"> market indices&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: Sector Analysis</h1>
<h2>1.1 The 11 GICS Sectors</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Sector</th>
<th>ETF</th>
<th>Characteristics</th>
</tr>
</thead>
<tbody>
<tr>
<td>Technology</td>
<td>XLK</td>
<td>Growth, high beta</td>
</tr>
<tr>
<td>Healthcare</td>
<td>XLV</td>
<td>Defensive, steady</td>
</tr>
<tr>
<td>Financials</td>
<td>XLF</td>
<td>Rate sensitive</td>
</tr>
<tr>
<td>Consumer Disc.</td>
<td>XLY</td>
<td>Cyclical</td>
</tr>
<tr>
<td>Consumer Staples</td>
<td>XLP</td>
<td>Defensive</td>
</tr>
<tr>
<td>Energy</td>
<td>XLE</td>
<td>Commodity linked</td>
</tr>
<tr>
<td>Industrials</td>
<td>XLI</td>
<td>Economic sensitive</td>
</tr>
<tr>
<td>Materials</td>
<td>XLB</td>
<td>Commodity linked</td>
</tr>
<tr>
<td>Utilities</td>
<td>XLU</td>
<td>Defensive, yield</td>
</tr>
<tr>
<td>Real Estate</td>
<td>XLRE</td>
<td>Rate sensitive</td>
</tr>
<tr>
<td>Communication</td>
<td>XLC</td>
<td>Mixed growth/value</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SectorAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze sector performance.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1y&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sector_etfs</span> <span class="o">=</span> <span class="n">SECTOR_ETFS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_data</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_fetch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch price data for all sector ETFs.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector_etfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">return</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">calculate_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">252</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate returns for multiple periods.&quot;&quot;&quot;</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sector_etfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sector_etfs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        
        <span class="n">period_names</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;1W&#39;</span><span class="p">,</span> <span class="mi">21</span><span class="p">:</span> <span class="s1">&#39;1M&#39;</span><span class="p">,</span> <span class="mi">63</span><span class="p">:</span> <span class="s1">&#39;3M&#39;</span><span class="p">,</span> <span class="mi">126</span><span class="p">:</span> <span class="s1">&#39;6M&#39;</span><span class="p">,</span> <span class="mi">252</span><span class="p">:</span> <span class="s1">&#39;1Y&#39;</span><span class="p">}</span>
        
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">period_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">D&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">period</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">period</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">returns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
        
        <span class="k">return</span> <span class="n">returns</span>
    
    <span class="k">def</span> <span class="nf">rank_sectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">63</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rank sectors by performance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">lookback</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="n">returns</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="s1">&#39;sector&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sector_etfs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">],</span>
            <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">values</span>
        <span class="p">})</span>
        
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">relative_strength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">benchmark</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SPY&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate relative strength vs benchmark.&quot;&quot;&quot;</span>
        <span class="c1"># Get benchmark data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bench</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">benchmark</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">)[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># Align data</span>
        <span class="n">common_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">bench</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">sector_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
        <span class="n">bench_data</span> <span class="o">=</span> <span class="n">bench</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_idx</span><span class="p">]</span>
        
        <span class="c1"># Calculate relative strength</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">sector_data</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">bench_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Get current RS and trend</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sector_etfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sector_etfs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        
        <span class="c1"># RS change over last month</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">21</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;rs_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">rs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">rs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">21</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;rs_trend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;rs_change&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;Improving&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;Weakening&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;Stable&#39;</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>

<span class="c1"># Analyze sectors</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">SectorAnalyzer</span><span class="p">(</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sector Performance:&quot;</span><span class="p">)</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">calculate_returns</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sector Ranking (3-Month):&quot;</span><span class="p">)</span>
<span class="n">ranking</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">rank_sectors</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ranking</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Visualize sector performance</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">calculate_returns</span><span class="p">()</span>

<span class="k">if</span> <span class="s1">&#39;3M&#39;</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;green&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;3M&#39;</span><span class="p">]]</span>
    <span class="n">bars</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">returns</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">],</span> <span class="n">returns</span><span class="p">[</span><span class="s1">&#39;3M&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;3-Month Return (%)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sector Performance (3-Month)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 8.1: Sector Relative Strength Scanner (Guided)</h3>
<p>Build a scanner to find sectors with improving relative strength.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">scan_sector_strength</span><span class="p">(</span><span class="n">min_rs_change</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scan for sectors with improving relative strength.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        min_rs_change: Minimum RS change (%) to flag as improving</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with sectors showing strength</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Create SectorAnalyzer</span>
    <span class="c1"># TODO: Get relative strength data</span>
    <span class="c1"># TODO: Filter for improving sectors</span>
    <span class="c1"># TODO: Add ranking information</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># strong_sectors = scan_sector_strength(0.5)</span>
<span class="c1"># print(strong_sectors)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">scan_sector_strength</span><span class="p">(</span><span class="n">min_rs_change</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Scan for sectors with improving relative strength.&quot;&quot;&quot;</span>

    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">SectorAnalyzer</span><span class="p">(</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>

    <span class="c1"># Get relative strength</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">relative_strength</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Get performance ranking</span>
    <span class="n">ranking</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">rank_sectors</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>

    <span class="c1"># Merge data</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ranking</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">]],</span> 
                      <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">)</span>

    <span class="c1"># Filter for improving</span>
    <span class="k">if</span> <span class="s1">&#39;rs_change&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">improving</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;rs_change&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_rs_change</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">improving</span> <span class="o">=</span> <span class="n">improving</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rs_change&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">improving</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sectors with Improving Relative Strength:&quot;</span><span class="p">)</span>
<span class="n">strong</span> <span class="o">=</span> <span class="n">scan_sector_strength</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">strong</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">strong</span><span class="p">[[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;rs_change&#39;</span><span class="p">,</span> <span class="s1">&#39;rs_trend&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No sectors meeting criteria&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Sector Rotation</h1>
<h2>2.1 Sector Rotation Strategy</h2>
<p>Rotate into the strongest sectors and out of the weakest.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SectorRotationStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Sector rotation trading strategy.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">63</span><span class="p">,</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            lookback: Days for momentum calculation</span>
<span class="sd">            top_n: Number of top sectors to hold</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_n</span> <span class="o">=</span> <span class="n">top_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">SectorAnalyzer</span><span class="p">(</span><span class="s1">&#39;2y&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_current_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current recommended allocation.&quot;&quot;&quot;</span>
        <span class="n">ranking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">rank_sectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ranking</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># Top N get allocation</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">ranking</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_n</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">top</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_n</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Equal weight</span>
        <span class="n">top</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;HOLD/BUY&#39;</span>
        
        <span class="c1"># Others get 0</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="n">ranking</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranking</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_n</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bottom</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bottom</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;AVOID&#39;</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate rotation signals.</span>
<span class="sd">        </span>
<span class="sd">        Compares current allocation to previous month.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">rank_sectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">rank_sectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">+</span> <span class="mi">21</span><span class="p">)</span>  <span class="c1"># 1 month ago</span>
        
        <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">previous</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># Merge rankings</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">previous</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">]],</span> 
            <span class="n">on</span><span class="o">=</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> 
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_prev&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Calculate rank change</span>
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;rank_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;rank_prev&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
        
        <span class="c1"># Generate signals</span>
        <span class="k">def</span> <span class="nf">get_signal</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_n</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rank_change&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;NEW BUY&#39;</span>  <span class="c1"># Entered top N</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_n</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;HOLD&#39;</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rank_prev&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_n</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_n</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;SELL&#39;</span>  <span class="c1"># Dropped out of top N</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;AVOID&#39;</span>
        
        <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_signal</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">signals</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">momentum_weighted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Momentum-weighted allocation (stronger momentum = higher weight).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ranking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">rank_sectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ranking</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># Only positive momentum sectors</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="n">ranking</span><span class="p">[</span><span class="n">ranking</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">positive</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ranking</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># At least hold something</span>
        
        <span class="c1"># Weight by momentum (normalized)</span>
        <span class="n">total_return</span> <span class="o">=</span> <span class="n">positive</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">positive</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">positive</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_return</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">positive</span>

<span class="c1"># Test sector rotation</span>
<span class="n">rotation</span> <span class="o">=</span> <span class="n">SectorRotationStrategy</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="mi">63</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current Sector Allocation:&quot;</span><span class="p">)</span>
<span class="n">allocation</span> <span class="o">=</span> <span class="n">rotation</span><span class="o">.</span><span class="n">get_current_allocation</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">allocation</span><span class="p">[[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Rotation Signals:&quot;</span><span class="p">)</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">rotation</span><span class="o">.</span><span class="n">generate_signals</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">signals</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">signals</span><span class="p">[[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="s1">&#39;rank_change&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">DualMomentumRotation</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dual momentum sector rotation.</span>
<span class="sd">    </span>
<span class="sd">    1. Absolute momentum: Only invest if sector &gt; 0 return</span>
<span class="sd">    2. Relative momentum: Pick top N vs peers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">126</span><span class="p">,</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_n</span> <span class="o">=</span> <span class="n">top_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">SectorAnalyzer</span><span class="p">(</span><span class="s1">&#39;2y&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get dual momentum allocation.&quot;&quot;&quot;</span>
        <span class="n">ranking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">rank_sectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ranking</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="c1"># Filter: Absolute momentum (positive returns only)</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="n">ranking</span><span class="p">[</span><span class="n">ranking</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">positive</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># All negative - go to cash/bonds</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;sector&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;CASH&#39;</span><span class="p">],</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;SHY&#39;</span><span class="p">],</span>
                <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">],</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;All sectors negative - defensive&#39;</span><span class="p">]</span>
            <span class="p">})</span>
        
        <span class="c1"># Relative momentum: Top N of positive</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">positive</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_n</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">top</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">top</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Positive momentum + top ranked&#39;</span>
        
        <span class="k">return</span> <span class="n">top</span>
    
    <span class="k">def</span> <span class="nf">risk_adjusted_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Allocate based on risk-adjusted returns.&quot;&quot;&quot;</span>
        <span class="c1"># Get returns and volatility</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">data</span>
        
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        
        <span class="n">returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="s1">&#39;sector&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">SECTOR_ETFS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">],</span>
            <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">returns</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">volatility</span><span class="o">.</span><span class="n">values</span>
        <span class="p">})</span>
        
        <span class="c1"># Sharpe-like ratio (return / volatility)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span>
        
        <span class="c1"># Filter and rank by Sharpe</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">positive</span> <span class="o">=</span> <span class="n">positive</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;sharpe&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">top</span> <span class="o">=</span> <span class="n">positive</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_n</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">top</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">))</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="n">top</span>

<span class="c1"># Test dual momentum</span>
<span class="n">dual</span> <span class="o">=</span> <span class="n">DualMomentumRotation</span><span class="p">(</span><span class="n">lookback</span><span class="o">=</span><span class="mi">126</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dual Momentum Allocation:&quot;</span><span class="p">)</span>
<span class="n">alloc</span> <span class="o">=</span> <span class="n">dual</span><span class="o">.</span><span class="n">get_allocation</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">alloc</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Risk-Adjusted Allocation:&quot;</span><span class="p">)</span>
<span class="n">risk_adj</span> <span class="o">=</span> <span class="n">dual</span><span class="o">.</span><span class="n">risk_adjusted_allocation</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">risk_adj</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">risk_adj</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 8.2: Sector Rotation Backtest (Open-ended)</h3>
<p>Backtest the sector rotation strategy.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SectorRotationBacktest</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Backtest sector rotation strategy.</span>
<span class="sd">    </span>
<span class="sd">    Implement:</span>
<span class="sd">    - Monthly rebalancing</span>
<span class="sd">    - Hold top N sectors</span>
<span class="sd">    - Compare to SPY buy-and-hold</span>
<span class="sd">    - Calculate returns, Sharpe, drawdown</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">63</span><span class="p">,</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_n</span> <span class="o">=</span> <span class="n">top_n</span>
    
    <span class="k">def</span> <span class="nf">run_backtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># TODO: Implement backtest</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">plot_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Plot equity curves</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># bt = SectorRotationBacktest()</span>
<span class="c1"># results = bt.run_backtest()</span>
<span class="c1"># print(results)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 3: ETF Trading</h1>
<h2>3.1 ETF Analysis</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ETFAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze ETFs for trading.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">basic_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get basic ETF information.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;longName&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">),</span>
            <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">),</span>
            <span class="s1">&#39;expense_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;annualReportExpenseRatio&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">),</span>
            <span class="s1">&#39;avg_volume&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;averageVolume&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;total_assets&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;totalAssets&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;yield&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;yield&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">performance_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate performance metrics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">close</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="c1"># Returns</span>
        <span class="n">ret_1m</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">21</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">21</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">ret_3m</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">63</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">63</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">ret_ytd</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Volatility</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Sharpe (assuming 5% risk-free rate)</span>
        <span class="n">ann_return</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">ann_return</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="n">vol</span> <span class="k">if</span> <span class="n">vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># Max drawdown</span>
        <span class="n">cummax</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span> <span class="o">-</span> <span class="n">cummax</span><span class="p">)</span> <span class="o">/</span> <span class="n">cummax</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">max_dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;return_1m&#39;</span><span class="p">:</span> <span class="n">ret_1m</span><span class="p">,</span>
            <span class="s1">&#39;return_3m&#39;</span><span class="p">:</span> <span class="n">ret_3m</span><span class="p">,</span>
            <span class="s1">&#39;return_ytd&#39;</span><span class="p">:</span> <span class="n">ret_ytd</span><span class="p">,</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">vol</span><span class="p">,</span>
            <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">sharpe</span><span class="p">,</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">max_dd</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">technical_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Basic technical analysis.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="n">close</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        
        <span class="c1"># Moving averages</span>
        <span class="n">sma_20</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sma_50</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sma_200</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="n">current</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Trend assessment</span>
        <span class="n">above_20</span> <span class="o">=</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">sma_20</span>
        <span class="n">above_50</span> <span class="o">=</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">sma_50</span>
        <span class="n">above_200</span> <span class="o">=</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">sma_200</span> <span class="k">if</span> <span class="n">sma_200</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="c1"># RSI</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">)))</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span>
            <span class="s1">&#39;sma_20&#39;</span><span class="p">:</span> <span class="n">sma_20</span><span class="p">,</span>
            <span class="s1">&#39;sma_50&#39;</span><span class="p">:</span> <span class="n">sma_50</span><span class="p">,</span>
            <span class="s1">&#39;sma_200&#39;</span><span class="p">:</span> <span class="n">sma_200</span><span class="p">,</span>
            <span class="s1">&#39;above_20sma&#39;</span><span class="p">:</span> <span class="n">above_20</span><span class="p">,</span>
            <span class="s1">&#39;above_50sma&#39;</span><span class="p">:</span> <span class="n">above_50</span><span class="p">,</span>
            <span class="s1">&#39;above_200sma&#39;</span><span class="p">:</span> <span class="n">above_200</span><span class="p">,</span>
            <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">rsi</span><span class="p">,</span>
            <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="s1">&#39;Bullish&#39;</span> <span class="k">if</span> <span class="n">above_20</span> <span class="ow">and</span> <span class="n">above_50</span> <span class="k">else</span> <span class="s1">&#39;Bearish&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">above_20</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">above_50</span> <span class="k">else</span> <span class="s1">&#39;Mixed&#39;</span>
        <span class="p">}</span>

<span class="c1"># Analyze SPY</span>
<span class="n">spy</span> <span class="o">=</span> <span class="n">ETFAnalyzer</span><span class="p">(</span><span class="s1">&#39;SPY&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SPY Basic Info:&quot;</span><span class="p">)</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">spy</span><span class="o">.</span><span class="n">basic_info</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Performance Metrics:&quot;</span><span class="p">)</span>
<span class="n">perf</span> <span class="o">=</span> <span class="n">spy</span><span class="o">.</span><span class="n">performance_metrics</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">perf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Technical Analysis:&quot;</span><span class="p">)</span>
<span class="n">tech</span> <span class="o">=</span> <span class="n">spy</span><span class="o">.</span><span class="n">technical_analysis</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tech</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ETFComparison</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Compare multiple ETFs.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzers</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">ETFAnalyzer</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">compare_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compare performance across ETFs.&quot;&quot;&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">analyzer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">perf</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">performance_metrics</span><span class="p">()</span>
            <span class="n">tech</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">technical_analysis</span><span class="p">()</span>
            
            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">tech</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;return_1m&#39;</span><span class="p">:</span> <span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_1m&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;return_3m&#39;</span><span class="p">:</span> <span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;return_3m&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;volatility&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sharpe&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;max_dd&#39;</span><span class="p">:</span> <span class="n">perf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;rsi&#39;</span><span class="p">:</span> <span class="n">tech</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">tech</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trend&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">rank_by_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rank ETFs by a specific metric.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_performance</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Compare market ETFs</span>
<span class="n">comparison</span> <span class="o">=</span> <span class="n">ETFComparison</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">MARKET_ETFS</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market ETF Comparison:&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">comparison</span><span class="o">.</span><span class="n">compare_performance</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ranked by Sharpe Ratio:&quot;</span><span class="p">)</span>
<span class="n">ranked</span> <span class="o">=</span> <span class="n">comparison</span><span class="o">.</span><span class="n">rank_by_metric</span><span class="p">(</span><span class="s1">&#39;sharpe&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ranked</span><span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;sharpe&#39;</span><span class="p">,</span> <span class="s1">&#39;return_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;volatility&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 8.3: ETF Momentum Strategy (Guided)</h3>
<p>Build a momentum strategy that rotates between market ETFs.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">etf_momentum_strategy</span><span class="p">(</span><span class="n">etfs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">63</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ETF momentum rotation strategy.</span>
<span class="sd">    </span>
<span class="sd">    Rules:</span>
<span class="sd">    - Calculate momentum for each ETF</span>
<span class="sd">    - If best ETF has positive momentum, invest in it</span>
<span class="sd">    - If all ETFs have negative momentum, go to cash (SHY)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        etfs: List of ETF symbols to consider</span>
<span class="sd">        lookback: Days for momentum calculation</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict with recommended ETF and allocation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Fetch data for all ETFs</span>
    <span class="c1"># TODO: Calculate momentum (return over lookback)</span>
    <span class="c1"># TODO: Find best performing ETF</span>
    <span class="c1"># TODO: Apply absolute momentum filter</span>
    <span class="c1"># TODO: Return recommendation</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># result = etf_momentum_strategy([&#39;SPY&#39;, &#39;QQQ&#39;, &#39;IWM&#39;, &#39;EFA&#39;])</span>
<span class="c1"># print(result)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">etf_momentum_strategy</span><span class="p">(</span><span class="n">etfs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">63</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;ETF momentum rotation strategy.&quot;&quot;&quot;</span>

    <span class="c1"># Fetch data and calculate momentum</span>
    <span class="n">momentum</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">etfs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lookback</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">lookback</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">momentum</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">momentum</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No data available&#39;</span><span class="p">}</span>

    <span class="c1"># Rank by momentum</span>
    <span class="n">ranked</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">momentum</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">best_etf</span><span class="p">,</span> <span class="n">best_momentum</span> <span class="o">=</span> <span class="n">ranked</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Apply absolute momentum filter</span>
    <span class="k">if</span> <span class="n">best_momentum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="n">best_etf</span><span class="p">,</span>
            <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="n">best_momentum</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;allocation&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Best momentum (</span><span class="si">{</span><span class="n">best_momentum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%) is positive&#39;</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;SHY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;DEFENSIVE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;allocation&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;All ETFs negative - best was </span><span class="si">{</span><span class="n">best_etf</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">best_momentum</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%)&#39;</span>
        <span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">etf_momentum_strategy</span><span class="p">([</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="s1">&#39;IWM&#39;</span><span class="p">,</span> <span class="s1">&#39;EFA&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ETF Momentum Strategy:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Market Regime Detection</h1>
<h2>4.1 Identifying Market Regimes</h2></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MarketRegimeDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect current market regime.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">benchmark</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SPY&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="n">benchmark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">benchmark</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;2y&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">trend_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine trend regime based on moving averages.</span>
<span class="sd">        </span>
<span class="sd">        Bull: Price &gt; 200 SMA, 50 SMA &gt; 200 SMA</span>
<span class="sd">        Bear: Price &lt; 200 SMA, 50 SMA &lt; 200 SMA</span>
<span class="sd">        Transition: Mixed signals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;regime&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">}</span>
        
        <span class="n">close</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">sma_50</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">sma_200</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="n">current</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ma50</span> <span class="o">=</span> <span class="n">sma_50</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ma200</span> <span class="o">=</span> <span class="n">sma_200</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">price_above_200</span> <span class="o">=</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">ma200</span>
        <span class="n">ma50_above_200</span> <span class="o">=</span> <span class="n">ma50</span> <span class="o">&gt;</span> <span class="n">ma200</span>
        
        <span class="k">if</span> <span class="n">price_above_200</span> <span class="ow">and</span> <span class="n">ma50_above_200</span><span class="p">:</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="s1">&#39;Bull Market&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">price_above_200</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ma50_above_200</span><span class="p">:</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="s1">&#39;Bear Market&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="s1">&#39;Transition&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;regime&#39;</span><span class="p">:</span> <span class="n">regime</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">current</span><span class="p">,</span>
            <span class="s1">&#39;sma_50&#39;</span><span class="p">:</span> <span class="n">ma50</span><span class="p">,</span>
            <span class="s1">&#39;sma_200&#39;</span><span class="p">:</span> <span class="n">ma200</span><span class="p">,</span>
            <span class="s1">&#39;price_above_200&#39;</span><span class="p">:</span> <span class="n">price_above_200</span><span class="p">,</span>
            <span class="s1">&#39;ma50_above_200&#39;</span><span class="p">:</span> <span class="n">ma50_above_200</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">volatility_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine volatility regime.</span>
<span class="sd">        </span>
<span class="sd">        Low Vol: Current vol &lt; 75% of long-term average</span>
<span class="sd">        High Vol: Current vol &gt; 125% of long-term average</span>
<span class="sd">        Normal: In between</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;regime&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">}</span>
        
        <span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        
        <span class="c1"># Short-term vol (20-day)</span>
        <span class="n">short_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">:]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Long-term vol (252-day)</span>
        <span class="n">long_vol</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="n">vol_ratio</span> <span class="o">=</span> <span class="n">short_vol</span> <span class="o">/</span> <span class="n">long_vol</span>
        
        <span class="k">if</span> <span class="n">vol_ratio</span> <span class="o">&lt;</span> <span class="mf">0.75</span><span class="p">:</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="s1">&#39;Low Volatility&#39;</span>
        <span class="k">elif</span> <span class="n">vol_ratio</span> <span class="o">&gt;</span> <span class="mf">1.25</span><span class="p">:</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="s1">&#39;High Volatility&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="s1">&#39;Normal Volatility&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;regime&#39;</span><span class="p">:</span> <span class="n">regime</span><span class="p">,</span>
            <span class="s1">&#39;current_vol&#39;</span><span class="p">:</span> <span class="n">short_vol</span><span class="p">,</span>
            <span class="s1">&#39;historical_vol&#39;</span><span class="p">:</span> <span class="n">long_vol</span><span class="p">,</span>
            <span class="s1">&#39;vol_ratio&#39;</span><span class="p">:</span> <span class="n">vol_ratio</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">breadth_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assess market breadth using sector performance.</span>
<span class="sd">        </span>
<span class="sd">        Strong: Most sectors positive</span>
<span class="sd">        Weak: Most sectors negative</span>
<span class="sd">        Mixed: Split</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">analyzer</span> <span class="o">=</span> <span class="n">SectorAnalyzer</span><span class="p">(</span><span class="s1">&#39;3mo&#39;</span><span class="p">)</span>
        <span class="n">ranking</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">rank_sectors</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ranking</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;regime&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">}</span>
        
        <span class="n">positive_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">ranking</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranking</span><span class="p">)</span>
        <span class="n">positive_pct</span> <span class="o">=</span> <span class="n">positive_count</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="k">if</span> <span class="n">positive_pct</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">:</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="s1">&#39;Strong Breadth&#39;</span>
        <span class="k">elif</span> <span class="n">positive_pct</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="s1">&#39;Weak Breadth&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="s1">&#39;Mixed Breadth&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;regime&#39;</span><span class="p">:</span> <span class="n">regime</span><span class="p">,</span>
            <span class="s1">&#39;positive_sectors&#39;</span><span class="p">:</span> <span class="n">positive_count</span><span class="p">,</span>
            <span class="s1">&#39;total_sectors&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
            <span class="s1">&#39;positive_pct&#39;</span><span class="p">:</span> <span class="n">positive_pct</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">combined_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get combined market regime assessment.&quot;&quot;&quot;</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend_regime</span><span class="p">()</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volatility_regime</span><span class="p">()</span>
        <span class="n">breadth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">breadth_regime</span><span class="p">()</span>
        
        <span class="c1"># Overall assessment</span>
        <span class="n">bullish_signals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bearish_signals</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Bull Market&#39;</span><span class="p">:</span>
            <span class="n">bullish_signals</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Bear Market&#39;</span><span class="p">:</span>
            <span class="n">bearish_signals</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">breadth</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Strong Breadth&#39;</span><span class="p">:</span>
            <span class="n">bullish_signals</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">breadth</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Weak Breadth&#39;</span><span class="p">:</span>
            <span class="n">bearish_signals</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">vol</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Low Volatility&#39;</span><span class="p">:</span>
            <span class="n">bullish_signals</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Low vol often bullish</span>
        <span class="k">elif</span> <span class="n">vol</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;High Volatility&#39;</span><span class="p">:</span>
            <span class="n">bearish_signals</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">bullish_signals</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;Risk-On&#39;</span>
        <span class="k">elif</span> <span class="n">bearish_signals</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;Risk-Off&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;Neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="n">overall</span><span class="p">,</span>
            <span class="s1">&#39;trend&#39;</span><span class="p">:</span> <span class="n">trend</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">],</span>
            <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">vol</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">],</span>
            <span class="s1">&#39;breadth&#39;</span><span class="p">:</span> <span class="n">breadth</span><span class="p">[</span><span class="s1">&#39;regime&#39;</span><span class="p">],</span>
            <span class="s1">&#39;bullish_signals&#39;</span><span class="p">:</span> <span class="n">bullish_signals</span><span class="p">,</span>
            <span class="s1">&#39;bearish_signals&#39;</span><span class="p">:</span> <span class="n">bearish_signals</span>
        <span class="p">}</span>

<span class="c1"># Detect market regime</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">MarketRegimeDetector</span><span class="p">(</span><span class="s1">&#39;SPY&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market Regime Analysis:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trend:&quot;</span><span class="p">)</span>
<span class="n">trend</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">trend_regime</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">trend</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Volatility:&quot;</span><span class="p">)</span>
<span class="n">vol</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">volatility_regime</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vol</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Combined Assessment:&quot;</span><span class="p">)</span>
<span class="n">combined</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">combined_regime</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">combined</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 8.4: Regime-Based Allocation (Open-ended)</h3>
<p>Build a system that adjusts allocation based on market regime.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your regime-based allocation system here</span>
</code></pre></div>
<div class="md-cell module-project"><hr />
<h1>Module Project: Complete Sector/ETF Trading System</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SectorETFTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete sector and ETF trading system.</span>
<span class="sd">    </span>
<span class="sd">    Combines:</span>
<span class="sd">    - Sector analysis and rotation</span>
<span class="sd">    - ETF comparison</span>
<span class="sd">    - Market regime detection</span>
<span class="sd">    - Allocation recommendations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regime_detector</span> <span class="o">=</span> <span class="n">MarketRegimeDetector</span><span class="p">(</span><span class="s1">&#39;SPY&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sector_analyzer</span> <span class="o">=</span> <span class="n">SectorAnalyzer</span><span class="p">(</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation_strategy</span> <span class="o">=</span> <span class="n">DualMomentumRotation</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current market regime.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime_detector</span><span class="o">.</span><span class="n">combined_regime</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_sector_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get recommended sector allocation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_strategy</span><span class="o">.</span><span class="n">get_allocation</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">adjust_for_regime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allocation</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjust allocation based on regime.</span>
<span class="sd">        </span>
<span class="sd">        Risk-Off: Reduce equity, add defensive</span>
<span class="sd">        Risk-On: Full allocation to momentum sectors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_regime</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">allocation</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">allocation</span>
        
        <span class="n">adjusted</span> <span class="o">=</span> <span class="n">allocation</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">regime</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Risk-Off&#39;</span><span class="p">:</span>
            <span class="c1"># Reduce allocation, add cash</span>
            <span class="n">adjusted</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjusted</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="c1"># Add cash component</span>
            <span class="n">cash</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;SHY&#39;</span><span class="p">],</span>
                <span class="s1">&#39;sector&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Cash/Bonds&#39;</span><span class="p">],</span>
                <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">],</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Risk-off regime adjustment&#39;</span><span class="p">]</span>
            <span class="p">})</span>
            <span class="n">adjusted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">adjusted</span><span class="p">,</span> <span class="n">cash</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">adjusted</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate complete system report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SECTOR &amp; ETF TRADING SYSTEM REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        
        <span class="c1"># Market Regime</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MARKET REGIME&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_regime</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overall: </span><span class="si">{</span><span class="n">regime</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Trend: </span><span class="si">{</span><span class="n">regime</span><span class="p">[</span><span class="s1">&#39;trend&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">regime</span><span class="p">[</span><span class="s1">&#39;volatility&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Breadth: </span><span class="si">{</span><span class="n">regime</span><span class="p">[</span><span class="s1">&#39;breadth&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Sector Performance</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SECTOR PERFORMANCE (3-Month)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">ranking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector_analyzer</span><span class="o">.</span><span class="n">rank_sectors</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ranking</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ranking</span><span class="p">[[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        
        <span class="c1"># Recommended Allocation</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RECOMMENDED ALLOCATION&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">allocation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sector_allocation</span><span class="p">()</span>
        <span class="n">adjusted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_for_regime</span><span class="p">(</span><span class="n">allocation</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">adjusted</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">adjusted</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        
        <span class="c1"># Action Items</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ACTION ITEMS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">regime</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Risk-On&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚úì Full allocation to momentum sectors&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚úì Focus on top-performing sectors&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">regime</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Risk-Off&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚ö† Reduce equity exposure&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚ö† Consider defensive positions&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚ö† Hold cash/bonds&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚Ä¢ Mixed signals - maintain balanced allocation&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;‚Ä¢ Monitor for regime change&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run the complete system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">SectorETFTradingSystem</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 8.5: Custom Sector Screen (Guided)</h3>
<p>Build a screen to find the best stocks within top sectors.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">screen_stocks_in_top_sectors</span><span class="p">(</span><span class="n">top_n_sectors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Screen for best stocks within top-performing sectors.</span>
<span class="sd">    </span>
<span class="sd">    Steps:</span>
<span class="sd">    1. Identify top N sectors by momentum</span>
<span class="sd">    2. For each top sector, find representative stocks</span>
<span class="sd">    3. Rank stocks within each sector</span>
<span class="sd">    4. Return top picks from each sector</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with top stock picks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Get top sectors</span>
    <span class="c1"># TODO: Get stocks from each sector (you can use predefined lists)</span>
    <span class="c1"># TODO: Analyze and rank stocks</span>
    <span class="c1"># TODO: Return top picks</span>
    <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># picks = screen_stocks_in_top_sectors()</span>
<span class="c1"># print(picks)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 8.6: Sector Momentum Dashboard (Open-ended)</h3>
<p>Build a comprehensive sector momentum dashboard.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Your sector momentum dashboard here</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>11 GICS Sectors:</strong> Know the characteristics of each sector</li>
<li><strong>Sector Rotation:</strong> Rotate into strong sectors, avoid weak ones</li>
<li><strong>Dual Momentum:</strong> Combine absolute and relative momentum</li>
<li><strong>ETF Analysis:</strong> Use ETFs for efficient sector exposure</li>
<li><strong>Market Regime:</strong> Adjust strategy based on regime</li>
<li><strong>Risk-Off:</strong> Reduce exposure in bear markets</li>
<li><strong>Breadth:</strong> Strong breadth confirms bull markets</li>
</ol>
<hr />
<p><strong>Next:</strong> Module 9 - Backtesting &amp; Risk Management</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="9"><div class="md-cell module-header"><h1>Module 9: Backtesting &amp; Risk Management</h1>
<h2>Part 2: Strategy Development</h2>
<hr />
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Prerequisites</strong></td>
<td>Part 1 (Modules 1-5), Modules 6-8</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<hr />
<h2>Learning Objectives</h2>
<p>By the end of this module, you will be able to:</p>
<ol>
<li>Build a backtesting framework that avoids common biases</li>
<li>Calculate key performance metrics (Sharpe, Sortino, max drawdown)</li>
<li>Implement position sizing methods (fixed, percent risk, volatility-adjusted)</li>
<li>Manage portfolio-level risk with correlation and sector constraints</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Required imports</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="c1"># Our consistent stock universe</span>
<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="c1"># Fetch sample data for backtesting (2 years for meaningful tests)</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;2y&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> days of AAPL data&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: Backtesting Properly</h1>
<h2>1.1 Why Backtesting Matters</h2>
<p><strong>Backtesting</strong> is simulating a trading strategy on historical data to evaluate how it would have performed. Done correctly, it gives you confidence before risking real money.</p>
<h3>Common Backtesting Pitfalls</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Bias</th>
<th>Description</th>
<th>Prevention</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Lookahead Bias</strong></td>
<td>Using future data in decisions</td>
<td>Only use data available at signal time</td>
</tr>
<tr>
<td><strong>Survivorship Bias</strong></td>
<td>Only testing on stocks that still exist</td>
<td>Use point-in-time constituents</td>
</tr>
<tr>
<td><strong>Overfitting</strong></td>
<td>Curve-fitting to historical data</td>
<td>Out-of-sample testing, fewer parameters</td>
</tr>
<tr>
<td><strong>Ignoring Costs</strong></td>
<td>Not accounting for commissions/slippage</td>
<td>Model realistic transaction costs</td>
</tr>
<tr>
<td><strong>Selection Bias</strong></td>
<td>Cherry-picking good backtest results</td>
<td>Test on multiple periods and assets</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TradeRecord</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Record of a single trade.&quot;&quot;&quot;</span>
    <span class="n">entry_date</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span>
    <span class="n">exit_date</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;long&#39; or &#39;short&#39;</span>
    <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">shares</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">slippage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gross_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Profit/loss before costs.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_price</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">net_pnl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Profit/loss after costs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gross_pnl</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">return_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return as percentage.&quot;&quot;&quot;</span>
        <span class="n">cost_basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_price</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shares</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_pnl</span> <span class="o">/</span> <span class="n">cost_basis</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">cost_basis</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">holding_days</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Number of days held.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>


<span class="c1"># Example trade</span>
<span class="n">trade</span> <span class="o">=</span> <span class="n">TradeRecord</span><span class="p">(</span>
    <span class="n">entry_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2024-01-15&#39;</span><span class="p">),</span>
    <span class="n">exit_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2024-02-10&#39;</span><span class="p">),</span>
    <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span>
    <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;long&#39;</span><span class="p">,</span>
    <span class="n">entry_price</span><span class="o">=</span><span class="mf">185.0</span><span class="p">,</span>
    <span class="n">exit_price</span><span class="o">=</span><span class="mf">192.5</span><span class="p">,</span>
    <span class="n">shares</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">commission</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">slippage</span><span class="o">=</span><span class="mf">5.0</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trade: </span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Entry: $</span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">entry_price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">entry_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Exit:  $</span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">exit_price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">exit_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Gross P&amp;L: $</span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">gross_pnl</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Net P&amp;L: $</span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">net_pnl</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Return: </span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">return_pct</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Holding: </span><span class="si">{</span><span class="n">trade</span><span class="o">.</span><span class="n">holding_days</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.2 Transaction Cost Modeling</h2>
<p>Realistic backtests must account for:</p>
<ul>
<li><strong>Commissions:</strong> Per-trade fees (most brokers now $0 for stocks)</li>
<li><strong>Slippage:</strong> Difference between expected and actual fill price</li>
<li><strong>Spread costs:</strong> Bid-ask spread, especially for less liquid stocks</li>
<li><strong>Market impact:</strong> Your order moving the price (for large orders)</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CostModel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Model transaction costs for backtesting.&quot;&quot;&quot;</span>
    <span class="n">commission_per_trade</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Most brokers now $0</span>
    <span class="n">slippage_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># 0.05% slippage per trade</span>
    <span class="n">spread_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># 0.02% half-spread</span>
    
    <span class="k">def</span> <span class="nf">total_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">shares</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate total cost for a trade.&quot;&quot;&quot;</span>
        <span class="n">notional</span> <span class="o">=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">shares</span>
        <span class="n">slippage</span> <span class="o">=</span> <span class="n">notional</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slippage_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">notional</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spread_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission_per_trade</span> <span class="o">+</span> <span class="n">slippage</span> <span class="o">+</span> <span class="n">spread</span>
    
    <span class="k">def</span> <span class="nf">cost_per_share</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cost per share in dollars.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">price</span> <span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">slippage_pct</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spread_pct</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">round_trip_cost_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Round-trip cost as percentage (entry + exit).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slippage_pct</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spread_pct</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">break_even_move</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Minimum price move needed to break even.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">round_trip_cost_pct</span><span class="p">()</span>


<span class="c1"># Example cost scenarios</span>
<span class="n">cheap</span> <span class="o">=</span> <span class="n">CostModel</span><span class="p">(</span><span class="n">commission_per_trade</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">slippage_pct</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">spread_pct</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">moderate</span> <span class="o">=</span> <span class="n">CostModel</span><span class="p">(</span><span class="n">commission_per_trade</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">slippage_pct</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">spread_pct</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
<span class="n">expensive</span> <span class="o">=</span> <span class="n">CostModel</span><span class="p">(</span><span class="n">commission_per_trade</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">slippage_pct</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">spread_pct</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

<span class="n">price</span> <span class="o">=</span> <span class="mf">190.0</span>
<span class="n">shares</span> <span class="o">=</span> <span class="mi">100</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cost Comparison (100 shares @ $190):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Scenario&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Per Trade&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Round-Trip %&#39;</span><span class="si">:</span><span class="s2">&gt;14</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Break-Even&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;Cheap&#39;</span><span class="p">,</span> <span class="n">cheap</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Moderate&#39;</span><span class="p">,</span> <span class="n">moderate</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Expensive&#39;</span><span class="p">,</span> <span class="n">expensive</span><span class="p">)]:</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">total_cost</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">shares</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">cost</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">round_trip_cost_pct</span><span class="p">()</span><span class="si">:</span><span class="s2">&gt;13.3f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">break_even_move</span><span class="p">()</span><span class="si">:</span><span class="s2">&gt;11.3f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>1.3 Building a Vectorized Backtester</h2>
<p>A <strong>vectorized backtester</strong> uses pandas operations to simulate strategies efficiently. This is faster than looping through each bar but has limitations (no intra-bar logic).</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">VectorizedBacktester</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized backtesting engine.</span>
<span class="sd">    </span>
<span class="sd">    Takes a price series and signal series, calculates returns</span>
<span class="sd">    with realistic transaction costs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">signals</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                 <span class="n">cost_model</span><span class="p">:</span> <span class="n">CostModel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span> <span class="o">=</span> <span class="n">signals</span>  <span class="c1"># 1 = long, -1 = short, 0 = flat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_model</span> <span class="o">=</span> <span class="n">cost_model</span> <span class="ow">or</span> <span class="n">CostModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run the backtest.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals</span>
        
        <span class="c1"># Daily returns</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;daily_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
        
        <span class="c1"># Strategy returns (signal * next day return)</span>
        <span class="c1"># Shift signal by 1: trade on next open after signal</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;strategy_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;daily_return&#39;</span><span class="p">]</span>
        
        <span class="c1"># Transaction costs (apply when position changes)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;position_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="n">cost_per_trade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_model</span><span class="o">.</span><span class="n">round_trip_cost_pct</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Half per side</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;position_change&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cost_per_trade</span>
        
        <span class="c1"># Net strategy return</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;net_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;strategy_return&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span>
        
        <span class="c1"># Cumulative returns</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;daily_return&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;net_return&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        
        <span class="c1"># Equity curve</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">*</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">def</span> <span class="nf">plot_equity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot equity curve vs buy-and-hold.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_market&#39;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Equity Curve&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Value ($)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Example: Simple SMA crossover backtest</span>
<span class="n">sma_20</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sma_50</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sma_20</span> <span class="o">&gt;</span> <span class="n">sma_50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="n">bt</span> <span class="o">=</span> <span class="n">VectorizedBacktester</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">signals</span><span class="p">,</span> <span class="n">cost_model</span><span class="o">=</span><span class="n">moderate</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SMA 20/50 Crossover Backtest:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Final Equity: $</span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Strategy Return: </span><span class="si">{</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_strategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Buy &amp; Hold Return: </span><span class="si">{</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Trades: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;position_change&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Costs: $</span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100_000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">bt</span><span class="o">.</span><span class="n">plot_equity</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 9.1: Add Slippage Modeling (Guided)</h3>
<p>Enhance the backtester with volume-dependent slippage.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">VolumeDependentCostModel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cost model where slippage depends on trade size vs average volume.</span>
<span class="sd">    </span>
<span class="sd">    Idea: If your trade is 1% of daily volume, slippage is low.</span>
<span class="sd">          If your trade is 10% of daily volume, slippage is much higher.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_slippage_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
                 <span class="n">volume_impact_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_slippage_pct</span> <span class="o">=</span> <span class="n">base_slippage_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume_impact_factor</span> <span class="o">=</span> <span class="n">volume_impact_factor</span>
    
    <span class="k">def</span> <span class="nf">estimate_slippage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_shares</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">avg_volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                          <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate slippage for a given trade.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            trade_shares: Number of shares to trade</span>
<span class="sd">            avg_volume: Average daily volume</span>
<span class="sd">            price: Current price</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Estimated slippage in dollars</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Calculate participation rate (trade_shares / avg_volume)</span>
        <span class="n">participation</span> <span class="o">=</span> <span class="n">trade_shares</span> <span class="o">/</span> <span class="n">______</span><span class="p">()</span>
        
        <span class="c1"># TODO: Scale slippage by participation rate</span>
        <span class="n">slippage_pct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_slippage_pct</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_impact_factor</span> <span class="o">*</span> <span class="n">______</span><span class="p">)</span>
        
        <span class="c1"># TODO: Convert to dollar amount</span>
        <span class="n">slippage_dollars</span> <span class="o">=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">trade_shares</span> <span class="o">*</span> <span class="p">(</span><span class="n">slippage_pct</span> <span class="o">/</span> <span class="n">______</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">slippage_dollars</span>


<span class="c1"># Test</span>
<span class="c1"># cost = VolumeDependentCostModel()</span>
<span class="c1"># slippage = cost.estimate_slippage(trade_shares=500, avg_volume=50_000_000, price=190.0)</span>
<span class="c1"># print(f&quot;Slippage for 500 shares: ${slippage:.4f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VolumeDependentCostModel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cost model where slippage depends on trade size vs average volume.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_slippage_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
                 <span class="n">volume_impact_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_slippage_pct</span> <span class="o">=</span> <span class="n">base_slippage_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume_impact_factor</span> <span class="o">=</span> <span class="n">volume_impact_factor</span>

    <span class="k">def</span> <span class="nf">estimate_slippage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_shares</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">avg_volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                          <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">participation</span> <span class="o">=</span> <span class="n">trade_shares</span> <span class="o">/</span> <span class="n">avg_volume</span>
        <span class="n">slippage_pct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_slippage_pct</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_impact_factor</span> <span class="o">*</span> <span class="n">participation</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">slippage_dollars</span> <span class="o">=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">trade_shares</span> <span class="o">*</span> <span class="p">(</span><span class="n">slippage_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slippage_dollars</span>

<span class="n">cost</span> <span class="o">=</span> <span class="n">VolumeDependentCostModel</span><span class="p">()</span>

<span class="c1"># Small trade (low impact)</span>
<span class="n">small</span> <span class="o">=</span> <span class="n">cost</span><span class="o">.</span><span class="n">estimate_slippage</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">50_000_000</span><span class="p">,</span> <span class="mf">190.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Small trade (500 shares): $</span><span class="si">{</span><span class="n">small</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Large trade (higher impact)</span>
<span class="n">large</span> <span class="o">=</span> <span class="n">cost</span><span class="o">.</span><span class="n">estimate_slippage</span><span class="p">(</span><span class="mi">500_000</span><span class="p">,</span> <span class="mi">50_000_000</span><span class="p">,</span> <span class="mf">190.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Large trade (500K shares): $</span><span class="si">{</span><span class="n">large</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Performance Metrics</h1>
<h2>2.1 Risk-Adjusted Returns</h2>
<p>Raw returns don't tell the full story. We need <strong>risk-adjusted</strong> metrics:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Metric</th>
<th>Formula</th>
<th>What It Measures</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Sharpe Ratio</strong></td>
<td>(Return - Rf) / Volatility</td>
<td>Return per unit of total risk</td>
</tr>
<tr>
<td><strong>Sortino Ratio</strong></td>
<td>(Return - Rf) / Downside Vol</td>
<td>Return per unit of downside risk</td>
</tr>
<tr>
<td><strong>Calmar Ratio</strong></td>
<td>Annualized Return / Max Drawdown</td>
<td>Return per unit of worst loss</td>
</tr>
<tr>
<td><strong>Information Ratio</strong></td>
<td>Active Return / Tracking Error</td>
<td>Skill of active management</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PerformanceMetrics</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate comprehensive performance metrics from a return series.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        returns: Daily return series (decimal, not percent)</span>
<span class="sd">        risk_free_rate: Annual risk-free rate (default 5%)</span>
<span class="sd">        periods_per_year: Trading days per year (default 252)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">risk_free_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                 <span class="n">periods_per_year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">risk_free_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periods</span> <span class="o">=</span> <span class="n">periods_per_year</span>
    
    <span class="k">def</span> <span class="nf">total_return</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Total cumulative return.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">annualized_return</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Annualized return.&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_return</span><span class="p">()</span>
        <span class="n">n_years</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">periods</span>
        <span class="k">if</span> <span class="n">n_years</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">total</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">n_years</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">annualized_volatility</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Annualized volatility (standard deviation).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periods</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">sharpe_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Annualized Sharpe ratio.&quot;&quot;&quot;</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annualized_return</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annualized_volatility</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">excess</span> <span class="o">/</span> <span class="n">vol</span> <span class="k">if</span> <span class="n">vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="k">def</span> <span class="nf">sortino_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sortino ratio (penalizes only downside volatility).&quot;&quot;&quot;</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annualized_return</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span>
        <span class="n">downside</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">downside_vol</span> <span class="o">=</span> <span class="n">downside</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periods</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">downside</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">excess</span> <span class="o">/</span> <span class="n">downside_vol</span> <span class="k">if</span> <span class="n">downside_vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="k">def</span> <span class="nf">max_drawdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Maximum drawdown as a negative percentage.&quot;&quot;&quot;</span>
        <span class="n">cum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">cum</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="n">cum</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
        <span class="k">return</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">calmar_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calmar ratio: annualized return / max drawdown.&quot;&quot;&quot;</span>
        <span class="n">mdd</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">annualized_return</span><span class="p">()</span> <span class="o">/</span> <span class="n">mdd</span> <span class="k">if</span> <span class="n">mdd</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="k">def</span> <span class="nf">win_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Percentage of positive return days.&quot;&quot;&quot;</span>
        <span class="n">wins</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">wins</span> <span class="o">/</span> <span class="n">total</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="k">def</span> <span class="nf">profit_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gross profits / gross losses.&quot;&quot;&quot;</span>
        <span class="n">gains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">gains</span> <span class="o">/</span> <span class="n">losses</span> <span class="k">if</span> <span class="n">losses</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">drawdown_series</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Full drawdown time series.&quot;&quot;&quot;</span>
        <span class="n">cum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">cum</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">cum</span> <span class="o">-</span> <span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak</span>
    
    <span class="k">def</span> <span class="nf">max_drawdown_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Longest drawdown duration in days.&quot;&quot;&quot;</span>
        <span class="n">cum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">cum</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="n">in_drawdown</span> <span class="o">=</span> <span class="n">cum</span> <span class="o">&lt;</span> <span class="n">peak</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_drawdown</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="c1"># Find consecutive drawdown periods</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">in_drawdown</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">drawdown_lengths</span> <span class="o">=</span> <span class="n">in_drawdown</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">drawdown_lengths</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drawdown_lengths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get all metrics as a dictionary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_return</span><span class="p">(),</span>
            <span class="s1">&#39;annualized_return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annualized_return</span><span class="p">(),</span>
            <span class="s1">&#39;annualized_volatility&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">annualized_volatility</span><span class="p">(),</span>
            <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharpe_ratio</span><span class="p">(),</span>
            <span class="s1">&#39;sortino_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortino_ratio</span><span class="p">(),</span>
            <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">(),</span>
            <span class="s1">&#39;calmar_ratio&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calmar_ratio</span><span class="p">(),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">win_rate</span><span class="p">(),</span>
            <span class="s1">&#39;profit_factor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">profit_factor</span><span class="p">(),</span>
            <span class="s1">&#39;max_dd_duration&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown_duration</span><span class="p">(),</span>
            <span class="s1">&#39;num_days&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print formatted performance report.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">45</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Performance Report: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">45</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Return:      </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annual Return:     </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;annualized_return&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Annual Volatility: </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;annualized_volatility&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe Ratio:      </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sortino Ratio:     </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sortino_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Drawdown:      </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Calmar Ratio:      </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;calmar_ratio&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Win Rate:          </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;8.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Profit Factor:     </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;profit_factor&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;8.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max DD Duration:   </span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;max_dd_duration&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;5d</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">45</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># Calculate metrics for our SMA strategy</span>
<span class="n">strat_returns</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;net_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">market_returns</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;daily_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">strat_metrics</span> <span class="o">=</span> <span class="n">PerformanceMetrics</span><span class="p">(</span><span class="n">strat_returns</span><span class="p">)</span>
<span class="n">market_metrics</span> <span class="o">=</span> <span class="n">PerformanceMetrics</span><span class="p">(</span><span class="n">market_returns</span><span class="p">)</span>

<span class="n">strat_metrics</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s1">&#39;SMA 20/50 Crossover&#39;</span><span class="p">)</span>
<span class="n">market_metrics</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s1">&#39;Buy &amp; Hold AAPL&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>2.2 Drawdown Analysis</h2>
<p>Drawdowns are critical for understanding risk. A strategy with great returns but 50% drawdowns may be unbearable in practice.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">DrawdownAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detailed drawdown analysis.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cum_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_returns</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cum_returns</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span>
    
    <span class="k">def</span> <span class="nf">top_drawdowns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the N worst drawdown periods.</span>
<span class="sd">        </span>
<span class="sd">        Returns DataFrame with start, trough, end, depth, duration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="c1"># Find trough</span>
            <span class="n">trough_idx</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
            <span class="n">trough_val</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">trough_idx</span><span class="p">]</span>
            
            <span class="c1"># Find start (last peak before trough)</span>
            <span class="n">before_trough</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[:</span><span class="n">trough_idx</span><span class="p">]</span>
            <span class="n">peaks_before</span> <span class="o">=</span> <span class="n">before_trough</span><span class="p">[</span><span class="n">before_trough</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">peaks_before</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks_before</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">dd</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># Find end (first recovery after trough)</span>
            <span class="n">after_trough</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">trough_idx</span><span class="p">:]</span>
            <span class="n">recovery</span> <span class="o">=</span> <span class="n">after_trough</span><span class="p">[</span><span class="n">after_trough</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">recovery</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">dd</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
            
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="n">start_idx</span><span class="p">,</span>
                <span class="s1">&#39;trough&#39;</span><span class="p">:</span> <span class="n">trough_idx</span><span class="p">,</span>
                <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="n">end_idx</span><span class="p">,</span>
                <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">trough_val</span><span class="p">,</span>
                <span class="s1">&#39;duration_days&#39;</span><span class="p">:</span> <span class="n">duration</span>
            <span class="p">})</span>
            
            <span class="c1"># Zero out this drawdown period to find the next one</span>
            <span class="n">dd</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot drawdown chart.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Equity curve</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cum_returns</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cum_returns</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Equity&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peak&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Equity Curve&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Return&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Drawdown</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Analyze drawdowns</span>
<span class="n">dd_analyzer</span> <span class="o">=</span> <span class="n">DrawdownAnalyzer</span><span class="p">(</span><span class="n">strat_returns</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top 5 Drawdowns:&quot;</span><span class="p">)</span>
<span class="n">top_dd</span> <span class="o">=</span> <span class="n">dd_analyzer</span><span class="o">.</span><span class="n">top_drawdowns</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top_dd</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  #</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;duration_days&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> days)&quot;</span><span class="p">)</span>

<span class="n">dd_analyzer</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 9.2: Strategy Comparison Report (Open-ended)</h3>
<p>Compare multiple strategies side-by-side.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">StrategyComparison</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare multiple strategies.</span>
<span class="sd">    </span>
<span class="sd">    Build a system that:</span>
<span class="sd">    1. Takes a dict of {name: return_series}</span>
<span class="sd">    2. Calculates PerformanceMetrics for each</span>
<span class="sd">    3. Creates a comparison table</span>
<span class="sd">    4. Plots all equity curves on the same chart</span>
<span class="sd">    5. Highlights the best strategy for each metric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategies</span> <span class="o">=</span> <span class="n">strategies</span>
    
    <span class="k">def</span> <span class="nf">comparison_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: Build comparison DataFrame with all metrics per strategy</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">plot_equity_curves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Plot all strategies on one chart</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">best_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># TODO: Return name of best strategy for given metric</span>
        <span class="k">pass</span>

<span class="c1"># Test: Compare SMA crossover vs buy-and-hold</span>
<span class="c1"># strategies = {&#39;SMA 20/50&#39;: strat_returns, &#39;Buy &amp; Hold&#39;: market_returns}</span>
<span class="c1"># comp = StrategyComparison(strategies)</span>
<span class="c1"># print(comp.comparison_table())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 3: Position Sizing</h1>
<h2>3.1 Why Position Sizing Matters</h2>
<p>Position sizing determines <strong>how much</strong> to risk on each trade. Even a great strategy can blow up with poor sizing.</p>
<h3>Position Sizing Methods</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Fixed Amount</strong></td>
<td>Same dollar amount per trade</td>
<td>Beginners</td>
</tr>
<tr>
<td><strong>Fixed Shares</strong></td>
<td>Same number of shares</td>
<td>Simple strategies</td>
</tr>
<tr>
<td><strong>Percent of Equity</strong></td>
<td>Fixed % of portfolio per trade</td>
<td>Consistent risk</td>
</tr>
<tr>
<td><strong>Percent Risk</strong></td>
<td>Size based on stop loss distance</td>
<td>Active traders</td>
</tr>
<tr>
<td><strong>Volatility-Adjusted</strong></td>
<td>Size inversely proportional to volatility</td>
<td>Quant strategies</td>
</tr>
<tr>
<td><strong>Kelly Criterion</strong></td>
<td>Optimal fraction based on edge</td>
<td>Theoretical max</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PositionSizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate position sizes using various methods.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        portfolio_value: Current total portfolio value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">portfolio_value</span>
    
    <span class="k">def</span> <span class="nf">fixed_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fixed dollar amount per trade.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            amount: Dollar amount to invest</span>
<span class="sd">            price: Current share price</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount</span> <span class="o">/</span> <span class="n">price</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">percent_of_equity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fixed percentage of portfolio.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            pct: Percentage of portfolio (e.g., 10 for 10%)</span>
<span class="sd">            price: Current share price</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount</span> <span class="o">/</span> <span class="n">price</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">percent_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                     <span class="n">stop_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Size based on maximum risk per trade.</span>
<span class="sd">        </span>
<span class="sd">        The key formula:</span>
<span class="sd">        shares = (portfolio * risk_pct) / (entry_price - stop_price)</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            risk_pct: Max risk as % of portfolio (e.g., 1 for 1%)</span>
<span class="sd">            price: Entry price</span>
<span class="sd">            stop_price: Stop loss price</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">risk_per_share</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">stop_price</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">risk_per_share</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">risk_amount</span> <span class="o">/</span> <span class="n">risk_per_share</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">volatility_adjusted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_vol_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">atr</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Size inversely proportional to volatility (ATR).</span>
<span class="sd">        </span>
<span class="sd">        Idea: Trade fewer shares of volatile stocks,</span>
<span class="sd">              more shares of stable stocks.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            target_vol_pct: Target portfolio volatility per position (e.g., 1%)</span>
<span class="sd">            price: Current share price</span>
<span class="sd">            atr: Average True Range (14-period)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_dollar_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">target_vol_pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_dollar_vol</span> <span class="o">/</span> <span class="n">atr</span><span class="p">)</span> <span class="k">if</span> <span class="n">atr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">kelly_criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">win_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">avg_win</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                        <span class="n">avg_loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                        <span class="n">fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kelly criterion for optimal sizing.</span>
<span class="sd">        </span>
<span class="sd">        Kelly % = W - (1-W)/R</span>
<span class="sd">        where W = win rate, R = avg_win/avg_loss</span>
<span class="sd">        </span>
<span class="sd">        Using half-Kelly (fraction=0.5) is common for safety.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            win_rate: Historical win rate (0-1)</span>
<span class="sd">            avg_win: Average winning trade return</span>
<span class="sd">            avg_loss: Average losing trade return (positive number)</span>
<span class="sd">            price: Current share price</span>
<span class="sd">            fraction: Kelly fraction (0.5 = half-Kelly)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">avg_loss</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">r</span> <span class="o">=</span> <span class="n">avg_win</span> <span class="o">/</span> <span class="n">avg_loss</span>  <span class="c1"># Win/loss ratio</span>
        <span class="n">kelly_pct</span> <span class="o">=</span> <span class="n">win_rate</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">win_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span>
        
        <span class="c1"># Apply fraction and cap at 25%</span>
        <span class="n">kelly_pct</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">kelly_pct</span> <span class="o">*</span> <span class="n">fraction</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
        
        <span class="n">amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">*</span> <span class="n">kelly_pct</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount</span> <span class="o">/</span> <span class="n">price</span><span class="p">)</span>


<span class="c1"># Compare position sizing methods</span>
<span class="n">sizer</span> <span class="o">=</span> <span class="n">PositionSizer</span><span class="p">(</span><span class="n">portfolio_value</span><span class="o">=</span><span class="mi">100_000</span><span class="p">)</span>
<span class="n">price</span> <span class="o">=</span> <span class="mf">190.0</span>
<span class="n">stop</span> <span class="o">=</span> <span class="mf">180.0</span>  <span class="c1"># $10 stop</span>
<span class="n">atr</span> <span class="o">=</span> <span class="mf">4.50</span>    <span class="c1"># ATR(14)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position Sizing Comparison (Portfolio: $100,000, Price: $</span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Method&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Shares&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Notional&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;</span><span class="si">% o</span><span class="s1">f Portfolio&#39;</span><span class="si">:</span><span class="s2">&gt;15</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">62</span><span class="p">)</span>

<span class="n">methods</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;Fixed $10K&#39;</span><span class="p">,</span> <span class="n">sizer</span><span class="o">.</span><span class="n">fixed_amount</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,</span> <span class="n">price</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;10</span><span class="si">% o</span><span class="s1">f Equity&#39;</span><span class="p">,</span> <span class="n">sizer</span><span class="o">.</span><span class="n">percent_of_equity</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">price</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;1% Risk (stop $180)&#39;</span><span class="p">,</span> <span class="n">sizer</span><span class="o">.</span><span class="n">percent_risk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">stop</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;2% Risk (stop $180)&#39;</span><span class="p">,</span> <span class="n">sizer</span><span class="o">.</span><span class="n">percent_risk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">stop</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;Vol-Adjusted (1%)&#39;</span><span class="p">,</span> <span class="n">sizer</span><span class="o">.</span><span class="n">volatility_adjusted</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atr</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;Half-Kelly (60% WR)&#39;</span><span class="p">,</span> <span class="n">sizer</span><span class="o">.</span><span class="n">kelly_criterion</span><span class="p">(</span><span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">shares</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
    <span class="n">notional</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">*</span> <span class="n">price</span>
    <span class="n">pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">notional</span> <span class="o">/</span> <span class="n">sizer</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">shares</span><span class="si">:</span><span class="s2">&gt;8,</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">notional</span><span class="si">:</span><span class="s2">&gt;11,.0f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">&gt;14.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 9.3: Dynamic Position Sizer (Guided)</h3>
<p>Build a position sizer that adjusts based on recent strategy performance.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">DynamicPositionSizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjusts position size based on recent performance.</span>
<span class="sd">    </span>
<span class="sd">    Idea: Size up when winning, size down when losing.</span>
<span class="sd">    Uses a rolling Sharpe ratio to scale position size.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">base_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">portfolio_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_risk_pct</span> <span class="o">=</span> <span class="n">base_risk_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>
    
    <span class="k">def</span> <span class="nf">calculate_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">recent_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate position size adjusted by recent performance.</span>
<span class="sd">        </span>
<span class="sd">        Returns dict with shares, risk_pct, and scaling_factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Calculate rolling Sharpe of recent returns</span>
        <span class="n">rolling_mean</span> <span class="o">=</span> <span class="n">recent_returns</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        <span class="n">rolling_std</span> <span class="o">=</span> <span class="n">recent_returns</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
        <span class="n">rolling_sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">rolling_mean</span> <span class="o">/</span> <span class="n">rolling_std</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="k">if</span> <span class="n">rolling_std</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># TODO: Scale risk between 0.5x and 2x based on Sharpe</span>
        <span class="c1"># Sharpe &gt; 1: scale up, Sharpe &lt; 0: scale down</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">rolling_sharpe</span> <span class="o">*</span> <span class="n">______</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
        
        <span class="c1"># TODO: Calculate adjusted risk percentage</span>
        <span class="n">adjusted_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_risk_pct</span> <span class="o">*</span> <span class="n">______</span>
        
        <span class="c1"># TODO: Calculate shares using percent risk method</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">adjusted_risk</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">risk_per_share</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">stop_price</span><span class="p">)</span>
        <span class="n">shares</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">risk_amount</span> <span class="o">/</span> <span class="n">risk_per_share</span><span class="p">)</span> <span class="k">if</span> <span class="n">risk_per_share</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;shares&#39;</span><span class="p">:</span> <span class="n">shares</span><span class="p">,</span>
            <span class="s1">&#39;adjusted_risk_pct&#39;</span><span class="p">:</span> <span class="n">adjusted_risk</span><span class="p">,</span>
            <span class="s1">&#39;scaling_factor&#39;</span><span class="p">:</span> <span class="n">scaling</span><span class="p">,</span>
            <span class="s1">&#39;rolling_sharpe&#39;</span><span class="p">:</span> <span class="n">rolling_sharpe</span>
        <span class="p">}</span>


<span class="c1"># Test</span>
<span class="c1"># dynamic = DynamicPositionSizer(100_000)</span>
<span class="c1"># result = dynamic.calculate_size(190.0, 180.0, strat_returns)</span>
<span class="c1"># print(result)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DynamicPositionSizer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjusts position size based on recent performance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">base_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">lookback</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">portfolio_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_risk_pct</span> <span class="o">=</span> <span class="n">base_risk_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback</span>

    <span class="k">def</span> <span class="nf">calculate_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">recent_returns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">rolling_mean</span> <span class="o">=</span> <span class="n">recent_returns</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rolling_std</span> <span class="o">=</span> <span class="n">recent_returns</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">rolling_sharpe</span> <span class="o">=</span> <span class="p">(</span><span class="n">rolling_mean</span> <span class="o">/</span> <span class="n">rolling_std</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="k">if</span> <span class="n">rolling_std</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">rolling_sharpe</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="n">adjusted_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_risk_pct</span> <span class="o">*</span> <span class="n">scaling</span>

        <span class="n">risk_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">adjusted_risk</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">risk_per_share</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">stop_price</span><span class="p">)</span>
        <span class="n">shares</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">risk_amount</span> <span class="o">/</span> <span class="n">risk_per_share</span><span class="p">)</span> <span class="k">if</span> <span class="n">risk_per_share</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;shares&#39;</span><span class="p">:</span> <span class="n">shares</span><span class="p">,</span>
            <span class="s1">&#39;adjusted_risk_pct&#39;</span><span class="p">:</span> <span class="n">adjusted_risk</span><span class="p">,</span>
            <span class="s1">&#39;scaling_factor&#39;</span><span class="p">:</span> <span class="n">scaling</span><span class="p">,</span>
            <span class="s1">&#39;rolling_sharpe&#39;</span><span class="p">:</span> <span class="n">rolling_sharpe</span>
        <span class="p">}</span>

<span class="n">dynamic</span> <span class="o">=</span> <span class="n">DynamicPositionSizer</span><span class="p">(</span><span class="mi">100_000</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">dynamic</span><span class="o">.</span><span class="n">calculate_size</span><span class="p">(</span><span class="mf">190.0</span><span class="p">,</span> <span class="mf">180.0</span><span class="p">,</span> <span class="n">strat_returns</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dynamic Position Size:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Portfolio Risk Management</h1>
<h2>4.1 Correlation Awareness</h2>
<p>Holding multiple correlated positions is like holding one big position. Portfolio risk management ensures true diversification.</p>
<h3>Key Concepts</h3>
<ul>
<li><strong>Correlation Matrix:</strong> Measures how assets move together</li>
<li><strong>Sector Concentration:</strong> Avoid putting too much in one sector</li>
<li><strong>Portfolio Heat:</strong> Total risk exposure across all positions</li>
<li><strong>Maximum Drawdown Limits:</strong> Kill switch when losses get too large</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PortfolioRiskManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monitor and manage portfolio-level risk.</span>
<span class="sd">    </span>
<span class="sd">    Tracks:</span>
<span class="sd">    - Position-level risk</span>
<span class="sd">    - Correlation between holdings</span>
<span class="sd">    - Sector exposure</span>
<span class="sd">    - Overall portfolio heat</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">max_position_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">,</span>
                 <span class="n">max_sector_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">40.0</span><span class="p">,</span>
                 <span class="n">max_correlated_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">50.0</span><span class="p">,</span>
                 <span class="n">max_portfolio_risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">6.0</span><span class="p">,</span>
                 <span class="n">max_drawdown_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">portfolio_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_position_pct</span> <span class="o">=</span> <span class="n">max_position_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_sector_pct</span> <span class="o">=</span> <span class="n">max_sector_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_correlated_pct</span> <span class="o">=</span> <span class="n">max_correlated_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_portfolio_risk_pct</span> <span class="o">=</span> <span class="n">max_portfolio_risk_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown_pct</span> <span class="o">=</span> <span class="n">max_drawdown_pct</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_value</span> <span class="o">=</span> <span class="n">portfolio_value</span>
    
    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">shares</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">stop_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sector</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a position to track.&quot;&quot;&quot;</span>
        <span class="n">notional</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">*</span> <span class="n">price</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">stop_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">shares</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;shares&#39;</span><span class="p">:</span> <span class="n">shares</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;stop_price&#39;</span><span class="p">:</span> <span class="n">stop_price</span><span class="p">,</span>
            <span class="s1">&#39;sector&#39;</span><span class="p">:</span> <span class="n">sector</span><span class="p">,</span>
            <span class="s1">&#39;notional&#39;</span><span class="p">:</span> <span class="n">notional</span><span class="p">,</span>
            <span class="s1">&#39;risk&#39;</span><span class="p">:</span> <span class="n">risk</span><span class="p">,</span>
            <span class="s1">&#39;weight_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">notional</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;risk_pct&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">risk</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">remove_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a position.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">total_exposure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Total portfolio exposure as % of equity.&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;notional&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">total_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Total portfolio risk (sum of all stop-loss risks) as %.&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;risk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    
    <span class="k">def</span> <span class="nf">sector_exposure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Exposure by sector as % of portfolio.&quot;&quot;&quot;</span>
        <span class="n">sectors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">sector</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span>
            <span class="n">sectors</span><span class="p">[</span><span class="n">sector</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;weight_pct&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sectors</span>
    
    <span class="k">def</span> <span class="nf">check_new_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">shares</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                        <span class="n">stop_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sector</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a new trade passes all risk limits.</span>
<span class="sd">        </span>
<span class="sd">        Returns dict with &#39;approved&#39; bool and list of &#39;violations&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">violations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">notional</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">*</span> <span class="n">price</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">stop_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">shares</span>
        
        <span class="c1"># Check position size limit</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">notional</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_position_pct</span><span class="p">:</span>
            <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Position size </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% exceeds max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_position_pct</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check sector limit</span>
        <span class="n">current_sector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector_exposure</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">new_sector</span> <span class="o">=</span> <span class="n">current_sector</span> <span class="o">+</span> <span class="n">weight</span>
        <span class="k">if</span> <span class="n">new_sector</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sector_pct</span><span class="p">:</span>
            <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Sector </span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2"> would be </span><span class="si">{</span><span class="n">new_sector</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_sector_pct</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check total portfolio risk</span>
        <span class="n">risk_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">risk</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">new_total_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_risk</span><span class="p">()</span> <span class="o">+</span> <span class="n">risk_pct</span>
        <span class="k">if</span> <span class="n">new_total_risk</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_portfolio_risk_pct</span><span class="p">:</span>
            <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Total risk would be </span><span class="si">{</span><span class="n">new_total_risk</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%, max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_portfolio_risk_pct</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check drawdown limit</span>
        <span class="n">current_dd</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_value</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_value</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="n">current_dd</span> <span class="o">&lt;</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown_pct</span><span class="p">:</span>
            <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Portfolio in drawdown (</span><span class="si">{</span><span class="n">current_dd</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%), max allowed </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown_pct</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;approved&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;violations&#39;</span><span class="p">:</span> <span class="n">violations</span><span class="p">,</span>
            <span class="s1">&#39;position_weight&#39;</span><span class="p">:</span> <span class="n">weight</span><span class="p">,</span>
            <span class="s1">&#39;position_risk&#39;</span><span class="p">:</span> <span class="n">risk_pct</span><span class="p">,</span>
            <span class="s1">&#39;total_risk_after&#39;</span><span class="p">:</span> <span class="n">new_total_risk</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print risk dashboard.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">55</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PORTFOLIO RISK DASHBOARD&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">55</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Portfolio Value:  $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s2">&gt;12,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Peak Value:       $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_value</span><span class="si">:</span><span class="s2">&gt;12,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_value</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_value</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Current Drawdown: </span><span class="si">{</span><span class="n">dd</span><span class="si">:</span><span class="s2">&gt;12.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Positions:        </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span><span class="si">:</span><span class="s2">&gt;12d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Exposure:   </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_exposure</span><span class="p">()</span><span class="si">:</span><span class="s2">&gt;11.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total Risk:       </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_risk</span><span class="p">()</span><span class="si">:</span><span class="s2">&gt;11.1f</span><span class="si">}</span><span class="s2">% (max </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_portfolio_risk_pct</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="s1">&#39;Symbol&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Weight&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Risk&#39;</span><span class="si">:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Sector&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">42</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">symbol</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;weight_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;7.1f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;risk_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;7.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">sectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sector_exposure</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sectors</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Sector Exposure:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sector</span><span class="p">,</span> <span class="n">pct</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sectors</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">bar</span> <span class="o">=</span> <span class="s1">&#39;‚ñà&#39;</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">pct</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">sector</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">&gt;6.1f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">55</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># Demo the risk manager</span>
<span class="n">rm</span> <span class="o">=</span> <span class="n">PortfolioRiskManager</span><span class="p">(</span><span class="n">portfolio_value</span><span class="o">=</span><span class="mi">100_000</span><span class="p">)</span>

<span class="c1"># Add some positions</span>
<span class="n">rm</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">190.0</span><span class="p">,</span> <span class="mf">180.0</span><span class="p">,</span> <span class="s1">&#39;Technology&#39;</span><span class="p">)</span>
<span class="n">rm</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">420.0</span><span class="p">,</span> <span class="mf">400.0</span><span class="p">,</span> <span class="s1">&#39;Technology&#39;</span><span class="p">)</span>
<span class="n">rm</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;JPM&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mf">195.0</span><span class="p">,</span> <span class="mf">185.0</span><span class="p">,</span> <span class="s1">&#39;Financials&#39;</span><span class="p">)</span>
<span class="n">rm</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="s1">&#39;JNJ&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mf">160.0</span><span class="p">,</span> <span class="mf">150.0</span><span class="p">,</span> <span class="s1">&#39;Healthcare&#39;</span><span class="p">)</span>

<span class="n">rm</span><span class="o">.</span><span class="n">dashboard</span><span class="p">()</span>

<span class="c1"># Check if we can add a new position</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Checking new trade: NVDA 20 shares @ $890, stop $850&quot;</span><span class="p">)</span>
<span class="n">check</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">check_new_trade</span><span class="p">(</span><span class="s1">&#39;NVDA&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">890.0</span><span class="p">,</span> <span class="mf">850.0</span><span class="p">,</span> <span class="s1">&#39;Technology&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Approved: </span><span class="si">{</span><span class="n">check</span><span class="p">[</span><span class="s1">&#39;approved&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;violations&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;violations&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ‚ö† </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>4.2 Correlation-Based Risk</h2>
<p>Positions in correlated stocks amplify risk. We need to check correlation before adding new trades.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">CorrelationMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor correlations between portfolio holdings.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;6mo&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_prices</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_fetch_prices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch price data for all symbols.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">prices</span>
    
    <span class="k">def</span> <span class="nf">correlation_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate correlation matrix.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">highly_correlated_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find pairs with correlation above threshold.&quot;&quot;&quot;</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_matrix</span><span class="p">()</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                        <span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                        <span class="n">corr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="p">))</span>
        
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    
    <span class="k">def</span> <span class="nf">plot_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot correlation heatmap.&quot;&quot;&quot;</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_matrix</span><span class="p">()</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="c1"># Add values</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr</span><span class="p">)):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">corr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                       <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Correlation Matrix&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Check correlations for portfolio holdings</span>
<span class="n">holdings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;JPM&#39;</span><span class="p">,</span> <span class="s1">&#39;JNJ&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>
<span class="n">corr_monitor</span> <span class="o">=</span> <span class="n">CorrelationMonitor</span><span class="p">(</span><span class="n">holdings</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation Matrix:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">corr_monitor</span><span class="o">.</span><span class="n">correlation_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Highly Correlated Pairs (&gt; 0.7):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sym1</span><span class="p">,</span> <span class="n">sym2</span><span class="p">,</span> <span class="n">corr</span> <span class="ow">in</span> <span class="n">corr_monitor</span><span class="o">.</span><span class="n">highly_correlated_pairs</span><span class="p">(</span><span class="mf">0.7</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">sym1</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">sym2</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">corr</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">corr_monitor</span><span class="o">.</span><span class="n">plot_correlation</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 9.4: Drawdown Kill Switch (Open-ended)</h3>
<p>Build a drawdown-based risk management system.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">DrawdownKillSwitch</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automated drawdown management.</span>
<span class="sd">    </span>
<span class="sd">    Implement a system that:</span>
<span class="sd">    1. Tracks portfolio drawdown in real-time</span>
<span class="sd">    2. Reduces position sizes at warning threshold (e.g., -10%)</span>
<span class="sd">    3. Closes all positions at kill threshold (e.g., -15%)</span>
<span class="sd">    4. Requires recovery above a level before resuming (e.g., -5%)</span>
<span class="sd">    5. Logs all actions taken</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">warning_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
                 <span class="n">kill_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>
                 <span class="n">resume_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio_value</span> <span class="o">=</span> <span class="n">portfolio_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_value</span> <span class="o">=</span> <span class="n">portfolio_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warning_pct</span> <span class="o">=</span> <span class="n">warning_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kill_pct</span> <span class="o">=</span> <span class="n">kill_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume_pct</span> <span class="o">=</span> <span class="n">resume_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_killed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># TODO: Update peak, calculate drawdown</span>
        <span class="c1"># TODO: Check warning and kill thresholds</span>
        <span class="c1"># TODO: Handle resume logic</span>
        <span class="c1"># TODO: Return action dict</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">get_position_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># TODO: Return 1.0 (normal), 0.5 (warning), 0.0 (killed)</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># ks = DrawdownKillSwitch(100_000)</span>
<span class="c1"># print(ks.update(95_000))  # Warning</span>
<span class="c1"># print(ks.update(84_000))  # Kill</span>
</code></pre></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 9.5: Full Backtest with Risk Management (Guided)</h3>
<p>Combine the backtester with position sizing and risk management.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">backtest_with_risk_management</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">signals</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                                   <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">,</span>
                                   <span class="n">risk_per_trade</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                                   <span class="n">max_drawdown</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run backtest with position sizing and drawdown protection.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Percent risk position sizing</span>
<span class="sd">    - ATR-based stops</span>
<span class="sd">    - Drawdown limit (reduce/stop trading)</span>
<span class="sd">    </span>
<span class="sd">    Returns DataFrame with equity curve and trade log.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate ATR for stop placement</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">prices</span>  <span class="c1"># Simplified: use close as proxy</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">prices</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    <span class="n">atr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">______</span><span class="p">()</span>
    
    <span class="c1"># TODO: Initialize tracking variables</span>
    <span class="n">equity</span> <span class="o">=</span> <span class="n">______</span><span class="p">()</span>
    <span class="n">peak_equity</span> <span class="o">=</span> <span class="n">initial_capital</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_capital</span>
    
    <span class="c1"># TODO: Loop through each bar</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)):</span>
        <span class="c1"># Calculate current drawdown</span>
        <span class="n">drawdown_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">-</span> <span class="n">peak_equity</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak_equity</span> <span class="o">*</span> <span class="mi">100</span>
        
        <span class="c1"># Position scaling based on drawdown</span>
        <span class="k">if</span> <span class="n">drawdown_pct</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">max_drawdown</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">______</span>  <span class="c1"># Stop trading</span>
        <span class="k">elif</span> <span class="n">drawdown_pct</span> <span class="o">&lt;</span> <span class="o">-</span><span class="p">(</span><span class="n">max_drawdown</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">):</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">______</span>  <span class="c1"># Reduce size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">______</span>  <span class="c1"># Full size</span>
        
        <span class="c1"># Calculate position size</span>
        <span class="n">current_atr</span> <span class="o">=</span> <span class="n">atr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">atr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">else</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.02</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">equity</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_per_trade</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="n">shares</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">risk_amount</span> <span class="o">/</span> <span class="p">(</span><span class="n">current_atr</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="k">if</span> <span class="n">current_atr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># Calculate daily P&amp;L</span>
        <span class="n">daily_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">position_value</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">*</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">daily_pnl</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">*</span> <span class="n">daily_return</span> <span class="o">*</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="c1"># Update equity</span>
        <span class="n">equity</span> <span class="o">+=</span> <span class="n">daily_pnl</span>
        <span class="n">peak_equity</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">peak_equity</span><span class="p">,</span> <span class="n">equity</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;equity&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">equity</span>
    
    <span class="k">return</span> <span class="n">results</span>


<span class="c1"># Test</span>
<span class="c1"># results_rm = backtest_with_risk_management(df[&#39;Close&#39;], signals)</span>
<span class="c1"># print(f&quot;Final equity: ${results_rm[&#39;equity&#39;].iloc[-1]:,.2f}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>üí° Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">backtest_with_risk_management</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">signals</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                                   <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">,</span>
                                   <span class="n">risk_per_trade</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                                   <span class="n">max_drawdown</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    <span class="n">atr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">equity</span> <span class="o">=</span> <span class="n">initial_capital</span>
    <span class="n">peak_equity</span> <span class="o">=</span> <span class="n">initial_capital</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prices</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_capital</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;drawdown_pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)):</span>
        <span class="n">drawdown_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">equity</span> <span class="o">-</span> <span class="n">peak_equity</span><span class="p">)</span> <span class="o">/</span> <span class="n">peak_equity</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="n">drawdown_pct</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">max_drawdown</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="n">drawdown_pct</span> <span class="o">&lt;</span> <span class="o">-</span><span class="p">(</span><span class="n">max_drawdown</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">):</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">current_atr</span> <span class="o">=</span> <span class="n">atr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">atr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">else</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.02</span>
        <span class="n">risk_amount</span> <span class="o">=</span> <span class="n">equity</span> <span class="o">*</span> <span class="p">(</span><span class="n">risk_per_trade</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="n">shares</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">risk_amount</span> <span class="o">/</span> <span class="p">(</span><span class="n">current_atr</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="k">if</span> <span class="n">current_atr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">daily_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">position_value</span> <span class="o">=</span> <span class="n">shares</span> <span class="o">*</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">daily_pnl</span> <span class="o">=</span> <span class="n">position_value</span> <span class="o">*</span> <span class="n">daily_return</span> <span class="o">*</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">equity</span> <span class="o">+=</span> <span class="n">daily_pnl</span>
        <span class="n">peak_equity</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">peak_equity</span><span class="p">,</span> <span class="n">equity</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;equity&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">equity</span>
        <span class="n">results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;drawdown_pct&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">drawdown_pct</span>
        <span class="n">results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">scale</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="n">results_rm</span> <span class="o">=</span> <span class="n">backtest_with_risk_management</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">signals</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final equity (with risk mgmt): $</span><span class="si">{</span><span class="n">results_rm</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final equity (no risk mgmt):   $</span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Plot comparison</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results_rm</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">results_rm</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;With Risk Mgmt&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Without Risk Mgmt&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Impact of Risk Management&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Value ($)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><h3>‚úèÔ∏è Exercise 9.6: Multi-Stock Portfolio Backtest (Open-ended)</h3>
<p>Build a portfolio-level backtester that manages multiple positions.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PortfolioBacktester</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Backtest a strategy across multiple stocks.</span>
<span class="sd">    </span>
<span class="sd">    Build a system that:</span>
<span class="sd">    1. Takes signals for multiple stocks</span>
<span class="sd">    2. Uses percent-risk position sizing</span>
<span class="sd">    3. Enforces sector and correlation limits</span>
<span class="sd">    4. Tracks portfolio-level metrics</span>
<span class="sd">    5. Generates a full performance report</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
    
    <span class="k">def</span> <span class="nf">generate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
        <span class="c1"># TODO: Generate SMA crossover signals for each stock</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># TODO: Backtest with position sizing and risk limits</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Print portfolio performance report</span>
        <span class="k">pass</span>

<span class="c1"># Test</span>
<span class="c1"># portfolio_bt = PortfolioBacktester(FAANG)</span>
<span class="c1"># portfolio_bt.run()</span>
<span class="c1"># portfolio_bt.report()</span>
</code></pre></div>
<div class="md-cell module-project"><hr />
<h1>Module Project: Complete Backtesting Framework</h1>
<p>Build a production-quality backtesting framework that combines everything from this module.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">BacktestingFramework</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Complete backtesting framework.</span>
<span class="sd">    </span>
<span class="sd">    Features:</span>
<span class="sd">    - Vectorized backtesting with realistic costs</span>
<span class="sd">    - Multiple position sizing methods</span>
<span class="sd">    - Comprehensive performance metrics</span>
<span class="sd">    - Drawdown analysis and protection</span>
<span class="sd">    - Portfolio risk management</span>
<span class="sd">    - Visual reporting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">=</span> <span class="n">initial_capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_model</span> <span class="o">=</span> <span class="n">CostModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">backtest_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">signal_func</span><span class="p">,</span>
                        <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;2y&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backtest a signal function on a single stock.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            symbol: Stock ticker</span>
<span class="sd">            signal_func: Function that takes a DataFrame and returns signals</span>
<span class="sd">            period: Data period</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Fetch data</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No data&#39;</span><span class="p">}</span>
        
        <span class="c1"># Generate signals</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="n">signal_func</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="c1"># Run backtest</span>
        <span class="n">bt</span> <span class="o">=</span> <span class="n">VectorizedBacktester</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">signals</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">cost_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        
        <span class="c1"># Calculate metrics</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">PerformanceMetrics</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;net_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        
        <span class="c1"># Drawdown analysis</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">DrawdownAnalyzer</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;net_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">summary</span><span class="p">(),</span>
            <span class="s1">&#39;top_drawdowns&#39;</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">top_drawdowns</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">backtest_universe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">signal_func</span><span class="p">,</span>
                          <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;2y&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backtest a signal function across multiple stocks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest_single</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">signal_func</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">}</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">])</span>
                    <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error backtesting </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">all_results</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">signal_func</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;2y&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate complete backtest report.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtest_single</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">signal_func</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Performance report</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">PerformanceMetrics</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;net_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> Strategy&quot;</span><span class="p">)</span>
        
        <span class="c1"># Top drawdowns</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top Drawdowns:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;top_drawdowns&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  #</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;duration_days&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> days)&quot;</span><span class="p">)</span>
        
        <span class="c1"># Plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> 
                                 <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="n">r</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span>
        
        <span class="c1"># Equity curve</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_capital</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;cum_market&#39;</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Buy &amp; Hold&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;equity&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strategy&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> Backtest Results&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Portfolio Value ($)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Drawdown</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">DrawdownAnalyzer</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;net_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dd</span><span class="o">.</span><span class="n">drawdown</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Drawdown&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Drawdown (%)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Signal positions</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> 
                    <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps-post&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Signal&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;Short&#39;</span><span class="p">,</span> <span class="s1">&#39;Flat&#39;</span><span class="p">,</span> <span class="s1">&#39;Long&#39;</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Define a signal function</span>
<span class="k">def</span> <span class="nf">sma_crossover_signal</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;SMA 20/50 crossover signal.&quot;&quot;&quot;</span>
    <span class="n">sma_20</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">sma_50</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sma_20</span> <span class="o">&gt;</span> <span class="n">sma_50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>


<span class="c1"># Run the full framework</span>
<span class="n">framework</span> <span class="o">=</span> <span class="n">BacktestingFramework</span><span class="p">(</span><span class="n">initial_capital</span><span class="o">=</span><span class="mi">100_000</span><span class="p">)</span>
<span class="n">framework</span><span class="o">.</span><span class="n">full_report</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">sma_crossover_signal</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Backtest across FAANG universe</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Universe Backtest: SMA 20/50 Crossover&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>

<span class="n">universe_results</span> <span class="o">=</span> <span class="n">framework</span><span class="o">.</span><span class="n">backtest_universe</span><span class="p">(</span><span class="n">FAANG</span><span class="p">,</span> <span class="n">sma_crossover_signal</span><span class="p">)</span>

<span class="n">display_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;total_return&#39;</span><span class="p">,</span> <span class="s1">&#39;annualized_return&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;max_drawdown&#39;</span><span class="p">,</span> <span class="s1">&#39;win_rate&#39;</span><span class="p">]</span>

<span class="n">formatted</span> <span class="o">=</span> <span class="n">universe_results</span><span class="p">[</span><span class="n">display_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">formatted</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted</span><span class="p">[</span><span class="s1">&#39;total_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="n">formatted</span><span class="p">[</span><span class="s1">&#39;annualized_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted</span><span class="p">[</span><span class="s1">&#39;annualized_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="n">formatted</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">formatted</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="n">formatted</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">formatted</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Average metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Average Sharpe: </span><span class="si">{</span><span class="n">universe_results</span><span class="p">[</span><span class="s1">&#39;sharpe_ratio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average Max DD: </span><span class="si">{</span><span class="n">universe_results</span><span class="p">[</span><span class="s1">&#39;max_drawdown&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>Avoid Biases:</strong> Lookahead, survivorship, and overfitting are the enemies of good backtests</li>
<li><strong>Model Costs:</strong> Slippage and spread costs can make or break a strategy</li>
<li><strong>Risk-Adjusted Metrics:</strong> Sharpe, Sortino, and Calmar tell you more than raw returns</li>
<li><strong>Drawdown Analysis:</strong> Understand worst-case scenarios before going live</li>
<li><strong>Position Sizing:</strong> Percent-risk and volatility-adjusted methods adapt to each trade</li>
<li><strong>Portfolio Risk:</strong> Monitor correlations, sector exposure, and total portfolio heat</li>
<li><strong>Kill Switches:</strong> Automated drawdown protection saves you from catastrophic losses</li>
</ol>
<hr />
<h2>Part 2 Complete!</h2>
<p>You've finished Strategy Development. You now have:</p>
<ul>
<li>‚úÖ Earnings-based trading strategies</li>
<li>‚úÖ Momentum and trend-following systems</li>
<li>‚úÖ Sector rotation and ETF strategies</li>
<li>‚úÖ Backtesting framework with risk management</li>
</ul>
<p><strong>Next:</strong> Part 3 - Options Trading</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="10"><div class="md-cell module-header"><h1>Module 10: Options Fundamentals</h1>
<h2>Part 3: Options Trading</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ol>
<li>Understand calls, puts, strike prices, and expiration dates</li>
<li>Read and analyse options chains using <code>yfinance</code></li>
<li>Price options with the Black-Scholes model and compute implied volatility</li>
<li>Calculate and interpret the Greeks (Delta, Gamma, Theta, Vega)</li>
<li>Build an options analytics dashboard combining all concepts</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 10: Options Fundamentals&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: Options Basics</h1>
<p>An <strong>option</strong> is a financial derivative that gives the holder the <em>right</em>, but not the
<em>obligation</em>, to buy or sell an underlying asset at a specified price on or before
a specified date.</p>
<h2>1.1 Calls and Puts</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Feature</th>
<th>Call Option</th>
<th>Put Option</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Right</strong></td>
<td>Buy the asset</td>
<td>Sell the asset</td>
</tr>
<tr>
<td><strong>Buyer profits when</strong></td>
<td>Price rises above strike</td>
<td>Price falls below strike</td>
</tr>
<tr>
<td><strong>Seller profits when</strong></td>
<td>Price stays below strike</td>
<td>Price stays above strike</td>
</tr>
<tr>
<td><strong>Max buyer loss</strong></td>
<td>Premium paid</td>
<td>Premium paid</td>
</tr>
</tbody>
</table></div>
<h2>1.2 Key Terminology</h2>
<ul>
<li><strong>Strike Price (K):</strong> The price at which the option holder can buy (call) or sell (put)</li>
<li><strong>Expiration Date:</strong> The last date the option can be exercised</li>
<li><strong>Premium:</strong> The price paid for the option contract</li>
<li><strong>Underlying:</strong> The stock (or other asset) the option is based on</li>
<li><strong>Contract Multiplier:</strong> Each option contract covers 100 shares</li>
</ul>
<h2>1.3 Moneyness</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Status</th>
<th>Call Option</th>
<th>Put Option</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>In-the-Money (ITM)</strong></td>
<td>Stock &gt; Strike</td>
<td>Stock &lt; Strike</td>
</tr>
<tr>
<td><strong>At-the-Money (ATM)</strong></td>
<td>Stock ‚âà Strike</td>
<td>Stock ‚âà Strike</td>
</tr>
<tr>
<td><strong>Out-of-the-Money (OTM)</strong></td>
<td>Stock &lt; Strike</td>
<td>Stock &gt; Strike</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">OptionContract</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a single option contract.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        symbol: Underlying stock ticker</span>
<span class="sd">        option_type: &#39;call&#39; or &#39;put&#39;</span>
<span class="sd">        strike: Strike price</span>
<span class="sd">        premium: Premium paid per share</span>
<span class="sd">        spot: Current stock price</span>
<span class="sd">        expiration: Expiration date string (YYYY-MM-DD)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">spot</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">option_type</span> <span class="o">=</span> <span class="n">option_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">=</span> <span class="n">strike</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">premium</span> <span class="o">=</span> <span class="n">premium</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spot</span> <span class="o">=</span> <span class="n">spot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expiration</span> <span class="o">=</span> <span class="n">expiration</span>

    <span class="k">def</span> <span class="nf">intrinsic_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate intrinsic value of the option.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extrinsic_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate extrinsic (time) value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">premium</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_value</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">moneyness</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return moneyness status.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;ATM&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;ITM&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="k">else</span> <span class="s1">&#39;OTM&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;ITM&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="k">else</span> <span class="s1">&#39;OTM&#39;</span>

    <span class="k">def</span> <span class="nf">payoff_at_expiry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate payoff at a given expiry price.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">premium</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">-</span> <span class="n">price</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">premium</span>

    <span class="k">def</span> <span class="nf">breakeven</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate breakeven price.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">premium</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">premium</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print option summary.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">option_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Option&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Strike:     $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Premium:    $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">premium</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Spot:       $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expiration: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expiration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Moneyness:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">moneyness</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Intrinsic:  $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_value</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Extrinsic:  $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extrinsic_value</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Breakeven:  $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">breakeven</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># Example</span>
<span class="n">call</span> <span class="o">=</span> <span class="n">OptionContract</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mf">5.50</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="s1">&#39;2025-03-21&#39;</span><span class="p">)</span>
<span class="n">call</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">put</span> <span class="o">=</span> <span class="n">OptionContract</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mf">3.20</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="s1">&#39;2025-03-21&#39;</span><span class="p">)</span>
<span class="n">put</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><h2>1.4 Payoff Diagrams</h2>
<p>The <strong>payoff diagram</strong> shows profit/loss at expiration across a range of stock prices.
This is the most fundamental visualisation in options trading.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">plot_payoff_diagram</span><span class="p">(</span><span class="n">options</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OptionContract</span><span class="p">],</span>
                       <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Options Payoff Diagram&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot payoff diagrams for one or more option contracts.</span>

<span class="sd">    Args:</span>
<span class="sd">        options: List of OptionContract instances</span>
<span class="sd">        title: Chart title</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">strikes</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">strike</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">options</span><span class="p">]</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">strikes</span><span class="p">)</span>
    <span class="n">price_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">center</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">center</span> <span class="o">*</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">price_range</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="n">payoffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">opt</span><span class="o">.</span><span class="n">payoff_at_expiry</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">price_range</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">opt</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">opt</span><span class="o">.</span><span class="n">option_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> K=$</span><span class="si">{</span><span class="n">opt</span><span class="o">.</span><span class="n">strike</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">price_range</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">+=</span> <span class="n">payoffs</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">price_range</span><span class="p">,</span> <span class="n">combined</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Combined&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">price_range</span><span class="p">,</span> <span class="n">combined</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">combined</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">price_range</span><span class="p">,</span> <span class="n">combined</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">combined</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Stock Price at Expiration ($)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Profit / Loss ($)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Plot call and put payoffs</span>
<span class="n">plot_payoff_diagram</span><span class="p">([</span><span class="n">call</span><span class="p">],</span> <span class="s1">&#39;AAPL Long Call Payoff&#39;</span><span class="p">)</span>
<span class="n">plot_payoff_diagram</span><span class="p">([</span><span class="n">put</span><span class="p">],</span> <span class="s1">&#39;AAPL Long Put Payoff&#39;</span><span class="p">)</span>
<span class="n">plot_payoff_diagram</span><span class="p">([</span><span class="n">call</span><span class="p">,</span> <span class="n">put</span><span class="p">],</span> <span class="s1">&#39;AAPL Long Call + Long Put (Straddle)&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 10.1: Options Payoff Calculator (Guided)</h3>
<p>Complete the function to calculate the payoff profile for a long call and a long put,
then determine the breakeven and max profit/loss.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.1: Options Payoff Calculator (Guided)</span>

<span class="k">def</span> <span class="nf">analyze_option_payoff</span><span class="p">(</span><span class="n">spot</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                          <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyse an option&#39;s payoff characteristics.</span>

<span class="sd">    Args:</span>
<span class="sd">        spot: Current stock price</span>
<span class="sd">        strike: Option strike price</span>
<span class="sd">        premium: Premium paid per share</span>
<span class="sd">        option_type: &#39;call&#39; or &#39;put&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with intrinsic, extrinsic, breakeven, max_profit, max_loss</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate intrinsic value</span>
    <span class="c1"># For a call: max(0, spot - strike), for a put: max(0, strike - spot)</span>
    <span class="n">intrinsic</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="c1"># TODO: Calculate extrinsic value</span>
    <span class="n">extrinsic</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="c1"># TODO: Calculate breakeven price</span>
    <span class="c1"># For a call: strike + premium, for a put: strike - premium</span>
    <span class="n">breakeven</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="c1"># TODO: Calculate max loss (for a long option, this is the premium)</span>
    <span class="n">max_loss</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="c1"># TODO: Calculate max profit</span>
    <span class="c1"># For a long call: theoretically unlimited, use float(&#39;inf&#39;)</span>
    <span class="c1"># For a long put: breakeven price (stock goes to 0)</span>
    <span class="n">max_profit</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;intrinsic&#39;</span><span class="p">:</span> <span class="n">intrinsic</span><span class="p">,</span>
        <span class="s1">&#39;extrinsic&#39;</span><span class="p">:</span> <span class="n">extrinsic</span><span class="p">,</span>
        <span class="s1">&#39;breakeven&#39;</span><span class="p">:</span> <span class="n">breakeven</span><span class="p">,</span>
        <span class="s1">&#39;max_loss&#39;</span><span class="p">:</span> <span class="n">max_loss</span><span class="p">,</span>
        <span class="s1">&#39;max_profit&#39;</span><span class="p">:</span> <span class="n">max_profit</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1"># Test (uncomment after completing):</span>
<span class="c1"># result = analyze_option_payoff(195, 190, 5.50, &#39;call&#39;)</span>
<span class="c1"># for k, v in result.items():</span>
<span class="c1">#     print(f&quot;  {k}: {v}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_option_payoff</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">premium</span><span class="p">,</span> <span class="n">option_type</span><span class="o">=</span><span class="s1">&#39;call&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
        <span class="n">intrinsic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">spot</span> <span class="o">-</span> <span class="n">strike</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">intrinsic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">strike</span> <span class="o">-</span> <span class="n">spot</span><span class="p">)</span>

    <span class="n">extrinsic</span> <span class="o">=</span> <span class="n">premium</span> <span class="o">-</span> <span class="n">intrinsic</span>

    <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
        <span class="n">breakeven</span> <span class="o">=</span> <span class="n">strike</span> <span class="o">+</span> <span class="n">premium</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">breakeven</span> <span class="o">=</span> <span class="n">strike</span> <span class="o">-</span> <span class="n">premium</span>

    <span class="n">max_loss</span> <span class="o">=</span> <span class="n">premium</span>

    <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
        <span class="n">max_profit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_profit</span> <span class="o">=</span> <span class="n">breakeven</span>  <span class="c1"># stock goes to 0</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;intrinsic&#39;</span><span class="p">:</span> <span class="n">intrinsic</span><span class="p">,</span>
        <span class="s1">&#39;extrinsic&#39;</span><span class="p">:</span> <span class="n">extrinsic</span><span class="p">,</span>
        <span class="s1">&#39;breakeven&#39;</span><span class="p">:</span> <span class="n">breakeven</span><span class="p">,</span>
        <span class="s1">&#39;max_loss&#39;</span><span class="p">:</span> <span class="n">max_loss</span><span class="p">,</span>
        <span class="s1">&#39;max_profit&#39;</span><span class="p">:</span> <span class="n">max_profit</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1"># Test</span>
<span class="k">for</span> <span class="n">otype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">analyze_option_payoff</span><span class="p">(</span><span class="mi">195</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mf">5.50</span><span class="p">,</span> <span class="n">otype</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">otype</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Option Analysis:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Options Chains</h1>
<p>An <strong>options chain</strong> is a listing of all available option contracts for a stock,
organised by expiration date and strike price. Understanding how to read chains
is essential for selecting the right contract.</p>
<h2>2.1 Reading Options Chains</h2>
<p>Key columns in an options chain:
- <strong>Strike:</strong> The strike price
- <strong>Last Price:</strong> Most recent trade price
- <strong>Bid/Ask:</strong> Current bid and ask prices (what you can sell/buy at)
- <strong>Volume:</strong> Number of contracts traded today
- <strong>Open Interest (OI):</strong> Total number of outstanding contracts
- <strong>Implied Volatility (IV):</strong> Market's expected future volatility</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">OptionsChainAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch and analyse options chains from yfinance.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        symbol: Ticker symbol</span>
<span class="sd">        ticker: yfinance Ticker object</span>
<span class="sd">        spot_price: Current stock price</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spot_price</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentPrice&#39;</span><span class="p">,</span>
                                   <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;regularMarketPrice&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expirations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Available expiration dates.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">options</span>

    <span class="k">def</span> <span class="nf">get_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch calls and puts for a given expiration.</span>

<span class="sd">        Args:</span>
<span class="sd">            expiration: Expiration date string</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (calls_df, puts_df)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">option_chain</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="n">calls</span><span class="p">,</span> <span class="n">chain</span><span class="o">.</span><span class="n">puts</span>

    <span class="k">def</span> <span class="nf">atm_strike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Find the at-the-money strike.&quot;&quot;&quot;</span>
        <span class="n">calls</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">calls</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_price</span>
        <span class="n">strikes</span> <span class="o">=</span> <span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">strikes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">strikes</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot_price</span><span class="p">))])</span>

    <span class="k">def</span> <span class="nf">find_nearest_expiration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_dte</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
                                <span class="n">max_dte</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find the nearest expiration within a DTE range.&quot;&quot;&quot;</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expirations</span><span class="p">:</span>
            <span class="n">exp_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="n">dte</span> <span class="o">=</span> <span class="p">(</span><span class="n">exp_date</span> <span class="o">-</span> <span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
            <span class="k">if</span> <span class="n">min_dte</span> <span class="o">&lt;=</span> <span class="n">dte</span> <span class="o">&lt;=</span> <span class="n">max_dte</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exp</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expirations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expirations</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">chain_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">num_strikes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarise the chain around ATM.</span>

<span class="sd">        Args:</span>
<span class="sd">            expiration: Expiration date</span>
<span class="sd">            num_strikes: Number of strikes above/below ATM</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with call and put data side-by-side</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">calls</span><span class="p">,</span> <span class="n">puts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">calls</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">atm_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atm_strike</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="n">all_strikes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">atm_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_strikes</span><span class="p">)),</span>
                      <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">all_strikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">atm_k</span><span class="p">))</span>
        <span class="n">nearby</span> <span class="o">=</span> <span class="n">all_strikes</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">atm_idx</span> <span class="o">-</span> <span class="n">num_strikes</span><span class="p">):</span>
                             <span class="n">atm_idx</span> <span class="o">+</span> <span class="n">num_strikes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nearby</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">calls</span><span class="p">[</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">puts</span><span class="p">[</span><span class="n">puts</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">c_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ask&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">p_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ask&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">c_oi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openInterest&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span>
                <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openInterest&#39;</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">p_oi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openInterest&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span>
                <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openInterest&#39;</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Call_Bid&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;Call_Ask&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ask&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;Call_Mid&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">c_mid</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;Call_Vol&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;Call_OI&#39;</span><span class="p">:</span> <span class="n">c_oi</span><span class="p">,</span>
                <span class="s1">&#39;Strike&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                <span class="s1">&#39;Put_Bid&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;Put_Ask&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ask&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;Put_Mid&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">p_mid</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;Put_Vol&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;Put_OI&#39;</span><span class="p">:</span> <span class="n">p_oi</span><span class="p">,</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>


<span class="c1"># Example</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">OptionsChainAnalyzer</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AAPL Spot: $</span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">spot_price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expirations: </span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">expirations</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">exp</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">find_nearest_expiration</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Using expiration: </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ATM Strike: $</span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">atm_strike</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">chain_summary</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Chain Summary:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chain analysis requires market data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 10.2: Options Chain Analyzer (Open-ended)</h3>
<p>Build a function that analyses an options chain and identifies the most liquid
contracts (highest volume and open interest).</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.2: Options Chain Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a function that:</span>
<span class="c1"># - Takes a symbol and expiration date</span>
<span class="c1"># - Fetches the full options chain</span>
<span class="c1"># - Identifies the top 5 most liquid calls and puts by volume</span>
<span class="c1"># - Calculates the put/call volume ratio</span>
<span class="c1"># - Finds the strike with the highest open interest (the &quot;max pain&quot; area)</span>
<span class="c1"># - Returns a dictionary with all findings</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_chain_liquidity</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">OptionsChainAnalyzer</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">calls</span><span class="p">,</span> <span class="n">puts</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>

    <span class="c1"># Top 5 most liquid calls</span>
    <span class="n">calls_sorted</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">)[</span>
        <span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">,</span> <span class="s1">&#39;lastPrice&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;openInterest&#39;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="c1"># Top 5 most liquid puts</span>
    <span class="n">puts_sorted</span> <span class="o">=</span> <span class="n">puts</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">)[</span>
        <span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">,</span> <span class="s1">&#39;lastPrice&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;openInterest&#39;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="c1"># Put/Call volume ratio</span>
    <span class="n">total_call_vol</span> <span class="o">=</span> <span class="n">calls</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_put_vol</span> <span class="o">=</span> <span class="n">puts</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">pc_ratio</span> <span class="o">=</span> <span class="n">total_put_vol</span> <span class="o">/</span> <span class="n">total_call_vol</span> <span class="k">if</span> <span class="n">total_call_vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># Max pain (strike with highest combined OI)</span>
    <span class="n">call_oi</span> <span class="o">=</span> <span class="n">calls</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;strike&#39;</span><span class="p">)[</span><span class="s1">&#39;openInterest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">put_oi</span> <span class="o">=</span> <span class="n">puts</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;strike&#39;</span><span class="p">)[</span><span class="s1">&#39;openInterest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">combined_oi</span> <span class="o">=</span> <span class="n">call_oi</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">put_oi</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">max_pain_strike</span> <span class="o">=</span> <span class="n">combined_oi</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
        <span class="s1">&#39;expiration&#39;</span><span class="p">:</span> <span class="n">expiration</span><span class="p">,</span>
        <span class="s1">&#39;top_calls&#39;</span><span class="p">:</span> <span class="n">calls_sorted</span><span class="p">,</span>
        <span class="s1">&#39;top_puts&#39;</span><span class="p">:</span> <span class="n">puts_sorted</span><span class="p">,</span>
        <span class="s1">&#39;total_call_volume&#39;</span><span class="p">:</span> <span class="n">total_call_vol</span><span class="p">,</span>
        <span class="s1">&#39;total_put_volume&#39;</span><span class="p">:</span> <span class="n">total_put_vol</span><span class="p">,</span>
        <span class="s1">&#39;put_call_ratio&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pc_ratio</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="s1">&#39;max_pain_strike&#39;</span><span class="p">:</span> <span class="n">max_pain_strike</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">OptionsChainAnalyzer</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">find_nearest_expiration</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">analyze_chain_liquidity</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Put/Call Ratio: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;put_call_ratio&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max Pain Strike: $</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;max_pain_strike&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top Calls:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;top_calls&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top Puts:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;top_puts&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Options Pricing</h1>
<h2>3.1 The Black-Scholes Model</h2>
<p>The <strong>Black-Scholes model</strong> is the foundation of modern options pricing. It prices
European-style options using five inputs:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Parameter</th>
<th>Symbol</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Stock Price</td>
<td>S</td>
<td>Current price of the underlying</td>
</tr>
<tr>
<td>Strike Price</td>
<td>K</td>
<td>Exercise price</td>
</tr>
<tr>
<td>Time to Expiry</td>
<td>T</td>
<td>Years until expiration</td>
</tr>
<tr>
<td>Risk-Free Rate</td>
<td>r</td>
<td>Annualised risk-free interest rate</td>
</tr>
<tr>
<td>Volatility</td>
<td>œÉ</td>
<td>Annualised standard deviation of returns</td>
</tr>
</tbody>
</table></div>
<p><strong>Black-Scholes Formulas:</strong></p>
<ul>
<li>Call: <code>C = S¬∑N(d‚ÇÅ) - K¬∑e^(-rT)¬∑N(d‚ÇÇ)</code></li>
<li>Put: <code>P = K¬∑e^(-rT)¬∑N(-d‚ÇÇ) - S¬∑N(-d‚ÇÅ)</code></li>
</ul>
<p>Where:
- <code>d‚ÇÅ = [ln(S/K) + (r + œÉ¬≤/2)¬∑T] / (œÉ¬∑‚àöT)</code>
- <code>d‚ÇÇ = d‚ÇÅ - œÉ¬∑‚àöT</code>
- <code>N(x)</code> = standard normal cumulative distribution function</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">BlackScholes</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Black-Scholes option pricing model.</span>

<span class="sd">    Provides static methods for pricing European calls and puts.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">d1</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate d1 parameter.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S</span> <span class="o">/</span> <span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">d2</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate d2 parameter.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">-</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">call_price</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                   <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Price a European call option.</span>

<span class="sd">        Args:</span>
<span class="sd">            S: Stock price</span>
<span class="sd">            K: Strike price</span>
<span class="sd">            T: Time to expiration (years)</span>
<span class="sd">            r: Risk-free rate</span>
<span class="sd">            sigma: Volatility (annualised)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Call option price</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">d2</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">put_price</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Price a European put option.&quot;&quot;&quot;</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">d2</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d2</span><span class="p">)</span> <span class="o">-</span> <span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d1</span><span class="p">)</span>


<span class="c1"># Example: Price AAPL options</span>
<span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span>

<span class="n">call_px</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">call_price</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
<span class="n">put_px</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">put_price</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Black-Scholes Option Prices (S=$</span><span class="si">{</span><span class="n">S</span><span class="si">}</span><span class="s2">, K=$</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s2">, T=</span><span class="si">{</span><span class="n">T</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">y, œÉ=</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Call: $</span><span class="si">{</span><span class="n">call_px</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Put:  $</span><span class="si">{</span><span class="n">put_px</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.2 Implied Volatility</h2>
<p><strong>Implied Volatility (IV)</strong> is the volatility value that, when plugged into the
Black-Scholes formula, produces the observed market price. It is extracted using
numerical methods (Newton's method).</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">implied_volatility</span><span class="p">(</span><span class="n">market_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span>
                       <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate implied volatility using Newton&#39;s method.</span>

<span class="sd">    Args:</span>
<span class="sd">        market_price: Observed option price</span>
<span class="sd">        S, K, T, r: Black-Scholes inputs</span>
<span class="sd">        option_type: &#39;call&#39; or &#39;put&#39;</span>
<span class="sd">        tol: Convergence tolerance</span>
<span class="sd">        max_iter: Maximum iterations</span>

<span class="sd">    Returns:</span>
<span class="sd">        Implied volatility (annualised)</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If convergence fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># initial guess</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">call_price</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">put_price</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="c1"># Vega (derivative of price w.r.t. sigma)</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">vega</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vega</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="n">price</span> <span class="o">-</span> <span class="n">market_price</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sigma</span>

        <span class="n">sigma</span> <span class="o">-=</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">vega</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IV did not converge (last sigma=</span><span class="si">{</span><span class="n">sigma</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>


<span class="c1"># Example</span>
<span class="n">market_call</span> <span class="o">=</span> <span class="mf">7.50</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="n">implied_volatility</span><span class="p">(</span><span class="n">market_call</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Market call price: $</span><span class="si">{</span><span class="n">market_call</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Implied Volatility: </span><span class="si">{</span><span class="n">iv</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>3.3 Put-Call Parity</h2>
<p><strong>Put-call parity</strong> is a fundamental relationship between call and put prices:</p>
<p><code>C - P = S - K¬∑e^(-rT)</code></p>
<p>If this equality is violated, an arbitrage opportunity exists.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">check_put_call_parity</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                          <span class="n">call_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">put_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check put-call parity: C - P = S - K*e^(-rT).</span>

<span class="sd">    Args:</span>
<span class="sd">        S, K, T, r: Market parameters</span>
<span class="sd">        call_price: Observed call price</span>
<span class="sd">        put_price: Observed put price</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with parity analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lhs</span> <span class="o">=</span> <span class="n">call_price</span> <span class="o">-</span> <span class="n">put_price</span>
    <span class="n">rhs</span> <span class="o">=</span> <span class="n">S</span> <span class="o">-</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lhs</span> <span class="o">-</span> <span class="n">rhs</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;C - P&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s1">&#39;S - Ke^(-rT)&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s1">&#39;Difference&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="s1">&#39;Parity Holds&#39;</span><span class="p">:</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mf">0.50</span><span class="p">,</span>
    <span class="p">}</span>


<span class="c1"># Example</span>
<span class="n">parity</span> <span class="o">=</span> <span class="n">check_put_call_parity</span><span class="p">(</span><span class="mi">195</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">call_px</span><span class="p">,</span> <span class="n">put_px</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Put-Call Parity Check:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parity</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 10.3: Options Pricer (Guided)</h3>
<p>Complete the function that prices an option using Black-Scholes and compares it
to the market price to find mispricing.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.3: Options Pricer (Guided)</span>

<span class="k">def</span> <span class="nf">price_and_compare</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">market_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Price an option with Black-Scholes and compare to market.</span>

<span class="sd">    Args:</span>
<span class="sd">        S, K, T, r: Market parameters</span>
<span class="sd">        market_price: Observed market price</span>
<span class="sd">        option_type: &#39;call&#39; or &#39;put&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with theoretical price, IV, and mispricing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate theoretical price using historical vol of 0.25</span>
    <span class="c1"># Hint: Use BlackScholes.call_price or BlackScholes.put_price</span>
    <span class="n">theo_price</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="c1"># TODO: Calculate implied volatility from market price</span>
    <span class="c1"># Hint: Use the implied_volatility() function</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="c1"># TODO: Calculate mispricing (market_price - theo_price)</span>
    <span class="n">mispricing</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="c1"># TODO: Determine if the option is overpriced or underpriced</span>
    <span class="c1"># based on the sign of mispricing</span>
    <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;theo_price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">theo_price</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">theo_price</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;market_price&#39;</span><span class="p">:</span> <span class="n">market_price</span><span class="p">,</span>
        <span class="s1">&#39;iv&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">iv</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">iv</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;mispricing&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">mispricing</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">mispricing</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1"># Test (uncomment after completing):</span>
<span class="c1"># result = price_and_compare(195, 190, 30/365, 0.05, 7.50, &#39;call&#39;)</span>
<span class="c1"># for k, v in result.items():</span>
<span class="c1">#     print(f&quot;  {k}: {v}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">price_and_compare</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">market_price</span><span class="p">,</span> <span class="n">option_type</span><span class="o">=</span><span class="s1">&#39;call&#39;</span><span class="p">):</span>
    <span class="n">hist_vol</span> <span class="o">=</span> <span class="mf">0.25</span>

    <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
        <span class="n">theo_price</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">call_price</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">hist_vol</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">theo_price</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">put_price</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">hist_vol</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="n">implied_volatility</span><span class="p">(</span><span class="n">market_price</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">option_type</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">mispricing</span> <span class="o">=</span> <span class="n">market_price</span> <span class="o">-</span> <span class="n">theo_price</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;Overpriced&#39;</span> <span class="k">if</span> <span class="n">mispricing</span> <span class="o">&gt;</span> <span class="mf">0.10</span> <span class="k">else</span> <span class="p">(</span>
        <span class="s1">&#39;Underpriced&#39;</span> <span class="k">if</span> <span class="n">mispricing</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.10</span> <span class="k">else</span> <span class="s1">&#39;Fair&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;theo_price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">theo_price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;market_price&#39;</span><span class="p">:</span> <span class="n">market_price</span><span class="p">,</span>
        <span class="s1">&#39;iv&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">iv</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">iv</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;mispricing&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">mispricing</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
    <span class="p">}</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">price_and_compare</span><span class="p">(</span><span class="mi">195</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">7.50</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pricing Analysis:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: The Greeks</h1>
<p>The <strong>Greeks</strong> measure the sensitivity of an option's price to changes in its
underlying parameters. They are essential for risk management.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Greek</th>
<th>Measures</th>
<th>Range (Calls)</th>
<th>Range (Puts)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Delta (Œî)</strong></td>
<td>Price sensitivity to stock move</td>
<td>0 to +1</td>
<td>-1 to 0</td>
</tr>
<tr>
<td><strong>Gamma (Œì)</strong></td>
<td>Rate of change of delta</td>
<td>Always positive</td>
<td>Always positive</td>
</tr>
<tr>
<td><strong>Theta (Œò)</strong></td>
<td>Time decay per day</td>
<td>Usually negative</td>
<td>Usually negative</td>
</tr>
<tr>
<td><strong>Vega (ŒΩ)</strong></td>
<td>Sensitivity to volatility</td>
<td>Always positive</td>
<td>Always positive</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">GreeksCalculator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate option Greeks using the Black-Scholes model.</span>

<span class="sd">    All methods are static for easy use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
              <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Delta: dC/dS or dP/dS.&quot;&quot;&quot;</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">gamma</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
              <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gamma: d¬≤C/dS¬≤ (same for calls and puts).&quot;&quot;&quot;</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">theta</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
              <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Theta: dC/dT (daily, negative = decay).&quot;&quot;&quot;</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">d2</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="n">term1</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="n">term2</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">term2</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d2</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">365</span>  <span class="c1"># daily theta</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">vega</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
             <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Vega: dC/dœÉ (per 1% change in vol).&quot;&quot;&quot;</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">BlackScholes</span><span class="o">.</span><span class="n">d1</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">all_greeks</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                   <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate all Greeks at once.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">delta</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">option_type</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
            <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
            <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">option_type</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
            <span class="s1">&#39;vega&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">vega</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">}</span>


<span class="c1"># Example: Calculate Greeks</span>
<span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Call Greeks:&quot;</span><span class="p">)</span>
<span class="n">call_greeks</span> <span class="o">=</span> <span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">all_greeks</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">call_greeks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">&gt;8.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Put Greeks:&quot;</span><span class="p">)</span>
<span class="n">put_greeks</span> <span class="o">=</span> <span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">all_greeks</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">put_greeks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">:</span><span class="s2">&gt;6</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">&gt;8.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h2>4.1 Visualising the Greeks</h2>
<p>Let us see how each Greek changes across a range of stock prices.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">plot_greeks</span><span class="p">(</span><span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Plot all four Greeks across stock prices.&quot;&quot;&quot;</span>
    <span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">K</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">K</span> <span class="o">*</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Option Greeks (K=$</span><span class="si">{</span><span class="n">K</span><span class="si">}</span><span class="s1">, T=</span><span class="si">{</span><span class="n">T</span><span class="o">*</span><span class="mi">365</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">d, œÉ=</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="c1"># Delta</span>
    <span class="n">call_d</span> <span class="o">=</span> <span class="p">[</span><span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">delta</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">]</span>
    <span class="n">put_d</span> <span class="o">=</span> <span class="p">[</span><span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">delta</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">call_d</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Call Delta&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">put_d</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Put Delta&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Delta&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Gamma</span>
    <span class="n">gamma_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">gamma_vals</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Gamma&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Theta</span>
    <span class="n">call_t</span> <span class="o">=</span> <span class="p">[</span><span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">]</span>
    <span class="n">put_t</span> <span class="o">=</span> <span class="p">[</span><span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">call_t</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Call Theta&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">put_t</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Put Theta&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Theta (daily)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Vega</span>
    <span class="n">vega_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">vega</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">vega_vals</span><span class="p">,</span> <span class="s1">&#39;m-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Vega (per 1% vol change)&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Stock Price ($)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">plot_greeks</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 10.4: Greeks Calculator (Guided)</h3>
<p>Complete the function to calculate Greeks across multiple strikes and display them.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.4: Greeks Calculator (Guided)</span>

<span class="k">def</span> <span class="nf">greeks_table</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">strikes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a table of Greeks for multiple strikes.</span>

<span class="sd">    Args:</span>
<span class="sd">        S: Current stock price</span>
<span class="sd">        strikes: List of strike prices</span>
<span class="sd">        T: Time to expiration (years)</span>
<span class="sd">        r: Risk-free rate</span>
<span class="sd">        sigma: Volatility</span>
<span class="sd">        option_type: &#39;call&#39; or &#39;put&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with Delta, Gamma, Theta, Vega for each strike</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">strikes</span><span class="p">:</span>
        <span class="c1"># TODO: Calculate delta using GreeksCalculator.delta(...)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

        <span class="c1"># TODO: Calculate gamma using GreeksCalculator.gamma(...)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

        <span class="c1"># TODO: Calculate theta using GreeksCalculator.theta(...)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

        <span class="c1"># TODO: Calculate vega using GreeksCalculator.vega(...)</span>
        <span class="n">vega</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

        <span class="c1"># TODO: Determine moneyness: &#39;ITM&#39;, &#39;ATM&#39;, or &#39;OTM&#39;</span>
        <span class="c1"># ATM if abs(S - k) / S &lt; 0.01, then for calls ITM if S &gt; K</span>
        <span class="n">moneyness</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Strike&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;Moneyness&#39;</span><span class="p">:</span> <span class="n">moneyness</span><span class="p">,</span>
            <span class="s1">&#39;Delta&#39;</span><span class="p">:</span> <span class="n">delta</span><span class="p">,</span> <span class="s1">&#39;Gamma&#39;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">,</span>
            <span class="s1">&#39;Theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s1">&#39;Vega&#39;</span><span class="p">:</span> <span class="n">vega</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

<span class="c1"># Test (uncomment after completing):</span>
<span class="c1"># strikes = [175, 180, 185, 190, 195, 200, 205]</span>
<span class="c1"># table = greeks_table(190, strikes, 30/365, 0.05, 0.25, &#39;call&#39;)</span>
<span class="c1"># print(table.to_string(index=False))</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">greeks_table</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">strikes</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">option_type</span><span class="o">=</span><span class="s1">&#39;call&#39;</span><span class="p">):</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">strikes</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">delta</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">option_type</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">theta</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">option_type</span><span class="p">)</span>
        <span class="n">vega</span> <span class="o">=</span> <span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">vega</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">S</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">S</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">moneyness</span> <span class="o">=</span> <span class="s1">&#39;ATM&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span> <span class="ow">and</span> <span class="n">S</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;put&#39;</span> <span class="ow">and</span> <span class="n">S</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">):</span>
            <span class="n">moneyness</span> <span class="o">=</span> <span class="s1">&#39;ITM&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">moneyness</span> <span class="o">=</span> <span class="s1">&#39;OTM&#39;</span>

        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Strike&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;Moneyness&#39;</span><span class="p">:</span> <span class="n">moneyness</span><span class="p">,</span>
            <span class="s1">&#39;Delta&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;Gamma&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="s1">&#39;Theta&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;Vega&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">vega</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

<span class="n">strikes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">175</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">205</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Call Greeks Table:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">greeks_table</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="n">strikes</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Put Greeks Table:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">greeks_table</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="n">strikes</span><span class="p">,</span> <span class="mi">30</span><span class="o">/</span><span class="mi">365</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 10.5: Implied Volatility Surface (Open-ended)</h3>
<p>Build a function that extracts the IV smile/skew from live options data.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.5: IV Smile Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a function that:</span>
<span class="c1"># - Takes a symbol and expiration date</span>
<span class="c1"># - Fetches the options chain and calculates IV for each strike</span>
<span class="c1"># - Uses the implied_volatility() function on call mid-prices</span>
<span class="c1"># - Creates a plot showing IV (y-axis) vs Strike (x-axis) ‚Äî the &quot;IV smile&quot;</span>
<span class="c1"># - Marks the ATM strike on the plot</span>
<span class="c1"># - Returns a DataFrame with Strike, IV, and Moneyness columns</span>
<span class="c1">#</span>
<span class="c1"># Expected output: A characteristic &quot;smile&quot; or &quot;skew&quot; shape where</span>
<span class="c1"># OTM puts (low strikes) have higher IV than ATM options</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">iv_smile</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
             <span class="n">num_strikes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">analyzer</span> <span class="o">=</span> <span class="n">OptionsChainAnalyzer</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">spot_price</span>
    <span class="n">calls</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">calls</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="n">exp_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">expiration</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">exp_date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.0</span>
    <span class="n">atm_k</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">atm_strike</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
    <span class="n">all_strikes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">atm_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_strikes</span><span class="p">)),</span>
                  <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">all_strikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">atm_k</span><span class="p">))</span>
    <span class="n">nearby</span> <span class="o">=</span> <span class="n">all_strikes</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">atm_idx</span> <span class="o">-</span> <span class="n">num_strikes</span><span class="p">):</span>
                         <span class="n">atm_idx</span> <span class="o">+</span> <span class="n">num_strikes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nearby</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">calls</span><span class="p">[</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">mid</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">iv</span> <span class="o">=</span> <span class="n">implied_volatility</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Strike&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">iv</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;Moneyness%&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">k</span> <span class="o">-</span> <span class="n">S</span><span class="p">)</span> <span class="o">/</span> <span class="n">S</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Strike&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;IV&#39;</span><span class="p">],</span> <span class="s1">&#39;bo-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">atm_k</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ATM $</span><span class="si">{</span><span class="n">atm_k</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Strike Price ($)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Implied Volatility (%)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> IV Smile (exp: </span><span class="si">{</span><span class="n">expiration</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">OptionsChainAnalyzer</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">find_nearest_expiration</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
        <span class="n">smile_df</span> <span class="o">=</span> <span class="n">iv_smile</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">smile_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 10.6: Complete Options Analysis Report (Open-ended)</h3>
<p>Combine everything you have learned to build a comprehensive options analysis
for a single stock.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 10.6: Options Analysis Report (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a function that, given a symbol, produces a complete analysis:</span>
<span class="c1">#</span>
<span class="c1"># 1. Fetch the stock price and nearest monthly expiration</span>
<span class="c1"># 2. Display the ATM call and put with:</span>
<span class="c1">#    - Market price (mid of bid/ask)</span>
<span class="c1">#    - Implied volatility</span>
<span class="c1">#    - All four Greeks</span>
<span class="c1">#    - Intrinsic and extrinsic value breakdown</span>
<span class="c1"># 3. Check put-call parity for the ATM strike</span>
<span class="c1"># 4. Plot the payoff diagram for both ATM call and ATM put</span>
<span class="c1"># 5. Return a summary dictionary with all key metrics</span>
<span class="c1">#</span>
<span class="c1"># This is your chance to combine OptionContract, BlackScholes,</span>
<span class="c1"># GreeksCalculator, implied_volatility, and check_put_call_parity.</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">full_options_report</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">OptionsChainAnalyzer</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">spot_price</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">find_nearest_expiration</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">exp</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No suitable expiration found for </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">calls</span><span class="p">,</span> <span class="n">puts</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calls</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">puts</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">atm_k</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">atm_strike</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
    <span class="n">exp_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">exp_date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.0</span>

    <span class="n">c_row</span> <span class="o">=</span> <span class="n">calls</span><span class="p">[</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">atm_k</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">p_row</span> <span class="o">=</span> <span class="n">puts</span><span class="p">[</span><span class="n">puts</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">atm_k</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">c_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_row</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">c_row</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">p_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_row</span><span class="p">[</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">p_row</span><span class="p">[</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">c_iv</span> <span class="o">=</span> <span class="n">implied_volatility</span><span class="p">(</span><span class="n">c_mid</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">atm_k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">c_iv</span> <span class="o">=</span> <span class="mf">0.25</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">p_iv</span> <span class="o">=</span> <span class="n">implied_volatility</span><span class="p">(</span><span class="n">p_mid</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">atm_k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">p_iv</span> <span class="o">=</span> <span class="mf">0.25</span>

    <span class="n">c_greeks</span> <span class="o">=</span> <span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">all_greeks</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">atm_k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c_iv</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
    <span class="n">p_greeks</span> <span class="o">=</span> <span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">all_greeks</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">atm_k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p_iv</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">)</span>
    <span class="n">c_intrinsic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">S</span> <span class="o">-</span> <span class="n">atm_k</span><span class="p">)</span>
    <span class="n">p_intrinsic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">atm_k</span> <span class="o">-</span> <span class="n">S</span><span class="p">)</span>
    <span class="n">parity</span> <span class="o">=</span> <span class="n">check_put_call_parity</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">atm_k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c_mid</span><span class="p">,</span> <span class="n">p_mid</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OPTIONS REPORT: </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Stock Price:    $</span><span class="si">{</span><span class="n">S</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ATM Strike:     $</span><span class="si">{</span><span class="n">atm_k</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expiration:     </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">T</span><span class="o">*</span><span class="mi">365</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> DTE)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;CALL&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;PUT&#39;</span><span class="si">:</span><span class="s2">&gt;12s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">44</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="s1">&#39;Market Price&#39;</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">c_mid</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">  $</span><span class="si">{</span><span class="n">p_mid</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="s1">&#39;Implied Vol&#39;</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">c_iv</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.1f</span><span class="si">}</span><span class="s2">%  </span><span class="si">{</span><span class="n">p_iv</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;10.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="s1">&#39;Intrinsic&#39;</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">c_intrinsic</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">  $</span><span class="si">{</span><span class="n">p_intrinsic</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="s1">&#39;Extrinsic&#39;</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="n">c_mid</span><span class="o">-</span><span class="n">c_intrinsic</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">  $</span><span class="si">{</span><span class="n">p_mid</span><span class="o">-</span><span class="n">p_intrinsic</span><span class="si">:</span><span class="s2">&gt;10.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;vega&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">g</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">c_greeks</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.4f</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">p_greeks</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;10.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Put-Call Parity: diff=$</span><span class="si">{</span><span class="n">parity</span><span class="p">[</span><span class="s1">&#39;Difference&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">  &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;HOLDS&#39;</span> <span class="k">if</span> <span class="n">parity</span><span class="p">[</span><span class="s1">&#39;Parity Holds&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;VIOLATED&#39;</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="n">call_opt</span> <span class="o">=</span> <span class="n">OptionContract</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">atm_k</span><span class="p">,</span> <span class="n">c_mid</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
    <span class="n">put_opt</span> <span class="o">=</span> <span class="n">OptionContract</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">atm_k</span><span class="p">,</span> <span class="n">p_mid</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>
    <span class="n">plot_payoff_diagram</span><span class="p">([</span><span class="n">call_opt</span><span class="p">,</span> <span class="n">put_opt</span><span class="p">],</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> ATM Call + Put Payoffs (exp </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;spot&#39;</span><span class="p">:</span> <span class="n">S</span><span class="p">,</span> <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="n">atm_k</span><span class="p">,</span>
        <span class="s1">&#39;call_iv&#39;</span><span class="p">:</span> <span class="n">c_iv</span><span class="p">,</span> <span class="s1">&#39;put_iv&#39;</span><span class="p">:</span> <span class="n">p_iv</span><span class="p">,</span>
        <span class="s1">&#39;call_greeks&#39;</span><span class="p">:</span> <span class="n">c_greeks</span><span class="p">,</span> <span class="s1">&#39;put_greeks&#39;</span><span class="p">:</span> <span class="n">p_greeks</span><span class="p">,</span>
        <span class="s1">&#39;parity&#39;</span><span class="p">:</span> <span class="n">parity</span>
    <span class="p">}</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">full_options_report</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h1>Module Project: Options Analytics Dashboard</h1>
<p>Build a comprehensive <code>OptionsAnalyticsDashboard</code> class that combines all concepts
from this module into a single, reusable tool.</p>
<p><strong>Requirements:</strong>
1. Fetch live options data for any stock
2. Calculate BS theoretical prices and implied volatility
3. Compute all Greeks for the chain
4. Generate visualisations (payoff diagrams, IV smile, Greeks)
5. Check put-call parity across the chain</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">OptionsAnalyticsDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Comprehensive options analytics dashboard.</span>

<span class="sd">    Combines chain analysis, Black-Scholes pricing, implied volatility,</span>
<span class="sd">    Greeks calculation, and visualisation into one unified interface.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        symbol: Stock ticker</span>
<span class="sd">        r: Risk-free rate</span>
<span class="sd">        analyzer: OptionsChainAnalyzer instance</span>
<span class="sd">        spot: Current stock price</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">OptionsChainAnalyzer</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">spot_price</span>

    <span class="k">def</span> <span class="nf">_dte</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate time to expiration in years.&quot;&quot;&quot;</span>
        <span class="n">exp_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">expiration</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">days</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">exp_date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">days</span> <span class="o">/</span> <span class="mf">365.0</span>

    <span class="k">def</span> <span class="nf">chain_with_greeks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">num_strikes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produce a chain summary enriched with Greeks and IV.</span>

<span class="sd">        Args:</span>
<span class="sd">            expiration: Expiration date</span>
<span class="sd">            num_strikes: Number of strikes above/below ATM</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with pricing, Greeks, and IV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">calls</span><span class="p">,</span> <span class="n">puts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">calls</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dte</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="n">atm_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">atm_strike</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="n">all_strikes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">atm_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_strikes</span><span class="p">)),</span>
                      <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">all_strikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">atm_k</span><span class="p">))</span>
        <span class="n">nearby</span> <span class="o">=</span> <span class="n">all_strikes</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">atm_idx</span> <span class="o">-</span> <span class="n">num_strikes</span><span class="p">):</span>
                             <span class="n">atm_idx</span> <span class="o">+</span> <span class="n">num_strikes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nearby</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">calls</span><span class="p">[</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">c_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ask&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">c_mid</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">c_iv</span> <span class="o">=</span> <span class="n">implied_volatility</span><span class="p">(</span><span class="n">c_mid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">ZeroDivisionError</span><span class="p">):</span>
                <span class="n">c_iv</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;impliedVolatility&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>

            <span class="n">greeks</span> <span class="o">=</span> <span class="n">GreeksCalculator</span><span class="o">.</span><span class="n">all_greeks</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
                <span class="n">c_iv</span> <span class="k">if</span> <span class="n">c_iv</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Strike&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                <span class="s1">&#39;Call_Mid&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">c_mid</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;IV%&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">c_iv</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">c_iv</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;Delta&#39;</span><span class="p">:</span> <span class="n">greeks</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Gamma&#39;</span><span class="p">:</span> <span class="n">greeks</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Theta&#39;</span><span class="p">:</span> <span class="n">greeks</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">],</span>
                <span class="s1">&#39;Vega&#39;</span><span class="p">:</span> <span class="n">greeks</span><span class="p">[</span><span class="s1">&#39;vega&#39;</span><span class="p">],</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_iv_smile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_strikes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot the implied volatility smile for calls.&quot;&quot;&quot;</span>
        <span class="n">calls</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">calls</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dte</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="n">atm_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">atm_strike</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="n">all_strikes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">atm_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_strikes</span><span class="p">)),</span>
                      <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">all_strikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">atm_k</span><span class="p">))</span>
        <span class="n">nearby</span> <span class="o">=</span> <span class="n">all_strikes</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">atm_idx</span> <span class="o">-</span> <span class="n">num_strikes</span><span class="p">):</span>
                             <span class="n">atm_idx</span> <span class="o">+</span> <span class="n">num_strikes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">ivs</span><span class="p">,</span> <span class="n">valid_strikes</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nearby</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">calls</span><span class="p">[</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">mid</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">iv</span> <span class="o">=</span> <span class="n">implied_volatility</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
                <span class="n">ivs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iv</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                <span class="n">valid_strikes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ivs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not calculate IV for any strikes.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">valid_strikes</span><span class="p">,</span> <span class="n">ivs</span><span class="p">,</span> <span class="s1">&#39;bo-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">atm_k</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                   <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ATM $</span><span class="si">{</span><span class="n">atm_k</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Strike Price ($)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Implied Volatility (%)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> IV Smile (exp: </span><span class="si">{</span><span class="n">expiration</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_greeks_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot Greeks across strikes for the given expiration.&quot;&quot;&quot;</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_with_greeks</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">summary</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> Greeks by Strike (exp: </span><span class="si">{</span><span class="n">expiration</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;Delta&#39;</span><span class="p">,</span> <span class="s1">&#39;Gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;Theta&#39;</span><span class="p">,</span> <span class="s1">&#39;Vega&#39;</span><span class="p">],</span>
                    <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">])):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;Strike&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="n">summary</span><span class="p">[</span><span class="n">col</span><span class="p">],</span>
                   <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Strike&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">parity_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check put-call parity across strikes near ATM.&quot;&quot;&quot;</span>
        <span class="n">calls</span><span class="p">,</span> <span class="n">puts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">calls</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">puts</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dte</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="n">atm_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">atm_strike</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="n">all_strikes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">atm_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_strikes</span><span class="p">)),</span>
                      <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">all_strikes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">atm_k</span><span class="p">))</span>
        <span class="n">nearby</span> <span class="o">=</span> <span class="n">all_strikes</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">atm_idx</span> <span class="o">-</span> <span class="mi">3</span><span class="p">):</span> <span class="n">atm_idx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nearby</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">calls</span><span class="p">[</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">puts</span><span class="p">[</span><span class="n">puts</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">c_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">p_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;bid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ask&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">c_mid</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">p_mid</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">check_put_call_parity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">c_mid</span><span class="p">,</span> <span class="n">p_mid</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Strike&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="n">result</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a full options analytics report.</span>

<span class="sd">        Args:</span>
<span class="sd">            expiration: Expiration date; auto-selects nearest if None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">expiration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expiration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">find_nearest_expiration</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expiration</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No suitable expiration found for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dte</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OPTIONS ANALYTICS DASHBOARD: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Spot Price:    $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">spot</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Expiration:    </span><span class="si">{</span><span class="n">expiration</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">T</span><span class="o">*</span><span class="mi">365</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> DTE)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Risk-Free Rate: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Chain with Greeks ---&quot;</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_with_greeks</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">summary</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Put-Call Parity ---&quot;</span><span class="p">)</span>
        <span class="n">parity_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parity_check</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parity_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">parity_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_iv_smile</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_greeks_surface</span><span class="p">(</span><span class="n">expiration</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run the dashboard</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">dashboard</span> <span class="o">=</span> <span class="n">OptionsAnalyticsDashboard</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">dashboard</span><span class="o">.</span><span class="n">full_report</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dashboard requires market data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>Options Basics:</strong> A call gives the right to buy; a put gives the right to sell. Premium = Intrinsic + Extrinsic value</li>
<li><strong>Options Chains:</strong> Always check bid-ask spread and open interest before trading. Wide spreads and low OI mean poor liquidity</li>
<li><strong>Black-Scholes Model:</strong> Prices European options using five inputs (S, K, T, r, œÉ). Foundation for all options pricing</li>
<li><strong>Implied Volatility:</strong> Extracted from market prices via Newton's method. Represents the market's volatility expectation</li>
<li><strong>Put-Call Parity:</strong> C - P = S - K¬∑e^(-rT). Violations imply arbitrage opportunities</li>
<li><strong>The Greeks:</strong></li>
<li><strong>Delta</strong> measures directional exposure (how much the option moves per $1 stock move)</li>
<li><strong>Gamma</strong> measures delta's rate of change (risk acceleration near ATM)</li>
<li><strong>Theta</strong> measures time decay (options lose value daily, accelerating near expiration)</li>
<li><strong>Vega</strong> measures volatility sensitivity (higher IV = higher premium)</li>
<li><strong>Practical Tips:</strong> ATM options have the highest gamma and vega; deep ITM options behave like stock; OTM options are pure time value bets</li>
</ol>
<hr />
<p><strong>Next: Module 11 ‚Äî Options Strategies</strong> (covered calls, spreads, iron condors, and more)</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="11"><div class="md-cell module-header"><h1>Module 11: Options Strategies</h1>
<h2>Part 3: Options Trading</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ol>
<li>Implement basic strategies: long calls/puts, covered calls, protective puts</li>
<li>Build and analyse vertical spreads (bull call, bear put, credit spreads)</li>
<li>Construct multi-leg strategies: iron condors and butterflies</li>
<li>Trade volatility with straddles, strangles, and IV rank strategies</li>
<li>Build an options strategy screener combining all techniques</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 11: Options Strategies&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: Basic Strategies</h1>
<h2>1.1 Strategy Building Blocks</h2>
<p>Every options strategy is built from combinations of <strong>legs</strong> ‚Äî individual option
positions (long/short, call/put). The four building blocks:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Leg</th>
<th>View</th>
<th>Max Profit</th>
<th>Max Loss</th>
</tr>
</thead>
<tbody>
<tr>
<td>Long Call</td>
<td>Bullish</td>
<td>Unlimited</td>
<td>Premium</td>
</tr>
<tr>
<td>Short Call</td>
<td>Bearish/Neutral</td>
<td>Premium</td>
<td>Unlimited</td>
</tr>
<tr>
<td>Long Put</td>
<td>Bearish</td>
<td>Strike - Premium</td>
<td>Premium</td>
</tr>
<tr>
<td>Short Put</td>
<td>Bullish/Neutral</td>
<td>Premium</td>
<td>Strike - Premium</td>
</tr>
</tbody>
</table></div>
<h2>1.2 Core Strategies</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Strategy</th>
<th>Legs</th>
<th>Outlook</th>
<th>When to Use</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Long Call</strong></td>
<td>Buy call</td>
<td>Bullish</td>
<td>Expect significant upside</td>
</tr>
<tr>
<td><strong>Long Put</strong></td>
<td>Buy put</td>
<td>Bearish</td>
<td>Expect significant downside</td>
</tr>
<tr>
<td><strong>Covered Call</strong></td>
<td>Own stock + sell call</td>
<td>Neutral/mild bull</td>
<td>Generate income on holdings</td>
</tr>
<tr>
<td><strong>Protective Put</strong></td>
<td>Own stock + buy put</td>
<td>Bullish with protection</td>
<td>Insure against downside</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Leg</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A single option leg in a strategy.&quot;&quot;&quot;</span>
    <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span>   <span class="c1"># &#39;call&#39; or &#39;put&#39;</span>
    <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">premium</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">position</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># &#39;long&#39; or &#39;short&#39;</span>
    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_long</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span>

    <span class="k">def</span> <span class="nf">payoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate payoff at a given underlying price.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="n">intrinsic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intrinsic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike</span> <span class="o">-</span> <span class="n">price</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_long</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">intrinsic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">premium</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">premium</span> <span class="o">-</span> <span class="n">intrinsic</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">x &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">option_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> K=$</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">strike</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;@$</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">premium</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Strategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Options strategy composed of one or more legs.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name: Strategy name</span>
<span class="sd">        underlying_price: Current stock price</span>
<span class="sd">        legs: List of Leg instances</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">underlying_price</span> <span class="o">=</span> <span class="n">underlying_price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Leg</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_leg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leg</span><span class="p">:</span> <span class="n">Leg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a leg to the strategy. Returns self for chaining.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">payoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Total strategy payoff at a given underlying price.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">leg</span><span class="o">.</span><span class="n">payoff</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">legs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">net_premium</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Net premium paid (positive) or received (negative).&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">legs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">leg</span><span class="o">.</span><span class="n">is_long</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">-=</span> <span class="n">leg</span><span class="o">.</span><span class="n">premium</span> <span class="o">*</span> <span class="n">leg</span><span class="o">.</span><span class="n">quantity</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">leg</span><span class="o">.</span><span class="n">premium</span> <span class="o">*</span> <span class="n">leg</span><span class="o">.</span><span class="n">quantity</span>
        <span class="k">return</span> <span class="n">total</span>

    <span class="k">def</span> <span class="nf">max_profit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Estimate max profit across a price range.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">underlying_price</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">underlying_price</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">payoff</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">max_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Estimate max loss across a price range.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">underlying_price</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">underlying_price</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">payoff</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">breakevens</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Find breakeven prices.&quot;&quot;&quot;</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">underlying_price</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">underlying_price</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">payoffs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">payoff</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">]</span>
        <span class="n">bkevens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payoffs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">payoffs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">payoffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bkevens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">bkevens</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print strategy summary.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">55</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Strategy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">55</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Underlying: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">underlying_price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">legs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Leg: </span><span class="si">{</span><span class="n">leg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Net Premium: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">net_premium</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Profit:  $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max Loss:    $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_loss</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Breakevens:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">breakevens</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">55</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot the payoff diagram.&quot;&quot;&quot;</span>
        <span class="n">strikes</span> <span class="o">=</span> <span class="p">[</span><span class="n">leg</span><span class="o">.</span><span class="n">strike</span> <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">legs</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">strikes</span><span class="p">)</span> <span class="k">if</span> <span class="n">strikes</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">underlying_price</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">center</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">center</span> <span class="o">*</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
        <span class="n">payoffs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">payoff</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">payoffs</span><span class="p">],</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">payoffs</span><span class="p">],</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">underlying_price</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span>
                   <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Spot $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">underlying_price</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">legs</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">leg</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                       <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Stock Price at Expiration ($)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Profit / Loss ($)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Example: Basic strategies</span>
<span class="n">price</span> <span class="o">=</span> <span class="mf">190.0</span>

<span class="c1"># Long Call</span>
<span class="n">long_call</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Long Call&#39;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
<span class="n">long_call</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mf">5.50</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
<span class="n">long_call</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">long_call</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="c1"># Covered Call (own stock + sell call)</span>
<span class="n">covered</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Covered Call&#39;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
<span class="n">covered</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mf">3.00</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
<span class="n">covered</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 11.1: Basic Strategy Builder (Guided)</h3>
<p>Complete the factory methods that create common strategies.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.1: Basic Strategy Builder (Guided)</span>

<span class="k">class</span> <span class="nc">BasicStrategies</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Factory for common single-leg and stock+option strategies.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">long_call</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a long call strategy.&quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Long Call&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="c1"># TODO: Add a long call leg</span>
        <span class="c1"># Hint: strat.add_leg(Leg(&#39;call&#39;, strike, premium, &#39;long&#39;))</span>
        <span class="k">pass</span>  <span class="c1"># Replace with your code</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">long_put</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a long put strategy.&quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Long Put&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="c1"># TODO: Add a long put leg</span>
        <span class="k">pass</span>  <span class="c1"># Replace with your code</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">covered_call</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">call_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">call_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a covered call strategy.</span>

<span class="sd">        Covered call = Own stock (profit from stock going up)</span>
<span class="sd">                     + Sell OTM call (collect premium, cap upside).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Covered Call&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="c1"># TODO: Add a short call leg</span>
        <span class="k">pass</span>  <span class="c1"># Replace with your code</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">protective_put</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">put_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">put_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a protective put strategy.</span>

<span class="sd">        Protective put = Own stock + Buy put (insurance).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Protective Put&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="c1"># TODO: Add a long put leg</span>
        <span class="k">pass</span>  <span class="c1"># Replace with your code</span>
        <span class="k">return</span> <span class="n">strat</span>

<span class="c1"># Test (uncomment after completing):</span>
<span class="c1"># lc = BasicStrategies.long_call(190, 195, 4.50)</span>
<span class="c1"># lc.summary()</span>
<span class="c1"># lc.plot()</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BasicStrategies</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">long_call</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">premium</span><span class="p">):</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Long Call&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">premium</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">long_put</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">premium</span><span class="p">):</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Long Put&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">premium</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">covered_call</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">,</span> <span class="n">call_strike</span><span class="p">,</span> <span class="n">call_premium</span><span class="p">):</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Covered Call&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">call_strike</span><span class="p">,</span> <span class="n">call_premium</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">protective_put</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">,</span> <span class="n">put_strike</span><span class="p">,</span> <span class="n">put_premium</span><span class="p">):</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Protective Put&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">put_strike</span><span class="p">,</span> <span class="n">put_premium</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>

<span class="c1"># Test all strategies</span>
<span class="n">strategies</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">BasicStrategies</span><span class="o">.</span><span class="n">long_call</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mf">4.50</span><span class="p">),</span>
    <span class="n">BasicStrategies</span><span class="o">.</span><span class="n">long_put</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mf">3.80</span><span class="p">),</span>
    <span class="n">BasicStrategies</span><span class="o">.</span><span class="n">covered_call</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mf">3.00</span><span class="p">),</span>
    <span class="n">BasicStrategies</span><span class="o">.</span><span class="n">protective_put</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mf">2.50</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strategies</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Vertical Spreads</h1>
<p>A <strong>vertical spread</strong> uses two options of the same type (both calls or both puts)
with different strikes but the same expiration. Spreads define both max profit
and max loss upfront.</p>
<h2>2.1 Spread Types</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Spread</th>
<th>Legs</th>
<th>Outlook</th>
<th>Net Premium</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Bull Call Spread</strong></td>
<td>Buy lower call + Sell higher call</td>
<td>Moderately bullish</td>
<td>Debit</td>
</tr>
<tr>
<td><strong>Bear Put Spread</strong></td>
<td>Buy higher put + Sell lower put</td>
<td>Moderately bearish</td>
<td>Debit</td>
</tr>
<tr>
<td><strong>Bull Put Credit</strong></td>
<td>Sell higher put + Buy lower put</td>
<td>Bullish/Neutral</td>
<td>Credit</td>
</tr>
<tr>
<td><strong>Bear Call Credit</strong></td>
<td>Sell lower call + Buy higher call</td>
<td>Bearish/Neutral</td>
<td>Credit</td>
</tr>
</tbody>
</table></div>
<p><strong>Key Formulas:</strong>
- Debit spread max profit = Width - Net debit
- Debit spread max loss = Net debit
- Credit spread max profit = Net credit
- Credit spread max loss = Width - Net credit</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">VerticalSpread</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Factory methods for vertical spread strategies.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bull_call</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">long_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">short_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">long_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">short_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bull call spread (debit spread).</span>

<span class="sd">        Buy lower-strike call, sell higher-strike call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Bull Call Spread&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">long_strike</span><span class="p">,</span> <span class="n">long_premium</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">short_strike</span><span class="p">,</span> <span class="n">short_premium</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bear_put</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">long_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">short_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">short_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">long_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bear put spread (debit spread).</span>

<span class="sd">        Buy higher-strike put, sell lower-strike put.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Bear Put Spread&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">long_strike</span><span class="p">,</span> <span class="n">long_premium</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">short_strike</span><span class="p">,</span> <span class="n">short_premium</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bull_put_credit</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                        <span class="n">long_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">short_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                        <span class="n">long_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">short_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bull put credit spread.</span>

<span class="sd">        Sell higher-strike put, buy lower-strike put.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Bull Put Credit Spread&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">short_strike</span><span class="p">,</span> <span class="n">short_premium</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">long_strike</span><span class="p">,</span> <span class="n">long_premium</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">bear_call_credit</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                         <span class="n">short_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">long_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                         <span class="n">short_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">long_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bear call credit spread.</span>

<span class="sd">        Sell lower-strike call, buy higher-strike call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Bear Call Credit Spread&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">short_strike</span><span class="p">,</span> <span class="n">short_premium</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">long_strike</span><span class="p">,</span> <span class="n">long_premium</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>


<span class="c1"># Example: Bull Call Spread</span>
<span class="n">price</span> <span class="o">=</span> <span class="mf">190.0</span>
<span class="n">bull_call</span> <span class="o">=</span> <span class="n">VerticalSpread</span><span class="o">.</span><span class="n">bull_call</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mf">8.00</span><span class="p">,</span> <span class="mf">3.50</span><span class="p">)</span>
<span class="n">bull_call</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">bull_call</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="c1"># Bear Put Spread</span>
<span class="n">bear_put</span> <span class="o">=</span> <span class="n">VerticalSpread</span><span class="o">.</span><span class="n">bear_put</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mf">1.50</span><span class="p">,</span> <span class="mf">6.00</span><span class="p">)</span>
<span class="n">bear_put</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">bear_put</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 11.2: Spread Analyzer (Open-ended)</h3>
<p>Build a function that compares different spread strategies side by side.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.2: Spread Analyzer (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a function that:</span>
<span class="c1"># - Takes a stock price and generates four spreads:</span>
<span class="c1">#   bull call, bear put, bull put credit, bear call credit</span>
<span class="c1"># - Uses strikes at price-10, price-5, price+5, price+10</span>
<span class="c1"># - Estimates premiums based on distance from ATM</span>
<span class="c1"># - Creates a 2x2 subplot showing all four payoff diagrams</span>
<span class="c1"># - Prints a comparison table: strategy, max profit, max loss, breakevens</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compare_spreads</span><span class="p">(</span><span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">vol_factor</span> <span class="o">=</span> <span class="mf">0.03</span>  <span class="c1"># rough premium estimate</span>
    <span class="n">atm_prem</span> <span class="o">=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">vol_factor</span>

    <span class="n">spreads</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Bull Call&#39;</span><span class="p">:</span> <span class="n">VerticalSpread</span><span class="o">.</span><span class="n">bull_call</span><span class="p">(</span>
            <span class="n">price</span><span class="p">,</span> <span class="n">price</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">price</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">atm_prem</span> <span class="o">*</span> <span class="mf">1.4</span><span class="p">,</span> <span class="n">atm_prem</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">),</span>
        <span class="s1">&#39;Bear Put&#39;</span><span class="p">:</span> <span class="n">VerticalSpread</span><span class="o">.</span><span class="n">bear_put</span><span class="p">(</span>
            <span class="n">price</span><span class="p">,</span> <span class="n">price</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">price</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">atm_prem</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">atm_prem</span> <span class="o">*</span> <span class="mf">1.3</span><span class="p">),</span>
        <span class="s1">&#39;Bull Put Credit&#39;</span><span class="p">:</span> <span class="n">VerticalSpread</span><span class="o">.</span><span class="n">bull_put_credit</span><span class="p">(</span>
            <span class="n">price</span><span class="p">,</span> <span class="n">price</span> <span class="o">-</span> <span class="n">width</span><span class="p">,</span> <span class="n">price</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">atm_prem</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">atm_prem</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">),</span>
        <span class="s1">&#39;Bear Call Credit&#39;</span><span class="p">:</span> <span class="n">VerticalSpread</span><span class="o">.</span><span class="n">bear_call_credit</span><span class="p">(</span>
            <span class="n">price</span><span class="p">,</span> <span class="n">price</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">price</span> <span class="o">+</span> <span class="n">width</span><span class="p">,</span>
            <span class="n">atm_prem</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">atm_prem</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spread Comparison (S=$</span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">prices_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">strat</span><span class="p">),</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spreads</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>
        <span class="n">payoffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">strat</span><span class="o">.</span><span class="n">payoff</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prices_range</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prices_range</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">prices_range</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">payoffs</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">prices_range</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">payoffs</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;Max Profit&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">strat</span><span class="o">.</span><span class="n">max_profit</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Max Loss&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">strat</span><span class="o">.</span><span class="n">max_loss</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Breakevens&#39;</span><span class="p">:</span> <span class="n">strat</span><span class="o">.</span><span class="n">breakevens</span><span class="p">(),</span>
            <span class="s1">&#39;Net Premium&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">strat</span><span class="o">.</span><span class="n">net_premium</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">compare_spreads</span><span class="p">(</span><span class="mi">190</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Iron Condors &amp; Butterflies</h1>
<p>Multi-leg strategies combine four or more legs to create defined-risk positions
that profit in specific price ranges.</p>
<h2>3.1 Iron Condor</h2>
<p>An <strong>iron condor</strong> combines a bull put spread and a bear call spread. It profits
when the stock stays within a defined range.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Component</th>
<th>Leg</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bull Put Spread</td>
<td>Buy OTM put + Sell closer-to-ATM put</td>
</tr>
<tr>
<td>Bear Call Spread</td>
<td>Sell closer-to-ATM call + Buy OTM call</td>
</tr>
</tbody>
</table></div>
<ul>
<li><strong>Max Profit:</strong> Net credit received</li>
<li><strong>Max Loss:</strong> Width of wider spread - net credit</li>
<li><strong>Ideal:</strong> Low volatility, range-bound stock</li>
</ul>
<h2>3.2 Butterfly Spread</h2>
<p>A <strong>butterfly</strong> uses three strikes to profit when the stock stays near a target.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Type</th>
<th>Legs</th>
</tr>
</thead>
<tbody>
<tr>
<td>Long Call Butterfly</td>
<td>Buy 1 low call + Sell 2 middle calls + Buy 1 high call</td>
</tr>
<tr>
<td>Long Put Butterfly</td>
<td>Buy 1 low put + Sell 2 middle puts + Buy 1 high put</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MultiLegStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Factory methods for multi-leg strategies.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">iron_condor</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="n">put_long_k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">put_short_k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="n">call_short_k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">call_long_k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="n">premiums</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an iron condor.</span>

<span class="sd">        Args:</span>
<span class="sd">            underlying_price: Current stock price</span>
<span class="sd">            put_long_k: Long put strike (lowest)</span>
<span class="sd">            put_short_k: Short put strike</span>
<span class="sd">            call_short_k: Short call strike</span>
<span class="sd">            call_long_k: Long call strike (highest)</span>
<span class="sd">            premiums: (put_long, put_short, call_short, call_long) premiums</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Iron Condor&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">put_long_k</span><span class="p">,</span> <span class="n">premiums</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">put_short_k</span><span class="p">,</span> <span class="n">premiums</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">call_short_k</span><span class="p">,</span> <span class="n">premiums</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">call_long_k</span><span class="p">,</span> <span class="n">premiums</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">long_call_butterfly</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">low_k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mid_k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">high_k</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">low_prem</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mid_prem</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">high_prem</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a long call butterfly.</span>

<span class="sd">        Buy 1 low call, sell 2 middle calls, buy 1 high call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Long Call Butterfly&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">low_k</span><span class="p">,</span> <span class="n">low_prem</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">mid_k</span><span class="p">,</span> <span class="n">mid_prem</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">high_k</span><span class="p">,</span> <span class="n">high_prem</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>


<span class="c1"># Example: Iron Condor on AAPL at $190</span>
<span class="n">ic</span> <span class="o">=</span> <span class="n">MultiLegStrategy</span><span class="o">.</span><span class="n">iron_condor</span><span class="p">(</span>
    <span class="mi">190</span><span class="p">,</span>
    <span class="n">put_long_k</span><span class="o">=</span><span class="mi">170</span><span class="p">,</span> <span class="n">put_short_k</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>
    <span class="n">call_short_k</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">call_long_k</span><span class="o">=</span><span class="mi">210</span><span class="p">,</span>
    <span class="n">premiums</span><span class="o">=</span><span class="p">(</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">2.50</span><span class="p">,</span> <span class="mf">2.80</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ic</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">ic</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="c1"># Butterfly</span>
<span class="n">butterfly</span> <span class="o">=</span> <span class="n">MultiLegStrategy</span><span class="o">.</span><span class="n">long_call_butterfly</span><span class="p">(</span>
    <span class="mi">190</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mf">12.00</span><span class="p">,</span> <span class="mf">5.50</span><span class="p">,</span> <span class="mf">1.50</span>
<span class="p">)</span>
<span class="n">butterfly</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">butterfly</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 11.3: Multi-Leg Strategy Builder (Guided)</h3>
<p>Complete the function that analyses risk/reward for an iron condor given
market conditions.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.3: Multi-Leg Strategy Builder (Guided)</span>

<span class="k">def</span> <span class="nf">analyze_iron_condor</span><span class="p">(</span><span class="n">spot</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
                        <span class="n">wing_distance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">,</span>
                        <span class="n">credit_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyse an iron condor with symmetric wings.</span>

<span class="sd">    Args:</span>
<span class="sd">        spot: Current stock price</span>
<span class="sd">        width: Width of each spread (put side and call side)</span>
<span class="sd">        wing_distance: Distance from spot to short strikes</span>
<span class="sd">        credit_pct: Estimated credit as fraction of width</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with strategy metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate the four strike prices</span>
    <span class="c1"># put_long_k: spot - wing_distance - width</span>
    <span class="c1"># put_short_k: spot - wing_distance</span>
    <span class="c1"># call_short_k: spot + wing_distance</span>
    <span class="c1"># call_long_k: spot + wing_distance + width</span>
    <span class="n">put_long_k</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1"># Replace with your code</span>
    <span class="n">put_short_k</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>
    <span class="n">call_short_k</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Replace with your code</span>
    <span class="n">call_long_k</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="c1"># TODO: Calculate net credit and max loss</span>
    <span class="c1"># net_credit = width * credit_pct</span>
    <span class="c1"># max_loss = width - net_credit</span>
    <span class="n">net_credit</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>
    <span class="n">max_loss</span> <span class="o">=</span> <span class="kc">None</span>    <span class="c1"># Replace with your code</span>

    <span class="c1"># TODO: Calculate probability of profit (approximate)</span>
    <span class="c1"># profit_range = call_short_k - put_short_k (the range where we profit)</span>
    <span class="c1"># total_range = call_long_k - put_long_k</span>
    <span class="c1"># pop = profit_range / total_range (simplified)</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;strikes&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">put_long_k</span><span class="p">,</span> <span class="n">put_short_k</span><span class="p">,</span> <span class="n">call_short_k</span><span class="p">,</span> <span class="n">call_long_k</span><span class="p">),</span>
        <span class="s1">&#39;net_credit&#39;</span><span class="p">:</span> <span class="n">net_credit</span><span class="p">,</span>
        <span class="s1">&#39;max_loss&#39;</span><span class="p">:</span> <span class="n">max_loss</span><span class="p">,</span>
        <span class="s1">&#39;risk_reward&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">net_credit</span> <span class="o">/</span> <span class="n">max_loss</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_loss</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;pop_estimate&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pop</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">pop</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1"># Test (uncomment after completing):</span>
<span class="c1"># result = analyze_iron_condor(190, width=10, wing_distance=15)</span>
<span class="c1"># for k, v in result.items():</span>
<span class="c1">#     print(f&quot;  {k}: {v}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_iron_condor</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">wing_distance</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span> <span class="n">credit_pct</span><span class="o">=</span><span class="mf">0.30</span><span class="p">):</span>
    <span class="n">put_long_k</span> <span class="o">=</span> <span class="n">spot</span> <span class="o">-</span> <span class="n">wing_distance</span> <span class="o">-</span> <span class="n">width</span>
    <span class="n">put_short_k</span> <span class="o">=</span> <span class="n">spot</span> <span class="o">-</span> <span class="n">wing_distance</span>
    <span class="n">call_short_k</span> <span class="o">=</span> <span class="n">spot</span> <span class="o">+</span> <span class="n">wing_distance</span>
    <span class="n">call_long_k</span> <span class="o">=</span> <span class="n">spot</span> <span class="o">+</span> <span class="n">wing_distance</span> <span class="o">+</span> <span class="n">width</span>

    <span class="n">net_credit</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">credit_pct</span>
    <span class="n">max_loss</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">net_credit</span>

    <span class="n">profit_range</span> <span class="o">=</span> <span class="n">call_short_k</span> <span class="o">-</span> <span class="n">put_short_k</span>
    <span class="n">total_range</span> <span class="o">=</span> <span class="n">call_long_k</span> <span class="o">-</span> <span class="n">put_long_k</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="n">profit_range</span> <span class="o">/</span> <span class="n">total_range</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;strikes&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">put_long_k</span><span class="p">,</span> <span class="n">put_short_k</span><span class="p">,</span> <span class="n">call_short_k</span><span class="p">,</span> <span class="n">call_long_k</span><span class="p">),</span>
        <span class="s1">&#39;net_credit&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">net_credit</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;max_loss&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">max_loss</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;risk_reward&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">net_credit</span> <span class="o">/</span> <span class="n">max_loss</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="s1">&#39;pop_estimate&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pop</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">}</span>

<span class="c1"># Test with different parameters</span>
<span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">analyze_iron_condor</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">wing_distance</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Wing distance: </span><span class="si">{</span><span class="n">dist</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Volatility Strategies</h1>
<p>Volatility strategies profit from moves in implied volatility or large stock
moves, regardless of direction.</p>
<h2>4.1 Straddles &amp; Strangles</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Strategy</th>
<th>Legs</th>
<th>Profits When</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Long Straddle</strong></td>
<td>Buy ATM call + Buy ATM put</td>
<td>Large move in either direction</td>
</tr>
<tr>
<td><strong>Short Straddle</strong></td>
<td>Sell ATM call + Sell ATM put</td>
<td>Stock stays near strike</td>
</tr>
<tr>
<td><strong>Long Strangle</strong></td>
<td>Buy OTM call + Buy OTM put</td>
<td>Very large move</td>
</tr>
<tr>
<td><strong>Short Strangle</strong></td>
<td>Sell OTM call + Sell OTM put</td>
<td>Stock stays in range</td>
</tr>
</tbody>
</table></div>
<h2>4.2 IV Rank and Strategy Selection</h2>
<p><strong>IV Rank</strong> measures where current IV sits relative to its historical range:</p>
<p><code>IV Rank = (Current IV - 52-week Low IV) / (52-week High IV - 52-week Low IV)</code></p>
<ul>
<li>IV Rank &gt; 50 ‚Üí consider <strong>selling</strong> premium (iron condors, short strangles)</li>
<li>IV Rank &lt; 30 ‚Üí consider <strong>buying</strong> premium (long straddles/strangles)</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">VolatilityStrategy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Factory methods for volatility-based strategies.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">long_straddle</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">call_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">put_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Buy ATM call + Buy ATM put.&quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Long Straddle&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">call_premium</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">put_premium</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">short_straddle</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">call_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">put_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sell ATM call + Sell ATM put.&quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Short Straddle&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">call_premium</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">put_premium</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">long_strangle</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">put_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">call_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">call_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">put_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Buy OTM call + Buy OTM put.&quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Long Strangle&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">call_strike</span><span class="p">,</span> <span class="n">call_premium</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">put_strike</span><span class="p">,</span> <span class="n">put_premium</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">short_strangle</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">put_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">call_strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">call_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">put_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Strategy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sell OTM call + Sell OTM put.&quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">Strategy</span><span class="p">(</span><span class="s1">&#39;Short Strangle&#39;</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="n">call_strike</span><span class="p">,</span> <span class="n">call_premium</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span><span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="n">put_strike</span><span class="p">,</span> <span class="n">put_premium</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">strat</span>


<span class="c1"># Example strategies</span>
<span class="n">price</span> <span class="o">=</span> <span class="mf">190.0</span>

<span class="n">straddle</span> <span class="o">=</span> <span class="n">VolatilityStrategy</span><span class="o">.</span><span class="n">long_straddle</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mf">5.50</span><span class="p">,</span> <span class="mf">5.00</span><span class="p">)</span>
<span class="n">straddle</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">straddle</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">strangle</span> <span class="o">=</span> <span class="n">VolatilityStrategy</span><span class="o">.</span><span class="n">short_strangle</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">,</span> <span class="mf">1.80</span><span class="p">)</span>
<span class="n">strangle</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">strangle</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">IVAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyse implied volatility rank and percentile.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lookback_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">252</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback</span> <span class="o">=</span> <span class="n">lookback_days</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;2y&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data for </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iv_series</span> <span class="o">=</span> <span class="n">log_returns</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iv_series</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">current_iv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Current implied volatility estimate (%).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iv_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">iv_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;IV Rank: position in 1-year range (0-100).&quot;&quot;&quot;</span>
        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span>
        <span class="n">iv_now</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">iv_low</span><span class="p">,</span> <span class="n">iv_high</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">window</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">iv_high</span> <span class="o">==</span> <span class="n">iv_low</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">50.0</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="n">iv_now</span> <span class="o">-</span> <span class="n">iv_low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">iv_high</span> <span class="o">-</span> <span class="n">iv_low</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iv_percentile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;IV Percentile: % of days IV was below current (0-100).&quot;&quot;&quot;</span>
        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lookback</span><span class="p">:]</span>
        <span class="n">iv_now</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="n">window</span> <span class="o">&lt;</span> <span class="n">iv_now</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recommendation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Suggest buy vs sell premium.&quot;&quot;&quot;</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iv_rank</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;SELL premium (IV elevated)&quot;</span>
        <span class="k">elif</span> <span class="n">rank</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;BUY premium (IV low)&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;NEUTRAL (IV mid-range)&quot;</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print IV analysis.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  IV Analysis: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Current IV: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_iv</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  IV Rank:    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iv_rank</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  IV Pctile:  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iv_percentile</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Advice:     </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recommendation</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># Example</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="n">IVAnalyzer</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">)</span>
    <span class="n">iv</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IV analysis error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 11.4: Vol Strategy Comparison (Open-ended)</h3>
<p>Build a function that visualises and compares all four volatility strategies
side by side.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.4: Volatility Strategy Comparison (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a function that:</span>
<span class="c1"># - Takes a stock price and estimated ATM/OTM premiums</span>
<span class="c1"># - Creates all four vol strategies (long/short straddle, long/short strangle)</span>
<span class="c1"># - Plots them in a 2x2 grid</span>
<span class="c1"># - Prints a comparison table with max profit, max loss, and breakevens</span>
<span class="c1"># - Adds a recommendation based on IV rank (if available)</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compare_vol_strategies</span><span class="p">(</span><span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">atm_call</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.50</span><span class="p">,</span>
                           <span class="n">atm_put</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.00</span><span class="p">,</span>
                           <span class="n">otm_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">15.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">otm_call_k</span> <span class="o">=</span> <span class="n">price</span> <span class="o">+</span> <span class="n">otm_offset</span>
    <span class="n">otm_put_k</span> <span class="o">=</span> <span class="n">price</span> <span class="o">-</span> <span class="n">otm_offset</span>
    <span class="n">otm_call_prem</span> <span class="o">=</span> <span class="n">atm_call</span> <span class="o">*</span> <span class="mf">0.35</span>
    <span class="n">otm_put_prem</span> <span class="o">=</span> <span class="n">atm_put</span> <span class="o">*</span> <span class="mf">0.35</span>

    <span class="n">strategies</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Long Straddle&#39;</span><span class="p">:</span> <span class="n">VolatilityStrategy</span><span class="o">.</span><span class="n">long_straddle</span><span class="p">(</span>
            <span class="n">price</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atm_call</span><span class="p">,</span> <span class="n">atm_put</span><span class="p">),</span>
        <span class="s1">&#39;Short Straddle&#39;</span><span class="p">:</span> <span class="n">VolatilityStrategy</span><span class="o">.</span><span class="n">short_straddle</span><span class="p">(</span>
            <span class="n">price</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">atm_call</span><span class="p">,</span> <span class="n">atm_put</span><span class="p">),</span>
        <span class="s1">&#39;Long Strangle&#39;</span><span class="p">:</span> <span class="n">VolatilityStrategy</span><span class="o">.</span><span class="n">long_strangle</span><span class="p">(</span>
            <span class="n">price</span><span class="p">,</span> <span class="n">otm_put_k</span><span class="p">,</span> <span class="n">otm_call_k</span><span class="p">,</span> <span class="n">otm_call_prem</span><span class="p">,</span> <span class="n">otm_put_prem</span><span class="p">),</span>
        <span class="s1">&#39;Short Strangle&#39;</span><span class="p">:</span> <span class="n">VolatilityStrategy</span><span class="o">.</span><span class="n">short_strangle</span><span class="p">(</span>
            <span class="n">price</span><span class="p">,</span> <span class="n">otm_put_k</span><span class="p">,</span> <span class="n">otm_call_k</span><span class="p">,</span> <span class="n">otm_call_prem</span><span class="p">,</span> <span class="n">otm_put_prem</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Volatility Strategies (S=$</span><span class="si">{</span><span class="n">price</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">prices_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">price</span> <span class="o">*</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">strat</span><span class="p">),</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">strategies</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">):</span>
        <span class="n">payoffs</span> <span class="o">=</span> <span class="p">[</span><span class="n">strat</span><span class="o">.</span><span class="n">payoff</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prices_range</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prices_range</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">prices_range</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">payoffs</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">prices_range</span><span class="p">,</span> <span class="n">payoffs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">payoffs</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;Max Profit&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">strat</span><span class="o">.</span><span class="n">max_profit</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Max Loss&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">strat</span><span class="o">.</span><span class="n">max_loss</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Net Premium&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">strat</span><span class="o">.</span><span class="n">net_premium</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Breakevens&#39;</span><span class="p">:</span> <span class="n">strat</span><span class="o">.</span><span class="n">breakevens</span><span class="p">(),</span>
        <span class="p">})</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">compare_vol_strategies</span><span class="p">(</span><span class="mi">190</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 11.5: IV Rank Strategy Selector (Guided)</h3>
<p>Complete the function that recommends a volatility strategy based on IV rank.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.5: IV Rank Strategy Selector (Guided)</span>

<span class="k">def</span> <span class="nf">select_vol_strategy</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">iv_rank</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                        <span class="n">atm_call_prem</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                        <span class="n">atm_put_prem</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Strategy</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select a volatility strategy based on IV rank.</span>

<span class="sd">    Rules:</span>
<span class="sd">        iv_rank &gt;= 60 -&gt; Short Strangle (sell OTM)</span>
<span class="sd">        iv_rank &gt;= 40 -&gt; Short Straddle (sell ATM)</span>
<span class="sd">        iv_rank &gt;= 20 -&gt; Long Strangle (buy OTM)</span>
<span class="sd">        iv_rank &lt;  20 -&gt; Long Straddle (buy ATM)</span>

<span class="sd">    Args:</span>
<span class="sd">        underlying_price: Current stock price</span>
<span class="sd">        iv_rank: IV rank (0-100)</span>
<span class="sd">        atm_call_prem: ATM call premium</span>
<span class="sd">        atm_put_prem: ATM put premium</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (recommendation, Strategy)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">otm_offset</span> <span class="o">=</span> <span class="n">underlying_price</span> <span class="o">*</span> <span class="mf">0.05</span>
    <span class="n">otm_call_k</span> <span class="o">=</span> <span class="n">underlying_price</span> <span class="o">+</span> <span class="n">otm_offset</span>
    <span class="n">otm_put_k</span> <span class="o">=</span> <span class="n">underlying_price</span> <span class="o">-</span> <span class="n">otm_offset</span>
    <span class="n">otm_call_prem</span> <span class="o">=</span> <span class="n">atm_call_prem</span> <span class="o">*</span> <span class="mf">0.4</span>
    <span class="n">otm_put_prem</span> <span class="o">=</span> <span class="n">atm_put_prem</span> <span class="o">*</span> <span class="mf">0.4</span>

    <span class="k">if</span> <span class="n">iv_rank</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="s2">&quot;SELL OTM premium (Short Strangle) -- IV elevated&quot;</span>
        <span class="c1"># TODO: Create short strangle using VolatilityStrategy.short_strangle(...)</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>
    <span class="k">elif</span> <span class="n">iv_rank</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">:</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="s2">&quot;SELL ATM premium (Short Straddle) -- IV above average&quot;</span>
        <span class="c1"># TODO: Create short straddle using VolatilityStrategy.short_straddle(...)</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>
    <span class="k">elif</span> <span class="n">iv_rank</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="s2">&quot;BUY OTM premium (Long Strangle) -- IV moderate&quot;</span>
        <span class="c1"># TODO: Create long strangle using VolatilityStrategy.long_strangle(...)</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="s2">&quot;BUY ATM premium (Long Straddle) -- IV very low&quot;</span>
        <span class="c1"># TODO: Create long straddle using VolatilityStrategy.long_straddle(...)</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="k">return</span> <span class="n">rec</span><span class="p">,</span> <span class="n">strat</span>

<span class="c1"># Test (uncomment after completing):</span>
<span class="c1"># rec, strat = select_vol_strategy(190, 65, 5.50, 5.00)</span>
<span class="c1"># print(rec)</span>
<span class="c1"># strat.summary()</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">select_vol_strategy</span><span class="p">(</span><span class="n">underlying_price</span><span class="p">,</span> <span class="n">iv_rank</span><span class="p">,</span> <span class="n">atm_call_prem</span><span class="p">,</span> <span class="n">atm_put_prem</span><span class="p">):</span>
    <span class="n">otm_offset</span> <span class="o">=</span> <span class="n">underlying_price</span> <span class="o">*</span> <span class="mf">0.05</span>
    <span class="n">otm_call_k</span> <span class="o">=</span> <span class="n">underlying_price</span> <span class="o">+</span> <span class="n">otm_offset</span>
    <span class="n">otm_put_k</span> <span class="o">=</span> <span class="n">underlying_price</span> <span class="o">-</span> <span class="n">otm_offset</span>
    <span class="n">otm_call_prem</span> <span class="o">=</span> <span class="n">atm_call_prem</span> <span class="o">*</span> <span class="mf">0.4</span>
    <span class="n">otm_put_prem</span> <span class="o">=</span> <span class="n">atm_put_prem</span> <span class="o">*</span> <span class="mf">0.4</span>

    <span class="k">if</span> <span class="n">iv_rank</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="s2">&quot;SELL OTM premium (Short Strangle) -- IV elevated&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">VolatilityStrategy</span><span class="o">.</span><span class="n">short_strangle</span><span class="p">(</span>
            <span class="n">underlying_price</span><span class="p">,</span> <span class="n">otm_put_k</span><span class="p">,</span> <span class="n">otm_call_k</span><span class="p">,</span>
            <span class="n">otm_call_prem</span><span class="p">,</span> <span class="n">otm_put_prem</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">iv_rank</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">:</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="s2">&quot;SELL ATM premium (Short Straddle) -- IV above average&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">VolatilityStrategy</span><span class="o">.</span><span class="n">short_straddle</span><span class="p">(</span>
            <span class="n">underlying_price</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">,</span>
            <span class="n">atm_call_prem</span><span class="p">,</span> <span class="n">atm_put_prem</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">iv_rank</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="s2">&quot;BUY OTM premium (Long Strangle) -- IV moderate&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">VolatilityStrategy</span><span class="o">.</span><span class="n">long_strangle</span><span class="p">(</span>
            <span class="n">underlying_price</span><span class="p">,</span> <span class="n">otm_put_k</span><span class="p">,</span> <span class="n">otm_call_k</span><span class="p">,</span>
            <span class="n">otm_call_prem</span><span class="p">,</span> <span class="n">otm_put_prem</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="s2">&quot;BUY ATM premium (Long Straddle) -- IV very low&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">VolatilityStrategy</span><span class="o">.</span><span class="n">long_straddle</span><span class="p">(</span>
            <span class="n">underlying_price</span><span class="p">,</span> <span class="n">underlying_price</span><span class="p">,</span>
            <span class="n">atm_call_prem</span><span class="p">,</span> <span class="n">atm_put_prem</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rec</span><span class="p">,</span> <span class="n">strat</span>

<span class="c1"># Test at different IV levels</span>
<span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">]:</span>
    <span class="n">rec</span><span class="p">,</span> <span class="n">strat</span> <span class="o">=</span> <span class="n">select_vol_strategy</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="mf">5.50</span><span class="p">,</span> <span class="mf">5.00</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IV Rank=</span><span class="si">{</span><span class="n">iv</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">strat</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 11.6: Vol Strategy Finder (Open-ended)</h3>
<p>Build a <code>VolStrategyFinder</code> class that scans multiple stocks for the best
volatility trading opportunities.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 11.6: Volatility Strategy Finder (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a VolStrategyFinder class that:</span>
<span class="c1"># - Accepts a list of ticker symbols</span>
<span class="c1"># - Computes IV rank and IV percentile for each</span>
<span class="c1"># - Recommends buy/sell premium strategy per stock</span>
<span class="c1"># - Ranks by &quot;edge&quot; (distance of IV rank from 50)</span>
<span class="c1"># - Returns a sorted DataFrame of opportunities</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VolStrategyFinder</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>

    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">analyzer</span> <span class="o">=</span> <span class="n">IVAnalyzer</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">rank</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">iv_rank</span><span class="p">()</span>
                <span class="n">pctile</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">iv_percentile</span><span class="p">()</span>
                <span class="n">rec</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">recommendation</span><span class="p">()</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rank</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;Symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;IV%&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">analyzer</span><span class="o">.</span><span class="n">current_iv</span><span class="p">()</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;IV Rank&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rank</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;IV Pctile&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pctile</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Edge&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">edge</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Recommendation&#39;</span><span class="p">:</span> <span class="n">rec</span><span class="p">,</span>
                <span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;Symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;IV%&#39;</span><span class="p">:</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;IV Rank&#39;</span><span class="p">:</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="s1">&#39;IV Pctile&#39;</span><span class="p">:</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Edge&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;Recommendation&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="p">})</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;_sort&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Edge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;_sort&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;_sort&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">finder</span> <span class="o">=</span> <span class="n">VolStrategyFinder</span><span class="p">(</span><span class="n">FAANG</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">finder</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h1>Module Project: Options Strategy Screener</h1>
<p>Build a comprehensive <code>OptionsStrategyScreener</code> that scans a universe of stocks
and recommends the best strategy based on outlook and IV environment.</p>
<p><strong>Requirements:</strong>
1. Scan a universe of stocks and estimate IV rank for each
2. Accept a user-supplied outlook (bullish, bearish, neutral)
3. Map (outlook, IV regime) to the optimal strategy
4. Construct and visualise the recommended strategy
5. Print a summary report with risk/reward metrics</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">OptionsStrategyScreener</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scan stocks and recommend options strategies based on IV and outlook.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        symbols: List of ticker symbols to scan</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">STRATEGY_MAP</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;high_iv&#39;</span><span class="p">):</span>  <span class="s1">&#39;bull_put_credit&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;mid_iv&#39;</span><span class="p">):</span>   <span class="s1">&#39;bull_call_spread&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;low_iv&#39;</span><span class="p">):</span>   <span class="s1">&#39;long_call&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;high_iv&#39;</span><span class="p">):</span>  <span class="s1">&#39;bear_call_credit&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;mid_iv&#39;</span><span class="p">):</span>   <span class="s1">&#39;bear_put_spread&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;low_iv&#39;</span><span class="p">):</span>   <span class="s1">&#39;long_put&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;high_iv&#39;</span><span class="p">):</span>  <span class="s1">&#39;iron_condor&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;mid_iv&#39;</span><span class="p">):</span>   <span class="s1">&#39;short_strangle&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;low_iv&#39;</span><span class="p">):</span>   <span class="s1">&#39;butterfly&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_get_stock_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch price and IV rank for a symbol.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No price data&quot;</span><span class="p">)</span>
            <span class="n">price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">vol_series</span> <span class="o">=</span> <span class="n">log_ret</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
            <span class="n">vol_series</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">current_vol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vol_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vol_series</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vol_series</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">iv_rank</span> <span class="o">=</span> <span class="p">((</span><span class="n">current_vol</span> <span class="o">-</span> <span class="n">v_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">v_max</span> <span class="o">-</span> <span class="n">v_min</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                       <span class="k">if</span> <span class="n">v_max</span> <span class="o">!=</span> <span class="n">v_min</span> <span class="k">else</span> <span class="mf">50.0</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                    <span class="s1">&#39;iv_est&#39;</span><span class="p">:</span> <span class="n">current_vol</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;iv_rank&#39;</span><span class="p">:</span> <span class="n">iv_rank</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_iv_regime</span><span class="p">(</span><span class="n">iv_rank</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iv_rank</span> <span class="o">&gt;=</span> <span class="mi">55</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;high_iv&#39;</span>
        <span class="k">elif</span> <span class="n">iv_rank</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;mid_iv&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;low_iv&#39;</span>

    <span class="k">def</span> <span class="nf">_build_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outlook</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Strategy</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Build the recommended strategy.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stock_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iv_regime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;iv_rank&#39;</span><span class="p">])</span>
        <span class="n">strategy_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">STRATEGY_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">outlook</span><span class="p">,</span> <span class="n">regime</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">strategy_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">vol_pct</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;iv_est&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">atm_est</span> <span class="o">=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">vol_pct</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">30</span> <span class="o">/</span> <span class="mi">365</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span>

        <span class="n">builders</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;long_call&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> Long Call&#39;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span>
                <span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;long&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;long_put&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">Strategy</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> Long Put&#39;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span><span class="o">.</span><span class="n">add_leg</span><span class="p">(</span>
                <span class="n">Leg</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;long&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;bull_call_spread&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">VerticalSpread</span><span class="o">.</span><span class="n">bull_call</span><span class="p">(</span>
                <span class="n">price</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="s1">&#39;bear_put_spread&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">VerticalSpread</span><span class="o">.</span><span class="n">bear_put</span><span class="p">(</span>
                <span class="n">price</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="s1">&#39;bull_put_credit&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">VerticalSpread</span><span class="o">.</span><span class="n">bull_put_credit</span><span class="p">(</span>
                <span class="n">price</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="s1">&#39;bear_call_credit&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">VerticalSpread</span><span class="o">.</span><span class="n">bear_call_credit</span><span class="p">(</span>
                <span class="n">price</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="s1">&#39;iron_condor&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">MultiLegStrategy</span><span class="o">.</span><span class="n">iron_condor</span><span class="p">(</span>
                <span class="n">price</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                 <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))),</span>
            <span class="s1">&#39;short_strangle&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">VolatilityStrategy</span><span class="o">.</span><span class="n">short_strangle</span><span class="p">(</span>
                <span class="n">price</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="s1">&#39;butterfly&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">MultiLegStrategy</span><span class="o">.</span><span class="n">long_call_butterfly</span><span class="p">(</span>
                <span class="n">price</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">price</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">atm_est</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
        <span class="p">}</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">builders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">strategy_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">builder</span><span class="p">()</span> <span class="k">if</span> <span class="n">builder</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outlook</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scan all symbols and recommend strategies.&quot;&quot;&quot;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stock_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
                <span class="k">continue</span>
            <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iv_regime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;iv_rank&#39;</span><span class="p">])</span>
            <span class="n">strat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_strategy</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">outlook</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;Price&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;IV Rank&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;iv_rank&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;Regime&#39;</span><span class="p">:</span> <span class="n">regime</span><span class="p">,</span>
                <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="n">strat</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">strat</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Max Profit&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">strat</span><span class="o">.</span><span class="n">max_profit</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">strat</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Max Loss&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">strat</span><span class="o">.</span><span class="n">max_loss</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">strat</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outlook</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build, summarise, and plot a recommended strategy.&quot;&quot;&quot;</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_strategy</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">outlook</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stock_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strat</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot build strategy for </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iv_regime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;iv_rank&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Outlook: </span><span class="si">{</span><span class="n">outlook</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> | IV Regime: </span><span class="si">{</span><span class="n">regime</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;(Rank: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;iv_rank&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
        <span class="n">strat</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">full_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outlook</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print a full screening report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  OPTIONS STRATEGY SCREENER  --  Outlook: </span><span class="si">{</span><span class="n">outlook</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">outlook</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Run the screener</span>
<span class="n">universe</span> <span class="o">=</span> <span class="n">FAANG</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;NVDA&#39;</span><span class="p">,</span> <span class="s1">&#39;TSLA&#39;</span><span class="p">]</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">screener</span> <span class="o">=</span> <span class="n">OptionsStrategyScreener</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">full_report</span><span class="p">(</span><span class="s1">&#39;neutral&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- BULLISH OUTLOOK ---&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">screener</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s1">&#39;bullish&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="c1"># Deep-dive on one stock</span>
    <span class="n">screener</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;bullish&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Screener error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>Basic Strategies:</strong> Long calls/puts give directional exposure with limited risk. Covered calls generate income; protective puts provide insurance</li>
<li><strong>Vertical Spreads:</strong> Bull call and bear put spreads offer defined risk/reward. Credit spreads let you collect premium with capped losses</li>
<li><strong>Iron Condors &amp; Butterflies:</strong> Multi-leg strategies profit in range-bound markets. Iron condors combine two credit spreads; butterflies profit at a precise price</li>
<li><strong>Volatility Strategies:</strong> Straddles and strangles profit from large moves regardless of direction. Use IV rank/percentile to decide whether to buy or sell premium</li>
<li><strong>IV Rank &gt; 50:</strong> Favour selling premium (short straddle, iron condor)</li>
<li><strong>IV Rank &lt; 30:</strong> Favour buying premium (long straddle, long strangle)</li>
<li><strong>Always define your risk:</strong> Use spreads and multi-leg structures to cap losses before entering a trade</li>
</ol>
<hr />
<p><strong>Next: Module 12 ‚Äî Options Automation</strong> (screening, strategy selection, backtesting, and rolling)</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="12"><div class="md-cell module-header"><h1>Module 12: Options Automation</h1>
<h2>Part 3: Options Trading</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ol>
<li>Screen for options opportunities using IV, volume, and earnings data</li>
<li>Automate strategy selection based on outlook and IV regime</li>
<li>Backtest options strategies using Black-Scholes simulation</li>
<li>Implement rolling and adjustment rules for open positions</li>
<li>Build a complete options trading system integrating all components</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>

<span class="c1"># Pre-fetch price data for the universe</span>
<span class="n">price_data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">FAANG</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">price_data</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Loaded </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span><span class="si">}</span><span class="s2"> days, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;last close $</span><span class="si">{</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: Error - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loaded data for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">price_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> symbols&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 12: Options Automation&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Section 1: Options Screening</h1>
<p>Screening is the first step in any systematic options strategy: finding stocks
where options trading offers an edge. We screen for three main signals:</p>
<ol>
<li><strong>High implied volatility</strong> ‚Äî stocks where options are relatively expensive</li>
<li><strong>Unusual activity</strong> ‚Äî volume spikes that may signal informed trading</li>
<li><strong>Earnings plays</strong> ‚Äî pre-announcement IV elevation</li>
</ol>
<h2>1.1 Volatility Screening</h2>
<p>Stocks with high <strong>historical volatility (HV)</strong> tend to have richer option premiums.
We estimate HV from daily returns and rank stocks by this metric.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">OptionsScreener</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Screen a universe of stocks for options trading opportunities.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        symbols: List of ticker symbols</span>
<span class="sd">        price_cache: Optional pre-fetched price data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                 <span class="n">price_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span> <span class="o">=</span> <span class="n">price_cache</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_get_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get historical data (cached or fresh).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">high_iv_stocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find stocks with high historical volatility.</span>

<span class="sd">        Args:</span>
<span class="sd">            threshold: Minimum annualised HV (e.g. 0.25 = 25%)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of dicts sorted by HV descending</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hist</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">hv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>
            <span class="n">price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">hv</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="s1">&#39;hv_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">hv</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">})</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;hv_pct&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unusual_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detect unusual options volume from yfinance chains.</span>

<span class="sd">        Args:</span>
<span class="sd">            volume_threshold: Minimum total option volume</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of dicts with volume stats and put/call ratios</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ticker</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">chain</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">option_chain</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

                <span class="n">call_vol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">calls</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="k">if</span> <span class="s1">&#39;volume&#39;</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">calls</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">put_vol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">puts</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="k">if</span> <span class="s1">&#39;volume&#39;</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">puts</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">call_vol</span> <span class="o">+</span> <span class="n">put_vol</span>
                <span class="n">pc_ratio</span> <span class="o">=</span> <span class="n">put_vol</span> <span class="o">/</span> <span class="n">call_vol</span> <span class="k">if</span> <span class="n">call_vol</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;=</span> <span class="n">volume_threshold</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                        <span class="s1">&#39;call_vol&#39;</span><span class="p">:</span> <span class="n">call_vol</span><span class="p">,</span> <span class="s1">&#39;put_vol&#39;</span><span class="p">:</span> <span class="n">put_vol</span><span class="p">,</span>
                        <span class="s1">&#39;total_vol&#39;</span><span class="p">:</span> <span class="n">total</span><span class="p">,</span>
                        <span class="s1">&#39;pc_ratio&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pc_ratio</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;Bearish&#39;</span> <span class="k">if</span> <span class="n">pc_ratio</span> <span class="o">&gt;</span> <span class="mf">1.5</span> <span class="k">else</span> <span class="p">(</span>
                            <span class="s1">&#39;Bullish&#39;</span> <span class="k">if</span> <span class="n">pc_ratio</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s1">&#39;Neutral&#39;</span><span class="p">),</span>
                    <span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;total_vol&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">earnings_plays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days_ahead</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find stocks with earnings announcements in the next N days.</span>

<span class="sd">        Pre-earnings periods typically show elevated IV.</span>

<span class="sd">        Args:</span>
<span class="sd">            days_ahead: Look-ahead window in days</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of dicts with earnings dates and IV estimates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">today</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_ahead</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">cal</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">calendar</span>
                <span class="k">if</span> <span class="n">cal</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cal</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Try to extract earnings date</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Earnings Date&#39;</span> <span class="ow">in</span> <span class="n">cal</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">earn_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">cal</span><span class="p">[</span><span class="s1">&#39;Earnings Date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Earnings Date&#39;</span> <span class="ow">in</span> <span class="n">cal</span><span class="p">:</span>
                    <span class="n">earn_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">cal</span><span class="p">[</span><span class="s1">&#39;Earnings Date&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">today</span> <span class="o">&lt;=</span> <span class="n">earn_date</span> <span class="o">&lt;=</span> <span class="n">deadline</span><span class="p">:</span>
                    <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hist</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="n">hv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                         <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hv</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                        <span class="s1">&#39;earnings_date&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">earn_date</span><span class="p">),</span>
                        <span class="s1">&#39;days_until&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">earn_date</span> <span class="o">-</span> <span class="n">today</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">,</span>
                        <span class="s1">&#39;hv_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">hv</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;days_until&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">full_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run all screens and return combined results.&quot;&quot;&quot;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hist</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">hv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

            <span class="c1"># IV rank estimate</span>
            <span class="n">vol_series</span> <span class="o">=</span> <span class="n">log_ret</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span>
            <span class="n">vol_series</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vol_series</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">v_now</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vol_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vol_series</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vol_series</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="n">iv_rank</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_now</span> <span class="o">-</span> <span class="n">v_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">v_max</span> <span class="o">-</span> <span class="n">v_min</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">v_max</span> <span class="o">!=</span> <span class="n">v_min</span> <span class="k">else</span> <span class="mi">50</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iv_rank</span> <span class="o">=</span> <span class="mi">50</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;Price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;HV%&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">hv</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;IV Rank&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">iv_rank</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;Regime&#39;</span><span class="p">:</span> <span class="s1">&#39;High&#39;</span> <span class="k">if</span> <span class="n">iv_rank</span> <span class="o">&gt;=</span> <span class="mi">55</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;Mid&#39;</span> <span class="k">if</span> <span class="n">iv_rank</span> <span class="o">&gt;=</span> <span class="mi">25</span> <span class="k">else</span> <span class="s1">&#39;Low&#39;</span><span class="p">),</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>


<span class="c1"># Run the screener</span>
<span class="n">screener</span> <span class="o">=</span> <span class="n">OptionsScreener</span><span class="p">(</span><span class="n">FAANG</span><span class="p">,</span> <span class="n">price_cache</span><span class="o">=</span><span class="n">price_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== HIGH VOLATILITY STOCKS ===&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">screener</span><span class="o">.</span><span class="n">high_iv_stocks</span><span class="p">(</span><span class="mf">0.20</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: HV=</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;hv_pct&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%, Price=$</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== FULL SCREEN ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">screener</span><span class="o">.</span><span class="n">full_screen</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 12.1: Advanced Options Screener (Guided)</h3>
<p>Complete the function that screens for covered call candidates ‚Äî stocks with
moderate volatility and good premium yield.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.1: Covered Call Screener (Guided)</span>

<span class="k">def</span> <span class="nf">screen_covered_calls</span><span class="p">(</span><span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">min_yield</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                         <span class="n">price_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Screen for stocks suitable for covered call writing.</span>

<span class="sd">    A good covered call candidate has:</span>
<span class="sd">    - Moderate HV (15-40%) ‚Äî enough premium but not too risky</span>
<span class="sd">    - Stock price is above its 50-day SMA (mild uptrend)</span>

<span class="sd">    Args:</span>
<span class="sd">        symbols: List of tickers</span>
<span class="sd">        min_yield: Minimum estimated monthly premium yield</span>
<span class="sd">        price_cache: Optional pre-fetched data</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of dicts with symbol, price, hv, sma50, premium_yield</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">price_cache</span> <span class="ow">and</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">price_cache</span><span class="p">:</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">price_cache</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># TODO: Calculate 50-day simple moving average</span>
            <span class="n">sma50</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

            <span class="c1"># TODO: Calculate annualised historical volatility</span>
            <span class="c1"># Hint: log returns -&gt; std -&gt; multiply by sqrt(252)</span>
            <span class="n">hv</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

            <span class="c1"># TODO: Check if stock is above SMA50 (uptrend)</span>
            <span class="c1"># and HV is between 0.15 and 0.40 (moderate vol)</span>
            <span class="n">in_uptrend</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1"># Replace with your code</span>
            <span class="n">moderate_vol</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

            <span class="k">if</span> <span class="n">in_uptrend</span> <span class="ow">and</span> <span class="n">moderate_vol</span><span class="p">:</span>
                <span class="c1"># TODO: Estimate monthly premium yield</span>
                <span class="c1"># Approximate: HV * sqrt(30/365) * 0.4 / price</span>
                <span class="n">est_premium</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1"># Replace with your code</span>
                <span class="n">premium_yield</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

                <span class="k">if</span> <span class="n">premium_yield</span> <span class="o">&gt;=</span> <span class="n">min_yield</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s1">&#39;sma50&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">sma50</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s1">&#39;hv_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">hv</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="s1">&#39;est_premium&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">est_premium</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s1">&#39;monthly_yield&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">premium_yield</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;monthly_yield&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Test (uncomment after completing):</span>
<span class="c1"># candidates = screen_covered_calls(FAANG, price_cache=price_data)</span>
<span class="c1"># for c in candidates:</span>
<span class="c1">#     print(f&quot;  {c[&#39;symbol&#39;]}: yield={c[&#39;monthly_yield&#39;]}%, &quot;</span>
<span class="c1">#           f&quot;HV={c[&#39;hv_pct&#39;]}%, premium=${c[&#39;est_premium&#39;]}&quot;)</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">screen_covered_calls</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">min_yield</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">price_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">price_cache</span> <span class="ow">and</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">price_cache</span><span class="p">:</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">price_cache</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">sma50</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">hv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>

            <span class="n">in_uptrend</span> <span class="o">=</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">sma50</span>
            <span class="n">moderate_vol</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="o">&lt;=</span> <span class="n">hv</span> <span class="o">&lt;=</span> <span class="mf">0.40</span>

            <span class="k">if</span> <span class="n">in_uptrend</span> <span class="ow">and</span> <span class="n">moderate_vol</span><span class="p">:</span>
                <span class="n">est_premium</span> <span class="o">=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">hv</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">30</span> <span class="o">/</span> <span class="mi">365</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span>
                <span class="n">premium_yield</span> <span class="o">=</span> <span class="n">est_premium</span> <span class="o">/</span> <span class="n">price</span>

                <span class="k">if</span> <span class="n">premium_yield</span> <span class="o">&gt;=</span> <span class="n">min_yield</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s1">&#39;sma50&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">sma50</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s1">&#39;hv_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">hv</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="s1">&#39;est_premium&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">est_premium</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s1">&#39;monthly_yield&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">premium_yield</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;monthly_yield&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">candidates</span> <span class="o">=</span> <span class="n">screen_covered_calls</span><span class="p">(</span><span class="n">FAANG</span><span class="p">,</span> <span class="n">price_cache</span><span class="o">=</span><span class="n">price_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Covered Call Candidates:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: yield=</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;monthly_yield&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%, &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;HV=</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;hv_pct&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%, premium=$</span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;est_premium&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 2: Strategy Selection</h1>
<h2>2.1 Matching Strategy to Outlook</h2>
<p>Once we have screened for candidates, we need to select the right strategy.
The <strong>strategy-outlook matrix</strong> maps a directional view and IV regime to the
optimal options strategy.</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th>High IV</th>
<th>Mid IV</th>
<th>Low IV</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Bullish</strong></td>
<td>Bull put credit</td>
<td>Bull call spread</td>
<td>Long call</td>
</tr>
<tr>
<td><strong>Bearish</strong></td>
<td>Bear call credit</td>
<td>Bear put spread</td>
<td>Long put</td>
</tr>
<tr>
<td><strong>Neutral</strong></td>
<td>Iron condor / Short strangle</td>
<td>Iron condor</td>
<td>Butterfly</td>
</tr>
</tbody>
</table></div>
<h2>2.2 Position Sizing</h2>
<p>For options, position sizing is based on <strong>max risk per trade</strong>:</p>
<ul>
<li><strong>Defined risk</strong> (spreads): <code>Contracts = Account Risk / (Width √ó 100)</code></li>
<li><strong>Undefined risk</strong> (naked): <code>Contracts = Account Risk / (Margin √ó 100)</code></li>
<li><strong>Rule of thumb:</strong> Never risk more than 2% of account equity per trade</li>
</ul></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">StrategySelector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select the optimal options strategy based on market outlook and IV.</span>

<span class="sd">    Uses a lookup matrix mapping (direction, iv_regime) to strategy names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MATRIX</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">):</span>  <span class="p">[</span><span class="s1">&#39;Bull Put Credit&#39;</span><span class="p">,</span> <span class="s1">&#39;Covered Call&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">):</span>   <span class="p">[</span><span class="s1">&#39;Bull Call Spread&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">):</span>   <span class="p">[</span><span class="s1">&#39;Long Call&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">):</span>  <span class="p">[</span><span class="s1">&#39;Bear Call Credit&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">):</span>   <span class="p">[</span><span class="s1">&#39;Bear Put Spread&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">):</span>   <span class="p">[</span><span class="s1">&#39;Long Put&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">):</span>  <span class="p">[</span><span class="s1">&#39;Iron Condor&#39;</span><span class="p">,</span> <span class="s1">&#39;Short Strangle&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;mid&#39;</span><span class="p">):</span>   <span class="p">[</span><span class="s1">&#39;Iron Condor&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">):</span>   <span class="p">[</span><span class="s1">&#39;Long Straddle&#39;</span><span class="p">,</span> <span class="s1">&#39;Long Strangle&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">iv_regime</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get strategy recommendations for a given outlook.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">MATRIX</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">direction</span><span class="p">,</span> <span class="n">iv_regime</span><span class="p">),</span> <span class="p">[])</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">analyze_symbol</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">price_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse a symbol and recommend strategies.</span>

<span class="sd">        Args:</span>
<span class="sd">            symbol: Ticker symbol</span>
<span class="sd">            price_cache: Optional pre-fetched data</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict with direction, iv_regime, hv, and strategy recommendations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">price_cache</span> <span class="ow">and</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">price_cache</span><span class="p">:</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">price_cache</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hist</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data&#39;</span><span class="p">}</span>

            <span class="n">close</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="n">price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">sma50</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">sma200</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="k">else</span> <span class="n">sma50</span>

            <span class="n">log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">close</span> <span class="o">/</span> <span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">hv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>

            <span class="c1"># Determine direction</span>
            <span class="k">if</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="n">sma50</span> <span class="o">&gt;</span> <span class="n">sma200</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
            <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="n">sma50</span> <span class="o">&lt;</span> <span class="n">sma200</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>

            <span class="c1"># Determine IV regime</span>
            <span class="k">if</span> <span class="n">hv</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                <span class="n">iv_regime</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span>
            <span class="k">elif</span> <span class="n">hv</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">:</span>
                <span class="n">iv_regime</span> <span class="o">=</span> <span class="s1">&#39;mid&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iv_regime</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span>

            <span class="n">strategies</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">iv_regime</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;direction&#39;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span> <span class="s1">&#39;iv_regime&#39;</span><span class="p">:</span> <span class="n">iv_regime</span><span class="p">,</span>
                <span class="s1">&#39;hv_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">hv</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;strategies&#39;</span><span class="p">:</span> <span class="n">strategies</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">position_size</span><span class="p">(</span><span class="n">account_equity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                      <span class="n">max_loss_per_contract</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate position size based on account risk.</span>

<span class="sd">        Args:</span>
<span class="sd">            account_equity: Total account value</span>
<span class="sd">            risk_pct: Max risk per trade (e.g. 0.02 for 2%)</span>
<span class="sd">            max_loss_per_contract: Max loss per contract in dollars</span>

<span class="sd">        Returns:</span>
<span class="sd">            Number of contracts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">risk_budget</span> <span class="o">=</span> <span class="n">account_equity</span> <span class="o">*</span> <span class="n">risk_pct</span>
        <span class="k">if</span> <span class="n">max_loss_per_contract</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">risk_budget</span> <span class="o">/</span> <span class="n">max_loss_per_contract</span><span class="p">)</span>


<span class="c1"># Example</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Strategy Recommendations:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">FAANG</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">StrategySelector</span><span class="o">.</span><span class="n">analyze_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">price_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> + &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;iv_regime&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">IV (HV=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;hv_pct&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%) &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;-&gt; </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;strategies&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Position sizing</span>
<span class="n">contracts</span> <span class="o">=</span> <span class="n">StrategySelector</span><span class="o">.</span><span class="n">position_size</span><span class="p">(</span>
    <span class="n">account_equity</span><span class="o">=</span><span class="mi">100_000</span><span class="p">,</span> <span class="n">risk_pct</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
    <span class="n">max_loss_per_contract</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Position size: </span><span class="si">{</span><span class="n">contracts</span><span class="si">}</span><span class="s2"> contracts &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;(2% risk on $100K, $500 max loss/contract)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 12.2: Custom Strategy Selector (Open-ended)</h3>
<p>Build a strategy selector that incorporates additional factors beyond
just direction and IV.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.2: Enhanced Strategy Selector (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a class that:</span>
<span class="c1"># - Accepts a symbol and account parameters</span>
<span class="c1"># - Analyses direction (SMA crossovers) and IV regime</span>
<span class="c1"># - Also considers: earnings proximity, RSI, and recent gap risk</span>
<span class="c1"># - Returns the top 3 strategies ranked by suitability score</span>
<span class="c1"># - Includes position sizing for each recommendation</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">EnhancedSelector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">account_equity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">,</span>
                 <span class="n">risk_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">price_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">account_equity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_pct</span> <span class="o">=</span> <span class="n">risk_pct</span>

        <span class="k">if</span> <span class="n">price_cache</span> <span class="ow">and</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">price_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hist</span> <span class="o">=</span> <span class="n">price_cache</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hist</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">sma20</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">sma50</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">&gt;</span> <span class="n">sma20</span> <span class="o">&gt;</span> <span class="n">sma50</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">&lt;</span> <span class="n">sma20</span> <span class="o">&lt;</span> <span class="n">sma50</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;neutral&#39;</span>

    <span class="k">def</span> <span class="nf">_hv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">log_ret</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_rsi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">recommend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">()</span>
        <span class="n">hv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hv</span><span class="p">()</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsi</span><span class="p">()</span>
        <span class="n">iv_regime</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span> <span class="k">if</span> <span class="n">hv</span> <span class="o">&gt;</span> <span class="mf">0.30</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;mid&#39;</span> <span class="k">if</span> <span class="n">hv</span> <span class="o">&gt;</span> <span class="mf">0.18</span> <span class="k">else</span> <span class="s1">&#39;low&#39;</span><span class="p">)</span>

        <span class="n">candidates</span> <span class="o">=</span> <span class="n">StrategySelector</span><span class="o">.</span><span class="n">recommend</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">iv_regime</span><span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">strat_name</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># base</span>
            <span class="k">if</span> <span class="n">iv_regime</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="s1">&#39;Credit&#39;</span> <span class="ow">in</span> <span class="n">strat_name</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">20</span>
            <span class="k">if</span> <span class="n">iv_regime</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span> <span class="ow">and</span> <span class="s1">&#39;Long&#39;</span> <span class="ow">in</span> <span class="n">strat_name</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">15</span>
            <span class="k">if</span> <span class="mi">30</span> <span class="o">&lt;</span> <span class="n">rsi</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">10</span>  <span class="c1"># not overbought/oversold</span>
            <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span> <span class="ow">and</span> <span class="n">rsi</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>
            <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span> <span class="ow">and</span> <span class="n">rsi</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">5</span>

            <span class="n">est_max_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># rough</span>
            <span class="n">contracts</span> <span class="o">=</span> <span class="n">StrategySelector</span><span class="o">.</span><span class="n">position_size</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk_pct</span><span class="p">,</span> <span class="n">est_max_loss</span><span class="p">)</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Strategy&#39;</span><span class="p">:</span> <span class="n">strat_name</span><span class="p">,</span>
                <span class="s1">&#39;Score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
                <span class="s1">&#39;Contracts&#39;</span><span class="p">:</span> <span class="n">contracts</span><span class="p">,</span>
                <span class="s1">&#39;Max Risk&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">est_max_loss</span> <span class="o">*</span> <span class="n">contracts</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">})</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">selector</span> <span class="o">=</span> <span class="n">EnhancedSelector</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">price_cache</span><span class="o">=</span><span class="n">price_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AAPL Recommendations:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">selector</span><span class="o">.</span><span class="n">recommend</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 3: Options Backtesting</h1>
<h2>3.1 Simulating Options with Black-Scholes</h2>
<p>Since historical options data is expensive and hard to obtain, we can
<strong>simulate</strong> option prices using the Black-Scholes model applied to historical
stock prices. This lets us backtest strategies like covered calls, iron condors,
and credit spreads.</p>
<p><strong>Approach:</strong>
1. Walk through historical price data day by day
2. At each "entry" point, calculate the BS option price
3. Track the position as the stock moves and time decays
4. Close at expiration or when a stop/target is hit</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">black_scholes</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Black-Scholes pricing with Greeks.</span>

<span class="sd">    Returns dict with price, delta, gamma, theta, vega.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">T</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">S</span> <span class="o">-</span> <span class="n">K</span><span class="p">),</span> <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">S</span> <span class="o">&gt;</span> <span class="n">K</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;vega&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">K</span> <span class="o">-</span> <span class="n">S</span><span class="p">),</span> <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">S</span> <span class="o">&lt;</span> <span class="n">K</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;vega&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S</span> <span class="o">/</span> <span class="n">K</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">K</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d2</span><span class="p">)</span> <span class="o">-</span> <span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">d1</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">gamma</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span> <span class="o">/</span> <span class="mi">365</span>
    <span class="n">vega</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">delta</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">,</span>
            <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s1">&#39;vega&#39;</span><span class="p">:</span> <span class="n">vega</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">OptionsBacktester</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Backtest a covered call strategy using Black-Scholes simulation.</span>

<span class="sd">    Simulates selling OTM calls against a stock position, rolling at</span>
<span class="sd">    each expiration cycle.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        prices: Historical price series</span>
<span class="sd">        strike_offset: OTM offset as fraction (e.g. 0.03 = 3%)</span>
<span class="sd">        dte: Days to expiration per cycle</span>
<span class="sd">        vol: Assumed volatility</span>
<span class="sd">        r: Risk-free rate</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">strike_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.03</span><span class="p">,</span>
                 <span class="n">dte</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">vol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strike_offset</span> <span class="o">=</span> <span class="n">strike_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dte</span> <span class="o">=</span> <span class="n">dte</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the covered call backtest.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with daily P&amp;L tracking</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">values</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dte</span><span class="p">:</span>
            <span class="n">entry_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">strike</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">strike_offset</span><span class="p">)</span>
            <span class="n">T_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dte</span> <span class="o">/</span> <span class="mi">365</span>

            <span class="c1"># Calculate entry premium</span>
            <span class="n">entry_bs</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">entry_price</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">T_total</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
            <span class="n">premium_received</span> <span class="o">=</span> <span class="n">entry_bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>

            <span class="c1"># Track through the cycle</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dte</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">current_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">T_remaining</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dte</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="mi">365</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>

                <span class="n">bs</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">current_price</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">T_remaining</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
                <span class="n">option_value</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>

                <span class="c1"># Stock P&amp;L + Option P&amp;L (short call)</span>
                <span class="n">stock_pnl</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">-</span> <span class="n">entry_price</span>
                <span class="n">option_pnl</span> <span class="o">=</span> <span class="n">premium_received</span> <span class="o">-</span> <span class="n">option_value</span>
                <span class="n">total_pnl</span> <span class="o">=</span> <span class="n">stock_pnl</span> <span class="o">+</span> <span class="n">option_pnl</span>

                <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span>
                    <span class="s1">&#39;stock_price&#39;</span><span class="p">:</span> <span class="n">current_price</span><span class="p">,</span>
                    <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="n">strike</span><span class="p">,</span>
                    <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
                    <span class="s1">&#39;premium&#39;</span><span class="p">:</span> <span class="n">premium_received</span><span class="p">,</span>
                    <span class="s1">&#39;option_value&#39;</span><span class="p">:</span> <span class="n">option_value</span><span class="p">,</span>
                    <span class="s1">&#39;stock_pnl&#39;</span><span class="p">:</span> <span class="n">stock_pnl</span><span class="p">,</span>
                    <span class="s1">&#39;option_pnl&#39;</span><span class="p">:</span> <span class="n">option_pnl</span><span class="p">,</span>
                    <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="n">total_pnl</span><span class="p">,</span>
                    <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">bs</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;cycle&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">dte</span><span class="p">,</span>
                <span class="p">})</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dte</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Summarise backtest results.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">cycles</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cycle&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">entry</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;entry_price&#39;</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">),</span>
            <span class="n">exit</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;stock_price&#39;</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">),</span>
            <span class="n">premium</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;premium&#39;</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">),</span>
            <span class="n">final_pnl</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;total_pnl&#39;</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_cycles&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">),</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="s1">&#39;final_pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;avg_cycle_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="s1">&#39;final_pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;win_rate_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span>
                <span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="s1">&#39;final_pnl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;avg_premium&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="s1">&#39;premium&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;max_cycle_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="s1">&#39;final_pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;min_cycle_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">cycles</span><span class="p">[</span><span class="s1">&#39;final_pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot backtest results.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Covered Call Backtest&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;stock_price&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Stock&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cycle&#39;</span><span class="p">):</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">cycle</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price ($)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_pnl&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total P&amp;L&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;stock_pnl&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Stock Only&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;P&amp;L ($)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Run backtest</span>
<span class="k">if</span> <span class="s1">&#39;AAPL&#39;</span> <span class="ow">in</span> <span class="n">price_data</span><span class="p">:</span>
    <span class="n">bt</span> <span class="o">=</span> <span class="n">OptionsBacktester</span><span class="p">(</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">][</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span>
                           <span class="n">strike_offset</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">dte</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">vol</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Covered Call Backtest ‚Äî AAPL&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">bt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 12.3: Options Backtester Enhancement (Guided)</h3>
<p>Complete the function that adds a stop-loss and profit-target to the backtest.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.3: Backtester with Stops (Guided)</span>

<span class="k">def</span> <span class="nf">backtest_with_stops</span><span class="p">(</span><span class="n">prices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">strike_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.03</span><span class="p">,</span>
                        <span class="n">dte</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">vol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
                        <span class="n">stop_loss_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                        <span class="n">profit_target_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Backtest covered calls with stop-loss and profit target.</span>

<span class="sd">    Args:</span>
<span class="sd">        prices: Historical price series</span>
<span class="sd">        strike_offset: OTM distance</span>
<span class="sd">        dte: Days per cycle</span>
<span class="sd">        vol: Assumed volatility</span>
<span class="sd">        stop_loss_pct: Close if stock drops this much from entry</span>
<span class="sd">        profit_target_pct: Close if option profit reaches this % of premium</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with cycle-level results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">values</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cycle_num</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="n">dte</span><span class="p">:</span>
        <span class="n">entry_price</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">strike</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strike_offset</span><span class="p">)</span>
        <span class="n">T_total</span> <span class="o">=</span> <span class="n">dte</span> <span class="o">/</span> <span class="mi">365</span>

        <span class="n">bs</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">entry_price</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">T_total</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
        <span class="n">premium</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>

        <span class="c1"># TODO: Calculate stop-loss price</span>
        <span class="c1"># Hint: entry_price * (1 - stop_loss_pct)</span>
        <span class="n">stop_price</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

        <span class="c1"># TODO: Calculate profit target (in dollar terms)</span>
        <span class="c1"># Hint: premium * profit_target_pct</span>
        <span class="n">target_profit</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

        <span class="n">exit_reason</span> <span class="o">=</span> <span class="s1">&#39;expiration&#39;</span>
        <span class="n">exit_day</span> <span class="o">=</span> <span class="n">dte</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dte</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">T_rem</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">dte</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="mi">365</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
            <span class="n">current_bs</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">T_rem</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
            <span class="n">option_pnl</span> <span class="o">=</span> <span class="n">premium</span> <span class="o">-</span> <span class="n">current_bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>

            <span class="c1"># TODO: Check stop-loss condition (current &lt; stop_price)</span>
            <span class="k">pass</span>  <span class="c1"># Replace with if-block</span>

            <span class="c1"># TODO: Check profit target (option_pnl &gt;= target_profit)</span>
            <span class="k">pass</span>  <span class="c1"># Replace with if-block</span>

        <span class="c1"># Calculate final P&amp;L</span>
        <span class="n">exit_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">exit_day</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">exit_price</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">exit_idx</span><span class="p">]</span>
        <span class="n">stock_pnl</span> <span class="o">=</span> <span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry_price</span>
        <span class="n">T_exit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">dte</span> <span class="o">-</span> <span class="n">exit_day</span><span class="p">)</span> <span class="o">/</span> <span class="mi">365</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
        <span class="n">exit_bs</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">exit_price</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">T_exit</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
        <span class="n">option_pnl</span> <span class="o">=</span> <span class="n">premium</span> <span class="o">-</span> <span class="n">exit_bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>

        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;cycle&#39;</span><span class="p">:</span> <span class="n">cycle_num</span><span class="p">,</span> <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">entry_price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;exit&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">exit_price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">strike</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;premium&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">premium</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;stock_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">stock_pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;option_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">option_pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">stock_pnl</span> <span class="o">+</span> <span class="n">option_pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;exit_reason&#39;</span><span class="p">:</span> <span class="n">exit_reason</span><span class="p">,</span> <span class="s1">&#39;days_held&#39;</span><span class="p">:</span> <span class="n">exit_day</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">i</span> <span class="o">+=</span> <span class="n">exit_day</span>
        <span class="n">cycle_num</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

<span class="c1"># Test (uncomment after completing):</span>
<span class="c1"># if &#39;AAPL&#39; in price_data:</span>
<span class="c1">#     results = backtest_with_stops(price_data[&#39;AAPL&#39;][&#39;Close&#39;])</span>
<span class="c1">#     print(results.to_string(index=False))</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">backtest_with_stops</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">strike_offset</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">dte</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">vol</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                        <span class="n">stop_loss_pct</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">profit_target_pct</span><span class="o">=</span><span class="mf">0.50</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">values</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cycle_num</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="n">dte</span><span class="p">:</span>
        <span class="n">entry_price</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">strike</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strike_offset</span><span class="p">)</span>
        <span class="n">T_total</span> <span class="o">=</span> <span class="n">dte</span> <span class="o">/</span> <span class="mi">365</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">entry_price</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">T_total</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
        <span class="n">premium</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>

        <span class="n">stop_price</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stop_loss_pct</span><span class="p">)</span>
        <span class="n">target_profit</span> <span class="o">=</span> <span class="n">premium</span> <span class="o">*</span> <span class="n">profit_target_pct</span>

        <span class="n">exit_reason</span> <span class="o">=</span> <span class="s1">&#39;expiration&#39;</span>
        <span class="n">exit_day</span> <span class="o">=</span> <span class="n">dte</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dte</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">T_rem</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">dte</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="mi">365</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
            <span class="n">current_bs</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">T_rem</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
            <span class="n">option_pnl</span> <span class="o">=</span> <span class="n">premium</span> <span class="o">-</span> <span class="n">current_bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">stop_price</span><span class="p">:</span>
                <span class="n">exit_reason</span> <span class="o">=</span> <span class="s1">&#39;stop_loss&#39;</span>
                <span class="n">exit_day</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">option_pnl</span> <span class="o">&gt;=</span> <span class="n">target_profit</span><span class="p">:</span>
                <span class="n">exit_reason</span> <span class="o">=</span> <span class="s1">&#39;profit_target&#39;</span>
                <span class="n">exit_day</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">break</span>

        <span class="n">exit_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">exit_day</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">exit_price</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">exit_idx</span><span class="p">]</span>
        <span class="n">stock_pnl</span> <span class="o">=</span> <span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry_price</span>
        <span class="n">T_exit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">dte</span> <span class="o">-</span> <span class="n">exit_day</span><span class="p">)</span> <span class="o">/</span> <span class="mi">365</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
        <span class="n">exit_bs</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">exit_price</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">T_exit</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
        <span class="n">option_pnl</span> <span class="o">=</span> <span class="n">premium</span> <span class="o">-</span> <span class="n">exit_bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>

        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;cycle&#39;</span><span class="p">:</span> <span class="n">cycle_num</span><span class="p">,</span> <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">entry_price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;exit&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">exit_price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">strike</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;premium&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">premium</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;stock_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">stock_pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;option_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">option_pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">stock_pnl</span> <span class="o">+</span> <span class="n">option_pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;exit_reason&#39;</span><span class="p">:</span> <span class="n">exit_reason</span><span class="p">,</span> <span class="s1">&#39;days_held&#39;</span><span class="p">:</span> <span class="n">exit_day</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">i</span> <span class="o">+=</span> <span class="n">exit_day</span>
        <span class="n">cycle_num</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

<span class="k">if</span> <span class="s1">&#39;AAPL&#39;</span> <span class="ow">in</span> <span class="n">price_data</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">backtest_with_stops</span><span class="p">(</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">][</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backtest with Stops:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Exit reasons: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;exit_reason&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average P&amp;L: $</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell"><hr />
<h1>Section 4: Rolling &amp; Adjustments</h1>
<h2>4.1 When to Roll</h2>
<p><strong>Rolling</strong> means closing an existing option position and opening a new one,
typically with a later expiration and/or different strike.</p>
<p><strong>Roll triggers:</strong>
1. <strong>Time-based:</strong> DTE falls below a threshold (e.g. 7 days)
2. <strong>Profit-based:</strong> You have captured a target percentage of max profit (e.g. 50%)
3. <strong>Strike-based:</strong> The stock has moved too close to your strike</p>
<p><strong>Roll types:</strong>
| Type | Action | When |
|------|--------|------|
| Roll forward | Same strike, later expiration | Near expiration |
| Roll up | Higher strike, same/later exp | Stock rallying past call |
| Roll down | Lower strike, same/later exp | Stock dropping to put |</p>
<h2>4.2 Adjustment Decision Framework</h2>
<p>The key rule: <strong>always try to roll for a net credit</strong> when possible.</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">OptionPosition</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A live option position for tracking.&quot;&quot;&quot;</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;call&#39; or &#39;put&#39;</span>
    <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">expiration</span><span class="p">:</span> <span class="nb">str</span>   <span class="c1"># YYYY-MM-DD</span>
    <span class="n">premium</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>     <span class="c1"># negative = short</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_short</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">&lt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">days_to_expiration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expiration</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">((</span><span class="n">exp</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PositionManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manage open option positions with roll detection and tracking.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        positions: List of open OptionPosition instances</span>
<span class="sd">        history: Action history log</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OptionPosition</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="n">OptionPosition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a new position.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()),</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;OPEN&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">option_type</span><span class="p">,</span>
            <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span>
            <span class="s1">&#39;premium&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">premium</span><span class="p">,</span>
            <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">close_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">close_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close a position at a given premium.&quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">premium</span> <span class="o">-</span> <span class="n">close_premium</span><span class="p">)</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pos</span><span class="o">.</span><span class="n">is_short</span><span class="p">:</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="o">-</span><span class="n">pnl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()),</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;CLOSE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">option_type</span><span class="p">,</span>
            <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span>
            <span class="s1">&#39;close_premium&#39;</span><span class="p">:</span> <span class="n">close_premium</span><span class="p">,</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">check_rolls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                    <span class="n">dte_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
                    <span class="n">profit_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check all positions for roll candidates.</span>

<span class="sd">        Args:</span>
<span class="sd">            current_prices: Dict of symbol -&gt; current price</span>
<span class="sd">            dte_threshold: Roll if DTE below this</span>
<span class="sd">            profit_threshold: Roll if profit exceeds this fraction</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of dicts with roll recommendations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">):</span>
            <span class="n">dte</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">days_to_expiration</span><span class="p">()</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">current_prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">proximity</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">price</span> <span class="o">-</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span><span class="p">)</span> <span class="o">/</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span> <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span> <span class="k">else</span> <span class="mi">1</span>

            <span class="n">reasons</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">dte</span> <span class="o">&lt;=</span> <span class="n">dte_threshold</span><span class="p">:</span>
                <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DTE=</span><span class="si">{</span><span class="n">dte</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Roll forward&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">proximity</span> <span class="o">&lt;</span> <span class="mf">0.02</span> <span class="ow">and</span> <span class="n">pos</span><span class="o">.</span><span class="n">is_short</span><span class="p">:</span>
                <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Strike proximity </span><span class="si">{</span><span class="n">proximity</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
                    <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Roll up&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Roll down&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">reasons</span><span class="p">:</span>
                <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">option_type</span><span class="p">,</span> <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span>
                    <span class="s1">&#39;dte&#39;</span><span class="p">:</span> <span class="n">dte</span><span class="p">,</span> <span class="s1">&#39;reasons&#39;</span><span class="p">:</span> <span class="n">reasons</span><span class="p">,</span>
                    <span class="s1">&#39;suggested_actions&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="p">,</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="n">recommendations</span>

    <span class="k">def</span> <span class="nf">portfolio_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a summary of all open positions.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">option_type</span><span class="p">,</span>
            <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="s1">&#39;exp&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">expiration</span><span class="p">,</span>
            <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="s1">&#39;premium&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">premium</span><span class="p">,</span>
            <span class="s1">&#39;dte&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">days_to_expiration</span><span class="p">(),</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>


<span class="c1"># Demo</span>
<span class="n">pm</span> <span class="o">=</span> <span class="n">PositionManager</span><span class="p">()</span>
<span class="n">pm</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">OptionPosition</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="s1">&#39;2025-03-21&#39;</span><span class="p">,</span> <span class="mf">3.50</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">pm</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">OptionPosition</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="s1">&#39;2025-03-21&#39;</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">pm</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span><span class="n">OptionPosition</span><span class="p">(</span><span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">520</span><span class="p">,</span> <span class="s1">&#39;2025-02-14&#39;</span><span class="p">,</span> <span class="mf">8.00</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current Positions:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">portfolio_summary</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="n">recs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">check_rolls</span><span class="p">({</span><span class="s1">&#39;AAPL&#39;</span><span class="p">:</span> <span class="mi">192</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">:</span> <span class="mi">518</span><span class="p">},</span> <span class="n">dte_threshold</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Roll Recommendations:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> K=$</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;DTE=</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;dte&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;reasons&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;suggested_actions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 12.4: Adjustment Advisor (Open-ended)</h3>
<p>Build a function that recommends specific adjustments for different
position types based on market conditions.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.4: Adjustment Advisor (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a function that:</span>
<span class="c1"># - Takes a position type (&#39;covered_call&#39;, &#39;bull_put_spread&#39;, &#39;iron_condor&#39;)</span>
<span class="c1"># - Takes current P&amp;L %, DTE, and stock position relative to strikes</span>
<span class="c1"># - Returns a recommendation: hold, close, roll forward/up/down</span>
<span class="c1"># - Includes urgency level (low, medium, high)</span>
<span class="c1"># - Explains the reasoning behind the recommendation</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">adjustment_advisor</span><span class="p">(</span><span class="n">position_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pnl_pct</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">dte</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stock_vs_strike</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="c1"># Profit target</span>
    <span class="k">if</span> <span class="n">pnl_pct</span> <span class="o">&gt;=</span> <span class="mf">0.50</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;Close for profit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Reached </span><span class="si">{</span><span class="n">pnl_pct</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">% of max&#39;</span><span class="p">,</span>
                <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">}</span>

    <span class="c1"># Near expiration</span>
    <span class="k">if</span> <span class="n">dte</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;Roll forward or close&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Only </span><span class="si">{</span><span class="n">dte</span><span class="si">}</span><span class="s1"> DTE&#39;</span><span class="p">,</span> <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">}</span>

    <span class="c1"># Position-specific</span>
    <span class="k">if</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s1">&#39;covered_call&#39;</span> <span class="ow">and</span> <span class="n">stock_vs_strike</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;Roll call up and out&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Stock above call strike&#39;</span><span class="p">,</span> <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s1">&#39;bull_put_spread&#39;</span> <span class="ow">and</span> <span class="n">stock_vs_strike</span> <span class="o">==</span> <span class="s1">&#39;below&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;Roll put spread down&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Stock below short put&#39;</span><span class="p">,</span> <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">position_type</span> <span class="o">==</span> <span class="s1">&#39;iron_condor&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stock_vs_strike</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;Roll call side up&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Upper wing threatened&#39;</span><span class="p">,</span> <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">stock_vs_strike</span> <span class="o">==</span> <span class="s1">&#39;below&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;Roll put side down&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Lower wing threatened&#39;</span><span class="p">,</span> <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;Hold&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Position OK&#39;</span><span class="p">,</span> <span class="s1">&#39;urgency&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">}</span>

<span class="n">scenarios</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;covered_call&#39;</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;between&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;covered_call&#39;</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;above&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;iron_condor&#39;</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;above&#39;</span><span class="p">),</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">pnl</span><span class="p">,</span> <span class="n">dte</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
    <span class="n">advice</span> <span class="o">=</span> <span class="n">adjustment_advisor</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="n">pnl</span><span class="p">,</span> <span class="n">dte</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ptype</span><span class="si">}</span><span class="s2"> PnL=</span><span class="si">{</span><span class="n">pnl</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">+.0f</span><span class="si">}</span><span class="s2">% DTE=</span><span class="si">{</span><span class="n">dte</span><span class="si">}</span><span class="s2"> -&gt; &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">advice</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">advice</span><span class="p">[</span><span class="s1">&#39;urgency&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 12.5: Roll Decision Engine (Guided)</h3>
<p>Complete the function that decides whether and how to roll an option position.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.5: Roll Decision Engine (Guided)</span>

<span class="k">def</span> <span class="nf">roll_decision</span><span class="p">(</span><span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">strike</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">option_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dte</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                  <span class="n">entry_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">current_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">is_short</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decide whether and how to roll an option.</span>

<span class="sd">    Args:</span>
<span class="sd">        current_price: Current stock price</span>
<span class="sd">        strike: Option strike price</span>
<span class="sd">        option_type: &#39;call&#39; or &#39;put&#39;</span>
<span class="sd">        dte: Days to expiration</span>
<span class="sd">        entry_premium: Premium at entry</span>
<span class="sd">        current_premium: Current option premium</span>
<span class="sd">        is_short: True if short the option</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict with should_roll, roll_type, and reason</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate P&amp;L percentage</span>
    <span class="c1"># Short: profit when premium drops -&gt; (entry - current) / entry</span>
    <span class="c1"># Long: profit when premium rises -&gt; (current - entry) / entry</span>
    <span class="k">if</span> <span class="n">is_short</span><span class="p">:</span>
        <span class="n">pnl_pct</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pnl_pct</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="c1"># TODO: Calculate proximity to strike (as fraction)</span>
    <span class="n">proximity</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>

    <span class="c1"># Rule 1: DTE too low</span>
    <span class="k">if</span> <span class="n">dte</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;should_roll&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;roll_type&#39;</span><span class="p">:</span> <span class="s1">&#39;forward&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;DTE=</span><span class="si">{</span><span class="n">dte</span><span class="si">}</span><span class="s1">, expiry imminent&#39;</span><span class="p">}</span>

    <span class="c1"># Rule 2: Profit target (&gt;= 50%)</span>
    <span class="c1"># TODO: Check if pnl_pct &gt;= 0.50 and return roll forward</span>
    <span class="k">pass</span>  <span class="c1"># Replace with if-block</span>

    <span class="c1"># Rule 3: Strike threatened (within 2%)</span>
    <span class="k">if</span> <span class="n">proximity</span> <span class="o">&lt;=</span> <span class="mf">0.02</span> <span class="ow">and</span> <span class="n">is_short</span><span class="p">:</span>
        <span class="c1"># TODO: Roll up for calls, roll down for puts</span>
        <span class="n">roll_type</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Replace with your code</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;should_roll&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;roll_type&#39;</span><span class="p">:</span> <span class="n">roll_type</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Stock within </span><span class="si">{</span><span class="n">proximity</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% of strike&#39;</span><span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;should_roll&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;roll_type&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Position OK&#39;</span><span class="p">}</span>

<span class="c1"># Test (uncomment after completing):</span>
<span class="c1"># print(roll_decision(192, 195, &#39;call&#39;, 5, 3.50, 1.20, True))</span>
<span class="c1"># print(roll_decision(174, 175, &#39;put&#39;, 20, 2.00, 3.50, True))</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">roll_decision</span><span class="p">(</span><span class="n">current_price</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">option_type</span><span class="p">,</span> <span class="n">dte</span><span class="p">,</span>
                  <span class="n">entry_premium</span><span class="p">,</span> <span class="n">current_premium</span><span class="p">,</span> <span class="n">is_short</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_short</span><span class="p">:</span>
        <span class="n">pnl_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry_premium</span> <span class="o">-</span> <span class="n">current_premium</span><span class="p">)</span> <span class="o">/</span> <span class="n">entry_premium</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pnl_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_premium</span> <span class="o">-</span> <span class="n">entry_premium</span><span class="p">)</span> <span class="o">/</span> <span class="n">entry_premium</span>

    <span class="n">proximity</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">strike</span><span class="p">)</span> <span class="o">/</span> <span class="n">strike</span>

    <span class="k">if</span> <span class="n">dte</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;should_roll&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;roll_type&#39;</span><span class="p">:</span> <span class="s1">&#39;forward&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;DTE=</span><span class="si">{</span><span class="n">dte</span><span class="si">}</span><span class="s1">, expiry imminent&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">pnl_pct</span> <span class="o">&gt;=</span> <span class="mf">0.50</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;should_roll&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;roll_type&#39;</span><span class="p">:</span> <span class="s1">&#39;forward&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Profit target reached (</span><span class="si">{</span><span class="n">pnl_pct</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">%)&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">proximity</span> <span class="o">&lt;=</span> <span class="mf">0.02</span> <span class="ow">and</span> <span class="n">is_short</span><span class="p">:</span>
        <span class="n">roll_type</span> <span class="o">=</span> <span class="s1">&#39;up&#39;</span> <span class="k">if</span> <span class="n">option_type</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span> <span class="k">else</span> <span class="s1">&#39;down&#39;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;should_roll&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;roll_type&#39;</span><span class="p">:</span> <span class="n">roll_type</span><span class="p">,</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Stock within </span><span class="si">{</span><span class="n">proximity</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">% of strike&#39;</span><span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;should_roll&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;roll_type&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Position OK&#39;</span><span class="p">}</span>

<span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">3.50</span><span class="p">,</span> <span class="mf">1.20</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">174</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">,</span> <span class="mf">3.50</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">185</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mf">4.00</span><span class="p">,</span> <span class="mf">1.50</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">roll_decision</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;S=$</span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> K=$</span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> DTE=</span><span class="si">{</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Roll=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;should_roll&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;roll_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>


</details></div>
<div class="md-cell exercise-header"><h3>Exercise 12.6: Portfolio Adjustment System (Open-ended)</h3>
<p>Build a comprehensive portfolio adjustment system that evaluates and
simulates rolls for all open positions.</p></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Exercise 12.6: Portfolio Adjustment System (Open-ended)</span>
<span class="c1">#</span>
<span class="c1"># Build a PortfolioAdjuster class that:</span>
<span class="c1"># - Accepts a list of OptionPosition objects and current market prices</span>
<span class="c1"># - Evaluates each position for rolling needs (DTE, P&amp;L, proximity)</span>
<span class="c1"># - Simulates the roll using Black-Scholes (estimate new premium)</span>
<span class="c1"># - Reports: positions needing action, recommended roll, estimated cost</span>
<span class="c1"># - Tracks total credits/debits from all adjustments</span>
<span class="c1">#</span>
<span class="c1"># Your implementation:</span>
</code></pre></div>
<div class="md-cell solution-block"><details>
<summary>Click to see solution</summary>


<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">PortfolioAdjuster</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OptionPosition</span><span class="p">],</span>
                 <span class="n">current_prices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                 <span class="n">vol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">current_prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">evaluate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">):</span>
            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">dte</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">days_to_expiration</span><span class="p">()</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">dte</span> <span class="o">/</span> <span class="mi">365</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">option_type</span><span class="p">)</span>
            <span class="n">current_value</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">is_short</span><span class="p">:</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">premium</span> <span class="o">-</span> <span class="n">current_value</span><span class="p">)</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">pnl_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">premium</span> <span class="o">-</span> <span class="n">current_value</span><span class="p">)</span> <span class="o">/</span> <span class="n">pos</span><span class="o">.</span><span class="n">premium</span> <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">premium</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_value</span> <span class="o">-</span> <span class="n">pos</span><span class="o">.</span><span class="n">premium</span><span class="p">)</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">pnl_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_value</span> <span class="o">-</span> <span class="n">pos</span><span class="o">.</span><span class="n">premium</span><span class="p">)</span> <span class="o">/</span> <span class="n">pos</span><span class="o">.</span><span class="n">premium</span> <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">premium</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="n">decision</span> <span class="o">=</span> <span class="n">roll_decision</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">option_type</span><span class="p">,</span>
                                     <span class="n">dte</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">premium</span><span class="p">,</span> <span class="n">current_value</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">is_short</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">option_type</span><span class="p">,</span>
                <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="s1">&#39;dte&#39;</span><span class="p">:</span> <span class="n">dte</span><span class="p">,</span>
                <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pnl</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;pnl_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">pnl_pct</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;should_roll&#39;</span><span class="p">:</span> <span class="n">decision</span><span class="p">[</span><span class="s1">&#39;should_roll&#39;</span><span class="p">],</span>
                <span class="s1">&#39;roll_type&#39;</span><span class="p">:</span> <span class="n">decision</span><span class="p">[</span><span class="s1">&#39;roll_type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">decision</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">],</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simulate_roll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">new_dte</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                      <span class="n">strike_shift</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">old_T</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">days_to_expiration</span><span class="p">()</span> <span class="o">/</span> <span class="mi">365</span>
        <span class="n">new_strike</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span> <span class="o">+</span> <span class="n">strike_shift</span>
        <span class="n">new_T</span> <span class="o">=</span> <span class="n">new_dte</span> <span class="o">/</span> <span class="mi">365</span>

        <span class="n">old_bs</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="n">old_T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">option_type</span><span class="p">)</span>
        <span class="n">new_bs</span> <span class="o">=</span> <span class="n">black_scholes</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">new_strike</span><span class="p">,</span> <span class="n">new_T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">option_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">is_short</span><span class="p">:</span>
            <span class="n">net</span> <span class="o">=</span> <span class="n">new_bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">old_bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">net</span> <span class="o">=</span> <span class="n">old_bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;old_strike&#39;</span><span class="p">:</span> <span class="n">pos</span><span class="o">.</span><span class="n">strike</span><span class="p">,</span> <span class="s1">&#39;new_strike&#39;</span><span class="p">:</span> <span class="n">new_strike</span><span class="p">,</span>
            <span class="s1">&#39;close_cost&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">old_bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;new_premium&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">new_bs</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;net&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;is_credit&#39;</span><span class="p">:</span> <span class="n">net</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eval_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_all</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PORTFOLIO ADJUSTMENT REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>

        <span class="n">needs</span> <span class="o">=</span> <span class="n">eval_df</span><span class="p">[</span><span class="n">eval_df</span><span class="p">[</span><span class="s1">&#39;should_roll&#39;</span><span class="p">]]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Positions needing action: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">needs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Positions OK: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">eval_df</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">needs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">needs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">needs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> K=$</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;(DTE=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dte&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, PnL=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pnl_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">+.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Reason: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;roll_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span> <span class="k">else</span> <span class="p">(</span>
                    <span class="o">-</span><span class="mi">5</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;roll_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;down&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_roll</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">],</span> <span class="n">strike_shift</span><span class="o">=</span><span class="n">shift</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CREDIT&#39;</span> <span class="k">if</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;is_credit&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;DEBIT&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Sim: K=</span><span class="si">{</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;old_strike&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;new_strike&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;Net </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> $</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>

<span class="n">positions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">OptionPosition</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="s1">&#39;2025-02-20&#39;</span><span class="p">,</span> <span class="mf">3.50</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">OptionPosition</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="s1">&#39;2025-04-18&#39;</span><span class="p">,</span> <span class="mf">2.00</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">OptionPosition</span><span class="p">(</span><span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">520</span><span class="p">,</span> <span class="s1">&#39;2025-02-14&#39;</span><span class="p">,</span> <span class="mf">8.00</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">adjuster</span> <span class="o">=</span> <span class="n">PortfolioAdjuster</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;AAPL&#39;</span><span class="p">:</span> <span class="mi">192</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">:</span> <span class="mi">518</span><span class="p">})</span>
<span class="n">adjuster</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</code></pre></div>


</details></div>
<div class="md-cell module-project"><hr />
<h1>Module Project: Options Trading System</h1>
<p>Build a comprehensive <code>OptionsTradingSystem</code> class that integrates all four
sections into a single automation pipeline:</p>
<ol>
<li><strong>Screen</strong> the universe for opportunities</li>
<li><strong>Select</strong> strategies based on outlook and IV</li>
<li><strong>Simulate</strong> trades using the backtester</li>
<li><strong>Monitor</strong> open positions and recommend adjustments</li>
<li><strong>Report</strong> with a full summary dashboard</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">OptionsTradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    End-to-end options trading automation system.</span>

<span class="sd">    Pipeline: screen -&gt; select -&gt; simulate -&gt; monitor -&gt; report</span>

<span class="sd">    Attributes:</span>
<span class="sd">        symbols: Universe of ticker symbols</span>
<span class="sd">        account_equity: Simulated account size</span>
<span class="sd">        risk_per_trade: Max risk per trade as fraction</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                 <span class="n">account_equity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">,</span>
                 <span class="n">risk_per_trade</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
                 <span class="n">price_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account_equity</span> <span class="o">=</span> <span class="n">account_equity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk_per_trade</span> <span class="o">=</span> <span class="n">risk_per_trade</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span> <span class="o">=</span> <span class="n">price_cache</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screener</span> <span class="o">=</span> <span class="n">OptionsScreener</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">price_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_mgr</span> <span class="o">=</span> <span class="n">PositionManager</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">screen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Screen universe for opportunities.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">screener</span><span class="o">.</span><span class="n">full_screen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">select_strategies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyse each symbol and recommend strategies.&quot;&quot;&quot;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">StrategySelector</span><span class="o">.</span><span class="n">analyze_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strike_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.03</span><span class="p">,</span>
                 <span class="n">dte</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">vol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run covered-call backtest on each symbol.&quot;&quot;&quot;</span>
        <span class="n">summaries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">bt</span> <span class="o">=</span> <span class="n">OptionsBacktester</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">strike_offset</span><span class="p">,</span> <span class="n">dte</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>
            <span class="n">summaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Check all positions for roll needs.&quot;&quot;&quot;</span>
        <span class="n">current_prices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">current_prices</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">price_cache</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_mgr</span><span class="o">.</span><span class="n">check_rolls</span><span class="p">(</span><span class="n">current_prices</span><span class="p">,</span> <span class="n">dte_threshold</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate a comprehensive trading system report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  OPTIONS TRADING SYSTEM ‚Äî COMPREHENSIVE REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Account: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">account_equity</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Risk/Trade: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">risk_per_trade</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Universe: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Screening</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  1. SCREENING&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">screen_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">screen_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">screen_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="c1"># Strategy selection</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  2. STRATEGY RECOMMENDATIONS&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">strat_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_strategies</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">strat_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">strat_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">strats</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;strategies&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;strategies&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;None&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;7</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;9</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;iv_regime&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;5</span><span class="si">}</span><span class="s2"> HV=</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;hv_pct&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&gt;5.1f</span><span class="si">}</span><span class="s2">%  -&gt; </span><span class="si">{</span><span class="n">strats</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Simulation</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  3. COVERED-CALL BACKTEST&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">sim_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sim_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;total_cycles&#39;</span><span class="p">,</span> <span class="s1">&#39;total_pnl&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;avg_cycle_pnl&#39;</span><span class="p">,</span> <span class="s1">&#39;win_rate_pct&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sim_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sim_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="c1"># Positions</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  4. POSITION MONITORING&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="n">pos_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_mgr</span><span class="o">.</span><span class="n">portfolio_summary</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pos_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">pos_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">rolls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rolls</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Roll Recommendations:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rolls</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> K=$</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;-&gt; </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;suggested_actions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  No rolls needed&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  No open positions&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  END OF REPORT&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">70</span><span class="p">)</span>


<span class="c1"># Run the system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">OptionsTradingSystem</span><span class="p">(</span><span class="n">FAANG</span><span class="p">,</span> <span class="n">account_equity</span><span class="o">=</span><span class="mi">100_000</span><span class="p">,</span>
                              <span class="n">price_cache</span><span class="o">=</span><span class="n">price_data</span><span class="p">)</span>

<span class="c1"># Add sample positions for monitoring</span>
<span class="n">system</span><span class="o">.</span><span class="n">position_mgr</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span>
    <span class="n">OptionPosition</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="s1">&#39;2025-03-21&#39;</span><span class="p">,</span> <span class="mf">3.50</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">system</span><span class="o">.</span><span class="n">position_mgr</span><span class="o">.</span><span class="n">add_position</span><span class="p">(</span>
    <span class="n">OptionPosition</span><span class="p">(</span><span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="s1">&#39;2025-02-14&#39;</span><span class="p">,</span> <span class="mf">2.20</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="n">system</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell key-takeaways"><hr />
<h1>Key Takeaways</h1>
<ol>
<li><strong>Options Screening:</strong> Screen for high IV (premium selling), unusual activity (informed flow), and earnings plays (IV crush opportunities). The put/call ratio is a contrarian sentiment indicator</li>
<li><strong>Strategy Selection:</strong> Use the strategy-outlook matrix to map (direction, IV regime) to the right strategy. High IV favours selling premium; low IV favours buying premium</li>
<li><strong>Position Sizing:</strong> Never risk more than 2% of account equity per trade. For defined-risk strategies: contracts = risk budget / max loss per contract</li>
<li><strong>Options Backtesting:</strong> Use Black-Scholes to simulate option prices over historical data. Track P&amp;L, Greeks, and exit reasons across cycles</li>
<li><strong>Rolling &amp; Adjustments:</strong> Roll when DTE is low, profit target is hit, or strike is threatened. Always try to roll for a net credit</li>
<li><strong>Systematic Approach:</strong> Combining screening, selection, backtesting, and monitoring into one system removes emotion and enforces discipline</li>
</ol>
<hr />
<h2>Part 3 Complete!</h2>
<p>You have finished all three modules in <strong>Part 3: Options Trading</strong>:
- Module 10: Options Fundamentals
- Module 11: Options Strategies
- Module 12: Options Automation</p>
<p><strong>Next: Part 4 ‚Äî Automation &amp; Production</strong></p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="13"><div class="md-cell module-header"><h1>Module 13: Paper Trading with Alpaca</h1>
<h2>Part 4: Automation &amp; Production</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ol>
<li>Set up Alpaca paper trading account</li>
<li>Connect to market data streams</li>
<li>Execute orders programmatically</li>
<li>Build a complete trading bot</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Note: Install alpaca-trade-api: pip install alpaca-trade-api</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Alpaca imports (uncomment when you have API keys)</span>
<span class="c1"># from alpaca_trade_api import REST, Stream</span>
<span class="c1"># from alpaca_trade_api.common import URL</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 13: Paper Trading with Alpaca&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h1>Section 1: Alpaca Setup</h1>
<h2>Getting API Keys</h2>
<ol>
<li>Go to https://alpaca.markets</li>
<li>Create free account</li>
<li>Generate Paper Trading API keys</li>
<li>Never commit keys to git!</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Configuration (use environment variables in production!)</span>
<span class="k">class</span> <span class="nc">AlpacaConfig</span><span class="p">:</span>
    <span class="c1"># Replace with your paper trading keys</span>
    <span class="n">API_KEY</span> <span class="o">=</span> <span class="s1">&#39;YOUR_API_KEY&#39;</span>
    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s1">&#39;YOUR_SECRET_KEY&#39;</span>
    <span class="n">BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;https://paper-api.alpaca.markets&#39;</span>  <span class="c1"># Paper trading</span>
    <span class="c1"># BASE_URL = &#39;https://api.alpaca.markets&#39;  # Live trading</span>

<span class="c1"># Mock API for demonstration</span>
<span class="k">class</span> <span class="nc">MockAlpacaAPI</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Mock Alpaca API for learning without real keys.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="mi">100000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">get_account</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;Account&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span>
            <span class="s1">&#39;cash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span><span class="p">,</span>
            <span class="s1">&#39;portfolio_value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s1">&#39;buying_power&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;ACTIVE&#39;</span>
        <span class="p">})()</span>
    
    <span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="n">p</span><span class="p">)()</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No position in </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">list_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="n">p</span><span class="p">)()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    
    <span class="k">def</span> <span class="nf">submit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="n">time_in_force</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">order_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ORD</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">qty</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;filled&#39;</span><span class="p">,</span> <span class="s1">&#39;filled_avg_price&#39;</span><span class="p">:</span> <span class="mf">185.00</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        
        <span class="c1"># Update positions</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;avg_entry_price&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">qty</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">185</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">-=</span> <span class="n">qty</span> <span class="o">*</span> <span class="mi">185</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">qty</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">185</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cash</span> <span class="o">+=</span> <span class="n">qty</span> <span class="o">*</span> <span class="mi">185</span>
        
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;Order&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="n">order</span><span class="p">)()</span>
    
    <span class="k">def</span> <span class="nf">get_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;Order&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="n">o</span><span class="p">)()</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">list_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;Order&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="n">o</span><span class="p">)()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order_id</span><span class="p">:</span>
                <span class="n">o</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cancelled&#39;</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># Use mock API for demonstration</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">MockAlpacaAPI</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mock Alpaca API initialized&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Account Cash: $</span><span class="si">{</span><span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span><span class="o">.</span><span class="n">cash</span><span class="si">:</span><span class="s1">,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h1>Section 2: Market Data</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MarketDataClient</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get market data from Alpaca or yfinance fallback.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_alpaca</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_alpaca</span> <span class="o">=</span> <span class="n">use_alpaca</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_alpaca</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yf</span> <span class="o">=</span> <span class="n">yf</span>
    
    <span class="k">def</span> <span class="nf">get_bars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1D&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get historical bars.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_alpaca</span><span class="p">:</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1y&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="c1"># Alpaca implementation would go here</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current quote.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_alpaca</span><span class="p">:</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">info</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;currentPrice&#39;</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;regularMarketPrice&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s1">&#39;bid&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bid&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s1">&#39;ask&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ask&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">get_quotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get quotes for multiple symbols.&quot;&quot;&quot;</span>
        <span class="n">quotes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">quotes</span><span class="p">)</span>

<span class="n">data_client</span> <span class="o">=</span> <span class="n">MarketDataClient</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;AAPL Quote:&#39;</span><span class="p">,</span> <span class="n">data_client</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 13.1: Real-Time Data Feed (Guided)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">stream_quotes</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stream quotes for specified duration.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement quote streaming</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell"><h1>Section 3: Order Execution</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">OrderManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage order submission and tracking.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api</span>
    
    <span class="k">def</span> <span class="nf">market_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submit market buy order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="n">qty</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="n">time_in_force</span><span class="o">=</span><span class="s1">&#39;day&#39;</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">market_sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submit market sell order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="n">qty</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;sell&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="n">time_in_force</span><span class="o">=</span><span class="s1">&#39;day&#39;</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">limit_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submit limit buy order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="n">qty</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="n">time_in_force</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="n">price</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">limit_sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submit limit sell order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="n">qty</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;sell&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="n">time_in_force</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="n">price</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">bracket_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                      <span class="n">take_profit</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submit bracket order (entry + TP + SL).&quot;&quot;&quot;</span>
        <span class="c1"># Simplified - real implementation uses OCO orders</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_buy</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry</span><span class="p">,</span>
            <span class="s1">&#39;take_profit&#39;</span><span class="p">:</span> <span class="n">take_profit</span><span class="p">,</span>
            <span class="s1">&#39;stop_loss&#39;</span><span class="p">:</span> <span class="n">stop_loss</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_order_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check order status.&quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="k">if</span> <span class="n">order</span> <span class="k">else</span> <span class="s1">&#39;not_found&#39;</span>
    
    <span class="k">def</span> <span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cancel an order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>

<span class="n">orders</span> <span class="o">=</span> <span class="n">OrderManager</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>

<span class="c1"># Test orders</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Submitting market buy...&#39;</span><span class="p">)</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">orders</span><span class="o">.</span><span class="n">market_buy</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Account after buy:&#39;</span><span class="p">)</span>
<span class="n">acct</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Cash: $</span><span class="si">{</span><span class="n">acct</span><span class="o">.</span><span class="n">cash</span><span class="si">:</span><span class="s1">,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Portfolio: $</span><span class="si">{</span><span class="n">acct</span><span class="o">.</span><span class="n">portfolio_value</span><span class="si">:</span><span class="s1">,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 13.2: Order Execution System (Open-ended)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Build a complete order execution system with error handling</span>
</code></pre></div>
<div class="md-cell"><h1>Section 4: Portfolio Management</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PortfolioManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage portfolio positions.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">data_client</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_client</span>
    
    <span class="k">def</span> <span class="nf">get_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get all positions as DataFrame.&quot;&quot;&quot;</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">list_positions</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">positions</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">qty</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">get_account_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get account summary.&quot;&quot;&quot;</span>
        <span class="n">acct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;cash&#39;</span><span class="p">:</span> <span class="n">acct</span><span class="o">.</span><span class="n">cash</span><span class="p">,</span>
            <span class="s1">&#39;portfolio_value&#39;</span><span class="p">:</span> <span class="n">acct</span><span class="o">.</span><span class="n">portfolio_value</span><span class="p">,</span>
            <span class="s1">&#39;buying_power&#39;</span><span class="p">:</span> <span class="n">acct</span><span class="o">.</span><span class="n">buying_power</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">calculate_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate current portfolio allocation.&quot;&quot;&quot;</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">positions</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">positions</span>
        
        <span class="n">total</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span><span class="o">.</span><span class="n">cash</span>
        <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;allocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">positions</span>
    
    <span class="k">def</span> <span class="nf">rebalance_to_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Rebalance to target allocations.&quot;&quot;&quot;</span>
        <span class="n">acct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
        <span class="n">total_value</span> <span class="o">=</span> <span class="n">acct</span><span class="o">.</span><span class="n">portfolio_value</span>
        
        <span class="n">orders_to_place</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">target_pct</span> <span class="ow">in</span> <span class="n">targets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">target_value</span> <span class="o">=</span> <span class="n">total_value</span> <span class="o">*</span> <span class="n">target_pct</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">quote</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
            
            <span class="n">target_qty</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_value</span> <span class="o">/</span> <span class="n">price</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">current_qty</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">qty</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">current_qty</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">diff</span> <span class="o">=</span> <span class="n">target_qty</span> <span class="o">-</span> <span class="n">current_qty</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">orders_to_place</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                    <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span>
                    <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="s1">&#39;buy&#39;</span> <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;sell&#39;</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">orders_to_place</span>

<span class="n">portfolio</span> <span class="o">=</span> <span class="n">PortfolioManager</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">data_client</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Account Summary:&#39;</span><span class="p">,</span> <span class="n">portfolio</span><span class="o">.</span><span class="n">get_account_summary</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Positions:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">portfolio</span><span class="o">.</span><span class="n">get_positions</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 13.3: Portfolio Dashboard (Guided)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">create_portfolio_dashboard</span><span class="p">(</span><span class="n">portfolio_manager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create portfolio monitoring dashboard.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Build comprehensive dashboard</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell module-project"><h1>Module Project: Complete Trading Bot</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SimpleTradingBot</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simple momentum-based trading bot.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">data_client</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">api</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="n">OrderManager</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span> <span class="o">=</span> <span class="n">PortfolioManager</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">data_client</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Calculate trading signals for all symbols.&quot;&quot;&quot;</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="n">bars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_bars</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bars</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">signals</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
                <span class="k">continue</span>
            
            <span class="n">close</span> <span class="o">=</span> <span class="n">bars</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="n">sma20</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sma50</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span> <span class="k">else</span> <span class="n">sma20</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">sma20</span> <span class="o">&gt;</span> <span class="n">sma50</span><span class="p">:</span>
                <span class="n">signals</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;buy&#39;</span>
            <span class="k">elif</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">sma20</span> <span class="o">&lt;</span> <span class="n">sma50</span><span class="p">:</span>
                <span class="n">signals</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sell&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signals</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="k">return</span> <span class="n">signals</span>
    
    <span class="k">def</span> <span class="nf">execute_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">position_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute trading signals.&quot;&quot;&quot;</span>
        <span class="n">acct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
        <span class="n">available</span> <span class="o">=</span> <span class="n">acct</span><span class="o">.</span><span class="n">cash</span> <span class="o">*</span> <span class="n">position_size</span>
        
        <span class="n">executed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">signal</span> <span class="o">==</span> <span class="s1">&#39;neutral&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">quote</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
            <span class="n">qty</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">available</span> <span class="o">/</span> <span class="n">price</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">qty</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="n">signal</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">market_buy</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>
                <span class="n">executed</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">qty</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">signal</span> <span class="o">==</span> <span class="s1">&#39;sell&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">qty</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">market_sell</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">qty</span><span class="p">,</span> <span class="n">pos</span><span class="o">.</span><span class="n">qty</span><span class="p">))</span>
                        <span class="n">executed</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">qty</span><span class="p">})</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
        
        <span class="k">return</span> <span class="n">executed</span>
    
    <span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run one iteration of the bot.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Trading Bot Run: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">1. Calculating signals...&#39;</span><span class="p">)</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_signals</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">signals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">sig</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">2. Executing signals...&#39;</span><span class="p">)</span>
        <span class="n">executed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_signals</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">executed</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">3. Portfolio status:&#39;</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span><span class="o">.</span><span class="n">get_account_summary</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cash: $</span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;cash&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Portfolio: $</span><span class="si">{</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;portfolio_value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># Run the bot</span>
<span class="n">bot</span> <span class="o">=</span> <span class="n">SimpleTradingBot</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">data_client</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">])</span>
<span class="n">bot</span><span class="o">.</span><span class="n">run_once</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 13.4-13.6</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># 13.4: Stop Loss Implementation (Guided)</span>
<span class="c1"># 13.5: Multi-Strategy Bot (Open-ended)</span>
<span class="c1"># 13.6: Paper Trading Competition (Open-ended)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><h1>Key Takeaways</h1>
<ol>
<li>Alpaca provides free paper trading API</li>
<li>Always test with paper trading first</li>
<li>Handle errors gracefully</li>
<li>Monitor positions continuously</li>
</ol>
<p><strong>Next:</strong> SEC Filings &amp; Alt Data</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="14"><div class="md-cell module-header"><h1>Module 14: SEC Filings &amp; Alternative Data</h1>
<h2>Part 4: Automation &amp; Production</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ol>
<li>Access and parse SEC EDGAR filings</li>
<li>Extract insider trading signals</li>
<li>Analyze news sentiment</li>
<li>Incorporate social media signals</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">FAANG</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NFLX&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 14: SEC Filings &amp; Alternative Data&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h1>Section 1: SEC EDGAR Database</h1>
<h2>Key Filing Types</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Form</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>10-K</td>
<td>Annual report</td>
</tr>
<tr>
<td>10-Q</td>
<td>Quarterly report</td>
</tr>
<tr>
<td>8-K</td>
<td>Current events</td>
</tr>
<tr>
<td>4</td>
<td>Insider trading</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SECEdgar</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Access SEC EDGAR filings.&quot;&quot;&quot;</span>
    
    <span class="n">BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;https://www.sec.gov&#39;</span>
    <span class="n">SEARCH_URL</span> <span class="o">=</span> <span class="s1">&#39;https://efts.sec.gov/LATEST/search-index&#39;</span>
    
    <span class="c1"># CIK lookup for common companies</span>
    <span class="n">CIK_MAP</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;AAPL&#39;</span><span class="p">:</span> <span class="s1">&#39;0000320193&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MSFT&#39;</span><span class="p">:</span> <span class="s1">&#39;0000789019&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GOOGL&#39;</span><span class="p">:</span> <span class="s1">&#39;0001652044&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AMZN&#39;</span><span class="p">:</span> <span class="s1">&#39;0001018724&#39;</span><span class="p">,</span>
        <span class="s1">&#39;META&#39;</span><span class="p">:</span> <span class="s1">&#39;0001326801&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NFLX&#39;</span><span class="p">:</span> <span class="s1">&#39;0001065280&#39;</span>
    <span class="p">}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Educational Research contact@example.com&#39;</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_cik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get CIK number for a symbol.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIK_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_filings_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">form_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;10-K&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get list of filings for a company.&quot;&quot;&quot;</span>
        <span class="n">cik</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cik</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cik</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="c1"># Using SEC&#39;s submissions endpoint</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/cgi-bin/browse-edgar?action=getcompany&amp;CIK=</span><span class="si">{</span><span class="n">cik</span><span class="si">}</span><span class="s1">&amp;type=</span><span class="si">{</span><span class="n">form_type</span><span class="si">}</span><span class="s1">&amp;dateb=&amp;owner=include&amp;count=</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">&amp;output=atom&#39;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># For demo, return mock data</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mock_filings</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">form_type</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">_mock_filings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">form_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate mock filing data for demonstration.&quot;&quot;&quot;</span>
        <span class="n">filings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">base_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">form_type</span> <span class="o">==</span> <span class="s1">&#39;10-K&#39;</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">base_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">form_type</span> <span class="o">==</span> <span class="s1">&#39;10-Q&#39;</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">base_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">base_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
            
            <span class="n">filings</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;form_type&#39;</span><span class="p">:</span> <span class="n">form_type</span><span class="p">,</span>
                <span class="s1">&#39;filing_date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="s1">&#39;accession_number&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;0001234567-</span><span class="si">{</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s1">06d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s1">/Archives/edgar/data/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cik</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="si">}</span><span class="s1">/...&#39;</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">filings</span>

<span class="n">sec</span> <span class="o">=</span> <span class="n">SECEdgar</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recent 10-K Filings for AAPL:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sec</span><span class="o">.</span><span class="n">get_filings_list</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;10-K&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;filing_date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;form_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Recent 10-Q Filings for AAPL:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sec</span><span class="o">.</span><span class="n">get_filings_list</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;10-Q&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;filing_date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;form_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 14.1: Filing Downloader (Guided)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">download_10k</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Download 10-K filing text.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Fetch and parse 10-K filing</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell"><h1>Section 2: Insider Trading Data</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">InsiderTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track insider trading from Form 4 filings.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sec</span> <span class="o">=</span> <span class="n">SECEdgar</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_insider_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get recent insider trades.&quot;&quot;&quot;</span>
        <span class="c1"># Mock data for demonstration</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">base_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="n">insiders</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;CEO&#39;</span><span class="p">,</span> <span class="s1">&#39;John Smith&#39;</span><span class="p">,</span> <span class="mi">50000</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;CFO&#39;</span><span class="p">,</span> <span class="s1">&#39;Jane Doe&#39;</span><span class="p">,</span> <span class="mi">25000</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;Director&#39;</span><span class="p">,</span> <span class="s1">&#39;Bob Wilson&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;VP Sales&#39;</span><span class="p">,</span> <span class="s1">&#39;Alice Brown&#39;</span><span class="p">,</span> <span class="mi">15000</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">shares</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">insiders</span><span class="p">):</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">base_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">days</span><span class="p">))</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;Buy&#39;</span><span class="p">,</span> <span class="s1">&#39;Sell&#39;</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
            <span class="n">qty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">shares</span><span class="p">)</span>
            <span class="n">price</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span> <span class="o">*</span> <span class="mi">5</span>
            
            <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;insider&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                <span class="s1">&#39;transaction_date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                <span class="s1">&#39;shares&#39;</span><span class="p">:</span> <span class="n">qty</span><span class="p">,</span>
                <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">qty</span> <span class="o">*</span> <span class="n">price</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;transaction_date&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate insider trading signals.&quot;&quot;&quot;</span>
        <span class="n">trades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_insider_trades</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trades</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        
        <span class="n">buys</span> <span class="o">=</span> <span class="n">trades</span><span class="p">[</span><span class="n">trades</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Buy&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">sells</span> <span class="o">=</span> <span class="n">trades</span><span class="p">[</span><span class="n">trades</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Sell&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
        <span class="n">net</span> <span class="o">=</span> <span class="n">buys</span> <span class="o">-</span> <span class="n">sells</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">buys</span> <span class="o">+</span> <span class="n">sells</span>
        
        <span class="k">if</span> <span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">net</span> <span class="o">/</span> <span class="n">total</span>
        
        <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;total_buys&#39;</span><span class="p">:</span> <span class="n">buys</span><span class="p">,</span>
            <span class="s1">&#39;total_sells&#39;</span><span class="p">:</span> <span class="n">sells</span><span class="p">,</span>
            <span class="s1">&#39;net&#39;</span><span class="p">:</span> <span class="n">net</span>
        <span class="p">}</span>

<span class="n">insider</span> <span class="o">=</span> <span class="n">InsiderTracker</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;AAPL Insider Trades:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">insider</span><span class="o">.</span><span class="n">get_insider_trades</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Insider Signal:&#39;</span><span class="p">,</span> <span class="n">insider</span><span class="o">.</span><span class="n">calculate_signals</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 14.2: Insider Activity Scanner (Open-ended)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Scan multiple stocks for insider activity patterns</span>
</code></pre></div>
<div class="md-cell"><h1>Section 3: News Sentiment</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">NewsSentimentAnalyzer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze news sentiment for stocks.&quot;&quot;&quot;</span>
    
    <span class="c1"># Simple word lists for sentiment</span>
    <span class="n">POSITIVE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;beat&#39;</span><span class="p">,</span> <span class="s1">&#39;exceeds&#39;</span><span class="p">,</span> <span class="s1">&#39;growth&#39;</span><span class="p">,</span> <span class="s1">&#39;profit&#39;</span><span class="p">,</span> <span class="s1">&#39;surge&#39;</span><span class="p">,</span> <span class="s1">&#39;rally&#39;</span><span class="p">,</span> <span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;strong&#39;</span><span class="p">,</span> <span class="s1">&#39;record&#39;</span><span class="p">,</span> <span class="s1">&#39;breakthrough&#39;</span><span class="p">,</span> <span class="s1">&#39;innovation&#39;</span><span class="p">]</span>
    <span class="n">NEGATIVE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;miss&#39;</span><span class="p">,</span> <span class="s1">&#39;decline&#39;</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="s1">&#39;fall&#39;</span><span class="p">,</span> <span class="s1">&#39;downgrade&#39;</span><span class="p">,</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span>
                <span class="s1">&#39;weak&#39;</span><span class="p">,</span> <span class="s1">&#39;concern&#39;</span><span class="p">,</span> <span class="s1">&#39;risk&#39;</span><span class="p">,</span> <span class="s1">&#39;lawsuit&#39;</span><span class="p">,</span> <span class="s1">&#39;investigation&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">score_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Score text sentiment (-1 to 1).&quot;&quot;&quot;</span>
        <span class="n">text_lower</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">text_lower</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        
        <span class="n">pos_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span> <span class="ow">in</span> <span class="n">w</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">POSITIVE</span><span class="p">))</span>
        <span class="n">neg_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">n</span> <span class="ow">in</span> <span class="n">w</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">NEGATIVE</span><span class="p">))</span>
        
        <span class="n">total</span> <span class="o">=</span> <span class="n">pos_count</span> <span class="o">+</span> <span class="n">neg_count</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">pos_count</span> <span class="o">-</span> <span class="n">neg_count</span><span class="p">)</span> <span class="o">/</span> <span class="n">total</span>
    
    <span class="k">def</span> <span class="nf">get_mock_news</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate mock news for demonstration.&quot;&quot;&quot;</span>
        <span class="n">headlines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> beats earnings expectations with strong growth&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> announces new product breakthrough&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Analyst upgrades </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> on bullish outlook&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> faces regulatory concerns&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> stock rallies on innovation news&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Investors worry about </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> competition risk&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> reports record quarterly profit&#39;</span>
        <span class="p">]</span>
        
        <span class="n">news</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">headlines</span><span class="p">))):</span>
            <span class="n">headline</span> <span class="o">=</span> <span class="n">headlines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">news</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;headline&#39;</span><span class="p">:</span> <span class="n">headline</span><span class="p">,</span>
                <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_text</span><span class="p">(</span><span class="n">headline</span><span class="p">)</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">news</span>
    
    <span class="k">def</span> <span class="nf">analyze_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Analyze news sentiment for a symbol.&quot;&quot;&quot;</span>
        <span class="n">news</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mock_news</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">news</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">}</span>
        
        <span class="n">avg_sentiment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">news</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">avg_sentiment</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">avg_sentiment</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">avg_sentiment</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;news_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">news</span><span class="p">)</span>
        <span class="p">}</span>

<span class="n">sentiment</span> <span class="o">=</span> <span class="n">NewsSentimentAnalyzer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;AAPL News Analysis:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">news</span> <span class="ow">in</span> <span class="n">sentiment</span><span class="o">.</span><span class="n">get_mock_news</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">news</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">news</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">+.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">news</span><span class="p">[</span><span class="s1">&#39;headline&#39;</span><span class="p">][:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Overall:&#39;</span><span class="p">,</span> <span class="n">sentiment</span><span class="o">.</span><span class="n">analyze_symbol</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 14.3: News Aggregator (Guided)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">aggregate_news_sentiment</span><span class="p">(</span><span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Aggregate sentiment across multiple symbols.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Build multi-symbol news aggregator</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell"><h1>Section 4: Social Media Signals</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SocialSentiment</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze social media sentiment.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">news_analyzer</span> <span class="o">=</span> <span class="n">NewsSentimentAnalyzer</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">get_mock_reddit_mentions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Mock Reddit/WSB mentions.&quot;&quot;&quot;</span>
        <span class="n">posts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> to the moon! üöÄ&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Just bought more </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">, bullish AF&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> earnings play - expecting beat&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Anyone worried about </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> competition?&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> chart looking strong&#39;</span>
        <span class="p">]</span>
        
        <span class="n">mentions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">post</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">posts</span><span class="p">):</span>
            <span class="n">mentions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;reddit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">post</span><span class="p">,</span>
                <span class="s1">&#39;upvotes&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
                <span class="s1">&#39;sentiment&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">news_analyzer</span><span class="o">.</span><span class="n">score_text</span><span class="p">(</span><span class="n">post</span><span class="p">),</span>
                <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">i</span><span class="o">*</span><span class="mi">6</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">mentions</span>
    
    <span class="k">def</span> <span class="nf">calculate_social_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate social sentiment score.&quot;&quot;&quot;</span>
        <span class="n">mentions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mock_reddit_mentions</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mentions</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">}</span>
        
        <span class="c1"># Weight by upvotes</span>
        <span class="n">total_upvotes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;upvotes&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mentions</span><span class="p">)</span>
        <span class="n">weighted_sentiment</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;upvotes&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mentions</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_upvotes</span>
        
        <span class="n">mention_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mentions</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">weighted_sentiment</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bullish&#39;</span>
        <span class="k">elif</span> <span class="n">weighted_sentiment</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;bearish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;neutral&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">weighted_sentiment</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
            <span class="s1">&#39;mention_count&#39;</span><span class="p">:</span> <span class="n">mention_count</span><span class="p">,</span>
            <span class="s1">&#39;total_engagement&#39;</span><span class="p">:</span> <span class="n">total_upvotes</span>
        <span class="p">}</span>

<span class="n">social</span> <span class="o">=</span> <span class="n">SocialSentiment</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Social Media Analysis for AAPL:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">social</span><span class="o">.</span><span class="n">calculate_social_score</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="md-cell module-project"><h1>Module Project: Alt Data Dashboard</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">AltDataDashboard</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Combine all alternative data sources.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sec</span> <span class="o">=</span> <span class="n">SECEdgar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insider</span> <span class="o">=</span> <span class="n">InsiderTracker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">news</span> <span class="o">=</span> <span class="n">NewsSentimentAnalyzer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">social</span> <span class="o">=</span> <span class="n">SocialSentiment</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">analyze_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Complete alt data analysis for one symbol.&quot;&quot;&quot;</span>
        <span class="n">insider_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insider</span><span class="o">.</span><span class="n">calculate_signals</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">news_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">news</span><span class="o">.</span><span class="n">analyze_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">social_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">social</span><span class="o">.</span><span class="n">calculate_social_score</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        
        <span class="c1"># Combine signals</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">insider_signal</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span>
            <span class="n">news_signal</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">],</span>
            <span class="n">social_signal</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">combined</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;BULLISH&#39;</span>
        <span class="k">elif</span> <span class="n">combined</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;BEARISH&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">overall</span> <span class="o">=</span> <span class="s1">&#39;NEUTRAL&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;insider&#39;</span><span class="p">:</span> <span class="n">insider_signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span>
            <span class="s1">&#39;news&#39;</span><span class="p">:</span> <span class="n">news_signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span>
            <span class="s1">&#39;social&#39;</span><span class="p">:</span> <span class="n">social_signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span>
            <span class="s1">&#39;combined_score&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="s1">&#39;overall&#39;</span><span class="p">:</span> <span class="n">overall</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate complete alt data report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ALTERNATIVE DATA DASHBOARD&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analysis</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Insider: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;insider&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  News: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;news&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Social: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;social&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Combined: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;combined_score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">+.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Overall: </span><span class="si">{</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;overall&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="n">dashboard</span> <span class="o">=</span> <span class="n">AltDataDashboard</span><span class="p">(</span><span class="n">FAANG</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">dashboard</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 14.4-14.6</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># 14.4: Earnings Transcript Analyzer (Guided)</span>
<span class="c1"># 14.5: Real-time Social Monitor (Open-ended)</span>
<span class="c1"># 14.6: Alt Data Trading Strategy (Open-ended)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><h1>Key Takeaways</h1>
<ol>
<li>SEC EDGAR provides free access to filings</li>
<li>Insider trading can signal future moves</li>
<li>News sentiment adds context to price action</li>
<li>Social media provides real-time sentiment</li>
</ol>
<p><strong>Next:</strong> Automation &amp; Monitoring</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="15"><div class="md-cell module-header"><h1>Module 15: Automation &amp; Monitoring</h1>
<h2>Part 4: Automation &amp; Production</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ol>
<li>Schedule trading tasks around market hours</li>
<li>Build alert and notification systems</li>
<li>Implement logging and monitoring</li>
<li>Deploy to cloud infrastructure</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">time_module</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 15: Automation &amp; Monitoring&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h1>Section 1: Market Hours Scheduling</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">MarketScheduler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Schedule tasks around market hours.&quot;&quot;&quot;</span>
    
    <span class="c1"># US Eastern Time</span>
    <span class="n">MARKET_OPEN</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">MARKET_CLOSE</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">PRE_MARKET_START</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">AFTER_HOURS_END</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">is_market_open</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if market is currently open.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">weekday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
        
        <span class="c1"># Weekend check</span>
        <span class="k">if</span> <span class="n">weekday</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">MARKET_OPEN</span> <span class="o">&lt;=</span> <span class="n">now</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MARKET_CLOSE</span>
    
    <span class="k">def</span> <span class="nf">time_to_open</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Time until market opens.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">today_open</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MARKET_OPEN</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">today_open</span> <span class="o">-</span> <span class="n">now</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Next trading day</span>
            <span class="n">next_day</span> <span class="o">=</span> <span class="n">today_open</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">next_day</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">next_day</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">next_day</span> <span class="o">-</span> <span class="n">now</span>
    
    <span class="k">def</span> <span class="nf">time_to_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Time until market closes.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">today_close</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_market_open</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">today_close</span> <span class="o">-</span> <span class="n">now</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">add_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_time</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a scheduled task.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">run_time</span><span class="p">,</span>
            <span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
            <span class="s1">&#39;last_run&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">check_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check and run due tasks.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">now</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">task</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">now</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running task: </span><span class="si">{</span><span class="n">task</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">task</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]()</span>
                    <span class="n">task</span><span class="p">[</span><span class="s1">&#39;last_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>

<span class="n">scheduler</span> <span class="o">=</span> <span class="n">MarketScheduler</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Market Open: </span><span class="si">{</span><span class="n">scheduler</span><span class="o">.</span><span class="n">is_market_open</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time to Open: </span><span class="si">{</span><span class="n">scheduler</span><span class="o">.</span><span class="n">time_to_open</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time to Close: </span><span class="si">{</span><span class="n">scheduler</span><span class="o">.</span><span class="n">time_to_close</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 15.1: Pre-Market Routine (Guided)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">create_premarket_routine</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create pre-market analysis routine.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement pre-market checks</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell"><h1>Section 2: Alerts &amp; Notifications</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">AlertSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Multi-channel alert system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;console&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_console_alert</span><span class="p">,</span>
            <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_alert</span><span class="p">,</span>
            <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_alert</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">_console_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print alert to console.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üö® [</span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_log_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log alert using logging module.&quot;&quot;&quot;</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">alert</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_file_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write alert to file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;alerts.log&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">alert</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">channels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send alert through specified channels.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;console&#39;</span><span class="p">]</span>
        
        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">level</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alert</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">channel</span><span class="p">](</span><span class="n">alert</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">price_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send price threshold alert.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;above&#39;</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> Price Alert&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> is now $</span><span class="si">{</span><span class="n">current</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> (above $</span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;warning&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;below&#39;</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> Price Alert&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> is now $</span><span class="si">{</span><span class="n">current</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> (below $</span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;warning&#39;</span>
            <span class="p">)</span>

<span class="n">alerts</span> <span class="o">=</span> <span class="n">AlertSystem</span><span class="p">()</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;System&#39;</span><span class="p">,</span> <span class="s1">&#39;Trading bot started&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">price_alert</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="s1">&#39;above&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PriceMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor prices and trigger alerts.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alert_system</span><span class="p">:</span> <span class="n">AlertSystem</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="n">alert_system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">watchlist</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">add_watch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">pct_change</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add symbol to watchlist.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">watchlist</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">low</span><span class="p">,</span>
            <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">high</span><span class="p">,</span>
            <span class="s1">&#39;pct_change&#39;</span><span class="p">:</span> <span class="n">pct_change</span><span class="p">,</span>
            <span class="s1">&#39;last_price&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;triggered&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check price against thresholds.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">watchlist</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">watch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">watchlist</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        
        <span class="c1"># High threshold</span>
        <span class="k">if</span> <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&gt;=</span> <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;high&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> High Alert&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;Price $</span><span class="si">{</span><span class="n">current_price</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> reached high of $</span><span class="si">{</span><span class="n">watch</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;warning&#39;</span>
                <span class="p">)</span>
                <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;high&#39;</span><span class="p">)</span>
        
        <span class="c1"># Low threshold</span>
        <span class="k">if</span> <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current_price</span> <span class="o">&lt;=</span> <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;low&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> Low Alert&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;Price $</span><span class="si">{</span><span class="n">current_price</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> hit low of $</span><span class="si">{</span><span class="n">watch</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;critical&#39;</span>
                <span class="p">)</span>
                <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;triggered&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;low&#39;</span><span class="p">)</span>
        
        <span class="c1"># Percent change</span>
        <span class="k">if</span> <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;pct_change&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;last_price&#39;</span><span class="p">]:</span>
            <span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_price</span> <span class="o">-</span> <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;last_price&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;last_price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;pct_change&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1"> Move Alert&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;Price moved </span><span class="si">{</span><span class="n">change</span><span class="si">:</span><span class="s1">+.1f</span><span class="si">}</span><span class="s1">% to $</span><span class="si">{</span><span class="n">current_price</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;info&#39;</span>
                <span class="p">)</span>
        
        <span class="n">watch</span><span class="p">[</span><span class="s1">&#39;last_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_price</span>

<span class="n">monitor</span> <span class="o">=</span> <span class="n">PriceMonitor</span><span class="p">(</span><span class="n">alerts</span><span class="p">)</span>
<span class="n">monitor</span><span class="o">.</span><span class="n">add_watch</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mi">175</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">195</span><span class="p">,</span> <span class="n">pct_change</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">monitor</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="mi">196</span><span class="p">)</span>  <span class="c1"># Should trigger high alert</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 15.2: Telegram Alert Bot (Open-ended)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Build Telegram notification integration</span>
</code></pre></div>
<div class="md-cell"><h1>Section 3: Logging &amp; Monitoring</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TradingLogger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Comprehensive trading logger.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;trading_bot&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        
        <span class="c1"># Console handler</span>
        <span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> | </span><span class="si">%(levelname)-8s</span><span class="s1"> | </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
        
        <span class="c1"># Trade log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log a trade.&quot;&quot;&quot;</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
            <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">qty</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">qty</span> <span class="o">*</span> <span class="n">price</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRADE: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">qty</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> @ $</span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span> <span class="ne">Exception</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log an error.&quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;exception&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span> <span class="k">if</span> <span class="n">exception</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">confidence</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log a trading signal.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SIGNAL: </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">signal</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> (conf: </span><span class="si">{</span><span class="n">confidence</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pnl</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">trades_today</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log performance summary.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PERF: P&amp;L $</span><span class="si">{</span><span class="n">pnl</span><span class="si">:</span><span class="s2">+.2f</span><span class="si">}</span><span class="s2"> | Trades: </span><span class="si">{</span><span class="n">trades_today</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_trade_log</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get trade log as DataFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">TradingLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">trade</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">185.50</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">performance</span><span class="p">(</span><span class="mf">1250.00</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SystemHealthMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Monitor trading system health.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;uptime_start&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s1">&#39;api_calls&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;api_errors&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;orders_placed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;orders_filled&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;last_heartbeat&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record heartbeat.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;last_heartbeat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">record_api_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record API call.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;api_calls&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;api_errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">record_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record order.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;orders_placed&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">filled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;orders_filled&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get system status.&quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">uptime</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;uptime_start&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;healthy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;uptime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uptime</span><span class="p">),</span>
            <span class="s1">&#39;api_success_rate&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;api_errors&#39;</span><span class="p">]</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;api_calls&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;fill_rate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;orders_filled&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;orders_placed&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;last_heartbeat&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;last_heartbeat&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print health report.&quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">System Health Report&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">health</span> <span class="o">=</span> <span class="n">SystemHealthMonitor</span><span class="p">()</span>
<span class="n">health</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">()</span>
<span class="n">health</span><span class="o">.</span><span class="n">record_api_call</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">health</span><span class="o">.</span><span class="n">record_order</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">health</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 15.3: Performance Tracker (Guided)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">track_daily_performance</span><span class="p">(</span><span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track daily trading performance.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Calculate daily PnL, win rate, etc.</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell"><h1>Section 4: Complete Monitoring System</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TradingMonitoringSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete trading monitoring system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">MarketScheduler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span> <span class="o">=</span> <span class="n">AlertSystem</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">TradingLogger</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">SystemHealthMonitor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">PriceMonitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;System startup routine.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;System&#39;</span><span class="p">,</span> <span class="s1">&#39;Trading system starting...&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;System initialized&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check market status</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">is_market_open</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;Market&#39;</span><span class="p">,</span> <span class="s1">&#39;Market is OPEN&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ttl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">time_to_open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;Market&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Market opens in </span><span class="si">{</span><span class="n">ttl</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">run_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run one monitoring cycle.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">check_tasks</span><span class="p">()</span>
        
        <span class="c1"># Would check prices, run strategies here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">record_api_call</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;System shutdown routine.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alerts</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;System&#39;</span><span class="p">,</span> <span class="s1">&#39;Trading system shutting down&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">demo_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cycles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Demo run for specified cycles.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TRADING MONITORING SYSTEM DEMO&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">startup</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cycles</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--- Cycle </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1"> ---&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_cycle</span><span class="p">()</span>
            <span class="n">time_module</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">TradingMonitoringSystem</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">demo_run</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 15.4-15.6</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># 15.4: Cloud Deployment Plan (Guided)</span>
<span class="c1"># 15.5: Full Monitoring Dashboard (Open-ended)</span>
<span class="c1"># 15.6: Alert Rules Engine (Open-ended)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><h1>Key Takeaways</h1>
<ol>
<li>Schedule around market hours</li>
<li>Multi-channel alerts for reliability</li>
<li>Log everything for debugging</li>
<li>Monitor system health continuously</li>
</ol>
<p><strong>Next:</strong> Trading Psychology &amp; Journaling</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="16"><div class="md-cell module-header"><h1>Module 16: Trading Psychology &amp; Journaling</h1>
<h2>Part 4: Automation &amp; Production</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Duration</strong></td>
<td>~2.5 hours</td>
</tr>
<tr>
<td><strong>Exercises</strong></td>
<td>6</td>
</tr>
</tbody>
</table></div>
<h2>Learning Objectives</h2>
<ol>
<li>Understand common trading biases</li>
<li>Build an automated trading journal</li>
<li>Implement performance review systems</li>
<li>Create continuous improvement frameworks</li>
</ol></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Module 16: Trading Psychology &amp; Journaling&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><h1>Section 1: Trading Psychology</h1>
<h2>Common Cognitive Biases</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Bias</th>
<th>Description</th>
<th>Counter</th>
</tr>
</thead>
<tbody>
<tr>
<td>Confirmation</td>
<td>Seeking info that confirms beliefs</td>
<td>Check opposing views</td>
</tr>
<tr>
<td>Loss Aversion</td>
<td>Holding losers, cutting winners</td>
<td>Use systematic stops</td>
</tr>
<tr>
<td>Overconfidence</td>
<td>Overestimating abilities</td>
<td>Track actual performance</td>
</tr>
<tr>
<td>Recency</td>
<td>Overweighting recent events</td>
<td>Use longer lookbacks</td>
</tr>
<tr>
<td>FOMO</td>
<td>Fear of missing out</td>
<td>Stick to strategy</td>
</tr>
</tbody>
</table></div></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">BiasDetector</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Detect potential trading biases from behavior.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                  <span class="n">hold_time_hours</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">planned_stop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record a trade for analysis.&quot;&quot;&quot;</span>
        <span class="n">pnl_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;exit&#39;</span><span class="p">:</span> <span class="n">exit_price</span><span class="p">,</span>
            <span class="s1">&#39;pnl_pct&#39;</span><span class="p">:</span> <span class="n">pnl_pct</span><span class="p">,</span>
            <span class="s1">&#39;hold_time&#39;</span><span class="p">:</span> <span class="n">hold_time_hours</span><span class="p">,</span>
            <span class="s1">&#39;planned_stop&#39;</span><span class="p">:</span> <span class="n">planned_stop</span><span class="p">,</span>
            <span class="s1">&#39;winner&#39;</span><span class="p">:</span> <span class="n">pnl_pct</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">analyze_loss_aversion</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for loss aversion bias.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;detected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data&#39;</span><span class="p">}</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        <span class="n">winners</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;winner&#39;</span><span class="p">]]</span>
        <span class="n">losers</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;winner&#39;</span><span class="p">]]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">losers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;detected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Need both winners and losers&#39;</span><span class="p">}</span>
        
        <span class="n">avg_win_hold</span> <span class="o">=</span> <span class="n">winners</span><span class="p">[</span><span class="s1">&#39;hold_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">avg_loss_hold</span> <span class="o">=</span> <span class="n">losers</span><span class="p">[</span><span class="s1">&#39;hold_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">avg_win</span> <span class="o">=</span> <span class="n">winners</span><span class="p">[</span><span class="s1">&#39;pnl_pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">losers</span><span class="p">[</span><span class="s1">&#39;pnl_pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Loss aversion: holding losers longer, cutting winners short</span>
        <span class="n">hold_ratio</span> <span class="o">=</span> <span class="n">avg_loss_hold</span> <span class="o">/</span> <span class="n">avg_win_hold</span> <span class="k">if</span> <span class="n">avg_win_hold</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">pnl_ratio</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">avg_loss</span><span class="p">)</span> <span class="o">/</span> <span class="n">avg_win</span> <span class="k">if</span> <span class="n">avg_win</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="n">detected</span> <span class="o">=</span> <span class="n">hold_ratio</span> <span class="o">&gt;</span> <span class="mf">1.5</span> <span class="ow">or</span> <span class="n">pnl_ratio</span> <span class="o">&gt;</span> <span class="mf">1.5</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;detected&#39;</span><span class="p">:</span> <span class="n">detected</span><span class="p">,</span>
            <span class="s1">&#39;avg_winner_hold&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">avg_win_hold</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;avg_loser_hold&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">avg_loss_hold</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;avg_win_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">avg_win</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;avg_loss_pct&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">avg_loss</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;Consider tighter stops on losers&#39;</span> <span class="k">if</span> <span class="n">detected</span> <span class="k">else</span> <span class="s1">&#39;OK&#39;</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">analyze_overconfidence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check for overconfidence bias.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;detected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s1">&#39;Insufficient data&#39;</span><span class="p">}</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
        <span class="n">win_rate</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;winner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="c1"># Check if position sizes increase after wins</span>
        <span class="c1"># Simplified: check if losing streaks follow winning streaks</span>
        
        <span class="n">detected</span> <span class="o">=</span> <span class="n">win_rate</span> <span class="o">&lt;</span> <span class="mf">0.4</span>  <span class="c1"># Overconfidence often leads to poor win rate</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;detected&#39;</span><span class="p">:</span> <span class="n">detected</span><span class="p">,</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">win_rate</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;recommendation&#39;</span><span class="p">:</span> <span class="s1">&#39;Review trade selection criteria&#39;</span> <span class="k">if</span> <span class="n">detected</span> <span class="k">else</span> <span class="s1">&#39;OK&#39;</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">detector</span> <span class="o">=</span> <span class="n">BiasDetector</span><span class="p">()</span>
<span class="n">detector</span><span class="o">.</span><span class="n">add_trade</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="c1"># Winner, quick exit</span>
<span class="n">detector</span><span class="o">.</span><span class="n">add_trade</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># Winner, quick exit</span>
<span class="n">detector</span><span class="o">.</span><span class="n">add_trade</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>   <span class="c1"># Loser, held long</span>
<span class="n">detector</span><span class="o">.</span><span class="n">add_trade</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>   <span class="c1"># Loser, held longer</span>
<span class="n">detector</span><span class="o">.</span><span class="n">add_trade</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>   <span class="c1"># Winner</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loss Aversion Analysis:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">detector</span><span class="o">.</span><span class="n">analyze_loss_aversion</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Overconfidence Analysis:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">detector</span><span class="o">.</span><span class="n">analyze_overconfidence</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 16.1: Bias Checklist (Guided)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">pre_trade_bias_check</span><span class="p">(</span><span class="n">trade_idea</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Pre-trade checklist to catch biases.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Implement bias checklist</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell"><h1>Section 2: Automated Trading Journal</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TradingJournal</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Automated trading journal.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">log_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">setup</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log a trade entry.&quot;&quot;&quot;</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
            <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">qty</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">qty</span> <span class="o">*</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="n">strategy</span><span class="p">,</span>
            <span class="s1">&#39;setup&#39;</span><span class="p">:</span> <span class="n">setup</span><span class="p">,</span>
            <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="n">notes</span><span class="p">,</span>
            <span class="s1">&#39;closed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;exit_price&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;exit_time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">close_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close a trade and calculate P&amp;L.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">trade_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;closed&#39;</span><span class="p">]:</span>
                <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;exit_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exit_price</span>
                <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;exit_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;closed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="k">if</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span><span class="p">:</span>
                    <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">exit_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">notes</span><span class="p">:</span>
                    <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; | Exit: </span><span class="si">{</span><span class="n">notes</span><span class="si">}</span><span class="s1">&#39;</span>
                
                <span class="k">return</span> <span class="n">trade</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">daily_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market_notes</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mood</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                    <span class="n">lessons</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add daily journal entry.&quot;&quot;&quot;</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
            <span class="s1">&#39;market_notes&#39;</span><span class="p">:</span> <span class="n">market_notes</span><span class="p">,</span>
            <span class="s1">&#39;mood&#39;</span><span class="p">:</span> <span class="n">mood</span><span class="p">,</span>
            <span class="s1">&#39;lessons&#39;</span><span class="p">:</span> <span class="n">lessons</span><span class="p">,</span>
            <span class="s1">&#39;plan&#39;</span><span class="p">:</span> <span class="n">plan</span><span class="p">,</span>
            <span class="s1">&#39;trades_today&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="k">if</span> 
                                 <span class="n">t</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))])</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_trades_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get trades as DataFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate trading statistics.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trades_df</span><span class="p">()</span>
        <span class="n">closed</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;closed&#39;</span><span class="p">]]</span>
        
        <span class="k">if</span> <span class="n">closed</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;No closed trades&#39;</span><span class="p">}</span>
        
        <span class="n">winners</span> <span class="o">=</span> <span class="n">closed</span><span class="p">[</span><span class="n">closed</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">losers</span> <span class="o">=</span> <span class="n">closed</span><span class="p">[</span><span class="n">closed</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">closed</span><span class="p">),</span>
            <span class="s1">&#39;winners&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">),</span>
            <span class="s1">&#39;losers&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">losers</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">closed</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;total_pnl&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">closed</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s1">&#39;avg_win&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">winners</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;avg_loss&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">losers</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">losers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;profit_factor&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">winners</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">losers</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">losers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">losers</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>

<span class="c1"># Demo</span>
<span class="n">journal</span> <span class="o">=</span> <span class="n">TradingJournal</span><span class="p">()</span>

<span class="c1"># Log some trades</span>
<span class="n">id1</span> <span class="o">=</span> <span class="n">journal</span><span class="o">.</span><span class="n">log_trade</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="s1">&#39;breakout&#39;</span><span class="p">)</span>
<span class="n">id2</span> <span class="o">=</span> <span class="n">journal</span><span class="o">.</span><span class="n">log_trade</span><span class="p">(</span><span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean_reversion&#39;</span><span class="p">)</span>

<span class="c1"># Close trades</span>
<span class="n">journal</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="s1">&#39;Hit target&#39;</span><span class="p">)</span>
<span class="n">journal</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="mi">345</span><span class="p">,</span> <span class="s1">&#39;Stopped out&#39;</span><span class="p">)</span>

<span class="c1"># Daily entry</span>
<span class="n">journal</span><span class="o">.</span><span class="n">daily_entry</span><span class="p">(</span>
    <span class="n">market_notes</span><span class="o">=</span><span class="s1">&#39;Strong tech day, indices up 1%&#39;</span><span class="p">,</span>
    <span class="n">mood</span><span class="o">=</span><span class="s1">&#39;confident&#39;</span><span class="p">,</span>
    <span class="n">lessons</span><span class="o">=</span><span class="s1">&#39;Momentum worked well today&#39;</span><span class="p">,</span>
    <span class="n">plan</span><span class="o">=</span><span class="s1">&#39;Look for continuation tomorrow&#39;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Trade Statistics:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">journal</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 16.2: Journal Analytics (Open-ended)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># Build analytics dashboard for journal data</span>
</code></pre></div>
<div class="md-cell"><h1>Section 3: Performance Review</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PerformanceReview</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Systematic performance review framework.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">journal</span><span class="p">:</span> <span class="n">TradingJournal</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">journal</span> <span class="o">=</span> <span class="n">journal</span>
    
    <span class="k">def</span> <span class="nf">weekly_review</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate weekly review.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">get_trades_df</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;No trades to review&#39;</span><span class="p">}</span>
        
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span>
        
        <span class="c1"># Analyze by strategy</span>
        <span class="n">closed</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;closed&#39;</span><span class="p">]]</span>
        <span class="n">by_strategy</span> <span class="o">=</span> <span class="n">closed</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;strategy&#39;</span><span class="p">)[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">])</span>
        
        <span class="c1"># Find best/worst trades</span>
        <span class="n">best</span> <span class="o">=</span> <span class="n">closed</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;pnl&#39;</span><span class="p">)[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="s1">&#39;strategy&#39;</span><span class="p">]]</span>
        <span class="n">worst</span> <span class="o">=</span> <span class="n">closed</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;pnl&#39;</span><span class="p">)[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;pnl&#39;</span><span class="p">,</span> <span class="s1">&#39;strategy&#39;</span><span class="p">]]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="s1">&#39;Weekly Review&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span>
            <span class="s1">&#39;by_strategy&#39;</span><span class="p">:</span> <span class="n">by_strategy</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">by_strategy</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="p">{},</span>
            <span class="s1">&#39;best_trades&#39;</span><span class="p">:</span> <span class="n">best</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">best</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s1">&#39;worst_trades&#39;</span><span class="p">:</span> <span class="n">worst</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">worst</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">identify_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Identify patterns in trading behavior.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">get_trades_df</span><span class="p">()</span>
        <span class="n">closed</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;closed&#39;</span><span class="p">]]</span>
        
        <span class="k">if</span> <span class="n">closed</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;patterns&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Check win rate by strategy</span>
        <span class="k">if</span> <span class="s1">&#39;strategy&#39;</span> <span class="ow">in</span> <span class="n">closed</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">strat</span> <span class="ow">in</span> <span class="n">closed</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">strat_trades</span> <span class="o">=</span> <span class="n">closed</span><span class="p">[</span><span class="n">closed</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">strat</span><span class="p">]</span>
                <span class="n">win_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">strat_trades</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">win_rate</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>
                    <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strong performance with &#39;</span><span class="si">{</span><span class="n">strat</span><span class="si">}</span><span class="s2">&#39; strategy (</span><span class="si">{</span><span class="n">win_rate</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% win rate)&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">win_rate</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">:</span>
                    <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Consider reviewing &#39;</span><span class="si">{</span><span class="n">strat</span><span class="si">}</span><span class="s2">&#39; strategy (</span><span class="si">{</span><span class="n">win_rate</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">% win rate)&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check time patterns (simplified)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">closed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">avg_pnl</span> <span class="o">=</span> <span class="n">closed</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">avg_pnl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Positive average P&amp;L: $</span><span class="si">{</span><span class="n">avg_pnl</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Negative average P&amp;L: $</span><span class="si">{</span><span class="n">avg_pnl</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> - review strategy&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;patterns&#39;</span><span class="p">:</span> <span class="n">patterns</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate comprehensive performance report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PERFORMANCE REVIEW REPORT&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        
        <span class="n">weekly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weekly_review</span><span class="p">()</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_patterns</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">OVERALL STATISTICS:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;stats&#39;</span> <span class="ow">in</span> <span class="n">weekly</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">weekly</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">PATTERNS IDENTIFIED:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">[</span><span class="s1">&#39;patterns&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  ‚Ä¢ </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">BEST TRADES:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">weekly</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;best_trades&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WORST TRADES:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">weekly</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;worst_trades&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: $</span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="n">review</span> <span class="o">=</span> <span class="n">PerformanceReview</span><span class="p">(</span><span class="n">journal</span><span class="p">)</span>
<span class="n">review</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 16.3: Improvement Tracker (Guided)</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">def</span> <span class="nf">track_improvement_goals</span><span class="p">(</span><span class="n">current_stats</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">goals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Track progress toward trading goals.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Compare current stats to goals</span>
    <span class="k">pass</span>
</code></pre></div>
<div class="md-cell"><h1>Section 4: Complete Journaling System</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TradingJournalSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete trading journal and review system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">journal</span> <span class="o">=</span> <span class="n">TradingJournal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias_detector</span> <span class="o">=</span> <span class="n">BiasDetector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">review</span> <span class="o">=</span> <span class="n">PerformanceReview</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">record_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                     <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Record a new trade.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">log_trade</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">close_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">exit_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close a trade and update bias detector.&quot;&quot;&quot;</span>
        <span class="n">trade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">trade_id</span><span class="p">,</span> <span class="n">exit_price</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trade</span><span class="p">:</span>
            <span class="c1"># Add to bias detector</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bias_detector</span><span class="o">.</span><span class="n">add_trade</span><span class="p">(</span>
                <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> 
                <span class="n">trade</span><span class="p">[</span><span class="s1">&#39;exit_price&#39;</span><span class="p">],</span>
                <span class="mi">1</span>  <span class="c1"># Simplified hold time</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">trade</span>
    
    <span class="k">def</span> <span class="nf">end_of_day_routine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run end of day analysis.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;END OF DAY ANALYSIS&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        
        <span class="c1"># Stats</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Today</span><span class="se">\&#39;</span><span class="s1">s Statistics:&#39;</span><span class="p">)</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># Bias check</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Bias Analysis:&#39;</span><span class="p">)</span>
        <span class="n">loss_aversion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_detector</span><span class="o">.</span><span class="n">analyze_loss_aversion</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Loss Aversion: </span><span class="si">{</span><span class="s1">&#39;‚ö†Ô∏è DETECTED&#39;</span> <span class="k">if</span> <span class="n">loss_aversion</span><span class="p">[</span><span class="s1">&#39;detected&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;‚úÖ OK&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loss_aversion</span><span class="p">[</span><span class="s1">&#39;detected&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">loss_aversion</span><span class="p">[</span><span class="s1">&#39;recommendation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">weekly_routine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run weekly review.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">review</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>

<span class="c1"># Demo the complete system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">TradingJournalSystem</span><span class="p">()</span>

<span class="c1"># Simulate a trading day</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">record_trade</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">record_trade</span><span class="p">(</span><span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="s1">&#39;breakout&#39;</span><span class="p">)</span>
<span class="n">t3</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">record_trade</span><span class="p">(</span><span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">)</span>

<span class="n">system</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="mi">186</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="mi">138</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">close_trade</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="mi">510</span><span class="p">)</span>

<span class="c1"># Run end of day</span>
<span class="n">system</span><span class="o">.</span><span class="n">end_of_day_routine</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell exercise-header"><h3>Exercise 16.4-16.6</h3></div>
<div class="code-cell exercise-code"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="c1"># 16.4: Trade Screenshot Automation (Guided)</span>
<span class="c1"># 16.5: Monthly Report Generator (Open-ended)</span>
<span class="c1"># 16.6: Personal Trading Dashboard (Open-ended)</span>
</code></pre></div>
<div class="md-cell key-takeaways"><h1>Key Takeaways</h1>
<ol>
<li><strong>Know Your Biases:</strong> Loss aversion, overconfidence, FOMO</li>
<li><strong>Journal Everything:</strong> Trades, emotions, market notes</li>
<li><strong>Review Regularly:</strong> Weekly and monthly reviews</li>
<li><strong>Track Patterns:</strong> What works, what doesn't</li>
<li><strong>Continuous Improvement:</strong> Set goals and measure progress</li>
</ol>
<hr />
<h1>üéâ Part 4 Complete!</h1>
<p>You've now learned:
- Paper trading with Alpaca
- SEC filings and alternative data
- Automation and monitoring
- Trading psychology and journaling</p>
<p><strong>Next:</strong> Capstone Project</p></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
<div class="module-section" data-idx="17"><div class="md-cell module-header"><h1>üéØ Capstone Project: Complete Stock Trading System</h1>
<h2>Course 2: Stock Market Algorithmic Trading</h2>
<hr />
<h2>Project Overview</h2>
<p>Build a complete stock trading system that combines:
- Multi-factor stock screening
- Fundamental + technical analysis
- Options strategy integration
- Alpaca execution
- Risk management
- Alternative data signals
- Automated journaling
- Performance analytics</p>
<p><strong>Estimated Time:</strong> 8-12 hours</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Capstone Project: Complete Stock Trading System&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 1: Data &amp; Screening Layer</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">DataManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Centralized data management.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universe</span> <span class="o">=</span> <span class="n">universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">get_price_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;1y&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_fundamentals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;pe_ratio&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trailingPE&#39;</span><span class="p">),</span>
                <span class="s1">&#39;pb_ratio&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priceToBook&#39;</span><span class="p">),</span>
                <span class="s1">&#39;market_cap&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marketCap&#39;</span><span class="p">),</span>
                <span class="s1">&#39;dividend_yield&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dividendYield&#39;</span><span class="p">),</span>
                <span class="s1">&#39;roe&#39;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;returnOnEquity&#39;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="p">{}</span>


<span class="k">class</span> <span class="nc">MultiFactorScreener</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Screen stocks using multiple factors.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_manager</span><span class="p">:</span> <span class="n">DataManager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_manager</span>
    
    <span class="k">def</span> <span class="nf">technical_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_price_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">close</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Trend: above 50 SMA</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Momentum: 3-month return positive</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">63</span><span class="p">:</span>
            <span class="n">ret_3m</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">63</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="k">if</span> <span class="n">ret_3m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># RSI: not overbought</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
        <span class="n">gain</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">/</span> <span class="n">loss</span>
        <span class="n">rsi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="mi">30</span> <span class="o">&lt;</span> <span class="n">rsi</span> <span class="o">&lt;</span> <span class="mi">70</span><span class="p">:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">score</span> <span class="o">/</span> <span class="mi">3</span>
    
    <span class="k">def</span> <span class="nf">fundamental_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">fund</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_fundamentals</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fund</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
        
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Reasonable P/E</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pe_ratio&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pe</span> <span class="ow">and</span> <span class="mi">5</span> <span class="o">&lt;</span> <span class="n">pe</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Good ROE</span>
        <span class="n">roe</span> <span class="o">=</span> <span class="n">fund</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;roe&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roe</span> <span class="ow">and</span> <span class="n">roe</span> <span class="o">&gt;</span> <span class="mf">0.15</span><span class="p">:</span> <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="n">score</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="k">def</span> <span class="nf">screen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">universe</span><span class="p">:</span>
            <span class="n">tech</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">technical_score</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">fund</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_score</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="p">(</span><span class="n">tech</span> <span class="o">+</span> <span class="n">fund</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;technical&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">tech</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;fundamental&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">fund</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;combined&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;combined&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Test</span>
<span class="n">universe</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;MSFT&#39;</span><span class="p">,</span> <span class="s1">&#39;GOOGL&#39;</span><span class="p">,</span> <span class="s1">&#39;AMZN&#39;</span><span class="p">,</span> <span class="s1">&#39;META&#39;</span><span class="p">,</span> <span class="s1">&#39;NVDA&#39;</span><span class="p">,</span> <span class="s1">&#39;JPM&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">]</span>
<span class="n">data_mgr</span> <span class="o">=</span> <span class="n">DataManager</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span>
<span class="n">screener</span> <span class="o">=</span> <span class="n">MultiFactorScreener</span><span class="p">(</span><span class="n">data_mgr</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Screening Results:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">screener</span><span class="o">.</span><span class="n">screen</span><span class="p">())</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 2: Signal Generation</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">SignalGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate trading signals from multiple sources.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_manager</span><span class="p">:</span> <span class="n">DataManager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_manager</span>
    
    <span class="k">def</span> <span class="nf">momentum_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_price_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        
        <span class="n">close</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">sma20</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sma50</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span> <span class="k">else</span> <span class="n">sma20</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">sma20</span> <span class="o">&gt;</span> <span class="n">sma50</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">sma20</span> <span class="o">&lt;</span> <span class="n">sma50</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">mean_reversion_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_price_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        
        <span class="n">close</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">sma</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">zscore</span> <span class="o">=</span> <span class="p">(</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sma</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">std</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">zscore</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bullish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">zscore</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;bearish&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">combined_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">mom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momentum_signal</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_reversion_signal</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        
        <span class="c1"># Combine signals</span>
        <span class="n">signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">mom</span><span class="p">,</span> <span class="n">mr</span><span class="p">]</span>
        <span class="n">bullish</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bullish&#39;</span><span class="p">)</span>
        <span class="n">bearish</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bearish&#39;</span><span class="p">)</span>
        
        <span class="n">avg_strength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">bullish</span> <span class="o">&gt;</span> <span class="n">bearish</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="n">avg_strength</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">bearish</span> <span class="o">&gt;</span> <span class="n">bullish</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;SELL&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="n">avg_strength</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="n">avg_strength</span><span class="p">}</span>

<span class="n">signals</span> <span class="o">=</span> <span class="n">SignalGenerator</span><span class="p">(</span><span class="n">data_mgr</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Trading Signals:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">universe</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">combined_signal</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">sig</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">sig</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (strength: </span><span class="si">{</span><span class="n">sig</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 3: Risk Management</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">RiskManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Portfolio risk management.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capital</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_position_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                 <span class="n">max_portfolio_risk</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">=</span> <span class="n">capital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_position_pct</span> <span class="o">=</span> <span class="n">max_position_pct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_portfolio_risk</span> <span class="o">=</span> <span class="n">max_portfolio_risk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">def</span> <span class="nf">calculate_position_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                 <span class="n">stop_loss</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate position size based on risk.&quot;&quot;&quot;</span>
        <span class="n">risk_per_share</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">entry_price</span> <span class="o">-</span> <span class="n">stop_loss</span><span class="p">)</span>
        <span class="n">max_risk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_portfolio_risk</span>
        <span class="n">max_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_position_pct</span>
        
        <span class="c1"># Risk-based size</span>
        <span class="n">risk_based</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_risk</span> <span class="o">/</span> <span class="n">risk_per_share</span><span class="p">)</span>
        
        <span class="c1"># Max position size</span>
        <span class="n">max_based</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_position</span> <span class="o">/</span> <span class="n">entry_price</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">risk_based</span><span class="p">,</span> <span class="n">max_based</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">calculate_stop_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">atr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;percent&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate stop loss price.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;percent&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="mf">0.95</span>  <span class="c1"># 5% stop</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;atr&#39;</span> <span class="ow">and</span> <span class="n">atr</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">atr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">entry_price</span> <span class="o">*</span> <span class="mf">0.95</span>
    
    <span class="k">def</span> <span class="nf">check_portfolio_risk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check current portfolio risk.&quot;&quot;&quot;</span>
        <span class="n">total_exposure</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">exposure_pct</span> <span class="o">=</span> <span class="n">total_exposure</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">capital</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;exposure&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">exposure_pct</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;positions&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">),</span>
            <span class="s1">&#39;can_trade&#39;</span><span class="p">:</span> <span class="n">exposure_pct</span> <span class="o">&lt;</span> <span class="mf">0.8</span>
        <span class="p">}</span>

<span class="n">risk_mgr</span> <span class="o">=</span> <span class="n">RiskManager</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">risk_mgr</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">176</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Position Size for AAPL: </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1"> shares&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stop Loss: $</span><span class="si">{</span><span class="n">risk_mgr</span><span class="o">.</span><span class="n">calculate_stop_loss</span><span class="p">(</span><span class="mi">185</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 4: Execution Engine</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">ExecutionEngine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trade execution (paper trading simulation).&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">risk_manager</span><span class="p">:</span> <span class="n">RiskManager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk</span> <span class="o">=</span> <span class="n">risk_manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fills</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">submit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">side</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                     <span class="n">price</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;market&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Submit an order.&quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
            <span class="s1">&#39;side&#39;</span><span class="p">:</span> <span class="n">side</span><span class="p">,</span>
            <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">qty</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">order_type</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;submitted&#39;</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        
        <span class="c1"># Simulate fill for market orders</span>
        <span class="k">if</span> <span class="n">order_type</span> <span class="o">==</span> <span class="s1">&#39;market&#39;</span><span class="p">:</span>
            <span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;filled&#39;</span>
            <span class="n">order</span><span class="p">[</span><span class="s1">&#39;fill_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fills</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            
            <span class="c1"># Update positions</span>
            <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;buy&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">qty</span><span class="p">,</span> <span class="s1">&#39;entry&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">qty</span> <span class="o">*</span> <span class="n">price</span>
                <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">order</span>
    
    <span class="k">def</span> <span class="nf">get_pending_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;submitted&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_fills</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fills</span><span class="p">)</span>

<span class="n">executor</span> <span class="o">=</span> <span class="n">ExecutionEngine</span><span class="p">(</span><span class="n">risk_mgr</span><span class="p">)</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">185.00</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Order submitted: </span><span class="si">{</span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fills: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">fills</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 5: Complete Trading System</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">TradingSystem</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Complete integrated trading system.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">universe</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">capital</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">DataManager</span><span class="p">(</span><span class="n">universe</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screener</span> <span class="o">=</span> <span class="n">MultiFactorScreener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span> <span class="o">=</span> <span class="n">SignalGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">risk</span> <span class="o">=</span> <span class="n">RiskManager</span><span class="p">(</span><span class="n">capital</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">ExecutionEngine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">risk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_log</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">scan_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scan for trading opportunities.&quot;&quot;&quot;</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screener</span><span class="o">.</span><span class="n">screen</span><span class="p">()</span>
        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">screen</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;combined&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">combined_signal</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;HOLD&#39;</span><span class="p">:</span>
                <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="o">**</span><span class="n">row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                    <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;signal_strength&#39;</span><span class="p">:</span> <span class="n">signal</span><span class="p">[</span><span class="s1">&#39;strength&#39;</span><span class="p">]</span>
                <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">opportunities</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">execute_opportunities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_trades</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute top opportunities.&quot;&quot;&quot;</span>
        <span class="n">opps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_opportunities</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">opps</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No opportunities found&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">executed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">opp</span> <span class="ow">in</span> <span class="n">opps</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">max_trades</span><span class="p">)</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BUY&#39;</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_price_data</span><span class="p">(</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">])</span>
                <span class="n">price</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">calculate_stop_loss</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
                <span class="n">qty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">calculate_position_size</span><span class="p">(</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span> <span class="n">price</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">qty</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span>
                        <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span> <span class="s1">&#39;buy&#39;</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">price</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trade_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">opp</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;BUY&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">qty</span><span class="p">,</span>
                        <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                        <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">stop</span>
                    <span class="p">})</span>
                    <span class="n">executed</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Executed: BUY </span><span class="si">{</span><span class="n">qty</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">opp</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> @ $</span><span class="si">{</span><span class="n">price</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">executed</span>
    
    <span class="k">def</span> <span class="nf">daily_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate daily trading report.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DAILY TRADING REPORT&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">üìä SCREENING RESULTS:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screener</span><span class="o">.</span><span class="n">screen</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">üìà OPPORTUNITIES:&#39;</span><span class="p">)</span>
        <span class="n">opps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_opportunities</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opps</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">opps</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  No opportunities&#39;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">üí∞ PORTFOLIO STATUS:&#39;</span><span class="p">)</span>
        <span class="n">risk_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">risk</span><span class="o">.</span><span class="n">check_portfolio_risk</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Exposure: </span><span class="si">{</span><span class="n">risk_status</span><span class="p">[</span><span class="s1">&#39;exposure&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Positions: </span><span class="si">{</span><span class="n">risk_status</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">üìù TODAY</span><span class="se">\&#39;</span><span class="s1">S TRADES:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> @ $</span><span class="si">{</span><span class="n">trade</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Run the complete system</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">TradingSystem</span><span class="p">(</span><span class="n">universe</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">daily_report</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">üöÄ EXECUTING TRADES...&#39;</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">execute_opportunities</span><span class="p">()</span>
<span class="n">system</span><span class="o">.</span><span class="n">daily_report</span><span class="p">()</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>Part 6: Performance Analytics</h1></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="k">class</span> <span class="nc">PerformanceAnalytics</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Analyze trading performance.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trades</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trades</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span> <span class="k">if</span> <span class="n">trades</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;No trades&#39;</span><span class="p">}</span>
        
        <span class="n">total_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">),</span>
            <span class="s1">&#39;total_invested&#39;</span><span class="p">:</span> <span class="n">total_value</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="s1">&#39;avg_trade_size&#39;</span><span class="p">:</span> <span class="n">total_value</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;symbols_traded&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trades</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="p">}</span>

<span class="n">analytics</span> <span class="o">=</span> <span class="n">PerformanceAnalytics</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">trade_log</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Performance Summary:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">analytics</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="md-cell"><hr />
<h1>üéì Project Complete!</h1>
<h2>What You Built</h2>
<ol>
<li><strong>Data Layer:</strong> Centralized data management</li>
<li><strong>Screening:</strong> Multi-factor stock screening</li>
<li><strong>Signals:</strong> Combined momentum + mean reversion</li>
<li><strong>Risk:</strong> Position sizing and stop losses</li>
<li><strong>Execution:</strong> Order management</li>
<li><strong>Analytics:</strong> Performance tracking</li>
</ol>
<h2>Extension Ideas</h2>
<ul>
<li>Add options strategies</li>
<li>Integrate real Alpaca API</li>
<li>Add sentiment signals</li>
<li>Build Streamlit dashboard</li>
<li>Deploy to cloud</li>
</ul>
<h2>Congratulations! üéâ</h2>
<p>You've completed the Stock Market Algorithmic Trading course!</p></div>
<div class="code-cell"><button class="copy-btn" onclick="copyCode(this)" title="Copy code">üìã</button><pre><code><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;üéì COURSE 2 COMPLETE: Stock Market Algorithmic Trading&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">You have mastered:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ‚úÖ Stock data analysis&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ‚úÖ Fundamental &amp; technical analysis&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ‚úÖ Screening &amp; strategy development&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ‚úÖ Options fundamentals &amp; strategies&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ‚úÖ Paper trading with Alpaca&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ‚úÖ Alternative data integration&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ‚úÖ Automation &amp; monitoring&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  ‚úÖ Trading psychology &amp; journaling&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">üöÄ Ready for the next course!&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</code></pre></div>
        <div class="nav-buttons">
            <button class="nav-btn prev-btn disabled" type="button">
                <span class="nav-btn-label">‚Üê Previous</span>
                <span class="nav-btn-name"></span>
            </button>
            <button class="nav-btn next-btn disabled" type="button">
                <span class="nav-btn-label">Next ‚Üí</span>
                <span class="nav-btn-name"></span>
            </button>
        </div>
        </div>
    </main>

    <script>
        window.courseId = 'course2_stock_trading';
        
// State
let currentModule = 0;
const modules = document.querySelectorAll('.module-section');
const sidebarItems = document.querySelectorAll('.sidebar-item');
const sidebar = document.querySelector('.sidebar');
const overlay = document.querySelector('.sidebar-overlay');
const headerModule = document.querySelector('.header-module');

function showModule(idx) {
    if (idx < 0 || idx >= modules.length) return;

    // Hide all, show target
    modules.forEach(m => m.classList.remove('active'));
    modules[idx].classList.add('active');

    // Update sidebar active state
    sidebarItems.forEach(s => s.classList.remove('active'));
    sidebarItems[idx].classList.add('active');

    // Update header
    const label = sidebarItems[idx].textContent.trim();
    if (headerModule) headerModule.textContent = label;

    // Update prev/next buttons
    updateNavButtons(idx);

    // Save & scroll
    currentModule = idx;
    try { localStorage.setItem(window.courseId + '_module', idx); } catch(e) {}
    window.scrollTo(0, 0);

    // Close sidebar on mobile
    closeSidebar();
}

function updateNavButtons(idx) {
    const section = modules[idx];
    const prevBtn = section.querySelector('.prev-btn');
    const nextBtn = section.querySelector('.next-btn');

    if (prevBtn) {
        // Clone to remove old listeners
        const newPrev = prevBtn.cloneNode(true);
        prevBtn.parentNode.replaceChild(newPrev, prevBtn);
        if (idx === 0) {
            newPrev.classList.add('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = '';
        } else {
            newPrev.classList.remove('disabled');
            newPrev.querySelector('.nav-btn-name').textContent = sidebarItems[idx - 1].textContent.trim();
            newPrev.addEventListener('click', () => showModule(idx - 1));
        }
    }
    if (nextBtn) {
        const newNext = nextBtn.cloneNode(true);
        nextBtn.parentNode.replaceChild(newNext, nextBtn);
        if (idx === modules.length - 1) {
            newNext.classList.add('disabled');
            newNext.querySelector('.nav-btn-name').textContent = '';
        } else {
            newNext.classList.remove('disabled');
            newNext.querySelector('.nav-btn-name').textContent = sidebarItems[idx + 1].textContent.trim();
            newNext.addEventListener('click', () => showModule(idx + 1));
        }
    }
}

function toggleSidebar() {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('open');
}

function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('open');
}

// Copy code button
function copyCode(btn) {
    const code = btn.parentElement.querySelector('pre code');
    const text = code.textContent;
    navigator.clipboard.writeText(text).then(() => {
        btn.textContent = '‚úì';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = 'üìã';
            btn.classList.remove('copied');
        }, 1500);
    }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        btn.textContent = '‚úì';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.textContent = 'üìã';
            btn.classList.remove('copied');
        }, 1500);
    });
}

// Init: bind sidebar items
sidebarItems.forEach((item, idx) => {
    item.addEventListener('click', () => showModule(idx));
});

// Restore last viewed module
document.addEventListener('DOMContentLoaded', () => {
    let saved = 0;
    try { saved = parseInt(localStorage.getItem(window.courseId + '_module')) || 0; } catch(e) {}
    if (saved >= 0 && saved < modules.length) {
        showModule(saved);
    } else {
        showModule(0);
    }
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' && currentModule > 0) showModule(currentModule - 1);
    if (e.key === 'ArrowRight' && currentModule < modules.length - 1) showModule(currentModule + 1);
    if (e.key === 'Escape') closeSidebar();
});

    </script>
</body>
</html>